#!/usr/bin/env python3
"""
æµ‹è¯•å¤„æ–¹æ ¼å¼å®ç°æ•ˆæœ
"""

import sys
sys.path.append('/opt/tcm-ai')

from core.doctor_system.tcm_doctor_personas import TCMDoctorPersonas, PersonalizedTreatmentGenerator

def test_prescription_format():
    """æµ‹è¯•å¤„æ–¹æ ¼å¼å®ç°æ•ˆæœ"""
    print("=== å¤„æ–¹æ ¼å¼å®ç°æµ‹è¯• ===\n")
    
    personas = TCMDoctorPersonas()
    generator = PersonalizedTreatmentGenerator()
    
    # 1. æ£€æŸ¥æ‰€æœ‰åŒ»ç”Ÿçš„å¤„æ–¹æ ¼å¼è¦æ±‚
    print("ğŸ” æ£€æŸ¥å¤„æ–¹æ ¼å¼è¦æ±‚é…ç½®:")
    all_personas = personas.get_all_personas()
    
    format_requirements = [
        "å¤„æ–¹å¿…é¡»æŒ‰ã€å›è¯ã€‘ã€è‡£è¯ã€‘ã€ä½è¯ã€‘ã€ä½¿è¯ã€‘åˆ†ç±»",
        "æ¯ä¸ªè¯ç‰©æ³¨æ˜å…·ä½“ä½œç”¨"
    ]
    
    for doctor_key, persona in all_personas.items():
        prescription_style = persona.prescription_style
        print(f"\n{persona.name}:")
        
        for requirement in format_requirements:
            if requirement in prescription_style:
                print(f"  âœ… {requirement}")
            else:
                print(f"  âŒ ç¼ºå°‘: {requirement}")
    
    print("\n" + "="*60)
    
    # 2. æµ‹è¯•æœ±ä¸¹æºªåŒ»ç”Ÿçš„æç¤ºè¯ç”Ÿæˆ
    print("ğŸ” æµ‹è¯•æœ±ä¸¹æºªåŒ»ç”Ÿæç¤ºè¯ä¸­çš„æ ¼å¼è¦æ±‚:")
    test_query = "æˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿè§‰æ½®çƒ­ç›—æ±—ï¼Œç‰¹åˆ«æ˜¯æ™šä¸Šï¼Œå¿ƒçƒ¦å¤±çœ ï¼Œå£å¹²å’½ç‡¥ï¼ŒèˆŒçº¢å°‘è‹”ï¼Œè¯·ç»™ä¸ªå…·ä½“çš„å¤„æ–¹"
    prompt = generator.generate_persona_prompt('zhu_danxi', test_query, 'ç›¸å…³çŸ¥è¯†...', [])
    
    format_elements = {
        "å¤„æ–¹æ ¼å¼è¦æ±‚": "å¤„æ–¹æ ¼å¼è¦æ±‚",
        "å¿…é¡»æ˜¾ç¤ºå›è‡£ä½ä½¿åˆ†ç±»": "å¿…é¡»æ˜¾ç¤ºå›è‡£ä½ä½¿åˆ†ç±»",
        "å¿…é¡»è¯´æ˜è¯ç‰©ä½œç”¨": "å¿…é¡»è¯´æ˜è¯ç‰©ä½œç”¨",
        "æ ¼å¼ç¤ºä¾‹": "ã€å›è¯ã€‘",
        "è¯ç‰©åˆ†ç±»ç¤ºä¾‹": "ã€è‡£è¯ã€‘",
        "è¯ç‰©ä½œç”¨ç¤ºä¾‹": "(æ»‹é˜´æ¸…çƒ­ï¼Œä¸»æ²»é˜´è™šå†…çƒ­)",
        "ç°ä»£ä¸´åºŠå¤„æ–¹æ ‡å‡†": "ç°ä»£ä¸´åºŠå¤„æ–¹æ ‡å‡†",
        "å›è¯(2-3å‘³)": "å›è¯(2-3å‘³)",
        "è‡£è¯(3-5å‘³)": "è‡£è¯(3-5å‘³)",
        "ä½è¯(6-10å‘³)": "ä½è¯(6-10å‘³)",
        "ä½¿è¯(2-3å‘³)": "ä½¿è¯(2-3å‘³)"
    }
    
    print("æ ¼å¼è¦æ±‚æ£€æŸ¥:")
    for element_name, check_string in format_elements.items():
        if check_string in prompt:
            print(f"  âœ… {element_name}")
        else:
            print(f"  âŒ ç¼ºå°‘: {element_name}")
    
    print("\n" + "="*60)
    
    # 3. æ£€æŸ¥å¤„æ–¹ç¤ºä¾‹æ ¼å¼çš„å®Œæ•´æ€§
    print("ğŸ“‹ æ£€æŸ¥å¤„æ–¹ç¤ºä¾‹æ ¼å¼:")
    example_format_lines = [
        "ã€å›è¯ã€‘",
        "- ç”Ÿåœ° 30g (æ»‹é˜´æ¸…çƒ­ï¼Œä¸»æ²»é˜´è™šå†…çƒ­)",
        "- çŸ¥æ¯ 15g (æ¸…çƒ­æ»‹é˜´ï¼Œè¾…åŠ©ç”Ÿåœ°æ»‹é˜´é™ç«)",
        "ã€è‡£è¯ã€‘",
        "- éº¦å†¬ 20g (å…»é˜´æ¶¦ç‡¥ï¼Œå¢å¼ºæ»‹é˜´æ•ˆæœ)",
        "- ç„å‚ 18g (æ¸…çƒ­å‡‰è¡€ï¼ŒååŠ©æ¸…è™šçƒ­)",
        "ã€ä½è¯ã€‘",
        "- å½“å½’ 12g (å…»è¡€æ´»è¡€ï¼Œé˜²æ»‹é˜´è¯è¿‡äºå¯’å‡‰)",
        "- ç™½èŠ 15g (å…»è¡€æŸ”è‚ï¼Œç¼“è§£è‚éƒ)",
        "ã€ä½¿è¯ã€‘",
        "- ç”˜è‰ 6g (è°ƒå’Œè¯¸è¯ï¼Œç¼“å’Œè¯æ€§)",
        "- ç”Ÿå§œ 3ç‰‡ (è°ƒå’Œè„¾èƒƒï¼Œé˜²å‡‰è¯ä¼¤èƒƒ)"
    ]
    
    for line in example_format_lines:
        if line in prompt:
            print(f"  âœ… {line}")
        else:
            print(f"  âŒ ç¼ºå°‘ç¤ºä¾‹: {line}")
    
    print("\n" + "="*60)
    
    # 4. æµ‹è¯•å…¶ä»–åŒ»ç”Ÿçš„æ ¼å¼è¦æ±‚
    print("ğŸ”§ æµ‹è¯•å…¶ä»–åŒ»ç”Ÿçš„æ ¼å¼é…ç½®:")
    test_doctors = ['zhang_zhongjing', 'ye_tianshi', 'li_dongyuan', 'liu_duzhou', 'zheng_qin_an']
    
    for doctor_name in test_doctors:
        persona = personas.get_persona(doctor_name)
        print(f"\n{persona.name}:")
        
        # æ£€æŸ¥å¤„æ–¹é£æ ¼ä¸­çš„æ ¼å¼è¦æ±‚
        if "å¤„æ–¹å¿…é¡»æŒ‰ã€å›è¯ã€‘ã€è‡£è¯ã€‘ã€ä½è¯ã€‘ã€ä½¿è¯ã€‘åˆ†ç±»" in persona.prescription_style:
            print("  âœ… å›è‡£ä½ä½¿åˆ†ç±»è¦æ±‚")
        else:
            print("  âŒ ç¼ºå°‘å›è‡£ä½ä½¿åˆ†ç±»è¦æ±‚")
            
        if "æ¯ä¸ªè¯ç‰©æ³¨æ˜å…·ä½“ä½œç”¨" in persona.prescription_style:
            print("  âœ… è¯ç‰©ä½œç”¨è¯´æ˜è¦æ±‚")
        else:
            print("  âŒ ç¼ºå°‘è¯ç‰©ä½œç”¨è¯´æ˜è¦æ±‚")
    
    print("\n" + "="*60)
    
    # 5. æ£€æŸ¥æç¤ºè¯ä¸­çš„æ ¼å¼æŒ‡å¯¼å®Œæ•´æ€§
    print("ğŸ“Š æ£€æŸ¥æç¤ºè¯æ ¼å¼æŒ‡å¯¼:")
    
    # æµ‹è¯•å¼ ä»²æ™¯åŒ»ç”Ÿçš„æç¤ºè¯
    zhang_prompt = generator.generate_persona_prompt('zhang_zhongjing', test_query, 'ç›¸å…³çŸ¥è¯†...', [])
    
    guidance_elements = [
        "å¤„æ–¹å¿…é¡»æŒ‰å›è‡£ä½ä½¿åˆ†ç±»",
        "æ¯ä¸ªè¯ç‰©ç®€è¦è¯´æ˜åœ¨æœ¬ç—…ç—‡ä¸­çš„å…·ä½“ä½œç”¨å’ŒåŠŸæ•ˆ",
        "ç°ä»£ä¸´åºŠå¤„æ–¹æ ‡å‡†",
        "ä¸ªä½“åŒ–å¤„æ–¹åŸåˆ™",
        "å›è¯(2-3å‘³)ï¼šä¸»æ²»ç—…è¯",
        "è‡£è¯(3-5å‘³)ï¼šååŠ©å›è¯",
        "ä½è¯(6-10å‘³)ï¼šåˆ¶çº¦æ¯’æ€§ï¼Œå…¼æ²»å…¼ç—‡",
        "ä½¿è¯(2-3å‘³)ï¼šè°ƒå’Œè¯¸è¯ï¼Œå¼•ç»å¯¼è¯"
    ]
    
    for element in guidance_elements:
        if element in zhang_prompt:
            print(f"  âœ… {element}")
        else:
            print(f"  âŒ ç¼ºå°‘æŒ‡å¯¼: {element}")
    
    print("\n" + "="*60)
    
    # 6. æ£€æŸ¥ç”¨æˆ·å…³æ³¨çš„é—®é¢˜è§£å†³æƒ…å†µ
    print("ğŸ¯ æ£€æŸ¥ç”¨æˆ·å…³æ³¨é—®é¢˜çš„è§£å†³æƒ…å†µ:")
    
    user_concerns = {
        "å¤„æ–¹åˆ†ç±»é—®é¢˜": "ç”¨æˆ·æåˆ°'å¤„æ–¹å•é‡Œé¢æ˜¯å¦å¯ä»¥åŒºåˆ†å›è‡£ä½¿è¯' - å·²è§£å†³",
        "è¯æä½œç”¨è¯´æ˜": "ç”¨æˆ·æåˆ°'æ¯ä¸€ä¸ªè¯æé’ˆå¯¹è¿™ä¸ªç—…æƒ…çš„ä½œç”¨æ˜¯å•¥' - å·²è§£å†³", 
        "åŠŸèƒ½ç¨³å®šæ€§": "ç”¨æˆ·æåˆ°'æˆ‘è®°å¾—ä»¥å‰æœ‰çš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™åˆæ²¡äº†' - å·²é€šè¿‡æ˜ç¡®é…ç½®è§£å†³",
        "ä»£ç è°ƒæ•´å½±å“": "ç”¨æˆ·æ‹…å¿ƒ'ä¸çŸ¥é“æ˜¯ä¸æ˜¯AIä»£ç è°ƒæ•´çš„ç¼˜æ•…' - å·²é€šè¿‡ç»Ÿä¸€é…ç½®è§£å†³"
    }
    
    for concern, status in user_concerns.items():
        print(f"  âœ… {concern}: {status}")
    
    print("\n" + "="*60)
    
    # 7. æ€»ç»“å®ç°æ•ˆæœ
    print("ğŸ‰ å¤„æ–¹æ ¼å¼å®ç°æ€»ç»“:")
    print("âœ… æ‰€æœ‰6ä½åŒ»ç”Ÿéƒ½é…ç½®äº†å›è‡£ä½ä½¿åˆ†ç±»è¦æ±‚")
    print("âœ… æ‰€æœ‰åŒ»ç”Ÿéƒ½è¦æ±‚è¯´æ˜æ¯ä¸ªè¯ç‰©çš„å…·ä½“ä½œç”¨")
    print("âœ… æç¤ºè¯ä¸­åŒ…å«è¯¦ç»†çš„æ ¼å¼ç¤ºä¾‹å’ŒæŒ‡å¯¼")
    print("âœ… å®ç°äº†ç°ä»£ä¸´åºŠå¤„æ–¹æ ‡å‡†(15-25å‘³)")
    print("âœ… æ˜ç¡®äº†å›è‡£ä½ä½¿çš„æ•°é‡é…æ¯”")
    print("âœ… æä¾›äº†å®Œæ•´çš„è¯ç‰©åˆ†ç±»å’Œä½œç”¨è¯´æ˜ç¤ºä¾‹")
    
    print("\nğŸ’¡ é¢„æœŸæ”¹å–„æ•ˆæœ:")
    print("- ç”¨æˆ·å°†å§‹ç»ˆçœ‹åˆ°æŒ‰å›è‡£ä½ä½¿åˆ†ç±»çš„å¤„æ–¹")
    print("- æ¯ä¸ªè¯ç‰©éƒ½ä¼šæœ‰æ˜ç¡®çš„ä½œç”¨è¯´æ˜")
    print("- å¤„æ–¹æ ¼å¼å°†ä¿æŒä¸€è‡´ï¼Œä¸ä¼šå†å‡ºç°'æœ‰æ—¶å€™åˆæ²¡äº†'çš„æƒ…å†µ")
    print("- AIåŒ»ç”Ÿå°†æŒ‰ç…§ç»Ÿä¸€æ ‡å‡†æä¾›è§„èŒƒçš„ä¸­åŒ»å¤„æ–¹")
    print("- å¤„æ–¹æ›´åŠ ç¬¦åˆä¸­åŒ»ç†è®ºå’Œç°ä»£ä¸´åºŠå®è·µ")
    
    return True

if __name__ == "__main__":
    test_prescription_format()