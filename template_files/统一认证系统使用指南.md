# ç»Ÿä¸€è®¤è¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ‰ å·²å®Œæˆçš„å·¥ä½œ

### âœ… é˜¶æ®µ1-4: æ ¸å¿ƒç³»ç»Ÿå®ç° (å·²å®Œæˆ)

1. **æ•°æ®åº“ç»“æ„**:
   - âœ… `doctors`è¡¨æ·»åŠ `user_id`å­—æ®µ
   - âœ… åˆ›å»º`patients`æ‰©å±•è¡¨
   - âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ

2. **æ ¸å¿ƒæœåŠ¡**:
   - âœ… `UnifiedAuthService` - ç»Ÿä¸€è®¤è¯æœåŠ¡
   - âœ… ç»Ÿä¸€ç™»å½•/ç™»å‡º/ä¼šè¯ç®¡ç†
   - âœ… è§’è‰²æƒé™æ§åˆ¶

3. **APIæ¥å£**:
   - âœ… `/api/auth/login` - ç»Ÿä¸€ç™»å½•
   - âœ… `/api/auth/logout` - ç»Ÿä¸€ç™»å‡º
   - âœ… `/api/auth/session` - ä¼šè¯ä¿¡æ¯
   - âœ… `/api/auth/me` - ç”¨æˆ·ä¿¡æ¯
   - âœ… `/api/auth/doctor/current` - å…¼å®¹æ—§API

4. **ä¾èµ–æ³¨å…¥**:
   - âœ… `get_current_user` - ç»Ÿä¸€è®¤è¯ä¾èµ–
   - âœ… `require_roles` - è§’è‰²æ§åˆ¶
   - âœ… `require_doctor/patient/admin` - ä¾¿æ·è§’è‰²ä¾èµ–
   - âœ… å‘ä¸‹å…¼å®¹æ—§ç³»ç»Ÿtoken

---

## ğŸ“‹ åç»­æ­¥éª¤

### æ­¥éª¤5: æ•°æ®è¿ç§» (éœ€è¦æ‰§è¡Œ)

#### 5.1 è¿ç§»ç°æœ‰åŒ»ç”Ÿè´¦æˆ·

ç›®å‰å¼ ä»²æ™¯å·²è¿ç§»,ä½†éœ€è¦è®¾ç½®å¯†ç :

```bash
# ä¸ºå¼ ä»²æ™¯è®¾ç½®å¯†ç 
python3 << 'EOF'
import sqlite3
import hashlib
import secrets

# ç”Ÿæˆå¯†ç å“ˆå¸Œ
password = "zhang123"  # ä¸´æ—¶å¯†ç 
salt = secrets.token_hex(16)
password_hash = hashlib.pbkdf2_hmac('sha256', password.encode(), salt.encode(), 100000).hex()

# æ›´æ–°å¯†ç 
conn = sqlite3.connect("/opt/tcm-ai/data/user_history.sqlite")
cursor = conn.cursor()

cursor.execute("""
    UPDATE unified_users
    SET password_hash = ?, salt = ?
    WHERE username = 'TCM-ZZJ-001'
""", (password_hash, salt))

conn.commit()
print(f"âœ… å¼ ä»²æ™¯å¯†ç å·²è®¾ç½®: zhang123")
print(f"   Username: TCM-ZZJ-001")
print(f"   Salt: {salt}")
conn.close()
EOF
```

#### 5.2 è¿ç§»å…¶ä»–åŒ»ç”Ÿ

```bash
# æ‰¹é‡è¿ç§»æ‰€æœ‰activeåŒ»ç”Ÿ
sqlite3 /opt/tcm-ai/data/user_history.sqlite << 'EOF'
-- è¿ç§»å‰©ä½™åŒ»ç”Ÿ
INSERT OR IGNORE INTO unified_users (
    global_user_id, username, display_name, password_hash, salt,
    account_status, security_level, registration_source
)
SELECT
    'usr_doctor_' || id,
    license_no,
    name,
    'ä¸´æ—¶å¯†ç éœ€é‡ç½®',
    hex(randomblob(16)),
    'active',
    'verified',
    'doctor_migration'
FROM doctors
WHERE status = 'active'
AND id NOT IN (
    SELECT CAST(REPLACE(global_user_id, 'usr_doctor_', '') AS INTEGER)
    FROM unified_users
    WHERE global_user_id LIKE 'usr_doctor_%'
);

-- åˆ†é…DOCTORè§’è‰²
INSERT OR IGNORE INTO user_roles_new (
    user_id, role_name, is_primary, assigned_by, assigned_reason
)
SELECT
    'usr_doctor_' || d.id,
    'DOCTOR',
    1,
    'system',
    'åŒ»ç”Ÿæ•°æ®è¿ç§»'
FROM doctors d
WHERE d.status = 'active'
AND NOT EXISTS (
    SELECT 1 FROM user_roles_new ur
    WHERE ur.user_id = 'usr_doctor_' || d.id
);

-- å…³è”user_id
UPDATE doctors
SET user_id = 'usr_doctor_' || id
WHERE status = 'active' AND user_id IS NULL;

-- æŸ¥çœ‹ç»“æœ
SELECT COUNT(*) as migrated_doctors FROM unified_users WHERE global_user_id LIKE 'usr_doctor_%';
SELECT COUNT(*) as doctor_roles FROM user_roles_new WHERE role_name = 'DOCTOR';
EOF
```

### æ­¥éª¤6: æµ‹è¯•ç»Ÿä¸€è®¤è¯

#### 6.1 æµ‹è¯•ç™»å½•

```bash
# 1. å¼ ä»²æ™¯åŒ»ç”Ÿç™»å½•
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "TCM-ZZJ-001",
    "password": "zhang123"
  }' | python3 -m json.tool

# æœŸæœ›è¾“å‡º:
# {
#   "success": true,
#   "session_token": "xxx",
#   "user": {...},
#   "roles": ["DOCTOR"],
#   "profile": {"doctor": {...}}
# }
```

#### 6.2 æµ‹è¯•ä¼šè¯éªŒè¯

```bash
# ä½¿ç”¨ç™»å½•è¿”å›çš„session_token
TOKEN="<session_token>"

curl -X GET "http://localhost:8000/api/auth/me" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool
```

#### 6.3 æµ‹è¯•å…¼å®¹æ€§API

```bash
# æ—§çš„åŒ»ç”Ÿç«¯APIåº”è¯¥ç»§ç»­å·¥ä½œ
curl -X GET "http://localhost:8000/api/doctor/current" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool
```

---

## ğŸ”§ å‰ç«¯æ”¹é€ æŒ‡å—

### æ–¹æ¡ˆA: æ–°é¡µé¢ä½¿ç”¨æ–°API (æ¨è)

```javascript
// ç»Ÿä¸€ç™»å½•
async function login(username, password) {
    const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: username,
            password: password,
            login_method: 'password'
        })
    });

    const result = await response.json();

    if (result.success) {
        // ä¿å­˜token
        localStorage.setItem('session_token', result.session_token);
        localStorage.setItem('user', JSON.stringify(result.user));
        localStorage.setItem('roles', JSON.stringify(result.roles));

        return result;
    } else {
        throw new Error(result.message);
    }
}

// ç»Ÿä¸€è®¤è¯è¯·æ±‚
async function authenticatedRequest(url, options = {}) {
    const token = localStorage.getItem('session_token');

    const response = await fetch(url, {
        ...options,
        headers: {
            ...options.headers,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });

    return response;
}

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
async function getCurrentUser() {
    const response = await authenticatedRequest('/api/auth/me');
    const result = await response.json();
    return result.user;
}

// ç™»å‡º
async function logout() {
    await authenticatedRequest('/api/auth/logout', {method: 'POST'});
    localStorage.clear();
    window.location.href = '/login';
}
```

### æ–¹æ¡ˆB: å…¼å®¹æ—§ä»£ç 

æ—§çš„ `/api/doctor/current` å·²ç»è‡ªåŠ¨å…¼å®¹æ–°è®¤è¯ç³»ç»Ÿ,æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ã€‚

---

## ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥

### æ£€æŸ¥è¿ç§»çŠ¶æ€

```bash
sqlite3 /opt/tcm-ai/data/user_history.sqlite << 'EOF'
-- ç»Ÿè®¡è¿ç§»æƒ…å†µ
SELECT '=== ç»Ÿä¸€ç”¨æˆ·è¡¨ ===' as section;
SELECT
    COUNT(*) as total_users,
    COUNT(CASE WHEN global_user_id LIKE 'usr_doctor_%' THEN 1 END) as doctors,
    COUNT(CASE WHEN global_user_id LIKE 'usr_patient_%' THEN 1 END) as patients
FROM unified_users;

SELECT '=== è§’è‰²åˆ†é… ===' as section;
SELECT
    role_name,
    COUNT(*) as count
FROM user_roles_new
WHERE is_active = 1
GROUP BY role_name;

SELECT '=== åŒ»ç”Ÿå…³è”çŠ¶æ€ ===' as section;
SELECT
    COUNT(*) as total_doctors,
    COUNT(user_id) as linked_doctors,
    COUNT(*) - COUNT(user_id) as unlinked_doctors
FROM doctors
WHERE status = 'active';

SELECT '=== æ´»è·ƒä¼šè¯ ===' as section;
SELECT
    COUNT(*) as active_sessions
FROM unified_sessions
WHERE session_status = 'active'
AND expires_at > datetime('now');
EOF
```

---

## ğŸ¯ ä½¿ç”¨æ–°ç³»ç»Ÿçš„ä¼˜åŠ¿

### 1. ç»Ÿä¸€å…¥å£
- æ‰€æœ‰ç”¨æˆ·ç±»å‹ä½¿ç”¨åŒä¸€å¥—ç™»å½•API
- ä¸å†éœ€è¦åŒºåˆ†åŒ»ç”Ÿç™»å½•ã€æ‚£è€…ç™»å½•

### 2. å®‰å…¨å¢å¼º
- ç»Ÿä¸€çš„ä¼šè¯ç®¡ç†å’Œè¿‡æœŸæ§åˆ¶
- å®Œæ•´çš„å®‰å…¨å®¡è®¡æ—¥å¿—
- è®¾å¤‡ç®¡ç†å’Œå¼‚å¸¸æ£€æµ‹

### 3. æƒé™çµæ´»
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
- ä¸´æ—¶è§’è‰²å’Œæƒé™å§”æ´¾

### 4. æ˜“äºæ‰©å±•
- æ–°å¢ç”¨æˆ·ç±»å‹åªéœ€æ·»åŠ è§’è‰²
- æ‰©å±•ä¿¡æ¯å­˜å‚¨åœ¨ä¸“å±è¡¨ä¸­
- ä¸å½±å“æ ¸å¿ƒè®¤è¯é€»è¾‘

### 5. å‘ä¸‹å…¼å®¹
- æ—§çš„tokenç»§ç»­æœ‰æ•ˆ
- å…¼å®¹å±‚è‡ªåŠ¨è½¬æ¢
- é€æ­¥è¿ç§»,æ— éœ€ä¸€æ¬¡æ€§åˆ‡æ¢

---

## â“ å¸¸è§é—®é¢˜

### Q: æ—§çš„åŒ»ç”ŸJWT tokenè¿˜èƒ½ç”¨å—?
**A**: èƒ½!å…¼å®¹å±‚ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæ–°çš„UserSessionå¯¹è±¡ã€‚ä½†å»ºè®®é€æ­¥è¿ç§»åˆ°æ–°ç³»ç»Ÿã€‚

### Q: æ‚£è€…å¦‚ä½•ç™»å½•?
**A**: ä½¿ç”¨ `/api/auth/login`,ç”¨æˆ·åå¯ä»¥æ˜¯æ‰‹æœºå·ã€é‚®ç®±æˆ–ç”¨æˆ·åã€‚

### Q: å¦‚ä½•ç»™ç”¨æˆ·åˆ†é…å¤šä¸ªè§’è‰²?
**A**: åœ¨ `user_roles_new` è¡¨æ’å…¥å¤šæ¡è®°å½•,è®¾ç½®ä¸åŒçš„ `role_name`ã€‚

### Q: å¯†ç å¦‚ä½•é‡ç½®?
**A**: ç›®å‰éœ€è¦æ•°æ®åº“æ“ä½œã€‚åç»­å¯å®ç° `/api/auth/reset-password` æ¥å£ã€‚

### Q: å…¼å®¹å±‚ä»€ä¹ˆæ—¶å€™å¯ä»¥ç§»é™¤?
**A**: ç­‰æ‰€æœ‰å‰ç«¯ä»£ç è¿ç§»åˆ°æ–°API,å¹¶ä¸”æ‰€æœ‰ç”¨æˆ·é‡æ–°ç™»å½•ä¸€æ¬¡åã€‚

---

## ğŸ“ ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

1. **å¯†ç é‡ç½®åŠŸèƒ½**
   - å®ç° `/api/auth/forgot-password`
   - é‚®ç®±/çŸ­ä¿¡éªŒè¯ç 

2. **æ³¨å†ŒåŠŸèƒ½**
   - å®ç° `/api/auth/register`
   - æ‚£è€…è‡ªåŠ©æ³¨å†Œ
   - åŒ»ç”Ÿæ³¨å†Œå®¡æ ¸

3. **å¤šè®¾å¤‡ç®¡ç†**
   - æŸ¥çœ‹æ‰€æœ‰ç™»å½•è®¾å¤‡
   - è¿œç¨‹ç™»å‡ºå…¶ä»–è®¾å¤‡

4. **OAuthé›†æˆ**
   - å¾®ä¿¡ç™»å½•
   - æ”¯ä»˜å®ç™»å½•

5. **æƒé™ç»†åŒ–**
   - ä»è§’è‰²çº§ç»†åŒ–åˆ°åŠŸèƒ½çº§
   - å®ç°æƒé™æ£€æŸ¥è£…é¥°å™¨

6. **ç›‘æ§å’Œå®¡è®¡**
   - ç™»å½•å¤±è´¥å‘Šè­¦
   - å¼‚å¸¸ç™»å½•æ£€æµ‹
   - å®Œæ•´å®¡è®¡æ—¥å¿—

---

**æ­å–œ!ç»Ÿä¸€è®¤è¯ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ ğŸ‰**

ç°åœ¨ä½ çš„ç³»ç»Ÿæœ‰äº†ä¸€ä¸ªç»Ÿä¸€ã€å®‰å…¨ã€çµæ´»çš„è®¤è¯åŸºç¡€ã€‚
