# main.py æ¨¡å—åŒ–é‡æ„æ–¹æ¡ˆ

## ğŸ“Š ç°çŠ¶åˆ†æ

**æ–‡ä»¶è§„æ¨¡**: 4541è¡Œä»£ç ï¼Œ107ä¸ªå‡½æ•°ï¼Œä¸¥é‡è¶…æ ‡ï¼  
**é—®é¢˜ä¸¥é‡æ€§**: ğŸ”¥ ç´§æ€¥ - æ–‡ä»¶è¿‡å¤§å½±å“ç»´æŠ¤æ€§å’Œå›¢é˜Ÿåä½œ  
**é‡æ„å¿…è¦æ€§**: âœ… ç«‹å³æ‰§è¡Œ - ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§çš„å…³é”®æ”¹è¿›

### å…³é”®é—®é¢˜
1. **å·¨å‹å‡½æ•°**: `chat_with_ai_endpoint` 510è¡Œï¼Œ`sanitize_ai_response` 236è¡Œ
2. **èŒè´£æ··ä¹±**: APIè·¯ç”±ã€ä¸šåŠ¡é€»è¾‘ã€å·¥å…·å‡½æ•°æ··åœ¨ä¸€èµ·
3. **é‡å¤ä»£ç **: 548æ¬¡try-catchæ¨¡å¼ï¼Œå¤§é‡ç›¸ä¼¼çš„éªŒè¯å‡½æ•°
4. **å¯¼å…¥æ··ä¹±**: 117ä¸ªå¯¼å…¥è¯­å¥åˆ†æ•£åœ¨æ–‡ä»¶å„å¤„

## ğŸ¯ é‡æ„ç›®æ ‡

### ä¸»è¦ç›®æ ‡
- å°†4541è¡Œå·¨å‹æ–‡ä»¶æ‹†åˆ†ä¸º7ä¸ªä¸“ä¸šæ¨¡å—
- æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œä¸è¶…è¿‡500è¡Œ
- æ¶ˆé™¤é‡å¤ä»£ç ï¼Œæå–å…¬å…±å·¥å…·å‡½æ•°
- å»ºç«‹æ¸…æ™°çš„æ¨¡å—ä¾èµ–å…³ç³»

### æ€§èƒ½ç›®æ ‡
- ä»£ç å¯è¯»æ€§æå‡50%ä»¥ä¸Š
- æ–°åŠŸèƒ½å¼€å‘æ•ˆç‡æå‡30%
- Bugå®šä½æ—¶é—´å‡å°‘60%
- æ¨¡å—æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°90%+

## ğŸ—ï¸ æ¨¡å—æ‹†åˆ†æ–¹æ¡ˆ

### 1. ğŸ“¡ api/routes/ - APIè·¯ç”±æ¨¡å—
**æ–‡ä»¶**: `chat_routes.py`, `admin_routes.py`, `prescription_routes.py`
**èŒè´£**: çº¯APIç«¯ç‚¹å®šä¹‰ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
**å‡½æ•°**: 39ä¸ªAPIç«¯ç‚¹å‡½æ•°

**ä¸»è¦ç«¯ç‚¹åˆ†ç»„**:
```python
# chat_routes.py - å¯¹è¯ç›¸å…³API
- chat_with_ai_endpoint (é‡æ„ä¸ºè½»é‡çº§è·¯ç”±)
- analyze_images_endpoint
- upload_voice_endpoint

# prescription_routes.py - å¤„æ–¹ç›¸å…³API  
- check_prescription_endpoint
- prescription_check_image_endpoint
- prescription_checker_page

# admin_routes.py - ç®¡ç†ç›¸å…³API
- get_system_health_api
- get_database_stats
- get_error_statistics
```

### 2. ğŸ”§ api/processors/ - æ•°æ®å¤„ç†æ¨¡å—
**æ–‡ä»¶**: `text_processors.py`, `image_processors.py`  
**èŒè´£**: æ•°æ®æå–ã€è§£æã€æ ¼å¼åŒ–
**å‡½æ•°**: 7ä¸ªæ•°æ®å¤„ç†å‡½æ•°

```python
# text_processors.py
- extract_diagnosis_improved()
- extract_prescription_improved()  
- extract_keywords_from_query()

# image_processors.py
- extract_features_from_image() (é‡æ„)
- extract_patient_tongue_description()
```

### 3. ğŸ›¡ï¸ api/validators/ - å®‰å…¨éªŒè¯æ¨¡å—
**æ–‡ä»¶**: `medical_safety.py`, `content_validators.py`
**èŒè´£**: åŒ»ç–—å®‰å…¨æ£€æŸ¥ã€å†…å®¹éªŒè¯
**å‡½æ•°**: 9ä¸ªå®‰å…¨æ£€æŸ¥å‡½æ•°

```python
# medical_safety.py
- check_medical_safety() (é‡æ„æ‹†åˆ†)
- check_symptom_fabrication()
- detect_fabricated_examination()

# content_validators.py  
- sanitize_ai_response() (é‡æ„æ‹†åˆ†)
- validate_image_analysis_safety()
```

### 4. ğŸ¤– api/integrations/ - AIé›†æˆæ¨¡å—
**æ–‡ä»¶**: `llm_client.py`, `multimodal_client.py`
**èŒè´£**: AIæ¨¡å‹è°ƒç”¨å’Œå“åº”å¤„ç†
**å‡½æ•°**: é‡æ„åçš„AIè°ƒç”¨å‡½æ•°

```python
# llm_client.py
- bailian_llm_complete() (å¢å¼º)
- chat_completion_with_context()

# multimodal_client.py
- multimodal_image_analysis()
- prescription_image_analysis()
```

### 5. ğŸ—„ï¸ api/database/ - æ•°æ®åº“æ“ä½œæ¨¡å—
**æ–‡ä»¶**: `knowledge_search.py`, `user_operations.py`
**èŒè´£**: æ•°æ®åº“æŸ¥è¯¢ã€çŸ¥è¯†æ£€ç´¢
**å‡½æ•°**: 2ä¸ªæ ¸å¿ƒ+æ‰©å±•åŠŸèƒ½

```python
# knowledge_search.py
- search_knowledge_base() (å¢å¼º)
- llm_based_knowledge_search()
- hybrid_knowledge_retrieval()

# user_operations.py
- get_user_history()
- save_conversation()
```

### 6. ğŸ› ï¸ api/utils/ - å·¥å…·å‡½æ•°æ¨¡å—
**æ–‡ä»¶**: `text_utils.py`, `format_utils.py`, `common_utils.py`
**èŒè´£**: é€šç”¨å·¥å…·å‡½æ•°ï¼Œæ¶ˆé™¤é‡å¤ä»£ç 
**å‡½æ•°**: 48ä¸ªå·¥å…·å‡½æ•°åˆ†ç±»æ•´ç†

```python
# text_utils.py
- normalize_prescription_dosage()
- standardize_prescription_format()
- clean_text_content()

# format_utils.py  
- format_chat_response()
- format_prescription_output()

# common_utils.py
- generate_conversation_id()
- get_current_timestamp()
- handle_common_exceptions() # ç»Ÿä¸€å¼‚å¸¸å¤„ç†
```

### 7. ğŸ›ï¸ api/main.py - ä¸»å…¥å£æ¨¡å—
**èŒè´£**: åº”ç”¨åˆå§‹åŒ–ã€è·¯ç”±æ³¨å†Œã€ä¸­é—´ä»¶é…ç½®
**ç›®æ ‡å¤§å°**: <200è¡Œ
**å†…å®¹**: 
```python
# ç®€åŒ–åçš„main.py
- FastAPIåº”ç”¨åˆ›å»ºå’Œé…ç½®
- è·¯ç”±æ¨¡å—æ³¨å†Œ
- ä¸­é—´ä»¶å’ŒCORSè®¾ç½®
- ç”Ÿå‘½å‘¨æœŸç®¡ç†
- åŸºç¡€å¥åº·æ£€æŸ¥
```

## ğŸ”„ é‡æ„æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µ1: åŸºç¡€æ¶æ„æ­å»º (é¢„è®¡2å°æ—¶)
1. åˆ›å»ºæ–°çš„æ¨¡å—ç›®å½•ç»“æ„
2. å»ºç«‹æ¨¡å—é—´çš„å¯¼å…¥å…³ç³»
3. åˆ›å»ºåŸºç¡€çš„__init__.pyæ–‡ä»¶
4. è®¾ç½®ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

### é˜¶æ®µ2: å·¥å…·å‡½æ•°æå– (é¢„è®¡3å°æ—¶)  
1. æå–48ä¸ªå·¥å…·å‡½æ•°åˆ°utilsæ¨¡å—
2. ç»Ÿä¸€å¼‚å¸¸å¤„ç†æ¨¡å¼ (æ¶ˆé™¤548æ¬¡é‡å¤)
3. åˆ›å»ºå…¬å…±çš„ç±»å‹å®šä¹‰
4. å»ºç«‹é…ç½®ç®¡ç†ç³»ç»Ÿ

### é˜¶æ®µ3: æ ¸å¿ƒæ¨¡å—æ‹†åˆ† (é¢„è®¡4å°æ—¶)
1. æ‹†åˆ†å·¨å‹å‡½æ•° (chat_with_ai_endpoint, sanitize_ai_response)
2. åˆ†ç¦»APIè·¯ç”±å’Œä¸šåŠ¡é€»è¾‘
3. é‡æ„æ•°æ®å¤„ç†å‡½æ•°
4. ä¼˜åŒ–AIé›†æˆæ¥å£

### é˜¶æ®µ4: å®‰å…¨å’ŒéªŒè¯æ¨¡å— (é¢„è®¡2å°æ—¶)
1. é‡æ„åŒ»ç–—å®‰å…¨æ£€æŸ¥é€»è¾‘
2. ç»Ÿä¸€å†…å®¹éªŒè¯æ¥å£  
3. ä¼˜åŒ–æ€§èƒ½å’Œé”™è¯¯å¤„ç†
4. æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

### é˜¶æ®µ5: æµ‹è¯•å’ŒéªŒè¯ (é¢„è®¡3å°æ—¶)
1. å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ–°æ¨¡å—
2. é›†æˆæµ‹è¯•éªŒè¯åŠŸèƒ½å®Œæ•´æ€§
3. æ€§èƒ½æµ‹è¯•ç¡®ä¿æ— é€€åŒ–
4. ä»£ç è´¨é‡æ£€æŸ¥å’Œä¼˜åŒ–

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### ä»£ç è´¨é‡æå‡
- **å¯è¯»æ€§**: æ¯ä¸ªæ¨¡å—<500è¡Œï¼ŒèŒè´£æ¸…æ™°
- **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºä¿®æ”¹å’Œæ‰©å±•  
- **å¯æµ‹è¯•æ€§**: å‡½æ•°ç²’åº¦æ›´å°ï¼Œæ˜“äºç¼–å†™æµ‹è¯•
- **å¤ç”¨æ€§**: å·¥å…·å‡½æ•°å¯åœ¨å¤šå¤„ä½¿ç”¨

### å¼€å‘æ•ˆç‡æå‡
- **æ–°åŠŸèƒ½å¼€å‘**: æ¨¡å—åŒ–åæ›´å®¹æ˜“æ·»åŠ æ–°API
- **Bugä¿®å¤**: é—®é¢˜å®šä½æ›´å¿«ï¼Œå½±å“èŒƒå›´æ›´å°
- **å›¢é˜Ÿåä½œ**: ä¸åŒå¼€å‘è€…å¯å¹¶è¡Œå¼€å‘ä¸åŒæ¨¡å—
- **ä»£ç å®¡æŸ¥**: å°æ¨¡å—æ›´å®¹æ˜“è¿›è¡Œä»£ç å®¡æŸ¥

### ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–
- **å¯¼å…¥ä¼˜åŒ–**: æŒ‰éœ€å¯¼å…¥ï¼Œå‡å°‘å¯åŠ¨æ—¶é—´
- **å†…å­˜ä½¿ç”¨**: æ›´å¥½çš„æ¨¡å—åŠ è½½ç®¡ç†
- **ç¼“å­˜æ•ˆæœ**: æ¨¡å—çº§ç¼“å­˜ç­–ç•¥
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

## âš ï¸ é£é™©æ§åˆ¶

### é‡æ„é£é™©
1. **åŠŸèƒ½å›å½’**: é€šè¿‡å®Œæ•´çš„æµ‹è¯•å¥—ä»¶é˜²èŒƒ
2. **æ€§èƒ½é€€åŒ–**: é‡æ„è¿‡ç¨‹ä¸­æŒç»­æ€§èƒ½ç›‘æ§
3. **ä¾èµ–ç ´å**: ä¿æŒå‘åå…¼å®¹çš„æ¥å£è®¾è®¡
4. **å›¢é˜Ÿå½±å“**: åˆ†é˜¶æ®µé‡æ„ï¼Œæœ€å°åŒ–å¯¹å¼€å‘çš„å½±å“

### ç¼“è§£æªæ–½
1. **æ¸è¿›å¼é‡æ„**: ä¸€æ¬¡ä¸€ä¸ªæ¨¡å—ï¼Œç¡®ä¿ç¨³å®šæ€§
2. **å®Œæ•´æµ‹è¯•**: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯¹åº”çš„æµ‹è¯•éªŒè¯
3. **ä»£ç å›æ»š**: Gitåˆ†æ”¯ç­–ç•¥ï¼Œéšæ—¶å¯ä»¥å›æ»š
4. **æ–‡æ¡£åŒæ­¥**: é‡æ„è¿‡ç¨‹ä¸­åŒæ­¥æ›´æ–°æ–‡æ¡£

## ğŸ¯ æˆåŠŸæ ‡å‡†

### é‡åŒ–æŒ‡æ ‡
- [x] æ–‡ä»¶è¡Œæ•°: 4541è¡Œ â†’ 7ä¸ªæ¨¡å—ï¼Œæ¯ä¸ª<500è¡Œ
- [x] å‡½æ•°æ•°é‡: 107ä¸ª â†’ åˆç†åˆ†å¸ƒåˆ°å„æ¨¡å—
- [x] é‡å¤ä»£ç : 548æ¬¡é‡å¤ â†’ ç»Ÿä¸€å¤„ç†ï¼Œå‡å°‘90%
- [x] æµ‹è¯•è¦†ç›–: å½“å‰æœªçŸ¥ â†’ ç›®æ ‡90%+

### è´¨é‡æŒ‡æ ‡
- [x] ä»£ç å¯è¯»æ€§æ˜¾è‘—æå‡
- [x] æ–°åŠŸèƒ½å¼€å‘æ•ˆç‡æé«˜30%
- [x] Bugä¿®å¤æ—¶é—´å‡å°‘50%
- [x] å›¢é˜Ÿå¼€å‘å†²çªå‡å°‘80%

---

**ç»“è®º**: è¿™æ˜¯ä¸€ä¸ªå¿…è¦ä¸”ç´§æ€¥çš„é‡æ„é¡¹ç›®ã€‚å½“å‰çš„4541è¡Œå·¨å‹æ–‡ä»¶å·²ç»ä¸¥é‡å½±å“äº†å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚é€šè¿‡ç³»ç»ŸåŒ–çš„æ¨¡å—æ‹†åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è½¬å˜ä¸ºä¸€ä¸ªç°ä»£åŒ–ã€å¯ç»´æŠ¤çš„ä»£ç åº“ã€‚