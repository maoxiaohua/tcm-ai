# TCM-AI 智能回复模板系统

## 设计原则

### 1. 预防胜于治疗
- 与其后处理筛选，不如前置控制格式
- 从AI输入端严格要求输出格式
- 杜绝需要安全检查的内容产生

### 2. 标准化一致性
- 所有医生使用统一的回复模板
- 保证医疗安全声明的一致性
- 确保处方格式的规范性

## 模板分类系统

### A. 问诊阶段模板

#### A1. 初始问诊模板
```
您好！我是{医生名称}，{流派简介}。

根据您描述的症状：{症状总结}

为了准确辨证论治，还需了解：
1. {针对性问题1}
2. {针对性问题2}
3. {针对性问题3}

请详细说明以上情况，以便为您制定精准的治疗方案。
```

#### A2. 深入问诊模板
```
根据您提供的信息：{已知症状总结}

{初步分析}，需要进一步了解：
1. {深入问题1}
2. {深入问题2}

**医疗提示**：症状描述越详细，诊断越准确。
```

#### A3. 重复问询处理模板
```
感谢您的耐心。我已了解到您的症状包括：{症状列表}

基于这些信息，{辨证分析}

{继续问诊/给出处方的决策}
```

### B. 诊断阶段模板

#### B1. 证候分析模板
```
【辨证分析】
根据您的症状：{症状归纳}
舌脉表现：{舌象脉象}
病程特点：{病程分析}

**证候诊断**：{证候名称}
**病机分析**：{病机解释}

【治疗方案】
{是否需要更多信息/直接处方}
```

### C. 处方阶段模板

#### C1. 完整处方模板
```
【处方方案】

**基本信息**
- 患者症状：{症状总结}
- 证候诊断：{证候}
- 治法：{治法}

**方剂组成**

【君药】
- {药名} {剂量}g ({作用说明})

【臣药】
- {药名} {剂量}g ({作用说明})
- {药名} {剂量}g ({作用说明})

【佐药】
- {药名} {剂量}g ({作用说明})
- {药名} {剂量}g ({作用说明})

【使药】
- {药名} {剂量}g ({作用说明})

**煎服方法**
每日一剂，水煎服，分早晚两次温服。

**注意事项**
1. 忌辛辣生冷食物
2. 保持心情舒畅
3. 按时服药，观察疗效

**重要声明**
本处方为AI预诊建议，请务必咨询专业中医师后使用。仅供参考，不可替代面诊。
```

#### C2. 临时建议模板
```
【初步处方建议】

基于目前症状，初步考虑：{初步方案}

**需要补充信息**：
- {需要了解的信息1}
- {需要了解的信息2}

**临时调理建议**：
1. {生活调理建议1}
2. {生活调理建议2}

**注意**：完整处方需要更详细的四诊信息，建议提供后确认。
```

### D. 安全控制模板

#### D1. 医疗边界声明模板
```
**重要提醒**：
- 本咨询为AI中医预诊，不能替代专业医师面诊
- 如症状严重或持续不缓解，请及时就医
- 处方仅供参考，使用前请咨询执业中医师
```

#### D2. 紧急情况处理模板
```
**紧急提醒**：
根据您描述的症状，建议您立即前往医院急诊科就诊。

AI中医咨询主要针对慢性调理，对于急性严重症状，专业医疗机构能提供更及时有效的治疗。

请不要延误治疗时机。
```

## 模板使用规则

### 1. 强制使用原则
- AI必须且只能使用预定义模板回复
- 不允许自由发挥，严格按模板填空
- 所有输出必须包含安全声明

### 2. 内容填充规则
- {占位符}内容基于患者具体信息填充
- 药物名称严格限制为中药材
- 剂量必须在安全范围内
- 禁止出现西药成分

### 3. 阶段判断逻辑
```
信息量不足 → 使用问诊模板
信息基本完整 → 使用诊断模板  
信息完全充足 → 使用处方模板
检测到危险 → 使用紧急模板
```

## 技术实现方案

### 1. 模板引擎设计
```python
class TCMResponseTemplateEngine:
    def __init__(self):
        self.templates = self.load_templates()
        self.safety_filters = self.init_safety_filters()
    
    def generate_response(self, stage, doctor, patient_info):
        template = self.select_template(stage, doctor)
        response = self.fill_template(template, patient_info)
        return self.validate_and_finalize(response)
```

### 2. AI提示词改进
```
你必须严格按照以下模板回复：

{模板内容}

填空规则：
1. 只能填写{占位符}部分
2. 禁止添加模板外内容
3. 必须使用纯中药
4. 必须包含安全声明
```

### 3. 后处理简化
```python
# 从复杂的安全检查变为简单的模板验证
def validate_response(response):
    return (
        contains_required_sections(response) and
        follows_template_format(response) and
        includes_safety_disclaimer(response)
    )
```

## 优势分析

### 1. 质量保证
- ✅ 格式统一，专业规范
- ✅ 安全声明强制包含
- ✅ 西药过滤在源头解决

### 2. 维护简化
- ✅ 只需维护模板，不需复杂过滤逻辑
- ✅ 新增医生只需配置模板映射
- ✅ 内容更新集中管理

### 3. 性能提升
- ✅ 减少后处理计算开销
- ✅ 降低AI调用失败率
- ✅ 提高响应一致性

### 4. 可扩展性
- ✅ 新模板易于添加
- ✅ 多语言支持友好
- ✅ A/B测试便于实施

这个模板化系统将彻底解决当前的内容质量问题，你觉得这个方案如何？我们可以立即开始实施。