# 决策树构建器使用指南

## 快速开始

访问地址：https://mxh0510.cn/static/decision_tree_visual_builder.html

## 核心功能概览

### 1. 🎨 决策树构建（保留）
**手动构建医生诊疗思维**
- ✅ 右键添加节点
- ✅ 双击编辑内容
- ✅ 拖拽调整位置
- ✅ 自动排列布局

### 2. 💊 AI分析决策树（✨ 已恢复）
**智能方剂分析功能**
- ✅ 自动提取病种证型
- ✅ AI推荐方剂组成
- ✅ 智能剂量建议
- ✅ 用法煎服指导

### 3. 📋 历史决策树管理（✨ 新增）
**查看和复用已保存的决策树**
- ✅ 查看所有历史记录
- ✅ 一键加载到画布
- ✅ 快速修改和更新
- ✅ 删除无用记录

### 4. 💾 保存到思维库（保留）
**持久化医生临床经验**
- ✅ 保存完整决策树
- ✅ 记录诊疗思路
- ✅ 追踪使用次数
- ✅ 支持后续调用

## 详细使用步骤

### 场景1：首次创建决策树

**Step 1: 输入基础信息**
```
1. 在"疾病名称"输入框填写：如"失眠"
2. 在"诊疗思路"文本框填写您的思路：
   例如："失眠多因心火旺盛或心脾两虚所致。
         心火旺盛证见舌红苔黄，治以清心火，
         方用黄连阿胶汤。心脾两虚证见面色萎黄，
         治以补益心脾，方用归脾汤。"
```

**Step 2: 构建节点**
```
1. 在画布空白处右键
2. 选择"添加症状节点"
3. 输入症状名称：如"失眠"
4. 继续添加其他节点（条件、诊断、处方等）
```

**Step 3: 连接节点**
```
1. 点击起始节点
2. 拖拽到目标节点
3. 自动建立连线关系
```

**Step 4: 使用AI分析**
```
1. 添加至少一个方剂节点
2. 点击侧边栏"💊 方剂AI分析"按钮
3. 等待AI分析（2-5秒）
4. 查看分析结果：
   - 病种诊断
   - 证型分析
   - 方剂组成
   - 剂量建议
   - 用法指导
```

**Step 5: 保存到思维库**
```
1. 点击"💾 保存到思维库"按钮
2. 确认疾病名称和诊疗思路
3. 系统自动保存决策树结构
4. 显示保存成功提示
```

### 场景2：查看和使用历史决策树

**Step 1: 打开历史记录**
```
1. 点击侧边栏"📋 查看历史决策树"按钮
2. 弹出历史记录模态框
3. 显示所有已保存的决策树
```

**Step 2: 浏览历史记录**
```
每条记录显示：
- 🏷️ 疾病名称（标题）
- 📅 创建时间
- 📊 使用次数
- 📝 诊疗思路摘要（前150字）
```

**Step 3: 加载历史决策树**
```
1. 找到需要的决策树
2. 点击"📂 加载"按钮
3. 系统自动恢复：
   - 疾病名称
   - 诊疗思路
   - 所有节点和连线
4. 模态框自动关闭
5. 画布显示完整决策树
```

**Step 4: 修改和更新**
```
1. 加载后可以直接修改
2. 添加新节点或删除旧节点
3. 修改诊疗思路
4. 重新保存（覆盖原记录）
```

**Step 5: 删除不需要的记录**
```
1. 点击"🗑️ 删除"按钮
2. 确认删除提示
3. 记录从列表中移除
```

### 场景3：基于历史快速创建新决策树

**最佳实践**：
```
1. 点击"📋 查看历史决策树"
2. 找到相似的疾病决策树
3. 点击"📂 加载"
4. 修改疾病名称（如"失眠" → "心悸"）
5. 修改诊疗思路
6. 调整节点内容
7. 点击"💊 方剂AI分析"获取新建议
8. 另存为新的决策树
```

## 按钮功能说明

### 侧边栏按钮（从上到下）

| 按钮 | 功能 | 快捷键 |
|------|------|--------|
| 🔄 清空画布 | 删除所有节点和连线 | - |
| ↩️ 撤销 | 撤销上一步操作 | Ctrl+Z |
| ↪️ 重做 | 重做被撤销的操作 | Ctrl+Y |
| 📐 自动排列 | 智能布局所有节点 | - |
| 💾 保存到思维库 | 保存当前决策树 | - |
| 💊 方剂AI分析 | AI分析方剂组成 | - |
| 📋 查看历史决策树 | 打开历史记录 | - |
| 💾 保存JSON | 导出JSON文件 | - |
| 📁 加载JSON | 导入JSON文件 | - |
| 📸 导出图片 | 导出PNG图片 | - |

### 右键菜单（节点上右键）

| 选项 | 功能 |
|------|------|
| ✏️ 编辑节点 | 修改节点内容 |
| 🗑️ 删除节点 | 删除选中节点 |
| ➕ 添加子节点 | 在下方添加连接节点 |
| 🔗 连接到... | 建立连线关系 |

## AI方剂分析详解

### 触发条件
```
✅ 必须有疾病名称
✅ 必须有至少1个方剂节点
✅ 建议填写诊疗思路（提高准确性）
```

### 分析内容
```
1. 病种识别
   - 自动从诊疗思路中提取病种
   - 识别主要证型

2. 证型诊断
   - 辨证分析
   - 病机判断

3. 治疗方法
   - 治则治法
   - 理论依据

4. 方剂组成
   - 药材名称
   - 推荐剂量
   - 功效说明

5. 用法指导
   - 煎煮方法
   - 服用剂量
   - 疗程建议
```

### 分析结果示例
```
💊 方剂AI分析结果

病种: 失眠

证型: 心火旺盛证

治法: 清心火，滋阴安神

方剂组成:
  黄连: 6-9g (清心火)
  阿胶: 9-12g (滋阴养血)
  黄芩: 6-9g (泻火除烦)
  白芍: 9-12g (养血柔肝)
  鸡子黄: 2枚 (滋阴安神)

用法: 水煎服，每日2次
煎服: 先煎黄连、黄芩30分钟，后下阿胶烊化，
      冷却后调入鸡子黄
```

## 历史记录管理详解

### 数据存储
```
- 存储位置: 数据库表 doctor_clinical_patterns
- 医生ID: 自动从登录状态获取
- 未登录: 使用临时医生ID（temp_doctor_default）
```

### 记录内容
```
每条历史记录包含：
- pattern_id: 唯一标识符
- doctor_id: 医生ID
- disease_name: 疾病名称
- thinking_process: 完整诊疗思路
- tree_structure: 决策树数据（节点+连线）
- clinical_patterns: 临床模式信息
- doctor_expertise: 医生专长信息
- usage_count: 使用次数
- created_at: 创建时间
- updated_at: 最后更新时间
```

### 加载机制
```
1. 读取pattern_id对应的完整数据
2. 恢复疾病名称到输入框
3. 恢复诊疗思路到文本框
4. 清空当前画布
5. 重建所有节点（位置、类型、内容）
6. 重建所有连线
7. 重新绘制画布
8. 关闭历史记录模态框
```

### 更新策略
```
- 同一医生 + 同一疾病 → 覆盖保存
- 不同疾病 → 新建记录
- 支持手动修改疾病名称实现"另存为"
```

## 常见问题

### Q1: AI分析按钮点击无反应？
```
A: 检查以下条件：
   1. 是否已输入疾病名称？
   2. 是否已添加方剂节点？
   3. 打开F12查看控制台错误信息
   4. 检查网络连接
```

### Q2: 历史记录显示为空？
```
A: 可能原因：
   1. 尚未保存过任何决策树
   2. 医生ID不匹配（切换了账号）
   3. 数据库连接问题

   解决方法：
   - 先保存一个决策树测试
   - 检查登录状态
   - 查看控制台错误
```

### Q3: 加载历史后画布空白？
```
A: 检查项：
   1. 历史记录的tree_structure是否完整
   2. 控制台是否有JavaScript错误
   3. 尝试刷新页面重新加载
```

### Q4: 保存后提示"保存失败"？
```
A: 可能原因：
   1. 未登录或权限不足
   2. 数据库连接问题
   3. 数据格式错误

   解决方法：
   - 检查登录状态
   - 确保填写了疾病名称和诊疗思路
   - 联系系统管理员检查数据库
```

## 技术说明

### API端点
```
1. POST /api/extract_prescription_info
   - 方剂AI分析
   - 参数: thinking_process, formulas, patient_symptoms
   - 返回: 结构化处方信息

2. GET /api/get_doctor_patterns/{doctor_id}
   - 获取医生的所有决策树
   - 可选参数: disease_name
   - 返回: patterns数组

3. POST /api/save_clinical_pattern
   - 保存决策树到思维库
   - 参数: 完整决策树数据
   - 返回: pattern_id
```

### 数据格式
```javascript
// 决策树节点结构
{
    id: "node_123",
    type: "symptom|condition|diagnosis|treatment|formula",
    name: "节点名称",
    description: "详细描述",
    x: 100,
    y: 200
}

// 连线结构
{
    from: "node_123",
    to: "node_456"
}
```

### 浏览器兼容性
```
✅ Chrome 90+
✅ Firefox 88+
✅ Safari 14+
✅ Edge 90+
❌ IE 11及以下（不支持）
```

## 最佳实践

### 1. 诊疗思路撰写技巧
```
建议结构：
1. 病因病机分析
2. 辨证要点
3. 治则治法
4. 方药选择
5. 加减变化

示例：
"失眠多因心火旺盛或心脾两虚所致。
心火旺盛者，证见心烦失眠，口干舌燥，舌红苔黄，
治以清心火、滋阴安神，方用黄连阿胶汤。
心脾两虚者，证见失眠多梦，心悸健忘，面色萎黄，
治以补益心脾、养血安神，方用归脾汤。"
```

### 2. 节点命名规范
```
✅ 症状节点: 简明扼要（如"失眠"、"心烦"）
✅ 条件节点: 判断标准（如"舌红苔黄？"、"面色萎黄？"）
✅ 诊断节点: 证型名称（如"心火旺盛证"）
✅ 治疗节点: 治法（如"清心火"）
✅ 处方节点: 方剂名（如"黄连阿胶汤"）
```

### 3. 决策树结构建议
```
推荐层级：
第1层: 主症状
第2层: 判断条件（舌象、脉象等）
第3层: 证型诊断
第4层: 治疗方法
第5层: 具体方药

示例流程：
失眠 → 舌红苔黄？→ 心火旺盛证 → 清心火 → 黄连阿胶汤
```

### 4. 知识管理策略
```
建议：
- 每个常见病建立1个标准决策树
- 定期更新和完善
- 记录临床反馈和疗效
- 分享给同科室医生

组织方式：
- 按疾病分类（如"失眠"、"胃痛"）
- 按证型分类（如"气虚类"、"实热类"）
- 按流派分类（如"经方"、"温病"）
```

## 更新日志

### v2.1 (2025-10-17)
- ✅ 恢复AI分析决策树功能（方剂AI分析）
- ❌ 移除成人/儿童剂量功能
- ➕ 新增历史决策树查看和管理功能

### v2.0 (2025-10-17)
- ❌ 移除智能分支生成
- ❌ 移除智能处方提取
- ❌ 移除右侧中医辨证指导面板

---

**如有问题或建议，请联系系统管理员**
