# AI中医诊断助手 - 多模态功能修复方案

## 问题诊断

根据QWEN多模态功能测试，发现以下关键问题：

### ❌ 主要问题
1. **模型版本不一致**
   - 处方分析: `qwen-vl-max` (最新高性能版本)
   - 舌象分析: `qwen-vl-plus` (较旧版本)

2. **超时配置不一致**
   - 处方分析: 80秒 (充足)
   - 舌象分析: 30秒 (可能不足)

### ✅ 正常功能
- DashScope API密钥配置正确 ✅
- DashScope库导入正常 ✅
- 两个多模态处理器都能正常初始化 ✅
- API连接正常 ✅

## 修复方案

### 1. 统一模型配置
将舌象分析的模型版本升级到 `qwen-vl-max`，与处方分析保持一致。

### 2. 统一超时配置
将舌象分析的超时时间增加到80秒，确保有足够时间处理复杂图像。

### 3. 统一配置管理
从配置文件中读取模型参数，避免硬编码。

## 实施计划

### 步骤1: 修改舌象分析函数
- 文件: `/opt/tcm-ai/api/main.py`
- 行数: ~1706行
- 修改: `model="qwen-vl-plus"` → `model="qwen-vl-max"`
- 修改: `timeout=30` → `timeout=80`

### 步骤2: 添加配置化支持
- 在 `config/settings.py` 中添加多模态模型配置
- 使两个处理器都从配置文件读取参数

### 步骤3: 测试验证
- 运行修复后的测试
- 确认两个功能使用相同配置
- 验证舌象分析功能正常

## 预期效果

修复后，舌象分析和处方分析将：
- 使用相同的高性能模型 (`qwen-vl-max`)
- 使用相同的超时配置 (80秒)
- 提供一致的用户体验
- 提高舌象分析的准确性和稳定性

## 风险评估

- **低风险**: 只是参数调整，不涉及核心逻辑
- **向后兼容**: 不影响现有功能
- **性能提升**: 使用更好的模型和更长超时时间