# 决策树与患者问诊联动功能 - 完整指南

## 📋 功能概述

当患者在 https://mxh0510.cn/smart 进行问诊时,系统会自动匹配医生保存的决策树,并使用决策树中的诊疗思路和处方来生成AI建议。

---

## 🔍 核心工作流程

```
患者问诊
  ↓
提取症状和疾病名称
  ↓
【三层匹配策略】
├─ 第1层: 查询当前医生的决策树 (例如: jin_daifu)
├─ 第2层: 查询通用决策树 (anonymous_doctor)
└─ 第3层: 查询所有医生的决策树 (不限doctor_id)
  ↓
找到最佳匹配 (基于疾病+症状+文本相似度)
  ↓
AI基于决策树生成诊疗建议
  ↓
处方使用决策树中的方剂
```

---

## 🧪 测试步骤

### 测试准备

**已有数据**:
- **决策树ID**: f20c3d0a-265d-4aba-b17e-79dc54339a1b
- **医生ID**: anonymous_doctor
- **疾病名称**: 脾胃虚寒型胃痛
- **方剂**: 理中汤合良附丸加减
- **药物**: 党参、白术、干姜、炙甘草、高良姜、香附、陈皮、半夏

---

### 第1步：数据库验证

**检查决策树数据**:
```bash
sqlite3 /opt/tcm-ai/data/user_history.sqlite "SELECT id, disease_name, doctor_id FROM doctor_clinical_patterns WHERE id = 'f20c3d0a-265d-4aba-b17e-79dc54339a1b'"
```

**预期结果**:
```
f20c3d0a-265d-4aba-b17e-79dc54339a1b|脾胃虚寒型胃痛|anonymous_doctor
```

---

### 第2步：患者问诊测试

**访问患者端**: https://mxh0510.cn/smart

**测试用例1：完全匹配**
```
患者输入: 我最近半年胃痛反复发作,喝温水会舒服一点,按压也能减轻疼痛。还经常吐清水,没什么胃口,整个人很疲劳。手脚也总是冰凉的,大便稀溏。
```

**预期匹配**:
- ✅ 疾病匹配: "胃痛" → "脾胃虚寒型胃痛" (别名匹配)
- ✅ 症状匹配: 胃痛、手足不温、大便溏薄、神疲乏力、泛吐清水
- ✅ 文本相似度: 高度相似

---

**测试用例2：部分匹配**
```
患者输入: 胃总是隐隐作痛,空腹的时候更严重,喝点热粥会好一些。
```

**预期匹配**:
- ✅ 疾病匹配: "胃痛" → "脾胃虚寒型胃痛"
- ✅ 症状匹配: 胃痛、喜温、空腹痛甚
- ⚠️ 匹配度: 中等 (50-70%)

---

### 第3步：查看服务日志

**实时监控日志**:
```bash
sudo journalctl -u tcm-ai -f
```

**关键日志标识**:
```
🔍 查询医生 jin_daifu 的决策树
📚 未找到医生 jin_daifu 的决策树,尝试查询通用决策树...
✅ 找到最佳决策树匹配: f20c3d0a-265d-4aba-b17e-79dc54339a1b, 疾病=脾胃虚寒型胃痛, 匹配分数=85%, 置信度=85%
🧠 决策树智能匹配已集成 (匹配度:85%, ID:f20c3d0a-265d-4aba-b17e-79dc54339a1b)
```

---

### 第4步：验证AI响应

**检查AI响应中的关键内容**:

1. **诊断应该提到**:
   - 脾胃虚寒证
   - 中阳不足

2. **处方应该包含**:
   - 方剂名称: 理中汤合良附丸加减 (或类似温中健脾方剂)
   - 核心药物: 党参、白术、干姜、炙甘草、高良姜、香附

3. **治疗原则**:
   - 温中散寒
   - 健脾益气

---

## 📈 统计数据查看

### 使用统计API

**获取决策树使用统计**:
```bash
curl -X GET "http://127.0.0.1:8000/api/doctor-decision-tree/usage-stats/anonymous_doctor?time_range=all"
```

---

## 📝 总结

### 核心优势

1. **智能匹配**: 三层fallback策略确保找到最佳决策树
2. **灵活性**: 支持疾病别名、症状模糊匹配
3. **可追溯**: 完整记录使用统计和匹配分数
4. **AI增强**: 决策树内容直接注入AI prompt,确保一致性

---

**创建时间**: 2025-10-19 11:45
**版本**: v1.0
**状态**: ✅ 已完成集成,等待验证
