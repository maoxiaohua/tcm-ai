# 医生数据安全删除执行计划

## 🎯 删除目标确认

**保留对象** (2个):
1. ✅ **金大夫** - 真实医生账号 (ID:1, license_no: TCM001)
2. ✅ **张仲景** - 真实医生账号 (ID:4, license_no: TCM-ZZJ-001)

**删除对象** (14个):
- 数据库doctors表中status='inactive'的14个医生记录
- 这些是**数据库记录层面的删除**，不影响AI人格系统

---

## ⚠️ 关键发现：两套系统

### 系统1: 数据库医生账户 (可删除)
**位置**: `doctors`表
**作用**: 真实医生登录账户
**保留**: 金大夫 + 张仲景
**删除**: 其他14个inactive账户

### 系统2: AI医生人格系统 (不能删除)
**位置**: `/opt/tcm-ai/core/doctor_system/tcm_doctor_personas.py`
**作用**: AI问诊时模拟不同流派医生的思维方式
**人格列表**:
- `jin_daifu` - 金大夫人格
- `zhang_zhongjing` - 张仲景风格医师
- `ye_tianshi` - 叶天士风格医师 ⚠️
- `li_dongyuan` - 李东垣风格医师 ⚠️
- `liu_duzhou` - 刘渡舟风格医师 ⚠️
- `zheng_qin_an` - 郑钦安风格医师 ⚠️
- `zhu_danxi` - 朱丹溪风格医师 ⚠️

**重要**: 这些医生人格是AI功能的核心，**删除数据库记录不影响AI人格系统**！

---

## 📋 详细删除计划

### 阶段0: 备份 (必须)

```bash
# 1. 备份数据库
sqlite3 /opt/tcm-ai/data/user_history.sqlite ".backup /opt/tcm-ai/data/backup_before_doctor_cleanup_$(date +%Y%m%d_%H%M%S).db"

# 2. 备份前端关键文件
tar -czf /opt/tcm-ai/backup_frontend_doctor_cleanup_$(date +%Y%m%d_%H%M%S).tar.gz \
  /opt/tcm-ai/static/index_smart_workflow.html \
  /opt/tcm-ai/static/js/prescription_renderer.js

# 3. Git提交当前状态
cd /opt/tcm-ai
git add -A
git commit -m "🔄 修改前备份: 准备删除inactive医生数据"
```

---

### 阶段1: 数据库删除 (安全，无关联)

#### 删除SQL
```sql
-- ⚠️ 仅删除数据库中的inactive医生记录
-- 不影响AI人格系统功能
DELETE FROM doctors
WHERE name NOT IN ('金大夫', '张仲景')
AND status = 'inactive';

-- 验证删除结果
SELECT COUNT(*) as total_doctors,
       SUM(CASE WHEN status='active' THEN 1 ELSE 0 END) as active_doctors
FROM doctors;

-- 应该返回: total_doctors=2, active_doctors=2
```

#### 风险评估
- **数据库关联**: ✅ 无风险 (已验证无关联数据)
- **外键约束**: ✅ 无风险 (所有表检查通过)
- **AI功能**: ✅ 无影响 (AI人格系统独立于数据库)

---

### 阶段2: 前端代码清理 (必须)

#### 2.1 修复 `index_smart_workflow.html`

**文件**: `/opt/tcm-ai/static/index_smart_workflow.html`

**位置1**: Line 3721-3726
```javascript
// 修改前
const doctorIcons = {
    '张仲景': '⚕️',
    '叶天士': '🌡️',    // ❌ 删除
    '李东垣': '🌱',    // ❌ 删除
    '郑钦安': '🔥',    // ❌ 删除
    '刘渡舟': '⚖️'     // ❌ 删除
};

// 修改后
const doctorIcons = {
    '张仲景': '⚕️',
    '金大夫': '💊'      // ✅ 添加金大夫
};
```

**位置2**: Line 4790附近
```javascript
// 修改前
const doctorMapping = {
    'zhang_zhongjing': '张仲景',
    'ye_tianshi': '叶天士',    // ❌ 删除
    'li_dongyuan': '李东垣',   // ❌ 删除
    // ...
};

// 修改后
const doctorMapping = {
    'zhang_zhongjing': '张仲景',
    'jin_daifu': '金大夫'       // ✅ 添加金大夫
};
```

---

#### 2.2 修复 `prescription_renderer.js`

**文件**: `/opt/tcm-ai/static/js/prescription_renderer.js`

**位置**: Line 646-651
```javascript
// 修改前
const DOCTOR_NAME_MAP = {
    'zhang_zhongjing': '张仲景',
    'ye_tianshi': '叶天士',      // ❌ 删除
    'li_dongyuan': '李东垣',     // ❌ 删除
    'zheng_qinan': '郑钦安',     // ❌ 删除
    'liu_duzhou': '刘渡舟'       // ❌ 删除
};

// 修改后
const DOCTOR_NAME_MAP = {
    'zhang_zhongjing': '张仲景',
    'jin_daifu': '金大夫'        // ✅ 添加金大夫
};
```

---

### 阶段3: Python代码清理 (可选，不影响功能)

#### 重要说明
Python代码中的医生人格是**AI功能的一部分**，建议保留：

**理由**:
1. **用户可能选择这些风格**: 虽然数据库只有金大夫和张仲景账号，但问诊时用户可以选择模拟其他名医风格
2. **功能完整性**: 保留完整的五大名医人格系统，体现中医学术多样性
3. **无副作用**: Python代码中的人格定义不占用资源，不影响性能

**如果你仍然希望删除**，可以修改以下文件：
- `/opt/tcm-ai/core/doctor_system/tcm_doctor_personas.py` - 删除对应人格
- `/opt/tcm-ai/core/consultation/unified_consultation_service.py` - 删除人格映射
- `/opt/tcm-ai/core/ai_response/template_engine.py` - 删除模板引用

**推荐做法**: **保留Python代码，仅删除数据库记录和前端硬编码**

---

## 🔍 逐步执行清单

### ✅ 准备阶段
- [ ] 阅读完整的影响分析报告
- [ ] 阅读本执行计划
- [ ] 确认删除范围和保留对象

### ✅ 备份阶段
- [ ] 备份数据库 (必须)
- [ ] 备份前端文件 (必须)
- [ ] Git提交当前状态 (必须)

### ✅ 执行阶段1: 数据库
- [ ] 执行DELETE SQL
- [ ] 验证删除结果 (应剩余2个active医生)
- [ ] 测试系统登录功能

### ✅ 执行阶段2: 前端清理
- [ ] 修复 `index_smart_workflow.html` (2处)
- [ ] 修复 `prescription_renderer.js` (1处)
- [ ] 检查其他19个文件是否动态加载
- [ ] 重启服务测试

### ✅ 测试验证
- [ ] 金大夫登录测试
- [ ] 张仲景登录测试
- [ ] 患者问诊功能测试
- [ ] 医生选择列表检查
- [ ] 处方显示功能测试
- [ ] 决策树功能测试

### ✅ 清理和提交
- [ ] 清除浏览器缓存
- [ ] 完整测试所有功能
- [ ] Git提交最终修改
- [ ] 更新系统文档

---

## 🚨 回滚方案

如果出现问题，立即执行回滚：

### 数据库回滚
```bash
# 恢复数据库备份
cp /opt/tcm-ai/data/backup_before_doctor_cleanup_YYYYMMDD_HHMMSS.db \
   /opt/tcm-ai/data/user_history.sqlite

# 重启服务
sudo service tcm-ai restart
```

### 代码回滚
```bash
# Git回滚
cd /opt/tcm-ai
git reset --hard HEAD~1

# 或恢复备份文件
tar -xzf backup_frontend_doctor_cleanup_YYYYMMDD_HHMMSS.tar.gz -C /
```

---

## 📊 预期结果

### 数据库状态
```sql
-- 应该只有2条记录
SELECT id, name, license_no, status FROM doctors;
-- 结果:
-- 1  | 金大夫  | TCM001      | active
-- 4  | 张仲景  | TCM-ZZJ-001 | active
```

### 前端状态
- 医生选择列表只显示: 金大夫、张仲景
- 处方渲染正常显示两位医生的处方
- 医生图标正确映射

### AI功能状态
- AI问诊仍然可以模拟五大名医风格 (如果保留Python人格代码)
- 或只能选择金大夫、张仲景风格 (如果删除了Python代码)

---

## 💡 建议和最佳实践

### 建议1: 保留AI人格系统
**理由**: AI人格系统独立于数据库账户，保留完整功能更好

**实施**:
- ✅ 删除数据库中的14个inactive医生记录
- ✅ 清理前端硬编码的医生映射
- ✅ 保留Python中的完整AI人格系统

### 建议2: 分步验证
**重要**: 不要一次性执行所有修改

**流程**:
1. 先备份
2. 先改前端，测试无问题
3. 再删数据库，逐步验证
4. 最后提交

### 建议3: 保留观察期
**时间**: 3-7天
**目的**: 确保无遗漏问题
**行动**: 监控日志，收集用户反馈

---

## ⏱️ 时间估算

| 阶段 | 预计时间 | 关键步骤 |
|------|---------|---------|
| 准备和备份 | 15分钟 | 备份数据库、代码、Git提交 |
| 前端修复 | 30分钟 | 修改2个文件，检查19个文件 |
| 数据库删除 | 5分钟 | 执行SQL，验证结果 |
| 测试验证 | 30分钟 | 完整功能测试 |
| 清理提交 | 10分钟 | Git提交，文档更新 |
| **总计** | **90分钟** | - |

---

## 📝 执行SQL脚本

### 完整的删除脚本 (谨慎执行)

```sql
-- ================================================
-- 医生数据安全删除脚本
-- 执行前确保已备份！
-- ================================================

-- 1. 删除前检查
SELECT '=== 删除前状态 ===' as section;
SELECT
    COUNT(*) as total_doctors,
    SUM(CASE WHEN status='active' THEN 1 ELSE 0 END) as active_doctors,
    SUM(CASE WHEN status='inactive' THEN 1 ELSE 0 END) as inactive_doctors
FROM doctors;

-- 2. 查看即将删除的医生
SELECT '=== 即将删除的医生 ===' as section;
SELECT id, name, license_no, status
FROM doctors
WHERE name NOT IN ('金大夫', '张仲景')
AND status = 'inactive';

-- 3. 确认无关联数据(最后检查)
SELECT '=== 关联数据检查 ===' as section;
SELECT 'consultations' as table_name, COUNT(*) as count
FROM consultations
WHERE selected_doctor_id IN (
    SELECT license_no FROM doctors WHERE status='inactive'
)
UNION ALL
SELECT 'prescriptions', COUNT(*)
FROM prescriptions
WHERE doctor_id IN (
    SELECT CAST(id AS TEXT) FROM doctors WHERE status='inactive'
);

-- 4. 执行删除 (⚠️ 谨慎！)
DELETE FROM doctors
WHERE name NOT IN ('金大夫', '张仲景')
AND status = 'inactive';

-- 5. 验证删除结果
SELECT '=== 删除后状态 ===' as section;
SELECT
    COUNT(*) as total_doctors,
    SUM(CASE WHEN status='active' THEN 1 ELSE 0 END) as active_doctors
FROM doctors;

-- 6. 查看剩余医生
SELECT '=== 剩余医生列表 ===' as section;
SELECT id, name, license_no, user_id, status
FROM doctors
ORDER BY id;

-- 预期结果:
-- total_doctors = 2
-- active_doctors = 2
-- 列表显示: 金大夫(1), 张仲景(4)
```

---

## ✅ 最终确认问题

**在执行前，请回答以下问题**:

1. ❓ 是否已经阅读完整的影响分析报告？
2. ❓ 是否理解AI人格系统与数据库账户的区别？
3. ❓ 是否确认只需要保留金大夫和张仲景两个数据库账户？
4. ❓ AI功能是否仍需要其他名医风格（如叶天士、李东垣等）？
5. ❓ 是否已经做好完整备份？
6. ❓ 是否准备好回滚方案？

**如果所有问题都确认，可以开始执行删除计划！**

---

**文档创建时间**: 2025-10-21 21:30
**风险评级**: 低 (数据库无关联) → 中 (前端硬编码需修复)
**推荐方案**: 删除数据库记录 + 清理前端硬编码 + 保留AI人格系统
