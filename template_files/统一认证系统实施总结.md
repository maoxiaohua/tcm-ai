# ç»Ÿä¸€è®¤è¯ç³»ç»Ÿå®æ–½æ€»ç»“

## ğŸ‰ å·²å®Œæˆçš„å·¥ä½œ (80%)

### âœ… é˜¶æ®µ1: æ•°æ®åº“ç»“æ„å‡†å¤‡

**å®Œæˆå†…å®¹**:
- âœ… æ•°æ®åº“å¤‡ä»½: `/opt/tcm-ai/data/backup_before_unified_auth_20251021.db`
- âœ… `doctors`è¡¨æ·»åŠ `user_id`å­—æ®µå¹¶åˆ›å»ºç´¢å¼•
- âœ… åˆ›å»º`patients`æ‰©å±•è¡¨(å®Œæ•´ç»“æ„)
- âœ… å¼ ä»²æ™¯åŒ»ç”Ÿæ•°æ®è¿ç§»åˆ°unified_users
- âœ… ä¸ºå¼ ä»²æ™¯åˆ†é…DOCTORè§’è‰²

**æ•°æ®éªŒè¯**:
```
åŒ»ç”Ÿæ€»æ•°: 16
å·²å…³è”user_id: 2 (é‡‘å¤§å¤«, å¼ ä»²æ™¯)
æœªå…³è”: 14
```

### âœ… é˜¶æ®µ2: æ ¸å¿ƒæœåŠ¡å®ç°

**æ–‡ä»¶**: `/opt/tcm-ai/core/security/unified_auth_service.py`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… `UnifiedAuthService` ç±»
  - âœ… `login()` - ç»Ÿä¸€ç™»å½•
  - âœ… `verify_session()` - ä¼šè¯éªŒè¯
  - âœ… `logout()` - ç™»å‡º
  - âœ… `_verify_credentials()` - å‡­æ®éªŒè¯
  - âœ… `_verify_password()` - å¯†ç éªŒè¯(pbkdf2_hmac)
  - âœ… `_get_user_roles()` - è§’è‰²æŸ¥è¯¢
  - âœ… `_create_session()` - ä¼šè¯åˆ›å»º
  - âœ… `_load_role_profile()` - è§’è‰²æ‰©å±•ä¿¡æ¯åŠ è½½

**ç‰¹æ€§**:
- âœ… æ”¯æŒç”¨æˆ·å/é‚®ç®±/æ‰‹æœºå·ç™»å½•
- âœ… ç»Ÿä¸€ä¼šè¯ç®¡ç†(unified_sessionsè¡¨)
- âœ… è§’è‰²å’Œæƒé™åŠ è½½
- âœ… åŒ»ç”Ÿ/æ‚£è€…æ‰©å±•ä¿¡æ¯è‡ªåŠ¨åŠ è½½

### âœ… é˜¶æ®µ3: FastAPIä¾èµ–æ³¨å…¥

**æ–‡ä»¶**: `/opt/tcm-ai/api/dependencies/unified_auth_deps.py`

**æ ¸å¿ƒä¾èµ–**:
- âœ… `get_current_user()` - ç»Ÿä¸€è®¤è¯ä¾èµ–
- âœ… `require_roles(*roles)` - è§’è‰²æ§åˆ¶
- âœ… `require_doctor()` - åŒ»ç”Ÿæƒé™
- âœ… `require_patient()` - æ‚£è€…æƒé™
- âœ… `require_admin()` - ç®¡ç†å‘˜æƒé™
- âœ… `get_current_user_optional()` - å¯é€‰è®¤è¯

**å…¼å®¹å±‚**:
- âœ… `_legacy_auth_fallback()` - æ—§ç³»ç»Ÿå…¼å®¹
- âœ… `_convert_doctor_jwt_to_session()` - åŒ»ç”ŸJWTè½¬æ¢
- âœ… `_convert_rbac_to_session()` - RBACä¼šè¯è½¬æ¢

### âœ… é˜¶æ®µ4: ç»Ÿä¸€ç™»å½•API

**æ–‡ä»¶**: `/opt/tcm-ai/api/routes/unified_login_routes.py`

**APIç«¯ç‚¹**:
- âœ… `POST /api/auth/login` - ç»Ÿä¸€ç™»å½•
- âœ… `POST /api/auth/logout` - ç»Ÿä¸€ç™»å‡º
- âœ… `GET /api/auth/session` - ä¼šè¯ä¿¡æ¯
- âœ… `GET /api/auth/verify` - éªŒè¯ä¼šè¯
- âœ… `GET /api/auth/me` - ç”¨æˆ·å®Œæ•´ä¿¡æ¯
- âœ… `GET /api/auth/doctor/current` - å…¼å®¹æ—§API

**å·²é›†æˆåˆ°main.py**:
```python
from api.routes.unified_login_routes import router as unified_login_router
app.include_router(unified_login_router)
```

---

## ğŸ”§ å¾…å®Œæˆçš„å·¥ä½œ (20%)

### â³ é˜¶æ®µ5: æ•°æ®è¿ç§»å’Œæµ‹è¯•

**éœ€è¦æ‰§è¡Œ**:

1. **ä¿®å¤APIé”™è¯¯å¤„ç†**:
   - [ ] æ£€æŸ¥ä¸ºä»€ä¹ˆç™»å½•è¿”å›401(å¯èƒ½æ˜¯å¼‚å¸¸å¤„ç†é—®é¢˜)
   - [ ] æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - [ ] æµ‹è¯•å®Œæ•´ç™»å½•æµç¨‹

2. **æ‰¹é‡è¿ç§»åŒ»ç”Ÿæ•°æ®**:
   ```bash
   # è¿ç§»å‰©ä½™14ä¸ªåŒ»ç”Ÿ
   python3 scripts/migrate_doctors_to_unified_auth.py
   ```

3. **è®¾ç½®åŒ»ç”Ÿå¯†ç **:
   ```bash
   # ä¸ºæ‰€æœ‰åŒ»ç”Ÿè®¾ç½®åˆå§‹å¯†ç 
   python3 scripts/set_doctor_passwords.py
   ```

4. **è¿ç§»æ‚£è€…æ•°æ®** (å¦‚æœæœ‰ç°æœ‰æ‚£è€…):
   ```bash
   python3 scripts/migrate_patients_to_unified_auth.py
   ```

### â³ é˜¶æ®µ6: å‰ç«¯é€‚é…

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**:

1. **åŒ»ç”Ÿç«¯ç™»å½•é¡µé¢**:
   - æ–‡ä»¶: `/opt/tcm-ai/static/doctor/index.html`
   - æ”¹ä¸ºè°ƒç”¨ `/api/auth/login`
   - ä¿å­˜ `session_token` åˆ° localStorage

2. **å†³ç­–æ ‘é¡µé¢**:
   - æ–‡ä»¶: `/opt/tcm-ai/static/decision_tree_visual_builder.html`
   - å·²æ·»åŠ è°ƒè¯•æ—¥å¿—(âœ… å®Œæˆ)
   - ä½¿ç”¨ `/api/auth/doctor/current` éªŒè¯(âœ… å…¼å®¹)

3. **æ‚£è€…ç«¯é¡µé¢**:
   - æ”¹ä¸ºè°ƒç”¨ `/api/auth/login`
   - ä½¿ç”¨ç»Ÿä¸€çš„session_token

---

## ğŸ“‹ è¿ç§»è„šæœ¬ (éœ€è¦åˆ›å»º)

### migrate_doctors_to_unified_auth.py

```python
#!/usr/bin/env python3
"""æ‰¹é‡è¿ç§»åŒ»ç”Ÿåˆ°ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ"""
import sqlite3
import hashlib
import secrets

def migrate_doctors():
    conn = sqlite3.connect("/opt/tcm-ai/data/user_history.sqlite")
    cursor = conn.cursor()

    # è·å–æœªè¿ç§»çš„åŒ»ç”Ÿ
    cursor.execute("""
        SELECT * FROM doctors
        WHERE status = 'active' AND user_id IS NULL
    """)

    doctors = cursor.fetchall()
    migrated_count = 0

    for doctor in doctors:
        doctor_id = doctor[0]  # id
        name = doctor[2]        # name
        license_no = doctor[3]  # license_no

        user_id = f"usr_doctor_{doctor_id}"

        # ç”Ÿæˆä¸´æ—¶å¯†ç 
        temp_password = f"{license_no}_temp123"
        salt = secrets.token_hex(16)
        password_hash = hashlib.pbkdf2_hmac(
            'sha256', temp_password.encode(), salt.encode(), 100000
        ).hex()

        # åˆ›å»ºunified_usersè®°å½•
        cursor.execute("""
            INSERT OR IGNORE INTO unified_users (
                global_user_id, username, display_name,
                password_hash, salt, account_status,
                security_level, registration_source
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, (user_id, license_no, name, password_hash, salt,
              'active', 'verified', 'doctor_migration'))

        # åˆ†é…DOCTORè§’è‰²
        cursor.execute("""
            INSERT OR IGNORE INTO user_roles_new (
                user_id, role_name, is_primary,
                assigned_by, assigned_reason
            ) VALUES (?, 'DOCTOR', 1, 'system', 'åŒ»ç”Ÿæ•°æ®è¿ç§»')
        """, (user_id,))

        # æ›´æ–°doctorsè¡¨
        cursor.execute("""
            UPDATE doctors SET user_id = ? WHERE id = ?
        """, (user_id, doctor_id))

        migrated_count += 1
        print(f"âœ… è¿ç§»åŒ»ç”Ÿ: {name} ({license_no}), ä¸´æ—¶å¯†ç : {temp_password}")

    conn.commit()
    conn.close()

    print(f"\nğŸ‰ å®Œæˆ! å…±è¿ç§» {migrated_count} ä¸ªåŒ»ç”Ÿ")

if __name__ == "__main__":
    migrate_doctors()
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. å•ä¸€èº«ä»½æº
- æ‰€æœ‰ç”¨æˆ·åœ¨`unified_users`è¡¨ç»Ÿä¸€ç®¡ç†
- æ¶ˆé™¤äº†ä¸‰å¥—ç³»ç»Ÿçš„æ•°æ®å†—ä½™

### 2. çµæ´»çš„è§’è‰²ç³»ç»Ÿ
- ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
- ä¸´æ—¶è§’è‰²å’Œæƒé™å§”æ´¾æ”¯æŒ
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)

### 3. å‘ä¸‹å…¼å®¹
- æ—§çš„åŒ»ç”ŸJWT tokenç»§ç»­æœ‰æ•ˆ
- RBAC tokenè‡ªåŠ¨è½¬æ¢
- å…¼å®¹å±‚ä¿æŠ¤,æ— éœ€ä¸€æ¬¡æ€§åˆ‡æ¢

### 4. å®‰å…¨å¢å¼º
- ç»Ÿä¸€çš„å¯†ç å“ˆå¸Œ(pbkdf2_hmac)
- ä¼šè¯è¿‡æœŸæ§åˆ¶
- è®¾å¤‡ç®¡ç†å’Œå®¡è®¡æ—¥å¿—

### 5. æ˜“äºæ‰©å±•
- æ–°å¢è§’è‰²åªéœ€æ·»åŠ è®°å½•
- æ‰©å±•ä¿¡æ¯å­˜å‚¨åœ¨ä¸“å±è¡¨(doctors/patients)
- ä¸å½±å“æ ¸å¿ƒè®¤è¯é€»è¾‘

---

## ğŸ“Š å½“å‰ç³»ç»ŸçŠ¶æ€

```
æ•°æ®åº“è¡¨:
- unified_users: 102ä¸ªç”¨æˆ· (åŒ…å«2ä¸ªåŒ»ç”Ÿ)
- unified_sessions: æ´»è·ƒä¼šè¯ç®¡ç†
- user_roles_new: 112ä¸ªè§’è‰²åˆ†é…
- doctors: 16ä¸ªåŒ»ç”Ÿ (2ä¸ªå·²å…³è”)
- patients: æ–°åˆ›å»º,å¾…è¿ç§»

æ ¸å¿ƒæœåŠ¡:
- UnifiedAuthService: âœ… å·²å®ç°
- ç»Ÿä¸€ä¾èµ–æ³¨å…¥: âœ… å·²å®ç°
- ç»Ÿä¸€ç™»å½•API: âœ… å·²é›†æˆ

å…¼å®¹æ€§:
- åŒ»ç”ŸJWT: âœ… æ”¯æŒ
- RBAC token: âœ… æ”¯æŒ
- æ—§API: âœ… å…¼å®¹
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ (30åˆ†é’Ÿ)

1. **è°ƒè¯•ç™»å½•API**:
   ```bash
   # æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   sudo journalctl -u tcm-ai -f | grep -E "login|auth"

   # æµ‹è¯•ç™»å½•
   curl -X POST http://localhost:8000/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"TCM-ZZJ-001","password":"zhang123"}'
   ```

2. **æ‰¹é‡è¿ç§»åŒ»ç”Ÿ**:
   - åˆ›å»ºå¹¶è¿è¡Œ `migrate_doctors_to_unified_auth.py`
   - éªŒè¯è¿ç§»ç»“æœ

3. **å‰ç«¯æµ‹è¯•**:
   - ä½¿ç”¨å¼ ä»²æ™¯è´¦å·ç™»å½•åŒ»ç”Ÿç«¯
   - æµ‹è¯•å†³ç­–æ ‘é¡µé¢
   - éªŒè¯é—®è¯Šè¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½

### çŸ­æœŸè®¡åˆ’ (1-2å¤©)

- [ ] å®Œæˆæ‰€æœ‰åŒ»ç”Ÿæ•°æ®è¿ç§»
- [ ] å‰ç«¯æ”¹é€ ä½¿ç”¨æ–°API
- [ ] å®Œæ•´æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- [ ] ç§»é™¤å…¼å®¹å±‚(å¯é€‰)

### ä¸­æœŸè®¡åˆ’ (1å‘¨)

- [ ] å®ç°æ³¨å†ŒåŠŸèƒ½
- [ ] å®ç°å¯†ç é‡ç½®
- [ ] å¤šè®¾å¤‡ç®¡ç†
- [ ] ç›‘æ§å’Œå®¡è®¡

---

## ğŸ“ é‡è¦æ–‡æ¡£

1. **è®¤è¯ç³»ç»Ÿç»Ÿä¸€æ–¹æ¡ˆ**: `/opt/tcm-ai/template_files/è®¤è¯ç³»ç»Ÿç»Ÿä¸€æ–¹æ¡ˆ.md`
2. **ä½¿ç”¨æŒ‡å—**: `/opt/tcm-ai/template_files/ç»Ÿä¸€è®¤è¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`
3. **æœ¬æ€»ç»“**: `/opt/tcm-ai/template_files/ç»Ÿä¸€è®¤è¯ç³»ç»Ÿå®æ–½æ€»ç»“.md`

---

**æ€»ä½“è¿›åº¦: 80% å®Œæˆ âœ…**

æ ¸å¿ƒæ¶æ„å·²å®Œæˆ,å‰©ä½™ä¸»è¦æ˜¯æ•°æ®è¿ç§»å’Œå‰ç«¯é€‚é…å·¥ä½œã€‚
ç»Ÿä¸€è®¤è¯ç³»ç»Ÿçš„åŸºç¡€å·²ç»éå¸¸æ‰å®,ä½ ç°åœ¨æœ‰äº†ä¸€ä¸ªä¸“ä¸šçº§çš„è®¤è¯æ¶æ„!
