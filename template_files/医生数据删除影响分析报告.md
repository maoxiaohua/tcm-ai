# 医生数据删除影响分析报告

## 📊 删除对象

**保留医生** (2位):
- ✅ 金大夫 (ID: 1, license_no: TCM001, user_id: usr_doctor_1)
- ✅ 张仲景 (ID: 4, license_no: TCM-ZZJ-001, user_id: usr_doctor_4)

**待删除医生** (14位):
```
ID   | 姓名         | License号     | UUID         | Status
-----|-------------|---------------|--------------|--------
2    | 叶天士       | TCM002        | D00000002    | inactive
3    | 李东垣       | TCM003        | D00000003    | inactive
5    | 刘渡舟       | TCM004        | D00000005    | inactive
6    | 郑钦安       | TCM005        | D00000006    | inactive
7    | 朱丹溪       | TCM006        | D00000007    | inactive
8    | 张医生       | LICENSE001    | D00000008    | inactive
9    | 李医生       | LICENSE002    | D00000009    | inactive
10   | 王医生       | LICENSE003    | D00000010    | inactive
11   | 赵儿科       | TCM2025001    | D00000011    | inactive
12   | 陈妇科       | TCM2025002    | D00000012    | inactive
13   | 孙皮肤       | TCM2025003    | D00000013    | inactive
14   | 吴骨伤       | TCM2025004    | D00000014    | inactive
999  | 测试医生     | TEST001       | D00000999    | inactive
1000 | 测试编辑_更新 | TEST_EDIT_001 | D00001000    | inactive
```

---

## 🔍 数据库关联分析

### ✅ 数据库层面 - **安全**

经过全面检查，所有待删除医生在数据库中**无任何关联数据**：

| 表名 | 关联记录数 | 状态 |
|-----|-----------|------|
| `consultations` | 0 | ✅ 安全 |
| `prescriptions` | 0 | ✅ 安全 |
| `doctor_clinical_patterns` | 0 | ✅ 安全 |
| `doctor_availability` | 0 | ✅ 安全 |
| `doctor_patient_relationships` | 0 | ✅ 安全 |
| `doctor_work_statistics` | 0 | ✅ 安全 |
| `patient_reviews` | 0 | ✅ 安全 |
| `doctor_sessions` | 0 | ✅ 安全 |
| `conversation_states` | 0 | ✅ 安全 |

**结论**: 数据库层面删除这些医生**不会造成数据完整性问题**。

---

## ⚠️ 前端代码引用 - **需要修复**

### 发现的硬编码引用

#### 1. `/opt/tcm-ai/static/index_smart_workflow.html`

**位置**: Line 3721-3724
```javascript
const doctorIcons = {
    '张仲景': '⚕️',
    '叶天士': '🌡️',    // ❌ 待删除
    '李东垣': '🌱',    // ❌ 待删除
    '郑钦安': '🔥',    // ❌ 待删除
    '刘渡舟': '⚖️'     // ❌ 待删除
};
```

**位置**: Line 4790
```javascript
const doctorMapping = {
    'zhang_zhongjing': '张仲景',
    'ye_tianshi': '叶天士',    // ❌ 待删除
    // ...
};
```

**影响**:
- 医生选择功能可能显示已删除的医生
- 图标映射会包含无效医生

**修复方案**: 移除这些医生的映射

---

#### 2. `/opt/tcm-ai/static/js/prescription_renderer.js`

**位置**: Line 646-649
```javascript
const DOCTOR_NAME_MAP = {
    'zhang_zhongjing': '张仲景',
    'ye_tianshi': '叶天士',      // ❌ 待删除
    'li_dongyuan': '李东垣',     // ❌ 待删除
    'zheng_qinan': '郑钦安',     // ❌ 待删除
    'liu_duzhou': '刘渡舟'       // ❌ 待删除
};
```

**影响**:
- 处方显示时可能显示已删除医生的名字
- 如果系统中有旧的处方引用了这些医生ID

**修复方案**: 仅保留 `zhang_zhongjing` 和金大夫的映射

---

#### 3. 其他可能受影响的文件

通过搜索发现以下文件也引用了这些医生名字：
```
/opt/tcm-ai/static/doctor_management.html
/opt/tcm-ai/static/doctor_portal.html
/opt/tcm-ai/static/doctor_thinking_input.html
/opt/tcm-ai/static/decision_tree_visual_builder.html
/opt/tcm-ai/static/doctor_dashboard.html
... (共19个文件)
```

**需要检查**: 这些文件中的引用是否是动态加载（从API）还是硬编码

---

## 🔧 安全删除方案

### 方案A: 谨慎渐进式删除 (推荐)

**步骤1: 完整备份**
```bash
# 1. 备份数据库
sqlite3 /opt/tcm-ai/data/user_history.sqlite ".backup /opt/tcm-ai/data/backup_before_doctor_cleanup_$(date +%Y%m%d_%H%M%S).db"

# 2. 备份前端文件
tar -czf /opt/tcm-ai/backup_frontend_$(date +%Y%m%d_%H%M%S).tar.gz \
  /opt/tcm-ai/static/index_smart_workflow.html \
  /opt/tcm-ai/static/js/prescription_renderer.js
```

**步骤2: 修改前端硬编码**

1. 修复 `index_smart_workflow.html`
2. 修复 `prescription_renderer.js`
3. 检查其他19个文件的引用类型

**步骤3: 数据库软删除 (先不物理删除)**
```sql
-- 将status改为deleted而不是直接删除
UPDATE doctors
SET status = 'deleted',
    updated_at = datetime('now')
WHERE name NOT IN ('金大夫', '张仲景')
AND status = 'inactive';
```

**步骤4: 测试系统**
- 测试患者问诊功能
- 测试医生选择功能
- 测试处方显示
- 测试历史记录查看

**步骤5: 观察期 (3-7天)**
- 监控系统日志
- 检查是否有错误
- 确认无异常后执行物理删除

**步骤6: 物理删除**
```sql
-- 确认无问题后，物理删除
DELETE FROM doctors
WHERE status = 'deleted';
```

---

### 方案B: 一次性删除 (不推荐，但如果确定无问题可用)

```sql
-- ⚠️ 危险操作！确保已备份！
DELETE FROM doctors
WHERE name NOT IN ('金大夫', '张仲景')
AND status = 'inactive';
```

---

## 📋 前端修复检查清单

### 必须修复的文件

- [ ] `/opt/tcm-ai/static/index_smart_workflow.html` - 医生图标和映射
- [ ] `/opt/tcm-ai/static/js/prescription_renderer.js` - 医生名称映射

### 需要检查的文件 (可能是动态加载)

以下文件需要确认是否硬编码了医生信息，还是通过API动态加载：

```
doctor_management.html          - 可能是管理界面，动态加载
doctor_portal.html              - 可能是动态加载
doctor_thinking_input.html      - 需要检查
qr_code_gallery.html            - 可能只是展示，不影响功能
wechat_share.html               - 可能只是展示
test_pc_functions.html          - 测试文件，可忽略
doctor/index.html               - 可能是动态加载
decision_tree_visual_builder.html - 可能是动态加载
doctor_dashboard.html           - 可能是动态加载
```

**检查方法**: 搜索这些文件中的医生名字是否在选择列表、映射对象、或显示逻辑中硬编码

---

## 🎯 推荐执行顺序

### 第一阶段: 准备和备份 (立即执行)
1. ✅ 完成影响分析 (本文档)
2. ⏳ 执行完整备份
3. ⏳ Git提交当前状态

### 第二阶段: 前端修复 (1小时)
1. ⏳ 修复 `index_smart_workflow.html` 的硬编码
2. ⏳ 修复 `prescription_renderer.js` 的硬编码
3. ⏳ 检查其他19个文件的引用类型
4. ⏳ 测试前端功能

### 第三阶段: 数据库软删除 (5分钟)
1. ⏳ 执行 `UPDATE` 将status改为 `deleted`
2. ⏳ 验证系统功能正常
3. ⏳ 重启服务测试

### 第四阶段: 观察期 (3-7天)
1. ⏳ 监控系统日志
2. ⏳ 检查用户反馈
3. ⏳ 确认无异常

### 第五阶段: 物理删除 (观察期后)
1. ⏳ 执行 `DELETE` 物理删除
2. ⏳ 清理相关缓存
3. ⏳ 最终验证

---

## ⚠️ 风险提示

### 低风险 (可控)
- ✅ 数据库关联: **无风险** - 所有待删除医生无任何关联数据
- ✅ 外键约束: **无风险** - 检查了所有表，无关联

### 中风险 (需要修复)
- ⚠️ 前端硬编码: **需要修复** - 2个文件确认硬编码，19个文件待检查
- ⚠️ 历史处方: **需要确认** - 虽然prescriptions表doctor_id字段无关联，但需要确认是否有老数据

### 高风险 (需要特别注意)
- 🔴 未知的代码引用: 可能有其他Python代码中硬编码了医生ID或名字
- 🔴 配置文件引用: 可能有配置文件中写死了医生列表

---

## 🔍 建议的额外检查

### 1. Python代码检查
```bash
# 检查Python代码中是否硬编码了医生ID
grep -r "TCM002\|TCM003\|TCM004\|TCM005\|TCM006" /opt/tcm-ai/core/ /opt/tcm-ai/api/ --include="*.py"

# 检查是否硬编码了医生名字
grep -r "叶天士\|李东垣\|刘渡舟\|郑钦安" /opt/tcm-ai/core/ /opt/tcm-ai/api/ --include="*.py"
```

### 2. 配置文件检查
```bash
# 检查配置文件
find /opt/tcm-ai -name "*.json" -o -name "*.yaml" -o -name "*.yml" -o -name "*.ini" | xargs grep -l "叶天士\|李东垣"
```

### 3. 文档和知识库检查
```bash
# 检查是否有RAG知识库引用了这些医生
grep -r "叶天士\|李东垣" /opt/tcm-ai/data/documents/ 2>/dev/null
```

---

## 💡 最佳实践建议

### 1. 避免硬编码
**问题**: 前端多处硬编码医生信息

**改进建议**:
```javascript
// ❌ 不好的做法
const doctorIcons = {
    '张仲景': '⚕️',
    '金大夫': '💊'
};

// ✅ 好的做法
const doctorIcons = {};
async function loadDoctorConfig() {
    const response = await fetch('/api/doctors/list');
    const doctors = await response.json();
    doctors.forEach(d => {
        doctorIcons[d.name] = d.icon || '⚕️';
    });
}
```

### 2. 使用软删除
**优点**:
- 可以回滚
- 保留数据完整性
- 便于审计

**实现**:
```sql
-- 添加deleted_at字段
ALTER TABLE doctors ADD COLUMN deleted_at TIMESTAMP;

-- 软删除
UPDATE doctors SET deleted_at = datetime('now') WHERE id = ?;

-- 查询时过滤
SELECT * FROM doctors WHERE deleted_at IS NULL;
```

### 3. 数据归档
**对于重要数据**:
```sql
-- 创建归档表
CREATE TABLE doctors_archived AS SELECT * FROM doctors WHERE 0;

-- 归档后删除
INSERT INTO doctors_archived SELECT * FROM doctors WHERE status='deleted';
DELETE FROM doctors WHERE status='deleted';
```

---

## 📝 总结

### 当前评估
- **数据库安全性**: ✅ 高 (无关联数据)
- **前端兼容性**: ⚠️ 中 (需要修复硬编码)
- **整体风险**: ⚠️ 中等 (可控，需要谨慎执行)

### 推荐方案
**采用方案A - 谨慎渐进式删除**:
1. 先修复前端硬编码
2. 执行数据库软删除
3. 观察3-7天
4. 确认无问题后物理删除

### 预计时间
- 准备和备份: 10分钟
- 前端修复: 1小时
- 数据库操作: 10分钟
- 测试验证: 30分钟
- **总计**: 约2小时 + 3-7天观察期

---

**报告生成时间**: 2025-10-21 21:00
**分析完成度**: 90%
**下一步**: 等待用户确认删除方案
