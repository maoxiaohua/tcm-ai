<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¿®å¤éªŒè¯ - é‡‘å¤§å¤«è®°å½•æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        pre { background: #f5f5f5; padding: 15px; overflow-x: auto; border-radius: 4px; }
        h2 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #5a67d8; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>ğŸ” é‡‘å¤§å¤«è®°å½•æ˜¾ç¤ºä¿®å¤éªŒè¯å·¥å…·</h1>

    <div class="test-section">
        <h2>æ­¥éª¤1: éªŒè¯APIè¿”å›æ•°æ®</h2>
        <button onclick="testAPIResponse()">ğŸ”„ æµ‹è¯•APIå“åº”</button>
        <div id="apiResult"></div>
    </div>

    <div class="test-section">
        <h2>æ­¥éª¤2: æ¨¡æ‹Ÿä¿®å¤åçš„é€»è¾‘</h2>
        <button onclick="testFixedLogic()">ğŸ”„ æµ‹è¯•ä¿®å¤åçš„é€»è¾‘</button>
        <div id="logicResult"></div>
    </div>

    <div class="test-section">
        <h2>æ­¥éª¤3: å®Œæ•´æµç¨‹æ¨¡æ‹Ÿ</h2>
        <button onclick="testFullFlow()">ğŸ”„ æµ‹è¯•å®Œæ•´åˆå§‹åŒ–æµç¨‹</button>
        <div id="flowResult"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå…¨å±€å˜é‡
        let doctorInfo = {};
        let allSessions = [];

        async function testAPIResponse() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';

            try {
                const response = await fetch('/api/consultation/patient/history?user_id=usr_20250920_5741e17a78e8');
                const data = await response.json();

                const jinDafuRecord = data.data.consultation_history.find(c => c.doctor_id === 'jin_daifu');
                const zhangRecord = data.data.consultation_history.find(c => c.doctor_id === 'zhang_zhongjing');

                let html = '<div class="result success">';
                html += '<h3>âœ… APIæµ‹è¯•ç»“æœ</h3>';
                html += `<p><strong>æ€»è®°å½•æ•°:</strong> ${data.data.total_count}</p>`;

                if (jinDafuRecord) {
                    html += '<p class="pass">âœ… é‡‘å¤§å¤«è®°å½•å­˜åœ¨</p>';
                    html += `<pre>${JSON.stringify(jinDafuRecord, null, 2)}</pre>`;
                } else {
                    html += '<p class="fail">âŒ é‡‘å¤§å¤«è®°å½•ç¼ºå¤±</p>';
                }

                if (zhangRecord) {
                    html += '<p class="pass">âœ… å¼ ä»²æ™¯è®°å½•å­˜åœ¨</p>';
                    html += `<pre>${JSON.stringify(zhangRecord, null, 2)}</pre>`;
                } else {
                    html += '<p class="fail">âŒ å¼ ä»²æ™¯è®°å½•ç¼ºå¤±</p>';
                }

                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error"><h3>âŒ APIæµ‹è¯•å¤±è´¥</h3><p>${error.message}</p></div>`;
            }
        }

        async function testFixedLogic() {
            const resultDiv = document.getElementById('logicResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•ä¿®å¤åçš„é€»è¾‘...</p>';

            try {
                // æ­¥éª¤1: åŠ è½½åŒ»ç”Ÿä¿¡æ¯ (æ¨¡æ‹ŸloadDoctorInfo)
                console.log('ğŸ“ æ­¥éª¤1: åŠ è½½åŒ»ç”Ÿä¿¡æ¯');
                const doctorResponse = await fetch('/api/doctor/list');
                const doctorData = await doctorResponse.json();

                doctorInfo = {};
                if (doctorData.success && doctorData.doctors) {
                    doctorData.doctors.forEach(doctor => {
                        if (doctor.doctor_code) {
                            doctorInfo[doctor.doctor_code] = {
                                name: doctor.name,
                                emoji: 'ğŸ‘¨â€âš•ï¸',
                                description: 'ä¸­åŒ»ä¸“å®¶'
                            };
                        }
                    });
                }
                console.log('âœ… doctorInfoæ„å»ºå®Œæˆ:', Object.keys(doctorInfo));

                // ğŸ”‘ ä¿®å¤ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨updateDoctorTabs(),å› ä¸ºæ­¤æ—¶allSessionsè¿˜æ˜¯ç©ºçš„
                console.log('âš ï¸ æ­¤æ—¶allSessionsé•¿åº¦:', allSessions.length); // åº”è¯¥æ˜¯0

                // æ­¥éª¤2: åŠ è½½å†å²è®°å½• (æ¨¡æ‹ŸloadSessionHistory)
                console.log('ğŸ“ æ­¥éª¤2: åŠ è½½å†å²è®°å½•');
                const historyResponse = await fetch('/api/consultation/patient/history?user_id=usr_20250920_5741e17a78e8');
                const historyData = await historyResponse.json();

                const consultations = historyData.data.consultation_history || [];
                allSessions = consultations.map((consultation, index) => ({
                    session_id: consultation.consultation_id,
                    doctor_name: consultation.doctor_id,  // ğŸ”‘ ä½¿ç”¨doctor_id
                    doctor_display_name: consultation.doctor_name,  // ğŸ”‘ ä¿å­˜ä¸­æ–‡æ˜¾ç¤ºå
                    session_count: index + 1
                }));
                console.log('âœ… allSessionså¡«å……å®Œæˆ:', allSessions.length, 'æ¡è®°å½•');
                console.log('âœ… åŒ…å«çš„åŒ»ç”Ÿ:', [...new Set(allSessions.map(s => s.doctor_name))]);

                // æ­¥éª¤3: ç°åœ¨è°ƒç”¨updateDoctorTabs (æ¨¡æ‹ŸrenderSessionHistoryä¸­çš„è°ƒç”¨)
                console.log('ğŸ“ æ­¥éª¤3: ç”ŸæˆåŒ»ç”Ÿç­›é€‰æ ‡ç­¾');
                const doctorsWithData = [...new Set(allSessions.map(session => session.doctor_name))];
                console.log('ğŸ” æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ:', doctorsWithData);
                console.log('ğŸ” æ´»è·ƒåŒ»ç”Ÿ:', Object.keys(doctorInfo));

                const validDoctors = doctorsWithData.filter(doctorKey => doctorInfo[doctorKey]);
                console.log('âœ… ç­›é€‰åçš„åŒ»ç”Ÿ:', validDoctors);

                // æ˜¾ç¤ºç»“æœ
                let html = '<div class="result success">';
                html += '<h3>âœ… ä¿®å¤åçš„é€»è¾‘æµ‹è¯•ç»“æœ</h3>';

                html += '<h4>æ‰§è¡Œé¡ºåº (ä¿®å¤å):</h4>';
                html += '<ol>';
                html += '<li>âœ… loadDoctorInfo() å®Œæˆ â†’ doctorInfoæœ‰ ' + Object.keys(doctorInfo).length + ' ä½åŒ»ç”Ÿ</li>';
                html += '<li>âš ï¸ æ­¤æ—¶allSessions = [] (é•¿åº¦0) - ä¸è°ƒç”¨updateDoctorTabs()</li>';
                html += '<li>âœ… loadSessionHistory() å®Œæˆ â†’ allSessionsæœ‰ ' + allSessions.length + ' æ¡è®°å½•</li>';
                html += '<li>âœ… renderSessionHistory() è°ƒç”¨ updateDoctorTabs()</li>';
                html += '<li>âœ… updateDoctorTabs() ä½¿ç”¨å¡«å……åçš„allSessions</li>';
                html += '</ol>';

                html += '<h4>æœ€ç»ˆç»“æœ:</h4>';
                html += `<p><strong>æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ:</strong> ${doctorsWithData.join(', ')}</p>`;
                html += `<p><strong>æ´»è·ƒåŒ»ç”Ÿ:</strong> ${Object.keys(doctorInfo).join(', ')}</p>`;
                html += `<p><strong>ç­›é€‰åæ˜¾ç¤ºçš„åŒ»ç”Ÿ:</strong> ${validDoctors.join(', ')}</p>`;

                if (validDoctors.includes('jin_daifu') && validDoctors.includes('zhang_zhongjing')) {
                    html += '<p class="pass">âœ…âœ…âœ… æˆåŠŸï¼é‡‘å¤§å¤«å’Œå¼ ä»²æ™¯éƒ½ä¼šæ˜¾ç¤ºï¼</p>';
                } else {
                    html += '<p class="fail">âŒ å¤±è´¥ï¼æŸäº›åŒ»ç”Ÿæœªæ˜¾ç¤º</p>';
                }

                html += '<h4>ç”Ÿæˆçš„åŒ»ç”Ÿæ ‡ç­¾:</h4>';
                html += '<div style="display: flex; gap: 10px; margin-top: 10px;">';
                validDoctors.forEach(doctorKey => {
                    const doctor = doctorInfo[doctorKey];
                    html += `<button style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; border: none;">${doctor.name}</button>`;
                });
                html += '</div>';

                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error"><h3>âŒ é€»è¾‘æµ‹è¯•å¤±è´¥</h3><p>${error.message}</p><pre>${error.stack}</pre></div>`;
            }
        }

        async function testFullFlow() {
            const resultDiv = document.getElementById('flowResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•å®Œæ•´åˆå§‹åŒ–æµç¨‹...</p>';

            try {
                // é‡ç½®å…¨å±€å˜é‡
                doctorInfo = {};
                allSessions = [];

                let flowLog = [];

                // æ¨¡æ‹ŸinitializePage()
                flowLog.push('ğŸš€ initializePage() å¼€å§‹');

                // æ­¥éª¤1: Promise.all å¹¶è¡Œæ‰§è¡Œ
                flowLog.push('ğŸ“ Promise.all([loadDoctorInfo(), loadUserInfo()]) å¼€å§‹');

                await Promise.all([
                    (async () => {
                        flowLog.push('  â†’ loadDoctorInfo() å¼€å§‹');
                        const response = await fetch('/api/doctor/list');
                        const data = await response.json();
                        doctorInfo = {};
                        if (data.success && data.doctors) {
                            data.doctors.forEach(doctor => {
                                if (doctor.doctor_code) {
                                    doctorInfo[doctor.doctor_code] = {
                                        name: doctor.name,
                                        emoji: 'ğŸ‘¨â€âš•ï¸',
                                        description: 'ä¸­åŒ»ä¸“å®¶'
                                    };
                                }
                            });
                        }
                        flowLog.push(`  â†’ loadDoctorInfo() å®Œæˆ - doctorInfoæœ‰${Object.keys(doctorInfo).length}ä½åŒ»ç”Ÿ`);
                        flowLog.push(`  âš ï¸ ğŸ”‘ ä¿®å¤ï¼šä¸è°ƒç”¨updateDoctorTabs()ï¼Œå› ä¸ºallSessions=[](é•¿åº¦${allSessions.length})`);
                    })(),
                    (async () => {
                        flowLog.push('  â†’ loadUserInfo() å¼€å§‹');
                        // æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯åŠ è½½
                        await new Promise(resolve => setTimeout(resolve, 100));
                        flowLog.push('  â†’ loadUserInfo() å®Œæˆ');
                    })()
                ]);

                flowLog.push('âœ… Promise.all å®Œæˆ');

                // æ­¥éª¤2: loadSessionHistory é¡ºåºæ‰§è¡Œ
                flowLog.push('ğŸ“ loadSessionHistory() å¼€å§‹');
                const historyResponse = await fetch('/api/consultation/patient/history?user_id=usr_20250920_5741e17a78e8');
                const historyData = await historyResponse.json();
                const consultations = historyData.data.consultation_history || [];
                allSessions = consultations.map((consultation, index) => ({
                    session_id: consultation.consultation_id,
                    doctor_name: consultation.doctor_id,
                    doctor_display_name: consultation.doctor_name,
                    session_count: index + 1
                }));
                flowLog.push(`âœ… loadSessionHistory() å®Œæˆ - allSessionsæœ‰${allSessions.length}æ¡è®°å½•`);

                // æ­¥éª¤3: renderSessionHistory è°ƒç”¨ updateDoctorTabs
                flowLog.push('ğŸ“ renderSessionHistory() è°ƒç”¨ updateDoctorTabs()');
                const doctorsWithData = [...new Set(allSessions.map(session => session.doctor_name))];
                const validDoctors = doctorsWithData.filter(doctorKey => doctorInfo[doctorKey]);
                flowLog.push(`âœ… updateDoctorTabs() å®Œæˆ - ç”Ÿæˆ${validDoctors.length}ä¸ªåŒ»ç”Ÿæ ‡ç­¾`);

                flowLog.push('ğŸ‰ initializePage() å®Œæˆ');

                // æ˜¾ç¤ºç»“æœ
                let html = '<div class="result success">';
                html += '<h3>âœ… å®Œæ•´æµç¨‹æµ‹è¯•ç»“æœ</h3>';

                html += '<h4>æ‰§è¡Œæ—¥å¿—:</h4>';
                html += '<pre>' + flowLog.join('\n') + '</pre>';

                html += '<h4>æœ€ç»ˆçŠ¶æ€:</h4>';
                html += `<p><strong>doctorInfo:</strong> ${Object.keys(doctorInfo).length} ä½åŒ»ç”Ÿ (${Object.keys(doctorInfo).join(', ')})</p>`;
                html += `<p><strong>allSessions:</strong> ${allSessions.length} æ¡è®°å½•</p>`;
                html += `<p><strong>æœ‰è®°å½•çš„åŒ»ç”Ÿ:</strong> ${doctorsWithData.join(', ')}</p>`;
                html += `<p><strong>æ˜¾ç¤ºçš„åŒ»ç”Ÿæ ‡ç­¾:</strong> ${validDoctors.join(', ')}</p>`;

                if (validDoctors.includes('jin_daifu')) {
                    html += '<p class="pass">âœ…âœ…âœ… é‡‘å¤§å¤«æ ‡ç­¾ä¼šæ­£ç¡®æ˜¾ç¤ºï¼</p>';
                } else {
                    html += '<p class="fail">âŒ é‡‘å¤§å¤«æ ‡ç­¾ç¼ºå¤±</p>';
                }

                if (validDoctors.includes('zhang_zhongjing')) {
                    html += '<p class="pass">âœ…âœ…âœ… å¼ ä»²æ™¯æ ‡ç­¾ä¼šæ­£ç¡®æ˜¾ç¤ºï¼</p>';
                } else {
                    html += '<p class="fail">âŒ å¼ ä»²æ™¯æ ‡ç­¾ç¼ºå¤±</p>';
                }

                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error"><h3>âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥</h3><p>${error.message}</p><pre>${error.stack}</pre></div>`;
            }
        }
    </script>
</body>
</html>
