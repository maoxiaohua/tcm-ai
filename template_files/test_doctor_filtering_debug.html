<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŒ»ç”Ÿç­›é€‰è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        h3 { color: #333; margin-top: 0; }
    </style>
</head>
<body>
    <h1>ğŸ” åŒ»ç”Ÿç­›é€‰é—®é¢˜è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h3>1. æ£€æŸ¥ /api/doctor/list API è¿”å›</h3>
        <button onclick="checkDoctorListAPI()">ğŸ”„ æ£€æŸ¥åŒ»ç”Ÿåˆ—è¡¨API</button>
        <pre id="doctorListResult">ç­‰å¾…æ‰§è¡Œ...</pre>
    </div>

    <div class="section">
        <h3>2. æ£€æŸ¥ /api/consultation/patient/history API è¿”å›</h3>
        <button onclick="checkHistoryAPI()">ğŸ”„ æ£€æŸ¥å†å²è®°å½•API</button>
        <pre id="historyResult">ç­‰å¾…æ‰§è¡Œ...</pre>
    </div>

    <div class="section">
        <h3>3. æ¨¡æ‹Ÿ doctorInfo å¯¹è±¡æ„å»º</h3>
        <button onclick="simulateDoctorInfo()">ğŸ”„ æ¨¡æ‹Ÿæ„å»º</button>
        <pre id="doctorInfoResult">ç­‰å¾…æ‰§è¡Œ...</pre>
    </div>

    <div class="section">
        <h3>4. æ¨¡æ‹Ÿ allSessions æ•°æ®æ˜ å°„</h3>
        <button onclick="simulateAllSessions()">ğŸ”„ æ¨¡æ‹Ÿæ˜ å°„</button>
        <pre id="allSessionsResult">ç­‰å¾…æ‰§è¡Œ...</pre>
    </div>

    <div class="section">
        <h3>5. æ¨¡æ‹Ÿç­›é€‰é€»è¾‘</h3>
        <button onclick="simulateFiltering()">ğŸ”„ æ¨¡æ‹Ÿç­›é€‰</button>
        <pre id="filteringResult">ç­‰å¾…æ‰§è¡Œ...</pre>
    </div>

    <script>
        let doctorInfo = {};
        let allSessions = [];

        async function checkDoctorListAPI() {
            try {
                const response = await fetch('/api/doctor/list');
                const data = await response.json();
                document.getElementById('doctorListResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('doctorListResult').textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function checkHistoryAPI() {
            try {
                // ä½¿ç”¨å®é™…ç”¨æˆ·ID
                const userId = 'usr_20250920_5741e17a78e8';
                const response = await fetch(`/api/consultation/patient/history?user_id=${userId}`);
                const data = await response.json();
                document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('historyResult').textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function simulateDoctorInfo() {
            try {
                const response = await fetch('/api/doctor/list');
                const data = await response.json();

                doctorInfo = {};
                if (data.success && data.doctors) {
                    data.doctors.forEach(doctor => {
                        if (doctor.doctor_code) {
                            doctorInfo[doctor.doctor_code] = {
                                name: doctor.name,
                                emoji: 'ğŸ‘¨â€âš•ï¸',
                                description: 'ä¸­åŒ»ä¸“å®¶'
                            };
                        }
                    });
                }

                const result = {
                    "è¯´æ˜": "è¿™æ˜¯æ¨¡æ‹Ÿçš„ doctorInfo å¯¹è±¡",
                    "é”®åˆ—è¡¨": Object.keys(doctorInfo),
                    "å®Œæ•´å¯¹è±¡": doctorInfo
                };

                document.getElementById('doctorInfoResult').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('doctorInfoResult').textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function simulateAllSessions() {
            try {
                const userId = 'usr_20250920_5741e17a78e8';
                const response = await fetch(`/api/consultation/patient/history?user_id=${userId}`);
                const data = await response.json();

                if (data.success && data.data) {
                    const consultations = data.data.consultation_history || [];

                    allSessions = consultations.map((consultation, index) => ({
                        session_id: consultation.consultation_id,
                        doctor_name: consultation.doctor_id,  // ğŸ”‘ å…³é”®å­—æ®µ
                        doctor_display_name: consultation.doctor_name,
                        session_count: index + 1
                    }));
                }

                const result = {
                    "è¯´æ˜": "è¿™æ˜¯æ¨¡æ‹Ÿçš„ allSessions æ•°ç»„",
                    "æ€»è®°å½•æ•°": allSessions.length,
                    "åŒ»ç”ŸIDåˆ—è¡¨": [...new Set(allSessions.map(s => s.doctor_name))],
                    "å®Œæ•´æ•°æ®": allSessions
                };

                document.getElementById('allSessionsResult').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('allSessionsResult').textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function simulateFiltering() {
            // ç¡®ä¿å…ˆæ‰§è¡Œäº†å‰é¢çš„æ­¥éª¤
            if (Object.keys(doctorInfo).length === 0 || allSessions.length === 0) {
                document.getElementById('filteringResult').textContent = 'âŒ è¯·å…ˆæ‰§è¡Œæ­¥éª¤3å’Œæ­¥éª¤4';
                return;
            }

            // è·å–æ‰€æœ‰æœ‰æ•°æ®çš„åŒ»ç”Ÿ
            const doctorsWithData = [...new Set(allSessions.map(session => session.doctor_name))];
            console.log('ğŸ” æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ:', doctorsWithData);
            console.log('ğŸ” æ´»è·ƒåŒ»ç”Ÿé”®åˆ—è¡¨:', Object.keys(doctorInfo));

            // ç­›é€‰å‡ºæ´»è·ƒä¸”æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ (è¿™æ˜¯åŸå§‹çš„ç­›é€‰é€»è¾‘)
            const validDoctors = doctorsWithData.filter(doctorKey => doctorInfo[doctorKey]);

            const result = {
                "è¯´æ˜": "è¿™æ˜¯ç­›é€‰é€»è¾‘çš„ç»“æœ",
                "æœ‰å†å²è®°å½•çš„åŒ»ç”ŸID": doctorsWithData,
                "doctorInfoä¸­çš„é”®": Object.keys(doctorInfo),
                "ç­›é€‰åçš„åŒ»ç”ŸID": validDoctors,
                "è¯¦ç»†æ£€æŸ¥": doctorsWithData.map(doctorKey => ({
                    "doctor_id": doctorKey,
                    "åœ¨doctorInfoä¸­": doctorKey in doctorInfo,
                    "doctorInfoå€¼": doctorInfo[doctorKey] || null
                }))
            };

            document.getElementById('filteringResult').textContent = JSON.stringify(result, null, 2);
        }
    </script>
</body>
</html>
