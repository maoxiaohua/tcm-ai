<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤„æ–¹æ”¯ä»˜æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #2d5aa0;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .test-case {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: #f8fafc;
        }
        
        .test-case.pass {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .test-case.fail {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .case-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .case-description {
            color: #6b7280;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .test-result {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .result-pass {
            background: #dcfce7;
            color: #166534;
        }
        
        .result-fail {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .result-details {
            margin-top: 8px;
            font-family: monospace;
            font-size: 12px;
            background: #f3f4f6;
            padding: 8px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        
        .test-button {
            background: linear-gradient(135deg, #2d5aa0, #4a7bc8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .test-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 90, 160, 0.3);
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .summary.pass {
            background: #dcfce7;
            color: #166534;
        }
        
        .summary.fail {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-title">ğŸ§ª å¤„æ–¹æ”¯ä»˜æµç¨‹å›å½’æµ‹è¯•</div>
        <p><strong>æµ‹è¯•ç›®æ ‡:</strong> éªŒè¯å¤„æ–¹æ£€æµ‹å’Œæ”¯ä»˜åŠŸèƒ½çš„å®Œæ•´æ€§ï¼Œç¡®ä¿æ²¡æœ‰åŠŸèƒ½å›å½’ã€‚</p>
        
        <div class="test-controls">
            <button class="test-button" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="test-button" onclick="runCriticalTests()">å…³é”®åŠŸèƒ½æµ‹è¯•</button>
            <button class="test-button" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
    </div>
    
    <div id="testResults"></div>
    
    <div id="testSummary"></div>

    <script src="/static/js/prescription_renderer.js"></script>
    <script>
        // æ¨¡æ‹Ÿå…¨å±€ç¯å¢ƒ
        window.selectedDoctor = 'zhang_zhongjing';
        
        // æµ‹è¯•ç”¨ä¾‹æ•°æ®
        const testCases = [
            {
                id: 'complete_prescription',
                title: 'å®Œæ•´å¤„æ–¹æ£€æµ‹',
                description: 'åº”è¯¥æ£€æµ‹åˆ°å®Œæ•´å¤„æ–¹å¹¶è§¦å‘æ”¯ä»˜æµç¨‹',
                content: `## å¤„æ–¹å»ºè®®

### ã€å›è¯ã€‘
å…šå‚ 15g - å¤§è¡¥å…ƒæ°”ï¼Œå¥è„¾å…»èƒƒ
ç™½æœ¯ 12g - å¥è„¾ç‡¥æ¹¿ï¼Œç›Šæ°”æ­¢æ±—

### ã€è‡£è¯ã€‘
èŒ¯è‹“ 15g - å¥è„¾æ¸—æ¹¿ï¼Œå®å¿ƒå®‰ç¥
å±±è¯ 20g - è¡¥è„¾å…»èƒƒï¼Œç”Ÿæ´¥ç›Šè‚º

### ã€ä½è¯ã€‘
é™ˆçš® 10g - ç†æ°”å¥è„¾ï¼Œç‡¥æ¹¿åŒ–ç—°
åŠå¤ 10g - ç‡¥æ¹¿åŒ–ç—°ï¼Œé™é€†æ­¢å‘•

### ã€ä½¿è¯ã€‘
ç”˜è‰ 6g - è°ƒå’Œè¯¸è¯ï¼Œç›Šæ°”å’Œä¸­

### ç…æœæ–¹æ³•
æ¯æ—¥1å‰‚ï¼Œæ°´ç…æœï¼Œåˆ†2æ¬¡æ¸©æœ`,
                expected: {
                    containsPrescription: true,
                    isTemporaryAdvice: false,
                    needsPayment: true
                }
            },
            
            {
                id: 'temporary_advice',
                title: 'ä¸´æ—¶å»ºè®®è¯†åˆ«',
                description: 'åº”è¯¥è¯†åˆ«ä¸´æ—¶å»ºè®®ï¼Œä¸è§¦å‘æ”¯ä»˜',
                content: `## åˆæ­¥å¤„æ–¹å»ºè®®ï¼ˆå¾…ç¡®è®¤ï¼‰

æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œåˆæ­¥è€ƒè™‘å¯ç”¨ï¼š
- å…šå‚ 15g
- ç™½æœ¯ 12g
- èŒ¯è‹“ 15g

è¯·è¡¥å……èˆŒè±¡ä¿¡æ¯åï¼Œæˆ‘å°†ä¸ºæ‚¨ç¡®è®¤æœ€ç»ˆå¤„æ–¹ã€‚`,
                expected: {
                    containsPrescription: false, // ä¸´æ—¶å»ºè®®ä¸ç®—å®Œæ•´å¤„æ–¹
                    isTemporaryAdvice: true,
                    needsPayment: false
                }
            },
            
            {
                id: 'diagnostic_analysis',
                title: 'çº¯è¯Šæ–­åˆ†æ',
                description: 'åº”è¯¥è¯†åˆ«ä¸ºæ™®é€šè¯Šæ–­ï¼Œä¸è§¦å‘æ”¯ä»˜',
                content: `## ä¸­åŒ»åˆ†æ

æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œåˆæ­¥è¾¨è¯ä¸ºè„¾èƒƒè™šå¼±è¯ã€‚

**ç—‡çŠ¶åˆ†æ**ï¼š
- ç–²åŠ³ä¹åŠ› - æç¤ºè„¾æ°”è™šå¼±
- é£Ÿæ¬²ä¸æŒ¯ - è„¾èƒƒåŠŸèƒ½å‡é€€
- è…¹èƒ€ - æ°”æœºä¸ç•…

**å»ºè®®**ï¼š
1. ä¿æŒè§„å¾‹ä½œæ¯
2. é¥®é£Ÿå®œæ¸…æ·¡
3. é€‚å½“è¿åŠ¨

å¦‚éœ€å¼€å…·å¤„æ–¹ï¼Œè¯·æä¾›æ›´è¯¦ç»†çš„èˆŒè±¡å’Œè„‰è±¡ä¿¡æ¯ã€‚`,
                expected: {
                    containsPrescription: false,
                    isTemporaryAdvice: false,
                    needsPayment: false
                }
            },
            
            {
                id: 'mixed_content',
                title: 'æ··åˆå†…å®¹æµ‹è¯•',
                description: 'åŒ…å«è¯Šæ–­åˆ†æå’Œä¸´æ—¶å»ºè®®çš„æ··åˆå†…å®¹',
                content: `## è¾¨è¯åˆ†æ
æ‚¨çš„ç—‡çŠ¶å±äºè„¾èƒƒè™šå¼±è¯ï¼Œç—…æœºä¸ºè„¾æ°”ä¸è¶³ï¼Œè¿åŒ–å¤±èŒã€‚

## æ²»ç–—åŸåˆ™
å¥è„¾ç›Šæ°”ï¼Œå’ŒèƒƒåŒ–æ¹¿

## æš‚æ‹Ÿå¤„æ–¹å»ºè®®
å…šå‚ 15gã€ç™½æœ¯ 12gã€èŒ¯è‹“ 15gã€ç”˜è‰ 6g

**è¯·æ³¨æ„**ï¼šæ­¤ä¸ºåˆæ­¥æ–¹æ¡ˆï¼Œè¯·ä¸Šä¼ èˆŒè±¡ç…§ç‰‡åç¡®è®¤æœ€ç»ˆå¤„æ–¹ã€‚`,
                expected: {
                    containsPrescription: false, // å«æœ‰"æš‚æ‹Ÿ"å…³é”®è¯ï¼Œå±äºä¸´æ—¶å»ºè®®
                    isTemporaryAdvice: true,
                    needsPayment: false
                }
            },
            
            {
                id: 'prescription_with_modification',
                title: 'å®Œæ•´å¤„æ–¹å«åŠ å‡',
                description: 'å®Œæ•´çš„å¤„æ–¹ï¼Œåº”è¯¥è§¦å‘æ”¯ä»˜',
                content: `## æ–¹å‰‚ç»„æˆ

**åŸºç¡€æ–¹è¯**ï¼š
å…šå‚ 15gã€ç™½æœ¯ 12gã€èŒ¯è‹“ 15gã€é™ˆçš® 10gã€åŠå¤ 10gã€ç”˜è‰ 6g

**éšè¯åŠ å‡**ï¼š
- è‹¥è…¹èƒ€æ˜æ˜¾ï¼ŒåŠ æ³å£³ 10g
- è‹¥ä¾¿æºä¸¥é‡ï¼ŒåŠ å±±è¯ 20g
- è‹¥é£Ÿæ¬²ä¸æŒ¯ï¼ŒåŠ ç¥æ›² 12g

**ç…æœæ–¹æ³•**ï¼š
æ°´ç…æœï¼Œæ¯æ—¥ä¸€å‰‚ï¼Œåˆ†æ—©æ™šä¸¤æ¬¡æ¸©æœ

**æ³¨æ„äº‹é¡¹**ï¼š
æœè¯æœŸé—´å¿Œç”Ÿå†·ã€æ²¹è…»é£Ÿç‰©`,
                expected: {
                    containsPrescription: true,
                    isTemporaryAdvice: false,
                    needsPayment: true
                }
            },
            
            {
                id: 'incomplete_prescription',
                title: 'ä¸å®Œæ•´å¤„æ–¹',
                description: 'ç¼ºå°‘å‰‚é‡çš„ä¸å®Œæ•´å¤„æ–¹ï¼Œä¸åº”è§¦å‘æ”¯ä»˜',
                content: `## è¯ç‰©å»ºè®®

è€ƒè™‘ä½¿ç”¨ä»¥ä¸‹ä¸­è¯ï¼š
- å…šå‚ - è¡¥æ°”å¥è„¾
- ç™½æœ¯ - ç‡¥æ¹¿åˆ©æ°´  
- èŒ¯è‹“ - å¥è„¾å®‰ç¥

å…·ä½“ç”¨é‡è¯·å’¨è¯¢ä¸“ä¸šä¸­åŒ»å¸ˆç¡®å®šã€‚`,
                expected: {
                    containsPrescription: false,
                    isTemporaryAdvice: false,
                    needsPayment: false
                }
            }
        ];
        
        let testResults = [];
        
        function runTest(testCase) {
            console.log(`\nğŸ§ª è¿è¡Œæµ‹è¯•: ${testCase.title}`);
            
            const result = {
                id: testCase.id,
                title: testCase.title,
                description: testCase.description,
                passed: true,
                details: {},
                errors: []
            };
            
            try {
                // æµ‹è¯•å¤„æ–¹æ£€æµ‹
                if (window.prescriptionRenderer) {
                    const containsPrescription = window.prescriptionRenderer.containsPrescription(testCase.content);
                    const isTemporaryAdvice = window.prescriptionRenderer.isTemporaryAdvice(testCase.content);
                    
                    result.details.containsPrescription = containsPrescription;
                    result.details.isTemporaryAdvice = isTemporaryAdvice;
                    result.details.needsPayment = containsPrescription && !isTemporaryAdvice;
                    
                    // éªŒè¯æœŸæœ›ç»“æœ
                    if (containsPrescription !== testCase.expected.containsPrescription) {
                        result.passed = false;
                        result.errors.push(`å¤„æ–¹æ£€æµ‹é”™è¯¯: æœŸæœ› ${testCase.expected.containsPrescription}, å®é™… ${containsPrescription}`);
                    }
                    
                    if (isTemporaryAdvice !== testCase.expected.isTemporaryAdvice) {
                        result.passed = false;
                        result.errors.push(`ä¸´æ—¶å»ºè®®æ£€æµ‹é”™è¯¯: æœŸæœ› ${testCase.expected.isTemporaryAdvice}, å®é™… ${isTemporaryAdvice}`);
                    }
                    
                    const needsPayment = containsPrescription && !isTemporaryAdvice;
                    if (needsPayment !== testCase.expected.needsPayment) {
                        result.passed = false;
                        result.errors.push(`æ”¯ä»˜è§¦å‘é”™è¯¯: æœŸæœ› ${testCase.expected.needsPayment}, å®é™… ${needsPayment}`);
                    }
                    
                } else {
                    result.passed = false;
                    result.errors.push('å¤„æ–¹æ¸²æŸ“å™¨æœªåŠ è½½');
                }
                
            } catch (error) {
                result.passed = false;
                result.errors.push(`æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${error.message}`);
            }
            
            return result;
        }
        
        function displayTestResult(result) {
            const container = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-case ${result.passed ? 'pass' : 'fail'}`;
            
            resultDiv.innerHTML = `
                <div class="case-title">
                    ${result.passed ? 'âœ…' : 'âŒ'} ${result.title}
                </div>
                <div class="case-description">${result.description}</div>
                <div class="test-result ${result.passed ? 'result-pass' : 'result-fail'}">
                    <strong>ç»“æœ:</strong> ${result.passed ? 'é€šè¿‡' : 'å¤±è´¥'}
                    ${result.errors.length > 0 ? `<br><strong>é”™è¯¯:</strong> ${result.errors.join(', ')}` : ''}
                </div>
                <div class="result-details">æ£€æµ‹ç»“æœ:
containsPrescription: ${result.details.containsPrescription}
isTemporaryAdvice: ${result.details.isTemporaryAdvice}
needsPayment: ${result.details.needsPayment}</div>
            `;
            
            container.appendChild(resultDiv);
        }
        
        function displaySummary(results) {
            const container = document.getElementById('testSummary');
            const passed = results.filter(r => r.passed).length;
            const total = results.length;
            const passRate = ((passed / total) * 100).toFixed(1);
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `summary ${passed === total ? 'pass' : 'fail'}`;
            
            summaryDiv.innerHTML = `
                <div class="test-title">æµ‹è¯•æ±‡æ€»</div>
                <p><strong>é€šè¿‡ç‡:</strong> ${passed}/${total} (${passRate}%)</p>
                <p><strong>çŠ¶æ€:</strong> ${passed === total ? 'âœ… å…¨éƒ¨é€šè¿‡ - åŠŸèƒ½æ­£å¸¸' : 'âŒ å­˜åœ¨å¤±è´¥ - éœ€è¦ä¿®å¤'}</p>
                ${passed !== total ? `<p><strong>å»ºè®®:</strong> æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿å¤„æ–¹æ£€æµ‹å’Œæ”¯ä»˜é€»è¾‘æ­£ç¡®å·¥ä½œã€‚</p>` : ''}
            `;
            
            container.innerHTML = '';
            container.appendChild(summaryDiv);
        }
        
        function runAllTests() {
            clearResults();
            testResults = [];
            
            testCases.forEach(testCase => {
                const result = runTest(testCase);
                testResults.push(result);
                displayTestResult(result);
            });
            
            displaySummary(testResults);
        }
        
        function runCriticalTests() {
            clearResults();
            testResults = [];
            
            const criticalCases = testCases.filter(tc => 
                tc.id === 'complete_prescription' || 
                tc.id === 'temporary_advice'
            );
            
            criticalCases.forEach(testCase => {
                const result = runTest(testCase);
                testResults.push(result);
                displayTestResult(result);
            });
            
            displaySummary(testResults);
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testSummary').innerHTML = '';
            testResults = [];
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºçŠ¶æ€
        window.addEventListener('load', function() {
            console.log('âœ… æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            console.log('ğŸ“‹ å¤„æ–¹æ¸²æŸ“å™¨çŠ¶æ€:', window.prescriptionRenderer ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            
            // è‡ªåŠ¨è¿è¡Œå…³é”®æµ‹è¯•
            setTimeout(() => {
                console.log('ğŸš€ è‡ªåŠ¨è¿è¡Œå…³é”®åŠŸèƒ½æµ‹è¯•...');
                runCriticalTests();
            }, 1000);
        });
    </script>
</body>
</html>