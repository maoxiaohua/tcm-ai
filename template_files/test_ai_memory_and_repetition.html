<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè®°å¿†åŠ›å’Œé‡å¤é—®è¯¢æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #2d5aa0;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .conversation-simulator {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }
        
        .user-message {
            background: #e0f2fe;
            border-left: 4px solid #0ea5e9;
        }
        
        .ai-message {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
        }
        
        .expected-message {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .test-button {
            background: linear-gradient(135deg, #2d5aa0, #4a7bc8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .test-pass {
            background: #dcfce7;
            color: #166534;
        }
        
        .test-fail {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .analysis {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-title">ğŸ§  AIè®°å¿†åŠ›å’Œé‡å¤é—®è¯¢æµ‹è¯•</div>
        <p><strong>æµ‹è¯•ç›®æ ‡:</strong> éªŒè¯AIæ˜¯å¦èƒ½è®°ä½å¯¹è¯å†å²ï¼Œé¿å…é‡å¤é—®è¯¢å·²ç»å›ç­”è¿‡çš„é—®é¢˜ã€‚</p>
        
        <div class="test-controls">
            <button class="test-button" onclick="runMemoryTest()">è¿è¡Œè®°å¿†åŠ›æµ‹è¯•</button>
            <button class="test-button" onclick="runRepetitionTest()">è¿è¡Œé‡å¤é—®è¯¢æµ‹è¯•</button>
            <button class="test-button" onclick="runFullScenarioTest()">å®Œæ•´åœºæ™¯æµ‹è¯•</button>
            <button class="test-button" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
    </div>
    
    <div id="testResults"></div>

    <script>
        // æ¨¡æ‹Ÿå¯¹è¯å†å²æ„å»ºå™¨
        class ConversationBuilder {
            constructor() {
                this.history = [];
                this.conversationId = 'test_' + Date.now();
            }
            
            addUserMessage(content) {
                this.history.push({
                    role: 'user',
                    content: content
                });
                return this;
            }
            
            addAIMessage(content) {
                this.history.push({
                    role: 'assistant', 
                    content: content
                });
                return this;
            }
            
            getHistory() {
                return [...this.history];
            }
            
            clear() {
                this.history = [];
                return this;
            }
        }
        
        // æµ‹è¯•ç”¨ä¾‹
        const testScenarios = [
            {
                id: 'basic_memory',
                title: 'åŸºç¡€è®°å¿†æµ‹è¯•',
                description: 'æµ‹è¯•AIæ˜¯å¦èƒ½è®°ä½æ‚£è€…å·²ç»æä¾›çš„åŸºæœ¬ä¿¡æ¯',
                setup: () => {
                    return new ConversationBuilder()
                        .addAIMessage('æ‚¨å¥½ï¼æˆ‘æ˜¯æœ±ä¸¹æºªï¼Œè¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ã€‚')
                        .addUserMessage('å¥³å­©å­8å²ï¼Œè‚šè„å‘¨å›´ç–¼ï¼Œéšç—›ã€‚å–å®Œæ°´å°±ä¼šç–¼ï¼Œç–¼5åˆ†é’Ÿä»¥å†…ä¼šè‡ªè¡Œç¼“è§£ã€‚æœ‰ä¾¿ç§˜ï¼Œå¤§ä¾¿å¹²ç¡¬ã€‚å¶å°”ä¾¿è¡€ï¼Œæ˜¯ç—”ç–®ã€‚èˆŒè‹”è–„ç™½ï¼Œæ·¡çº¢ã€‚')
                        .addAIMessage('æ ¹æ®æ‚¨çš„æè¿°ï¼Œè¿™æ˜¯å…¸å‹çš„é˜´è™šè‚ ç‡¥è¯ã€‚æˆ‘ä¸ºæ‚¨å¼€å…·å¤„æ–¹...')
                        .addUserMessage('ç–¼ç—›æ˜¯å’Œå–æ°´æœ‰å…³ï¼Œå–å®Œè¿‡å‡ ç§’å°±ä¼šç–¼æŒç»­4-5åˆ†é’Ÿã€‚ä¾¿è¡€é²œçº¢ï¼Œé‡æœ‰æ—¶å€™å¤šæœ‰æ—¶å€™å°‘ï¼Œé¢‘ç‡ä¸é«˜ã€‚æœ‰é£Ÿæ¬²ä¸ä½³ï¼Œé•¿æœŸä¾¿ç§˜å²ã€‚èˆŒè‹”è–„ç™½æ·¡çº¢ã€‚');
                },
                expectedBehavior: 'åº”è¯¥åŸºäºå·²æœ‰ä¿¡æ¯è¿›è¡Œæ·±å…¥åˆ†æï¼Œä¸åº”è¯¥å†é—®å¹´é¾„ã€ç—‡çŠ¶ã€ä¾¿è¡€æƒ…å†µã€èˆŒè±¡ç­‰å·²çŸ¥ä¿¡æ¯',
                prohibitedQuestions: [
                    'å¹´é¾„',
                    'ç–¼ç—›éƒ¨ä½',
                    'ç–¼ç—›æ€§è´¨', 
                    'ä¾¿è¡€é¢œè‰²',
                    'èˆŒè‹”é¢œè‰²',
                    'å¤§ä¾¿å¹²ç¡¬æƒ…å†µ'
                ]
            },
            
            {
                id: 'repetition_detection',
                title: 'é‡å¤é—®è¯¢æ£€æµ‹',
                description: 'ä¸“é—¨æµ‹è¯•AIæ˜¯å¦ä¼šé‡å¤é—®å·²ç»å›ç­”è¿‡çš„é—®é¢˜',
                setup: () => {
                    return new ConversationBuilder()
                        .addAIMessage('è¯·æè¿°æ‚¨çš„ç—‡çŠ¶')
                        .addUserMessage('å¤´ç—›ï¼Œä½ç½®åœ¨å¤ªé˜³ç©´ï¼Œèƒ€ç—›ï¼ŒæŒç»­3å¤©äº†ã€‚ä¼´æœ‰æ¶å¿ƒã€‚ç¡çœ ä¸å¥½ï¼Œé£Ÿæ¬²æ­£å¸¸ã€‚èˆŒè‹”è–„ç™½ï¼ŒèˆŒè´¨æ·¡çº¢ã€‚æ²¡æœ‰å‘çƒ­ã€‚')
                        .addAIMessage('æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œè€ƒè™‘è‚é˜³ä¸Šäº¢ã€‚è¯·é—®å¤´ç—›çš„å…·ä½“ä½ç½®åœ¨å“ªé‡Œï¼Ÿç–¼ç—›æ€§è´¨å¦‚ä½•ï¼Ÿæ˜¯å¦ä¼´æœ‰æ¶å¿ƒï¼Ÿ')
                        .addUserMessage('æˆ‘åˆšæ‰å·²ç»è¯´äº†ï¼Œå¤´ç—›åœ¨å¤ªé˜³ç©´ï¼Œæ˜¯èƒ€ç—›ï¼Œæœ‰æ¶å¿ƒã€‚');
                },
                expectedBehavior: 'AIåº”è¯¥æ„è¯†åˆ°è‡ªå·±é‡å¤é—®è¯¢äº†ï¼Œé“æ­‰å¹¶åŸºäºå·²æœ‰ä¿¡æ¯ç»§ç»­åˆ†æ',
                prohibitedQuestions: [
                    'å¤´ç—›ä½ç½®',
                    'ç–¼ç—›æ€§è´¨',
                    'æ˜¯å¦æ¶å¿ƒ',
                    'èˆŒè±¡é¢œè‰²'
                ]
            },
            
            {
                id: 'complete_info_analysis',
                title: 'ä¿¡æ¯å®Œæ•´æ€§åˆ†æ',
                description: 'æµ‹è¯•å½“ä¿¡æ¯è¶³å¤Ÿæ—¶ï¼ŒAIæ˜¯å¦èƒ½ç›´æ¥ç»™å‡ºè¯Šæ–­è€Œä¸æ˜¯ç»§ç»­é—®è¯Š',
                setup: () => {
                    return new ConversationBuilder()
                        .addAIMessage('è¯·æè¿°æ‚¨çš„ç—‡çŠ¶')
                        .addUserMessage('å¤±çœ å¤šæ¢¦ï¼Œå…¥ç¡å›°éš¾ï¼Œå®¹æ˜“é†’ï¼Œé†’åéš¾ä»¥å†ç¡ã€‚å¿ƒçƒ¦æ„ä¹±ï¼Œå¥å¿˜ã€‚èˆŒè´¨çº¢ï¼Œè‹”è–„é»„ï¼Œè„‰ç»†æ•°ã€‚å·²ç»æŒç»­2ä¸ªæœˆï¼Œå·¥ä½œå‹åŠ›å¤§ã€‚å¹³æ—¶å®¹æ˜“ä¸Šç«ï¼Œå£å¹²ã€‚å¤§å°ä¾¿æ­£å¸¸ã€‚');
                },
                expectedBehavior: 'ä¿¡æ¯å·²ç»è¶³å¤Ÿå®Œæ•´ï¼ˆä¸»ç—‡+ä¼´ç—‡+èˆŒè„‰+ç—…ç¨‹+è¯±å› ï¼‰ï¼Œåº”è¯¥ç»™å‡ºæ˜ç¡®è¯Šæ–­å’Œå¤„æ–¹',
                expectedActions: [
                    'æ˜ç¡®è¯Šæ–­',
                    'ç»™å‡ºå¤„æ–¹',
                    'ä¸å†è¿½é—®åŸºæœ¬ä¿¡æ¯'
                ]
            }
        ];
        
        // æµ‹è¯•æ‰§è¡Œå™¨
        class AIMemoryTester {
            constructor() {
                this.results = [];
            }
            
            async runTest(scenario) {
                console.log(`ğŸ§ª è¿è¡Œæµ‹è¯•: ${scenario.title}`);
                
                const result = {
                    id: scenario.id,
                    title: scenario.title,
                    description: scenario.description,
                    passed: false,
                    aiResponse: '',
                    analysis: {},
                    errors: []
                };
                
                try {
                    // è®¾ç½®å¯¹è¯å†å²
                    const conversationBuilder = scenario.setup();
                    const conversationHistory = conversationBuilder.getHistory();
                    const lastUserMessage = conversationHistory[conversationHistory.length - 1].content;
                    
                    // è°ƒç”¨AI API
                    const response = await this.callAI(lastUserMessage, conversationHistory, 'zhu_danxi');
                    result.aiResponse = response;
                    
                    // åˆ†æAIå›å¤
                    result.analysis = this.analyzeAIResponse(response, scenario);
                    result.passed = result.analysis.passed;
                    result.errors = result.analysis.errors;
                    
                } catch (error) {
                    result.errors.push(`æµ‹è¯•æ‰§è¡Œå¤±è´¥: ${error.message}`);
                    result.passed = false;
                }
                
                return result;
            }
            
            async callAI(message, conversationHistory, doctor) {
                try {
                    const response = await fetch('/api/consultation/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            conversation_id: 'memory_test_' + Date.now(),
                            selected_doctor: doctor,
                            conversation_history: conversationHistory
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.reply) {
                        return data.data.reply;
                    } else if (data.reply) {
                        return data.reply;
                    } else {
                        throw new Error('AIå“åº”æ ¼å¼é”™è¯¯');
                    }
                    
                } catch (error) {
                    throw new Error(`AIè°ƒç”¨å¤±è´¥: ${error.message}`);
                }
            }
            
            analyzeAIResponse(response, scenario) {
                const analysis = {
                    passed: true,
                    errors: [],
                    detectedIssues: [],
                    positivePoints: []
                };
                
                const responseLower = response.toLowerCase();
                
                // æ£€æŸ¥æ˜¯å¦é‡å¤é—®è¯¢ç¦æ­¢çš„é—®é¢˜
                if (scenario.prohibitedQuestions) {
                    scenario.prohibitedQuestions.forEach(question => {
                        if (this.containsQuestion(responseLower, question)) {
                            analysis.passed = false;
                            analysis.errors.push(`æ£€æµ‹åˆ°é‡å¤é—®è¯¢: ${question}`);
                            analysis.detectedIssues.push(`é‡å¤è¯¢é—®${question}ç›¸å…³é—®é¢˜`);
                        }
                    });
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«é¢„æœŸè¡Œä¸º
                if (scenario.expectedActions) {
                    scenario.expectedActions.forEach(action => {
                        if (this.containsExpectedAction(response, action)) {
                            analysis.positivePoints.push(`åŒ…å«é¢„æœŸè¡Œä¸º: ${action}`);
                        } else {
                            analysis.errors.push(`ç¼ºå°‘é¢„æœŸè¡Œä¸º: ${action}`);
                            analysis.passed = false;
                        }
                    });
                }
                
                // ç‰¹æ®Šæ£€æŸ¥ï¼šæ˜¯å¦åˆé—®äº†åŒæ ·çš„åç»­é—®é¢˜
                if (scenario.id === 'basic_memory') {
                    const commonQuestions = [
                        'æ˜¯å¦æœ‰å…¶ä»–éƒ¨ä½çš„ä¸é€‚',
                        'ä¾¿è¡€çš„é¢œè‰²ã€é‡åŠé¢‘ç‡',
                        'æ˜¯å¦æœ‰è…¹èƒ€ã€é£Ÿæ¬²ä¸ä½³',
                        'æ˜¯å¦æœ‰é•¿æœŸä¾¿ç§˜å²',
                        'è¯·æè¿°èˆŒè‹”å˜åŒ–'
                    ];
                    
                    let questionCount = 0;
                    commonQuestions.forEach(q => {
                        if (responseLower.includes(q.toLowerCase())) {
                            questionCount++;
                        }
                    });
                    
                    if (questionCount >= 3) {
                        analysis.passed = false;
                        analysis.errors.push('æ£€æµ‹åˆ°å¤§é‡é‡å¤é—®é¢˜ï¼ŒAIæ²¡æœ‰åˆ©ç”¨å·²æœ‰ä¿¡æ¯');
                        analysis.detectedIssues.push('é‡å¤é—®è¯Šæ¨¡å¼');
                    }
                }
                
                return analysis;
            }
            
            containsQuestion(response, questionTopic) {
                const questionPatterns = {
                    'å¹´é¾„': ['å¤šå¤§', 'å¹´é¾„', 'å‡ å²'],
                    'ç–¼ç—›éƒ¨ä½': ['å“ªé‡Œç–¼', 'ç–¼ç—›ä½ç½®', 'ç–¼åœ¨å“ª'],
                    'ç–¼ç—›æ€§è´¨': ['æ€ä¹ˆç–¼', 'ç–¼ç—›æ€§è´¨', 'ä»€ä¹ˆæ ·çš„ç–¼'],
                    'ä¾¿è¡€é¢œè‰²': ['ä¾¿è¡€.*é¢œè‰²', 'è¡€.*ä»€ä¹ˆé¢œè‰²'],
                    'èˆŒè‹”é¢œè‰²': ['èˆŒè‹”.*é¢œè‰²', 'èˆŒè‹”.*ä»€ä¹ˆæ ·'],
                    'å¤§ä¾¿å¹²ç¡¬æƒ…å†µ': ['å¤§ä¾¿.*æ€ä¹ˆæ ·', 'ä¾¿ç§˜.*æƒ…å†µ']
                };
                
                const patterns = questionPatterns[questionTopic] || [questionTopic];
                return patterns.some(pattern => {
                    const regex = new RegExp(pattern, 'i');
                    return regex.test(response);
                });
            }
            
            containsExpectedAction(response, action) {
                const actionPatterns = {
                    'æ˜ç¡®è¯Šæ–­': ['è¯', 'è¾¨è¯', 'è¯Šæ–­', 'è¯å€™'],
                    'ç»™å‡ºå¤„æ–¹': ['å¤„æ–¹', 'æ–¹å‰‚', 'è¯', 'å›è¯', 'è‡£è¯'],
                    'ä¸å†è¿½é—®åŸºæœ¬ä¿¡æ¯': true // é€šè¿‡å…¶ä»–æ£€æŸ¥æ¥éªŒè¯
                };
                
                const pattern = actionPatterns[action];
                if (pattern === true) return true; // é€šè¿‡å…¶ä»–æ–¹å¼éªŒè¯
                
                return Array.isArray(pattern) ? 
                    pattern.some(p => response.includes(p)) : 
                    response.includes(pattern);
            }
        }
        
        // æµ‹è¯•ç»“æœæ˜¾ç¤º
        function displayTestResult(result) {
            const container = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-container';
            
            resultDiv.innerHTML = `
                <div class="test-title">
                    ${result.passed ? 'âœ…' : 'âŒ'} ${result.title}
                </div>
                <p>${result.description}</p>
                
                <div class="test-result ${result.passed ? 'test-pass' : 'test-fail'}">
                    <strong>æµ‹è¯•ç»“æœ:</strong> ${result.passed ? 'é€šè¿‡' : 'å¤±è´¥'}
                    ${result.errors.length > 0 ? `<br><strong>é—®é¢˜:</strong> ${result.errors.join(', ')}` : ''}
                </div>
                
                ${result.analysis.positivePoints && result.analysis.positivePoints.length > 0 ? `
                    <div style="background: #dcfce7; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>âœ… æ­£é¢è¡¨ç°:</strong> ${result.analysis.positivePoints.join(', ')}
                    </div>
                ` : ''}
                
                ${result.analysis.detectedIssues && result.analysis.detectedIssues.length > 0 ? `
                    <div style="background: #fee2e2; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>âŒ æ£€æµ‹åˆ°çš„é—®é¢˜:</strong> ${result.analysis.detectedIssues.join(', ')}
                    </div>
                ` : ''}
                
                <details>
                    <summary style="cursor: pointer; color: #6b7280; margin-top: 10px;">æŸ¥çœ‹AIå›å¤</summary>
                    <div class="analysis">${result.aiResponse}</div>
                </details>
            `;
            
            container.appendChild(resultDiv);
        }
        
        // æµ‹è¯•æ‰§è¡Œå‡½æ•°
        const tester = new AIMemoryTester();
        
        async function runMemoryTest() {
            clearResults();
            const scenario = testScenarios.find(s => s.id === 'basic_memory');
            const result = await tester.runTest(scenario);
            displayTestResult(result);
        }
        
        async function runRepetitionTest() {
            clearResults();
            const scenario = testScenarios.find(s => s.id === 'repetition_detection');
            const result = await tester.runTest(scenario);
            displayTestResult(result);
        }
        
        async function runFullScenarioTest() {
            clearResults();
            
            for (const scenario of testScenarios) {
                const result = await tester.runTest(scenario);
                displayTestResult(result);
                
                // åœ¨æµ‹è¯•é—´æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIé¢‘ç‡é™åˆ¶
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        window.addEventListener('load', function() {
            console.log('âœ… AIè®°å¿†åŠ›æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            console.log('ğŸ§  å‡†å¤‡æµ‹è¯•AIçš„è®°å¿†èƒ½åŠ›å’Œé‡å¤é—®è¯¢æ£€æµ‹');
        });
    </script>
</body>
</html>