<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医生登录调试工具</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .debug-output { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .status { padding: 5px; margin: 5px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>🔍 医生登录调试工具</h1>
    
    <div class="debug-section">
        <h3>1. 当前状态检查</h3>
        <button onclick="checkCurrentState()">检查当前状态</button>
        <div id="currentState" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>2. 执行登录</h3>
        <button onclick="performLogin()">执行医生登录</button>
        <div id="loginResult" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>3. 测试医生门户访问</h3>
        <button onclick="testDoctorPortal()">测试/doctor访问</button>
        <div id="doctorPortalResult" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>4. 实时日志</h3>
        <button onclick="clearLogs()">清空日志</button>
        <div id="logs" class="debug-output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logsDiv.textContent += logEntry;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function checkCurrentState() {
            const output = document.getElementById('currentState');
            
            const state = {
                currentUrl: window.location.href,
                cookies: document.cookie || '无Cookie',
                localStorage: {
                    doctorToken: localStorage.getItem('doctorToken'),
                    adminToken: localStorage.getItem('adminToken'),
                    patientToken: localStorage.getItem('patientToken')
                },
                sessionToken: getCookie('session_token'),
                userAgent: navigator.userAgent
            };
            
            output.textContent = JSON.stringify(state, null, 2);
            log('当前状态检查完成');
        }

        async function performLogin() {
            const output = document.getElementById('loginResult');
            log('开始执行医生登录...');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'doctor',
                        password: 'doctor123'
                    }),
                    credentials: 'include' // 重要：包含Cookie
                });
                
                const result = await response.json();
                
                // 检查响应头中的Cookie设置
                const setCookieHeader = response.headers.get('Set-Cookie');
                
                const debugInfo = {
                    status: response.status,
                    result: result,
                    setCookieHeader: setCookieHeader,
                    actualCookies: document.cookie,
                    sessionTokenFromCookie: getCookie('session_token')
                };
                
                output.textContent = JSON.stringify(debugInfo, null, 2);
                
                // 如果登录成功但没有token，尝试从Cookie中获取
                if (result.success && !result.token) {
                    const sessionToken = getCookie('session_token');
                    if (sessionToken) {
                        localStorage.setItem('doctorToken', sessionToken);
                        log(`从Cookie设置doctorToken: ${sessionToken.substring(0, 20)}...`);
                    } else {
                        log('警告: 登录成功但未获取到session_token', 'warning');
                    }
                } else if (result.token) {
                    localStorage.setItem('doctorToken', result.token);
                    log(`从响应设置doctorToken: ${result.token.substring(0, 20)}...`);
                }
                
                log('登录请求完成');
                
            } catch (error) {
                output.textContent = `错误: ${error.message}`;
                log(`登录失败: ${error.message}`, 'error');
            }
        }

        async function testDoctorPortal() {
            const output = document.getElementById('doctorPortalResult');
            log('测试医生门户访问...');
            
            try {
                // 方法1: 直接访问（模拟用户点击）
                const response1 = await fetch('/doctor', {
                    method: 'GET',
                    credentials: 'include',
                    redirect: 'manual' // 不自动跟随重定向
                });
                
                const result1 = {
                    method: 'GET /doctor with credentials',
                    status: response1.status,
                    statusText: response1.statusText,
                    redirected: response1.redirected,
                    url: response1.url,
                    location: response1.headers.get('Location'),
                    cookies: document.cookie,
                    localStorage: localStorage.getItem('doctorToken')
                };
                
                // 方法2: 使用localStorage中的token作为Authorization头
                const doctorToken = localStorage.getItem('doctorToken');
                let result2 = null;
                
                if (doctorToken) {
                    const response2 = await fetch('/doctor', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${doctorToken}`
                        },
                        redirect: 'manual'
                    });
                    
                    result2 = {
                        method: 'GET /doctor with Bearer token',
                        status: response2.status,
                        statusText: response2.statusText,
                        redirected: response2.redirected,
                        url: response2.url,
                        location: response2.headers.get('Location')
                    };
                }
                
                const debugInfo = {
                    test1_cookie_auth: result1,
                    test2_bearer_token: result2,
                    conclusion: response1.status === 200 ? '成功访问' : '需要调试重定向原因'
                };
                
                output.textContent = JSON.stringify(debugInfo, null, 2);
                log(`门户访问测试完成，状态: ${response1.status}`);
                
            } catch (error) {
                output.textContent = `错误: ${error.message}`;
                log(`门户访问测试失败: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('logs').textContent = '';
        }

        // 页面加载时检查状态
        window.addEventListener('load', function() {
            log('调试工具加载完成');
            checkCurrentState();
        });
        
        // 监听localStorage变化
        window.addEventListener('storage', function(e) {
            if (e.key === 'doctorToken') {
                log(`doctorToken变化: ${e.oldValue} -> ${e.newValue}`);
            }
        });
    </script>
</body>
</html>