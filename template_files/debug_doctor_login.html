<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç”Ÿç™»å½•è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .debug-output { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .status { padding: 5px; margin: 5px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸ” åŒ»ç”Ÿç™»å½•è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h3>1. å½“å‰çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkCurrentState()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        <div id="currentState" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>2. æ‰§è¡Œç™»å½•</h3>
        <button onclick="performLogin()">æ‰§è¡ŒåŒ»ç”Ÿç™»å½•</button>
        <div id="loginResult" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>3. æµ‹è¯•åŒ»ç”Ÿé—¨æˆ·è®¿é—®</h3>
        <button onclick="testDoctorPortal()">æµ‹è¯•/doctorè®¿é—®</button>
        <div id="doctorPortalResult" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>4. å®æ—¶æ—¥å¿—</h3>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logs" class="debug-output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logsDiv.textContent += logEntry;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function checkCurrentState() {
            const output = document.getElementById('currentState');
            
            const state = {
                currentUrl: window.location.href,
                cookies: document.cookie || 'æ— Cookie',
                localStorage: {
                    doctorToken: localStorage.getItem('doctorToken'),
                    adminToken: localStorage.getItem('adminToken'),
                    patientToken: localStorage.getItem('patientToken')
                },
                sessionToken: getCookie('session_token'),
                userAgent: navigator.userAgent
            };
            
            output.textContent = JSON.stringify(state, null, 2);
            log('å½“å‰çŠ¶æ€æ£€æŸ¥å®Œæˆ');
        }

        async function performLogin() {
            const output = document.getElementById('loginResult');
            log('å¼€å§‹æ‰§è¡ŒåŒ»ç”Ÿç™»å½•...');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'doctor',
                        password: 'doctor123'
                    }),
                    credentials: 'include' // é‡è¦ï¼šåŒ…å«Cookie
                });
                
                const result = await response.json();
                
                // æ£€æŸ¥å“åº”å¤´ä¸­çš„Cookieè®¾ç½®
                const setCookieHeader = response.headers.get('Set-Cookie');
                
                const debugInfo = {
                    status: response.status,
                    result: result,
                    setCookieHeader: setCookieHeader,
                    actualCookies: document.cookie,
                    sessionTokenFromCookie: getCookie('session_token')
                };
                
                output.textContent = JSON.stringify(debugInfo, null, 2);
                
                // å¦‚æœç™»å½•æˆåŠŸä½†æ²¡æœ‰tokenï¼Œå°è¯•ä»Cookieä¸­è·å–
                if (result.success && !result.token) {
                    const sessionToken = getCookie('session_token');
                    if (sessionToken) {
                        localStorage.setItem('doctorToken', sessionToken);
                        log(`ä»Cookieè®¾ç½®doctorToken: ${sessionToken.substring(0, 20)}...`);
                    } else {
                        log('è­¦å‘Š: ç™»å½•æˆåŠŸä½†æœªè·å–åˆ°session_token', 'warning');
                    }
                } else if (result.token) {
                    localStorage.setItem('doctorToken', result.token);
                    log(`ä»å“åº”è®¾ç½®doctorToken: ${result.token.substring(0, 20)}...`);
                }
                
                log('ç™»å½•è¯·æ±‚å®Œæˆ');
                
            } catch (error) {
                output.textContent = `é”™è¯¯: ${error.message}`;
                log(`ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testDoctorPortal() {
            const output = document.getElementById('doctorPortalResult');
            log('æµ‹è¯•åŒ»ç”Ÿé—¨æˆ·è®¿é—®...');
            
            try {
                // æ–¹æ³•1: ç›´æ¥è®¿é—®ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»ï¼‰
                const response1 = await fetch('/doctor', {
                    method: 'GET',
                    credentials: 'include',
                    redirect: 'manual' // ä¸è‡ªåŠ¨è·Ÿéšé‡å®šå‘
                });
                
                const result1 = {
                    method: 'GET /doctor with credentials',
                    status: response1.status,
                    statusText: response1.statusText,
                    redirected: response1.redirected,
                    url: response1.url,
                    location: response1.headers.get('Location'),
                    cookies: document.cookie,
                    localStorage: localStorage.getItem('doctorToken')
                };
                
                // æ–¹æ³•2: ä½¿ç”¨localStorageä¸­çš„tokenä½œä¸ºAuthorizationå¤´
                const doctorToken = localStorage.getItem('doctorToken');
                let result2 = null;
                
                if (doctorToken) {
                    const response2 = await fetch('/doctor', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${doctorToken}`
                        },
                        redirect: 'manual'
                    });
                    
                    result2 = {
                        method: 'GET /doctor with Bearer token',
                        status: response2.status,
                        statusText: response2.statusText,
                        redirected: response2.redirected,
                        url: response2.url,
                        location: response2.headers.get('Location')
                    };
                }
                
                const debugInfo = {
                    test1_cookie_auth: result1,
                    test2_bearer_token: result2,
                    conclusion: response1.status === 200 ? 'æˆåŠŸè®¿é—®' : 'éœ€è¦è°ƒè¯•é‡å®šå‘åŸå› '
                };
                
                output.textContent = JSON.stringify(debugInfo, null, 2);
                log(`é—¨æˆ·è®¿é—®æµ‹è¯•å®Œæˆï¼ŒçŠ¶æ€: ${response1.status}`);
                
            } catch (error) {
                output.textContent = `é”™è¯¯: ${error.message}`;
                log(`é—¨æˆ·è®¿é—®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('logs').textContent = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', function() {
            log('è°ƒè¯•å·¥å…·åŠ è½½å®Œæˆ');
            checkCurrentState();
        });
        
        // ç›‘å¬localStorageå˜åŒ–
        window.addEventListener('storage', function(e) {
            if (e.key === 'doctorToken') {
                log(`doctorTokenå˜åŒ–: ${e.oldValue} -> ${e.newValue}`);
            }
        });
    </script>
</body>
</html>