<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>处方恢复测试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto; }
        .container { max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 处方状态恢复测试工具</h1>
        
        <div class="test-result info">
            <h3>📋 测试说明</h3>
            <p>这个页面用于测试患者端刷新后处方状态恢复问题。</p>
            <p><strong>问题现象</strong>：页面刷新后显示"从云端恢复0条处方"然后"恢复3条处方"，但对话框仍为空。</p>
        </div>

        <button onclick="testAPI()">🌐 测试API接口</button>
        <button onclick="testUserContext()">👤 测试用户上下文</button>
        <button onclick="testRecoveryMechanism()">🔄 测试恢复机制</button>
        <button onclick="simulatePageRefresh()">🔄 模拟页面刷新</button>
        <button onclick="clearTestData()">🗑️ 清理测试数据</button>

        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function log(message, type = 'info') {
            console.log(message);
            addResult(message, type);
        }

        // 测试API接口
        async function testAPI() {
            log('🌐 开始测试API接口...', 'info');
            
            try {
                const userId = 'usr_20250920_5741e17a78e8';
                const response = await fetch(`/api/prescription/patient/${userId}/prescriptions`);
                
                if (!response.ok) {
                    log(`❌ API调用失败: ${response.status} ${response.statusText}`, 'error');
                    return;
                }
                
                const result = await response.json();
                log(`✅ API调用成功，返回 ${result.prescriptions?.length || 0} 个处方`, 'success');
                
                if (result.prescriptions && result.prescriptions.length > 0) {
                    result.prescriptions.forEach(p => {
                        log(`📋 处方 ${p.id}: status=${p.status}, payment=${p.payment_status}`, 'info');
                    });
                } else {
                    log('⚠️ 未找到处方数据', 'warning');
                }
                
            } catch (error) {
                log(`❌ API测试失败: ${error.message}`, 'error');
            }
        }

        // 测试用户上下文
        function testUserContext() {
            log('👤 开始测试用户上下文...', 'info');
            
            // 模拟设置用户数据
            const testUser = {
                global_user_id: 'usr_20250920_5741e17a78e8',
                username: 'maoxiaohua',
                display_name: 'maoxiaohua'
            };
            
            localStorage.setItem('currentUser', JSON.stringify(testUser));
            localStorage.setItem('currentUserId', testUser.global_user_id);
            
            log(`✅ 设置测试用户: ${testUser.username} (${testUser.global_user_id})`, 'success');
            
            // 检查用户ID获取函数（简化版本）
            function getCurrentUserId() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.global_user_id) {
                    return currentUser.global_user_id;
                }
                return localStorage.getItem('currentUserId');
            }
            
            const currentId = getCurrentUserId();
            log(`🔍 当前用户ID: ${currentId}`, currentId ? 'success' : 'error');
        }

        // 测试恢复机制
        async function testRecoveryMechanism() {
            log('🔄 开始测试恢复机制...', 'info');
            
            try {
                const userId = 'usr_20250920_5741e17a78e8';
                log(`🔍 使用用户ID: ${userId}`, 'info');
                
                const response = await fetch(`/api/prescription/patient/${userId}/prescriptions`);
                if (!response.ok) {
                    log(`❌ 获取处方失败: ${response.status}`, 'error');
                    return;
                }
                
                const result = await response.json();
                log(`📋 获取到 ${result.prescriptions?.length || 0} 个处方`, 'info');
                
                if (result.success && result.prescriptions && result.prescriptions.length > 0) {
                    const prescriptions = result.prescriptions;
                    let restoredCount = 0;
                    
                    for (const prescription of prescriptions) {
                        const prescriptionId = prescription.id;
                        const status = prescription.status;
                        const paymentStatus = prescription.payment_status;
                        
                        log(`📋 处理处方ID ${prescriptionId}: status=${status}, payment=${paymentStatus}`, 'info');
                        
                        if (paymentStatus === 'paid' && status === 'pending_review') {
                            log(`⏳ 处方 ${prescriptionId} 符合恢复条件 (已支付 + 等待审核)`, 'success');
                            restoredCount++;
                        } else if (status === 'doctor_approved' || status === 'doctor_modified') {
                            log(`✅ 处方 ${prescriptionId} 已审核完成`, 'success');
                            restoredCount++;
                        } else {
                            log(`ℹ️ 处方 ${prescriptionId} 不需要恢复 (状态: ${status})`, 'info');
                        }
                    }
                    
                    if (restoredCount > 0) {
                        log(`🎉 恢复函数测试成功！应该恢复 ${restoredCount} 个处方状态`, 'success');
                        addResult(`
                            <strong>📱 实际测试步骤：</strong><br>
                            1. 在新标签页中打开: <a href="/smart" target="_blank">/smart</a><br>
                            2. 使用用户名 <code>maoxiaohua</code> 登录<br>
                            3. 页面加载完成后，应该自动显示 ${restoredCount} 个"等待医生审核"的处方<br>
                            4. 检查浏览器控制台是否有恢复日志
                        `, 'info');
                    } else {
                        log('⚠️ 没有需要恢复的处方', 'warning');
                    }
                } else {
                    log('⚠️ 未获取到有效的处方数据', 'warning');
                }
                
            } catch (error) {
                log(`❌ 恢复机制测试失败: ${error.message}`, 'error');
            }
        }

        // 模拟页面刷新
        function simulatePageRefresh() {
            log('🔄 模拟页面刷新行为...', 'info');
            
            // 设置用户数据（模拟登录状态）
            testUserContext();
            
            // 模拟延迟执行恢复函数（类似真实页面加载）
            setTimeout(() => {
                log('⏳ 模拟页面加载完成，开始执行恢复...', 'info');
                testRecoveryMechanism();
            }, 1000);
        }

        // 清理测试数据
        function clearTestData() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('userData');
            
            // 清理可能的对话相关数据
            const allKeys = Object.keys(localStorage);
            allKeys.forEach(key => {
                if (key.startsWith('conversationId_') || 
                    key.startsWith('tcm_doctor_history_') ||
                    key.startsWith('smart_user_')) {
                    localStorage.removeItem(key);
                }
            });
            
            log('🗑️ 测试数据已清理', 'success');
            
            // 清空结果显示
            document.getElementById('results').innerHTML = '';
        }

        // 页面加载时自动显示当前状态
        window.addEventListener('load', () => {
            log('🔧 处方恢复测试工具已加载', 'info');
            log('💡 点击上方按钮开始测试各个功能', 'info');
        });
    </script>
</body>
</html>