# AI智能决策树系统 - 功能说明与使用指南

## 🎯 系统概览

本系统为TCM-AI项目新增了完整的AI驱动决策树功能，集成了中医理论知识分析、自动路径生成、遗漏逻辑检测等智能功能，帮助医生快速构建高质量的诊疗决策树。

## 🚀 核心功能特性

### 1. AI自动生成决策树
- **功能**: 基于疾病名称自动生成完整的诊疗路径
- **覆盖疾病**: 失眠、胃痛、头痛等，支持通用疾病模板
- **路径结构**: 症状→判断条件→诊断→治疗→方剂的完整流程
- **智能特性**: 每个路径包含中医理论依据和关键词匹配

### 2. 中医理论分析
- **功能**: 基于传统中医理论评估决策树的合理性
- **分析维度**: 辨证论治逻辑、理论依据、完整性评估
- **评分机制**: 100分制评分，包含优势和不足分析
- **改进建议**: 提供具体的优化建议和知识补充

### 3. 遗漏逻辑检测
- **功能**: 智能检测决策树可能遗漏的重要诊疗逻辑
- **检测内容**: 常见证型、鉴别诊断、预后评估等
- **智能提醒**: 基于疾病特点提供针对性补充建议
- **快速修复**: 一键添加建议的诊疗路径

### 4. 可视化交互界面
- **拖拽构建**: 直观的可视化决策树构建器
- **实时预览**: 路径连线和节点关系可视化
- **多条件支持**: AND/OR逻辑组合的复杂判断条件
- **右键编辑**: 便捷的节点编辑和路径管理

## 📂 文件结构说明

### 前端文件
- **`static/decision_tree_v3.html`**: V3主界面，支持路径式决策树创建
- **`static/decision_tree_visual_builder.html`**: 可视化构建器，拖拽式树形结构编辑
- **`static/decision_tree_integration_demo.html`**: 集成演示，展示症状匹配效果

### 后端文件
- **`api/routes/doctor_decision_tree_routes.py`**: API路由定义，包含所有AI功能端点
- **`services/famous_doctor_learning_system.py`**: 核心AI服务实现
- **`test_ai_decision_tree_features.py`**: AI功能测试脚本

## 🔧 API端点说明

### 1. AI生成决策树
```http
POST /api/generate_visual_decision_tree
Content-Type: application/json

{
  "disease_name": "失眠",
  "include_tcm_analysis": true,
  "complexity_level": "standard"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "AI决策树生成成功",
  "data": {
    "paths": [
      {
        "id": "insomnia_heart_fire",
        "title": "心火旺盛型失眠",
        "steps": [...],
        "keywords": ["失眠", "多梦", "心烦"],
        "tcm_theory": "心主神明，心火亢盛则神不安"
      }
    ],
    "suggested_layout": {
      "auto_arrange": true,
      "spacing": {"horizontal": 300, "vertical": 150}
    }
  }
}
```

### 2. 中医理论分析
```http
POST /api/analyze_tree_tcm_theory
Content-Type: application/json

{
  "tree_data": { ... },
  "disease_name": "失眠"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "theory_analysis": {
      "overall_score": 85,
      "strengths": ["诊疗流程完整，层次清晰"],
      "weaknesses": ["可增加更多证型路径"],
      "theoretical_basis": "基于中医失眠的传统理论体系分析"
    },
    "improvement_suggestions": [...],
    "knowledge_supplements": [...]
  }
}
```

### 3. 遗漏逻辑检测
```http
POST /api/detect_missing_logic
Content-Type: application/json

{
  "current_tree": { ... },
  "disease_name": "失眠"
}
```

## 🏥 中医知识库集成

### 支持的疾病证型
- **失眠**: 心火旺盛证、心脾两虚证、肝郁化火证、心肾不交证、痰热扰心证
- **胃痛**: 脾胃虚寒证、肝气犯胃证、胃阴不足证、湿热中阻证、瘀血阻络证
- **头痛**: 风寒头痛、风热头痛、肝阳上亢、痰浊头痛、血瘀头痛
- **咳嗽**: 风寒咳嗽、风热咳嗽、痰湿咳嗽、痰热咳嗽、肺阴虚咳嗽

### 理论依据分析
- **虚证**: "虚则补之"的治疗原则
- **实热证**: "实则泻之，热者清之"的治疗原则  
- **气机不利**: "通则不痛"的治疗理念
- **辨证论治**: 中医个体化诊疗的核心思想

## 💡 使用流程指南

### 步骤1: 启动可视化构建器
1. 访问 `http://localhost:8000/static/decision_tree_visual_builder.html`
2. 在疾病名称输入框中输入目标疾病（如"失眠"）
3. 点击"AI自动生成"按钮

### 步骤2: AI生成与理论分析
1. 系统自动生成3-5条完整诊疗路径
2. 每条路径包含症状→条件→诊断→治疗→方剂的完整流程
3. 自动进行中医理论合理性分析
4. 显示理论评分和改进建议

### 步骤3: 遗漏逻辑检测
1. 点击"检测遗漏逻辑"按钮
2. 系统分析当前决策树的完整性
3. 提供具体的补充建议和快速添加选项
4. 一键添加建议的诊疗路径

### 步骤4: 交互式编辑优化
1. 使用拖拽功能调整节点位置
2. 右键编辑节点内容和条件
3. 添加新的路径和判断条件
4. 实时预览决策树结构

### 步骤5: 保存与集成
1. 保存完成的决策树到系统
2. 启用问诊集成功能
3. 在患者问诊时自动匹配决策路径
4. 提供智能方剂推荐

## 🧪 测试验证

### 运行功能测试
```bash
# 测试AI功能（本地测试）
python test_ai_decision_tree_features.py

# 测试API端点（需要服务器重启后）
python test_decision_tree_v3.py
```

### 预期测试结果
- ✅ AI生成3条失眠诊疗路径（心火旺盛、心脾两虚、肝郁化火）
- ✅ 理论分析评分85分，提供具体优势和不足分析
- ✅ 遗漏逻辑检测发现鉴别诊断和预后评估缺失
- ✅ 特定疾病支持失眠和胃痛的专门路径模板

## 🔄 集成工作流演示

### 完整的医生使用场景

1. **医生登录系统**
   - 访问医生门户，选择"智能决策树构建"

2. **快速生成决策树**
   - 输入"失眠"，点击AI生成
   - 系统自动生成3条路径：心火旺盛、心脾两虚、肝郁化火

3. **理论验证和优化**
   - 系统分析理论合理性：85分
   - 提示"可增加更多证型路径"
   - 建议"补充鉴别诊断要点"

4. **补充完善逻辑**
   - 检测遗漏：发现缺少"心肾不交证"和"痰热扰心证"
   - 一键添加：补充鉴别诊断路径
   - 手动优化：调整判断条件的具体性

5. **实际问诊应用**
   - 患者描述"失眠多梦心烦口干舌红苔黄"
   - 自动匹配到"心火旺盛型失眠"路径
   - 推荐"黄连阿胶汤"，匹配度85%

## 🎉 技术亮点

### AI智能化
- **自适应生成**: 根据疾病特点生成专门的诊疗路径
- **理论验证**: 基于中医基础理论进行自动验证
- **智能补全**: 检测和建议遗漏的重要诊疗逻辑

### 中医专业性
- **辨证论治**: 完整的症状→证候→治法→方药流程
- **流派融合**: 整合张仲景、叶天士、李东垣等名医思维
- **君臣佐使**: 方剂配伍的传统理论指导

### 交互体验
- **可视化构建**: 直观的拖拽式决策树编辑
- **实时分析**: 即时的理论分析和逻辑检测
- **一键添加**: 快速采纳AI建议优化决策树

### 临床实用性  
- **症状匹配**: 自动匹配患者症状到决策路径
- **置信度评估**: 量化的匹配度评估和推荐
- **集成问诊**: 与现有问诊系统无缝集成

## 📋 后续优化方向

1. **布局算法优化**: 实现更智能的自动布局算法
2. **知识库扩展**: 集成更大规模的中医知识库
3. **AI模型升级**: 接入更强大的中医专业AI模型
4. **多模态支持**: 结合舌象图片分析的决策路径
5. **协作功能**: 支持多医生协作编辑决策树

---

## 🔍 故障排除

### 常见问题

**Q: API端点返回404错误**
A: 需要重启API服务器以加载新的路由配置
```bash
# 重启API服务
python api/main.py
```

**Q: AI生成的决策树内容简单**
A: 当前使用模板生成，实际部署时需要配置Dashscope API密钥以启用真正的AI生成

**Q: 可视化构建器连线显示异常**
A: 清除浏览器缓存，或使用无痕模式重新访问

### 技术支持
- 功能演示: `test_ai_decision_tree_features.py`
- 集成测试: `test_decision_tree_v3.py`  
- 可视化演示: `decision_tree_integration_demo.html`

---

*最后更新: 2025-09-02*  
*版本: 1.0*  
*开发者: TCM-AI团队*