# TCM-AI ä¿®å¤æ±‡æ€» - 2025å¹´10æœˆ11æ—¥

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. æ³¨å†Œè·³è½¬URLé”™è¯¯ä¿®å¤ âœ…
**é—®é¢˜**: ç”¨æˆ·æ³¨å†ŒæˆåŠŸåè·³è½¬åˆ° `https://mxh0510.cn` è€Œä¸æ˜¯ `https://mxh0510.cn/login`

**ä¿®å¤ä½ç½®**: `/opt/tcm-ai/static/auth_portal.html`
- è¡Œ 1208: æ‰‹æœºæ³¨å†Œè·³è½¬ (ä¿®æ”¹ä¸º `/login`)
- è¡Œ 1689: æ‰‹æœºæ³¨å†Œè·³è½¬ (ä¿®æ”¹ä¸º `/login`)
- è¡Œ 1772: é‚®ç®±æ³¨å†Œè·³è½¬ (ä¿®æ”¹ä¸º `/login`)
- è¡Œ 1850: ç”¨æˆ·åæ³¨å†Œè·³è½¬ (ä¿®æ”¹ä¸º `/login`)

**ä¿®å¤ä»£ç **:
```javascript
// âŒ ä¿®å¤å‰:
window.location.href = '/';

// âœ… ä¿®å¤å:
window.location.href = '/login';
```

**é¢„æœŸæ•ˆæœ**:
- âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
- âœ… ç”¨æˆ·å¯ä»¥ç«‹å³ä½¿ç”¨æ–°è´¦æˆ·ç™»å½•ç³»ç»Ÿ
- âœ… é¿å…è·³è½¬åˆ°æ ¹è·¯å¾„å¯¼è‡´çš„æ··æ·†

---

### 2. JavaScriptç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ âœ…
**é—®é¢˜**: æµè§ˆå™¨ç¼“å­˜æ—§ç‰ˆæœ¬JavaScriptä»£ç ï¼Œå¯¼è‡´ä¿®å¤åçš„ä»£ç ä»ç„¶æ— æ³•ç”Ÿæ•ˆ

**æ ¹æœ¬åŸå› **:
- æµè§ˆå™¨ä¼šç¼“å­˜JavaScriptæ–‡ä»¶ä»¥åŠ å¿«åŠ è½½é€Ÿåº¦
- ä»£ç ä¿®å¤åï¼Œç”¨æˆ·æµè§ˆå™¨ä»ä½¿ç”¨ç¼“å­˜ä¸­çš„æ—§ä»£ç 
- å¯¼è‡´"æ˜æ˜ä¿®å¤äº†ä½†è¿˜æ˜¯æœ‰é—®é¢˜"çš„ç°è±¡

**ä¿®å¤æ–¹æ¡ˆ**: ä¸ºæ‰€æœ‰JavaScriptæ–‡ä»¶æ·»åŠ ç‰ˆæœ¬å‚æ•°

**ä¿®å¤ä½ç½®**:

1. `/opt/tcm-ai/static/index_smart_workflow.html` (æ‚£è€…ç«¯)
   - è¡Œ 97: `auth_manager.js?v=20251011001`
   - è¡Œ 11236: `conversation_state_manager.js?v=20251011001`
   - è¡Œ 11239: `auto_sync_manager.js?v=20251011001`

2. `/opt/tcm-ai/static/auth_portal.html` (ç™»å½•æ³¨å†Œé¡µ)
   - è¡Œ 10: `auth_manager.js?v=20251011001`

**ç‰ˆæœ¬å‘½åè§„èŒƒ**:
```
v + YYYYMMDD + åºå·
ä¾‹å¦‚: v20251011001 (2025å¹´10æœˆ11æ—¥ç¬¬1ä¸ªç‰ˆæœ¬)
```

**æœªæ¥æ›´æ–°æµç¨‹**:
```bash
# æ¯æ¬¡ä¿®æ”¹JavaScriptæ–‡ä»¶åï¼Œæ›´æ–°HTMLä¸­çš„ç‰ˆæœ¬å·
sed -i 's/v20251011001/v20251011002/g' /opt/tcm-ai/static/*.html
```

**é¢„æœŸæ•ˆæœ**:
- âœ… å¼ºåˆ¶æµè§ˆå™¨ä¸‹è½½æœ€æ–°ç‰ˆæœ¬JavaScript
- âœ… é¿å…ç¼“å­˜å¯¼è‡´çš„"ä¿®å¤æ— æ•ˆ"é—®é¢˜
- âœ… ä¾¿äºç‰ˆæœ¬è¿½è¸ªå’Œé—®é¢˜å®šä½

---

## ğŸ” å·²è¯†åˆ«ä½†å¾…ä¿®å¤çš„é—®é¢˜

### 3. æ‚£è€…ç«¯ç”¨æˆ·IDä¸åŒ¹é…é—®é¢˜ â³
**ç—‡çŠ¶**:
- æ‚£è€…åˆ·æ–°é¡µé¢åå¯¹è¯è®°å½•æ¸…ç©º
- å†å²è®°å½•æ˜¾ç¤º"å·²ä»äº‘ç«¯æ¢å¤0æ¡è®°å½•"
- æŸ¥çœ‹å†å²è®°å½•åˆ—è¡¨ä¸ºç©º

**æ ¹æœ¬åŸå› **:
```javascript
// å‰ç«¯ä½¿ç”¨çš„IDæ ¼å¼
const userId = 'user_1760162322';  // user_ + timestamp

// æ•°æ®åº“å®é™…å­˜å‚¨çš„IDæ ¼å¼
'usr_20250920_575ba94095a7'  // usr_ + date + random

// session APIè¿”å›çš„æ­£ç¡®ID
session.user_id = 'usr_20250920_575ba94095a7'
```

**æ•°æ®åº“è¯æ®**:
```sql
SELECT session_id, user_id FROM unified_sessions
WHERE session_id='sess_1760162322_10f8ae1113a2d5b8';
-- Result: usr_20250920_575ba94095a7

-- å‰ç«¯è¯·æ±‚: /api/conversation/history/user_1760162322
-- æ•°æ®åº“æŸ¥è¯¢: WHERE user_id = 'user_1760162322'
-- ç»“æœ: 0æ¡è®°å½• (å› ä¸ºIDä¸åŒ¹é…)
```

**ä¿®å¤æ–¹æ¡ˆ** (å¾…æ‰§è¡Œ):
```javascript
// éœ€è¦ä¿®å¤ getCurrentUserId() å‡½æ•°

// âŒ å½“å‰é”™è¯¯å®ç°:
function getCurrentUserId() {
    let userId = localStorage.getItem('global_user_id');
    if (!userId) {
        userId = 'user_' + Date.now();  // é”™è¯¯ï¼ç”Ÿæˆä¸´æ—¶ID
        localStorage.setItem('global_user_id', userId);
    }
    return userId;
}

// âœ… æ­£ç¡®å®ç°:
async function getCurrentUserId() {
    // 1. ä¼˜å…ˆä»session APIè·å–çœŸå®ID
    try {
        const response = await fetch('/api/auth/session');
        if (response.ok) {
            const data = await response.json();
            if (data.user_id) {
                return data.user_id;  // usr_xxxæ ¼å¼
            }
        }
    } catch (error) {
        console.error('è·å–sessionå¤±è´¥:', error);
    }

    // 2. é™çº§æ–¹æ¡ˆï¼šlocalStorage
    return localStorage.getItem('global_user_id') || null;
}
```

**ä¿®å¤ä½ç½®**: `/opt/tcm-ai/static/index_smart_workflow.html` ä¸­çš„ `getCurrentUserId()` å‡½æ•°

---

### 4. consultation_idå­—æ®µä¸ºç©ºé—®é¢˜ â³
**ç—‡çŠ¶**: æ‚£è€…å†å²è®°å½•è¯¦æƒ…ä¸­ç¼ºå°‘å®Œæ•´çš„å¯¹è¯å†…å®¹å’Œä¸­åŒ»åˆ†æ

**æ ¹æœ¬åŸå› **:
```sql
-- prescriptionsè¡¨ä¸­consultation_idä¸ºç©º
SELECT id, patient_id, consultation_id FROM prescriptions WHERE id=130;
-- Result: 130|usr_20250920_5741e17a78e8||  â† consultation_idä¸ºç©º!

-- å¯¼è‡´æ— æ³•å…³è”conversation_logè¡¨
SELECT * FROM conversation_log WHERE consultation_id = '';
-- Result: 0æ¡è®°å½• (æ— æ³•æ‰¾åˆ°å¯¹è¯è®°å½•)
```

**ä¿®å¤æ–¹æ¡ˆ** (å¾…æ‰§è¡Œ):
1. åç«¯ä¿®å¤ï¼šç¡®ä¿åˆ›å»ºå¤„æ–¹æ—¶å¡«å…… `consultation_id`
   - ä½ç½®: `/opt/tcm-ai/api/routes/unified_consultation_routes.py`
   - å‡½æ•°: `_store_consultation_record()`
   - ä¿®æ”¹: åˆ›å»ºprescriptionæ—¶å¿…é¡»åŒ…å« `consultation_id=consultation_id`

2. å†å²æ•°æ®ä¿®å¤ï¼šè¡¥å…¨ç°æœ‰å¤„æ–¹çš„ `consultation_id`
   ```sql
   -- é€šè¿‡patient_idå’Œæ—¶é—´æˆ³åŒ¹é…
   UPDATE prescriptions
   SET consultation_id = (
       SELECT id FROM consultations
       WHERE consultations.patient_id = prescriptions.patient_id
       AND consultations.created_at BETWEEN
           datetime(prescriptions.created_at, '-5 minutes') AND
           datetime(prescriptions.created_at, '+5 minutes')
       LIMIT 1
   )
   WHERE consultation_id IS NULL OR consultation_id = '';
   ```

---

### 5. åŒ»ç”Ÿç«¯å®¡æŸ¥ç½‘ç»œé”™è¯¯ â³
**å½“å‰çŠ¶æ€**: ä»£ç å·²ä¿®å¤ä½†æµè§ˆå™¨ç¼“å­˜ä»æ˜¾ç¤ºæ—§é”™è¯¯

**å·²ä¿®å¤çš„ä»£ç é”™è¯¯**:
1. âœ… `hideRejectForm()` â†’ `hideModifyForm()` (line 2835)
2. âœ… `showSection()` eventå‚æ•°å¤„ç† (line 2440)

**ç”¨æˆ·éœ€è¦æ‰§è¡Œ**:
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼š
   - **Windows/Linux**: `Ctrl + Shift + Delete`
   - **Mac**: `Cmd + Shift + Delete`
   - é€‰æ‹©"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
   - æ—¶é—´èŒƒå›´é€‰æ‹©"å…¨éƒ¨æ—¶é—´"

2. æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•ï¼š
   - **Chrome/Edge**: `Ctrl + Shift + N`
   - **Firefox**: `Ctrl + Shift + P`

3. å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼š
   - **Windows/Linux**: `Ctrl + Shift + R`
   - **Mac**: `Cmd + Shift + R`

**æ³¨æ„äº‹é¡¹**:
- å¤„æ–¹130çŠ¶æ€ä¸º `doctor_approved`ï¼Œå·²ç»å®¡æŸ¥è¿‡äº†ï¼Œä¸èƒ½é‡å¤å®¡æŸ¥
- æµ‹è¯•æ—¶åº”è¯¥ä½¿ç”¨çŠ¶æ€ä¸º `pending_review` çš„å¤„æ–¹
- åŒ»ç”Ÿåªèƒ½å®¡æŸ¥åˆ†é…ç»™è‡ªå·±çš„å¤„æ–¹ï¼ˆé€šè¿‡ `doctor_id` åŒ¹é…ï¼‰

---

## ğŸ“‹ æµ‹è¯•éªŒè¯æ¸…å•

### æ³¨å†ŒåŠŸèƒ½æµ‹è¯• âœ…
- [ ] æ‰‹æœºæ³¨å†ŒæˆåŠŸåè·³è½¬åˆ° `/login`
- [ ] é‚®ç®±æ³¨å†ŒæˆåŠŸåè·³è½¬åˆ° `/login`
- [ ] ç”¨æˆ·åæ³¨å†ŒæˆåŠŸåè·³è½¬åˆ° `/login`
- [ ] æ³¨å†Œåå¯ä»¥æ­£å¸¸ç™»å½•æ–°è´¦æˆ·

### JavaScriptç¼“å­˜æµ‹è¯• âœ…
- [ ] æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åï¼Œé”™è¯¯æ¶ˆå¤±
- [ ] å¼ºåˆ¶åˆ·æ–°åï¼Œçœ‹åˆ°æœ€æ–°ä»£ç æ•ˆæœ
- [ ] æ§åˆ¶å°ä¸å†æ˜¾ç¤ºæ—§çš„é”™è¯¯ä¿¡æ¯
- [ ] æ–°ç‰ˆæœ¬å‚æ•°æ­£ç¡®åŠ è½½ (æ£€æŸ¥Networké¢æ¿)

### æ‚£è€…ç«¯åŠŸèƒ½æµ‹è¯• â³
- [ ] ç™»å½•åç”¨æˆ·IDæ­£ç¡®æ˜¾ç¤º (usr_æ ¼å¼)
- [ ] åˆ·æ–°é¡µé¢åå¯¹è¯è®°å½•ä¿ç•™
- [ ] å†å²è®°å½•åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] å†å²è®°å½•è¯¦æƒ…å®Œæ•´ (å¯¹è¯ã€åˆ†æã€å¤„æ–¹)
- [ ] å¤šè®¾å¤‡åŒæ­¥æ­£å¸¸å·¥ä½œ

### åŒ»ç”Ÿç«¯åŠŸèƒ½æµ‹è¯• â³
- [ ] æ¸…é™¤ç¼“å­˜åå®¡æŸ¥åŠŸèƒ½æ­£å¸¸
- [ ] é€šè¿‡æŒ‰é’®æ­£å¸¸å·¥ä½œ
- [ ] æ‹’ç»/ä¿®æ”¹è¡¨å•æ­£å¸¸æ˜¾ç¤ºå’Œéšè—
- [ ] å®¡æŸ¥åå¤„æ–¹ä»åˆ—è¡¨ä¸­æ¶ˆå¤±
- [ ] ç»Ÿè®¡æ•°å­—æ­£ç¡®æ›´æ–°

---

## ğŸš€ éƒ¨ç½²ä¿¡æ¯

**éƒ¨ç½²æ—¶é—´**: 2025-10-11 16:25:25 CST

**æœåŠ¡çŠ¶æ€**: âœ… æ­£å¸¸è¿è¡Œ
```bash
sudo service tcm-ai status
# Active: active (running) since Sat 2025-10-11 16:25:25 CST
```

**ä»£ç ç‰ˆæœ¬**: v20251011001

**ä¿®æ”¹çš„æ–‡ä»¶**:
1. `/opt/tcm-ai/static/auth_portal.html` - æ³¨å†Œè·³è½¬ + JSç‰ˆæœ¬æ§åˆ¶
2. `/opt/tcm-ai/static/index_smart_workflow.html` - JSç‰ˆæœ¬æ§åˆ¶

**Gitå¤‡ä»½** (å¾…æ‰§è¡Œ):
```bash
cd /opt/tcm-ai
git add -A
git commit -m "ğŸ› ä¿®å¤æ³¨å†Œè·³è½¬URLé”™è¯¯ + æ·»åŠ JavaScriptç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ

- ä¿®å¤: æ³¨å†ŒæˆåŠŸåè·³è½¬åˆ°/loginè€Œä¸æ˜¯æ ¹è·¯å¾„
- æ–°å¢: JavaScriptæ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶å‚æ•° v20251011001
- æ”¹è¿›: å¼ºåˆ¶æµè§ˆå™¨æ›´æ–°ç¼“å­˜çš„JavaScriptä»£ç 
- ä½ç½®: auth_portal.html (4å¤„), index_smart_workflow.html (3å¤„)

è¿™è§£å†³äº†ç”¨æˆ·æ³¨å†Œåè·³è½¬æ··ä¹±å’Œæµè§ˆå™¨ç¼“å­˜å¯¼è‡´ä¿®å¤æ— æ•ˆçš„é—®é¢˜ã€‚

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## ğŸ’¡ ç”¨æˆ·æ“ä½œæŒ‡å—

### å¦‚æœåŒ»ç”Ÿç«¯å®¡æŸ¥ä»ç„¶æŠ¥é”™
1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜** (å¿…é¡»!)
   - Chrome: è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ æ¸…é™¤æµè§ˆæ•°æ®
   - å‹¾é€‰"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
   - æ—¶é—´èŒƒå›´é€‰"å…¨éƒ¨æ—¶é—´"
   - ç‚¹å‡»"æ¸…é™¤æ•°æ®"

2. **å¼ºåˆ¶åˆ·æ–°é¡µé¢**
   - Windows: `Ctrl + Shift + R`
   - Mac: `Cmd + Shift + R`

3. **éªŒè¯ç¼“å­˜æ¸…é™¤æˆåŠŸ**
   - æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
   - åˆ‡æ¢åˆ°Networké¢æ¿
   - åˆ·æ–°é¡µé¢
   - æ£€æŸ¥JavaScriptæ–‡ä»¶URLæ˜¯å¦åŒ…å« `?v=20251011001`

4. **æµ‹è¯•æ­£ç¡®çš„å¤„æ–¹**
   - ä¸è¦æµ‹è¯•å·²å®¡æŸ¥çš„å¤„æ–¹ (status = 'doctor_approved')
   - ä½¿ç”¨æ–°åˆ›å»ºçš„å¾…å®¡æŸ¥å¤„æ–¹ (status = 'pending_review')
   - ç¡®ä¿å¤„æ–¹åˆ†é…ç»™å½“å‰ç™»å½•çš„åŒ»ç”Ÿ

### å¦‚æœæ‚£è€…ç«¯å†å²è®°å½•ä¸ºç©º
**è¿™æ˜¯å·²çŸ¥é—®é¢˜ï¼Œæ­£åœ¨ä¿®å¤ä¸­**

ä¸´æ—¶è§£å†³æ–¹æ¡ˆ:
1. é‡æ–°ç™»å½•æ‚£è€…è´¦æˆ·
2. å¼€å§‹æ–°çš„é—®è¯Šå¯¹è¯
3. å®Œæˆé—®è¯Šåæ£€æŸ¥æ˜¯å¦è®°å½•

---

## ğŸ“ éœ€è¦æŠ€æœ¯æ”¯æŒ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤æ“ä½œåä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. æ¸…é™¤ç¼“å­˜çš„ç¡®è®¤æˆªå›¾
2. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯ä¿¡æ¯ (F12 â†’ Console)
3. Networké¢æ¿ä¸­JavaScriptæ–‡ä»¶çš„åŠ è½½æƒ…å†µ (F12 â†’ Network)
4. æµ‹è¯•çš„å…·ä½“æ“ä½œæ­¥éª¤

**æ–‡æ¡£æ›´æ–°**: 2025-10-11 16:26
**ç‰ˆæœ¬å·**: v20251011001
**æœåŠ¡çŠ¶æ€**: âœ… è¿è¡Œæ­£å¸¸
