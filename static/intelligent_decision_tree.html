<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åŒ»ç”Ÿå†³ç­–æ ‘ç”Ÿæˆå™¨ - AIè¾…åŠ©è¯Šç–—æ€ç»´æ¢³ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .step-container {
            margin-bottom: 30px;
        }

        .step-header {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-header:hover {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-color: #3b82f6;
        }

        .step-header.active {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .step-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #4f46e5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .step-info h3 {
            color: #1e40af;
            margin-bottom: 5px;
        }

        .step-info p {
            color: #6b7280;
            font-size: 14px;
        }

        .step-arrow {
            font-size: 1.5rem;
            color: #6b7280;
            transition: transform 0.3s ease;
        }

        .step-header.active .step-arrow {
            transform: rotate(90deg);
        }

        .step-content {
            display: none;
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #4f46e5;
        }

        .step-content.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .textarea-field {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        .btn {
            background: #4f46e5;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .analysis-result {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            margin-top: 20px;
        }

        .analysis-title {
            color: #1e40af;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .thinking-schools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .school-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .school-card:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .school-card.selected {
            background: #dbeafe;
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }

        .school-name {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 5px;
        }

        .school-desc {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        .tree-visualization {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            margin-top: 20px;
            position: relative;
        }

        .tree-node {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            max-width: 200px;
            position: relative;
            text-align: center;
            font-size: 13px;
            line-height: 1.4;
        }

        .tree-node:hover {
            background: #e0f2fe;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }

        .tree-node.symptom {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .tree-node.diagnosis {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .tree-node.treatment {
            background: #fce7f3;
            border-color: #ec4899;
        }

        .tree-node.formula {
            background: #f3e8ff;
            border-color: #a855f7;
        }

        /* åˆ†æ”¯è¿çº¿æ ·å¼ */
        .tree-connection {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }

        .branch-line {
            width: 2px;
            height: 30px;
            background: #6b7280;
            position: relative;
        }

        .branch-condition {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 11px;
            color: #374151;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .branch-condition.positive {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        .branch-condition.negative {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        /* èŠ‚ç‚¹å±‚çº§å®¹å™¨ */
        .tree-level {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(248, 250, 252, 0.5);
        }

        .tree-level-title {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 15px;
            padding: 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
        }

        .tree-nodes-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* å³é”®èœå• */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 180px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background: #f3f4f6;
        }

        .context-menu-item.danger {
            color: #dc2626;
        }

        .context-menu-item.danger:hover {
            background: #fee2e2;
        }

        /* æ·»åŠ åˆ†æ”¯å¯¹è¯æ¡† */
        .add-branch-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-branch-form {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .condition-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .condition-template {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .condition-template:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .examples {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .example-title {
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .example-text {
            color: #075985;
            font-size: 14px;
            line-height: 1.5;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .thinking-schools {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  æ™ºèƒ½å†³ç­–æ ‘ç”Ÿæˆå™¨</h1>
            <p>AIè¾…åŠ©ä¸­åŒ»è¯Šç–—æ€ç»´æ¢³ç† Â· è®©å¤æ‚çš„è¯Šæ–­é€»è¾‘å˜å¾—æ¸…æ™°å¯è§</p>
        </div>

        <div class="main-content">
            <!-- æ­¥éª¤1ï¼šç–¾ç—…æè¿° -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(1)">
                    <div class="step-title">
                        <div class="step-number">1</div>
                        <div class="step-info">
                            <h3>æè¿°æ‚¨çš„è¯Šç–—æ€è·¯</h3>
                            <p>ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨å¯¹æŸç§ç–¾ç—…çš„è¯Šæ–­å’Œæ²»ç–—æ€è€ƒè¿‡ç¨‹</p>
                        </div>
                    </div>
                    <div class="step-arrow">â–¶</div>
                </div>
                
                <div class="step-content" id="step1">
                    <div class="input-group">
                        <label class="input-label">ç–¾ç—…åç§°æˆ–ä¸»è¦ç—‡çŠ¶</label>
                        <input type="text" class="input-field" id="diseaseName" 
                               placeholder="ä¾‹å¦‚ï¼šæ…¢æ€§èƒƒç‚ã€å¤±çœ ã€æœˆç»ä¸è°ƒç­‰">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">æ‚¨çš„è¯Šç–—æ€ç»´è¿‡ç¨‹</label>
                        <textarea class="input-field textarea-field" id="thinkingProcess" 
                                  placeholder="è¯·è¯¦ç»†æè¿°æ‚¨å¯¹è¿™ç§ç–¾ç—…çš„è¯Šæ–­æ€è·¯ï¼ŒåŒ…æ‹¬ï¼š&#10;â€¢ é¦–å…ˆä¼šè§‚å¯Ÿå“ªäº›ç—‡çŠ¶æˆ–ä½“å¾&#10;â€¢ å¦‚ä½•è¿›è¡Œç—‡çŠ¶åˆ†æå’Œé‰´åˆ«è¯Šæ–­&#10;â€¢ è€ƒè™‘ä»€ä¹ˆæ ·çš„æ²»ç–—æ–¹æ¡ˆ&#10;â€¢ ç”¨è¯é€‰æ‹©çš„é€»è¾‘&#10;â€¢ å¯èƒ½çš„å˜è¯å¤„ç†&#10;&#10;è¯·å°½é‡è¯¦ç»†ï¼ŒAIä¼šå¸®æ‚¨æ•´ç†æˆæ¸…æ™°çš„å†³ç­–æ ‘ç»“æ„..."></textarea>
                    </div>
                    
                    <div class="examples">
                        <div class="example-title">ğŸ’¡ ç¤ºä¾‹å‚è€ƒ</div>
                        <div class="example-text">
                            "å¯¹äºå¤±çœ æ‚£è€…ï¼Œæˆ‘é¦–å…ˆä¼šè¯¢é—®å¤±çœ çš„ç±»å‹ï¼Œæ˜¯å…¥ç¡å›°éš¾ã€å¤šæ¢¦æ˜“é†’è¿˜æ˜¯æ—©é†’ã€‚ç„¶åè§‚å¯Ÿæ‚£è€…çš„ç²¾ç¥çŠ¶æ€ã€èˆŒè±¡è„‰è±¡ã€‚å¦‚æœæ˜¯å¿ƒç«æ—ºç››ï¼ŒèˆŒçº¢è‹”é»„ï¼Œè„‰æ•°ï¼Œæˆ‘ä¼šè€ƒè™‘æ¸…å¿ƒç«çš„æ–¹æ³•ï¼Œé€‰ç”¨é»„è¿é˜¿èƒ¶æ±¤æˆ–å®‰ç¥å®šå¿—ä¸¸ã€‚å¦‚æœæ˜¯å¿ƒè„¾ä¸¤è™šï¼Œé¢è‰²èé»„ï¼ŒèˆŒæ·¡è„‰å¼±ï¼Œåˆ™ç”¨å½’è„¾æ±¤è°ƒå…»ã€‚è¿˜è¦è€ƒè™‘æ˜¯å¦æœ‰è‚éƒåŒ–ç«çš„æƒ…å†µ..."
                        </div>
                    </div>
                    
                    <button class="btn" onclick="analyzeThinking()">
                        ğŸ” å¼€å§‹AIåˆ†æ
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤2ï¼šæµæ´¾è¡¥å…… -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(2)">
                    <div class="step-title">
                        <div class="step-number">2</div>
                        <div class="step-info">
                            <h3>é€‰æ‹©ä¸­åŒ»æµæ´¾è§†è§’</h3>
                            <p>é€‰æ‹©ä¸åŒçš„ä¸­åŒ»æµæ´¾æ¥è¡¥å……å’Œå®Œå–„æ‚¨çš„è¯Šç–—æ€è·¯</p>
                        </div>
                    </div>
                    <div class="step-arrow">â–¶</div>
                </div>
                
                <div class="step-content" id="step2">
                    <div class="thinking-schools">
                        <div class="school-card" onclick="selectSchool('zhongjing')">
                            <div class="school-name">ğŸ“œ å¼ ä»²æ™¯ç»æ–¹æ´¾</div>
                            <div class="school-desc">å…­ç»è¾¨è¯ï¼Œæ–¹è¯å¯¹åº”ï¼Œé‡è§†æ¡æ–‡åŸæ„</div>
                        </div>
                        <div class="school-card" onclick="selectSchool('tianshi')">
                            <div class="school-name">ğŸŒ¡ï¸ å¶å¤©å£«æ¸©ç—…æ´¾</div>
                            <div class="school-desc">å«æ°”è¥è¡€ï¼Œä¸‰ç„¦è¾¨è¯ï¼Œå–„æ²»å¤–æ„Ÿçƒ­ç—…</div>
                        </div>
                        <div class="school-card" onclick="selectSchool('dongyuan')">
                            <div class="school-name">ğŸŒ¾ æä¸œå£è„¾èƒƒæ´¾</div>
                            <div class="school-desc">é‡è§†è„¾èƒƒï¼Œå†…ä¼¤æ‚ç—…ï¼Œå‡æ¸…é™æµŠ</div>
                        </div>
                        <div class="school-card" onclick="selectSchool('qingan')">
                            <div class="school-name">ğŸ”¥ éƒ‘é’¦å®‰ç«ç¥æ´¾</div>
                            <div class="school-desc">é‡è§†é˜³æ°”ï¼Œå–„ç”¨å§œæ¡‚ï¼Œæ‰¶é˜³æŠ‘é˜´</div>
                        </div>
                        <div class="school-card" onclick="selectSchool('duzhou')">
                            <div class="school-name">âš–ï¸ åˆ˜æ¸¡èˆŸç»æ–¹æ´¾</div>
                            <div class="school-desc">ç°ä»£ç»æ–¹åº”ç”¨ï¼Œé‡è§†ä¸´åºŠå®è·µ</div>
                        </div>
                        <div class="school-card" onclick="selectSchool('comprehensive')">
                            <div class="school-name">ğŸ”„ ç»¼åˆå„æ´¾è§‚ç‚¹</div>
                            <div class="school-desc">æ•´åˆå¤šä¸ªæµæ´¾çš„è¯Šç–—æ€ç»´</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="generateEnhancedTree()">
                        ğŸŒ³ ç”Ÿæˆå¢å¼ºå†³ç­–æ ‘
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤3ï¼šå†³ç­–æ ‘å±•ç¤º -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(3)">
                    <div class="step-title">
                        <div class="step-number">3</div>
                        <div class="step-info">
                            <h3>äº¤äº’å¼å†³ç­–æ ‘</h3>
                            <p>æŸ¥çœ‹ã€ç¼–è¾‘å’Œå®Œå–„ç”Ÿæˆçš„å†³ç­–æ ‘ç»“æ„</p>
                        </div>
                    </div>
                    <div class="step-arrow">â–¶</div>
                </div>
                
                <div class="step-content" id="step3">
                    <div class="loading" id="loadingIndicator">
                        <div class="loading-spinner"></div>
                        <p>AIæ­£åœ¨åˆ†ææ‚¨çš„è¯Šç–—æ€è·¯ï¼Œè¯·ç¨å€™...</p>
                    </div>
                    
                    <div class="analysis-result" id="analysisResult" style="display: none;">
                        <div class="analysis-title">
                            ğŸ¯ AIåˆ†æç»“æœ
                        </div>
                        <div id="analysisContent">
                            <!-- AIåˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <div class="tree-visualization" id="treeVisualization" style="display: none;">
                        <div class="analysis-title">
                            ğŸŒ³ å†³ç­–æ ‘ç»“æ„å›¾
                        </div>
                        <div id="treeContent">
                            <!-- å†³ç­–æ ‘å¯è§†åŒ–å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="exportDecisionTree()">
                            ğŸ“¥ å¯¼å‡ºå†³ç­–æ ‘
                        </button>
                        <button class="btn" onclick="saveToLibrary()">
                            ğŸ’¾ ä¿å­˜åˆ°çŸ¥è¯†åº“
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedSchools = [];
        let currentDecisionTree = null;
        let selectedNodeId = null;
        let editingNode = null;
        
        // åˆ‡æ¢æ­¥éª¤æ˜¾ç¤º
        function toggleStep(stepNumber) {
            const header = event.target.closest('.step-header');
            const content = document.getElementById(`step${stepNumber}`);
            
            // åˆ‡æ¢activeçŠ¶æ€
            header.classList.toggle('active');
            content.classList.toggle('active');
        }
        
        // é€‰æ‹©ä¸­åŒ»æµæ´¾
        function selectSchool(schoolId) {
            const card = event.target.closest('.school-card');
            card.classList.toggle('selected');
            
            if (selectedSchools.includes(schoolId)) {
                selectedSchools = selectedSchools.filter(id => id !== schoolId);
            } else {
                selectedSchools.push(schoolId);
            }
            
            console.log('å·²é€‰æ‹©æµæ´¾:', selectedSchools);
        }
        
        // åˆ†æè¯Šç–—æ€ç»´
        async function analyzeThinking() {
            const diseaseName = document.getElementById('diseaseName').value.trim();
            const thinkingProcess = document.getElementById('thinkingProcess').value.trim();
            
            if (!diseaseName || !thinkingProcess) {
                alert('è¯·å¡«å†™ç–¾ç—…åç§°å’Œè¯Šç–—æ€ç»´è¿‡ç¨‹');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadingIndicator').classList.add('active');
            
            try {
                // è°ƒç”¨AIåˆ†ææ¥å£
                const response = await fetch('/api/analyze_thinking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName,
                        thinking_process: thinkingProcess
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    displayAnalysisResult(diseaseName, thinkingProcess, data.data);
                } else {
                    throw new Error(data.message || 'åˆ†æå¤±è´¥');
                }
                
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                alert(`åˆ†æå¤±è´¥ï¼š${error.message}`);
                document.getElementById('loadingIndicator').classList.remove('active');
            }
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysisResult(disease, thinking, analysisData) {
            document.getElementById('loadingIndicator').classList.remove('active');
            
            const analysisResult = document.getElementById('analysisResult');
            const analysisContent = document.getElementById('analysisContent');
            
            // ä½¿ç”¨å®é™…çš„AIåˆ†æç»“æœ
            let resultHTML = '';
            
            if (analysisData.key_points && analysisData.key_points.length > 0) {
                resultHTML += `
                    <h4 style="color: #059669; margin-bottom: 10px;">ğŸ¯ å…³é”®è¯Šæ–­è¦ç‚¹æå–</h4>
                    <div style="background: #f0f9f0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <ul style="margin: 0; padding-left: 20px;">`;
                analysisData.key_points.forEach(point => {
                    resultHTML += `<li>${point}</li>`;
                });
                resultHTML += `</ul></div>`;
            }
            
            if (analysisData.missing_considerations && analysisData.missing_considerations.length > 0) {
                resultHTML += `
                    <h4 style="color: #d97706; margin-bottom: 10px;">âš ï¸ å¯èƒ½é—æ¼çš„è€ƒè™‘ç‚¹</h4>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <ul style="margin: 0; padding-left: 20px;">`;
                analysisData.missing_considerations.forEach(consideration => {
                    resultHTML += `<li>${consideration}</li>`;
                });
                resultHTML += `</ul></div>`;
            }
            
            if (analysisData.suggested_workflow) {
                resultHTML += `
                    <h4 style="color: #7c3aed; margin-bottom: 10px;">ğŸ”„ å»ºè®®çš„è¯Šç–—æµç¨‹</h4>
                    <div style="background: #f3e8ff; padding: 15px; border-radius: 8px;">
                        <p style="margin: 0;">${analysisData.suggested_workflow}</p>
                    </div>`;
            }
            
            // å¦‚æœæ²¡æœ‰åˆ†æç»“æœï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
            if (!resultHTML) {
                resultHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; color: #6b7280;">
                        <p>AIæ­£åœ¨åˆ†ææ‚¨çš„è¯Šç–—æ€ç»´ï¼Œè¯·ç¨å€™...</p>
                        <p>åˆ†æå®Œæˆåå°†æ˜¾ç¤ºè¯¦ç»†çš„è¯Šæ–­è¦ç‚¹å’Œå»ºè®®</p>
                    </div>`;
            }
            
            analysisContent.innerHTML = resultHTML;
            analysisResult.style.display = 'block';
            
            // è‡ªåŠ¨æ‰“å¼€ä¸‹ä¸€æ­¥
            setTimeout(() => {
                toggleStep(2);
            }, 1000);
        }
        
        // ç”Ÿæˆå¢å¼ºå†³ç­–æ ‘
        async function generateEnhancedTree() {
            if (selectedSchools.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä¸­åŒ»æµæ´¾');
                return;
            }
            
            const diseaseName = document.getElementById('diseaseName').value.trim();
            const thinkingProcess = document.getElementById('thinkingProcess').value.trim();
            
            if (!diseaseName || !thinkingProcess) {
                alert('è¯·å…ˆå®Œæˆç¬¬ä¸€æ­¥çš„è¯Šç–—æ€è·¯åˆ†æ');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('active');
            
            try {
                // è°ƒç”¨AIç”Ÿæˆå†³ç­–æ ‘æ¥å£
                const response = await fetch('/api/generate_decision_tree', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName,
                        thinking_process: thinkingProcess,
                        selected_schools: selectedSchools
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    currentDecisionTree = data.data;
                    displayDecisionTree(data.data);
                    toggleStep(3);
                } else {
                    throw new Error(data.message || 'ç”Ÿæˆå†³ç­–æ ‘å¤±è´¥');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆå†³ç­–æ ‘å¤±è´¥:', error);
                alert(`ç”Ÿæˆå†³ç­–æ ‘å¤±è´¥ï¼š${error.message}`);
                
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºå›é€€
                setTimeout(() => {
                    displayDecisionTree();
                    toggleStep(3);
                }, 500);
            }
        }
        
        // æ˜¾ç¤ºå†³ç­–æ ‘
        function displayDecisionTree(treeData) {
            document.getElementById('loadingIndicator').classList.remove('active');
            
            const treeVisualization = document.getElementById('treeVisualization');
            const treeContent = document.getElementById('treeContent');
            
            let treeHTML = '';
            
            // å¦‚æœæœ‰å®é™…çš„æ ‘çŠ¶æ•°æ®ï¼Œä½¿ç”¨å®ƒ
            if (treeData && treeData.tree) {
                treeHTML = generateTreeVisualization(treeData.tree);
                
                // æ˜¾ç¤ºæµæ´¾è¡¥å……å»ºè®®
                if (treeData.school_suggestions && treeData.school_suggestions.length > 0) {
                    treeHTML += `
                        <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                            <h4 style="color: #1e40af; margin-bottom: 15px;">ğŸ“Š æµæ´¾è¡¥å……å»ºè®®</h4>
                            <div style="display: grid; gap: 15px;">`;
                    
                    treeData.school_suggestions.forEach(suggestion => {
                        treeHTML += `
                            <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid ${getSchoolColor(suggestion.school)};">
                                <strong>${suggestion.school}è§†è§’ï¼š</strong> ${suggestion.advice}
                            </div>`;
                    });
                    
                    treeHTML += `</div></div>`;
                }
            } else {
                // ä½¿ç”¨é»˜è®¤çš„å†³ç­–æ ‘å¯è§†åŒ–ï¼ˆå¸¦åˆ†æ”¯æ¡ä»¶çš„ç¤ºä¾‹ï¼‰
                treeHTML = `
                    <div id="treeContainer" style="padding: 20px;">
                        <div class="tree-level" data-level="0">
                            <div class="tree-level-title">ä¸»è¦ç—‡çŠ¶è¯†åˆ«</div>
                            <div class="tree-nodes-container">
                                <div class="tree-node symptom" id="node_0_0" data-level="0" data-index="0" 
                                     title="å¤±çœ çš„ä¸»è¦è¡¨ç°" oncontextmenu="showContextMenu(event, 'node_0_0')">
                                    <div class="node-content">å¤±çœ ä¸»è¯</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tree-connection">
                            <div class="branch-line">
                                <div class="branch-condition">ç—‡çŠ¶è¡¨ç° â†’</div>
                            </div>
                        </div>
                        
                        <div class="tree-level" data-level="1">
                            <div class="tree-level-title">ç—‡çŠ¶ç»†åˆ†</div>
                            <div class="tree-nodes-container">
                                <div class="tree-node symptom" id="node_1_0" data-level="1" data-index="0"
                                     title="éš¾ä»¥å…¥ç¡ï¼Œèºæ‰°ä¸å®‰" oncontextmenu="showContextMenu(event, 'node_1_0')">
                                    <div class="node-content">å…¥ç¡å›°éš¾</div>
                                </div>
                                <div class="tree-node symptom" id="node_1_1" data-level="1" data-index="1"
                                     title="ç¡çœ æµ…ï¼Œæ˜“è¢«æƒŠé†’" oncontextmenu="showContextMenu(event, 'node_1_1')">
                                    <div class="node-content">å¤šæ¢¦æ˜“é†’</div>
                                </div>
                                <div class="tree-node symptom" id="node_1_2" data-level="1" data-index="2"
                                     title="å‡Œæ™¨æ—©é†’ï¼Œä¸èƒ½å†å¯" oncontextmenu="showContextMenu(event, 'node_1_2')">
                                    <div class="node-content">æ—©é†’ä¸å¯</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tree-connection">
                            <div class="branch-line">
                                <div class="branch-condition positive">èˆŒçº¢è‹”é»„ï¼Ÿ âœ“</div>
                            </div>
                            <div class="branch-line">
                                <div class="branch-condition negative">é¢è‰²èé»„ï¼Ÿ âœ“</div>
                            </div>
                            <div class="branch-line">
                                <div class="branch-condition positive">èƒ¸èƒèƒ€æ»¡ï¼Ÿ âœ“</div>
                            </div>
                        </div>
                        
                        <div class="tree-level" data-level="2">
                            <div class="tree-level-title">è¾¨è¯åˆ†å‹</div>
                            <div class="tree-nodes-container">
                                <div class="tree-node diagnosis" id="node_2_0" data-level="2" data-index="0"
                                     title="å¿ƒç«äº¢ç››ï¼Œæ‰°åŠ¨å¿ƒç¥" oncontextmenu="showContextMenu(event, 'node_2_0')">
                                    <div class="node-content">å¿ƒç«æ—ºç››</div>
                                </div>
                                <div class="tree-node diagnosis" id="node_2_1" data-level="2" data-index="1"
                                     title="å¿ƒè„¾æ°”è¡€ä¸¤è™š" oncontextmenu="showContextMenu(event, 'node_2_1')">
                                    <div class="node-content">å¿ƒè„¾ä¸¤è™š</div>
                                </div>
                                <div class="tree-node diagnosis" id="node_2_2" data-level="2" data-index="2"
                                     title="è‚æ°”éƒç»“åŒ–ç«" oncontextmenu="showContextMenu(event, 'node_2_2')">
                                    <div class="node-content">è‚éƒåŒ–ç«</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tree-connection">
                            <div class="branch-line">
                                <div class="branch-condition">æ¸…å¿ƒç« â†’</div>
                            </div>
                            <div class="branch-line">
                                <div class="branch-condition">è¡¥æ°”è¡€ â†’</div>
                            </div>
                            <div class="branch-line">
                                <div class="branch-condition">ç–è‚è§£éƒ â†’</div>
                            </div>
                        </div>
                        
                        <div class="tree-level" data-level="3">
                            <div class="tree-level-title">æ–¹è¯é€‰æ‹©</div>
                            <div class="tree-nodes-container">
                                <div class="tree-node formula" id="node_3_0" data-level="3" data-index="0"
                                     title="é»„è¿é˜¿èƒ¶æ±¤ï¼šæ»‹é˜´æ¸…çƒ­ï¼Œå…»å¿ƒå®‰ç¥" oncontextmenu="showContextMenu(event, 'node_3_0')">
                                    <div class="node-content">é»„è¿é˜¿èƒ¶æ±¤</div>
                                </div>
                                <div class="tree-node formula" id="node_3_1" data-level="3" data-index="1"
                                     title="å½’è„¾æ±¤ï¼šè¡¥ç›Šå¿ƒè„¾ï¼Œå…»è¡€å®‰ç¥" oncontextmenu="showContextMenu(event, 'node_3_1')">
                                    <div class="node-content">å½’è„¾æ±¤</div>
                                </div>
                                <div class="tree-node formula" id="node_3_2" data-level="3" data-index="2"
                                     title="é€é¥æ•£ï¼šç–è‚è§£éƒï¼Œå¥è„¾å’Œèƒƒ" oncontextmenu="showContextMenu(event, 'node_3_2')">
                                    <div class="node-content">é€é¥æ•£</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <h4 style="color: #1e40af; margin-bottom: 15px;">ğŸ“Š æµæ´¾è¡¥å……å»ºè®®</h4>
                        <div style="display: grid; gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #059669;">
                                <strong>å¼ ä»²æ™¯ç»æ–¹è§†è§’ï¼š</strong> å¯è€ƒè™‘ç”˜è‰å¹²å§œæ±¤æ²»ç–—é˜³è™šå¤±çœ ï¼Œé»„èŠ©æ±¤æ¸…çƒ­é™¤çƒ¦
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #d97706;">
                                <strong>æä¸œå£è„¾èƒƒè§†è§’ï¼š</strong> æ³¨æ„è„¾èƒƒè™šå¼±å¯¼è‡´çš„å¿ƒç¥å¤±å…»ï¼Œå¯ç”¨è¡¥ä¸­ç›Šæ°”æ±¤åŠ å‡
                            </div>
                        </div>
                    </div>
                `;
            }
            
            treeContent.innerHTML = treeHTML;
            treeVisualization.style.display = 'block';
        }
        
        // ç”Ÿæˆæ ‘çŠ¶ç»“æ„å¯è§†åŒ–
        function generateTreeVisualization(treeStructure) {
            if (!treeStructure || !treeStructure.levels || treeStructure.levels.length === 0) {
                return '<p>æš‚æ— å†³ç­–æ ‘æ•°æ®</p>';
            }
            
            let html = '<div style="padding: 20px;" id="treeContainer">';
            
            treeStructure.levels.forEach((level, levelIndex) => {
                // åˆ›å»ºå±‚çº§å®¹å™¨
                html += `<div class="tree-level" data-level="${levelIndex}">`;
                
                // æ·»åŠ å±‚çº§æ ‡é¢˜
                if (level.title) {
                    html += `<div class="tree-level-title">${level.title}</div>`;
                }
                
                // æ·»åŠ è¯¥å±‚çº§çš„èŠ‚ç‚¹å®¹å™¨
                html += '<div class="tree-nodes-container">';
                
                level.nodes.forEach((node, nodeIndex) => {
                    const nodeClass = getNodeClass(node.type || level.type);
                    const nodeId = `node_${levelIndex}_${nodeIndex}`;
                    html += `
                        <div class="tree-node ${nodeClass}" 
                             id="${nodeId}"
                             data-level="${levelIndex}" 
                             data-index="${nodeIndex}"
                             title="${node.description || ''}"
                             oncontextmenu="showContextMenu(event, '${nodeId}')">
                            <div class="node-content">${node.name}</div>
                            ${node.condition ? `<div class="node-condition">${node.condition}</div>` : ''}
                        </div>`;
                });
                
                html += '</div></div>';
                
                // æ·»åŠ åˆ†æ”¯è¿çº¿ï¼ˆé™¤äº†æœ€åä¸€å±‚ï¼‰
                if (levelIndex < treeStructure.levels.length - 1) {
                    html += generateBranchConnections(level, treeStructure.levels[levelIndex + 1], levelIndex);
                }
            });
            
            html += '</div>';
            
            // æ·»åŠ å³é”®èœå•å’Œæ¨¡æ€æ¡†
            html += generateContextMenu();
            html += generateAddBranchModal();
            
            return html;
        }
        
        // ç”Ÿæˆåˆ†æ”¯è¿çº¿
        function generateBranchConnections(currentLevel, nextLevel, levelIndex) {
            let html = '<div class="tree-connection">';
            
            // å¦‚æœæœ‰åˆ†æ”¯æ¡ä»¶å®šä¹‰ï¼Œä½¿ç”¨å…·ä½“çš„åˆ†æ”¯
            if (currentLevel.branches && currentLevel.branches.length > 0) {
                currentLevel.branches.forEach((branch, branchIndex) => {
                    html += `
                        <div class="branch-line" data-branch="${branchIndex}">
                            <div class="branch-condition ${branch.result === 'positive' ? 'positive' : 'negative'}">
                                ${branch.condition}
                                ${branch.result === 'positive' ? ' âœ“' : ' âœ—'}
                            </div>
                        </div>`;
                });
            } else {
                // é»˜è®¤è¿çº¿
                const nodeCount = Math.min(currentLevel.nodes.length, nextLevel.nodes.length);
                for (let i = 0; i < nodeCount; i++) {
                    html += `
                        <div class="branch-line" data-branch="${i}">
                            <div class="branch-condition">
                                ç¬¦åˆæ¡ä»¶ â†’ 
                            </div>
                        </div>`;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        // ç”Ÿæˆå³é”®èœå•
        function generateContextMenu() {
            return `
                <div class="context-menu" id="contextMenu">
                    <div class="context-menu-item" onclick="addChildBranch()">
                        â• æ·»åŠ å­åˆ†æ”¯
                    </div>
                    <div class="context-menu-item" onclick="addSiblingBranch()">
                        â†”ï¸ æ·»åŠ åŒçº§åˆ†æ”¯
                    </div>
                    <div class="context-menu-item" onclick="editNodeContent()">
                        âœï¸ ç¼–è¾‘èŠ‚ç‚¹
                    </div>
                    <div class="context-menu-item" onclick="setBranchCondition()">
                        ğŸ”— è®¾ç½®åˆ†æ”¯æ¡ä»¶
                    </div>
                    <div class="context-menu-item danger" onclick="deleteNode()">
                        ğŸ—‘ï¸ åˆ é™¤èŠ‚ç‚¹
                    </div>
                </div>`;
        }
        
        // ç”Ÿæˆæ·»åŠ åˆ†æ”¯æ¨¡æ€æ¡†
        function generateAddBranchModal() {
            return `
                <div class="add-branch-modal" id="addBranchModal" style="display: none;">
                    <div class="add-branch-form">
                        <h3 style="margin: 0 0 20px 0; color: #2d5aa0;">æ·»åŠ æ–°åˆ†æ”¯</h3>
                        
                        <div class="form-group">
                            <label class="form-label">èŠ‚ç‚¹åç§°</label>
                            <input type="text" class="form-input" id="newNodeName" placeholder="è¾“å…¥èŠ‚ç‚¹åç§°">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">èŠ‚ç‚¹ç±»å‹</label>
                            <select class="form-select" id="newNodeType">
                                <option value="symptom">ç—‡çŠ¶è¯†åˆ«</option>
                                <option value="diagnosis">è¾¨è¯åˆ†å‹</option>
                                <option value="treatment">æ²»ç–—æ–¹æ¡ˆ</option>
                                <option value="formula">æ–¹è¯é€‰æ‹©</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">åˆ†æ”¯æ¡ä»¶</label>
                            <input type="text" class="form-input" id="branchCondition" placeholder="ä¾‹å¦‚ï¼šèˆŒè‹”åšè…»ï¼Ÿ">
                            
                            <div class="condition-templates">
                                <div class="condition-template" onclick="setBranchTemplate('èˆŒè‹”åšè…»ï¼Ÿ')">
                                    èˆŒè‹”åšè…»ï¼Ÿ
                                </div>
                                <div class="condition-template" onclick="setBranchTemplate('è„‰è±¡æ»‘æ•°ï¼Ÿ')">
                                    è„‰è±¡æ»‘æ•°ï¼Ÿ
                                </div>
                                <div class="condition-template" onclick="setBranchTemplate('ç–¼ç—›å‰§çƒˆï¼Ÿ')">
                                    ç–¼ç—›å‰§çƒˆï¼Ÿ
                                </div>
                                <div class="condition-template" onclick="setBranchTemplate('è™šå®è¾¨è¯ï¼Ÿ')">
                                    è™šå®è¾¨è¯ï¼Ÿ
                                </div>
                                <div class="condition-template" onclick="setBranchTemplate('å¯’çƒ­æ€§è´¨ï¼Ÿ')">
                                    å¯’çƒ­æ€§è´¨ï¼Ÿ
                                </div>
                                <div class="condition-template" onclick="setBranchTemplate('ä½“è´¨å¼ºå¼±ï¼Ÿ')">
                                    ä½“è´¨å¼ºå¼±ï¼Ÿ
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">æ¡ä»¶ç»“æœ</label>
                            <select class="form-select" id="conditionResult">
                                <option value="positive">æ˜¯/æœ‰/æ­£å‘ âœ“</option>
                                <option value="negative">å¦/æ— /è´Ÿå‘ âœ—</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">è¯¦ç»†æè¿°</label>
                            <textarea class="form-input" id="nodeDescription" placeholder="è¯¦ç»†è¯´æ˜è¯¥èŠ‚ç‚¹çš„ç‰¹ç‚¹å’Œæ³¨æ„äº‹é¡¹" rows="3"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="confirmAddBranch()" style="flex: 1;">
                                âœ… ç¡®è®¤æ·»åŠ 
                            </button>
                            <button class="btn btn-secondary" onclick="closeAddBranchModal()" style="flex: 1;">
                                âŒ å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        
        // è·å–èŠ‚ç‚¹æ ·å¼ç±»
        function getNodeClass(type) {
            switch (type) {
                case 'symptom': return 'symptom';
                case 'diagnosis': return 'diagnosis';
                case 'treatment': return 'treatment';
                default: return 'diagnosis';
            }
        }
        
        // è·å–æµæ´¾é¢œè‰²
        function getSchoolColor(schoolName) {
            const colorMap = {
                'å¼ ä»²æ™¯': '#059669',
                'å¶å¤©å£«': '#3b82f6',
                'æä¸œå£': '#d97706',
                'æœ±ä¸¹æºª': '#7c3aed',
                'åˆ˜æ¸¡èˆŸ': '#dc2626',
                'éƒ‘é’¦å®‰': '#f59e0b'
            };
            
            for (const [school, color] of Object.entries(colorMap)) {
                if (schoolName.includes(school)) {
                    return color;
                }
            }
            return '#6b7280';
        }
        
        // å¯¼å‡ºå†³ç­–æ ‘
        function exportDecisionTree() {
            if (!currentDecisionTree) {
                alert('è¯·å…ˆç”Ÿæˆå†³ç­–æ ‘');
                return;
            }
            
            // åˆ›å»ºå¯¼å‡ºé€‰é¡¹å¯¹è¯æ¡†
            const exportModal = document.createElement('div');
            exportModal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 9999; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            exportModal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: #2d5aa0;">ğŸ“¥ å¯¼å‡ºå†³ç­–æ ‘</h3>
                    <div style="margin-bottom: 20px;">
                        <button onclick="exportAsJSON()" style="width: 100%; margin-bottom: 10px; padding: 12px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ“„ JSONæ ¼å¼ (æ•°æ®ç»“æ„)
                        </button>
                        <button onclick="exportAsImage()" style="width: 100%; margin-bottom: 10px; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ–¼ï¸ å›¾ç‰‡æ ¼å¼ (PNG)
                        </button>
                        <button onclick="exportAsPDF()" style="width: 100%; margin-bottom: 10px; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ“‘ PDFæ ¼å¼ (æŠ¥å‘Š)
                        </button>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            
            document.body.appendChild(exportModal);
        }
        
        // å¯¼å‡ºä¸ºJSON
        function exportAsJSON() {
            const data = {
                disease_name: document.getElementById('diseaseName').value,
                thinking_process: document.getElementById('thinkingProcess').value,
                selected_schools: selectedSchools,
                decision_tree: currentDecisionTree,
                export_time: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å†³ç­–æ ‘_${data.disease_name || 'æœªå‘½å'}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // å…³é—­å¯¹è¯æ¡†
            document.querySelector('[style*="rgba(0,0,0,0.5)"]').remove();
        }
        
        // å¯¼å‡ºä¸ºå›¾ç‰‡
        function exportAsImage() {
            // ä½¿ç”¨HTML2Canvasåº“å¯¼å‡ºå†³ç­–æ ‘å¯è§†åŒ–åŒºåŸŸ
            const element = document.getElementById('treeVisualization');
            if (typeof html2canvas !== 'undefined') {
                html2canvas(element).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `å†³ç­–æ ‘_${document.getElementById('diseaseName').value || 'æœªå‘½å'}_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            } else {
                alert('å›¾ç‰‡å¯¼å‡ºåŠŸèƒ½éœ€è¦åŠ è½½html2canvasåº“ï¼Œè¯·ç¨åå†è¯•æˆ–ä½¿ç”¨å…¶ä»–å¯¼å‡ºæ ¼å¼');
            }
            
            // å…³é—­å¯¹è¯æ¡†
            document.querySelector('[style*="rgba(0,0,0,0.5)"]').remove();
        }
        
        // å¯¼å‡ºä¸ºPDF
        function exportAsPDF() {
            alert('PDFå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...\n\nå°†æ”¯æŒï¼š\nâ€¢ å®Œæ•´çš„å†³ç­–æ ‘ç»“æ„\nâ€¢ æµæ´¾åˆ†æå»ºè®®\nâ€¢ åŒ»ç”Ÿæ€ç»´è¿‡ç¨‹è®°å½•\nâ€¢ ä¸“ä¸šæ ¼å¼æ’ç‰ˆ');
            
            // å…³é—­å¯¹è¯æ¡†
            document.querySelector('[style*="rgba(0,0,0,0.5)"]').remove();
        }
        
        // ä¿å­˜åˆ°çŸ¥è¯†åº“
        async function saveToLibrary() {
            if (!currentDecisionTree) {
                alert('è¯·å…ˆç”Ÿæˆå†³ç­–æ ‘');
                return;
            }
            
            const diseaseName = document.getElementById('diseaseName').value.trim();
            const thinkingProcess = document.getElementById('thinkingProcess').value.trim();
            
            if (!diseaseName || !thinkingProcess) {
                alert('ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼Œæ— æ³•ä¿å­˜');
                return;
            }
            
            try {
                const response = await fetch('/api/save_decision_tree', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName,
                        thinking_process: thinkingProcess,
                        selected_schools: selectedSchools,
                        decision_tree: currentDecisionTree,
                        is_template: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    alert('âœ… å†³ç­–æ ‘å·²æˆåŠŸä¿å­˜åˆ°çŸ¥è¯†åº“ï¼\n\nå…¶ä»–åŒ»ç”Ÿå¯ä»¥å‚è€ƒæ‚¨çš„è¯Šç–—æ€è·¯ã€‚');
                } else {
                    throw new Error(data.message || 'ä¿å­˜å¤±è´¥');
                }
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert(`ä¿å­˜å¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚`);
            }
        }
        
        // å³é”®èœå•ç›¸å…³å‡½æ•°
        function showContextMenu(event, nodeId) {
            event.preventDefault();
            selectedNodeId = nodeId;
            
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            selectedNodeId = null;
        }
        
        // æ·»åŠ å­åˆ†æ”¯
        function addChildBranch() {
            hideContextMenu();
            showAddBranchModal('child');
        }
        
        // æ·»åŠ åŒçº§åˆ†æ”¯
        function addSiblingBranch() {
            hideContextMenu();
            showAddBranchModal('sibling');
        }
        
        // ç¼–è¾‘èŠ‚ç‚¹å†…å®¹
        function editNodeContent() {
            hideContextMenu();
            const node = document.getElementById(selectedNodeId);
            const currentName = node.querySelector('.node-content').textContent;
            
            // å¡«å……å½“å‰å†…å®¹åˆ°æ¨¡æ€æ¡†
            document.getElementById('newNodeName').value = currentName;
            showAddBranchModal('edit');
        }
        
        // è®¾ç½®åˆ†æ”¯æ¡ä»¶
        function setBranchCondition() {
            hideContextMenu();
            const condition = prompt('è¯·è¾“å…¥åˆ†æ”¯åˆ¤æ–­æ¡ä»¶ï¼š', 'èˆŒè‹”åšè…»ï¼Ÿ');
            if (condition) {
                // æ›´æ–°è¿çº¿æ ‡ç­¾
                updateBranchCondition(selectedNodeId, condition);
            }
        }
        
        // åˆ é™¤èŠ‚ç‚¹
        function deleteNode() {
            hideContextMenu();
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹å—ï¼Ÿ')) {
                document.getElementById(selectedNodeId).remove();
                // è¿™é‡Œåº”è¯¥æ›´æ–°currentDecisionTreeæ•°æ®
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ åˆ†æ”¯æ¨¡æ€æ¡†
        function showAddBranchModal(mode) {
            editingNode = { mode, nodeId: selectedNodeId };
            document.getElementById('addBranchModal').style.display = 'flex';
            
            // æ ¹æ®æ¨¡å¼è®¾ç½®è¡¨å•æ ‡é¢˜
            const titles = {
                'child': 'æ·»åŠ å­åˆ†æ”¯',
                'sibling': 'æ·»åŠ åŒçº§åˆ†æ”¯', 
                'edit': 'ç¼–è¾‘èŠ‚ç‚¹'
            };
            
            document.querySelector('.add-branch-form h3').textContent = titles[mode] || 'æ·»åŠ æ–°åˆ†æ”¯';
        }
        
        // å…³é—­æ·»åŠ åˆ†æ”¯æ¨¡æ€æ¡†
        function closeAddBranchModal() {
            document.getElementById('addBranchModal').style.display = 'none';
            editingNode = null;
            // æ¸…ç©ºè¡¨å•
            document.getElementById('newNodeName').value = '';
            document.getElementById('branchCondition').value = '';
            document.getElementById('nodeDescription').value = '';
        }
        
        // è®¾ç½®åˆ†æ”¯æ¡ä»¶æ¨¡æ¿
        function setBranchTemplate(template) {
            document.getElementById('branchCondition').value = template;
        }
        
        // ç¡®è®¤æ·»åŠ åˆ†æ”¯
        function confirmAddBranch() {
            const nodeName = document.getElementById('newNodeName').value.trim();
            const nodeType = document.getElementById('newNodeType').value;
            const branchCondition = document.getElementById('branchCondition').value.trim();
            const conditionResult = document.getElementById('conditionResult').value;
            const nodeDescription = document.getElementById('nodeDescription').value.trim();
            
            if (!nodeName) {
                alert('è¯·è¾“å…¥èŠ‚ç‚¹åç§°');
                return;
            }
            
            if (editingNode.mode === 'edit') {
                // ç¼–è¾‘ç°æœ‰èŠ‚ç‚¹
                const existingNode = document.getElementById(editingNode.nodeId);
                existingNode.querySelector('.node-content').textContent = nodeName;
                existingNode.title = nodeDescription;
                existingNode.className = `tree-node ${nodeType}`;
            } else {
                // æ·»åŠ æ–°èŠ‚ç‚¹
                addNewNodeToTree(nodeName, nodeType, branchCondition, conditionResult, nodeDescription, editingNode.mode);
            }
            
            closeAddBranchModal();
        }
        
        // æ·»åŠ æ–°èŠ‚ç‚¹åˆ°æ ‘ä¸­
        function addNewNodeToTree(nodeName, nodeType, branchCondition, conditionResult, nodeDescription, mode) {
            const selectedNode = document.getElementById(selectedNodeId);
            const currentLevel = parseInt(selectedNode.dataset.level);
            
            let targetLevel;
            if (mode === 'child') {
                targetLevel = currentLevel + 1;
            } else {
                targetLevel = currentLevel;
            }
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºç›®æ ‡å±‚çº§
            let targetLevelElement = document.querySelector(`[data-level="${targetLevel}"]`);
            
            if (!targetLevelElement && mode === 'child') {
                // åˆ›å»ºæ–°å±‚çº§
                const newLevelHTML = `
                    <div class="tree-level" data-level="${targetLevel}">
                        <div class="tree-level-title">æ–°å¢å±‚çº§</div>
                        <div class="tree-nodes-container">
                            <div class="tree-node ${nodeType}" 
                                 id="node_${targetLevel}_0"
                                 data-level="${targetLevel}" 
                                 data-index="0"
                                 title="${nodeDescription}"
                                 oncontextmenu="showContextMenu(event, 'node_${targetLevel}_0')">
                                <div class="node-content">${nodeName}</div>
                            </div>
                        </div>
                    </div>`;
                
                // æ·»åŠ åˆ†æ”¯è¿çº¿
                const connectionHTML = `
                    <div class="tree-connection">
                        <div class="branch-line">
                            <div class="branch-condition ${conditionResult === 'positive' ? 'positive' : 'negative'}">
                                ${branchCondition}
                                ${conditionResult === 'positive' ? ' âœ“' : ' âœ—'}
                            </div>
                        </div>
                    </div>`;
                
                selectedNode.closest('.tree-level').insertAdjacentHTML('afterend', connectionHTML + newLevelHTML);
            } else if (targetLevelElement) {
                // æ·»åŠ åˆ°ç°æœ‰å±‚çº§
                const nodesContainer = targetLevelElement.querySelector('.tree-nodes-container');
                const nodeCount = nodesContainer.children.length;
                
                const newNodeHTML = `
                    <div class="tree-node ${nodeType}" 
                         id="node_${targetLevel}_${nodeCount}"
                         data-level="${targetLevel}" 
                         data-index="${nodeCount}"
                         title="${nodeDescription}"
                         oncontextmenu="showContextMenu(event, 'node_${targetLevel}_${nodeCount}')">
                        <div class="node-content">${nodeName}</div>
                    </div>`;
                
                nodesContainer.insertAdjacentHTML('beforeend', newNodeHTML);
            }
        }
        
        // æ›´æ–°åˆ†æ”¯æ¡ä»¶
        function updateBranchCondition(nodeId, condition) {
            // æŸ¥æ‰¾ä¸è¯¥èŠ‚ç‚¹ç›¸å…³çš„åˆ†æ”¯æ¡ä»¶æ ‡ç­¾å¹¶æ›´æ–°
            const node = document.getElementById(nodeId);
            const nextConnection = node.closest('.tree-level').nextElementSibling;
            
            if (nextConnection && nextConnection.classList.contains('tree-connection')) {
                const branchCondition = nextConnection.querySelector('.branch-condition');
                if (branchCondition) {
                    branchCondition.innerHTML = `${condition} âœ“`;
                }
            }
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é»˜è®¤æ‰“å¼€ç¬¬ä¸€æ­¥
            toggleStep(1);
            
            // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶éšè—å³é”®èœå•
            document.addEventListener('click', hideContextMenu);
            
            console.log('æ™ºèƒ½å†³ç­–æ ‘ç”Ÿæˆå™¨åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>