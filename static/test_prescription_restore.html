<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤„æ–¹çŠ¶æ€æ¢å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { margin: 5px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>å¤„æ–¹çŠ¶æ€æ¢å¤æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•ç”¨æˆ·ä¿¡æ¯</h2>
        <div id="userInfo" class="info">
            <strong>æµ‹è¯•ç”¨æˆ·ID:</strong> usr_20250920_5741e17a78e8<br>
            <strong>æµ‹è¯•ç”¨æˆ·å:</strong> maoxiaohua<br>
            <strong>é¢„æœŸå¤„æ–¹æ•°é‡:</strong> 2ä¸ª (ID: 120, 121)<br>
            <strong>é¢„æœŸçŠ¶æ€:</strong> pending_review (å·²æ”¯ä»˜ï¼Œç­‰å¾…å®¡æ ¸)
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ§ª æµ‹è¯•æ“ä½œ</h2>
        <button onclick="testAPIConnection()">1. æµ‹è¯•APIè¿æ¥</button>
        <button onclick="fetchPrescriptions()">2. è·å–ç”¨æˆ·å¤„æ–¹</button>
        <button onclick="testRestoreFunction()">3. æµ‹è¯•æ¢å¤å‡½æ•°</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
        <div id="log"></div>
    </div>

    <script>
        const TEST_USER_ID = 'usr_20250920_5741e17a78e8';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            logDiv.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function addResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }
        
        async function testAPIConnection() {
            log('ğŸ”— æµ‹è¯•APIè¿æ¥...', 'info');
            try {
                const response = await fetch('/api/prescription/statistics/status');
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… APIè¿æ¥æˆåŠŸ', 'success');
                    addResult('âœ… APIè¿æ¥æµ‹è¯•é€šè¿‡', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`âŒ APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                addResult(`âŒ APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function fetchPrescriptions() {
            log(`ğŸ“‹ è·å–ç”¨æˆ· ${TEST_USER_ID} çš„å¤„æ–¹åˆ—è¡¨...`, 'info');
            try {
                const response = await fetch(`/api/prescription/patient/${TEST_USER_ID}/prescriptions`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                log(`ğŸ“Š APIå“åº”: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success && data.prescriptions) {
                    const prescriptions = data.prescriptions;
                    log(`âœ… æˆåŠŸè·å– ${prescriptions.length} ä¸ªå¤„æ–¹`, 'success');
                    
                    let resultMessage = `âœ… æˆåŠŸè·å– ${prescriptions.length} ä¸ªå¤„æ–¹ï¼š<br>`;
                    prescriptions.forEach(p => {
                        resultMessage += `&nbsp;&nbsp;â€¢ å¤„æ–¹ID: ${p.id}, çŠ¶æ€: ${p.status}, æ”¯ä»˜: ${p.payment_status}<br>`;
                        log(`ğŸ“ å¤„æ–¹ ${p.id}: status=${p.status}, payment=${p.payment_status}`, 'info');
                    });
                    
                    addResult(resultMessage, 'success');
                    
                    // éªŒè¯é¢„æœŸæ•°æ®
                    const pendingReviewPrescriptions = prescriptions.filter(p => 
                        p.status === 'pending_review' && p.payment_status === 'paid'
                    );
                    
                    if (pendingReviewPrescriptions.length > 0) {
                        log(`ğŸ¯ å‘ç° ${pendingReviewPrescriptions.length} ä¸ªéœ€è¦æ¢å¤çš„å¤„æ–¹`, 'success');
                        addResult(`ğŸ¯ å‘ç° ${pendingReviewPrescriptions.length} ä¸ªå¾…æ¢å¤å¤„æ–¹ (ç­‰å¾…å®¡æ ¸çŠ¶æ€)`, 'info');
                        return prescriptions;
                    } else {
                        log('âš ï¸ æ²¡æœ‰å‘ç°éœ€è¦æ¢å¤çš„å¤„æ–¹ (pending_review + paid)', 'error');
                        addResult('âš ï¸ æ²¡æœ‰å‘ç°éœ€è¦æ¢å¤çš„å¤„æ–¹', 'error');
                    }
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼ä¸æ­£ç¡®');
                }
            } catch (error) {
                log(`âŒ è·å–å¤„æ–¹å¤±è´¥: ${error.message}`, 'error');
                addResult(`âŒ è·å–å¤„æ–¹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testRestoreFunction() {
            log('ğŸ”„ æµ‹è¯•å¤„æ–¹çŠ¶æ€æ¢å¤å‡½æ•°...', 'info');
            
            // æ¨¡æ‹Ÿæ¢å¤å‡½æ•°é€»è¾‘
            try {
                const response = await fetch(`/api/prescription/patient/${TEST_USER_ID}/prescriptions`);
                const result = await response.json();
                
                if (result.success && result.prescriptions && result.prescriptions.length > 0) {
                    const prescriptions = result.prescriptions;
                    let restoredCount = 0;
                    
                    log('ğŸ” å¼€å§‹å¤„ç†å¤„æ–¹æ¢å¤...', 'info');
                    
                    for (const prescription of prescriptions) {
                        const prescriptionId = prescription.id;
                        const status = prescription.status;
                        const paymentStatus = prescription.payment_status;
                        
                        log(`ğŸ“‹ å¤„ç†å¤„æ–¹ID ${prescriptionId}: status=${status}, payment=${paymentStatus}`, 'info');
                        
                        if (paymentStatus === 'paid' && status === 'pending_review') {
                            log(`â³ å¤„æ–¹ ${prescriptionId} ç¬¦åˆæ¢å¤æ¡ä»¶ (å·²æ”¯ä»˜ + ç­‰å¾…å®¡æ ¸)`, 'success');
                            restoredCount++;
                        } else if (status === 'doctor_approved' || status === 'doctor_modified') {
                            log(`âœ… å¤„æ–¹ ${prescriptionId} å·²å®¡æ ¸å®Œæˆ`, 'success');
                            restoredCount++;
                        } else {
                            log(`â„¹ï¸ å¤„æ–¹ ${prescriptionId} ä¸éœ€è¦æ¢å¤ (çŠ¶æ€: ${status})`, 'info');
                        }
                    }
                    
                    if (restoredCount > 0) {
                        log(`ğŸ‰ æ¢å¤å‡½æ•°æµ‹è¯•æˆåŠŸï¼åº”è¯¥æ¢å¤ ${restoredCount} ä¸ªå¤„æ–¹çŠ¶æ€`, 'success');
                        addResult(`ğŸ‰ æ¢å¤å‡½æ•°æµ‹è¯•æˆåŠŸï¼åº”è¯¥æ¢å¤ ${restoredCount} ä¸ªå¤„æ–¹çŠ¶æ€`, 'success');
                        
                        // æä¾›å®é™…é¡µé¢æµ‹è¯•é“¾æ¥
                        addResult(`
                            <strong>ğŸ“± å®é™…æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
                            1. åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€: <a href="/smart" target="_blank">/smart</a><br>
                            2. ä½¿ç”¨ç”¨æˆ·å <code>maoxiaohua</code> ç™»å½•<br>
                            3. é¡µé¢åŠ è½½å®Œæˆåï¼Œåº”è¯¥è‡ªåŠ¨æ˜¾ç¤º ${restoredCount} ä¸ª"ç­‰å¾…åŒ»ç”Ÿå®¡æ ¸"çš„å¤„æ–¹<br>
                            4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ¢å¤æ—¥å¿—
                        `, 'info');
                    } else {
                        log('âŒ æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¢å¤çš„å¤„æ–¹', 'error');
                        addResult('âŒ æ¢å¤å‡½æ•°æµ‹è¯•å¤±è´¥ï¼šæ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¢å¤çš„å¤„æ–¹', 'error');
                    }
                } else {
                    throw new Error('æ— æ³•è·å–å¤„æ–¹æ•°æ®è¿›è¡Œæµ‹è¯•');
                }
            } catch (error) {
                log(`âŒ æ¢å¤å‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult(`âŒ æ¢å¤å‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', async () => {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...', 'info');
            await testAPIConnection();
            await fetchPrescriptions();
        });
    </script>
</body>
</html>