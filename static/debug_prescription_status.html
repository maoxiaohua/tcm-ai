<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤„æ–¹æ”¯ä»˜çŠ¶æ€è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .tool-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .tool-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 10px 5px 0;
            font-size: 14px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .emergency-btn {
            background: #e74c3c !important;
        }
        
        .emergency-btn:hover {
            background: #c0392b !important;
        }
        
        .output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        
        .status-indicator {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        
        .status-success {
            background: #2ecc71;
            color: white;
        }
        
        .status-warning {
            background: #f39c12;
            color: white;
        }
        
        .status-error {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¤„æ–¹æ”¯ä»˜çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
        <p style="text-align: center; color: #7f8c8d;">
            ä¸“ç”¨äºè°ƒè¯•å¤„æ–¹æ”¯ä»˜çŠ¶æ€æŒä¹…åŒ–é—®é¢˜ï¼Œè¯·åœ¨å‡ºç°æ”¯ä»˜åä»æ˜¾ç¤ºé”å®šçš„æƒ…å†µä¸‹ä½¿ç”¨
        </p>
        
        <!-- åŸºç¡€æ£€æŸ¥å·¥å…· -->
        <div class="tool-section">
            <h3>ğŸ“‹ åŸºç¡€çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkBasicStatus()">æ£€æŸ¥localStorageæ”¯ä»˜è®°å½•</button>
            <button onclick="runFullCheck()">è¿è¡Œå®Œæ•´çŠ¶æ€æ£€æŸ¥</button>
            <div id="basic-output" class="output" style="display: none;"></div>
        </div>
        
        <!-- é«˜çº§è°ƒè¯•å·¥å…· -->
        <div class="tool-section">
            <h3>ğŸ” é«˜çº§è°ƒè¯•åˆ†æ</h3>
            <button onclick="runDebugMatching()">è¯¦ç»†åŒ¹é…åˆ†æ</button>
            <button onclick="showPrescriptionInfo()">æ˜¾ç¤ºæ‰€æœ‰å¤„æ–¹ä¿¡æ¯</button>
            <div id="debug-output" class="output" style="display: none;"></div>
        </div>
        
        <!-- åº”æ€¥ä¿®å¤å·¥å…· -->
        <div class="tool-section">
            <h3>ğŸš¨ åº”æ€¥ä¿®å¤å·¥å…·</h3>
            <div class="input-group">
                <label>å¼ºåˆ¶è§£é”æŒ‡å®šå¤„æ–¹ï¼ˆè¾“å…¥å¤„æ–¹åºå·ï¼‰ï¼š</label>
                <input type="number" id="prescriptionIndex" min="1" placeholder="å¦‚: 1">
                <button class="emergency-btn" onclick="forceUnlock()">å¼ºåˆ¶è§£é”</button>
            </div>
            <button class="emergency-btn" onclick="clearAllPayments()">æ¸…é™¤æ‰€æœ‰æ”¯ä»˜è®°å½•</button>
            <button onclick="refreshPage()">åˆ·æ–°é¡µé¢</button>
            <div id="emergency-output" class="output" style="display: none;"></div>
        </div>
        
        <!-- æµ‹è¯•é“¾æ¥ -->
        <div class="tool-section">
            <h3>ğŸ”— å¿«é€Ÿå¯¼èˆª</h3>
            <button onclick="window.open('/smart', '_blank')">æ‰“å¼€æ™ºèƒ½é—®è¯Šé¡µé¢</button>
            <button onclick="window.open('/static/index_smart_workflow.html', '_blank')">æ‰“å¼€é—®è¯Šé¡µé¢ï¼ˆç›´æ¥ï¼‰</button>
            <p style="color: #7f8c8d; font-size: 14px; margin-top: 10px;">
                å»ºè®®ï¼šå…ˆåœ¨é—®è¯Šé¡µé¢å®Œæˆæ”¯ä»˜ï¼Œç„¶åè¿”å›æ­¤é¡µé¢è¿›è¡Œè°ƒè¯•
            </p>
        </div>
    </div>

    <script src="/static/js/prescription_payment_manager.js?v=20250925-002"></script>
    
    <script>
        function showOutput(elementId, content) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = content;
        }
        
        function appendOutput(elementId, content) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent += content + '\n';
        }
        
        function checkBasicStatus() {
            const output = [];
            output.push('ğŸ“‹ localStorageæ”¯ä»˜è®°å½•æ£€æŸ¥:');
            output.push('=' + '='.repeat(40));
            
            let recordCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('prescription_paid_')) {
                    const value = localStorage.getItem(key);
                    const prescriptionId = key.replace('prescription_paid_', '');
                    output.push(`âœ… ${prescriptionId}: ${value}`);
                    recordCount++;
                }
            }
            
            if (recordCount === 0) {
                output.push('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ”¯ä»˜è®°å½•');
            } else {
                output.push('');
                output.push(`æ€»è®¡: ${recordCount} ä¸ªæ”¯ä»˜è®°å½•`);
            }
            
            showOutput('basic-output', output.join('\n'));
        }
        
        function runFullCheck() {
            if (typeof window.checkAllPrescriptionStatus === 'function') {
                console.log('ğŸ” è¿è¡Œå®Œæ•´çŠ¶æ€æ£€æŸ¥...');
                
                // æ•è·æ§åˆ¶å°è¾“å‡º
                const originalLog = console.log;
                const logs = [];
                console.log = function(...args) {
                    logs.push(args.join(' '));
                    originalLog.apply(console, arguments);
                };
                
                window.checkAllPrescriptionStatus();
                
                // æ¢å¤æ§åˆ¶å°
                console.log = originalLog;
                
                showOutput('basic-output', 'å®Œæ•´æ£€æŸ¥å·²æ‰§è¡Œï¼ŒæŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯\n\næ§åˆ¶å°è¾“å‡ºé¢„è§ˆ:\n' + logs.slice(-20).join('\n'));
            } else {
                showOutput('basic-output', 'âŒ æ£€æŸ¥å‡½æ•°æœªåŠ è½½ï¼Œè¯·ç¡®ä¿é¡µé¢ä¸­åŒ…å«prescription_payment_manager.js');
            }
        }
        
        function runDebugMatching() {
            if (typeof window.debugPrescriptionMatching === 'function') {
                console.log('ğŸ” è¿è¡Œè¯¦ç»†è°ƒè¯•åˆ†æ...');
                
                const originalLog = console.log;
                const logs = [];
                console.log = function(...args) {
                    logs.push(args.join(' '));
                    originalLog.apply(console, arguments);
                };
                
                const result = window.debugPrescriptionMatching();
                
                console.log = originalLog;
                
                let output = 'è¯¦ç»†è°ƒè¯•åˆ†æå·²æ‰§è¡Œ\n\n';
                if (result) {
                    output += `ç»“æœæ‘˜è¦:\n`;
                    output += `- å¤„æ–¹æ•°é‡: ${result.prescriptions}\n`;
                    output += `- æ”¯ä»˜è®°å½•: ${result.paidRecords}\n`;
                    output += `- è‡ªåŠ¨ä¿®å¤: ${result.fixedCount}\n\n`;
                }
                output += 'è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æ§åˆ¶å°\n\n';
                output += 'æ§åˆ¶å°è¾“å‡ºé¢„è§ˆ:\n' + logs.slice(-30).join('\n');
                
                showOutput('debug-output', output);
            } else {
                showOutput('debug-output', 'âŒ è°ƒè¯•å‡½æ•°æœªåŠ è½½');
            }
        }
        
        function showPrescriptionInfo() {
            const output = [];
            output.push('ğŸ“‹ é¡µé¢å¤„æ–¹ä¿¡æ¯åˆ†æ:');
            output.push('=' + '='.repeat(40));
            
            const aiMessages = document.querySelectorAll('.message.ai');
            let prescriptionCount = 0;
            
            aiMessages.forEach((messageEl, index) => {
                const messageText = messageEl.querySelector('.message-text');
                if (messageText && (messageText.innerHTML.includes('å¤„æ–¹é¢„è§ˆ') || messageText.innerHTML.includes('ğŸ”“ è§£é”å®Œæ•´å¤„æ–¹'))) {
                    prescriptionCount++;
                    const prescriptionId = messageEl.getAttribute('data-prescription-id');
                    const hasOriginalContent = !!messageText.getAttribute('data-original-content');
                    const isLocked = messageText.innerHTML.includes('ğŸ”“ è§£é”å®Œæ•´å¤„æ–¹');
                    
                    output.push(`å¤„æ–¹ #${prescriptionCount}:`);
                    output.push(`  - ID: ${prescriptionId || 'æ— '}`);
                    output.push(`  - çŠ¶æ€: ${isLocked ? 'ğŸ”’ é”å®š' : 'ğŸ”“ å·²è§£é”'}`);
                    output.push(`  - åŸå§‹å†…å®¹: ${hasOriginalContent ? 'æœ‰' : 'æ— '}`);
                    output.push('');
                }
            });
            
            if (prescriptionCount === 0) {
                output.push('âŒ é¡µé¢ä¸­æ²¡æœ‰å‘ç°å¤„æ–¹å†…å®¹');
                output.push('è¯·å…ˆåˆ°é—®è¯Šé¡µé¢ç”Ÿæˆå¤„æ–¹ï¼Œç„¶åå†è¿›è¡Œè°ƒè¯•');
            } else {
                output.push(`æ€»è®¡å‘ç° ${prescriptionCount} ä¸ªå¤„æ–¹`);
            }
            
            showOutput('debug-output', output.join('\n'));
        }
        
        function forceUnlock() {
            const index = parseInt(document.getElementById('prescriptionIndex').value);
            
            if (!index || index < 1) {
                showOutput('emergency-output', 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å¤„æ–¹åºå·ï¼ˆä»1å¼€å§‹ï¼‰');
                return;
            }
            
            if (typeof window.forceUnlockPrescription === 'function') {
                const success = window.forceUnlockPrescription(index);
                if (success) {
                    showOutput('emergency-output', `âœ… å·²å¼ºåˆ¶è§£é”å¤„æ–¹ #${index}\n\nè¯·åˆ·æ–°é—®è¯Šé¡µé¢æŸ¥çœ‹æ•ˆæœ`);
                } else {
                    showOutput('emergency-output', `âŒ å¼ºåˆ¶è§£é”å¤±è´¥ï¼Œå¤„æ–¹åºå· ${index} å¯èƒ½ä¸å­˜åœ¨`);
                }
            } else {
                showOutput('emergency-output', 'âŒ å¼ºåˆ¶è§£é”å‡½æ•°æœªåŠ è½½');
            }
        }
        
        function clearAllPayments() {
            if (confirm('âš ï¸  ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ”¯ä»˜è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                let clearedCount = 0;
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('prescription_paid_')) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    clearedCount++;
                });
                
                showOutput('emergency-output', `âœ… å·²æ¸…é™¤ ${clearedCount} ä¸ªæ”¯ä»˜è®°å½•\n\næ‰€æœ‰å¤„æ–¹å°†é‡æ–°æ˜¾ç¤ºä¸ºé”å®šçŠ¶æ€`);
            }
        }
        
        function refreshPage() {
            window.location.reload();
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥åŸºç¡€çŠ¶æ€
        window.addEventListener('load', function() {
            setTimeout(checkBasicStatus, 1000);
        });
    </script>
</body>
</html>