<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØä - ‰∏ì‰∏öÁâà</title>
    
    <!-- Open Graph / ÂæÆ‰ø°ÂàÜ‰∫´‰ºòÂåñ -->
    <meta property="og:title" content="üè• AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã - ‰∏ì‰∏öÁâà">
    <meta property="og:description" content="Âü∫‰∫éAIÁöÑ‰∏≠ÂåªÊô∫ËÉΩËØäÊñ≠Á≥ªÁªüÔºåÊîØÊåÅÁóáÁä∂ÈóÆËØä„ÄÅËØÅÂÄôÂàÜÊûê„ÄÅÊñπÂâÇÊé®Ëçê„ÄÇÈõÜÊàê5Â§ß‰∏≠ÂåªÊµÅÊ¥æÔºåÊèê‰æõ‰∏™ÊÄßÂåñ‰∏≠ÂåªÊ≤ªÁñóÂª∫ËÆÆ„ÄÇÈÄÇÁî®‰∫é‰∏¥Â∫äËæÖÂä©ËØäÊñ≠„ÄÇ">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="AI‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã - ‰∏ì‰∏öÂåªÁñóËØäÊñ≠Â∑•ÂÖ∑">
    <meta property="og:url" content="https://mxh0510.cn/">
    <meta property="og:site_name" content="TCM AI ‰∏≠ÂåªÊô∫ËÉΩËØäÊñ≠Á≥ªÁªü">
    
    <!-- ÂæÆ‰ø°ÂàÜ‰∫´‰∏ìÁî®Ê†áÁ≠æ -->
    <meta name="description" content="AI‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©ÊâãÔºå‰∏ì‰∏öÁöÑ‰∏≠ÂåªËØäÊñ≠ËæÖÂä©Â∑•ÂÖ∑ÔºåÊîØÊåÅÁóáÁä∂ÂàÜÊûê„ÄÅËØÅÂÄôÂà§Êñ≠„ÄÅÊñπÂâÇÊé®Ëçê">
    <meta name="keywords" content="‰∏≠Âåª,AIËØäÊñ≠,Êô∫ËÉΩÈóÆËØä,‰∏≠ËçØÊñπÂâÇ,ËØÅÂÄôÂàÜÊûê,‰º†Áªü‰∏≠Âåª,‰∫∫Â∑•Êô∫ËÉΩ">
    <meta name="author" content="TCM AI Team">
    
    <!-- ÂæÆ‰ø°Â∞èÁ®ãÂ∫èÂàÜ‰∫´Âç°Áâá‰ºòÂåñ -->
    <meta property="wx:card" content="summary_large_image">
    <meta property="wx:title" content="üè• AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã">
    <meta property="wx:description" content="‰∏ì‰∏öAI‰∏≠ÂåªËØäÊñ≠ËæÖÂä©Â∑•ÂÖ∑ÔºåÈõÜÊàê5Â§ßÊµÅÊ¥æÔºåÊèê‰æõ‰∏™ÊÄßÂåñÊ≤ªÁñóÂª∫ËÆÆ">
    <meta property="wx:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- ÂæÆ‰ø°ÂÆâÂÖ®È™åËØÅ -->
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <!-- ÂæÆ‰ø°È™åËØÅÊñá‰ª∂Ê†áËØÜ -->
    <meta name="wechat-enable" content="true">
    <meta name="applicable-device" content="mobile">
    
    <!-- Twitter Card Ê†áÁ≠æ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="üè• AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã">
    <meta name="twitter:description" content="Âü∫‰∫éAIÁöÑ‰∏≠ÂåªÊô∫ËÉΩËØäÊñ≠Á≥ªÁªüÔºå‰∏ì‰∏öÂåªÁñóËæÖÂä©Â∑•ÂÖ∑">
    <meta name="twitter:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- ÁâàÊú¨Ê†áËØÜ: v1.2.4 Êõ¥Êñ∞Êó∂Èó¥: 2025-08-03 20:20 ÂàÜ‰∫´‰ºòÂåñÁâà -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            background: #f5f7fa;
            overflow: hidden;
        }

        /* ‰∏ªÂ∏ÉÂ±ÄÂÆπÂô® */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .history-btn, .new-chat-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .history-btn:hover, .new-chat-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .history-btn {
            background: rgba(255,255,255,0.15);
        }

        /* È°µÈù¢ÂØºËà™‰∏ãÊãâËèúÂçï */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-dropdown-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: white;
            min-width: 250px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-radius: 12px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .nav-dropdown-content.show {
            display: block;
        }

        .nav-dropdown-header {
            background: #f8f9fa;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .nav-dropdown-section {
            padding: 8px 0;
        }

        .nav-dropdown-section:not(:last-child) {
            border-bottom: 1px solid #f3f4f6;
        }

        .nav-dropdown-item {
            display: block;
            padding: 10px 16px;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-dropdown-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .nav-dropdown-item.primary {
            color: #3b82f6;
            font-weight: 500;
        }

        .nav-dropdown-item.secondary {
            color: #6b7280;
        }

        /* ÁßªÂä®Á´ØÂØºËà™ */
        @media (max-width: 768px) {
            .nav-dropdown {
                display: none; /* ÁßªÂä®Á´ØÈöêËóè‰∏ãÊãâËèúÂçï */
            }
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            justify-content: center;
            background: #f5f7fa;
        }

        /* ÂÜÖÂÆπÂÆπÂô® - Â±Ö‰∏≠ÊòæÁ§∫ */
        .content-wrapper {
            display: flex;
            width: 100%;
            max-width: 1400px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Â∑¶‰æßÊ†è */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* ÂåªÁîüÈÄâÊã©Âå∫Âüü */
        .doctor-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doctors-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .doctor-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }

        .doctor-card:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .doctor-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .doctor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .doctor-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .doctor-details h3 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }

        .doctor-school {
            font-size: 12px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 8px;
            border-radius: 8px;
        }

        .selection-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .doctor-card.selected .selection-indicator {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .doctor-specialty {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* Â∑•ÂÖ∑Âå∫Âüü */
        .tools-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .tool-group {
            margin-bottom: 20px;
        }

        .tool-group:last-child {
            margin-bottom: 0;
        }

        .tool-title {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* Â§öÂõæÁâá‰∏ä‰º†Ê†∑Âºè */
        .upload-section {
            margin-bottom: 15px;
        }

        .upload-subtitle {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .upload-status {
            margin-top: 15px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 13px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        /* ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó - ÂæÆ‰ø°ÂÖºÂÆπ‰øÆÂ§ç */
        .mobile-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999999;  /* ÊèêÈ´òz-indexÂ±ÇÁ∫ßÔºåÁ°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .mobile-modal-hidden {
            display: none !important;
        }
        
        .mobile-modal-visible {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .mobile-image-modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 350px;
            min-width: 280px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            position: relative;
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-options {
            padding: 20px;
        }

        .image-option-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .image-option-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .image-option-btn:last-child {
            margin-bottom: 0;
        }

        .option-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .option-text {
            text-align: left;
        }

        .option-text strong {
            display: block;
            margin-bottom: 4px;
            color: #111827;
        }

        .option-text span {
            color: #6b7280;
            font-size: 13px;
        }

        .upload-status-mobile {
            padding: 15px 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .mobile-status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .mobile-status-item:last-child {
            margin-bottom: 0;
        }

        /* ÂæÆ‰ø°ÊµèËßàÂô®ÁâπÊÆäÈÄÇÈÖç */
        @media screen and (max-width: 480px) {
            .mobile-image-modal {
                padding: 15px;
            }
            
            .mobile-image-modal-content {
                max-width: calc(100vw - 30px);
                min-width: 260px;
            }
            
            .modal-header {
                padding: 15px 15px 10px 15px;
            }
            
            .modal-header h3 {
                font-size: 16px;
            }
            
            .modal-options {
                padding: 15px;
            }
            
            .image-option-btn {
                padding: 12px;
            }
        }

        /* ÊûÅÂ∞èÂ±èÂπïÈÄÇÈÖç */
        @media screen and (max-width: 360px) {
            .mobile-image-modal-content {
                max-width: calc(100vw - 20px);
                border-radius: 8px;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-options {
                padding: 12px;
            }
        }

        .upload-text {
            font-size: 13px;
            color: #6b7280;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-btn {
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .voice-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .voice-btn.recording {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .auto-speak {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }

        /* Âè≥‰æßÂØπËØùÂå∫Âüü */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* ÂΩìÂâçÂåªÁîü‰ø°ÊÅØÊù° */
        .current-doctor-bar {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .current-doctor-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .current-doctor-info h2 {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .current-doctor-desc {
            font-size: 14px;
            color: #6b7280;
        }

        /* ÂØπËØùÊ∂àÊÅØÂå∫Âüü */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fafafa;
        }

        .message {
            display: flex;
            margin-bottom: 24px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 12px;
        }

        .user .message-avatar {
            background: #10b981;
            color: white;
        }

        .ai .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .user .message-content {
            background: #10b981;
            color: white;
        }

        .message-content::before {
            content: '';
            position: absolute;
            top: 20px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .ai .message-content::before {
            left: -16px;
            border-right-color: white;
        }

        .user .message-content::before {
            right: -16px;
            border-left-color: #10b981;
        }

        .message-text {
            line-height: 1.6;
            font-size: 14px;
            word-wrap: break-word;
            white-space: normal;
        }
        .message-text h3, .message-text h4 {
            margin: 12px 0 8px 0;
            line-height: 1.4;
        }
        .message-text strong {
            font-weight: 600;
        }
        .message-text hr {
            margin: 12px 0;
            border: none;
            border-top: 1px solid #e5e7eb;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
        }

        /* ÂèçÈ¶àÊåâÈíÆ */
        .feedback-controls {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .feedback-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .rating-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .rating-btn {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            border-top: 1px solid #e5e7eb;
            padding: 20px 24px;
            background: white;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 12px 16px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #5a67d8;
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ÈªòËÆ§ÈöêËóèÁßªÂä®Á´ØÂÆπÂô® */
        .mobile-page-container {
            display: none;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1440px) {
            .content-wrapper {
                max-width: 95%;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                position: relative;
                overflow: hidden;
            }
            
            /* ÁßªÂä®Á´ØÈ°µÈù¢ÂÆπÂô® */
            .mobile-page-container {
                display: flex !important; /* Ë¶ÜÁõñÈªòËÆ§ÁöÑÈöêËóè */
                position: relative;
                width: 200%;
                height: 100vh;
                min-height: 100vh;
                transition: transform 0.3s ease-in-out;
                overflow: hidden;
            }
            
            .mobile-page-container.show-chat {
                transform: translateX(-50%);
            }
            
            /* ÂåªÁîüÈÄâÊã©È°µÈù¢ */
            .mobile-doctor-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .mobile-doctor-header {
                padding: 20px;
                text-align: center;
                color: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }

            .mobile-header-content {
                flex: 1;
            }
            
            .mobile-doctor-header h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .mobile-doctor-header p {
                font-size: 0.9rem;
                opacity: 0.9;
            }

            .mobile-header-actions {
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            }

            .mobile-action-btn {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                font-weight: 500;
                min-width: 60px;
            }

            .mobile-action-btn:hover,
            .mobile-action-btn:active {
                background: rgba(255,255,255,0.25);
                transform: translateY(-1px);
            }

            .mobile-chat-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .mobile-action-btn-small {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px;
                border-radius: 12px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .mobile-action-btn-small:hover,
            .mobile-action-btn-small:active {
                background: rgba(255,255,255,0.25);
                transform: scale(1.05);
            }
            
            .mobile-doctors-container {
                flex: 1;
                background: white;
                border-radius: 20px 20px 0 0;
                padding: 24px 16px 120px 16px; /* Â¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ùÈÅøÂÖçË¢´ÈÅÆÊå° */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOSÂπ≥ÊªëÊªöÂä® */
            }
            
            .mobile-doctors-title {
                text-align: center;
                font-size: 1.2rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 20px;
            }
            
            .mobile-doctors-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .mobile-doctor-card {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .mobile-doctor-card:hover,
            .mobile-doctor-card:active {
                border-color: #3b82f6;
                background: #eff6ff;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .mobile-doctor-info {
                display: flex;
                align-items: center;
                margin-bottom: 12px;
            }
            
            .mobile-doctor-avatar {
                font-size: 2.5rem;
                margin-right: 16px;
            }
            
            .mobile-doctor-details h3 {
                font-size: 1.1rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 4px;
            }
            
            .mobile-doctor-details .school {
                font-size: 0.85rem;
                color: #6b7280;
            }
            
            .mobile-doctor-specialty {
                font-size: 0.9rem;
                color: #4b5563;
                line-height: 1.4;
            }
            
            .mobile-doctor-specialty strong {
                color: #374151;
            }
            
            /* ËÅäÂ§©È°µÈù¢ */
            .mobile-chat-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: white;
            }
            
            .mobile-chat-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                flex-shrink: 0;
            }
            
            .mobile-back-btn {
                background: none;
                border: none;
                color: white;
                font-size: 1.2rem;
                padding: 8px;
                margin-right: 12px;
                cursor: pointer;
                border-radius: 50%;
                transition: background 0.2s;
            }
            
            .mobile-back-btn:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .mobile-current-doctor {
                flex: 1;
                display: flex;
                align-items: center;
            }
            
            .mobile-current-doctor .avatar {
                font-size: 1.5rem;
                margin-right: 12px;
            }
            
            .mobile-current-doctor .info h2 {
                font-size: 1rem;
                margin-bottom: 2px;
            }
            
            .mobile-current-doctor .info p {
                font-size: 0.8rem;
                opacity: 0.9;
            }
            
            .mobile-messages-container {
                flex: 1;
                padding: 16px;
                overflow-y: auto;
                background: #f9fafb;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-input-container {
                padding: 12px 16px;
                background: white;
                border-top: 1px solid #e5e7eb;
                flex-shrink: 0;
            }

            .mobile-input-helper {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
                padding: 0 4px;
                flex-wrap: wrap;
            }

            .mobile-guidance-trigger {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }

            .mobile-guidance-trigger:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            }

            .mobile-upload-trigger {
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .mobile-upload-trigger:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            }

            .mobile-upload-trigger.has-file {
                background: linear-gradient(135deg, #28a745, #20c997);
            }

            .mobile-helper-text {
                font-size: 11px;
                color: #6b7280;
                flex: 1;
                min-width: 100px;
            }
            
            .mobile-input-wrapper {
                display: flex;
                gap: 8px;
                align-items: flex-end;
            }
            
            .mobile-input-wrapper textarea {
                flex: 1;
                border: 1px solid #d1d5db;
                border-radius: 20px;
                padding: 12px 16px;
                font-size: 16px;
                resize: none;
                max-height: 100px;
                min-height: 44px;
                -webkit-appearance: none;
                -webkit-border-radius: 20px;
            }
            
            .mobile-send-btn {
                width: 44px;
                height: 44px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 1.2rem;
                cursor: pointer;
                transition: background 0.2s;
                flex-shrink: 0;
            }
            
            .mobile-send-btn:hover {
                background: #2563eb;
            }
            
            .mobile-send-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }
            
            /* PCÁ´ØÂÖÉÁ¥†Ê≠£Â∏∏ÊòæÁ§∫ - ÁßªÈô§‰∫ÜÈöêËóèËßÑÂàô */
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            
            .header-title h1 {
                font-size: 1.1rem;
            }
            
            .header-subtitle {
                font-size: 0.7rem;
            }
            
            .messages-container {
                padding: 8px;
            }
            
            .message-content {
                max-width: 95%;
                font-size: 0.85rem;
                padding: 10px 12px;
            }
            
            .input-container {
                padding: 8px;
            }
            
            .new-chat-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .sidebar {
                max-height: 120px !important;
            }
            
            .doctor-section {
                padding: 6px 8px !important;
            }
            
            .doctor-card {
                min-width: 100px !important;
                padding: 6px 8px !important;
            }
        }
        
        @media (max-width: 320px) {
            .header-title h1 {
                font-size: 1.0rem;
            }
            
            .message-content {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .input-wrapper input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .sidebar {
                max-height: 100px !important;
            }
            
            .doctor-section {
                padding: 4px 6px !important;
            }
            
            .doctor-section .section-title {
                font-size: 0.8rem !important;
                margin-bottom: 4px !important;
            }
            
            .doctor-card {
                min-width: 90px !important;
                padding: 4px 6px !important;
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-name {
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-desc {
                font-size: 0.6rem !important;
            }
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .messages-container::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .messages-container::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* ÈóÆËØäÊåáÂØºÊ†∑Âºè */
        .input-helper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .guidance-trigger {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 10px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .guidance-trigger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .helper-text {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }

        .guidance-tips {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            animation: fadeInScale 0.3s ease-out;
        }

        .tips-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tips-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tips-content {
            padding: 20px;
        }

        .tip-section {
            margin-bottom: 20px;
        }

        .tip-section h5 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .tip-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .tip-section li {
            margin-bottom: 5px;
            color: #666;
            line-height: 1.4;
        }

        .tip-footer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tip-footer p {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .guidance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            .guidance-tips {
                max-width: 95vw;
                max-height: 80vh;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
                border-radius: 16px;
                padding: 0;
            }
            
            .tips-header {
                padding: 16px 20px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .tips-header h4 {
                font-size: 18px;
                margin: 0;
            }
            
            .tips-content {
                padding: 16px 20px;
                max-height: calc(80vh - 80px);
                overflow-y: auto;
            }
            
            .tip-section {
                margin-bottom: 16px;
            }
            
            .tip-section h5 {
                font-size: 15px;
                margin-bottom: 8px;
                color: #374151;
            }
            
            .tip-section ul {
                padding-left: 16px;
                margin: 0;
            }
            
            .tip-section li {
                font-size: 14px;
                line-height: 1.5;
                margin-bottom: 4px;
                color: #4b5563;
            }
            
            .close-btn {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }
            
            .input-helper {
                display: flex !important;
                padding: 0 12px;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 12px;
            }
            
            .guidance-trigger {
                font-size: 14px !important;
                padding: 8px 12px !important;
                border-radius: 6px !important;
                min-height: 36px;
            }
            
            .helper-text {
                font-size: 11px;
                line-height: 1.3;
                flex: 1;
                min-width: 100%;
                margin-top: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ÁßªÂä®Á´ØÈ°µÈù¢ÂÆπÂô® -->
        <div class="mobile-page-container" id="mobilePageContainer">
            <!-- ÂåªÁîüÈÄâÊã©È°µÈù¢ -->
            <div class="mobile-doctor-page">
                <div class="mobile-doctor-header">
                    <div class="mobile-header-content">
                        <h1>AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØä</h1>
                        <p>‰º†Áªü‰∏≠Âåª √ó ‰∫∫Â∑•Êô∫ËÉΩ</p>
                    </div>
                    <div class="mobile-header-actions">
                        <button class="mobile-action-btn" onclick="showMobileNavigation()" title="È°µÈù¢ÂØºËà™">
                            üîó ÂØºËà™
                        </button>
                        <button class="mobile-action-btn" onclick="openRegisterPage()" title="Ê≥®ÂÜåË¥¶Êà∑">
                            üë§ Ê≥®ÂÜå
                        </button>
                        <button class="mobile-action-btn" onclick="openHistoryPage()" title="Êü•ÁúãÂéÜÂè≤">
                            üìã ÂéÜÂè≤
                        </button>
                    </div>
                </div>
                <div class="mobile-doctors-container">
                    <h2 class="mobile-doctors-title">üë®‚Äç‚öïÔ∏è ‰∏≠ÂåªÂ∏àÂõ¢Èòü</h2>
                    <div class="mobile-doctors-grid" id="mobileDoctorsGrid">
                        <!-- ÂåªÁîüÂç°ÁâáÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
            
            <!-- ËÅäÂ§©È°µÈù¢ -->
            <div class="mobile-chat-page">
                <div class="mobile-chat-header">
                    <button class="mobile-back-btn" onclick="showMobileDoctorPage()">‚Üê</button>
                    <div class="mobile-current-doctor">
                        <div class="avatar" id="mobileDoctorAvatar">ü§ñ</div>
                        <div class="info">
                            <h2 id="mobileDoctorName">ÂåªÂ∏àÂßìÂêç</h2>
                            <p id="mobileDoctorDesc">ÂåªÂ∏àÊèèËø∞</p>
                        </div>
                    </div>
                    <div class="mobile-chat-actions">
                        <button class="mobile-action-btn-small" onclick="openRegisterPage()" title="Ê≥®ÂÜå">
                            üë§
                        </button>
                        <button class="mobile-action-btn-small" onclick="openHistoryPage()" title="ÂéÜÂè≤">
                            üìã
                        </button>
                        <button class="mobile-action-btn-small" onclick="startNewChat()" title="Êñ∞ÂØπËØù">
                            ‚ú®
                        </button>
                    </div>
                </div>
                <div class="mobile-messages-container" id="mobileMessagesContainer">
                    <!-- Ê∂àÊÅØÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>
                <div class="mobile-input-container">
                    <div class="mobile-input-helper">
                        <button onclick="showGuidance()" class="mobile-guidance-trigger">üí° ÈóÆËØäÊåáÂØº</button>
                        <button onclick="showMobileImageOptions()" class="mobile-upload-trigger" id="mobileUploadTrigger">
                            üì∑ <span id="mobileUploadText">‰∏ä‰º†ËàåËãîÂíåÈù¢Ë±°ÁÖßÁâá</span>
                        </button>
                        <span class="mobile-helper-text">‰∏çÁü•ÈÅìÊÄé‰πàÊèèËø∞ÁóáÁä∂Ôºü</span>
                    </div>
                    <!-- ÁßªÂä®Á´ØÂ§öÂõæÁâá‰∏ä‰º† -->
                    <input type="file" id="mobileTongueUpload" accept="image/*" style="display: none;" onchange="handleMobileTongueUpload(event)">
                    <input type="file" id="mobileFaceUpload" accept="image/*" style="display: none;" onchange="handleMobileFaceUpload(event)">
                    
                    <!-- ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™óÂ∑≤ÁßªÂä®Âà∞bodyÂ∫ïÈÉ® -->
                    <div class="mobile-input-wrapper">
                        <textarea 
                            id="mobileMessageInput" 
                            placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÊàñÈóÆÈ¢ò..."
                            rows="1"
                            onkeydown="handleMobileKeyPress(event)"
                            oninput="adjustMobileTextareaHeight()"
                            onfocus="ensureMobileInputVisible()"
                            ontouchstart="ensureMobileInputVisible()"
                        ></textarea>
                        <button class="mobile-send-btn" id="mobileSendBtn" onclick="sendMobileMessage()">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ê°åÈù¢Á´ØÔºöÈ°∂ÈÉ®ÂØºËà™Ê†è -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØä</h1>
                    <p class="header-subtitle">‰º†Áªü‰∏≠Âåª √ó ‰∫∫Â∑•Êô∫ËÉΩ - ‰∏ì‰∏öÁâà</p>
                </div>
                <div class="header-actions">
                    <!-- È°µÈù¢ÂØºËà™‰∏ãÊãâËèúÂçï -->
                    <div class="nav-dropdown">
                        <button class="nav-dropdown-btn" onclick="toggleNavDropdown()">
                            üîó È°µÈù¢ÂØºËà™ ‚ñº
                        </button>
                        <div class="nav-dropdown-content" id="navDropdown">
                            <div class="nav-dropdown-header">Á≥ªÁªüÈ°µÈù¢ÂØºËà™</div>
                            
                            <div class="nav-dropdown-section">
                                <button class="nav-dropdown-item primary" onclick="navigateToPage('/')">
                                    üè† ‰∏ªÈ°µ - AI‰∏≠ÂåªÈóÆËØä
                                </button>
                                <button class="nav-dropdown-item primary" onclick="navigateToPage('/prescription/checker')">
                                    üè• Êô∫ËÉΩÂ§ÑÊñπÊ£ÄÊµã
                                </button>
                                <button class="nav-dropdown-item primary" onclick="navigateToPage('/prescription/learning')">
                                    üìö Â§ÑÊñπÂ≠¶‰π†Ê°à‰æã
                                </button>
                                <button class="nav-dropdown-item" onclick="navigateToPage('/register')">
                                    üë§ Áî®Êà∑Ê≥®ÂÜå
                                </button>
                                <button class="nav-dropdown-item" onclick="navigateToPage('/phone-binding')">
                                    üì± ÊâãÊú∫ÁªëÂÆö
                                </button>
                                <button class="nav-dropdown-item" onclick="navigateToPage('/history')">
                                    üìã ÂéÜÂè≤ËÆ∞ÂΩï
                                </button>
                            </div>
                            
                            <div class="nav-dropdown-section">
                                <button class="nav-dropdown-item primary" onclick="navigateToPage('/doctor/portal')">
                                    üë®‚Äç‚öïÔ∏è ÂåªÁîüÈó®Êà∑
                                </button>
                                <button class="nav-dropdown-item" onclick="navigateToPage('/doctor/thinking-v2')">
                                    üß† ÂåªÁîüÊÄùÁª¥ÂΩïÂÖ• (Êé®Ëçê)
                                </button>
                                <button class="nav-dropdown-item secondary" onclick="navigateToPage('/doctor/thinking')">
                                    üß† ÂåªÁîüÊÄùÁª¥ÂΩïÂÖ• (ÊóßÁâà)
                                </button>
                                <button class="nav-dropdown-item" onclick="navigateToPage('/doctor/management')">
                                    üîß ÂåªÁîüÁÆ°ÁêÜ
                                </button>
                            </div>
                            
                            <div class="nav-dropdown-section">
                                <button class="nav-dropdown-item" onclick="navigateToPage('/system/monitor')">
                                    üñ•Ô∏è Á≥ªÁªüÊÄßËÉΩ‰∏éÊ®°ÂùóÂÆâÂÖ®ÁõëÊéß
                                </button>
                                <button class="nav-dropdown-item" onclick="navigateToPage('/qr_gallery')">
                                    üì± ‰∫åÁª¥Á†ÅÁîªÂªä
                                </button>
                                <button class="nav-dropdown-item secondary" onclick="navigateToPage('/static/wechat_share.html')">
                                    üí¨ ÂæÆ‰ø°ÂàÜ‰∫´È°µÈù¢
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="history-btn" onclick="openRegisterPage()" title="Ê≥®ÂÜåË¥¶Êà∑">
                        üë§ Ê≥®ÂÜå
                    </button>
                    <button class="history-btn" onclick="openHistoryPage()" title="Êü•ÁúãÈóÆËØäÂéÜÂè≤">
                        üìã ÂéÜÂè≤ËÆ∞ÂΩï
                    </button>
                    <button class="new-chat-btn" onclick="startNewChat()">
                        ‚ú® Êñ∞ÂØπËØù
                    </button>
                </div>
            </div>
        </header>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <div class="main-content">
            <div class="content-wrapper">
                <!-- Â∑¶‰æßÊ†è -->
                <aside class="sidebar">
                <!-- ÂåªÁîüÈÄâÊã©Âå∫Âüü -->
                <div class="doctor-section">
                    <h3 class="section-title">üë®‚Äç‚öïÔ∏è ÈÄâÊã©ÂåªÂ∏à</h3>
                    <div class="doctors-grid" id="doctorsGrid">
                        <!-- ÂåªÁîüÂç°ÁâáÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>

                <!-- Â∑•ÂÖ∑Âå∫Âüü -->
                <div class="tools-section">
                    <!-- Â§öÂõæÁâá‰∏ä‰º† - ËàåËØä + Èù¢ËØä -->
                    <div class="tool-group">
                        <h4 class="tool-title">üì∏ ÂõæÂÉèËØäÊñ≠</h4>
                        
                        <!-- ËàåËØäÂõæÁâá‰∏ä‰º† -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">üëÖ ËàåËØäÂõæÁâá</h5>
                            <div class="upload-area" id="tongueUploadArea" onclick="triggerTongueUpload()">
                                <div class="upload-icon">üì∑</div>
                                <div class="upload-text">ÁÇπÂáª‰∏ä‰º†ËàåËØäÁÖßÁâá</div>
                            </div>
                            <input type="file" id="tongueImageUpload" accept="image/*" style="display: none;" onchange="handleTongueImageUpload(event)">
                        </div>
                        
                        <!-- Èù¢ËØäÂõæÁâá‰∏ä‰º† -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">üòä Èù¢ËØäÂõæÁâá</h5>
                            <div class="upload-area" id="faceUploadArea" onclick="triggerFaceUpload()">
                                <div class="upload-icon">üì∑</div>
                                <div class="upload-text">ÁÇπÂáª‰∏ä‰º†Èù¢ËØäÁÖßÁâá</div>
                            </div>
                            <input type="file" id="faceImageUpload" accept="image/*" style="display: none;" onchange="handleFaceImageUpload(event)">
                        </div>
                        
                        <!-- ‰∏ä‰º†Áä∂ÊÄÅ -->
                        <div class="upload-status" id="uploadStatus" style="display: none;">
                            <div class="status-item" id="tongueStatus">üëÖ ËàåËØä: <span>Êú™‰∏ä‰º†</span></div>
                            <div class="status-item" id="faceStatus">üòä Èù¢ËØä: <span>Êú™‰∏ä‰º†</span></div>
                        </div>
                    </div>

                    <!-- ËØ≠Èü≥ÂäüËÉΩ -->
                    <div class="tool-group">
                        <h4 class="tool-title">üé§ ËØ≠Èü≥ÂäüËÉΩ</h4>
                        <div class="voice-controls">
                            <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">
                                ÂºÄÂßãËØ≠Èü≥ËæìÂÖ•
                            </button>
                            <label class="auto-speak">
                                <input type="checkbox" id="autoSpeak">
                                <span>Ëá™Âä®ÊúóËØªÂõûÂ§ç</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Âè≥‰æßÂØπËØùÂå∫Âüü -->
            <main class="chat-area">
                <!-- ÂΩìÂâçÂåªÁîü‰ø°ÊÅØÊù° -->
                <div class="current-doctor-bar" id="currentDoctorBar">
                    <div class="current-doctor-avatar" id="currentDoctorAvatar">ü§ñ</div>
                    <div class="current-doctor-info">
                        <h2 id="currentDoctorName">ËØ∑ÈÄâÊã©ÂåªÂ∏à</h2>
                        <p class="current-doctor-desc" id="currentDoctorDesc">ÂΩìÂâçÂåªÂ∏àÔºöÂº†‰ª≤ÊôØ</p>
                    </div>
                </div>

                <!-- ÂØπËØùÊ∂àÊÅØÂå∫Âüü -->
                <div class="messages-container" id="messagesContainer">
                    <!-- ÈªòËÆ§ÂåªÁîüÂ∑≤ÈÄâ‰∏≠Ôºå‰∏çÈúÄË¶ÅÈÄâÊã©ÊèêÁ§∫ -->
                </div>

                <!-- Âä†ËΩΩÂä®Áîª -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <div>AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...</div>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="input-area">
                    <div class="input-helper">
                        <button onclick="showGuidance()" class="guidance-trigger">üí° ÈóÆËØäÊåáÂØº</button>
                        <span class="helper-text">‰∏çÁü•ÈÅìÊÄé‰πàÊèèËø∞ÁóáÁä∂ÔºüÁÇπÂáªÊü•ÁúãÈóÆËØäÊåáÂØº</span>
                    </div>
                    <div class="input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÊàñÈóÆÈ¢ò..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                            oninput="adjustTextareaHeight()"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            ‚Üí
                        </button>
                    </div>
                </div>
            </main>
            </div> <!-- end content-wrapper -->
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentConversationId = '';
        let selectedDoctor = 'zhang_zhongjing'; // ÈªòËÆ§Âº†‰ª≤ÊôØ
        let isVoiceRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];

        // ÂåªÁîüÊï∞ÊçÆ
        const doctors = {
            "zhang_zhongjing": {
                "name": "Âº†‰ª≤ÊôØ",
                "school": "‰º§ÂØíÊ¥æ", 
                "avatar": "üéØ",
                "specialty": "Â§ñÊÑüÁóÖ„ÄÅÂÜÖ‰º§ÊùÇÁóÖ„ÄÅÊÄ•Áóá",
                "introduction": "‰º§ÂØíÊ¥æ‰ª•„Ää‰º§ÂØíËÆ∫„Äã‰∏∫ÁêÜËÆ∫Âü∫Á°ÄÔºåÊìÖÈïøÂÖ≠ÁªèËæ®ËØÅÔºåÊ≤ªÁñóÂ§ñÊÑüÁÉ≠ÁóÖÂíåÂÜÖ‰º§ÊùÇÁóÖ„ÄÇÁî®ËçØÁ≤æÂáÜÔºåÊñπËØÅÂØπÂ∫î„ÄÇ"
            },
            "ye_tianshi": {
                "name": "Âè∂Â§©Â£´", 
                "school": "Ê∏©ÁóÖÊ¥æ",
                "avatar": "üå°Ô∏è",
                "specialty": "Ê∏©ÁóÖ„ÄÅÁÉ≠ÁóÖ„ÄÅÂÑøÁßë„ÄÅÂ¶áÁßë",
                "introduction": "Ê∏©ÁóÖÊ¥æ‰∏ìÊ≤ªÂêÑÁßçÁÉ≠ÊÄßÁñæÁóÖÔºå‰ª•Âç´Ê∞îËê•Ë°ÄËæ®ËØÅ‰∏∫ÁâπËâ≤ÔºåÁî®ËçØËΩªÊ∏ÖÁÅµÂä®„ÄÇ"
            },
            "li_dongyuan": {
                "name": "Êùé‰∏úÂû£",
                "school": "Ë°•ÂúüÊ¥æ", 
                "avatar": "üå±",
                "specialty": "ËÑæËÉÉÁóÖ„ÄÅÂÜÖ‰º§ÂèëÁÉ≠„ÄÅÊ∂àÂåñÁ≥ªÁªüÁñæÁóÖ",
                "introduction": "Ë°•ÂúüÊ¥æ‰ª•Ë∞ÉÁêÜËÑæËÉÉ‰∏∫Ê†∏ÂøÉÔºåÊìÖÈïøÊ≤ªÁñóÊ∂àÂåñÁ≥ªÁªüÁñæÁóÖÂíåÂÜÖ‰º§ÂèëÁÉ≠„ÄÇ"
            },
            "zhu_danxi": {
                "name": "Êú±‰∏πÊ∫™",
                "school": "ÊªãÈò¥Ê¥æ",
                "avatar": "üíß", 
                "specialty": "Èò¥ËôöÁÅ´Êó∫„ÄÅÂ¶áÁßëÊùÇÁóá„ÄÅÂÜÖÁßëË∞ÉÂÖª",
                "introduction": "ÊªãÈò¥Ê¥æÈáçËßÜÂÖªÈò¥Ê∏ÖÁÉ≠ÔºåÊìÖÈïøÊ≤ªÁñóÈò¥ËôöÁÅ´Êó∫ÂíåÂêÑÁßçÂÜÖÁßëË∞ÉÂÖªÔºåÁî®ËçØÂπ≥ÂíåÊúâÊïà„ÄÇ"
            },
            "liu_duzhou": {
                "name": "ÂàòÊ∏°Ëàü",
                "school": "ÁªèÊñπÊ¥æ",
                "avatar": "üìö", 
                "specialty": "ÁªèÊñπÂ∫îÁî®„ÄÅÁñëÈöæÊùÇÁóá„ÄÅÊÖ¢ÊÄßÁóÖ",
                "introduction": "ÁªèÊñπÊ¥æ‰∏•Ê†ºÊåâÁÖßÂè§‰ª£ÁªèÂÖ∏ÊñπÂâÇÊ≤ªÁñóÔºåÁâπÂà´ÊìÖÈïøÁñëÈöæÊùÇÁóáÂíåÊÖ¢ÊÄßÁñæÁóÖ„ÄÇ"
            },
            "zheng_qin_an": {
                "name": "ÈÉëÈí¶ÂÆâ",
                "school": "Êâ∂Èò≥Ê¥æ",
                "avatar": "‚òÄÔ∏è",
                "specialty": "Èò≥ËôöËØÅ„ÄÅÊÄ•Âç±ÈáçÁóá„ÄÅÁñëÈöæÊùÇÁóá", 
                "introduction": "Êâ∂Èò≥Ê¥æÈáçËßÜÈò≥Ê∞îÔºåÊìÖÈïøÊ≤ªÁñóÂêÑÁßçÈò≥ËôöÁóáÁä∂ÂíåÊÄ•Âç±ÈáçÁóá„ÄÇ"
            }
        };

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            renderDoctorCards();
            loadConversationHistory(); // Ëøô‰∏™ÂáΩÊï∞ÂÜÖÈÉ®‰ºöË∞ÉÁî®generateConversationIdÂ¶ÇÊûúÈúÄË¶Å
            
            // ËÆæÁΩÆÈªòËÆ§ÂåªÁîü - Âº†‰ª≤ÊôØÔºàÊúÄÂÖ®Èù¢ÁöÑÂåªÂ∏àÔºâ
            setDefaultDoctor('zhang_zhongjing');
            
            // Ê∑ªÂä†Ë∞ÉËØïÂäüËÉΩÔºà‰ªÖÂú®ÂºÄÂèëÁéØÂ¢ÉÊàñÁâπÂÆöÊù°‰ª∂‰∏ãÔºâ
            if (isDebugMode()) {
                console.log('üîß Ë∞ÉËØïÊ®°ÂºèÂ∑≤ÂêØÁî®');
                console.log('üìã ÂèØÁî®Ë∞ÉËØïÂëΩ‰ª§:');
                console.log('  - diagnoseHistoryIssues(): ËØäÊñ≠ÂéÜÂè≤ËÆ∞ÂΩïÈóÆÈ¢ò');
                console.log('  - checkLocalStorageUsage(): Ê£ÄÊü•Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ');
                console.log('  - cleanOldHistoryRecords(): Ê∏ÖÁêÜÊóßÁöÑÂéÜÂè≤ËÆ∞ÂΩï');
                
                // Â∞ÜË∞ÉËØïÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä
                window.diagnoseHistoryIssues = diagnoseHistoryIssues;
                window.checkLocalStorageUsage = checkLocalStorageUsage;
                window.cleanOldHistoryRecords = cleanOldHistoryRecords;
                
                // È°µÈù¢Âä†ËΩΩÂêéËá™Âä®ËøêË°å‰∏ÄÊ¨°ËØäÊñ≠
                setTimeout(() => {
                    console.log('\nüîç Ëá™Âä®ÂéÜÂè≤ËÆ∞ÂΩïËØäÊñ≠:');
                    diagnoseHistoryIssues();
                }, 1000);
            }
        }
        
        // ËÆæÁΩÆÈªòËÆ§ÂåªÁîüÔºà‰∏ç‰ºöÊúâÁ°ÆËÆ§ÊèêÁ§∫Ôºâ
        function setDefaultDoctor(doctorKey) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // Êõ¥Êñ∞UIÊòæÁ§∫
            const cards = document.querySelectorAll('.doctor-card');
            cards.forEach((card, index) => {
                if (Object.keys(doctors)[index] === doctorKey) {
                    card.classList.add('selected');
                }
            });
            
            // Êõ¥Êñ∞È°∂ÈÉ®ÂåªÁîü‰ø°ÊÅØÊù°
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `ÊìÖÈïøÔºö${doctor.specialty}`;
            
            // Âä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï
            loadDoctorHistory(doctorKey);
        }

        // ÁîüÊàêÂØπËØùID - ÊåâÁî®Êà∑Á±ªÂûãÈöîÁ¶ª
        function generateConversationId() {
            // Ëé∑ÂèñÈ°µÈù¢Á±ªÂûãÊù•Âå∫ÂàÜÁî®Êà∑‰ºöËØù
            const pageType = getPageType();
            const userId = getCurrentUserId();
            
            // ÁîüÊàêÂü∫Á°ÄUUID
            const baseId = 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            
            // ‰∏∫‰∏çÂêåÁî®Êà∑Á±ªÂûãÊ∑ªÂä†ÂâçÁºÄÔºåÁ°Æ‰øùÈöîÁ¶ª
            currentConversationId = `${pageType}-${userId}-${baseId}`;
            
            // ‰ΩøÁî®Â∏¶Áî®Êà∑Ê†áËØÜÁöÑkeyÂ≠òÂÇ®ÔºåÈÅøÂÖçË∑®Áî®Êà∑Ê±°Êüì
            const storageKey = `conversationId_${pageType}_${userId}`;
            localStorage.setItem(storageKey, currentConversationId);
        }
        
        // Ëé∑ÂèñÈ°µÈù¢Á±ªÂûã
        function getPageType() {
            const path = window.location.pathname;
            if (path.includes('/smart')) {
                return 'smart_workflow';
            } else {
                return 'guest_portal';
            }
        }
        
        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ID
        function getCurrentUserId() {
            // Â∞ùËØï‰ªéÂ§ö‰∏™Êù•Ê∫êËé∑ÂèñÁî®Êà∑ID
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.id || currentUser.user_id) {
                return currentUser.id || currentUser.user_id;
            }
            
            // Êô∫ËÉΩÂ∑•‰ΩúÊµÅÁ®ãÈ°µÈù¢ÁöÑÁî®Êà∑
            const smartUser = localStorage.getItem('currentUserId');
            if (smartUser) {
                return smartUser;
            }
            
            // Ê∏∏ÂÆ¢Áî®Êà∑ - ÁîüÊàêÂîØ‰∏ÄÊ†áËØÜ
            const guestId = localStorage.getItem('guestUserId');
            if (guestId) {
                return guestId;
            }
            
            // ÁîüÊàêÊñ∞ÁöÑÊ∏∏ÂÆ¢ID
            const newGuestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('guestUserId', newGuestId);
            return newGuestId;
        }
        
        // Ë∞ÉËØïÂäüËÉΩÔºöÊ∏ÖÈô§ÂΩìÂâçÈ°µÈù¢Á±ªÂûãÁöÑÂØπËØùÊï∞ÊçÆ
        function clearCurrentPageConversation() {
            const pageType = getPageType();
            const userId = getCurrentUserId();
            const storageKey = `conversationId_${pageType}_${userId}`;
            
            localStorage.removeItem(storageKey);
            
            // Ê∏ÖÁ©∫ÂΩìÂâçÂØπËØù
            currentConversationId = '';
            
            // Ê∏ÖÁ©∫Ê∂àÊÅØÂÆπÂô®
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
            
            // ÈáçÊñ∞ÁîüÊàêÊñ∞ÁöÑÂØπËØùID
            generateConversationId();
            
            console.log(`Â∑≤Ê∏ÖÈô§${pageType}Áî®Êà∑(${userId})ÁöÑÂØπËØùÊï∞ÊçÆÔºåÊñ∞ÂØπËØùID: ${currentConversationId}`);
        }

        // Ê∏≤ÊüìÂåªÁîüÂç°Áâá
        function renderDoctorCards() {
            const container = document.getElementById('doctorsGrid');
            container.innerHTML = '';

            Object.entries(doctors).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'doctor-card';
                card.onclick = () => selectDoctor(key);
                
                card.innerHTML = `
                    <div class="doctor-header">
                        <div class="doctor-info">
                            <div class="doctor-avatar">${doctor.avatar}</div>
                            <div class="doctor-details">
                                <h3>${doctor.name}</h3>
                                <span class="doctor-school">${doctor.school}</span>
                            </div>
                        </div>
                        <div class="selection-indicator">
                            <span style="font-size: 12px;">‚úì</span>
                        </div>
                    </div>
                    <div class="doctor-specialty">
                        <strong>ÊìÖÈïøÔºö</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // ÈÄâÊã©ÂåªÁîü
        function selectDoctor(doctorKey) {
            const messagesContainer = document.getElementById('messagesContainer');
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁúüÊ≠£ÁöÑÂØπËØùÂÜÖÂÆπÔºàÁî®Êà∑Ê∂àÊÅØÊàñAIÂõûÂ§çÔºâ
            const userMessages = messagesContainer.querySelectorAll('.message.user');
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            const hasExistingMessages = userMessages.length > 0 || aiMessages.length > 0;
            
            // ÂàáÊç¢ÂåªÁîüÊó∂‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤Ôºå‰∏çÂÜçÊ∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï
            if (selectedDoctor && selectedDoctor !== doctorKey && hasExistingMessages) {
                // ‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤
                saveCurrentDoctorHistory();
            }
            
            // ÁßªÈô§‰πãÂâçÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Ê∑ªÂä†Êñ∞ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            event.currentTarget.classList.add('selected');

            const previousDoctor = selectedDoctor;
            selectedDoctor = doctorKey;
            const doctor = doctors[doctorKey];

            // Êõ¥Êñ∞È°∂ÈÉ®ÂåªÁîü‰ø°ÊÅØÊù°
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `ÊìÖÈïøÔºö${doctor.specialty}`;

            // ÂàáÊç¢ÂåªÁîüÊó∂ÁîüÊàêÊñ∞ÁöÑÂØπËØùIDÔºåÁ°Æ‰øùAIË∫´‰ªΩÊ≠£Á°ÆÂàáÊç¢
            if (previousDoctor && previousDoctor !== doctorKey) {
                // ÁîüÊàêÊñ∞ÁöÑÂØπËØùIDÔºåÂº∫Âà∂ÂºÄÂßãÊñ∞ÂØπËØù
                generateConversationId();
            }
            
            // Âä†ËΩΩÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤Ôºå‰∏çÊ∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï
            if (!previousDoctor || previousDoctor !== doctorKey) {
                // Âä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ÂØπËØù
                loadDoctorHistory(doctorKey);
            }
            
            // ÊòæÁ§∫ËæìÂÖ•Ê°Ü
            const inputContainer = document.querySelector('.input-container');
            if (inputContainer) {
                inputContainer.classList.add('show');
            }
            
            // ÁßªÂä®Á´ØÔºöÂÖ≥Èó≠ÂåªÁîüÈÄâÊã©ÊµÆÂ±Ç
            if (window.innerWidth <= 768) {
                closeMobileDoctorSelector();
            }
        }

        // Ê∑ªÂä†Ê∂àÊÅØ
        function addMessage(sender, content, showFeedback = false) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'üë§' : (selectedDoctor ? doctors[selectedDoctor].avatar : 'ü§ñ')}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    <div class="message-time">${timeStr}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">Ëøô‰∏™ÂõûÁ≠îÊúâÂ∏ÆÂä©ÂêóÔºü</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">üòä ÂæàÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">üëç ‰∏çÈîô</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">üëå ËøòË°å</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">üëé ‰∏çÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">üòû ÂæàÂ∑Æ</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            // Ëá™Âä®ÊúóËØªAIÂõûÂ§ç
            if (sender === 'ai' && document.getElementById('autoSpeak').checked) {
                speakText(content);
            }
            
            // Ëá™Âä®‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤
            if (selectedDoctor) {
                setTimeout(() => saveCurrentDoctorHistory(), 100); // Âª∂Ëøü100msÁ°Æ‰øùDOMÊõ¥Êñ∞ÂÆåÊàê
            }
        }

        // Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπ
        function formatMessage(content) {
            if (!content) return '';
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ËØäÁñóÊñπÊ°àXMLÊ†áÁ≠æ
            if (content.includes('<ËØäÁñóÊñπÊ°à>')) {
                return formatTCMPrescription(content);
            }
            
            // Â¢ûÂº∫ÁöÑMarkdownÂ§ÑÁêÜ - ÊòéÁ°ÆÁöÑÂ±ÇÊ¨°ÂíåÊ†∑Âºè
            return content
                // Â§ÑÁêÜ„ÄêÂ§ÑÊñπ„ÄëÊ†áÁ≠æ - ÁâπÊÆäÈ´ò‰∫ÆÊ†∑Âºè
                .replace(/\*\*„ÄêÂ§ÑÊñπ„Äë\*\*/g, '<div style="background: linear-gradient(135deg, #2d5aa0, #4a7bc8); color: white; padding: 10px 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; font-size: 16px; text-align: center;">üìã ‰∏≠ËçØÂ§ÑÊñπ</div>')
                // Â§ÑÁêÜ„ÄêÁî®Ê≥ï„Äë„ÄêÊ≥®ÊÑè„ÄëÁ≠âÊ†áÁ≠æ
                .replace(/\*\*„Äê(Áî®Ê≥ï|Ê≥®ÊÑè|Á¶ÅÂøå|ÂäüÊïà)„Äë\*\*/g, '<div style="background: #f3f4f6; color: #374151; padding: 8px 12px; border-radius: 6px; margin: 10px 0; font-weight: bold; border-left: 4px solid #6b7280;">$1</div>')
                // Â§ÑÁêÜÂÖ∂‰ªñÁ≤ó‰ΩìÊ†áÁ≠æ„Äêxxx„Äë
                .replace(/\*\*„Äê(.*?)„Äë\*\*/g, '<strong style="color: #2d5aa0; font-size: 15px; background: #e0f2fe; padding: 2px 6px; border-radius: 4px;">„Äê$1„Äë</strong>')
                // Â§ÑÁêÜÂÖ∂‰ªñÁ≤ó‰ΩìÊñáÊú¨
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937; font-weight: bold;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color: #6b7280;">$1</em>')
                // Â§ÑÁêÜ#####Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫ÂàÜÂâ≤Á∫ø
                .replace(/#{5,}/g, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb; background: linear-gradient(to right, #e5e7eb, transparent);">')
                // Â§ÑÁêÜ###Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫ÊòéÊòæÁöÑÂ∞èÊ†áÈ¢ò
                .replace(/###\s*(.*?)(?=\n|$)/g, '<h4 style="margin: 20px 0 12px 0; color: #2d5aa0; font-size: 17px; font-weight: bold; padding-left: 8px; border-left: 4px solid #2d5aa0; background: #f8fafc;">$1</h4>')
                // Â§ÑÁêÜ##Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫Êõ¥Â§ßÁöÑ‰∏≠Ê†áÈ¢ò  
                .replace(/##\s*(.*?)(?=\n|$)/g, '<h3 style="margin: 25px 0 15px 0; color: #1f2937; font-size: 19px; font-weight: bold; padding: 8px 12px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 6px;">$1</h3>')
                // Â§ÑÁêÜ#Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫Â§ßÊ†áÈ¢ò
                .replace(/^#\s*(.*?)(?=\n|$)/gm, '<h2 style="margin: 30px 0 20px 0; color: #111827; font-size: 22px; font-weight: bold; text-align: center; padding: 12px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px;">$1</h2>')
                // Â§ÑÁêÜËçØÊùêÂàóË°® - ÁâπÊÆäÊ†∑Âºè
                .replace(/([‰∏Ä-Èæü\u4e00-\u9fff]+)\s+(\d+)g/g, '<span style="display: inline-block; background: #ecfdf5; color: #065f46; padding: 2px 6px; margin: 1px 3px; border-radius: 4px; font-weight: 500; border: 1px solid #d1fae5;">$1 <strong>$2g</strong></span>')
                .replace(/\n\n/g, '<br><br>')  // ÊÆµËêΩÈó¥Ë∑ù
                .replace(/\n/g, '<br>')        // ÊôÆÈÄöÊç¢Ë°å
                .replace(/(\d+\.\s)/g, '<br><span style="color: #2d5aa0; font-weight: bold;">$1</span>') // Êï∞Â≠óÂàóË°®Ê†∑Âºè
                .replace(/^<br>/, '');         // ÁßªÈô§ÂºÄÂ§¥ÁöÑÊç¢Ë°å
        }

        // Ê†ºÂºèÂåñ‰∏≠ÂåªÂ§ÑÊñπ - ÂÖ®Êñ∞ËÆæËÆ°
        function formatTCMPrescription(content) {
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´XMLÊ†ºÂºè
            const hasXMLFormat = content.includes('<ËØäÁñóÊñπÊ°à>');
            
            if (hasXMLFormat) {
                return formatXMLPrescription(content);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâXMLÊ†ºÂºèÔºåÂ∞ùËØïÊô∫ËÉΩËß£ÊûêÊñáÊú¨Ê†ºÂºè
                return formatTextPrescription(content);
            }
        }

        // XMLÊ†ºÂºèÂ§ÑÊñπËß£Êûê
        function formatXMLPrescription(content) {
            const prescriptionMatch = content.match(/<ËØäÁñóÊñπÊ°à>([\s\S]*?)<\/ËØäÁñóÊñπÊ°à>/);
            if (!prescriptionMatch) {
                return formatTextPrescription(content);
            }
            
            const prescriptionContent = prescriptionMatch[1];
            let formattedHTML = '<div class="modern-tcm-report">';
            
            // ÂÆö‰πâÂêÑ‰∏™ÈÉ®ÂàÜÁöÑÈÖçÁΩÆ
            const sections = [
                { name: '‰∏ªËØâ', key: '‰∏ªËØâ', icon: 'ü©∫', color: '#ef4444' },
                { name: 'Áé∞ÁóÖÂè≤', key: 'Áé∞ÁóÖÂè≤', icon: 'üìã', color: '#3b82f6' },
                { name: 'ÊúõËØäÊâÄËßÅ', key: 'ÊúõËØäÊâÄËßÅ', icon: 'üëÅÔ∏è', color: '#10b981' },
                { name: 'ÁóÖÊú∫ÂàÜÊûê', key: 'ÁóÖÊú∫ÂàÜÊûê', icon: 'üß†', color: '#8b5cf6' },
                { name: 'ËØÅÂûãËØäÊñ≠', key: 'ËØÅÂûãËØäÊñ≠', icon: 'üéØ', color: '#f59e0b' },
                { name: 'Ê≤ªÊ≥ï', key: 'Ê≤ªÊ≥ï', icon: '‚ö°', color: '#06b6d4' },
                { name: 'ÊñπÂâÇÈÄâÁî®', key: 'ÊñπÂâÇÈÄâÁî®', icon: 'üìú', color: '#84cc16' },
                { name: 'Â§ÑÊñπÂª∫ËÆÆ', key: 'Â§ÑÊñπÂª∫ËÆÆ', icon: 'üíä', color: '#ec4899', special: 'prescription' },
                { name: 'ÁÖéÊúçÊñπÊ≥ï', key: 'ÁÖéÊúçÊñπÊ≥ï', icon: 'üî•', color: '#f97316' },
                { name: 'ÈöèËØÅÂä†Âáè', key: 'ÈöèËØÅÂä†Âáè', icon: '‚öñÔ∏è', color: '#6366f1' },
                { name: 'ÁîüÊ¥ªË∞ÉÊëÑ', key: 'ÁîüÊ¥ªË∞ÉÊëÑ', icon: 'üå±', color: '#059669' },
                { name: 'Â§çËØäÂª∫ËÆÆ', key: 'Â§çËØäÂª∫ËÆÆ', icon: 'üìÖ', color: '#dc2626' }
            ];
            
            sections.forEach(section => {
                const regex = new RegExp(`<${section.key}>(.*?)<\/${section.key}>`, 's');
                const match = prescriptionContent.match(regex);
                
                if (match) {
                    let sectionContent = match[1].trim()
                        .replace(/\*\*(.*?)\*\*/g, '<span class="highlight-term">$1</span>')
                        .replace(/\n/g, '<br>');
                    
                    // ÁâπÊÆäÂ§ÑÁêÜÂ§ÑÊñπÂª∫ËÆÆ
                    if (section.special === 'prescription') {
                        sectionContent = formatModernPrescription(sectionContent);
                    }
                    
                    formattedHTML += `
                        <div class="modern-tcm-section" style="--section-color: ${section.color}">
                            <div class="section-header">
                                <span class="section-icon">${section.icon}</span>
                                <span class="section-title">${section.name}</span>
                            </div>
                            <div class="section-content">${sectionContent}</div>
                        </div>
                    `;
                }
            });
            
            formattedHTML += '</div>';
            
            // Â§ÑÁêÜXMLÂ§ñÁöÑÂÜÖÂÆπ
            const beforeMatch = content.substring(0, content.indexOf('<ËØäÁñóÊñπÊ°à>'));
            const afterMatch = content.substring(content.indexOf('</ËØäÁñóÊñπÊ°à>') + 7);
            
            let result = '';
            if (beforeMatch.trim()) {
                result += '<div class="pre-prescription">' + formatMessage(beforeMatch) + '</div>';
            }
            result += formattedHTML;
            if (afterMatch.trim()) {
                result += '<div class="post-prescription">' + formatMessage(afterMatch) + '</div>';
            }
            
            return result;
        }

        // ÊñáÊú¨Ê†ºÂºèÂ§ÑÊñπÊô∫ËÉΩËß£Êûê
        function formatTextPrescription(content) {
            let formattedHTML = '<div class="text-tcm-report">';
            
            // ÊåâÊÆµËêΩÂàÜÊûê
            const paragraphs = content.split('\n\n');
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ†áÈ¢òË°å
                    if (paragraph.includes('**') && paragraph.length < 50) {
                        formattedHTML += `<div class="text-section-header">${formatMessage(paragraph)}</div>`;
                    } else {
                        formattedHTML += `<div class="text-section-content">${formatMessage(paragraph)}</div>`;
                    }
                }
            });
            
            formattedHTML += '</div>';
            return formattedHTML;
        }

        // Áé∞‰ª£ÂåñÂ§ÑÊñπÊ†ºÂºèÂåñ
        function formatModernPrescription(prescriptionText) {
            // Â§öÁßçËçØÊùêÊ†ºÂºèËØÜÂà´
            const herbs = [];
            let originalText = prescriptionText;
            
            // Ê®°ÂºèÂåπÈÖçËçØÊùêÂêçÁß∞ÂíåÂâÇÈáè
            const patterns = [
                /<span class="highlight-term">(.*?)<\/span>\s*(\d+(?:\.\d+)?g?)/g,
                /\*\*(.*?)\*\*\s*(\d+(?:\.\d+)?g?)/g,
                /<strong>(.*?)<\/strong>\s*(\d+(?:\.\d+)?g?)/g,
                /([^\s\dÔºå„ÄÇÔºõ„ÄÅ\-]+)\s*(\d+(?:\.\d+)?g)/g
            ];
            
            let usedPattern = null;
            
            for (let pattern of patterns) {
                pattern.lastIndex = 0; // ÈáçÁΩÆÊ≠£ÂàôË°®ËææÂºèÁöÑlastIndex
                let match;
                let tempHerbs = [];
                
                while ((match = pattern.exec(originalText)) !== null) {
                    const herbName = match[1].trim();
                    const dosage = match[2];
                    
                    // ÊéíÈô§ÈùûËçØÊùêËØçÊ±áÂíåÈáçÂ§çÈ°π
                    if (!['ÂÖ±', 'ÁÖé', 'Êúç', 'Áî®', 'ÊØè', 'Ê¨°', 'Êó•', 'Ê∞¥', 'ÁÖéÊúç', 'ÂàÜÊúç', 'Êñπ', 'ËçØ'].includes(herbName) 
                        && herbName.length > 0 && herbName.length < 10) {
                        
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
                        if (!tempHerbs.some(h => h.name === herbName)) {
                            tempHerbs.push({
                                name: herbName,
                                dosage: dosage,
                                fullMatch: match[0]
                            });
                        }
                    }
                }
                
                if (tempHerbs.length > 0) {
                    herbs.push(...tempHerbs);
                    usedPattern = pattern;
                    break; // ÊâæÂà∞ÂåπÈÖçÂ∞±ÂÅúÊ≠¢
                }
            }
            
            if (herbs.length > 0) {
                let modernHTML = '<div class="modern-prescription-grid">';
                herbs.forEach((herb, index) => {
                    modernHTML += `
                        <div class="herb-card" style="animation-delay: ${index * 0.1}s">
                            <div class="herb-name-modern">
                                ${herb.name} 
                                <span class="herb-dosage-inline">${herb.dosage}</span>
                            </div>
                        </div>
                    `;
                });
                modernHTML += '</div>';
                
                // ÁßªÈô§Â∑≤ÁªèÊòæÁ§∫ÁöÑËçØÊùê‰ø°ÊÅØÔºåÈÅøÂÖçÈáçÂ§ç
                let remainingText = originalText;
                herbs.forEach(herb => {
                    // ÁßªÈô§ÂêÑÁßçÂèØËÉΩÁöÑËçØÊùêÊ†ºÂºè
                    remainingText = remainingText
                        .replace(new RegExp(`\\*\\*${herb.name}\\*\\*\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '')
                        .replace(new RegExp(`<strong>${herb.name}</strong>\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '')
                        .replace(new RegExp(`<span class="highlight-term">${herb.name}</span>\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '')
                        .replace(new RegExp(`${herb.name}\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '');
                });
                
                // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÊ†áÁÇπÂíåÁ©∫ÁôΩ
                remainingText = remainingText
                    .replace(/<[^>]*>/g, '') // ÁßªÈô§HTMLÊ†áÁ≠æ
                    .replace(/\*\*/g, '') // ÁßªÈô§markdownÊ†áËÆ∞
                    .replace(/[Ôºå„ÄÅ]{2,}/g, '„ÄÅ') // ÂêàÂπ∂Â§ö‰∏™Ê†áÁÇπ
                    .replace(/^[Ôºå„ÄÅ\s]+|[Ôºå„ÄÅ\s]+$/g, '') // ÁßªÈô§È¶ñÂ∞æÊ†áÁÇπ
                    .trim();
                
                // Âè™ÊúâÂΩìÂâ©‰ΩôÊñáÊú¨ÊúâÂÆûÈôÖÂÜÖÂÆπÊó∂ÊâçÊòæÁ§∫
                if (remainingText && remainingText.length > 5) {
                    modernHTML += `<div class="prescription-notes">${remainingText}</div>`;
                }
                
                return modernHTML;
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâËØÜÂà´Âà∞ËçØÊùêÔºåËøîÂõûÊ†ºÂºèÂåñÁöÑÊñáÊú¨
            return `<div class="prescription-text">${prescriptionText}</div>`;
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰ΩçÂåªÂ∏à');
                }
                return;
            }

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMessage('user', message);
            input.value = '';
            adjustTextareaHeight();

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const sendBtn = document.getElementById('sendBtn');
            const loading = document.getElementById('loading');
            sendBtn.disabled = true;
            loading.style.display = 'block';

                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/api/consultation/chat-legacy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                // Êô∫ËÉΩÂà§Êñ≠ÊòØÂê¶ÊòæÁ§∫ÁÇπËØÑ - Âè™ÊúâÂåÖÂê´Â§ÑÊñπÊó∂ÊâçÊòæÁ§∫
                const shouldShowFeedback = containsPrescription(data.reply);
                addMessage('ai', data.reply, shouldShowFeedback);
                
                // ËÆ∞ÂΩïËØäÊñ≠Èò∂ÊÆµ
                if (shouldShowFeedback) {
                    console.log('Ê£ÄÊµãÂà∞Â§ÑÊñπÂÜÖÂÆπÔºåÊòæÁ§∫ÁÇπËØÑÂäüËÉΩ');
                } else {
                    console.log('ÊôÆÈÄöÂØπËØùÔºå‰∏çÊòæÁ§∫ÁÇπËØÑ');
                }

            } catch (error) {
                addMessage('ai', `Êä±Ê≠âÔºåÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®Ôºö${error.message}`);
            } finally {
                sendBtn.disabled = false;
                loading.style.display = 'none';
                input.focus();
            }
        }

        // Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // ÊâìÂºÄÊ≥®ÂÜåÈ°µÈù¢
        function openRegisterPage() {
            window.open('/register', '_blank');
        }

        // ÊâìÂºÄÂéÜÂè≤ËÆ∞ÂΩïÈ°µÈù¢
        function openHistoryPage() {
            window.open('/history', '_blank');
        }

        // È°µÈù¢ÂØºËà™‰∏ãÊãâËèúÂçïÂäüËÉΩ
        function toggleNavDropdown() {
            const dropdown = document.getElementById('navDropdown');
            dropdown.classList.toggle('show');
        }

        // ÂØºËà™Âà∞ÊåáÂÆöÈ°µÈù¢
        function navigateToPage(url) {
            // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
            const dropdown = document.getElementById('navDropdown');
            dropdown.classList.remove('show');
            
            // Â¶ÇÊûúÊòØ‰∏ªÈ°µÔºåÂà∑Êñ∞ÂΩìÂâçÈ°µÈù¢
            if (url === '/' && window.location.pathname === '/') {
                window.location.reload();
                return;
            }
            
            // ÂØºËà™Âà∞Êñ∞È°µÈù¢
            window.open(url, '_blank');
        }

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('navDropdown');
            const dropdownBtn = event.target.closest('.nav-dropdown');
            
            if (!dropdownBtn && dropdown) {
                dropdown.classList.remove('show');
            }
        });

        // ÁßªÂä®Á´ØÈ°µÈù¢ÂØºËà™
        function showMobileNavigation() {
            const navigationHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 12px; padding: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="text-align: center; font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #374151;">
                            üì± Á≥ªÁªüÈ°µÈù¢ÂØºËà™
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #6b7280; font-size: 14px;">Áî®Êà∑ÂäüËÉΩ</div>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/'); this.parentElement.parentElement.parentElement.remove();">üè† ‰∏ªÈ°µ - AI‰∏≠ÂåªÈóÆËØä</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/register'); this.parentElement.parentElement.parentElement.remove();">üë§ Áî®Êà∑Ê≥®ÂÜå</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/phone-binding'); this.parentElement.parentElement.parentElement.remove();">üì± ÊâãÊú∫ÁªëÂÆö</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/history'); this.parentElement.parentElement.parentElement.remove();">üìã ÂéÜÂè≤ËÆ∞ÂΩï</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/prescription/checker'); this.parentElement.parentElement.parentElement.remove();">üè• Êô∫ËÉΩÂ§ÑÊñπÊ£ÄÊµã</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/prescription/learning'); this.parentElement.parentElement.parentElement.remove();">üìö Â§ÑÊñπÂ≠¶‰π†Ê°à‰æã</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #6b7280; font-size: 14px;">ÂåªÁîüÂäüËÉΩ</div>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #e3f2fd; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/doctor/portal'); this.parentElement.parentElement.parentElement.remove();">üë®‚Äç‚öïÔ∏è ÂåªÁîüÈó®Êà∑</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #e3f2fd; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/doctor/thinking-v2'); this.parentElement.parentElement.parentElement.remove();">üß† ÂåªÁîüÊÄùÁª¥ÂΩïÂÖ• (Êé®Ëçê)</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #e3f2fd; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/doctor/management'); this.parentElement.parentElement.parentElement.remove();">üîß ÂåªÁîüÁÆ°ÁêÜ</button>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #6b7280; font-size: 14px;">Á≥ªÁªüÁÆ°ÁêÜ</div>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #fff3e0; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/system/monitor'); this.parentElement.parentElement.parentElement.remove();">üñ•Ô∏è Á≥ªÁªüÊÄßËÉΩ‰∏éÊ®°ÂùóÂÆâÂÖ®ÁõëÊéß</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #fff3e0; border: none; border-radius: 8px; text-align: left;" onclick="navigateToPage('/qr_gallery'); this.parentElement.parentElement.parentElement.remove();">üì± ‰∫åÁª¥Á†ÅÁîªÂªä</button>
                        </div>
                        
                        <button style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 500;" onclick="this.parentElement.parentElement.remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', navigationHtml);
        }

        // ÂºÄÂßãÊñ∞ÂØπËØù
        function startNewChat() {
            const choice = confirm('ÂºÄÂßãÊñ∞ÂØπËØùÈÄâÈ°πÔºö\n- Á°ÆÂÆöÔºöÊ∏ÖÁ©∫ÂΩìÂâçÂåªÁîüÁöÑÂØπËØùËÆ∞ÂΩï\n- ÂèñÊ∂àÔºö‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩï‰∏çÂèò');
            if (choice) {
                // Áî®Êà∑ÈÄâÊã©Ê∏ÖÁ©∫ÂΩìÂâçÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                if (selectedDoctor) {
                    const historyKey = `tcm_doctor_history_${selectedDoctor}`;
                    localStorage.removeItem(historyKey);
                    console.log(`Â∑≤Ê∏ÖÁ©∫${selectedDoctor}ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï`);
                }
                generateConversationId();
                
                // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºàÁé∞Âú®ÊòØÁ©∫ÁöÑÔºâ
                if (selectedDoctor) {
                    loadDoctorHistory(selectedDoctor);
                }
            } else {
                // Áî®Êà∑ÈÄâÊã©‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩïÔºå‰ªÄ‰πàÈÉΩ‰∏çÂÅö
                console.log('Áî®Êà∑ÈÄâÊã©‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩï‰∏çÂèò');
                
                // ÈöêËóèËæìÂÖ•Ê°Ü
                const inputContainer = document.querySelector('.input-container');
                if (inputContainer) {
                    inputContainer.classList.remove('show');
                }
            }
        }

        // Â§öÂõæÁâá‰∏ä‰º†ÂäüËÉΩ
        let tongueImage = null;
        let faceImage = null;

        // Ê°åÈù¢Á´Ø - ËàåËØäÂõæÁâá‰∏ä‰º†
        function triggerTongueUpload() {
            document.getElementById('tongueImageUpload').click();
        }

        function handleTongueImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                const uploadArea = document.getElementById('tongueUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <div class="upload-text">ËàåËØäÁÖßÁâáÂ∑≤ÈÄâÊã©</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // Ê°åÈù¢Á´Ø - Èù¢ËØäÂõæÁâá‰∏ä‰º†
        function triggerFaceUpload() {
            document.getElementById('faceImageUpload').click();
        }

        function handleFaceImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                const uploadArea = document.getElementById('faceUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <div class="upload-text">Èù¢ËØäÁÖßÁâáÂ∑≤ÈÄâÊã©</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // ÁßªÂä®Á´Ø - ÊòæÁ§∫ÂõæÁâáÈÄâÊã©ÂºπÁ™óÔºàÂæÆ‰ø°ÂÖºÂÆπ‰ºòÂåñÂ¢ûÂº∫ÁâàÔºâ
        function showMobileImageOptions() {
            console.log('üîÑ Â∞ùËØïÊòæÁ§∫ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó...');
            
            try {
                const modal = document.getElementById('mobileImageModal');
                console.log('üîç ÂºπÁ™óÂÖÉÁ¥†Êü•ÊâæÁªìÊûú:', modal ? 'ÊâæÂà∞' : 'Êú™ÊâæÂà∞');
                
                if (modal) {
                    // ÊñπÊ≥ï1: Á´ãÂç≥ÊòæÁ§∫ÂºπÁ™ó
                    console.log('üì± ÊñπÊ≥ï1: Á´ãÂç≥ÊòæÁ§∫ÂºπÁ™ó');
                    setModalVisible(modal);
                    
                    // ÊñπÊ≥ï2: Âª∂Ëøü100msÂÜçÊ¨°Á°ÆËÆ§ÊòæÁ§∫ÔºàÂ§ÑÁêÜÊ∏≤ÊüìÂª∂ËøüÔºâ
                    setTimeout(() => {
                        console.log('üì± ÊñπÊ≥ï2: Âª∂ËøüÁ°ÆËÆ§ÊòæÁ§∫');
                        const computedStyle = window.getComputedStyle(modal);
                        if (computedStyle.display === 'none') {
                            console.log('‚ö†Ô∏è  ÂºπÁ™ó‰ªçÊú™ÊòæÁ§∫ÔºåÂº∫Âà∂ÊòæÁ§∫');
                            forceShowModal(modal);
                        } else {
                            console.log('‚úÖ ÂºπÁ™óÊòæÁ§∫ÊàêÂäü');
                        }
                    }, 100);
                    
                    // ÊñπÊ≥ï3: ÂæÆ‰ø°ÁéØÂ¢ÉÁâπÊÆäÂ§ÑÁêÜ
                    if (isWeChatBrowser()) {
                        setTimeout(() => {
                            console.log('üì± ÊñπÊ≥ï3: ÂæÆ‰ø°ÁéØÂ¢ÉÁâπÊÆäÂ§ÑÁêÜ');
                            wechatModalFix(modal);
                        }, 200);
                    }
                    
                } else {
                    console.error('‚ùå Êâæ‰∏çÂà∞ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™óÂÖÉÁ¥†Ôºå‰ΩøÁî®fallbackÊñπÊ≥ï');
                    // Fallback: Áõ¥Êé•Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
                    if (confirm('üì∑ ÈÄâÊã©ÂõæÁâáÁ±ªÂûãÔºö\n\nÁ°ÆÂÆö = üëÖ ËàåËØäÁÖßÁâá\nÂèñÊ∂à = üòä Èù¢ËØäÁÖßÁâá')) {
                        console.log('Áî®Êà∑ÈÄâÊã©ËàåËØäÁÖßÁâá');
                        document.getElementById('mobileTongueUpload').click();
                    } else {
                        console.log('Áî®Êà∑ÈÄâÊã©Èù¢ËØäÁÖßÁâá');
                        document.getElementById('mobileFaceUpload').click();
                    }
                }
            } catch (error) {
                console.error('‚ùå ÊòæÁ§∫ÂºπÁ™óÊó∂Âá∫Èîô:', error);
                // ÊúÄÁÆÄÂçïÁöÑfallback
                alert('ÂõæÁâá‰∏ä‰º†ÂäüËÉΩÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï\n\nÈîôËØØ: ' + error.message);
            }
        }
        
        // ËÆæÁΩÆÂºπÁ™óÂèØËßÅÁöÑÊ†∏ÂøÉÂáΩÊï∞
        function setModalVisible(modal) {
            console.log('üéØ ËÆæÁΩÆÂºπÁ™óÊ†∑Âºè...');
            
            // ‰ΩøÁî®CSSÁ±ªÂàáÊç¢ÔºàÊõ¥ÂèØÈù†Ôºâ
            modal.classList.remove('mobile-modal-hidden');
            modal.classList.add('mobile-modal-visible');
            
            // ÂêåÊó∂ËÆæÁΩÆÂÜÖËÅîÊ†∑Âºè‰Ωú‰∏∫ÂèåÈáç‰øùÈô©
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0, 0, 0, 0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
            document.body.style.overflow = 'hidden';
            
            console.log('‚úÖ ÂºπÁ™óÊ†∑ÂºèËÆæÁΩÆÂÆåÊàê - Á±ªÂêçÂíåÂÜÖËÅîÊ†∑ÂºèÂèåÈáçËÆæÁΩÆ');
        }
        
        // Âº∫Âà∂ÊòæÁ§∫ÂºπÁ™ó
        function forceShowModal(modal) {
            console.log('üî• Âº∫Âà∂ÊòæÁ§∫ÂºπÁ™ó');
            
            // ÂÆåÂÖ®ÈáçÁΩÆÊ†∑Âºè
            modal.removeAttribute('style');
            modal.removeAttribute('class');
            
            // ‰ΩøÁî® !important Âº∫Âà∂ÊòæÁ§∫
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.8) !important;
                z-index: 999999 !important;
                justify-content: center !important;
                align-items: center !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            console.log('üî• Âº∫Âà∂Ê†∑ÂºèÂ∫îÁî®ÂÆåÊàê');
        }
        
        // ÂæÆ‰ø°ÁéØÂ¢ÉÁâπÊÆä‰øÆÂ§ç
        function wechatModalFix(modal) {
            console.log('üîß ÂæÆ‰ø°ÁéØÂ¢É‰øÆÂ§ç');
            
            // ÂæÆ‰ø°ÊµèËßàÂô®ÂèØËÉΩÈúÄË¶ÅËß¶ÂèëÈáçÁªò
            modal.style.transform = 'translateZ(0)';
            modal.offsetHeight; // Âº∫Âà∂ÈáçÁªò
            modal.style.transform = '';
            
            // Á°Æ‰øùÂÜÖÂÆπÂÖÉÁ¥†‰πüÂèØËßÅ
            const content = modal.querySelector('.mobile-image-modal-content');
            if (content) {
                content.style.display = 'block';
                content.style.visibility = 'visible';
                content.style.opacity = '1';
                console.log('üîß ÂºπÁ™óÂÜÖÂÆπÂÖÉÁ¥†Ê†∑Âºè‰øÆÂ§çÂÆåÊàê');
            }
        }
        
        // Ê£ÄÊµãÊòØÂê¶‰∏∫ÂæÆ‰ø°ÊµèËßàÂô®
        function isWeChatBrowser() {
            return navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1;
        }

        function closeMobileImageModal() {
            console.log('üîÑ ÂÖ≥Èó≠ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó');
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                // ‰ΩøÁî®CSSÁ±ªÈöêËóè
                modal.classList.remove('mobile-modal-visible');
                modal.classList.add('mobile-modal-hidden');
                
                // ÂêåÊó∂ËÆæÁΩÆÂÜÖËÅîÊ†∑Âºè
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                
                // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
                document.body.style.overflow = 'auto';
                
                console.log('‚úÖ ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
            } else {
                console.error('‚ùå Êú™ÊâæÂà∞ÂºπÁ™óÂÖÉÁ¥†');
            }
        }

        // Ë∞ÉËØïÂáΩÊï∞ÔºöÊ£ÄÊü•ÂºπÁ™óÁä∂ÊÄÅ
        function debugModalState() {
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                console.log('ÂºπÁ™óÂÖÉÁ¥†Â≠òÂú®');
                console.log('ÂºπÁ™ódisplay:', window.getComputedStyle(modal).display);
                console.log('ÂºπÁ™ó‰ΩçÁΩÆ:', modal.getBoundingClientRect());
                console.log('ÂºπÁ™ózIndex:', window.getComputedStyle(modal).zIndex);
                console.log('Â±èÂπïÂ∞∫ÂØ∏:', window.innerWidth + 'x' + window.innerHeight);
            } else {
                console.error('ÂºπÁ™óÂÖÉÁ¥†‰∏çÂ≠òÂú®');
            }
        }

        // ÁßªÂä®Á´Ø - ËàåËØäÂõæÁâá‰∏ä‰º†
        function triggerMobileTongueUpload() {
            closeMobileImageModal();
            document.getElementById('mobileTongueUpload').click();
        }

        function handleMobileTongueUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // ÁßªÂä®Á´Ø - Èù¢ËØäÂõæÁâá‰∏ä‰º†
        function triggerMobileFaceUpload() {
            closeMobileImageModal();
            document.getElementById('mobileFaceUpload').click();
        }

        function handleMobileFaceUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // Êõ¥Êñ∞‰∏ä‰º†Áä∂ÊÄÅÊòæÁ§∫
        function updateUploadStatus() {
            const statusDiv = document.getElementById('uploadStatus');
            const tongueStatus = document.getElementById('tongueStatus').querySelector('span');
            const faceStatus = document.getElementById('faceStatus').querySelector('span');

            tongueStatus.textContent = tongueImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';
            faceStatus.textContent = faceImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';

            if (tongueImage || faceImage) {
                statusDiv.style.display = 'block';
            }
        }

        // Êõ¥Êñ∞ÁßªÂä®Á´Ø‰∏ä‰º†Áä∂ÊÄÅ
        function updateMobileUploadStatus() {
            const mobileTongueStatus = document.getElementById('mobileTongueStatus').querySelector('span');
            const mobileFaceStatus = document.getElementById('mobileFaceStatus').querySelector('span');

            mobileTongueStatus.textContent = tongueImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';
            mobileFaceStatus.textContent = faceImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';

            // Êõ¥Êñ∞Ëß¶ÂèëÊåâÈíÆÊñáÊú¨
            const uploadText = document.getElementById('mobileUploadText');
            const uploadedCount = (tongueImage ? 1 : 0) + (faceImage ? 1 : 0);
            if (uploadedCount > 0) {
                uploadText.textContent = `Â∑≤ÈÄâÊã© ${uploadedCount} Âº†ÂõæÁâá`;
            }
        }

        // Â§öÂõæÁâá‰∏ä‰º†Ê†∏ÂøÉÂáΩÊï∞
        async function uploadImages() {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂõæÁâáÈúÄË¶Å‰∏ä‰º†
            if (!tongueImage && !faceImage) {
                return;
            }

            // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                return;
            }

            const formData = new FormData();
            formData.append('conversation_id', currentConversationId);
            
            // Ê†πÊçÆÂõæÁâáÁ±ªÂûãÂàÜÂà´Ê∑ªÂä†
            if (tongueImage) {
                formData.append('tongue_image', tongueImage);
            }
            if (faceImage) {
                formData.append('face_image', faceImage);
            }

            try {
                // ÊûÑÂª∫‰∏ä‰º†ÊèêÁ§∫Ê∂àÊÅØ
                let uploadMessage = 'üì∑ Ê≠£Âú®ÂàÜÊûê';
                if (tongueImage && faceImage) {
                    uploadMessage += 'ËàåËØäÂíåÈù¢ËØäÂõæÁâá...';
                } else if (tongueImage) {
                    uploadMessage += 'ËàåËØäÂõæÁâá...';
                } else if (faceImage) {
                    uploadMessage += 'Èù¢ËØäÂõæÁâá...';
                }
                
                addMessage('user', uploadMessage);
                
                const response = await fetch('/analyze_images', {
                    method: 'POST',
                    body: formData,
                    // Ê∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂
                    signal: AbortSignal.timeout(120000), // 2ÂàÜÈíüË∂ÖÊó∂
                    headers: {
                        // ‰∏çËÆæÁΩÆContent-TypeÔºåËÆ©ÊµèËßàÂô®Ëá™Âä®ËÆæÁΩÆmultipart/form-data
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const analysisResult = `ÂõæÂÉèÂàÜÊûêÁªìÊûúÔºö
${data.analysis_result}`;  
                const shouldShowImageFeedback = containsPrescription(analysisResult);
                addMessage('ai', analysisResult, shouldShowImageFeedback);

                // ÂàÜÊûêÂÆåÊàêÂêéÊ∏ÖÁ©∫ÂõæÁâáÁºìÂ≠òÔºåÂÖÅËÆ∏Áî®Êà∑ÈáçÊñ∞‰∏ä‰º†
                resetImageUploads();

            } catch (error) {
                console.error('üì∑ ÂõæÂÉè‰∏ä‰º†ÂÆåÊï¥ÈîôËØØ‰ø°ÊÅØ:', error);
                
                let errorMessage = 'ÂõæÂÉèÂàÜÊûêÂ§±Ë¥•Ôºö';
                
                if (error.message.includes('502')) {
                    errorMessage += 'ÊúçÂä°Âô®ÊöÇÊó∂Êó†Ê≥ïÂ§ÑÁêÜËØ∑Ê±Ç (502)„ÄÇÂèØËÉΩÂéüÂõ†Ôºö\n';
                    errorMessage += '‚Ä¢ AIÊúçÂä°ÊöÇÊó∂ÁπÅÂøôÔºåËØ∑Á®çÂêéÈáçËØï\n';
                    errorMessage += '‚Ä¢ ÂõæÁâáÂ§ÑÁêÜË∂ÖÊó∂\n';
                    errorMessage += '‚Ä¢ ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                } else if (error.message.includes('timeout')) {
                    errorMessage += 'ËØ∑Ê±ÇË∂ÖÊó∂„ÄÇËØ∑Ê£ÄÊü•Ôºö\n';
                    errorMessage += '‚Ä¢ ÁΩëÁªúËøûÊé•ÊòØÂê¶Á®≥ÂÆö\n';
                    errorMessage += '‚Ä¢ ÂõæÁâáÂ§ßÂ∞èÊòØÂê¶ËøáÂ§ß\n';
                    errorMessage += '‚Ä¢ Á®çÂêéÈáçËØï';
                } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                    errorMessage += 'ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò„ÄÇËØ∑Ê£ÄÊü•Ôºö\n';
                    errorMessage += '‚Ä¢ ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n';
                    errorMessage += '‚Ä¢ ÊòØÂê¶‰ΩøÁî®‰∫Ü‰ª£ÁêÜÊàñVPN\n';
                    errorMessage += '‚Ä¢ Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï';
                } else {
                    errorMessage += error.message;
                }
                
                // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØÔºà‰ªÖÂú®ÂºÄÂèëÁéØÂ¢ÉÊòæÁ§∫Ôºâ
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    errorMessage += `\n\n[Ë∞ÉËØï‰ø°ÊÅØ]\nÂØπËØùID: ${currentConversationId}\nÈîôËØØÁ±ªÂûã: ${error.constructor.name}\nÊó∂Èó¥: ${new Date().toLocaleString()}`;
                }
                
                addMessage('ai', errorMessage);
                
                // ÈáçÁΩÆ‰∏ä‰º†Áä∂ÊÄÅÔºåÂÖÅËÆ∏Áî®Êà∑ÈáçËØï
                resetImageUploads();
            }
        }

        // ÈáçÁΩÆÂõæÁâá‰∏ä‰º†Áä∂ÊÄÅ
        function resetImageUploads() {
            tongueImage = null;
            faceImage = null;
            
            // ÈáçÁΩÆÊ°åÈù¢Á´ØÁïåÈù¢
            const tongueUploadArea = document.getElementById('tongueUploadArea');
            const faceUploadArea = document.getElementById('faceUploadArea');
            
            if (tongueUploadArea) {
                tongueUploadArea.classList.remove('has-file');
                tongueUploadArea.innerHTML = `
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">ÁÇπÂáª‰∏ä‰º†ËàåËØäÁÖßÁâá</div>
                `;
            }
            
            if (faceUploadArea) {
                faceUploadArea.classList.remove('has-file');
                faceUploadArea.innerHTML = `
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">ÁÇπÂáª‰∏ä‰º†Èù¢ËØäÁÖßÁâá</div>
                `;
            }

            // ÈöêËóè‰∏ä‰º†Áä∂ÊÄÅ
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }

            // ÈáçÁΩÆÁßªÂä®Á´ØÊåâÈíÆÊñáÊú¨
            const uploadText = document.getElementById('mobileUploadText');
            if (uploadText) {
                uploadText.textContent = '‰∏ä‰º†ËàåËãîÂíåÈù¢Ë±°ÁÖßÁâá';
            }
        }

        // ‰øùÁïôÂéüuploadImageÂáΩÊï∞‰Ωú‰∏∫ÂÖºÂÆπÊÄßÊîØÊåÅÔºàÂ∑≤Â∫üÂºÉ‰ΩøÁî®Ôºâ
        async function uploadImage(file) {
            console.warn('uploadImageÂáΩÊï∞Â∑≤Â∫üÂºÉÔºåËØ∑‰ΩøÁî®uploadImagesÂáΩÊï∞');
            // ÂèØÈÄâÔºö‰∏∫‰∫ÜÂÖºÂÆπÊÄßÔºåÂ∞ÜÂçïÂõæÁâáËΩ¨Êç¢‰∏∫Â§öÂõæÁâáÊ®°Âºè
            tongueImage = file; // ÂÅáËÆæÂçïÂõæÁâáÈªòËÆ§‰∏∫ËàåËØä
            uploadImages();
        }

        // ËØ≠Èü≥ÂäüËÉΩ
        function toggleVoiceRecording() {
            if (isVoiceRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        async function startVoiceRecording() {
                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processVoiceInput(audioBlob);
                };

                mediaRecorder.start();
                isVoiceRecording = true;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = 'ÂÅúÊ≠¢ÂΩïÈü≥';
                voiceBtn.classList.add('recording');

            } catch (error) {
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && isVoiceRecording) {
                mediaRecorder.stop();
                isVoiceRecording = false;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = 'ÂºÄÂßãËØ≠Èü≥ËæìÂÖ•';
                voiceBtn.classList.remove('recording');
            }
        }

        async function processVoiceInput(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'voice.webm');

                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/speech_to_text', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.text) {
                    document.getElementById('messageInput').value = data.text;
                    adjustTextareaHeight();
                }

            } catch (error) {
                addMessage('ai', `ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•Ôºö${error.message}`);
            }
        }

        // ËØ≠Èü≥ÂêàÊàê
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
            }
        }

        
        // Ê£ÄÊµãÂõûÂ§çÊòØÂê¶ÂåÖÂê´Â§ÑÊñπ
        function containsPrescription(text) {
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùtextÂèÇÊï∞ÊúâÊïà
            if (!text || typeof text !== 'string') {
                console.warn('containsPrescription: Êó†ÊïàÁöÑÊñáÊú¨ÂèÇÊï∞', text);
                return false;
            }
            
            // Â§ÑÊñπÂÖ≥ÈîÆËØçÊ£ÄÊµã
            const prescriptionKeywords = [
                'Â§ÑÊñπ', 'ÊñπÂâÇ', 'ËçØÊñπ', '‰∏≠ËçØ', 'ÊúçÁî®', 'ÁÖéÊúç', 'ÊØèÊó•', 'ÂÖã', 'g',
                'ÊñπÁî®', 'ÊñπÂèñ', 'ÁªÑÊàê', 'Áî®Ê≥ï', 'Áî®Èáè', 'ÁÖéÁÖÆ', 'ÊúçÊ≥ï',
                'ÂÖöÂèÇ', 'ÈªÑËä™', 'ÂΩìÂΩí', 'ÁôΩÊúØ', 'ËåØËãì', 'ÁîòËçâ', 'ÁîüÂú∞', 'ÁÜüÂú∞',
                'Â∑ùËäé', 'ÁôΩËäç', 'Êü¥ËÉ°', 'ÈªÑËä©', 'ÂçäÂ§è', 'ÈôàÁöÆ', 'Êû≥Â£≥', 'Ê°îÊ¢ó'
            ];
            
            // XMLÊ†ºÂºèÂ§ÑÊñπÊ£ÄÊµã
            const xmlPrescriptionPattern = /<prescription>.*?<\/prescription>/s;
            if (xmlPrescriptionPattern.test(text)) {
                return true;
            }
            
            // Ê†áÂáÜÂ§ÑÊñπÊ†ºÂºèÊ£ÄÊµã
            const standardPrescriptionPattern = /„ÄêÂ§ÑÊñπ„Äë|„ÄêÊñπÂâÇ„Äë|„ÄêËçØÊñπ„Äë|„Äê‰∏≠ËçØÂ§ÑÊñπ„Äë/;
            if (standardPrescriptionPattern.test(text)) {
                return true;
            }
            
            // ÂÖ≥ÈîÆËØçÁªÑÂêàÊ£ÄÊµã - Ëá≥Â∞ëÂåÖÂê´2‰∏™Â§ÑÊñπÁõ∏ÂÖ≥ËØçÊ±á
            let keywordCount = 0;
            for (const keyword of prescriptionKeywords) {
                if (text.includes(keyword)) {
                    keywordCount++;
                }
            }
            
            return keywordCount >= 2;
        }

        // ÂèçÈ¶àËØÑÂàÜ
        function rateFeedback(button, rating) {
            const ratingButtons = button.parentElement.querySelectorAll('.rating-btn');
            ratingButtons.forEach(btn => btn.disabled = true);
            
            button.style.backgroundColor = '#10b981';
            button.style.color = 'white';
            
            submitFeedback(rating);
        }

        async function submitFeedback(rating) {
                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            
            try {
                await fetch('/submit_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        rating: rating,
                        timestamp: new Date().toISOString()
                    }),
                });
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜÁ≥ªÁªü
        function saveCurrentDoctorHistory() {
            if (!selectedDoctor) return;
            
            try {
                const messages = [];
                
                // Ê£ÄÊµãÂΩìÂâçÊòØÁßªÂä®Á´ØËøòÊòØPCÁ´Ø
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                
                if (!messagesContainer) {
                    console.warn('Êú™ÊâæÂà∞Ê∂àÊÅØÂÆπÂô®ÔºåË∑≥Ëøá‰øùÂ≠ò');
                    return;
                }
                
                // ÊèêÂèñÊâÄÊúâÊ∂àÊÅØ
                messagesContainer.querySelectorAll('.message').forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    
                    if (textEl && textEl.innerHTML.trim()) {
                        messages.push({
                            type: isUser ? 'user' : 'ai',
                            content: textEl.innerHTML,
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: Date.now()
                        });
                    }
                });
                
                // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÂàô‰∏ç‰øùÂ≠ò
                if (messages.length === 0) {
                    console.log('Ê≤°ÊúâÊ∂àÊÅØÈúÄË¶Å‰øùÂ≠ò');
                    return;
                }
                
                // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÈáèÔºàÈò≤Ê≠¢localStorageÊ∫¢Âá∫Ôºâ
                const maxMessages = 50; // ÊúÄÂ§ö‰øùÂ≠ò50Êù°Ê∂àÊÅØ
                const trimmedMessages = messages.slice(-maxMessages);
                
                // ‰øùÂ≠òÂà∞localStorage
                const historyKey = `tcm_doctor_history_${selectedDoctor}`;
                const dataToSave = JSON.stringify({
                    messages: trimmedMessages,
                    lastUpdated: new Date().toISOString(),
                    doctor: selectedDoctor,
                    version: '2.1', // Â¢ûÂº∫ÁâàÊú¨Âè∑
                    saveCount: (JSON.parse(localStorage.getItem(historyKey) || '{}').saveCount || 0) + 1
                });
                
                // È™åËØÅlocalStorageÂèØÁî®ÊÄß
                if (typeof(Storage) === "undefined") {
                    console.error('ÊµèËßàÂô®‰∏çÊîØÊåÅlocalStorage');
                    return;
                }
                
                localStorage.setItem(historyKey, dataToSave);
                console.log(`‚úÖ Â∑≤‰øùÂ≠ò${selectedDoctor}ÂåªÁîüÁöÑ${trimmedMessages.length}Êù°ÂØπËØùËÆ∞ÂΩï (Á¨¨${JSON.parse(dataToSave).saveCount}Ê¨°‰øùÂ≠ò)`);
                
                // Á´ãÂç≥È™åËØÅ‰øùÂ≠òÊòØÂê¶ÊàêÂäü
                const savedData = localStorage.getItem(historyKey);
                if (!savedData) {
                    console.error('‚ùå ‰øùÂ≠òÈ™åËØÅÂ§±Ë¥•ÔºåÊï∞ÊçÆÊú™Ê≠£Á°ÆÂ≠òÂÇ®');
                    // Â∞ùËØïÈáçÊñ∞‰øùÂ≠ò
                    setTimeout(() => {
                        localStorage.setItem(historyKey, dataToSave);
                        console.log('üîÑ ÈáçËØï‰øùÂ≠òÂÆåÊàê');
                    }, 100);
                } else {
                    console.log('‚úÖ ‰øùÂ≠òÈ™åËØÅÊàêÂäü');
                }
                
                // Ê£ÄÊü•localStorage‰ΩøÁî®ÊÉÖÂÜµ
                checkLocalStorageUsage();
                
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊòØÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÂ∞ùËØïÊ∏ÖÁêÜÊóßËÆ∞ÂΩï
                if (error.name === 'QuotaExceededError') {
                    cleanOldHistoryRecords();
                    // ÈáçËØï‰øùÂ≠òÔºàÂè™‰øùÂ≠òÊúÄËøëÁöÑÊ∂àÊÅØÔºâ
                    try {
                        const recentMessages = messages.slice(-20);
                        const historyKey = `tcm_doctor_history_${selectedDoctor}`;
                        localStorage.setItem(historyKey, JSON.stringify({
                            messages: recentMessages,
                            lastUpdated: new Date().toISOString(),
                            doctor: selectedDoctor,
                            version: '2.0'
                        }));
                        console.log(`Á©∫Èó¥‰∏çË∂≥ÔºåÂ∑≤‰øùÂ≠òÊúÄËøë${recentMessages.length}Êù°ËÆ∞ÂΩï`);
                    } catch (retryError) {
                        console.error('ÈáçËØï‰øùÂ≠ò‰πüÂ§±Ë¥•:', retryError);
                    }
                }
            }
        }
        
        function loadDoctorHistory(doctorKey) {
            const historyKey = `tcm_doctor_history_${doctorKey}`;
            const storedHistory = localStorage.getItem(historyKey);
            
            // Ê£ÄÊµãÂΩìÂâçÊòØÁßªÂä®Á´ØËøòÊòØPCÁ´Ø
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            if (!messagesContainer) return;
            
            // Ê∏ÖÁ©∫ÂΩìÂâçÊ∂àÊÅØ
            messagesContainer.innerHTML = '';
            
            // ÁßªÂä®Á´ØÈúÄË¶ÅÈáçÁΩÆÊ†∑Âºè
            if (isMobile) {
                messagesContainer.style.display = 'block';
                messagesContainer.style.alignItems = 'flex-start';
                messagesContainer.style.justifyContent = 'flex-start';
            }
            
            if (storedHistory) {
                try {
                    let historyData = JSON.parse(storedHistory);
                    let messages = [];
                    
                    // ÂÖºÂÆπÊóßÊ†ºÂºèÂíåÊñ∞Ê†ºÂºè
                    if (Array.isArray(historyData)) {
                        // ÊóßÊ†ºÂºèÔºöÁõ¥Êé•ÊòØÊ∂àÊÅØÊï∞ÁªÑ
                        messages = historyData;
                        console.log(`Âä†ËΩΩ${doctorKey}ÂåªÁîüÁöÑ${messages.length}Êù°ÂéÜÂè≤ËÆ∞ÂΩïÔºàÊóßÊ†ºÂºèÔºâ`);
                    } else if (historyData.messages && Array.isArray(historyData.messages)) {
                        // Êñ∞Ê†ºÂºèÔºöÂåÖÂê´ÂÖÉÊï∞ÊçÆÁöÑÂØπË±°
                        messages = historyData.messages;
                        console.log(`Âä†ËΩΩ${doctorKey}ÂåªÁîüÁöÑ${messages.length}Êù°ÂéÜÂè≤ËÆ∞ÂΩïÔºà${historyData.version || '1.0'}ÁâàÊú¨ÔºåÊúÄÂêéÊõ¥Êñ∞Ôºö${historyData.lastUpdated}Ôºâ`);
                    } else {
                        throw new Error('Êú™Áü•ÁöÑÂéÜÂè≤ËÆ∞ÂΩïÊ†ºÂºè');
                    }
                    
                    // ÊÅ¢Â§çÂéÜÂè≤Ê∂àÊÅØ
                    messages.forEach(msg => {
                        // ÂØπ‰∫éAIÊ∂àÊÅØÔºåÊ£ÄÊµãÊòØÂê¶ÂåÖÂê´Â§ÑÊñπ‰ª•ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ËØÑ‰ª∑Á≥ªÁªü
                        const shouldShowFeedback = msg.type === 'ai' && containsPrescription(msg.content);
                        
                        if (isMobile) {
                            addMobileMessage(msg.type, msg.content, shouldShowFeedback);
                        } else {
                            addMessageWithTime(msg.type, msg.content, msg.time, shouldShowFeedback);
                        }
                    });
                    
                    // Â¶ÇÊûúÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÂú®ÊéßÂà∂Âè∞ÊòæÁ§∫Êõ¥Â§ö‰ø°ÊÅØ
                    if (messages.length > 0) {
                        console.log(`ÂéÜÂè≤ËÆ∞ÂΩïËØ¶ÊÉÖ: Á¨¨‰∏ÄÊù°Ê∂àÊÅØÊó∂Èó¥=${messages[0].time}, ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÊó∂Èó¥=${messages[messages.length-1].time}`);
                    }
                    
                } catch (error) {
                    console.error('Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                    console.log('ÂéüÂßãÊï∞ÊçÆ:', storedHistory.substring(0, 200) + '...');
                    addWelcomeMessage(doctorKey);
                }
            } else {
                // Ê≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                console.log(`${doctorKey}ÂåªÁîüÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ`);
                addWelcomeMessage(doctorKey);
            }
        }
        
        function addWelcomeMessage(doctorKey) {
            const doctor = doctors[doctorKey];
            const isMobile = window.innerWidth <= 768;
            const welcomeMessage = `ÊÇ®Â•ΩÔºÅÊàëÊòØ${doctor.name}Ôºå${doctor.school}‰º†‰∫∫„ÄÇËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÔºåÊàëÂ∞Ü‰∏∫ÊÇ®ËøõË°å‰∏ì‰∏öÁöÑ‰∏≠ÂåªÂàÜÊûê„ÄÇ`;
            
            if (isMobile) {
                addMobileMessage('ai', welcomeMessage);
            } else {
                addMessage('ai', welcomeMessage);
            }
        }
        
        function addMessageWithTime(sender, content, timeStr, showFeedback = false) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'üë§' : (selectedDoctor ? doctors[selectedDoctor].avatar : 'ü§ñ')}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    <div class="message-time">${timeStr}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">Ëøô‰∏™ÂõûÁ≠îÊúâÂ∏ÆÂä©ÂêóÔºü</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">üòä ÂæàÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">üëç ‰∏çÈîô</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">üëå ËøòË°å</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">üëé ‰∏çÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">üòû ÂæàÂ∑Æ</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Âä†ËΩΩÂØπËØùÂéÜÂè≤ - ÊåâÁî®Êà∑Á±ªÂûãÈöîÁ¶ª
        function loadConversationHistory() {
            const pageType = getPageType();
            const userId = getCurrentUserId();
            const storageKey = `conversationId_${pageType}_${userId}`;
            
            // Â∞ùËØïÂä†ËΩΩÂΩìÂâçÁî®Êà∑Á±ªÂûãÁöÑÂØπËØùID
            const storedId = localStorage.getItem(storageKey);
            if (storedId) {
                currentConversationId = storedId;
                console.log(`Â∑≤Âä†ËΩΩ${pageType}Áî®Êà∑(${userId})ÁöÑÂØπËØùID: ${currentConversationId}`);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂ≠òÂÇ®ÁöÑIDÔºåÁîüÊàêÊñ∞ÁöÑ
                generateConversationId();
                console.log(`‰∏∫${pageType}Áî®Êà∑(${userId})ÁîüÊàêÊñ∞ÂØπËØùID: ${currentConversationId}`);
            }
            
            // Â¶ÇÊûúÊúâÈÄâ‰∏≠ÁöÑÂåªÁîüÔºåÂä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï
            if (selectedDoctor) {
                loadDoctorHistory(selectedDoctor);
            }
        }

        // ÁßªÂä®Á´ØÈ°µÈù¢ÂàáÊç¢
        function showMobileChatPage() {
            if (window.innerWidth <= 768) {
                const container = document.getElementById('mobilePageContainer');
                container.classList.add('show-chat');
                
            }
        }
        
        function showMobileDoctorPage() {
            if (window.innerWidth <= 768) {
                document.getElementById('mobilePageContainer').classList.remove('show-chat');
            }
        }

        // ÁßªÂä®Á´ØÂåªÁîüÈÄâÊã©
        function selectMobileDoctor(doctorKey) {
            // ‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤
            if (selectedDoctor && selectedDoctor !== doctorKey) {
                saveCurrentDoctorHistory();
            }
            
            selectedDoctor = doctorKey;
            const doctor = doctors[doctorKey];
            
            // Êõ¥Êñ∞ÁßªÂä®Á´ØÂåªÁîü‰ø°ÊÅØ
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // ÁîüÊàêÊñ∞ÁöÑÂØπËØùIDÔºåÂº∫Âà∂ÂºÄÂßãÊñ∞ÂØπËØù
            generateConversationId();
            
            // Áõ¥Êé•Âä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ÂØπËØùÔºàloadDoctorHistory‰ºöËá™Âä®Ê∏ÖÁ©∫ÂÆπÂô®Ôºâ
            loadDoctorHistory(doctorKey);
            
            // ÂàáÊç¢Âà∞ËÅäÂ§©È°µÈù¢
            showMobileChatPage();
            
            // Á°Æ‰øùËæìÂÖ•Ê°ÜÂèØËßÅ
            setTimeout(() => ensureMobileInputVisible(), 500);
        }

        // ÁßªÂä®Á´ØÊ∏≤ÊüìÂåªÁîüÂç°Áâá
        function renderMobileDoctorCards() {
            const container = document.getElementById('mobileDoctorsGrid');
            container.innerHTML = '';

            Object.entries(doctors).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'mobile-doctor-card';
                card.onclick = () => selectMobileDoctor(key);
                
                card.innerHTML = `
                    <div class="mobile-doctor-info">
                        <div class="mobile-doctor-avatar">${doctor.avatar}</div>
                        <div class="mobile-doctor-details">
                            <h3>${doctor.name}</h3>
                            <div class="school">${doctor.school}</div>
                        </div>
                    </div>
                    <div class="mobile-doctor-specialty">
                        <strong>ÊìÖÈïøÔºö</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // ÁßªÂä®Á´ØÊ∑ªÂä†Ê∂àÊÅØ
        function addMobileMessage(sender, content, showFeedback = false) {
            const container = document.getElementById('mobileMessagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Ê†ºÂºèÂåñAIÂõûÂ§çÂÜÖÂÆπÔºå‰øùÊåÅÊç¢Ë°åÂíåÊéíÁâà
            let formattedContent = content;
            if (sender === 'ai') {
                formattedContent = content
                    // ÂÖàÂ§ÑÁêÜÊ†áÈ¢òÔºàÂú®Êç¢Ë°åËΩ¨Êç¢ÂâçÔºâ
                    .replace(/### (.*?)(\n|$)/g, '<h4 style="color: #2d5aa0; margin: 15px 0 8px 0; font-size: 16px; font-weight: bold;">$1</h4>\n')
                    .replace(/## (.*?)(\n|$)/g, '<h3 style="color: #2d5aa0; margin: 18px 0 10px 0; font-size: 18px; font-weight: bold;">$1</h3>\n')
                    // Â§ÑÁêÜÂä†Á≤óÊñáÊú¨
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #333; font-weight: bold;">$1</strong>')
                    // Â§ÑÁêÜÂàÜÂâ≤Á∫ø
                    .replace(/---/g, '<hr style="border: none; border-top: 1px solid #e5e7eb; margin: 15px 0;">')
                    // Â§ÑÁêÜË°åÂÜÖ‰ª£Á†Å
                    .replace(/`([^`]+)`/g, '<code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px; font-family: monospace; color: #374151;">$1</code>')
                    // ÊúÄÂêéÂ§ÑÁêÜÊç¢Ë°åÔºàËøôÊ†∑ÂèØ‰ª•‰øùÁïôÊ†áÈ¢òÂêéÁöÑÊç¢Ë°åÔºâ
                    .replace(/\n/g, '<br>')
                    // Â§ÑÁêÜÂàóË°®È°πÔºàÊç¢Ë°åÂêéÂ§ÑÁêÜÔºâ
                    .replace(/<br>(\d+\. )/g, '<br><span style="color: #10b981; font-weight: bold;">$1</span>')
                    .replace(/^(\d+\. )/g, '<span style="color: #10b981; font-weight: bold;">$1</span>')
                    .replace(/<br>(- )/g, '<br><span style="color: #10b981;">‚Ä¢ </span>')
                    .replace(/^(- )/g, '<span style="color: #10b981;">‚Ä¢ </span>');
            }
            
            const messageContent = `
                <div class="message-content">
                    <div class="message-text">${formattedContent}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">Ëøô‰∏™ÂõûÁ≠îÊúâÂ∏ÆÂä©ÂêóÔºü</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">üòä ÂæàÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">üëç ‰∏çÈîô</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">üëå ËøòË°å</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">üëé ‰∏çÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">üòû ÂæàÂ∑Æ</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            container.appendChild(messageDiv);
            
            // Âπ≥ÊªëÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // Ëá™Âä®‰øùÂ≠òÁßªÂä®Á´ØÂØπËØùÂéÜÂè≤
            if (selectedDoctor) {
                setTimeout(() => saveCurrentDoctorHistory(), 200); // Âª∂Ëøü200msÁ°Æ‰øùDOMÂíåÊªöÂä®ÈÉΩÂÆåÊàê
            }
        }

        // ÁßªÂä®Á´ØÂèëÈÄÅÊ∂àÊÅØ
        async function sendMobileMessage() {
            const input = document.getElementById('mobileMessageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰ΩçÂåªÂ∏à');
                }
                return;
            }

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMobileMessage('user', message);
            input.value = '';
            adjustMobileTextareaHeight();

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const sendBtn = document.getElementById('mobileSendBtn');
            sendBtn.disabled = true;
            
            // Ê∑ªÂä†"Ê≠£Âú®ÂàÜÊûê"ÁöÑ‰∏¥Êó∂Ê∂àÊÅØ
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message ai loading-message';
            loadingMessage.innerHTML = `
                <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f4f6; border-radius: 50%; border-top: 2px solid #667eea; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                AIÊ≠£Âú®ÂàÜÊûêÊÇ®ÁöÑÁóáÁä∂...
            `;
            const container = document.getElementById('mobileMessagesContainer');
            container.appendChild(loadingMessage);
            container.scrollTop = container.scrollHeight;

            // ÂàõÂª∫Â∏¶Ë∂ÖÊó∂ÁöÑAbortController
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 45000); // 45ÁßíË∂ÖÊó∂

                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/api/consultation/chat-legacy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                if (data.reply) {
                    // Êô∫ËÉΩÂà§Êñ≠ÊòØÂê¶ÊòæÁ§∫ËØÑ‰ª∑Á≥ªÁªü - Âè™ÊúâÂåÖÂê´Â§ÑÊñπÊó∂ÊâçÊòæÁ§∫
                    const shouldShowFeedback = containsPrescription(data.reply);
                    addMobileMessage('ai', data.reply, shouldShowFeedback);
                    
                    // ËÆ∞ÂΩïËØäÊñ≠Èò∂ÊÆµ
                    if (shouldShowFeedback) {
                        console.log('ÁßªÂä®Á´ØÊ£ÄÊµãÂà∞Â§ÑÊñπÂÜÖÂÆπÔºåÊòæÁ§∫ÁÇπËØÑÂäüËÉΩ');
                    } else {
                        console.log('ÁßªÂä®Á´ØÊôÆÈÄöÂØπËØùÔºå‰∏çÊòæÁ§∫ÁÇπËØÑ');
                    }
                } else {
                    addMobileMessage('ai', 'Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïÂõûÁ≠îÊÇ®ÁöÑÈóÆÈ¢òÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
                }
                
                // ‰øùÂ≠òÁßªÂä®Á´ØÂØπËØùÂéÜÂè≤
                setTimeout(() => saveCurrentDoctorHistory(), 100);

            } catch (error) {
                console.error('Mobile API Error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                let errorMsg = 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = 'ÁΩëÁªúËøûÊé•ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÂÜçËØï';
                } else if (error.message.includes('HTTP error')) {
                    errorMsg = `ÊúçÂä°Âô®ÈîôËØØ: ${error.message}`;
                } else {
                    errorMsg = `ËøûÊé•Â§±Ë¥•: ${error.message}`;
                }
                
                addMobileMessage('ai', errorMsg);
            } finally {
                sendBtn.disabled = false;
            }
        }

        // ÁßªÂä®Á´ØËæìÂÖ•Ê°ÜÈ´òÂ∫¶Ë∞ÉÊï¥
        function adjustMobileTextareaHeight() {
            const textarea = document.getElementById('mobileMessageInput');
            if (!textarea) return;
            
            textarea.style.height = '44px'; // ÈáçÁΩÆ‰∏∫ÊúÄÂ∞èÈ´òÂ∫¶
            const newHeight = Math.min(textarea.scrollHeight, 100);
            textarea.style.height = newHeight + 'px';
        }

        // ÁßªÂä®Á´ØÈîÆÁõò‰∫ã‰ª∂
        function handleMobileKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMobileMessage();
            }
        }
        
        
        // ÁßªÂä®Á´ØËæìÂÖ•Ê°ÜÁÑ¶ÁÇπÂ§ÑÁêÜ
        function ensureMobileInputVisible() {
            const input = document.getElementById('mobileMessageInput');
            const container = document.getElementById('mobileMessagesContainer');
            const inputContainer = document.querySelector('.mobile-input-container');
            
            if (container) {
                // ÊªöÂä®Ê∂àÊÅØÂÆπÂô®Âà∞Â∫ïÈÉ®ÔºåÁ°Æ‰øùËæìÂÖ•Ê°ÜÂå∫ÂüüÂèØËßÅ
                container.scrollTop = container.scrollHeight;
            }
            
            if (inputContainer) {
                // Á°Æ‰øùËæìÂÖ•ÂÆπÂô®ÂèØËßÅ
                setTimeout(() => {
                    inputContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 200);
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÁßªÂä®Á´Ø
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                renderMobileDoctorCards();
                // ÁßªÂä®Á´Ø‰∏çËÆæÁΩÆÈªòËÆ§ÂåªÁîüÔºåËÆ©Áî®Êà∑‰∏ªÂä®ÈÄâÊã©
                // setMobileDefaultDoctor('zhang_zhongjing');
                
            }
        });
        
        // ÁßªÂä®Á´ØËÆæÁΩÆÈªòËÆ§ÂåªÁîü
        function setMobileDefaultDoctor(doctorKey) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // Êõ¥Êñ∞ÁßªÂä®Á´ØÂåªÁîü‰ø°ÊÅØ
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // Ê∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØÂà∞ÁßªÂä®Á´Ø
            const mobileContainer = document.getElementById('mobileMessagesContainer');
            if (mobileContainer && !mobileContainer.querySelector('.message')) {
                addMobileMessage('ai', `ÊÇ®Â•ΩÔºÅÊàëÊòØ${doctor.name}Ôºå${doctor.school}‰º†‰∫∫„ÄÇËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÔºåÊàëÂ∞Ü‰∏∫ÊÇ®ËøõË°å‰∏ì‰∏öÁöÑ‰∏≠ÂåªÂàÜÊûê„ÄÇ`);
            }
        }
    </script>
    
    <!-- ÂºÄÂèëË∞ÉËØï‰ø°ÊÅØÔºà‰ªÖÂºÄÂèëÊ®°ÂºèÊòæÁ§∫Ôºâ -->
    <div id="mobileVersionInfo" style="display: none; position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 20px; font-size: 11px; z-index: 1000; border: 1px solid rgba(255,255,255,0.2);">
        <span style="color: #4fc3f7;">TCM v1.2.4</span> | 
        <a href="/static/wechat_debug.html" style="color: #81c784; text-decoration: none;">ÁΩëÁªúËØäÊñ≠</a> | 
        <a href="javascript:location.reload(true)" style="color: #ffb74d; text-decoration: none;">Âà∑Êñ∞</a> |
        <span style="color: #f48fb1; cursor: pointer;" onclick="this.parentElement.style.display='none'">√ó</span>
    </div>
    
    <script>
        // Ë∞ÉËØïÊ®°ÂºèÊ£ÄÊµã - Âè™ÊúâÂú®ÁâπÂÆöÊù°‰ª∂‰∏ãÊâçÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
        function isDebugMode() {
            // Ê£ÄÊµãURLÂèÇÊï∞„ÄÅÂºÄÂèëÁéØÂ¢ÉÁ≠â
            const urlParams = new URLSearchParams(window.location.search);
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const hasDebugParam = urlParams.has('debug');
            const isDevPort = window.location.port === '7789' || window.location.port === '3000';
            
            return isLocalhost || hasDebugParam || isDevPort;
        }
        
        // Ê∑ªÂä†ÁâπÊÆäÊâãÂäøÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØÁöÑÂäüËÉΩÔºà‰ªÖ‰æõÂºÄÂèëË∞ÉËØïÔºâ
        let clickSequence = [];
        let debugVisible = false;
        
        document.addEventListener('click', function(e) {
            // ËÆ∞ÂΩïÁÇπÂáª‰ΩçÁΩÆÔºàÂàÜ‰∏∫9ÂÆ´Ê†ºÔºâ
            const x = Math.floor(e.clientX / (window.innerWidth / 3));
            const y = Math.floor(e.clientY / (window.innerHeight / 3));
            const position = y * 3 + x;
            
            clickSequence.push(position);
            if (clickSequence.length > 5) clickSequence.shift();
            
            // ÁâπÊÆäÂ∫èÂàóÔºöÂ∑¶‰∏ä-Âè≥‰∏ä-Â∑¶‰∏ã-Âè≥‰∏ã-‰∏≠ÂøÉ (0-2-6-8-4)
            const debugSequence = [0, 2, 6, 8, 4];
            const isDebugSequence = clickSequence.length === 5 && 
                clickSequence.every((pos, idx) => pos === debugSequence[idx]);
            
            if (isDebugSequence && (isDebugMode() || window.location.hostname.includes('dev'))) {
                debugVisible = !debugVisible;
                document.getElementById('mobileVersionInfo').style.display = debugVisible ? 'block' : 'none';
                clickSequence = [];
                
                if (debugVisible) {
                    setTimeout(() => {
                        document.getElementById('mobileVersionInfo').style.display = 'none';
                        debugVisible = false;
                    }, 10000);
                }
            }
            
            // Ê∏ÖÁ©∫Â∫èÂàó
            setTimeout(() => { clickSequence = []; }, 3000);
        });
        // ÁΩëÁªúÁä∂ÊÄÅÊ£ÄÊµã
        function checkNetworkStatus() {
            if (!navigator.onLine) {
                addMobileMessage('ai', 'üîå Ê£ÄÊµãÂà∞ÁΩëÁªúËøûÊé•‰∏≠Êñ≠ÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËÆæÁΩÆ„ÄÇ');
                return false;
            }
            return true;
        }
        
        // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅÂèòÂåñ
        window.addEventListener('online', function() {
            console.log('Network is back online');
        });
        
        window.addEventListener('offline', function() {
            console.log('Network is offline');
            addMobileMessage('ai', 'üîå ÁΩëÁªúËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËÆæÁΩÆ„ÄÇ');
        });
    </script>

    <!-- ÂæÆ‰ø°ÂàÜ‰∫´Â¢ûÂº∫ËÑöÊú¨ -->
    <script>
        // ÂæÆ‰ø°ÁéØÂ¢ÉÊ£ÄÊµã
        function isWechat() {
            return /MicroMessenger/i.test(navigator.userAgent);
        }
        
        // Ê£ÄÊµãÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Êù•Ê∫ê
        function detectWechatSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromWechat = urlParams.get('from') === 'wechat';
            const wechatSource = urlParams.get('source') || 'unknown';
            
            return {
                fromWechat: fromWechat,
                source: wechatSource,
                isWechatBrowser: isWechat()
            };
        }
        
        // Â§ÑÁêÜÂæÆ‰ø°ÂÖ¨‰ºóÂè∑ËÆøÈóÆ
        function handleWechatPublicAccount() {
            const wechatInfo = detectWechatSource();
            
            if (wechatInfo.fromWechat || wechatInfo.isWechatBrowser) {
                console.log('ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Áî®Êà∑ËÆøÈóÆÔºåÊù•Ê∫ê:', wechatInfo.source);
                
                // ËÆ∞ÂΩïÂæÆ‰ø°ËÆøÈóÆÁªüËÆ°
                fetch('/api/log_wechat_visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: wechatInfo.source,
                        from_wechat: wechatInfo.fromWechat,
                        is_wechat_browser: wechatInfo.isWechatBrowser,
                        timestamp: new Date().toISOString(),
                        page: 'main_app'
                    })
                }).catch(err => console.log('ÂæÆ‰ø°ËÆøÈóÆËÆ∞ÂΩïÂ§±Ë¥•:', err));
                
                // ÊòæÁ§∫ÂæÆ‰ø°‰∏ìÂ±ûÊ¨¢Ëøé‰ø°ÊÅØ
                if (wechatInfo.fromWechat && wechatInfo.source === 'menu') {
                    setTimeout(() => showWechatWelcome(), 1000);
                }
                
                // ÂæÆ‰ø°ÂÜÖ‰ºòÂåñÔºöÈöêËóè‰∏çÂøÖË¶ÅÁöÑÂàÜ‰∫´ÊåâÈíÆ
                if (wechatInfo.isWechatBrowser) {
                    const shareButtons = document.querySelectorAll('.share-button, .external-share');
                    shareButtons.forEach(btn => btn.style.display = 'none');
                }
            }
        }
        
        // ÊòæÁ§∫ÂæÆ‰ø°‰∏ìÂ±ûÊ¨¢Ëøé‰ø°ÊÅØ
        function showWechatWelcome() {
            const welcomeHTML = `
                <div id="wechatWelcome" style="
                    position: fixed; 
                    top: 60px; 
                    left: 50%; 
                    transform: translateX(-50%); 
                    background: linear-gradient(135deg, #28a745, #20c997); 
                    color: white; 
                    padding: 12px 20px; 
                    border-radius: 25px; 
                    font-size: 13px; 
                    z-index: 9999;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    animation: slideInDown 0.6s ease-out;
                    text-align: center;
                    max-width: 280px;
                ">
                    üéâ Ê¨¢Ëøé‰ªéÂÖ¨‰ºóÂè∑ËÆøÈóÆÔºÅ<br>
                    <small>5Â§ß‰∏≠ÂåªÊµÅÊ¥æÔºå‰∏ì‰∏öAIÈóÆËØä</small>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', welcomeHTML);
            
            // 4ÁßíÂêéÊ∑°Âá∫
            setTimeout(() => {
                const welcome = document.getElementById('wechatWelcome');
                if (welcome) {
                    welcome.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    welcome.style.opacity = '0';
                    welcome.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => welcome.remove(), 500);
                }
            }, 4000);
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÂæÆ‰ø°ÂäüËÉΩ
        document.addEventListener('DOMContentLoaded', function() {
            handleWechatPublicAccount();
        });
        
        // ‰ºòÂåñÂæÆ‰ø°ÂàÜ‰∫´
        if (isWechat()) {
            // Âä®ÊÄÅËÆæÁΩÆÂàÜ‰∫´‰ø°ÊÅØ
            document.title = "AI‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã";
            
            // Ê∑ªÂä†ÂæÆ‰ø°ÂàÜ‰∫´ÂÖÉ‰ø°ÊÅØ
            var metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.content = "‰∏ì‰∏öAI‰∏≠ÂåªËØäÊñ≠Âä©ÊâãÔºåÊô∫ËÉΩÁóáÁä∂ÂàÜÊûêÔºåËØÅÂÄôÂà§Êñ≠Ôºå‰∏™ÊÄßÂåñÊñπÂâÇÊé®Ëçê";
            }
            
            // ËÆ∞ÂΩïÂæÆ‰ø°ÂàÜ‰∫´ÁªüËÆ°
            window.addEventListener('load', function() {
                fetch('/api/wechat_visit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        page: 'main_app',
                        is_shared: document.referrer.includes('wechat'),
                        timestamp: new Date().toISOString()
                    })
                }).catch(() => {});
            });
            
            // È°µÈù¢ÂÖ≥Èó≠ÊàñÂà∑Êñ∞Êó∂‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
            window.addEventListener('beforeunload', function(event) {
                // Á°Æ‰øùÂú®È°µÈù¢ÂÖ≥Èó≠Ââç‰øùÂ≠òÂΩìÂâçÂØπËØùÂéÜÂè≤
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('È°µÈù¢ÂÖ≥Èó≠ÂâçÂ∑≤‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
            
            // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂‰πü‰øùÂ≠òÔºàÂ∫îÂØπÊâãÊú∫ÂàáÊç¢Â∫îÁî®Á≠âÂú∫ÊôØÔºâ
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('È°µÈù¢ÈöêËóèÊó∂Â∑≤‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
            
            // Â¢ûÂº∫ÂéÜÂè≤ËÆ∞ÂΩï‰øùÊä§ - ÂÆöÊúüËá™Âä®‰øùÂ≠ò
            setInterval(() => {
                if (selectedDoctor) {
                    const messagesContainer = document.getElementById(window.innerWidth <= 768 ? 'mobileMessagesContainer' : 'messagesContainer');
                    if (messagesContainer && messagesContainer.children.length > 0) {
                        saveCurrentDoctorHistory();
                        console.log('ÂÆöÊúüËá™Âä®‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                    }
                }
            }, 30000); // ÊØè30ÁßíËá™Âä®‰øùÂ≠ò‰∏ÄÊ¨°
            
            // ÊµèËßàÂô®ÁÑ¶ÁÇπÂèòÂåñÊó∂‰øùÂ≠ò
            window.addEventListener('blur', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('ÊµèËßàÂô®Â§±ÂéªÁÑ¶ÁÇπÊó∂‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
            
            // È°µÈù¢Âç∏ËΩΩÂâçÂº∫Âà∂‰øùÂ≠ò
            window.addEventListener('pagehide', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('È°µÈù¢Âç∏ËΩΩÂâç‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
        }
        
        // localStorageÁÆ°ÁêÜÂäüËÉΩ
        function checkLocalStorageUsage() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length + key.length;
                    }
                }
                const sizeInMB = (totalSize / 1024 / 1024).toFixed(2);
                console.log(`LocalStorage‰ΩøÁî®Èáè: ${sizeInMB}MB`);
                
                // Â¶ÇÊûúË∂ÖËøá4MBÔºåÂèëÂá∫Ë≠¶Âëä
                if (totalSize > 4 * 1024 * 1024) {
                    console.warn('LocalStorage‰ΩøÁî®ÈáèËæÉÂ§ßÔºåÂèØËÉΩÈúÄË¶ÅÊ∏ÖÁêÜ');
                }
            } catch (error) {
                console.error('Ê£ÄÊü•localStorage‰ΩøÁî®ÈáèÂ§±Ë¥•:', error);
            }
        }
        
        function cleanOldHistoryRecords() {
            try {
                const keys = Object.keys(localStorage);
                const historyKeys = keys.filter(key => key.startsWith('tcm_doctor_history_'));
                
                // Â¶ÇÊûúÊúâË∂ÖËøá10‰∏™ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºåÊ∏ÖÁêÜÊúÄÊóßÁöÑ
                if (historyKeys.length > 10) {
                    const keysWithTime = historyKeys.map(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            const lastUpdated = data.lastUpdated || data.timestamp || 0;
                            return { key, lastUpdated };
                        } catch {
                            return { key, lastUpdated: 0 };
                        }
                    });
                    
                    // ÊåâÊó∂Èó¥ÊéíÂ∫èÔºåÂà†Èô§ÊúÄÊóßÁöÑ
                    keysWithTime.sort((a, b) => new Date(a.lastUpdated) - new Date(b.lastUpdated));
                    const keysToDelete = keysWithTime.slice(0, historyKeys.length - 8); // ‰øùÁïôÊúÄÊñ∞8‰∏™
                    
                    keysToDelete.forEach(({ key }) => {
                        localStorage.removeItem(key);
                        console.log(`Â∑≤Ê∏ÖÁêÜÊóßÂéÜÂè≤ËÆ∞ÂΩï: ${key}`);
                    });
                }
            } catch (error) {
                console.error('Ê∏ÖÁêÜÊóßÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
            }
        }
        
        // ÂéÜÂè≤ËÆ∞ÂΩïËØäÊñ≠ÂäüËÉΩ
        function diagnoseHistoryIssues() {
            console.log('=== ÂéÜÂè≤ËÆ∞ÂΩïËØäÊñ≠ ===');
            console.log('ÂΩìÂâçÂåªÁîü:', selectedDoctor);
            console.log('ÊµèËßàÂô®‰ø°ÊÅØ:', navigator.userAgent);
            console.log('Â±èÂπïÂ∞∫ÂØ∏:', window.innerWidth + 'x' + window.innerHeight);
            
            const keys = Object.keys(localStorage);
            const historyKeys = keys.filter(key => key.startsWith('tcm_doctor_history_'));
            console.log('ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè:', historyKeys.length);
            
            historyKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = JSON.parse(data);
                    const messageCount = Array.isArray(parsed) ? parsed.length : (parsed.messages ? parsed.messages.length : 0);
                    console.log(`${key}: ${messageCount}Êù°Ê∂àÊÅØ, Â§ßÂ∞è=${(data.length/1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error(`${key}: Êï∞ÊçÆÊçüÂùè`, error);
                }
            });
            
            checkLocalStorageUsage();
            
            // ÊµãËØïlocalStorageÂÜôÂÖ•
            try {
                const testKey = 'tcm_test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                console.log('‚úÖ localStorageÂÜôÂÖ•ÊµãËØïÊàêÂäü');
            } catch (error) {
                console.error('‚ùå localStorageÂÜôÂÖ•ÊµãËØïÂ§±Ë¥•:', error);
            }
        }

        // ÈóÆËØäÊåáÂØºÂäüËÉΩ
        function showGuidance() {
            const overlay = document.createElement('div');
            overlay.className = 'guidance-overlay';
            overlay.onclick = hideGuidance;
            document.body.appendChild(overlay);
            
            document.getElementById('guidanceTips').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideGuidance() {
            document.getElementById('guidanceTips').style.display = 'none';
            const overlay = document.querySelector('.guidance-overlay');
            if (overlay) {
                overlay.remove();
            }
            document.body.style.overflow = 'auto';
        }

        function toggleGuidance() {
            hideGuidance();
        }
    </script>

    <!-- ÈóÆËØäÊåáÂØºÊèêÁ§∫ -->
    <div class="guidance-tips" id="guidanceTips" style="display: none;">
        <div class="tips-header">
            <h4>üí° ÈóÆËØäÊåáÂØº</h4>
            <button onclick="toggleGuidance()" class="close-btn">√ó</button>
        </div>
        <div class="tips-content">
            <div class="tip-section">
                <h5>üîç ‰∏ªË¶ÅÁóáÁä∂ÊèèËø∞</h5>
                <ul>
                    <li>‰∏ªË¶Å‰∏çÈÄÇÊÑüËßâÔºàÁñºÁóõ„ÄÅÂèëÁÉ≠„ÄÅÂí≥ÂóΩÁ≠âÔºâ</li>
                    <li>ÁóáÁä∂ÊåÅÁª≠Êó∂Èó¥ÔºàÂá†Â§©„ÄÅÂá†Âë®„ÄÅÂá†‰∏™ÊúàÔºâ</li>
                    <li>ÁóáÁä∂Á®ãÂ∫¶ÔºàËΩªÂæÆ„ÄÅ‰∏≠Á≠â„ÄÅ‰∏•ÈáçÔºâ</li>
                    <li>Âèë‰ΩúËßÑÂæãÔºàÊåÅÁª≠ÊÄß„ÄÅÈó¥Ê≠áÊÄß„ÄÅÁâπÂÆöÊó∂Èó¥Ôºâ</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>ü©∫ ‰º¥ÈöèÁóáÁä∂</h5>
                <ul>
                    <li>Áù°Áú†ÊÉÖÂÜµÔºàÂÖ•Áù°Âõ∞Èöæ„ÄÅÊòìÈÜí„ÄÅÂ§öÊ¢¶Ôºâ</li>
                    <li>È£üÊ¨≤Áä∂ÂÜµÔºàÈ£üÊ¨≤‰∏çÊåØ„ÄÅÊ∂àÂåñ‰∏çËâØÔºâ</li>
                    <li>Â§ßÂ∞è‰æøÊÉÖÂÜµÔºà‰æøÁßò„ÄÅËÖπÊ≥ª„ÄÅÂ∞øÈ¢ëÁ≠âÔºâ</li>
                    <li>ÊÉÖÁª™Áä∂ÊÄÅÔºàÁÑ¶Ëôë„ÄÅÊäëÈÉÅ„ÄÅÁÉ¶Ë∫ÅÔºâ</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>üëÖ ËàåË±°ËÑâË±°ÔºàÂ¶ÇÊûúÊñπ‰æøÔºâ</h5>
                <ul>
                    <li>ËàåÂ§¥È¢úËâ≤ÔºàÊ∑°Á∫¢„ÄÅÁ∫¢„ÄÅÊöóÁ∫¢Ôºâ</li>
                    <li>ËàåËãîÊÉÖÂÜµÔºàËñÑÁôΩ„ÄÅÂéöÈªÑ„ÄÅÊó†ËãîÁ≠âÔºâ</li>
                    <li>ËÑâÊêèÊÑüËßâÔºàÂø´ÊÖ¢„ÄÅÂº∫Âº±„ÄÅËßÑÂæãÊÄßÔºâ</li>
                    <li>ÂèØ‰∏ä‰º†ËàåË±°ÁÖßÁâá‰ª•‰æøÊõ¥ÂáÜÁ°ÆËØäÊñ≠</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>üìã ÂÖ∂‰ªñÈáçË¶Å‰ø°ÊÅØ</h5>
                <ul>
                    <li>Êó¢ÂæÄÁóÖÂè≤ÔºàÊÖ¢ÊÄßÁóÖ„ÄÅÊâãÊúØÂè≤Ôºâ</li>
                    <li>ËøáÊïèÂè≤ÔºàËçØÁâ©„ÄÅÈ£üÁâ©ËøáÊïèÔºâ</li>
                    <li>ÁõÆÂâçÁî®ËçØÊÉÖÂÜµ</li>
                    <li>ÁîüÊ¥ª‰π†ÊÉØÔºà‰ΩúÊÅØ„ÄÅÈ•ÆÈ£ü„ÄÅËøêÂä®Ôºâ</li>
                </ul>
            </div>
            
            <div class="tip-footer">
                <p>üí¨ <strong>ÊèêÁ§∫</strong>ÔºöÊèê‰æõË∂äËØ¶ÁªÜÁöÑ‰ø°ÊÅØÔºåÂåªÁîüË∂äËÉΩÁªôÂá∫ÂáÜÁ°ÆÁöÑËØäÊñ≠ÂíåÊ≤ªÁñóÂª∫ËÆÆ</p>
            </div>
        </div>
    </div>
    
    <!-- ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó - ÁßªËá≥bodyÂ∫ïÈÉ®Á°Æ‰øùÊúÄÈ´òÂ±ÇÁ∫ß -->
    <div class="mobile-image-modal mobile-modal-hidden" id="mobileImageModal">
        <div class="mobile-image-modal-content">
            <div class="modal-header">
                <h3>ÈÄâÊã©ÊãçÁÖßÁ±ªÂûã</h3>
                <button onclick="closeMobileImageModal()" class="modal-close">√ó</button>
            </div>
            <div class="modal-options">
                <button onclick="triggerMobileTongueUpload()" class="image-option-btn">
                    <div class="option-icon">üëÖ</div>
                    <div class="option-text">
                        <strong>ËàåËØäÊãçÁÖß</strong>
                        <span>ÊãçÊëÑËàåÂ§¥ÁÖßÁâá</span>
                    </div>
                </button>
                <button onclick="triggerMobileFaceUpload()" class="image-option-btn">
                    <div class="option-icon">üòä</div>
                    <div class="option-text">
                        <strong>Èù¢ËØäÊãçÁÖß</strong>
                        <span>ÊãçÊëÑÈù¢ÈÉ®ÁÖßÁâá</span>
                    </div>
                </button>
            </div>
            <div class="upload-status-mobile" id="mobileUploadStatus">
                <div class="mobile-status-item" id="mobileTongueStatus">üëÖ ËàåËØä: <span>Êú™‰∏ä‰º†</span></div>
                <div class="mobile-status-item" id="mobileFaceStatus">üòä Èù¢ËØä: <span>Êú™‰∏ä‰º†</span></div>
            </div>
        </div>
    </div>
</body>
</html>