<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å¯è§†åŒ–å†³ç­–æ ‘æ„å»ºå™¨ v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .sidebar {
            width: 336px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .canvas-area {
            flex: 1;
            background: #f9fafb;
            border-radius: 8px;
            position: relative;
            overflow: auto;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            min-height: 600px;
            border: 2px solid #e5e7eb;
        }

        .canvas-toolbar {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 100;
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .canvas-tool-btn {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .canvas-tool-btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }

        .canvas-tool-btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        .canvas-tool-btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
        }

        .canvas-tool-btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        .canvas-tool-btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        }

        .canvas-tool-btn-primary:hover {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .canvas-tool-btn:active {
            transform: translateY(0);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn-group.full-width {
            grid-template-columns: 1fr;
        }

        .canvas {
            width: 100%;
            height: 100%;
            position: relative;
            padding: 20px;
            background: #fafbfc;
        }

        .canvas svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .branch-line {
            stroke: #3b82f6;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .branch-line.selected {
            stroke: #ef4444;
            stroke-width: 3;
        }

        .node {
            position: absolute;
            width: 220px;
            min-height: 80px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .node:hover {
            border-color: #3b82f6;
        }

        .node.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .node.condition { 
            border-left: 4px solid #0ea5e9; 
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        }
        .node.diagnosis { 
            border-left: 4px solid #22c55e; 
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
        }
        .node.treatment { 
            border-left: 4px solid #ec4899; 
            background: linear-gradient(135deg, #ffffff 0%, #fdf2f8 100%);
        }
        .node.formula { 
            border-left: 4px solid #a855f7; 
            background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%);
        }
        .node.symptom { 
            border-left: 4px solid #f59e0b; 
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
        }
        .node.pathogenesis { 
            border-left: 4px solid #dc2626; 
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
        }
        .node.syndrome { 
            border-left: 4px solid #059669; 
            background: linear-gradient(135deg, #ffffff 0%, #ecfdf5 100%);
        }
        .node.principle { 
            border-left: 4px solid #7c3aed; 
            background: linear-gradient(135deg, #ffffff 0%, #f5f3ff 100%);
        }
        .node.prescription { 
            border-left: 4px solid #be185d; 
            background: linear-gradient(135deg, #ffffff 0%, #fdf2f8 100%);
        }

        .node-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            color: #1f2937;
            text-align: center;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .node-content {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        .node-content.truncated {
            max-height: 72px;
            overflow: hidden;
            position: relative;
        }
        .node-content.truncated::after {
            content: '...';
            position: absolute;
            bottom: 0;
            right: 0;
            background: white;
            padding-left: 10px;
            color: #9ca3af;
        }
        .expand-btn {
            color: #3b82f6;
            cursor: pointer;
            font-size: 11px;
            margin-top: 4px;
            text-decoration: underline;
            display: block;
            text-align: center;
            padding: 2px 0;
            border-top: 1px solid #f3f4f6;
        }
        .expand-btn:hover {
            color: #1d4ed8;
            background: #f8fafc;
        }
        
        /* èŠ‚ç‚¹ç±»å‹å›¾æ ‡ */
        .node-type-icon {
            display: inline-block;
            margin-right: 4px;
            font-size: 16px;
            vertical-align: middle;
        }

        /* ç›¸å…³ç—‡çŠ¶æ ·å¼ */
        .related-symptoms {
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            border-left: 3px solid #3b82f6;
        }

        .symptoms-label {
            font-size: 10px;
            color: #3b82f6;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .symptoms-list {
            font-size: 10px;
            color: #1e40af;
            line-height: 1.3;
        }

        .node-desc {
            margin-top: 5px;
            font-size: 10px;
            color: #9ca3af;
            font-style: italic;
        }

        .empty-canvas {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            text-align: center;
        }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
        }

        .auth-bar {
            position: static;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            color: white;
            padding: 10px 20px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container.with-auth {
            height: 100vh;
        }

        .suggestion-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .suggestion-content {
            font-weight: 500;
            color: #1e40af;
            margin-bottom: 4px;
        }

        .suggestion-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: #f8fafc;
        }

        .context-menu-item.danger {
            color: #ef4444;
        }

        .context-menu-item.danger:hover {
            background: #fef2f2;
        }

        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .node:hover .delete-btn {
            display: flex;
        }

        .formula-analysis-panel {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .herb-item {
            display: inline-block;
            background: white;
            border: 1px solid #0ea5e9;
            border-radius: 15px;
            padding: 4px 8px;
            margin: 2px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .herb-item:hover {
            background: #0ea5e9;
            color: white;
        }

        .apply-formula-btn {
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }

        .apply-formula-btn:hover {
            background: #16a34a;
        }

        .auto-analysis-panel {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .pathway-step {
            background: white;
            border-left: 4px solid #3b82f6;
            padding: 10px;
            margin: 8px 0;
            border-radius: 0 6px 6px 0;
        }

        .add-pathway-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        /* AIæ¨¡å¼åˆ‡æ¢å¼€å…³æ ·å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
        }
        
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        
        .toggle-label {
            display: block;
            width: 50px;
            height: 24px;
            background-color: #cbd5e0;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input[type="checkbox"]:checked + .toggle-label {
            background-color: #3b82f6;
        }
        
        .toggle-switch input[type="checkbox"]:checked + .toggle-label .toggle-slider {
            transform: translateX(26px);
        }
        
        /* æ•°æ®æ¥æºæ ‡è¯†æ ·å¼ */
        .data-source-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-source-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .data-source-template {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .data-source-fallback {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #8b4513;
        }
        
        /* ç”ŸæˆçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .generation-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        
        .generation-status.ai-mode {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }
        
        .generation-status.template-mode {
            background: #fef3f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }
    </style>
</head>
<body>
    <div id="authBar"></div>
    <div class="container" id="mainContainer">
        <!-- å·¦ä¾§å·¥å…·æ  -->
        <div class="sidebar">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="section-title">ğŸ¥ åŸºæœ¬ä¿¡æ¯</div>
            <div class="form-group">
                <label class="form-label">ç–¾ç—…åç§°</label>
                <input type="text" class="form-input" id="diseaseName" placeholder="å¦‚ï¼šå¤±çœ ã€èƒƒç—›ã€å¤´ç—›">
            </div>
            <div class="form-group">
                <label class="form-label">è¯Šç–—æ€è·¯</label>
                <textarea class="form-input form-textarea" id="doctorThought" placeholder="ç®€è¿°æ‚¨çš„è¯Šç–—æ€è·¯..."></textarea>
            </div>

            <!-- AIåŠŸèƒ½ -->
            <div class="section-title">ğŸ¤– æ™ºèƒ½åŠŸèƒ½</div>
            
            <!-- AIæ¨¡å¼é€‰æ‹© -->
            <div class="ai-mode-selector" style="margin-bottom: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="font-weight: 500; color: #374151;">ç”Ÿæˆæ¨¡å¼:</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="aiModeToggle" checked>
                        <label for="aiModeToggle" class="toggle-label">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <span id="aiModeText" style="font-size: 12px; color: #6b7280;">AIæ™ºèƒ½æ¨¡å¼</span>
                </div>
                <div id="aiStatusInfo" style="font-size: 11px; color: #9ca3af;">
                    <span id="aiStatusIndicator">â³ æ£€æŸ¥AIçŠ¶æ€ä¸­...</span>
                </div>
            </div>
            
            <div class="btn-group full-width">
                <button class="btn btn-primary" id="generateBtn">
                    <span id="generateBtnIcon">ğŸ¤–</span>
                    <span id="generateBtnText">æ™ºèƒ½ç”Ÿæˆå†³ç­–æ ‘</span>
                </button>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="saveToLibraryBtn" style="background: #7c3aed;">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-secondary" id="viewHistoryBtn" style="background: #6b7280;">ğŸ“‹ å†å²</button>
            </div>

            <!-- æˆ‘çš„å†³ç­–æ ‘å†å² -->
            <div id="myTreesSection" style="display: none; margin-top: 15px;">
                <div class="section-title">ğŸ“š æˆ‘çš„å†³ç­–æ ‘</div>
                <div id="myTreesList" style="max-height: 300px; overflow-y: auto; background: white; border-radius: 8px; padding: 10px;">
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“‚</div>
                        <div style="font-size: 12px;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- æ‰¹é‡å¯¼å‡ºåŠŸèƒ½ -->
            <div class="section-title">ğŸ“¦ æ‰¹é‡å¯¼å‡º</div>
            <div class="btn-group full-width">
                <button class="btn btn-primary" id="exportAllBtn" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                    ğŸ“¥ å¯¼å‡ºæ‰€æœ‰å†³ç­–æ ‘
                </button>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px; padding-left: 10px;">
                ğŸ’¡ ä¸€æ¬¡æ€§å¯¼å‡ºæ‚¨çš„æ‰€æœ‰å†³ç­–æ ‘
            </div>

            <!-- æ•°æ®åˆ†æåŠŸèƒ½ -->
            <div class="section-title">ğŸ“Š æ•°æ®åˆ†æ</div>
            <div class="btn-group full-width">
                <button class="btn btn-primary" id="viewUsageStatsBtn"
                        style="background: linear-gradient(135deg, #10b981, #059669); border: none;">
                    ğŸ“ˆ æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡
                </button>
            </div>

            <!-- é€‰ä¸­èŠ‚ç‚¹ä¿¡æ¯ -->
            <div id="selectedNodeInfo" style="display: none;">
                <div class="section-title">ğŸ“ é€‰ä¸­èŠ‚ç‚¹</div>
                <div class="result-panel">
                    <div id="nodeInfoContent"></div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="header">
                <h1 style="color: #1e40af; margin-bottom: 10px;">ğŸŒ³ å¯è§†åŒ–å†³ç­–æ ‘æ„å»ºå™¨</h1>
                <p style="color: #6b7280; font-size: 14px;">æ„å»ºä¸­åŒ»æ™ºèƒ½è¯Šç–—å†³ç­–æ ‘ï¼Œæ”¯æŒAIç”Ÿæˆå’Œå¯è§†åŒ–ç¼–è¾‘</p>
            </div>

            <!-- ç”ŸæˆçŠ¶æ€å’Œæ•°æ®æ¥æºæ˜¾ç¤º -->
            <div id="generationStatusPanel" class="generation-status" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="dataSourceBadge" class="data-source-badge data-source-template">Template</span>
                        <span id="generationInfo">å·²ä½¿ç”¨æ ‡å‡†æ¨¡æ¿ç”Ÿæˆ</span>
                    </div>
                    <div style="font-size: 10px; color: #6b7280;">
                        <span id="generationTime">å³æ—¶</span>
                    </div>
                </div>
            </div>

            <!-- åˆ†æç»“æœåŒºåŸŸ -->
            <div id="analysisResultsContainer" style="display: none; margin-bottom: 15px;">
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleAnalysisResults()">
                        <div style="color: white; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ“Š åˆ†æç»“æœ</span>
                            <span id="analysisResultsBadge" style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 12px; font-size: 11px;"></span>
                        </div>
                        <span id="analysisResultsToggle" style="color: white; font-size: 18px;">â–¼</span>
                    </div>
                    <div id="analysisResultsContent" style="max-height: 300px; overflow-y: auto; padding: 15px;">
                        <div id="analysisResults"></div>
                    </div>
                </div>
            </div>

            <div class="canvas-area">
                <!-- ç”»å¸ƒå³ä¸Šè§’çš„æ“ä½œæŒ‰é’®ç»„ -->
                <div id="canvasToolbar" class="canvas-toolbar" style="display: none;">
                    <button id="arrangeBtn" class="canvas-tool-btn canvas-tool-btn-success" title="è‡ªåŠ¨æ’åˆ—èŠ‚ç‚¹">
                        ğŸ“ æ’åˆ—
                    </button>
                    <button id="clearBtn" class="canvas-tool-btn canvas-tool-btn-danger" title="æ¸…ç©ºç”»å¸ƒ">
                        ğŸ—‘ï¸ æ¸…ç©º
                    </button>
                    <button id="exportCurrentBtn" class="canvas-tool-btn canvas-tool-btn-primary" title="å¯¼å‡ºå½“å‰å†³ç­–æ ‘">
                        ğŸ“¥ å¯¼å‡º
                    </button>
                </div>

                <div class="canvas" id="canvas">
                    <svg id="branchSvg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" />
                            </marker>
                        </defs>
                    </svg>
                    <div class="empty-canvas" id="emptyHint">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸŒ³</div>
                        <h3>å¼€å§‹æ„å»ºæ‚¨çš„å†³ç­–æ ‘</h3>
                        <p style="margin: 10px 0;">è¾“å…¥ç–¾ç—…åç§°ï¼Œç„¶åç‚¹å‡»"AIç”Ÿæˆå†³ç­–æ ‘"</p>
                        <p style="color: #9ca3af; font-size: 12px;">æˆ–ç‚¹å‡»"æ ‡å‡†è·¯å¾„"å¿«é€Ÿå¼€å§‹</p>
                    </div>
                </div>
                <div class="loading" id="loading" style="display: none;">
                    <div class="loading-content">
                        <div class="spinner"></div>
                        <div id="loadingText">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ä½¿ç”¨ç»Ÿè®¡å¼¹çª— -->
    <div id="usageStatsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ“Š</span>
                    <span>å†³ç­–æ ‘ä½¿ç”¨ç»Ÿè®¡</span>
                </h2>
                <span class="close" onclick="closeUsageStatsModal()" style="color: white; cursor: pointer; font-size: 28px;">&times;</span>
            </div>

            <div class="modal-body" style="padding: 20px;">
                <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 10px;">
                        <button class="time-filter-btn active" data-range="all" onclick="filterByTimeRange('all')">å…¨éƒ¨</button>
                        <button class="time-filter-btn" data-range="today" onclick="filterByTimeRange('today')">ä»Šæ—¥</button>
                        <button class="time-filter-btn" data-range="week" onclick="filterByTimeRange('week')">æœ¬å‘¨</button>
                        <button class="time-filter-btn" data-range="month" onclick="filterByTimeRange('month')">æœ¬æœˆ</button>
                    </div>
                    <button class="btn btn-sm" onclick="refreshUsageStats()" style="background: #6b7280; color: white;">ğŸ”„ åˆ·æ–°</button>
                </div>

                <!-- æ€»ä½“ç»Ÿè®¡ -->
                <div id="overallStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- å†³ç­–æ ‘åˆ—è¡¨ -->
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
                        <h3 style="margin: 0; color: #1f2937; font-size: 16px;">ğŸ“‹ å†³ç­–æ ‘è¯¦ç»†ç»Ÿè®¡</h3>
                    </div>
                    <div id="patternStatsList" style="padding: 15px;">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨è¯¦æƒ…å¼¹çª— -->
    <div id="usageDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 20px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ”</span>
                    <span id="detailModalTitle">ä½¿ç”¨è¯¦æƒ…</span>
                </h2>
                <span class="close" onclick="closeUsageDetailModal()" style="color: white; cursor: pointer; font-size: 28px;">&times;</span>
            </div>

            <div class="modal-body" style="padding: 20px;">
                <div id="usageDetailContent">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“‹ å†å²å†³ç­–æ ‘å¼¹çª— -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 20px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ“‹</span>
                    <span>æˆ‘çš„å†³ç­–æ ‘å†å²</span>
                </h2>
                <span class="close" onclick="closeHistoryModal()" style="color: white; cursor: pointer; font-size: 28px;">&times;</span>
            </div>

            <div class="modal-body" style="padding: 20px;">
                <div id="historyListContainer">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px;">â³</div>
                        <div style="margin-top: 10px;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        .close:hover {
            opacity: 0.8;
        }

        /* æ—¶é—´ç­›é€‰æŒ‰é’® */
        .time-filter-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .time-filter-btn:hover {
            background: #f3f4f6;
        }

        .time-filter-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }

        .stat-card .stat-unit {
            font-size: 14px;
            opacity: 0.8;
        }

        /* å†³ç­–æ ‘ç»Ÿè®¡é¡¹ */
        .pattern-stat-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }

        .pattern-stat-item:hover {
            background: #f9fafb;
        }

        .pattern-stat-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }
    </style>

    <script>
        // å…¨å±€å˜é‡
        let nodes = [];
        let selectedNode = null;
        let nodeCounter = 1;
        let isAuthenticated = false;
        let currentUser = null;
        let connections = [];
        let symptomClusters = new Map(); // ç—‡çŠ¶ç¾¤å­˜å‚¨
        
        // ç—‡çŠ¶ç¾¤æ•°æ®ç»“æ„
        const SYMPTOM_CLUSTER_TEMPLATES = {
            'å¤±çœ ç¾¤': {
                mainDisease: 'å¤±çœ ',
                icon: 'ğŸ˜´',
                color: '#8b5cf6',
                relatedSymptoms: ['æ—©é†’', 'å¤šæ¢¦', 'å…¥ç¡å›°éš¾', 'ç¡çœ æµ…', 'æ˜“æƒŠé†’'],
                accompanyingSymptoms: ['å¿ƒçƒ¦', 'å¥å¿˜', 'å¤´æ™•', 'ç–²ä¹']
            },
            'èƒƒç—›ç¾¤': {
                mainDisease: 'èƒƒç—›',
                icon: 'ğŸ¤¢',
                color: '#f59e0b',
                relatedSymptoms: ['èƒƒèƒ€', 'åé…¸', 'å—³æ°”', 'æ¶å¿ƒ', 'èƒƒè„ç–¼ç—›'],
                accompanyingSymptoms: ['é£Ÿæ¬²ä¸æŒ¯', 'ä¹åŠ›', 'è…¹èƒ€', 'ä¾¿ç§˜']
            }
        };

        // è¾…åŠ©å‡½æ•°ï¼šè·å–ç–¾ç—…åç§°
        function getCurrentDiseaseName() {
            const value = document.getElementById('diseaseName')?.value?.trim() || '';
            // æ¼”ç¤ºï¼šæ·»åŠ è¾“å…¥éªŒè¯
            if (value && value.length < 2) {
                console.warn('ç–¾ç—…åç§°è¿‡çŸ­ï¼Œå»ºè®®è‡³å°‘2ä¸ªå­—ç¬¦');
                return '';
            }
            return value;
        }

        // å…¨å±€AIçŠ¶æ€å˜é‡
        let aiStatus = {
            ai_enabled: false,
            available: false,
            model: 'unknown',
            features: {
                decision_tree_generation: false,
                theory_analysis: false,
                hybrid_mode: false
            }
        };
        
        // ç”¨æˆ·æ¨¡å¼åå¥½
        let userPreferences = {
            aiModePreferred: true,
            complexityLevel: 'standard'
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
            
            // åˆå§‹åŒ–AIçŠ¶æ€æ£€æŸ¥
            initializeAIStatus();
            
            // åˆå§‹åŒ–æ¨¡å¼åˆ‡æ¢
            initializeModeToggle();
            
            console.log('æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨:');
            console.log('generateBtn:', document.getElementById('generateBtn'));
            console.log('analyzeBtn:', document.getElementById('analyzeBtn'));
            console.log('diseaseName:', document.getElementById('diseaseName'));
            
            // ç®€å•æµ‹è¯•ï¼šç›´æ¥ç»‘å®šä¸€ä¸ªç®€å•çš„ç‚¹å‡»äº‹ä»¶
            const testBtn = document.getElementById('generateBtn');
            if (testBtn) {
                console.log('å°è¯•ç»‘å®šç®€å•æµ‹è¯•äº‹ä»¶...');
                testBtn.onclick = function() {
                    console.log('ç®€å•ç‚¹å‡»äº‹ä»¶å·¥ä½œæ­£å¸¸!');
                    alert('æŒ‰é’®ç‚¹å‡»æˆåŠŸ!');
                    return false;
                };
            }
            
            // ä½¿ç”¨ç«‹å³æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°æ¥å¤„ç†åˆå§‹åŒ–
            (async () => {
                try {
                    await initializeAuth();  // âš ï¸ å¿…é¡»ç­‰å¾…è®¤è¯å®Œæˆ
                    initializeEventListeners();
                    checkURLParameters();
                    console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ(å«è®¤è¯)');
                } catch (error) {
                    console.error('âŒ é¡µé¢åˆå§‹åŒ–å‡ºé”™:', error);
                }
            })();
        });

        // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
        async function initializeAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('ğŸ” å¼€å§‹è®¤è¯åˆå§‹åŒ–...');
            console.log('   URLå‚æ•°:', {
                auto_auth: urlParams.get('auto_auth'),
                has_doctor_token: !!urlParams.get('doctor_token'),
                doctor_name: urlParams.get('doctor_name')
            });

            if (urlParams.get('auto_auth') === '1') {
                const doctorToken = urlParams.get('doctor_token');
                const doctorName = decodeURIComponent(urlParams.get('doctor_name') || '');

                console.log('ğŸ”‘ URLè‡ªåŠ¨è®¤è¯æ¨¡å¼');

                if (doctorToken && doctorName) {
                    console.log('âœ… ä¿å­˜tokenåˆ°localStorage');
                    localStorage.setItem('token', doctorToken);
                    localStorage.setItem('doctorToken', doctorToken);
                    localStorage.setItem('doctorName', doctorName);

                    // æ¸…ç†URLå‚æ•°
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);

                    // âš ï¸ é‡è¦:éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
                    await checkExistingAuth();
                } else {
                    console.warn('âš ï¸ URLå‚æ•°ä¸å®Œæ•´ï¼Œfallbackåˆ°æ£€æŸ¥ç°æœ‰è®¤è¯');
                    await checkExistingAuth();
                }
            } else {
                console.log('ğŸ” æ£€æŸ¥ç°æœ‰è®¤è¯...');
                await checkExistingAuth();
            }
        }

        // æ£€æŸ¥ç°æœ‰è®¤è¯çŠ¶æ€
        async function checkExistingAuth() {
            const token = localStorage.getItem('token');
            console.log('ğŸ” æ£€æŸ¥è®¤è¯çŠ¶æ€:', {
                hasToken: !!token,
                tokenPreview: token ? token.substring(0, 20) + '...' : 'null'
            });

            // å¼ºåˆ¶ç™»å½•æ£€æŸ¥
            if (!token) {
                console.warn('âš ï¸ æœªæ‰¾åˆ°tokenï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
                showLoginRequired();
                return;
            }

            try {
                const response = await fetch('/api/auth/doctor/current', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… è®¤è¯æˆåŠŸ:', data);

                    // éªŒè¯æ˜¯å¦ä¸ºåŒ»ç”Ÿè§’è‰²
                    if (data.role !== 'doctor') {
                        alert('âš ï¸ æ­¤é¡µé¢ä»…é™åŒ»ç”Ÿè´¦æˆ·è®¿é—®');
                        redirectToLogin();
                        return;
                    }

                    showAuthStatus(data.name, true);
                    isAuthenticated = true;
                    currentUser = data;

                    // ğŸ”§ ä¿®å¤: æ¯æ¬¡è®¤è¯æˆåŠŸåéƒ½åŠ è½½åŒ»ç”Ÿçš„å†å²å†³ç­–æ ‘
                    // æ— è®ºæ˜¯é¦–æ¬¡ç™»å½•è¿˜æ˜¯é¡µé¢åˆ·æ–°,éƒ½ç¡®ä¿æ•°æ®æ˜¾ç¤º
                    console.log('ğŸ”„ è®¤è¯æˆåŠŸ,å¼€å§‹åŠ è½½å†å²å†³ç­–æ ‘...');
                    await loadDoctorHistoryTrees();
                    console.log('âœ… å†å²å†³ç­–æ ‘åŠ è½½å®Œæˆ');
                } else {
                    // Tokenæ— æ•ˆï¼Œè·³è½¬ç™»å½•
                    console.warn('âŒ è®¤è¯å¤±è´¥:', response.status, response.statusText);
                    try {
                        const errorData = await response.json();
                        console.warn('é”™è¯¯è¯¦æƒ…:', errorData);
                    } catch(e) {}
                    redirectToLogin();
                }
            } catch (error) {
                console.error('âŒ è®¤è¯æ£€æŸ¥å¼‚å¸¸:', error);
                redirectToLogin();
            }
        }

        // æ˜¾ç¤ºéœ€è¦ç™»å½•çš„æç¤º
        function showLoginRequired() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            overlay.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”</div>
                    <h2 style="color: #1e40af; margin-bottom: 15px; font-size: 24px;">éœ€è¦åŒ»ç”Ÿè´¦æˆ·ç™»å½•</h2>
                    <p style="color: #6b7280; margin-bottom: 30px; line-height: 1.6;">
                        å¯è§†åŒ–å†³ç­–æ ‘æ„å»ºå™¨æ˜¯åŒ»ç”Ÿä¸“ç”¨å·¥å…·<br>
                        è¯·ä½¿ç”¨åŒ»ç”Ÿè´¦æˆ·ç™»å½•åè®¿é—®
                    </p>
                    <button onclick="redirectToLogin()"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                   color: white;
                                   border: none;
                                   padding: 12px 32px;
                                   border-radius: 8px;
                                   font-size: 16px;
                                   font-weight: 600;
                                   cursor: pointer;
                                   box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                        å‰å¾€åŒ»ç”Ÿç™»å½•
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        function redirectToLogin() {
            // ä¿å­˜å½“å‰é¡µé¢URLï¼Œç™»å½•åå¯ä»¥è¿”å›
            localStorage.setItem('returnUrl', window.location.href);
            // è·³è½¬åˆ°åŒ»ç”Ÿç™»å½•é¡µé¢
            window.location.href = '/doctor/login';
        }

        // æ˜¾ç¤ºè®¤è¯çŠ¶æ€
        function showAuthStatus(doctorName, isLoggedIn) {
            const authBar = document.getElementById('authBar');
            const container = document.getElementById('mainContainer');
            
            if (isLoggedIn) {
                authBar.className = 'auth-bar';
                authBar.innerHTML = `
                    âœ… å·²ç™»å½•åŒ»ç”Ÿ: ${doctorName} | å†³ç­–æ ‘å°†è‡ªåŠ¨ä¿å­˜åˆ°æ‚¨çš„è´¦æˆ·
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 12px; border-radius: 4px; margin-left: 20px; cursor: pointer; font-size: 12px;">é€€å‡ºç™»å½•</button>
                `;
                container.classList.add('with-auth');
                isAuthenticated = true;
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            // æ¸…é™¤æ‰€æœ‰è®¤è¯ä¿¡æ¯
            localStorage.removeItem('token');
            localStorage.removeItem('doctorToken');
            localStorage.removeItem('doctorName');
            localStorage.removeItem('userData');
            localStorage.removeItem('returnUrl');

            // æ¸…é™¤çŠ¶æ€
            isAuthenticated = false;
            currentUser = null;

            // æ¸…ç©ºç”»å¸ƒ
            clearCanvas();

            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = '/doctor/login';
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            try {
                // AIåŠŸèƒ½æŒ‰é’®
                // ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æŒ‰é’®
                const generateBtn = document.getElementById('generateBtn');
                if (generateBtn) generateBtn.addEventListener('click', generateAITree);
                
                const extractPrescriptionBtn = document.getElementById('extractPrescriptionBtn');
                if (extractPrescriptionBtn) extractPrescriptionBtn.addEventListener('click', extractPrescriptionInfo);
                
                // ğŸ”¬ é«˜çº§åˆ†æåŠŸèƒ½  
                const formulaAnalyzeBtn = document.getElementById('formulaAnalyzeBtn');
                if (formulaAnalyzeBtn) formulaAnalyzeBtn.addEventListener('click', analyzeFormula);
                
                // ğŸ’¾ æ€ç»´åº“åŠŸèƒ½
                const saveToLibraryBtn = document.getElementById('saveToLibraryBtn');
                if (saveToLibraryBtn) {
                    saveToLibraryBtn.addEventListener('click', saveToThinkingLibrary);
                }
                
                // å¿«é€Ÿæ“ä½œæŒ‰é’®
                const addPathBtn = document.getElementById('addPathBtn');
                if (addPathBtn) addPathBtn.addEventListener('click', addStandardPath);
                
                const arrangeBtn = document.getElementById('arrangeBtn');
                if (arrangeBtn) {
                    arrangeBtn.onclick = function(e) {
                        e.preventDefault();
                        console.log('arrangeBtnè¢«ç‚¹å‡»äº†!');
                        autoArrangeNodes();
                        return false;
                    };
                }
                
                const clearBtn = document.getElementById('clearBtn');
                if (clearBtn) {
                    clearBtn.onclick = function(e) {
                        e.preventDefault();
                        console.log('clearBtnè¢«ç‚¹å‡»äº†!');
                        clearCanvas();
                        return false;
                    };
                }

                // å•ä¸ªå†³ç­–æ ‘å¯¼å‡ºæŒ‰é’®ï¼ˆå³ä¾§ç”»å¸ƒï¼‰
                const exportCurrentBtn = document.getElementById('exportCurrentBtn');
                if (exportCurrentBtn) {
                    exportCurrentBtn.addEventListener('click', function() {
                        exportCurrentDecisionTree();
                    });
                }

                // æ‰¹é‡å¯¼å‡ºæ‰€æœ‰å†³ç­–æ ‘æŒ‰é’®ï¼ˆå·¦ä¾§å·¥å…·æ ï¼‰
                const exportAllBtn = document.getElementById('exportAllBtn');
                if (exportAllBtn) {
                    exportAllBtn.addEventListener('click', function() {
                        exportAllDecisionTrees();
                    });
                }

                // å…¨å±€äº‹ä»¶
                document.addEventListener('contextmenu', function(e) {
                    // å¦‚æœä¸æ˜¯èŠ‚ç‚¹çš„å³é”®èœå•ï¼Œåˆ™éšè—ç°æœ‰èœå•
                    if (!e.target.closest('.node')) {
                        hideContextMenu();
                    }
                });
                document.addEventListener('click', function(e) {
                    console.log('Global click detected, target:', e.target);
                    
                    // æ£€æŸ¥ç‚¹å‡»ç›®æ ‡
                    const isContextMenuClick = e.target.closest('.context-menu');
                    const isNodeClick = e.target.closest('.node');
                    const canvas = document.getElementById('canvas');
                    const isCanvasClick = canvas && (e.target === canvas || canvas.contains(e.target));
                    
                    // éšè—å³é”®èœå•ï¼ˆé™¤éç‚¹å‡»èœå•æœ¬èº«ï¼‰
                    if (!isContextMenuClick) {
                        console.log('Hiding context menu due to click outside menu');
                        hideContextMenu();
                    }
                    
                    // æ¸…é™¤èŠ‚ç‚¹é€‰æ‹©ï¼ˆå¦‚æœç‚¹å‡»ç”»å¸ƒç©ºç™½åŒºåŸŸï¼‰
                    if (isCanvasClick && !isNodeClick && !isContextMenuClick) {
                        console.log('Clearing node selection due to canvas click');
                        document.querySelectorAll('.node').forEach(el => {
                            el.classList.remove('selected');
                        });
                        selectedNode = null;
                        hideSelectedNodeInfo();
                    }
                });
                
                console.log('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–AIçŠ¶æ€æ£€æŸ¥
        async function initializeAIStatus() {
            try {
                console.log('ğŸ” æ£€æŸ¥AIçŠ¶æ€...');
                const response = await fetch('/api/ai_status');
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        aiStatus = data.data;
                        updateAIStatusDisplay();
                        console.log('âœ… AIçŠ¶æ€è·å–æˆåŠŸ:', aiStatus);
                    } else {
                        console.warn('âš ï¸ AIçŠ¶æ€è·å–å¤±è´¥:', data.message);
                        updateAIStatusDisplay(false, data.message);
                    }
                } else {
                    console.warn('âš ï¸ AIçŠ¶æ€APIä¸å¯ç”¨ (404)ï¼Œä½¿ç”¨é™çº§æ¨¡å¼');
                    // é™çº§å¤„ç†ï¼šå‡è®¾AIå¯ç”¨ï¼Œè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©
                    aiStatus.ai_enabled = true;
                    updateAIStatusDisplay(true, '');
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const statusIndicator = document.getElementById('aiStatusIndicator');
                    if (statusIndicator) {
                        statusIndicator.innerHTML = 'âš¡ æ··åˆæ¨¡å¼ (APIé™çº§)';
                        statusIndicator.style.color = '#f59e0b';
                    }
                }
            } catch (error) {
                console.error('âŒ AIçŠ¶æ€æ£€æŸ¥ç½‘ç»œå¤±è´¥:', error);
                console.log('ğŸ”„ å¯ç”¨é™çº§æ¨¡å¼ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©');
                
                // ç½‘ç»œé”™è¯¯ä¹Ÿå¯ç”¨é™çº§æ¨¡å¼
                aiStatus.ai_enabled = true;
                updateAIStatusDisplay(true, '');
                
                const statusIndicator = document.getElementById('aiStatusIndicator');
                if (statusIndicator) {
                    statusIndicator.innerHTML = 'âš¡ æ··åˆæ¨¡å¼ (ç½‘ç»œé™çº§)';
                    statusIndicator.style.color = '#f59e0b';
                }
            }
        }
        
        // æ›´æ–°AIçŠ¶æ€æ˜¾ç¤º
        function updateAIStatusDisplay(success = true, errorMessage = '') {
            const statusIndicator = document.getElementById('aiStatusIndicator');
            const aiModeToggle = document.getElementById('aiModeToggle');
            const aiModeText = document.getElementById('aiModeText');
            
            if (success && aiStatus.ai_enabled) {
                // AIå¯ç”¨æˆ–é™çº§æ¨¡å¼
                if (!statusIndicator.innerHTML.includes('æ··åˆæ¨¡å¼')) {
                    statusIndicator.innerHTML = `âœ… AIå·²å°±ç»ª (${aiStatus.model || 'qwen-max'})`;
                    statusIndicator.style.color = '#059669';
                }
                aiModeToggle.disabled = false;
                
                console.log('ğŸ›ï¸ AIæ¨¡å¼åˆ‡æ¢å·²å¯ç”¨');
            } else if (errorMessage && !errorMessage.includes('é™çº§')) {
                // åªæœ‰åœ¨çœŸæ­£é”™è¯¯æ—¶æ‰ç¦ç”¨
                const message = errorMessage || 'AIæœåŠ¡ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æ¨¡æ¿æ¨¡å¼';
                statusIndicator.innerHTML = `âš ï¸ ${message}`;
                statusIndicator.style.color = '#d97706';
                aiModeToggle.checked = false;
                aiModeToggle.disabled = true;
                updateModeDisplay(false);
                
                console.log('ğŸš« AIæ¨¡å¼åˆ‡æ¢å·²ç¦ç”¨');
            } else {
                // é™çº§æ¨¡å¼ï¼šä¿æŒåˆ‡æ¢å¯ç”¨
                aiModeToggle.disabled = false;
                console.log('âš¡ é™çº§æ¨¡å¼ï¼šAIåˆ‡æ¢ä¿æŒå¯ç”¨');
            }
        }
        
        // åˆå§‹åŒ–æ¨¡å¼åˆ‡æ¢
        function initializeModeToggle() {
            const aiModeToggle = document.getElementById('aiModeToggle');
            
            console.log('ğŸ”§ åˆå§‹åŒ–æ¨¡å¼åˆ‡æ¢...');
            console.log('  - Toggleå…ƒç´ :', aiModeToggle);
            console.log('  - AIçŠ¶æ€:', aiStatus);
            
            if (aiModeToggle) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                aiModeToggle.removeEventListener('change', handleModeToggle);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                aiModeToggle.addEventListener('change', handleModeToggle);
                
                // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                const initialUseAI = aiModeToggle.checked && aiStatus.ai_enabled;
                updateModeDisplay(initialUseAI);
                
                console.log('âœ… æ¨¡å¼åˆ‡æ¢åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°aiModeToggleå…ƒç´ ');
            }
        }
        
        // æ¨¡å¼åˆ‡æ¢å¤„ç†å‡½æ•°
        function handleModeToggle() {
            const useAI = this.checked && aiStatus.ai_enabled;
            console.log('ğŸ”„ æ¨¡å¼åˆ‡æ¢äº‹ä»¶è§¦å‘:');
            console.log('  - Toggleé€‰ä¸­:', this.checked);
            console.log('  - AIå¯ç”¨:', aiStatus.ai_enabled);
            console.log('  - æœ€ç»ˆæ¨¡å¼:', useAI ? 'AIæ¨¡å¼' : 'æ¨¡æ¿æ¨¡å¼');
            
            updateModeDisplay(useAI);
            
            // å¯é€‰ï¼šä¿å­˜ç”¨æˆ·åå¥½
            if (typeof userPreferences !== 'undefined') {
                userPreferences.aiModePreferred = useAI;
            }
        }
        
        // æ›´æ–°æ¨¡å¼æ˜¾ç¤º
        function updateModeDisplay(useAI) {
            const aiModeText = document.getElementById('aiModeText');
            const generateBtnIcon = document.getElementById('generateBtnIcon');
            const generateBtnText = document.getElementById('generateBtnText');
            
            if (useAI) {
                aiModeText.textContent = 'AIæ™ºèƒ½æ¨¡å¼';
                aiModeText.style.color = '#3b82f6';
                generateBtnIcon.textContent = 'ğŸ¤–';
                generateBtnText.textContent = 'AIæ™ºèƒ½ç”Ÿæˆ';
            } else {
                aiModeText.textContent = 'æ ‡å‡†æ¨¡æ¿æ¨¡å¼';
                aiModeText.style.color = '#6b7280';
                generateBtnIcon.textContent = 'ğŸ“‹';
                generateBtnText.textContent = 'æ ‡å‡†æ¨¡æ¿ç”Ÿæˆ';
            }
            
            userPreferences.aiModePreferred = useAI;
        }
        
        // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€å’Œæ•°æ®æ¥æº
        function showGenerationStatus(source, info, time) {
            const statusPanel = document.getElementById('generationStatusPanel');
            const dataSourceBadge = document.getElementById('dataSourceBadge');
            const generationInfo = document.getElementById('generationInfo');
            const generationTime = document.getElementById('generationTime');
            
            // æ›´æ–°æ•°æ®æ¥æºæ ‡è¯†
            dataSourceBadge.className = `data-source-badge data-source-${source}`;
            switch (source) {
                case 'ai':
                    dataSourceBadge.textContent = 'ğŸ¤– AI Generated';
                    generationInfo.textContent = info || 'å·²ä½¿ç”¨AIæ™ºèƒ½ç”Ÿæˆ';
                    break;
                case 'template':
                    dataSourceBadge.textContent = 'ğŸ“‹ Template';
                    generationInfo.textContent = info || 'å·²ä½¿ç”¨æ ‡å‡†æ¨¡æ¿ç”Ÿæˆ';
                    break;
                case 'template_fallback':
                    dataSourceBadge.textContent = 'âš ï¸ Fallback';
                    generationInfo.textContent = info || 'AIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿å¤‡ç”¨';
                    break;
            }
            
            generationTime.textContent = time || 'å³æ—¶';
            
            // æ˜¾ç¤ºçŠ¶æ€é¢æ¿
            statusPanel.style.display = 'block';
            statusPanel.className = `generation-status ${source === 'ai' ? 'ai-mode' : 'template-mode'}`;
        }

        // AIç”Ÿæˆå†³ç­–æ ‘ï¼ˆå‡çº§ç‰ˆï¼‰
        async function generateAITree() {
            console.log('ğŸš€ æ™ºèƒ½ç”Ÿæˆå†³ç­–æ ‘è¢«è°ƒç”¨');
            
            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            if (!getCurrentDiseaseName()) {
                alert('è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°');
                return;
            }

            const doctorThought = document.getElementById('doctorThought').value.trim();
            const useAI = document.getElementById('aiModeToggle').checked && aiStatus.ai_enabled;
            
            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„loadingä¿¡æ¯
            const loadingMessage = useAI ? 
                (doctorThought ? 'AIæ­£åœ¨æ ¹æ®æ‚¨çš„æ€è·¯ç”Ÿæˆå†³ç­–æ ‘...' : 'AIæ­£åœ¨ç”Ÿæˆæ ‡å‡†å†³ç­–æ ‘...') :
                'æ­£åœ¨åŠ è½½æ ‡å‡†æ¨¡æ¿...';
            
            showLoading(loadingMessage);

            try {
                const response = await fetch('/api/generate_visual_decision_tree', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        disease_name: getCurrentDiseaseName(),
                        thinking_process: doctorThought,
                        use_ai: useAI,
                        include_tcm_analysis: true,
                        complexity_level: userPreferences.complexityLevel
                    })
                });

                const result = await response.json();
                
                if (result.success && result.data && result.data.paths) {
                    const pathsData = result.data.paths;
                    const source = result.data.source || 'template';
                    const generationTime = result.data.generation_time || 'å³æ—¶';
                    
                    generateNodesFromPaths(pathsData);
                    hideLoading();
                    
                    // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€
                    showGenerationStatus(
                        source, 
                        result.message,
                        generationTime
                    );
                    
                    showResult('æˆåŠŸ', `âœ… æˆåŠŸç”Ÿæˆäº†${pathsData.length}æ¡è¯Šç–—è·¯å¾„ï¼`, 'success');
                    console.log('ğŸ“Š ç”Ÿæˆç»Ÿè®¡:', {
                        source: source,
                        pathCount: pathsData.length,
                        aiEnabled: aiStatus.ai_enabled,
                        userThinking: !!doctorThought
                    });
                } else {
                    throw new Error(result.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            }
        }


        // ä»AIè·¯å¾„æ•°æ®ç”ŸæˆèŠ‚ç‚¹ï¼ˆç®€åŒ–ç‰ˆï¼šç›´æ¥ä½¿ç”¨è·¯å¾„æ•°æ®ï¼‰
        function generateNodesFromPaths(paths) {
            console.log('ğŸ”„ å¼€å§‹ç”ŸæˆèŠ‚ç‚¹ï¼Œè·¯å¾„æ•°æ®:', paths);
            clearCanvas();
            
            if (!paths || paths.length === 0) {
                console.warn('âš ï¸ æ²¡æœ‰è·¯å¾„æ•°æ®å¯ç”Ÿæˆ');
                return;
            }
            
            let baseX = 50, baseY = 80;
            const pathWidth = 300;
            const stepHeight = 120;
            
            // ä¸ºæ¯æ¡è·¯å¾„ç”ŸæˆèŠ‚ç‚¹
            paths.forEach((path, pathIndex) => {
                console.log(`ğŸ“ å¤„ç†è·¯å¾„ ${pathIndex + 1}: ${path.title || path.id}`);
                
                if (path.steps && path.steps.length > 0) {
                    path.steps.forEach((step, stepIndex) => {
                        const node = {
                            id: `${path.id}_step_${stepIndex}`,
                            name: step.title || step.content || step.name || 'è¯Šç–—æ­¥éª¤',
                            description: step.content || step.description || '',
                            type: step.type || 'condition',
                            x: baseX + (pathIndex * pathWidth),
                            y: baseY + (stepIndex * stepHeight)
                        };

                        nodes.push(node);
                        renderNode(node);
                        console.log(`  âœ… æ·»åŠ èŠ‚ç‚¹: ${node.name} (${node.type})`);
                        
                        // è¿æ¥åŒä¸€è·¯å¾„å†…çš„è¿ç»­æ­¥éª¤
                        if (stepIndex > 0) {
                            const prevNodeId = `${path.id}_step_${stepIndex - 1}`;
                            connections.push({
                                from: prevNodeId,
                                to: node.id
                            });
                        }
                    });
                } else {
                    console.warn(`âš ï¸ è·¯å¾„ ${path.title || path.id} æ²¡æœ‰æ­¥éª¤æ•°æ®`);
                    // å¦‚æœæ²¡æœ‰stepsï¼Œåˆ›å»ºä¸€ä¸ªåŸºæœ¬èŠ‚ç‚¹
                    const node = {
                        id: `${path.id}_basic`,
                        name: path.title || path.id || 'è¯Šç–—è·¯å¾„',
                        description: path.description || 'åŸºæœ¬è¯Šç–—ä¿¡æ¯',
                        type: 'condition',
                        x: baseX + (pathIndex * pathWidth),
                        y: baseY
                    };
                    
                    nodes.push(node);
                    renderNode(node);
                }
            });
            
            // è‡ªåŠ¨æ’åˆ—èŠ‚ç‚¹
            setTimeout(() => {
                autoArrangeNodes();
            }, 100);
            
            console.log(`âœ… èŠ‚ç‚¹ç”Ÿæˆå®Œæˆï¼Œå…± ${nodes.length} ä¸ªèŠ‚ç‚¹`);
        }

        // åˆ†æå½“å‰å†³ç­–æ ‘
        async function analyzeCurrentTree() {
            console.log('åˆ†æå½“å‰å†³ç­–æ ‘è¢«è°ƒç”¨');
            
            if (nodes.length === 0) {
                alert('è¯·å…ˆåˆ›å»ºæˆ–ç”Ÿæˆå†³ç­–æ ‘');
                return;
            }

            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            if (!getCurrentDiseaseName()) {
                alert('è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°');
                return;
            }

            showLoading('æ­£åœ¨è¿›è¡Œä¸­åŒ»ç†è®ºåˆ†æ...');

            try {
                const treeData = {
                    disease_name: getCurrentDiseaseName(),
                    nodes: nodes
                };

                const response = await fetch('/api/analyze_tree_tcm_theory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tree_data: treeData,
                        disease_name: getCurrentDiseaseName()
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    hideLoading();
                    showAnalysisResult(data.data.analysis || 'åˆ†æå®Œæˆ');
                } else {
                    throw new Error(data.message || 'åˆ†æå¤±è´¥');
                }
            } catch (error) {
                console.error('ç†è®ºåˆ†æå¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ åˆ†æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å»ºè®®é—æ¼é€»è¾‘
        async function suggestMissingLogic() {
            console.log('å»ºè®®é—æ¼é€»è¾‘è¢«è°ƒç”¨');
            
            if (nodes.length === 0) {
                alert('è¯·å…ˆåˆ›å»ºæˆ–ç”Ÿæˆå†³ç­–æ ‘');
                return;
            }

            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            if (!getCurrentDiseaseName()) {
                alert('è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°');
                return;
            }

            showLoading('æ­£åœ¨æ£€æµ‹é—æ¼é€»è¾‘...');

            try {
                const response = await fetch('/api/detect_missing_logic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        disease_name: getCurrentDiseaseName(),
                        current_paths: [],
                        existing_nodes: nodes
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    hideLoading();
                    showMissingLogicResult(data.data);
                } else {
                    throw new Error(data.message || 'æ£€æµ‹å¤±è´¥');
                }
            } catch (error) {
                console.error('é—æ¼é€»è¾‘æ£€æµ‹å¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ æ ‡å‡†è·¯å¾„
        function addStandardPath() {
            console.log('æ·»åŠ æ ‡å‡†è·¯å¾„è¢«è°ƒç”¨');
            
            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            
            clearCanvas();
            
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ›å»ºç—‡çŠ¶ç¾¤
            const template = SYMPTOM_CLUSTER_TEMPLATES[`${getCurrentDiseaseName()}ç¾¤`];
            if (template) {
                // åˆ›å»ºç—‡çŠ¶ç¾¤æ¨¡å¼
                // TODO: ä¼˜åŒ–åæ·»åŠ ç—‡çŠ¶ç¾¤åŠŸèƒ½
                
                // åˆ›å»ºåç»­èŠ‚ç‚¹
                const followUpNodes = [
                    { type: 'diagnosis', name: 'ä¸­åŒ»è¯Šæ–­', description: 'è¾¨è¯åˆ†å‹', x: 400, y: 150 },
                    { type: 'treatment', name: 'æ²»ç–—æ–¹æ³•', description: 'æ²»åˆ™æ²»æ³•', x: 650, y: 150 },
                    { type: 'formula', name: 'æ–¹å‰‚é€‰æ‹©', description: 'å…·ä½“æ–¹è¯', x: 900, y: 150 }
                ];
                
                let previousNode = null;
                followUpNodes.forEach((nodeData, index) => {
                    const node = {
                        id: `std_${index + 2}`,
                        ...nodeData
                    };
                    nodes.push(node);
                    renderNode(node);
                    previousNode = node;
                });
            } else {
                // ä¼ ç»Ÿæ¨¡å¼ - åˆ›å»ºç¬¦åˆä¸­åŒ»è¯Šç–—æµç¨‹çš„æ ‡å‡†è·¯å¾„èŠ‚ç‚¹
                const standardNodes = [
                    { type: 'disease', name: `${getCurrentDiseaseName()}`, description: 'ç—…ç§è¯†åˆ«', x: 50, y: 100 },
                    { type: 'four_diagnosis', name: 'å››è¯Šæ”¶é›†', description: 'æœ›é—»é—®åˆ‡', x: 250, y: 100 },
                    { type: 'symptom', name: 'ä¸»è¦ç—‡çŠ¶', description: 'ç—‡çŠ¶åˆ†æ', x: 450, y: 100 },
                    { type: 'pathogenesis', name: 'ç—…å› ç—…æœº', description: 'ç—…ç†åˆ†æ', x: 650, y: 100 },
                    { type: 'syndrome', name: 'è¯å€™åˆ¤æ–­', description: 'è¾¨è¯åˆ†å‹', x: 850, y: 100 },
                    { type: 'principle', name: 'æ²»åˆ™æ²»æ³•', description: 'ç¡®å®šæ²»ç–—åŸåˆ™', x: 1050, y: 100 },
                    { type: 'prescription', name: 'æ–¹å‰‚å¤„æ–¹', description: 'é€‰æ–¹ç”¨è¯', x: 1250, y: 100 },
                    { type: 'formula', name: 'æ–¹å‰‚é€‰æ‹©', description: 'å…·ä½“æ–¹è¯', x: 1050, y: 100 }
                ];
                
                let previousNode = null;
                standardNodes.forEach((nodeData, index) => {
                    const node = {
                        id: `std_${index + 1}`,
                        ...nodeData
                    };
                    nodes.push(node);
                    renderNode(node);
                    
                    // åˆ›å»ºè¿æ¥
                    if (previousNode) {
                        connections.push({
                            from: previousNode.id,
                            to: node.id
                        });
                    }
                    
                    previousNode = node;
                });
            }
            
            let previousNode = null;
            standardNodes.forEach((nodeData, index) => {
                const node = {
                    id: `std_${index + 1}`,
                    ...nodeData
                };
                nodes.push(node);
                renderNode(node);
                
                // åˆ›å»ºè¿æ¥
                if (previousNode) {
                    connections.push({
                        from: previousNode.id,
                        to: node.id
                    });
                }
                
                previousNode = node;
            });
            
            updateCanvas();
            drawConnections();
            showResult('æˆåŠŸ', 'âœ… æ ‡å‡†è¯Šç–—è·¯å¾„å·²æ·»åŠ ', 'success');
        }

        // è‡ªåŠ¨æ’åˆ—èŠ‚ç‚¹
        function autoArrangeNodes() {
            console.log('è‡ªåŠ¨æ’åˆ—èŠ‚ç‚¹è¢«è°ƒç”¨');
            
            if (nodes.length === 0) {
                showResult('æç¤º', 'æ²¡æœ‰èŠ‚ç‚¹éœ€è¦æ’åˆ—', 'info');
                return;
            }
            
            // åŸºäºä¸­åŒ»è¯Šç–—æµç¨‹çš„æ™ºèƒ½æ’åˆ—
            const nodeHierarchy = buildNodeHierarchy();
            
            // è®¡ç®—å¸ƒå±€
            const baseX = 50;
            const baseY = 300;
            const horizontalGap = 280;
            const verticalGap = 150;
            
            // æŒ‰å±‚çº§æ’åˆ—
            Object.keys(nodeHierarchy).forEach((level, levelIndex) => {
                const levelNodes = nodeHierarchy[level];
                const levelX = baseX + levelIndex * horizontalGap;
                
                levelNodes.forEach((node, nodeIndex) => {
                    // è®¡ç®—å‚ç›´ä½ç½®ï¼Œä½¿åŒå±‚èŠ‚ç‚¹å±…ä¸­åˆ†å¸ƒ
                    const totalHeight = (levelNodes.length - 1) * verticalGap;
                    const startY = baseY - (totalHeight / 2);
                    node.x = levelX;
                    node.y = startY + (nodeIndex * verticalGap);
                    
                    updateNodePosition(node);
                });
            });
            
            // é‡ç»˜è¿æ¥çº¿
            setTimeout(() => {
                drawConnections();
                showResult('æˆåŠŸ', `âœ… å·²æŒ‰ä¸­åŒ»è¯Šç–—æµç¨‹æ™ºèƒ½æ’åˆ—${nodes.length}ä¸ªèŠ‚ç‚¹`, 'success');
            }, 50);
        }
        
        // æ„å»ºèŠ‚ç‚¹å±‚çº§å…³ç³»
        function buildNodeHierarchy() {
            const hierarchy = {};
            const visited = new Set();
            
            // æŸ¥æ‰¾æ ¹èŠ‚ç‚¹ï¼ˆæ²¡æœ‰å…¥è¾¹çš„èŠ‚ç‚¹ï¼‰
            const rootNodes = nodes.filter(node => {
                return !connections.some(conn => conn.to === node.id);
            });
            
            // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„æ ¹èŠ‚ç‚¹ï¼Œé€‰æ‹©ç—…ç§ç±»å‹çš„èŠ‚ç‚¹ä½œä¸ºæ ¹
            if (rootNodes.length === 0) {
                const diseaseNodes = nodes.filter(n => n.type === 'disease');
                if (diseaseNodes.length > 0) {
                    rootNodes.push(...diseaseNodes);
                } else if (nodes.length > 0) {
                    rootNodes.push(nodes[0]);
                }
            }
            
            // å¹¿åº¦ä¼˜å…ˆéå†æ„å»ºå±‚çº§
            let currentLevel = 0;
            let currentLevelNodes = rootNodes;
            
            while (currentLevelNodes.length > 0 && currentLevel < 10) {
                hierarchy[currentLevel] = [...currentLevelNodes];
                currentLevelNodes.forEach(n => visited.add(n.id));
                
                // è·å–ä¸‹ä¸€å±‚èŠ‚ç‚¹
                const nextLevelNodes = [];
                currentLevelNodes.forEach(node => {
                    const childConnections = connections.filter(conn => conn.from === node.id);
                    childConnections.forEach(conn => {
                        const childNode = nodes.find(n => n.id === conn.to);
                        if (childNode && !visited.has(childNode.id)) {
                            nextLevelNodes.push(childNode);
                            visited.add(childNode.id);
                        }
                    });
                });
                
                currentLevelNodes = nextLevelNodes;
                currentLevel++;
            }
            
            return hierarchy;
        }

        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            console.log('æ¸…ç©ºç”»å¸ƒè¢«è°ƒç”¨');
            
            nodes = [];
            selectedNode = null;
            connections = [];
            
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = `
                <svg id="branchSvg">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" />
                        </marker>
                    </defs>
                </svg>
                <div class="empty-canvas" id="emptyHint">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸŒ³</div>
                    <h3>å¼€å§‹æ„å»ºæ‚¨çš„å†³ç­–æ ‘</h3>
                    <p style="margin: 10px 0;">è¾“å…¥ç–¾ç—…åç§°ï¼Œç„¶åç‚¹å‡»"AIç”Ÿæˆå†³ç­–æ ‘"</p>
                    <p style="color: #9ca3af; font-size: 12px;">æˆ–ç‚¹å‡»"æ ‡å‡†è·¯å¾„"å¿«é€Ÿå¼€å§‹</p>
                </div>
            `;
            
            clearResults();
            hideSelectedNodeInfo();
            showResult('æˆåŠŸ', 'âœ… ç”»å¸ƒå·²æ¸…ç©º', 'success');
        }

        // ä¿å­˜åˆ°æ€ç»´åº“ï¼ˆä¸´åºŠå†³ç­–æ¨¡å¼ï¼‰
        async function saveToThinkingLibrary() {
            console.log('ä¿å­˜åˆ°æ€ç»´åº“è¢«è°ƒç”¨');

            // éªŒè¯ç™»å½•çŠ¶æ€
            if (!isAuthenticated || !currentUser) {
                showResult('æç¤º', 'âš ï¸ è¯·å…ˆç™»å½•åŒ»ç”Ÿè´¦æˆ·', 'warning');
                setTimeout(() => {
                    redirectToLogin();
                }, 1500);
                return;
            }

            // éªŒè¯å¿…è¦æ¡ä»¶
            if (!getCurrentDiseaseName()) {
                showResult('æç¤º', 'è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°', 'warning');
                return;
            }
            if (nodes.length === 0) {
                showResult('æç¤º', 'è¯·å…ˆæ„å»ºå†³ç­–æ ‘', 'warning');
                return;
            }

            // æ˜¾ç¤ºä¿å­˜å¯¹è¯æ¡†
            showThinkingLibraryDialog();
        }
        
        // æ˜¾ç¤ºæ€ç»´åº“ä¿å­˜å¯¹è¯æ¡†
        function showThinkingLibraryDialog() {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                backdrop-filter: blur(2px);
                animation: fadeIn 0.2s ease-out;
            `;
            
            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 0;
                border-radius: 12px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.15);
                z-index: 10000;
                width: 520px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                overflow-x: hidden;
                animation: slideIn 0.3s ease-out;
            `;
            
            const diseaseName = getCurrentDiseaseName();
            const nodeCount = nodes.length;
            const connectionCount = connections.length;
            
            dialog.innerHTML = `
                <div style="background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%); color: white; padding: 24px; text-align: center;">
                    <div style="font-size: 36px; margin-bottom: 12px;">ğŸ§ </div>
                    <h3 style="margin: 0; font-size: 20px; font-weight: 600;">ä¿å­˜åˆ°åŒ»ç”Ÿæ€ç»´åº“</h3>
                    <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">å°†æ‚¨çš„ä¸´åºŠå†³ç­–ç»éªŒä¿å­˜ä¸ºå¯å¤ç”¨çš„æ€ç»´æ¨¡å¼</p>
                </div>
                
                <div style="padding: 28px;">
                    <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 24px; border-left: 4px solid #7c3aed;">
                        <h4 style="margin: 0 0 12px; color: #374151; font-size: 16px;">ğŸ“Š å†³ç­–æ ‘ä¿¡æ¯</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                            <div><strong>ç–¾ç—…åç§°:</strong> ${diseaseName}</div>
                            <div><strong>èŠ‚ç‚¹æ•°é‡:</strong> ${nodeCount} ä¸ª</div>
                            <div><strong>è¿æ¥æ•°é‡:</strong> ${connectionCount} ä¸ª</div>
                            <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            ğŸ·ï¸ æ€ç»´æ¨¡å¼åç§°
                        </label>
                        <input type="text" id="thinkingPatternName" 
                               value="${diseaseName}ä¸´åºŠå†³ç­–æ¨¡å¼" 
                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                               placeholder="è¯·è¾“å…¥æ€ç»´æ¨¡å¼åç§°">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            ğŸ¯ åº”ç”¨åœºæ™¯
                        </label>
                        <select id="applicationScenario" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                            <option value="clinical_diagnosis">ä¸´åºŠè¯Šæ–­å†³ç­–</option>
                            <option value="treatment_planning">æ²»ç–—æ–¹æ¡ˆè§„åˆ’</option>
                            <option value="symptom_analysis">ç—‡çŠ¶åˆ†ææµç¨‹</option>
                            <option value="formula_selection">æ–¹å‰‚é€‰æ‹©æŒ‡å¯¼</option>
                            <option value="teaching_case">æ•™å­¦æ¡ˆä¾‹æ¨¡æ¿</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            ğŸ“ ä¸´åºŠæ€ç»´æè¿°
                        </label>
                        <textarea id="clinicalThinking" 
                                  style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; min-height: 120px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;"
                                  placeholder="è¯·æè¿°æ‚¨åœ¨æ„å»ºæ­¤å†³ç­–æ ‘æ—¶çš„ä¸´åºŠæ€ç»´è¿‡ç¨‹ã€æ ¸å¿ƒè¦ç‚¹ã€æ³¨æ„äº‹é¡¹ç­‰...&#10;ä¾‹å¦‚ï¼šæ­¤å†³ç­–æ ‘åŸºäºå¼ ä»²æ™¯å…­ç»è¾¨è¯ç†è®ºï¼Œé‡ç‚¹çªå‡º..."></textarea>
                    </div>
                    
                    <div style="background: #fffbeb; border-radius: 8px; padding: 16px; margin-bottom: 24px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 16px; margin-right: 8px;">ğŸ’¡</span>
                            <strong style="color: #92400e;">æ€ç»´åº“ä»·å€¼</strong>
                        </div>
                        <ul style="margin: 0; padding-left: 16px; font-size: 13px; color: #92400e; line-height: 1.6;">
                            <li>ç§¯ç´¯ä¸´åºŠå†³ç­–ç»éªŒï¼Œå½¢æˆä¸ªäººçŸ¥è¯†åº“</li>
                            <li>å¿«é€Ÿå¤ç”¨æˆåŠŸçš„è¯Šç–—æ€è·¯å’Œæµç¨‹</li>
                            <li>ä¸ºæ•™å­¦å’ŒåŸ¹è®­æä¾›æ ‡å‡†åŒ–æ¨¡æ¿</li>
                            <li>ä¿ƒè¿›ä¸´åºŠç»éªŒçš„ä¼ æ‰¿å’Œåˆ†äº«</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="cancelLibrarySave" 
                                style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; color: #6b7280; transition: all 0.2s ease;">
                            âœ–ï¸ å–æ¶ˆ
                        </button>
                        <button id="confirmLibrarySave" 
                                style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%); color: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(124, 58, 237, 0.2); transition: all 0.2s ease;">
                            ğŸ§  ä¿å­˜åˆ°æ€ç»´åº“
                        </button>
                    </div>
                </div>
            `;
            
            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            function closeDialog() {
                dialog.style.animation = 'slideOut 0.2s ease-in forwards';
                overlay.style.animation = 'fadeOut 0.2s ease-in forwards';
                setTimeout(() => {
                    if (overlay.parentNode) overlay.remove();
                    if (dialog.parentNode) dialog.remove();
                }, 200);
            }
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(overlay);
            document.body.appendChild(dialog);
            
            // äº‹ä»¶ç»‘å®š
            document.getElementById('cancelLibrarySave').onclick = closeDialog;
            overlay.onclick = closeDialog;
            
            // ESCé”®å…³é—­
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeDialog();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            // ä¿å­˜åˆ°æ€ç»´åº“
            document.getElementById('confirmLibrarySave').onclick = async function() {
                const patternName = document.getElementById('thinkingPatternName').value.trim();
                const scenario = document.getElementById('applicationScenario').value;
                const thinking = document.getElementById('clinicalThinking').value.trim();
                
                if (!patternName) {
                    document.getElementById('thinkingPatternName').focus();
                    showResult('æç¤º', 'è¯·è¾“å…¥æ€ç»´æ¨¡å¼åç§°', 'warning');
                    return;
                }

                // ğŸ”§ å–æ¶ˆä¸´åºŠæ€ç»´æè¿°çš„å¼ºåˆ¶è¦æ±‚ï¼Œæ”¹ä¸ºå¯é€‰
                // if (!thinking) {
                //     document.getElementById('clinicalThinking').focus();
                //     showResult('æç¤º', 'è¯·æè¿°æ‚¨çš„ä¸´åºŠæ€ç»´è¿‡ç¨‹', 'warning');
                //     return;
                // }

                closeDialog();
                document.removeEventListener('keydown', escHandler);
                
                // æ‰§è¡Œä¿å­˜
                await performLibrarySave(patternName, scenario, thinking);
            };
            
            // è‡ªåŠ¨èšç„¦
            setTimeout(() => {
                document.getElementById('thinkingPatternName').focus();
                document.getElementById('thinkingPatternName').select();
            }, 100);
        }
        
        // æ‰§è¡Œæ€ç»´åº“ä¿å­˜
        async function performLibrarySave(patternName, scenario, thinking) {
            showLoading('æ­£åœ¨ä¿å­˜åˆ°æ€ç»´åº“...');
            
            try {
                const saveData = {
                    disease_name: getCurrentDiseaseName(),
                    thinking_process: thinking,
                    tree_structure: {
                        nodes: nodes,
                        connections: connections,
                        metadata: {
                            pattern_name: patternName,
                            scenario: scenario,
                            created_at: new Date().toISOString(),
                            node_count: nodes.length,
                            connection_count: connections.length
                        }
                    },
                    clinical_patterns: {
                        scenario_type: scenario,
                        key_decision_points: extractKeyDecisionPoints(),
                        diagnostic_flow: extractDiagnosticFlow(),
                        treatment_principles: extractTreatmentPrinciples()
                    },
                    doctor_expertise: {
                        specialization: "ä¸­åŒ»å†…ç§‘", // å¯ä»¥åç»­ä»ç”¨æˆ·ä¿¡æ¯è·å–
                        experience_level: "ä¸»æ²»åŒ»å¸ˆ", // å¯ä»¥åç»­ä»ç”¨æˆ·ä¿¡æ¯è·å–
                        theoretical_basis: extractTheoreticalBasis()
                    }
                };
                
                const response = await fetch('/api/save_clinical_pattern', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    },
                    body: JSON.stringify(saveData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    hideLoading();
                    showResult('æˆåŠŸ', `ğŸ§  ä¸´åºŠå†³ç­–æ¨¡å¼å·²ä¿å­˜åˆ°æ€ç»´åº“ï¼æ¨¡å¼ID: ${result.data.pattern_id}`, 'success');

                    // åˆ·æ–°å†å²å†³ç­–æ ‘åˆ—è¡¨
                    await loadDoctorHistoryTrees();
                } else {
                    throw new Error(result.message || 'ä¿å­˜åˆ°æ€ç»´åº“å¤±è´¥');
                }
                
            } catch (error) {
                console.error('ä¿å­˜åˆ°æ€ç»´åº“å¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ ä¿å­˜åˆ°æ€ç»´åº“å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æå–å…³é”®å†³ç­–ç‚¹
        function extractKeyDecisionPoints() {
            const decisionPoints = [];
            nodes.forEach(node => {
                if (['condition', 'diagnosis', 'syndrome'].includes(node.type)) {
                    decisionPoints.push({
                        node_id: node.id,
                        node_type: node.type,
                        decision_name: node.name,
                        decision_criteria: node.description || ''
                    });
                }
            });
            return decisionPoints;
        }
        
        // æå–è¯Šæ–­æµç¨‹
        function extractDiagnosticFlow() {
            const flow = [];
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    flow.push({
                        from: fromNode.name,
                        to: toNode.name,
                        from_type: fromNode.type,
                        to_type: toNode.type
                    });
                }
            });
            return flow;
        }
        
        // æå–æ²»ç–—åŸåˆ™
        function extractTreatmentPrinciples() {
            const principles = [];
            nodes.forEach(node => {
                if (['principle', 'treatment', 'prescription'].includes(node.type)) {
                    principles.push({
                        principle_name: node.name,
                        principle_type: node.type,
                        description: node.description || ''
                    });
                }
            });
            return principles;
        }
        
        // æå–ç†è®ºåŸºç¡€
        function extractTheoreticalBasis() {
            const basis = [];
            nodes.forEach(node => {
                if (node.description && node.description.includes('ç†è®º')) {
                    basis.push({
                        node_name: node.name,
                        theoretical_content: node.description
                    });
                }
            });
            return basis.length > 0 ? basis : [{ 
                node_name: "æ•´ä½“å†³ç­–æ ‘", 
                theoretical_content: "åŸºäºä¸­åŒ»ä¼ ç»Ÿç†è®ºçš„è¯Šç–—å†³ç­–è¿‡ç¨‹" 
            }];
        }

        // ========================================
        // ğŸ“¥ å¯¼å‡ºåŠŸèƒ½ï¼ˆå¤šæ ¼å¼æ”¯æŒï¼‰
        // ========================================

        // å¯¼å‡ºä¸ºJSONæ ¼å¼
        function exportAsJSON() {
            console.log('å¯¼å‡ºJSONè¢«è°ƒç”¨');

            const exportData = {
                disease_name: getCurrentDiseaseName() || 'æœªå‘½åç–¾ç—…',
                nodes: nodes,
                exported_at: new Date().toISOString(),
                version: '2.0'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `å†³ç­–æ ‘_${getCurrentDiseaseName() || 'æœªå‘½å'}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();

            URL.revokeObjectURL(url);
            showResult('æˆåŠŸ', 'âœ… JSONæ–‡ä»¶å·²ä¸‹è½½', 'success');
        }

        // å¯¼å‡ºå½“å‰å†³ç­–æ ‘ï¼ˆå•ä¸ªï¼‰
        function exportCurrentDecisionTree() {
            console.log('å¯¼å‡ºå½“å‰å†³ç­–æ ‘è¢«è°ƒç”¨');
            console.log('å½“å‰èŠ‚ç‚¹æ•°é‡:', nodes.length);
            console.log('èŠ‚ç‚¹æ•°æ®:', nodes);

            // éªŒè¯æ˜¯å¦æœ‰æ•°æ®å¯å¯¼å‡º
            if (nodes.length === 0) {
                alert('âŒ æ— æ³•å¯¼å‡ºï¼šå½“å‰å†³ç­–æ ‘æ²¡æœ‰èŠ‚ç‚¹\n\nè¯·å…ˆåˆ›å»ºæˆ–åŠ è½½å†³ç­–æ ‘åå†å¯¼å‡ºã€‚');
                return;
            }

            const diseaseName = getCurrentDiseaseName() || 'æœªå‘½åç–¾ç—…';
            const exportTime = new Date().toLocaleString('zh-CN');

            let content = '';
            content += 'â•'.repeat(80) + '\n';
            content += '                    ä¸­åŒ»ä¸´åºŠå†³ç­–æ ‘\n';
            content += 'â•'.repeat(80) + '\n\n';

            content += `ğŸ“‹ ç–¾ç—…åç§°: ${diseaseName}\n`;
            content += `ğŸ“… å¯¼å‡ºæ—¶é—´: ${exportTime}\n`;
            content += `ğŸ“Š èŠ‚ç‚¹æ€»æ•°: ${nodes.length}\n`;
            content += '\n' + 'â”€'.repeat(80) + '\n\n';

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å…ƒç´ ID (doctorThought è€Œä¸æ˜¯ clinicalThinking)
            const thinkingTextarea = document.getElementById('doctorThought');
            const thinkingProcess = thinkingTextarea ? thinkingTextarea.value.trim() : '';

            if (thinkingProcess) {
                content += 'ğŸ’­ ä¸´åºŠæ€ç»´æè¿°\n';
                content += 'â”€'.repeat(80) + '\n';
                content += thinkingProcess + '\n\n';
                content += 'â”€'.repeat(80) + '\n\n';
            }

            // æŒ‰ç±»å‹åˆ†ç»„èŠ‚ç‚¹
            const diseaseNodes = nodes.filter(n => n.type === 'disease');
            const symptomNodes = nodes.filter(n => n.type === 'symptom');
            const diagnosisNodes = nodes.filter(n => n.type === 'diagnosis');
            const prescriptionNodes = nodes.filter(n => n.type === 'prescription');

            // è¾…åŠ©å‡½æ•°ï¼šè·å–èŠ‚ç‚¹æ˜¾ç¤ºæ–‡æœ¬
            const getNodeText = (node) => {
                // ä¼˜å…ˆä½¿ç”¨ descriptionï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ name
                return node.description || node.name || '(æ— æè¿°)';
            };

            // å¯¼å‡ºç–¾ç—…èŠ‚ç‚¹
            if (diseaseNodes.length > 0) {
                content += 'ğŸ”´ ç–¾ç—…/è¯å€™èŠ‚ç‚¹\n';
                content += 'â”€'.repeat(80) + '\n';
                diseaseNodes.forEach((node, index) => {
                    content += `${index + 1}. ${getNodeText(node)}\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
                content += '\n';
            }

            // å¯¼å‡ºç—‡çŠ¶èŠ‚ç‚¹
            if (symptomNodes.length > 0) {
                content += 'ğŸ”µ ç—‡çŠ¶/ä½“å¾èŠ‚ç‚¹\n';
                content += 'â”€'.repeat(80) + '\n';
                symptomNodes.forEach((node, index) => {
                    content += `${index + 1}. ${getNodeText(node)}\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
                content += '\n';
            }

            // å¯¼å‡ºè¯Šæ–­èŠ‚ç‚¹
            if (diagnosisNodes.length > 0) {
                content += 'ğŸŸ¡ è¯Šæ–­/è¾¨è¯èŠ‚ç‚¹\n';
                content += 'â”€'.repeat(80) + '\n';
                diagnosisNodes.forEach((node, index) => {
                    content += `${index + 1}. ${getNodeText(node)}\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
                content += '\n';
            }

            // å¯¼å‡ºå¤„æ–¹èŠ‚ç‚¹
            if (prescriptionNodes.length > 0) {
                content += 'ğŸŸ¢ å¤„æ–¹/æ²»ç–—èŠ‚ç‚¹\n';
                content += 'â”€'.repeat(80) + '\n';
                prescriptionNodes.forEach((node, index) => {
                    content += `${index + 1}. ${getNodeText(node)}\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
                content += '\n';
            }

            // å†³ç­–æµç¨‹
            if (nodes.length > 1) {
                content += 'ğŸ”€ å†³ç­–æµç¨‹\n';
                content += 'â”€'.repeat(80) + '\n';
                nodes.forEach((node, index) => {
                    const connections = node.connections || [];
                    if (connections.length > 0) {
                        connections.forEach(targetId => {
                            const targetNode = nodes.find(n => n.id === targetId);
                            if (targetNode) {
                                content += `${getNodeText(node)}\n`;
                                content += `  â†“\n`;
                                content += `${getNodeText(targetNode)}\n\n`;
                            }
                        });
                    }
                });
            }

            content += 'â•'.repeat(80) + '\n';
            content += 'å¯¼å‡ºå®Œæˆ | TCM-AI ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ\n';
            content += 'â•'.repeat(80) + '\n';

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `å†³ç­–æ ‘_${diseaseName}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();

            URL.revokeObjectURL(url);
            showResult('æˆåŠŸ', 'âœ… æ–‡æœ¬æ–‡ä»¶å·²ä¸‹è½½ï¼Œå¯ç›´æ¥ç”¨è®°äº‹æœ¬æ‰“å¼€æŸ¥çœ‹', 'success');
        }

        // æ‰¹é‡å¯¼å‡ºæ‰€æœ‰å†³ç­–æ ‘
        async function exportAllDecisionTrees() {
            console.log('æ‰¹é‡å¯¼å‡ºæ‰€æœ‰å†³ç­–æ ‘è¢«è°ƒç”¨');

            showLoading('æ­£åœ¨è·å–æ‚¨çš„å†³ç­–æ ‘åˆ—è¡¨...');

            try {
                const doctorId = getCurrentDoctorId();
                const response = await fetch(`/api/get_doctor_patterns/${doctorId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('è·å–å†³ç­–æ ‘åˆ—è¡¨å¤±è´¥');
                }

                const data = await response.json();
                hideLoading();

                if (!data.success || !data.data.patterns || data.data.patterns.length === 0) {
                    alert('âŒ æ‚¨è¿˜æ²¡æœ‰ä¿å­˜ä»»ä½•å†³ç­–æ ‘\n\nè¯·å…ˆåˆ›å»ºå¹¶ä¿å­˜å†³ç­–æ ‘åå†å¯¼å‡ºã€‚');
                    return;
                }

                const patterns = data.data.patterns;
                console.log(`æ‰¾åˆ° ${patterns.length} ä¸ªå†³ç­–æ ‘ï¼Œå¼€å§‹æ‰¹é‡å¯¼å‡º`);

                // ç”Ÿæˆæ‰¹é‡å¯¼å‡ºå†…å®¹
                let allContent = '';
                allContent += 'â•'.repeat(80) + '\n';
                allContent += '                  ä¸­åŒ»ä¸´åºŠå†³ç­–æ ‘ - æ‰¹é‡å¯¼å‡º\n';
                allContent += 'â•'.repeat(80) + '\n\n';

                allContent += `ğŸ“… å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
                allContent += `ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿ: ${currentUser?.name || 'æœªçŸ¥'}\n`;
                allContent += `ğŸ“Š å†³ç­–æ ‘æ€»æ•°: ${patterns.length} ä¸ª\n`;
                allContent += '\n' + 'â•'.repeat(80) + '\n\n';

                // éå†æ¯ä¸ªå†³ç­–æ ‘
                patterns.forEach((pattern, index) => {
                    allContent += '\n\n';
                    allContent += 'â–¼'.repeat(80) + '\n';
                    allContent += `ã€å†³ç­–æ ‘ ${index + 1}/${patterns.length}ã€‘\n`;
                    allContent += 'â–¼'.repeat(80) + '\n\n';

                    allContent += `ğŸ“‹ ç–¾ç—…åç§°: ${pattern.disease_name}\n`;
                    allContent += `ğŸ“… åˆ›å»ºæ—¶é—´: ${new Date(pattern.created_at).toLocaleString('zh-CN')}\n`;

                    const nodeCount = pattern.tree_structure && pattern.tree_structure.nodes ?
                        pattern.tree_structure.nodes.length : 0;
                    allContent += `ğŸ“Š èŠ‚ç‚¹æ€»æ•°: ${nodeCount}\n`;
                    allContent += '\n' + 'â”€'.repeat(80) + '\n\n';

                    // ä¸´åºŠæ€ç»´æè¿°
                    if (pattern.thinking_process) {
                        allContent += 'ğŸ’­ ä¸´åºŠæ€ç»´æè¿°\n';
                        allContent += 'â”€'.repeat(80) + '\n';
                        allContent += pattern.thinking_process + '\n\n';
                        allContent += 'â”€'.repeat(80) + '\n\n';
                    }

                    // å¯¼å‡ºèŠ‚ç‚¹å†…å®¹
                    if (pattern.tree_structure && pattern.tree_structure.nodes) {
                        const treeNodes = pattern.tree_structure.nodes;

                        // æŒ‰ç±»å‹åˆ†ç»„
                        const diseaseNodes = treeNodes.filter(n => n.type === 'disease');
                        const symptomNodes = treeNodes.filter(n => n.type === 'symptom');
                        const diagnosisNodes = treeNodes.filter(n => n.type === 'diagnosis');
                        const prescriptionNodes = treeNodes.filter(n => n.type === 'prescription');

                        // å¯¼å‡ºç–¾ç—…èŠ‚ç‚¹
                        if (diseaseNodes.length > 0) {
                            allContent += 'ğŸ”´ ç–¾ç—…/è¯å€™èŠ‚ç‚¹\n';
                            allContent += 'â”€'.repeat(80) + '\n';
                            diseaseNodes.forEach((node, idx) => {
                                const text = node.description || node.name || '(æ— æè¿°)';
                                allContent += `${idx + 1}. ${text}\n`;
                                if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                                    allContent += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                                }
                                allContent += '\n';
                            });
                            allContent += '\n';
                        }

                        // å¯¼å‡ºç—‡çŠ¶èŠ‚ç‚¹
                        if (symptomNodes.length > 0) {
                            allContent += 'ğŸ”µ ç—‡çŠ¶/ä½“å¾èŠ‚ç‚¹\n';
                            allContent += 'â”€'.repeat(80) + '\n';
                            symptomNodes.forEach((node, idx) => {
                                const text = node.description || node.name || '(æ— æè¿°)';
                                allContent += `${idx + 1}. ${text}\n`;
                                if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                                    allContent += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                                }
                                allContent += '\n';
                            });
                            allContent += '\n';
                        }

                        // å¯¼å‡ºè¯Šæ–­èŠ‚ç‚¹
                        if (diagnosisNodes.length > 0) {
                            allContent += 'ğŸŸ¡ è¯Šæ–­/è¾¨è¯èŠ‚ç‚¹\n';
                            allContent += 'â”€'.repeat(80) + '\n';
                            diagnosisNodes.forEach((node, idx) => {
                                const text = node.description || node.name || '(æ— æè¿°)';
                                allContent += `${idx + 1}. ${text}\n`;
                                if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                                    allContent += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                                }
                                allContent += '\n';
                            });
                            allContent += '\n';
                        }

                        // å¯¼å‡ºå¤„æ–¹èŠ‚ç‚¹
                        if (prescriptionNodes.length > 0) {
                            allContent += 'ğŸŸ¢ å¤„æ–¹/æ²»ç–—èŠ‚ç‚¹\n';
                            allContent += 'â”€'.repeat(80) + '\n';
                            prescriptionNodes.forEach((node, idx) => {
                                const text = node.description || node.name || '(æ— æè¿°)';
                                allContent += `${idx + 1}. ${text}\n`;
                                if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                                    allContent += `   ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                                }
                                allContent += '\n';
                            });
                            allContent += '\n';
                        }

                        // å†³ç­–æµç¨‹
                        if (treeNodes.length > 1) {
                            allContent += 'ğŸ”€ å†³ç­–æµç¨‹\n';
                            allContent += 'â”€'.repeat(80) + '\n';
                            treeNodes.forEach((node) => {
                                const connections = node.connections || [];
                                if (connections.length > 0) {
                                    connections.forEach(targetId => {
                                        const targetNode = treeNodes.find(n => n.id === targetId);
                                        if (targetNode) {
                                            const nodeText = node.description || node.name || '(æ— æè¿°)';
                                            const targetText = targetNode.description || targetNode.name || '(æ— æè¿°)';
                                            allContent += `${nodeText}\n`;
                                            allContent += `  â†“\n`;
                                            allContent += `${targetText}\n\n`;
                                        }
                                    });
                                }
                            });
                        }
                    }

                    allContent += 'â–²'.repeat(80) + '\n';
                    allContent += `ã€å†³ç­–æ ‘ ${index + 1} ç»“æŸã€‘\n`;
                    allContent += 'â–²'.repeat(80) + '\n';
                });

                // æ·»åŠ ç»“å°¾
                allContent += '\n\n';
                allContent += 'â•'.repeat(80) + '\n';
                allContent += `æ‰¹é‡å¯¼å‡ºå®Œæˆ | å…± ${patterns.length} ä¸ªå†³ç­–æ ‘ | TCM-AI ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ\n`;
                allContent += 'â•'.repeat(80) + '\n';

                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([allContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                const doctorName = currentUser?.name || 'åŒ»ç”Ÿ';
                a.download = `${doctorName}_æ‰€æœ‰å†³ç­–æ ‘_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();

                URL.revokeObjectURL(url);
                showResult('æˆåŠŸ', `âœ… å·²å¯¼å‡º ${patterns.length} ä¸ªå†³ç­–æ ‘\n\næ–‡ä»¶å·²ä¸‹è½½ï¼Œå¯ç”¨è®°äº‹æœ¬æ‰“å¼€æŸ¥çœ‹`, 'success');

            } catch (error) {
                console.error('æ‰¹é‡å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `æ‰¹é‡å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¯¼å‡ºä¸ºMarkdownæ ¼å¼
        function exportAsMarkdown() {
            console.log('å¯¼å‡ºMarkdownæ ¼å¼è¢«è°ƒç”¨');

            const diseaseName = getCurrentDiseaseName() || 'æœªå‘½åç–¾ç—…';
            const exportTime = new Date().toLocaleString('zh-CN');

            let content = '';
            content += `# ä¸­åŒ»ä¸´åºŠå†³ç­–æ ‘ - ${diseaseName}\n\n`;
            content += `> **å¯¼å‡ºæ—¶é—´**: ${exportTime}  \n`;
            content += `> **èŠ‚ç‚¹æ€»æ•°**: ${nodes.length}\n\n`;
            content += `---\n\n`;

            // è·å–ä¸´åºŠæ€ç»´æè¿°
            const thinkingTextarea = document.getElementById('clinicalThinking');
            const thinkingProcess = thinkingTextarea ? thinkingTextarea.value.trim() : '';

            if (thinkingProcess) {
                content += `## ğŸ’­ ä¸´åºŠæ€ç»´æè¿°\n\n`;
                content += `${thinkingProcess}\n\n`;
                content += `---\n\n`;
            }

            // æŒ‰ç±»å‹åˆ†ç»„èŠ‚ç‚¹
            const diseaseNodes = nodes.filter(n => n.type === 'disease');
            const symptomNodes = nodes.filter(n => n.type === 'symptom');
            const diagnosisNodes = nodes.filter(n => n.type === 'diagnosis');
            const prescriptionNodes = nodes.filter(n => n.type === 'prescription');

            // å¯¼å‡ºç–¾ç—…èŠ‚ç‚¹
            if (diseaseNodes.length > 0) {
                content += `## ğŸ”´ ç–¾ç—…/è¯å€™èŠ‚ç‚¹\n\n`;
                diseaseNodes.forEach((node, index) => {
                    content += `${index + 1}. **${node.description}**\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   - ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
            }

            // å¯¼å‡ºç—‡çŠ¶èŠ‚ç‚¹
            if (symptomNodes.length > 0) {
                content += `## ğŸ”µ ç—‡çŠ¶/ä½“å¾èŠ‚ç‚¹\n\n`;
                symptomNodes.forEach((node, index) => {
                    content += `${index + 1}. **${node.description}**\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   - ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
            }

            // å¯¼å‡ºè¯Šæ–­èŠ‚ç‚¹
            if (diagnosisNodes.length > 0) {
                content += `## ğŸŸ¡ è¯Šæ–­/è¾¨è¯èŠ‚ç‚¹\n\n`;
                diagnosisNodes.forEach((node, index) => {
                    content += `${index + 1}. **${node.description}**\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   - ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
            }

            // å¯¼å‡ºå¤„æ–¹èŠ‚ç‚¹
            if (prescriptionNodes.length > 0) {
                content += `## ğŸŸ¢ å¤„æ–¹/æ²»ç–—èŠ‚ç‚¹\n\n`;
                prescriptionNodes.forEach((node, index) => {
                    content += `${index + 1}. **${node.description}**\n`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        content += `   - ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}\n`;
                    }
                    content += '\n';
                });
            }

            // å†³ç­–æµç¨‹
            if (nodes.length > 1) {
                content += `## ğŸ”€ å†³ç­–æµç¨‹\n\n`;
                content += '```\n';
                nodes.forEach((node) => {
                    const connections = node.connections || [];
                    if (connections.length > 0) {
                        connections.forEach(targetId => {
                            const targetNode = nodes.find(n => n.id === targetId);
                            if (targetNode) {
                                content += `${node.description}\n`;
                                content += `  â†“\n`;
                                content += `${targetNode.description}\n\n`;
                            }
                        });
                    }
                });
                content += '```\n\n';
            }

            content += `---\n\n`;
            content += `*å¯¼å‡ºè‡ª TCM-AI ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ*\n`;

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `å†³ç­–æ ‘_${diseaseName}_${new Date().toISOString().split('T')[0]}.md`;
            a.click();

            URL.revokeObjectURL(url);
            showResult('æˆåŠŸ', 'âœ… Markdownæ–‡ä»¶å·²ä¸‹è½½ï¼Œå¯ç”¨Typoraç­‰ç¼–è¾‘å™¨æ‰“å¼€', 'success');
        }

        // å¯¼å‡ºä¸ºHTMLæ ¼å¼ï¼ˆå¯åœ¨æµè§ˆå™¨æ‰“å¼€å’Œæ‰“å°ï¼‰
        function exportAsHTML() {
            console.log('å¯¼å‡ºHTMLæ ¼å¼è¢«è°ƒç”¨');

            const diseaseName = getCurrentDiseaseName() || 'æœªå‘½åç–¾ç—…';
            const exportTime = new Date().toLocaleString('zh-CN');

            let html = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†³ç­–æ ‘ - ${diseaseName}</title>
    <style>
        body {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.8;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            text-align: center;
        }
        .meta {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            color: #34495e;
        }
        .meta-item {
            margin: 5px 0;
        }
        h2 {
            color: #16a085;
            margin-top: 30px;
            border-left: 4px solid #16a085;
            padding-left: 10px;
        }
        .thinking {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin: 15px 0;
            white-space: pre-wrap;
        }
        .node-list {
            list-style: none;
            padding: 0;
        }
        .node-item {
            background: #f8f9fa;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .node-item.disease { border-left-color: #e74c3c; }
        .node-item.symptom { border-left-color: #3498db; }
        .node-item.diagnosis { border-left-color: #f39c12; }
        .node-item.prescription { border-left-color: #27ae60; }
        .symptoms {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .flow {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            font-family: "Courier New", monospace;
            white-space: pre-wrap;
        }
        .footer {
            text-align: center;
            color: #95a5a6;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }
        @media print {
            body {
                background: white;
                margin: 0;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¸­åŒ»ä¸´åºŠå†³ç­–æ ‘</h1>
        <h2 style="text-align: center; color: #e74c3c; border: none; margin: 10px 0;">${diseaseName}</h2>

        <div class="meta">
            <div class="meta-item">ğŸ“… <strong>å¯¼å‡ºæ—¶é—´</strong>: ${exportTime}</div>
            <div class="meta-item">ğŸ“Š <strong>èŠ‚ç‚¹æ€»æ•°</strong>: ${nodes.length}</div>
        </div>
`;

            // è·å–ä¸´åºŠæ€ç»´æè¿°
            const thinkingTextarea = document.getElementById('clinicalThinking');
            const thinkingProcess = thinkingTextarea ? thinkingTextarea.value.trim() : '';

            if (thinkingProcess) {
                html += `
        <h2>ğŸ’­ ä¸´åºŠæ€ç»´æè¿°</h2>
        <div class="thinking">${thinkingProcess}</div>
`;
            }

            // æŒ‰ç±»å‹åˆ†ç»„èŠ‚ç‚¹
            const diseaseNodes = nodes.filter(n => n.type === 'disease');
            const symptomNodes = nodes.filter(n => n.type === 'symptom');
            const diagnosisNodes = nodes.filter(n => n.type === 'diagnosis');
            const prescriptionNodes = nodes.filter(n => n.type === 'prescription');

            // å¯¼å‡ºç–¾ç—…èŠ‚ç‚¹
            if (diseaseNodes.length > 0) {
                html += `
        <h2>ğŸ”´ ç–¾ç—…/è¯å€™èŠ‚ç‚¹</h2>
        <ul class="node-list">
`;
                diseaseNodes.forEach((node, index) => {
                    html += `            <li class="node-item disease">
                <strong>${index + 1}. ${node.description}</strong>`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        html += `
                <div class="symptoms">ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}</div>`;
                    }
                    html += `
            </li>
`;
                });
                html += `        </ul>
`;
            }

            // å¯¼å‡ºç—‡çŠ¶èŠ‚ç‚¹
            if (symptomNodes.length > 0) {
                html += `
        <h2>ğŸ”µ ç—‡çŠ¶/ä½“å¾èŠ‚ç‚¹</h2>
        <ul class="node-list">
`;
                symptomNodes.forEach((node, index) => {
                    html += `            <li class="node-item symptom">
                <strong>${index + 1}. ${node.description}</strong>`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        html += `
                <div class="symptoms">ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}</div>`;
                    }
                    html += `
            </li>
`;
                });
                html += `        </ul>
`;
            }

            // å¯¼å‡ºè¯Šæ–­èŠ‚ç‚¹
            if (diagnosisNodes.length > 0) {
                html += `
        <h2>ğŸŸ¡ è¯Šæ–­/è¾¨è¯èŠ‚ç‚¹</h2>
        <ul class="node-list">
`;
                diagnosisNodes.forEach((node, index) => {
                    html += `            <li class="node-item diagnosis">
                <strong>${index + 1}. ${node.description}</strong>`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        html += `
                <div class="symptoms">ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}</div>`;
                    }
                    html += `
            </li>
`;
                });
                html += `        </ul>
`;
            }

            // å¯¼å‡ºå¤„æ–¹èŠ‚ç‚¹
            if (prescriptionNodes.length > 0) {
                html += `
        <h2>ğŸŸ¢ å¤„æ–¹/æ²»ç–—èŠ‚ç‚¹</h2>
        <ul class="node-list">
`;
                prescriptionNodes.forEach((node, index) => {
                    html += `            <li class="node-item prescription">
                <strong>${index + 1}. ${node.description}</strong>`;
                    if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                        html += `
                <div class="symptoms">ç›¸å…³ç—‡çŠ¶: ${node.relatedSymptoms.join(', ')}</div>`;
                    }
                    html += `
            </li>
`;
                });
                html += `        </ul>
`;
            }

            // å†³ç­–æµç¨‹
            if (nodes.length > 1) {
                html += `
        <h2>ğŸ”€ å†³ç­–æµç¨‹</h2>
        <div class="flow">`;
                nodes.forEach((node) => {
                    const connections = node.connections || [];
                    if (connections.length > 0) {
                        connections.forEach(targetId => {
                            const targetNode = nodes.find(n => n.id === targetId);
                            if (targetNode) {
                                html += `${node.description}\n  â†“\n${targetNode.description}\n\n`;
                            }
                        });
                    }
                });
                html += `</div>
`;
            }

            html += `
        <div class="footer">
            å¯¼å‡ºè‡ª TCM-AI ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ<br>
            ${exportTime}
        </div>
    </div>
</body>
</html>`;

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `å†³ç­–æ ‘_${diseaseName}_${new Date().toISOString().split('T')[0]}.html`;
            a.click();

            URL.revokeObjectURL(url);
            showResult('æˆåŠŸ', 'âœ… HTMLæ–‡ä»¶å·²ä¸‹è½½ï¼Œå¯ç”¨æµè§ˆå™¨æ‰“å¼€å¹¶æ‰“å°', 'success');
        }

        // æ¸²æŸ“èŠ‚ç‚¹
        function renderNode(node) {
            const canvas = document.getElementById('canvas');
            const emptyHint = document.getElementById('emptyHint');
            
            if (emptyHint) {
                emptyHint.remove();
            }

            const nodeElement = document.createElement('div');

            nodeElement.className = `node ${node.type}`;
            nodeElement.id = node.id;
            nodeElement.style.left = `${node.x}px`;
            nodeElement.style.top = `${node.y}px`;

            // æ„å»ºèŠ‚ç‚¹å†…å®¹ï¼Œæ”¯æŒç›¸å…³ç—‡çŠ¶æ˜¾ç¤º
            let nodeContent = node.description || '';
            if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                nodeContent = `${nodeContent}
                    <div class="related-symptoms">
                        <div class="symptoms-label">ç›¸å…³ç—‡çŠ¶:</div>
                        <div class="symptoms-list">${node.relatedSymptoms.join(', ')}</div>
                    </div>`;
            }

            // æ™ºèƒ½æ–‡æœ¬å¤„ç† - æ£€æŸ¥å†…å®¹é•¿åº¦
            const isLongContent = nodeContent.length > 120;
            const contentId = `content_${node.id}`;

            // ä¸ºä¸åŒç±»å‹èŠ‚ç‚¹æ·»åŠ å›¾æ ‡
            const typeIcons = {
                'condition': 'ğŸ¥',
                'diagnosis': 'ğŸ”',
                'treatment': 'ğŸ’Š',
                'formula': 'ğŸŒ¿',
                'symptom': 'ğŸ“‹',
                'pathogenesis': 'âš¡',
                'syndrome': 'ğŸ¯',
                'principle': 'ğŸ“',
                'prescription': 'ğŸ“',
                'four_diagnosis': 'ğŸ‘',
                'disease': 'ğŸ”¬'
            };
            const nodeIcon = typeIcons[node.type] || 'ğŸ“„';

            nodeElement.innerHTML = `
                <button class="delete-btn" onclick="deleteNodeById('${node.id}')">Ã—</button>
                <div class="node-title">
                    <span class="node-type-icon">${nodeIcon}</span>
                    ${node.name}
                </div>
                <div class="node-content" id="${contentId}">${nodeContent}</div>
                ${isLongContent ? `<div class="expand-btn" onclick="toggleNodeContent('${node.id}')">å±•å¼€è¯¦æƒ… â–¼</div>` : ''}
            `;
            
            // å¦‚æœå†…å®¹è¿‡é•¿ï¼Œé»˜è®¤æˆªæ–­æ˜¾ç¤º
            if (isLongContent) {
                const contentDiv = nodeElement.querySelector('.node-content');
                contentDiv.classList.add('truncated');
            }
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            nodeElement.addEventListener('click', function(e) {
                e.stopPropagation();
                selectNode(node);
            });
            
            // æ·»åŠ å³é”®èœå•äº‹ä»¶
            nodeElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showContextMenu(e, node);
            });
            
            // ä½¿ç”¨ç»Ÿä¸€çš„ç¼–è¾‘åŠŸèƒ½ç»‘å®š
            ensureNodeEditability(nodeElement, node);
            
            // æ·»åŠ æ‹–æ‹½
            makeNodeDraggable(nodeElement, node);
            
            canvas.appendChild(nodeElement);
        }

        

        // é€‰æ‹©èŠ‚ç‚¹
        function selectNode(node) {
            // æ¸…é™¤å…¶ä»–é€‰æ‹©
            document.querySelectorAll('.node').forEach(el => {
                el.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰èŠ‚ç‚¹
            document.getElementById(node.id).classList.add('selected');
            selectedNode = node;
            
            showSelectedNodeInfo(node);
            console.log('é€‰æ‹©äº†èŠ‚ç‚¹:', node.name);
        }

        // ä½¿èŠ‚ç‚¹å¯æ‹–æ‹½
        function makeNodeDraggable(element, node) {
            let isDragging = false;
            let startX, startY, startNodeX, startNodeY;

            element.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startNodeX = node.x;
                startNodeY = node.y;
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            function handleMouseMove(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                node.x = Math.max(0, startNodeX + deltaX);
                node.y = Math.max(0, startNodeY + deltaY);
                
                updateNodePosition(node);
            }

            function handleMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        }

        // æ›´æ–°èŠ‚ç‚¹ä½ç½®
        function updateNodePosition(node) {
            const element = document.getElementById(node.id);
            if (element) {
                element.style.left = `${node.x}px`;
                element.style.top = `${node.y}px`;
            }
        }

        // è½¬æ¢èŠ‚ç‚¹ä¸ºè·¯å¾„æ ¼å¼
        function convertNodesToPaths() {
            if (nodes.length === 0) return [];
            
            return [{
                id: 'path_1',
                steps: nodes.map(node => ({
                    type: node.type,
                    content: node.name
                })),
                keywords: [document.getElementById('diseaseName').value.trim()],
                created_by: currentUser?.name || 'åŒ¿åç”¨æˆ·'
            }];
        }

        // æ›´æ–°ç”»å¸ƒçŠ¶æ€
        function updateCanvas() {
            const canvas = document.getElementById('canvas');
            const emptyHint = document.getElementById('emptyHint');
            const canvasToolbar = document.getElementById('canvasToolbar');

            if (nodes.length === 0 && !emptyHint) {
                canvas.innerHTML = `
                    <div class="empty-canvas" id="emptyHint">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸŒ³</div>
                        <h3>å¼€å§‹æ„å»ºæ‚¨çš„å†³ç­–æ ‘</h3>
                        <p style="margin: 10px 0;">è¾“å…¥ç–¾ç—…åç§°ï¼Œç„¶åç‚¹å‡»"AIç”Ÿæˆå†³ç­–æ ‘"</p>
                        <p style="color: #9ca3af; font-size: 12px;">æˆ–ç‚¹å‡»"æ ‡å‡†è·¯å¾„"å¿«é€Ÿå¼€å§‹</p>
                    </div>
                `;
            }

            // ğŸ†• æ§åˆ¶ç”»å¸ƒå·¥å…·æ æ˜¾ç¤ºï¼šæœ‰èŠ‚ç‚¹æ—¶æ˜¾ç¤ºï¼Œæ— èŠ‚ç‚¹æ—¶éšè—
            if (canvasToolbar) {
                canvasToolbar.style.display = nodes.length > 0 ? 'flex' : 'none';
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(message) {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            
            loadingText.textContent = message;
            loading.style.display = 'flex';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            const loading = document.getElementById('loading');
            loading.style.display = 'none';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(title, message, type) {
            const resultsDiv = document.getElementById('analysisResults');
            const container = document.getElementById('analysisResultsContainer');

            const typeColors = {
                success: '#22c55e',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };

            const color = typeColors[type] || typeColors.info;

            const resultElement = document.createElement('div');
            resultElement.className = 'result-panel';
            resultElement.innerHTML = `
                <div class="result-title" style="color: ${color};">${title}</div>
                <div style="font-size: 13px; color: #374151;">${message}</div>
            `;

            resultsDiv.appendChild(resultElement);

            // æ˜¾ç¤ºåˆ†æç»“æœå®¹å™¨
            if (container) {
                container.style.display = 'block';
            }

            // 5ç§’åè‡ªåŠ¨ç§»é™¤æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    resultElement.remove();
                }, 5000);
            }
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function showAnalysisResult(analysisHtml) {
            // æ¸…é™¤ä¹‹å‰çš„ç»“æœï¼Œé¿å…é‡å¤
            clearResults();

            const resultsDiv = document.getElementById('analysisResults');
            const container = document.getElementById('analysisResultsContainer');

            const resultElement = document.createElement('div');
            resultElement.className = 'result-panel';
            resultElement.innerHTML = `
                <div class="result-title">ğŸ§  ä¸­åŒ»ç†è®ºåˆ†æç»“æœ</div>
                <div style="font-size: 13px;">${analysisHtml}</div>
            `;

            resultsDiv.appendChild(resultElement);

            // æ˜¾ç¤ºåˆ†æç»“æœå®¹å™¨
            if (container) {
                container.style.display = 'block';
            }
        }

        // åˆ‡æ¢åˆ†æç»“æœæ˜¾ç¤º/éšè—
        function toggleAnalysisResults() {
            const content = document.getElementById('analysisResultsContent');
            const toggle = document.getElementById('analysisResultsToggle');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }

        // æ˜¾ç¤ºé—æ¼é€»è¾‘ç»“æœ
        function showMissingLogicResult(data) {
            // æ¸…é™¤ä¹‹å‰çš„ç»“æœï¼Œé¿å…é‡å¤
            clearResults();
            
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = '<div class="result-title">ğŸ’¡ é—æ¼é€»è¾‘æ£€æµ‹ç»“æœ</div>';
            
            if (data.missing_analyses && data.missing_analyses.length > 0) {
                data.missing_analyses.forEach(analysis => {
                    html += `<div style="margin: 15px 0;"><strong>${analysis.category}:</strong><br>`;
                    analysis.items.forEach(item => {
                        html += `
                            <div class="suggestion-item" onclick="addSuggestionToTree('${item.suggested_addition.step_type}', '${item.content}', '${item.description}')">
                                <div class="suggestion-content">${item.content}</div>
                                <div class="suggestion-desc">${item.description}</div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                });
            } else {
                html += '<div style="color: #22c55e;">âœ… å½“å‰å†³ç­–æ ‘é€»è¾‘å®Œæ•´ï¼Œæœªå‘ç°æ˜æ˜¾é—æ¼</div>';
            }
            
            const resultElement = document.createElement('div');
            resultElement.className = 'result-panel';
            resultElement.innerHTML = html;
            
            resultsDiv.appendChild(resultElement);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            const resultsDiv = document.getElementById('analysisResults');
            const container = document.getElementById('analysisResultsContainer');
            resultsDiv.innerHTML = '';

            // éšè—åˆ†æç»“æœå®¹å™¨
            if (container) {
                container.style.display = 'none';
            }
        }


        // ç»˜åˆ¶è¿æ¥çº¿
        function drawConnections() {
            const svg = document.getElementById('branchSvg');
            
            // æ¸…é™¤ç°æœ‰è¿æ¥çº¿
            const existingPaths = svg.querySelectorAll('.branch-line, .branch-path');
            existingPaths.forEach(path => path.remove());
            
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                
                if (fromNode && toNode) {
                    const fromElement = document.getElementById(fromNode.id);
                    const toElement = document.getElementById(toNode.id);
                    
                    if (fromElement && toElement) {
                        const fromRect = fromElement.getBoundingClientRect();
                        const toRect = toElement.getBoundingClientRect();
                        const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                        
                        // è®¡ç®—è¿æ¥ç‚¹ä½ç½®
                        const x1 = fromRect.left - canvasRect.left + fromRect.width;
                        const y1 = fromRect.top - canvasRect.top + fromRect.height / 2;
                        const x2 = toRect.left - canvasRect.left;
                        const y2 = toRect.top - canvasRect.top + toRect.height / 2;
                        
                        // ä½¿ç”¨è´å¡å°”æ›²çº¿åˆ›å»ºå¹³æ»‘è¿æ¥
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const midX = (x1 + x2) / 2;
                        
                        // åˆ›å»ºå¹³æ»‘çš„æ›²çº¿è·¯å¾„
                        const d = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                        
                        path.setAttribute('d', d);
                        path.setAttribute('class', 'branch-path');
                        path.setAttribute('fill', 'none');
                        path.setAttribute('stroke', '#3b82f6');
                        path.setAttribute('stroke-width', '2');
                        path.setAttribute('marker-end', 'url(#arrowhead)');
                        
                        // æ·»åŠ è¿æ¥æ ‡ç­¾ï¼ˆå¦‚æœéœ€è¦ï¼‰
                        if (conn.label) {
                            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            text.setAttribute('x', midX);
                            text.setAttribute('y', (y1 + y2) / 2 - 10);
                            text.setAttribute('text-anchor', 'middle');
                            text.setAttribute('font-size', '12');
                            text.setAttribute('fill', '#6b7280');
                            text.textContent = conn.label;
                            svg.appendChild(text);
                        }
                        
                        svg.appendChild(path);
                    }
                }
            });
        }

        // æ˜¾ç¤ºé€‰ä¸­èŠ‚ç‚¹ä¿¡æ¯
        function showSelectedNodeInfo(node) {
            const infoDiv = document.getElementById('selectedNodeInfo');
            const contentDiv = document.getElementById('nodeInfoContent');
            
            contentDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">${node.name}</div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">ç±»å‹: ${getNodeTypeText(node.type)}</div>
                <div style="font-size: 12px; color: #374151;">${node.description}</div>
                ${selectedNode ? '<div style="margin-top: 10px; font-size: 11px; color: #059669;">ğŸ’¡ ç‚¹å‡»é—æ¼é€»è¾‘æ£€æµ‹ç»“æœä¸­çš„å»ºè®®å¯æ·»åŠ åˆ°æ­¤èŠ‚ç‚¹</div>' : ''}
            `;
            
            infoDiv.style.display = 'block';
        }

        // éšè—é€‰ä¸­èŠ‚ç‚¹ä¿¡æ¯
        function hideSelectedNodeInfo() {
            const infoDiv = document.getElementById('selectedNodeInfo');
            infoDiv.style.display = 'none';
        }

        // è·å–èŠ‚ç‚¹ç±»å‹æ–‡æœ¬
        function getNodeTypeText(type) {
            const typeMap = {
                'symptom': 'ç—‡çŠ¶',
                'condition': 'åˆ¤æ–­æ¡ä»¶',
                'diagnosis': 'è¯Šæ–­',
                'treatment': 'æ²»ç–—',
                'formula': 'æ–¹å‰‚'
            };
            return typeMap[type] || type;
        }

        // æ·»åŠ å»ºè®®åˆ°å†³ç­–æ ‘ (æ”¯æŒå¼‚æ­¥æ•°æ®åº“æŸ¥è¯¢)
        async function addSuggestionToTree(nodeType, nodeName, description) {
            if (!selectedNode) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ·»åŠ ä½ç½®');
                return;
            }
            
            // æ™ºèƒ½ç—‡çŠ¶åˆå¹¶ï¼šæ£€æŸ¥æ˜¯å¦åº”è¯¥åˆå¹¶åˆ°ç°æœ‰ç—‡çŠ¶ç¾¤
            if (nodeType === 'symptom') {
                console.log(`å¼€å§‹æ™ºèƒ½ç—‡çŠ¶åˆ†æ: ${nodeName}`);
                const mergeTarget = await findSymptomMergeTarget(nodeName);
                if (mergeTarget) {
                    // ç»™ç”¨æˆ·ä¸€ä¸ªç¡®è®¤æç¤º
                    const isSelectedNode = mergeTarget === selectedNode;
                    const targetDescription = isSelectedNode ? 
                        `å½“å‰é€‰ä¸­çš„"${mergeTarget.name}"` : 
                        `ç°æœ‰çš„"${mergeTarget.name}"`;
                    
                    console.log(`å‡†å¤‡åˆå¹¶ç—‡çŠ¶"${nodeName}"åˆ°${targetDescription}èŠ‚ç‚¹`);
                    mergeSymptomToNode(mergeTarget, nodeName, description);
                    return;
                }
            }
            
            // å¦‚æœä¸éœ€è¦åˆå¹¶ï¼Œåˆ›å»ºæ–°çš„ç‹¬ç«‹èŠ‚ç‚¹
            const newX = selectedNode.x + 250;
            const newY = selectedNode.y + (Math.random() - 0.5) * 100; // ç¨å¾®éšæœºåç§»
            
            const newNode = {
                id: `suggested_${nodeCounter++}`,
                type: nodeType,
                name: nodeName,
                description: description,
                x: newX,
                y: newY
            };
            
            nodes.push(newNode);
            renderNode(newNode);
            
            // åˆ›å»ºè¿æ¥
            connections.push({
                from: selectedNode.id,
                to: newNode.id
            });
            
            drawConnections();
            updateCanvas();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showResult('æˆåŠŸ', `âœ… å·²æ·»åŠ "${nodeName}"åˆ°å†³ç­–æ ‘`, 'success');
        }

        // æ™ºèƒ½ç—‡çŠ¶åˆå¹¶ï¼šæŸ¥æ‰¾åº”è¯¥åˆå¹¶çš„ç›®æ ‡èŠ‚ç‚¹ (æ•°æ®åº“ç‰ˆæœ¬)
        async function findSymptomMergeTarget(newSymptom) {
            console.log(`\n=== æ™ºèƒ½ç—‡çŠ¶åˆå¹¶åˆ†æ ===`);
            console.log(`æ–°ç—‡çŠ¶: ${newSymptom}`);
            console.log(`å½“å‰é€‰ä¸­èŠ‚ç‚¹:`, selectedNode);
            console.log(`å½“å‰é€‰ä¸­èŠ‚ç‚¹çš„ç›¸å…³ç—‡çŠ¶:`, selectedNode?.relatedSymptoms);
            
            // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šå¦‚æœå½“å‰é€‰ä¸­çš„èŠ‚ç‚¹æ˜¯ç—‡çŠ¶ç±»å‹ï¼Œä¼˜å…ˆæ£€æŸ¥æ•°æ®åº“å…³ç³»
            if (selectedNode && selectedNode.type === 'symptom') {
                console.log(`æ£€æŸ¥é€‰ä¸­èŠ‚ç‚¹ä¸æ–°ç—‡çŠ¶çš„æ•°æ®åº“å…³ç³»...`);
                
                try {
                    // è°ƒç”¨ç—‡çŠ¶å…³ç³»æ•°æ®åº“API
                    const response = await fetch(`/api/symptom/quick_analyze/${encodeURIComponent(selectedNode.name)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const allRelatedSymptoms = [
                            ...data.data.related_symptoms,
                            ...data.data.accompanying_symptoms
                        ];
                        
                        console.log(`æ•°æ®åº“æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ°ç›¸å…³ç—‡çŠ¶:`, allRelatedSymptoms);
                        
                        if (allRelatedSymptoms.includes(newSymptom)) {
                            console.log(`âœ… æ•°æ®åº“ç¡®è®¤å…³ç³»ï¼Œä¼˜å…ˆåˆå¹¶åˆ°é€‰ä¸­èŠ‚ç‚¹: ${newSymptom} -> ${selectedNode.name}`);
                            return selectedNode;
                        }
                        
                        // æ£€æŸ¥æ¨¡ç³ŠåŒ¹é…
                        const fuzzyMatch = allRelatedSymptoms.find(symptom => 
                            symptom.includes(newSymptom) || newSymptom.includes(symptom)
                        );
                        if (fuzzyMatch) {
                            console.log(`âœ… æ•°æ®åº“æ¨¡ç³ŠåŒ¹é…æˆåŠŸ: ${newSymptom} â‰ˆ ${fuzzyMatch} -> ${selectedNode.name}`);
                            return selectedNode;
                        }
                    }
                } catch (error) {
                    console.warn(`æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°é€»è¾‘:`, error);
                }
                
                // å›é€€åˆ°åŸæœ‰çš„æœ¬åœ°å…³ç³»æ£€æŸ¥
                if (isSymptomRelated(selectedNode.name, newSymptom)) {
                    console.log(`âœ… æœ¬åœ°å…³ç³»æ£€æŸ¥é€šè¿‡ï¼Œåˆå¹¶åˆ°é€‰ä¸­èŠ‚ç‚¹: ${newSymptom} -> ${selectedNode.name}`);
                    return selectedNode;
                }
                
                console.log(`âŒ é€‰ä¸­èŠ‚ç‚¹ä¸æ–°ç—‡çŠ¶ä¸ç›¸å…³`);
            }
            
            // ç¬¬äºŒä¼˜å…ˆçº§ï¼šæŸ¥æ‰¾å…¶ä»–ç°æœ‰ç—‡çŠ¶èŠ‚ç‚¹çš„æ•°æ®åº“å…³ç³»
            console.log(`æ£€æŸ¥å…¶ä»–ç—‡çŠ¶èŠ‚ç‚¹çš„æ•°æ®åº“å…³ç³»...`);
            const existingSymptomNodes = nodes.filter(node => 
                node.type === 'symptom' && node !== selectedNode
            );
            
            for (const node of existingSymptomNodes) {
                try {
                    const response = await fetch(`/api/symptom/quick_analyze/${encodeURIComponent(node.name)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const allRelatedSymptoms = [
                            ...data.data.related_symptoms,
                            ...data.data.accompanying_symptoms
                        ];
                        
                        if (allRelatedSymptoms.includes(newSymptom)) {
                            console.log(`âœ… æ•°æ®åº“æ‰¾åˆ°åˆå¹¶ç›®æ ‡: ${newSymptom} -> ${node.name}`);
                            return node;
                        }
                    }
                } catch (error) {
                    console.warn(`èŠ‚ç‚¹ ${node.name} æ•°æ®åº“æŸ¥è¯¢å¤±è´¥:`, error);
                    // ç»§ç»­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
                }
                
                // æœ¬åœ°å…³ç³»æ£€æŸ¥ä½œä¸ºåå¤‡
                if (isSymptomRelated(node.name, newSymptom)) {
                    console.log(`âœ… æœ¬åœ°å…³ç³»æ‰¾åˆ°åˆå¹¶ç›®æ ‡: ${newSymptom} -> ${node.name}`);
                    return node;
                }
            }
            
            console.log(`âŒ æœªæ‰¾åˆ°ä»»ä½•åˆå¹¶ç›®æ ‡ï¼Œå°†åˆ›å»ºæ–°èŠ‚ç‚¹: ${newSymptom}`);
            return null; // æ²¡æ‰¾åˆ°åˆå¹¶ç›®æ ‡ï¼Œéœ€è¦åˆ›å»ºæ–°èŠ‚ç‚¹
        }

        // åˆ¤æ–­ä¸¤ä¸ªç—‡çŠ¶æ˜¯å¦ç›¸å…³
        function isSymptomRelated(existingSymptom, newSymptom) {
            console.log(`  æ£€æŸ¥ç—‡çŠ¶å…³è”æ€§: "${existingSymptom}" vs "${newSymptom}"`);
            
            const relationshipMap = {
                'å¤±çœ ': ['æ—©é†’', 'å¤šæ¢¦', 'å…¥ç¡å›°éš¾', 'ç¡çœ æµ…', 'æ˜“æƒŠé†’', 'å¤œé†’', 'å¿ƒçƒ¦', 'å¥å¿˜', 'å¤´æ™•', 'ç–²ä¹', 'ç²¾ç¥ä¸æŒ¯'],
                'å¤´ç—›': ['å¤´èƒ€', 'å¤´æ™•', 'åå¤´ç—›', 'å¤ªé˜³ç©´ç—›', 'åè„‘ç—›', 'é¢ˆé¡¹å¼ºç›´', 'æ¶å¿ƒ'],
                'èƒƒç—›': ['èƒƒèƒ€', 'èƒƒé…¸', 'åé…¸', 'å—³æ°”', 'èƒƒè„˜ç—›', 'èƒƒéƒ¨ä¸é€‚', 'é£Ÿæ¬²ä¸æŒ¯', 'æ¶å¿ƒ', 'å‘•å'],
                'ä¾¿ç§˜': ['å¤§ä¾¿å¹²ç‡¥', 'æ’ä¾¿å›°éš¾', 'å¤§ä¾¿å¹²ç»“', 'ä¾¿å¹²å¦‚æ —', 'è…¹èƒ€', 'å£å¹²'],
                'è…¹æ³»': ['ä¾¿æº', 'æ³„æ³»', 'æ°´æ³»', 'å¤§ä¾¿ç¨€è–„', 'è…¹ç—›', 'è‚ é¸£', 'é‡Œæ€¥åé‡'],
                'å’³å—½': ['å’³ç—°', 'å¹²å’³', 'å’³å–˜', 'ç—°å¤š', 'å–‰ç—’', 'èƒ¸é—·', 'æ°”çŸ­']
            };
            
            // æ£€æŸ¥åŒå‘å…³ç³»
            for (const [mainSymptom, relatedList] of Object.entries(relationshipMap)) {
                const condition1 = existingSymptom.includes(mainSymptom) && relatedList.includes(newSymptom);
                const condition2 = newSymptom.includes(mainSymptom) && relatedList.includes(existingSymptom);
                
                if (condition1 || condition2) {
                    console.log(`    âœ… æ‰¾åˆ°å…³è”: ${mainSymptom} -> [${relatedList.join(', ')}]`);
                    console.log(`    æ¡ä»¶1 (${existingSymptom} åŒ…å« ${mainSymptom} ä¸” ${newSymptom} åœ¨åˆ—è¡¨ä¸­): ${condition1}`);
                    console.log(`    æ¡ä»¶2 (${newSymptom} åŒ…å« ${mainSymptom} ä¸” ${existingSymptom} åœ¨åˆ—è¡¨ä¸­): ${condition2}`);
                    return true;
                }
            }
            
            console.log(`    âŒ æœªæ‰¾åˆ°å…³è”å…³ç³»`);
            return false;
        }

        // å°†ç—‡çŠ¶åˆå¹¶åˆ°ç°æœ‰èŠ‚ç‚¹
        function mergeSymptomToNode(targetNode, newSymptom, description) {
            console.log(`å¼€å§‹åˆå¹¶ç—‡çŠ¶: ${newSymptom} -> ${targetNode.name}`);
            
            // æ›´æ–°èŠ‚ç‚¹å†…å®¹ï¼Œå°†æ–°ç—‡çŠ¶æ·»åŠ åˆ°æè¿°ä¸­
            if (!targetNode.relatedSymptoms) {
                targetNode.relatedSymptoms = [];
            }
            
            // é¿å…é‡å¤æ·»åŠ 
            if (!targetNode.relatedSymptoms.includes(newSymptom)) {
                targetNode.relatedSymptoms.push(newSymptom);
                
                console.log(`ç—‡çŠ¶åˆå¹¶æˆåŠŸï¼Œå½“å‰ç›¸å…³ç—‡çŠ¶:`, targetNode.relatedSymptoms);
                
                // æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤º
                updateNodeDisplay(targetNode);
                
                // æ˜¾ç¤ºåˆå¹¶æˆåŠŸæ¶ˆæ¯ï¼ŒåŒºåˆ†æ˜¯å¦ä¸ºé€‰ä¸­èŠ‚ç‚¹
                const isSelectedNode = targetNode === selectedNode;
                const message = isSelectedNode ? 
                    `âœ… å·²å°†"${newSymptom}"åˆå¹¶åˆ°æ‚¨é€‰ä¸­çš„"${targetNode.name}"ç—‡çŠ¶ç¾¤` :
                    `âœ… å·²å°†"${newSymptom}"åˆå¹¶åˆ°ç›¸å…³çš„"${targetNode.name}"ç—‡çŠ¶ç¾¤`;
                showResult('æˆåŠŸ', message, 'success');
                
                console.log(`èŠ‚ç‚¹æ˜¾ç¤ºæ›´æ–°å®Œæˆï¼Œç›®æ ‡èŠ‚ç‚¹:`, targetNode);
            } else {
                showResult('æç¤º', `"${newSymptom}"å·²å­˜åœ¨äº"${targetNode.name}"ç—‡çŠ¶ç¾¤ä¸­`, 'info');
            }
        }

        // æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤ºä»¥æ˜¾ç¤ºç›¸å…³ç—‡çŠ¶
        function updateNodeDisplay(node) {
            const nodeElement = document.getElementById(node.id);
            if (!nodeElement) return;
            
            const contentDiv = nodeElement.querySelector('.node-content');
            if (!contentDiv) return;
            
            // æ¸…ç†æè¿°å†…å®¹ï¼Œç§»é™¤å·²æœ‰çš„ç›¸å…³ç—‡çŠ¶HTML
            let cleanDescription = node.description || '';
            // ç§»é™¤ä¹‹å‰æ·»åŠ çš„ç›¸å…³ç—‡çŠ¶HTMLï¼Œé˜²æ­¢é‡å¤
            cleanDescription = cleanDescription.replace(/<div class="related-symptoms">[\s\S]*?<\/div>/g, '');
            
            // é‡æ–°æ„å»ºå†…å®¹
            let nodeContent = cleanDescription;
            if (node.relatedSymptoms && node.relatedSymptoms.length > 0) {
                nodeContent = `${nodeContent}
                    <div class="related-symptoms">
                        <div class="symptoms-label">ç›¸å…³ç—‡çŠ¶:</div>
                        <div class="symptoms-list">${node.relatedSymptoms.join(', ')}</div>
                    </div>`;
            }
            
            contentDiv.innerHTML = nodeContent;
            
            // å…³é”®ä¿®å¤ï¼šç¡®ä¿ä¼ é€’çš„æ˜¯nodesæ•°ç»„ä¸­çš„å®é™…èŠ‚ç‚¹å¯¹è±¡
            const actualNode = nodes.find(n => n.id === node.id);
            if (actualNode) {
                ensureNodeEditability(nodeElement, actualNode);
            } else {
                // ä½œä¸ºåå¤‡ï¼Œä½¿ç”¨ä¼ å…¥çš„nodeå¯¹è±¡
                ensureNodeEditability(nodeElement, node);
            }
        }
        
        // ç¡®ä¿èŠ‚ç‚¹å…·æœ‰ç¼–è¾‘åŠŸèƒ½ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
        function ensureNodeEditability(nodeElement, node) {
            // ç§»é™¤æ—§çš„åŒå‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingHandler = nodeElement._editHandler;
            if (existingHandler) {
                nodeElement.removeEventListener('dblclick', existingHandler);
            }
            
            // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•° - ç»Ÿä¸€ä½¿ç”¨å¯¹è¯æ¡†ç¼–è¾‘
            const newHandler = function(e) {
                e.stopPropagation();
                e.preventDefault();
                // ç›´æ¥æŸ¥æ‰¾æœ€æ–°çš„èŠ‚ç‚¹æ•°æ®
                const currentNode = nodes.find(n => n.id === node.id) || node;
                editNode(currentNode); // ä½¿ç”¨ç»Ÿä¸€çš„å¯¹è¯æ¡†ç¼–è¾‘
            };
            
            // ä¿å­˜äº‹ä»¶å¤„ç†å™¨å¼•ç”¨ä»¥ä¾¿åç»­ç§»é™¤
            nodeElement._editHandler = newHandler;
            
            // æ·»åŠ åŒå‡»ç¼–è¾‘åŠŸèƒ½
            nodeElement.addEventListener('dblclick', newHandler);
            
            // æ ‡è®°ä¸ºå·²ç»‘å®šç¼–è¾‘äº‹ä»¶
            nodeElement.setAttribute('data-editable', 'true');
        }

        // æ›´æ–°èŠ‚ç‚¹æ‹–æ‹½åé‡ç»˜è¿æ¥çº¿
        function updateNodePosition(node) {
            const element = document.getElementById(node.id);
            if (element) {
                element.style.left = `${node.x}px`;
                element.style.top = `${node.y}px`;
                
                // é‡ç»˜è¿æ¥çº¿
                setTimeout(drawConnections, 10);
            }
        }

        // åˆ‡æ¢èŠ‚ç‚¹å†…å®¹æ˜¾ç¤ºçŠ¶æ€
        function toggleNodeContent(nodeId) {
            const contentDiv = document.getElementById(`content_${nodeId}`);
            const expandBtn = contentDiv.nextElementSibling;
            
            if (contentDiv.classList.contains('truncated')) {
                // å±•å¼€å†…å®¹
                contentDiv.classList.remove('truncated');
                if (expandBtn) expandBtn.innerHTML = 'æ”¶èµ·è¯¦æƒ… â–²';
            } else {
                // æ”¶èµ·å†…å®¹
                contentDiv.classList.add('truncated');
                if (expandBtn) expandBtn.innerHTML = 'å±•å¼€è¯¦æƒ… â–¼';
            }
        }
        
        // åˆ é™¤èŠ‚ç‚¹
        function deleteNodeById(nodeId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹å—ï¼Ÿ')) {
                // ä»æ•°ç»„ä¸­ç§»é™¤èŠ‚ç‚¹
                nodes = nodes.filter(node => node.id !== nodeId);
                
                // ç§»é™¤ç›¸å…³è¿æ¥
                connections = connections.filter(conn => 
                    conn.from !== nodeId && conn.to !== nodeId
                );
                
                // ä»DOMä¸­ç§»é™¤èŠ‚ç‚¹
                const element = document.getElementById(nodeId);
                if (element) {
                    element.remove();
                }
                
                // å¦‚æœåˆ é™¤çš„æ˜¯é€‰ä¸­èŠ‚ç‚¹ï¼Œæ¸…é™¤é€‰æ‹©
                if (selectedNode && selectedNode.id === nodeId) {
                    selectedNode = null;
                    hideSelectedNodeInfo();
                }
                
                // é‡ç»˜è¿æ¥çº¿
                drawConnections();
                updateCanvas();
                
                showResult('æˆåŠŸ', 'âœ… èŠ‚ç‚¹å·²åˆ é™¤', 'success');
            }
        }
        
        // æ·»åŠ åˆ†æ”¯èŠ‚ç‚¹ï¼ˆæ”¯æŒå¤šåˆ†æ”¯è¯Šæ–­ï¼‰
        function addBranchNode(parentNode) {
            const nodeType = getNextNodeType(parentNode.type);
            const newNode = {
                id: `branch_${nodeCounter++}`,
                type: nodeType,
                name: getDefaultNodeName(nodeType),
                description: '',
                x: parentNode.x + 200,
                y: parentNode.y + 150
            };
            
            nodes.push(newNode);
            renderNode(newNode);
            
            // åˆ›å»ºè¿æ¥
            connections.push({
                from: parentNode.id,
                to: newNode.id
            });
            
            drawConnections();
            updateCanvas();
            
            // è‡ªåŠ¨é€‰ä¸­æ–°èŠ‚ç‚¹ä»¥ä¾¿ç¼–è¾‘
            selectNode(newNode);
            editNode(newNode);
        }
        
        // æ·»åŠ å­èŠ‚ç‚¹ï¼ˆé¡ºåºæµç¨‹ï¼‰
        function addChildNode(parentNode) {
            const nodeType = getNextNodeType(parentNode.type);
            const newNode = {
                id: `child_${nodeCounter++}`,
                type: nodeType,
                name: getDefaultNodeName(nodeType),
                description: '',
                x: parentNode.x + 250,
                y: parentNode.y
            };
            
            nodes.push(newNode);
            renderNode(newNode);
            
            // åˆ›å»ºè¿æ¥
            connections.push({
                from: parentNode.id,
                to: newNode.id
            });
            
            drawConnections();
            updateCanvas();
            
            // è‡ªåŠ¨é€‰ä¸­æ–°èŠ‚ç‚¹ä»¥ä¾¿ç¼–è¾‘
            selectNode(newNode);
            editNode(newNode);
        }
        
        // æ·»åŠ è¯å€™åˆ†å‹ï¼ˆæ”¯æŒå¤šç§è¯å‹ï¼‰
        function addSyndromeTypes(syndromeNode) {
            const syndromeTypes = [
                { name: 'è¯å‹1', desc: 'è¯·ç¼–è¾‘è¯å‹åç§°å’Œæè¿°' },
                { name: 'è¯å‹2', desc: 'è¯·ç¼–è¾‘è¯å‹åç§°å’Œæè¿°' }
            ];
            
            syndromeTypes.forEach((type, index) => {
                const newNode = {
                    id: `syndrome_type_${nodeCounter++}`,
                    type: 'syndrome',
                    name: type.name,
                    description: type.desc,
                    x: syndromeNode.x + 200,
                    y: syndromeNode.y + (index - 0.5) * 120
                };
                
                nodes.push(newNode);
                renderNode(newNode);
                
                connections.push({
                    from: syndromeNode.id,
                    to: newNode.id
                });
            });
            
            drawConnections();
            updateCanvas();
            showResult('æˆåŠŸ', 'âœ… å·²æ·»åŠ è¯å€™åˆ†å‹æ¨¡æ¿ï¼Œè¯·ç¼–è¾‘å…·ä½“å†…å®¹', 'success');
        }
        
        // ç¼–è¾‘èŠ‚ç‚¹ï¼ˆç¾è§‚å¢å¼ºç‰ˆï¼‰
        function editNode(node) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                backdrop-filter: blur(2px);
                animation: fadeIn 0.2s ease-out;
            `;
            
            // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 0;
                border-radius: 12px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.15);
                z-index: 10000;
                width: 480px;
                max-width: 90vw;
                max-height: 80vh;
                overflow: hidden;
                animation: slideIn 0.3s ease-out;
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.querySelector('#edit-dialog-styles')) {
                const style = document.createElement('style');
                style.id = 'edit-dialog-styles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { 
                            opacity: 0;
                            transform: translate(-50%, -60%);
                            scale: 0.95;
                        }
                        to { 
                            opacity: 1;
                            transform: translate(-50%, -50%);
                            scale: 1;
                        }
                    }
                    .edit-input:focus {
                        outline: none;
                        border-color: #3b82f6;
                        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                    }
                    .edit-btn {
                        transition: all 0.2s ease;
                    }
                    .edit-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // è·å–èŠ‚ç‚¹ç±»å‹å›¾æ ‡
            const typeIcons = {
                'disease': 'ğŸ”¬',
                'four_diagnosis': 'ğŸ‘',
                'symptom': 'ğŸ“‹',
                'pathogenesis': 'âš¡',
                'syndrome': 'ğŸ¯',
                'principle': 'ğŸ“',
                'prescription': 'ğŸ“',
                'modification': 'ğŸ”„',
                'prognosis': 'ğŸ’š'
            };
            
            dialog.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">
                        ${typeIcons[node.type] || 'ğŸ“„'}
                    </div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ç¼–è¾‘èŠ‚ç‚¹ä¿¡æ¯</h3>
                    <p style="margin: 5px 0 0; opacity: 0.9; font-size: 14px;">åŒå‡»æˆ–å³é”®ç¼–è¾‘èŠ‚ç‚¹å†…å®¹</p>
                </div>
                
                <div style="padding: 24px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            ğŸ·ï¸ èŠ‚ç‚¹åç§°
                        </label>
                        <input type="text" id="editNodeName" value="${node.name}" 
                               class="edit-input"
                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                               placeholder="è¯·è¾“å…¥èŠ‚ç‚¹åç§°">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            ğŸ¯ èŠ‚ç‚¹ç±»å‹
                        </label>
                        <select id="editNodeType" 
                                class="edit-input"
                                style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; transition: all 0.2s ease;">
                            <option value="disease" ${node.type === 'disease' ? 'selected' : ''}>ğŸ”¬ ç—…ç§è¯†åˆ«</option>
                            <option value="four_diagnosis" ${node.type === 'four_diagnosis' ? 'selected' : ''}>ğŸ‘ å››è¯Šä¿¡æ¯</option>
                            <option value="symptom" ${node.type === 'symptom' ? 'selected' : ''}>ğŸ“‹ ä¸»è¦ç—‡çŠ¶</option>
                            <option value="pathogenesis" ${node.type === 'pathogenesis' ? 'selected' : ''}>âš¡ ç—…å› ç—…æœº</option>
                            <option value="syndrome" ${node.type === 'syndrome' ? 'selected' : ''}>ğŸ¯ è¯å€™åˆ¤æ–­</option>
                            <option value="principle" ${node.type === 'principle' ? 'selected' : ''}>ğŸ“ æ²»åˆ™æ²»æ³•</option>
                            <option value="prescription" ${node.type === 'prescription' ? 'selected' : ''}>ğŸ“ æ–¹å‰‚å¤„æ–¹</option>
                            <option value="modification" ${node.type === 'modification' ? 'selected' : ''}>ğŸ”„ éšç—‡åŠ å‡</option>
                            <option value="prognosis" ${node.type === 'prognosis' ? 'selected' : ''}>ğŸ’š é¢„åè°ƒç†</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            ğŸ“ è¯¦ç»†æè¿°
                        </label>
                        <textarea id="editNodeDesc" 
                                  class="edit-input"
                                  style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; min-height: 100px; font-size: 14px; line-height: 1.5; resize: vertical; transition: all 0.2s ease; font-family: inherit;"
                                  placeholder="è¯·è¾“å…¥è¯¦ç»†çš„èŠ‚ç‚¹æè¿°ä¿¡æ¯...">${node.description || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="cancelEdit" 
                                class="edit-btn"
                                style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; color: #6b7280;">
                            âœ–ï¸ å–æ¶ˆ
                        </button>
                        <button id="saveNodeEdit" 
                                class="edit-btn"
                                style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);">
                            âœ… ä¿å­˜æ›´æ”¹
                        </button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ é®ç½©å±‚å’Œå¯¹è¯æ¡†åˆ°é¡µé¢
            document.body.appendChild(overlay);
            document.body.appendChild(dialog);
            
            // å…³é—­å¯¹è¯æ¡†çš„å‡½æ•°
            function closeDialog() {
                dialog.style.animation = 'slideOut 0.2s ease-in forwards';
                overlay.style.animation = 'fadeOut 0.2s ease-in forwards';
                
                setTimeout(() => {
                    if (overlay.parentNode) overlay.remove();
                    if (dialog.parentNode) dialog.remove();
                }, 200);
            }
            
            // æ·»åŠ å…³é—­åŠ¨ç”»æ ·å¼
            const exitAnimations = `
                @keyframes slideOut {
                    to { 
                        opacity: 0;
                        transform: translate(-50%, -60%);
                        scale: 0.95;
                    }
                }
                @keyframes fadeOut {
                    to { opacity: 0; }
                }
            `;
            document.querySelector('#edit-dialog-styles').textContent += exitAnimations;
            
            // å–æ¶ˆç¼–è¾‘
            document.getElementById('cancelEdit').onclick = closeDialog;
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.onclick = closeDialog;
            
            // ESCé”®å…³é—­
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closeDialog();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
            
            // ä¿å­˜ç¼–è¾‘
            document.getElementById('saveNodeEdit').onclick = function() {
                const nameInput = document.getElementById('editNodeName');
                const typeSelect = document.getElementById('editNodeType');
                const descTextarea = document.getElementById('editNodeDesc');
                
                // éªŒè¯è¾“å…¥
                if (!nameInput.value.trim()) {
                    nameInput.focus();
                    nameInput.style.borderColor = '#ef4444';
                    setTimeout(() => nameInput.style.borderColor = '#e5e7eb', 2000);
                    return;
                }
                
                // æ›´æ–°èŠ‚ç‚¹æ•°æ®
                node.name = nameInput.value.trim();
                node.type = typeSelect.value;
                node.description = descTextarea.value.trim();
                
                // æ›´æ–°æ˜¾ç¤º
                const nodeElement = document.getElementById(node.id);
                nodeElement.className = `node ${node.type}`;
                updateNodeDisplay(node);
                
                closeDialog();
                showResult('æˆåŠŸ', 'âœ… èŠ‚ç‚¹ä¿¡æ¯å·²æ›´æ–°', 'success');
                
                // ç§»é™¤ESCç›‘å¬å™¨
                document.removeEventListener('keydown', escapeHandler);
            };
            
            // è‡ªåŠ¨èšç„¦åˆ°åç§°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('editNodeName').focus();
                document.getElementById('editNodeName').select();
            }, 100);
        }
        
        // è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„é»˜è®¤ç±»å‹
        function getNextNodeType(currentType) {
            const typeFlow = {
                'disease': 'four_diagnosis',
                'four_diagnosis': 'symptom',
                'symptom': 'pathogenesis',
                'pathogenesis': 'syndrome',
                'syndrome': 'principle',
                'principle': 'prescription',
                'prescription': 'modification',
                'modification': 'prognosis'
            };
            return typeFlow[currentType] || 'symptom';
        }
        
        // è·å–èŠ‚ç‚¹é»˜è®¤åç§°
        function getDefaultNodeName(nodeType) {
            const defaultNames = {
                'disease': 'ç—…ç§åç§°',
                'four_diagnosis': 'å››è¯Šä¿¡æ¯',
                'symptom': 'ä¸»è¦ç—‡çŠ¶',
                'pathogenesis': 'ç—…å› ç—…æœº',
                'syndrome': 'è¯å€™ç±»å‹',
                'principle': 'æ²»åˆ™æ²»æ³•',
                'prescription': 'æ–¹å‰‚åç§°',
                'modification': 'åŠ å‡æ–¹æ¡ˆ',
                'prognosis': 'é¢„åå»ºè®®'
            };
            return defaultNames[nodeType] || 'æ–°èŠ‚ç‚¹';
        }

        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(e, node) {
            hideContextMenu();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.id = 'contextMenu';
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;
            
            const menuItems = [
                { text: 'ğŸ” åˆ†ææ­¤èŠ‚ç‚¹', action: () => analyzeSelectedNode(node) },
                { text: 'ğŸ“ ç¼–è¾‘èŠ‚ç‚¹', action: () => editNode(node) },
                { text: 'â• æ·»åŠ å­èŠ‚ç‚¹', action: () => addChildNode(node) },
                { text: 'ğŸŒ¿ æ·»åŠ åˆ†æ”¯', action: () => addBranchNode(node) }
            ];
            
            if (node.type === 'prescription') {
                menuItems.push({ text: 'ğŸ’Š AIæ–¹å‰‚åˆ†æ', action: () => analyzeFormulaNode(node) });
            }
            
            if (node.type === 'syndrome') {
                menuItems.push({ text: 'ğŸ“‹ æ·»åŠ è¯å€™åˆ†å‹', action: () => addSyndromeTypes(node) });
            }
            
            menuItems.push({ text: 'ğŸ—‘ï¸ åˆ é™¤èŠ‚ç‚¹', action: () => deleteNodeById(node.id), danger: true });
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = `context-menu-item ${item.danger ? 'danger' : ''}`;
                menuItem.innerHTML = item.text;
                menuItem.onclick = () => {
                    item.action();
                    hideContextMenu();
                };
                menu.appendChild(menuItem);
            });
            
            document.body.appendChild(menu);
        }

        // éšè—å³é”®èœå•
        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            if (menu) {
                console.log('Removing context menu');
                menu.remove();
            } else {
                console.log('No context menu to remove');
            }
        }

        // ç—‡çŠ¶é—æ¼æ£€æµ‹
        async function detectMissingSymptoms() {
            console.log('ç—‡çŠ¶é—æ¼æ£€æµ‹è¢«è°ƒç”¨');
            
            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            if (!getCurrentDiseaseName()) {
                alert('è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°');
                return;
            }

            // æ”¶é›†ç°æœ‰ç—‡çŠ¶èŠ‚ç‚¹
            const symptomNodes = nodes.filter(node => node.type === 'symptom');
            const existingSymptoms = symptomNodes.map(node => node.name);
            
            showLoading('æ­£åœ¨æ£€æµ‹ç—‡çŠ¶é—æ¼...');

            try {
                // ä½¿ç”¨ç°æœ‰çš„APIï¼Œä½†ä¸“æ³¨äºç—‡çŠ¶æ£€æµ‹
                const response = await fetch('/api/detect_missing_logic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        disease_name: getCurrentDiseaseName(),
                        current_paths: [],
                        existing_nodes: nodes.filter(node => node.type === 'symptom')
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    hideLoading();
                    showSymptomDetectionResult(data.data, existingSymptoms);
                } else {
                    throw new Error(data.message || 'æ£€æµ‹å¤±è´¥');
                }
            } catch (error) {
                console.error('ç—‡çŠ¶é—æ¼æ£€æµ‹å¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç—‡çŠ¶æ£€æµ‹ç»“æœ
        function showSymptomDetectionResult(data, existingSymptoms) {
            clearResults();
            
            const resultsDiv = document.getElementById('analysisResults');
            
            // ç”Ÿæˆå¸¸è§ç—‡çŠ¶å»ºè®®
            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            const commonSymptoms = getCommonSymptomsForDisease(getCurrentDiseaseName());
            const missingSymptoms = commonSymptoms.filter(symptom => 
                !existingSymptoms.some(existing => existing.includes(symptom))
            );
            
            let html = '<div class="result-title">ğŸ” ç—‡çŠ¶é—æ¼æ£€æµ‹ç»“æœ</div>';
            
            if (missingSymptoms.length > 0) {
                html += '<div style="margin: 15px 0;"><strong>å»ºè®®è¡¥å……çš„ç—‡çŠ¶:</strong><br>';
                missingSymptoms.forEach(symptom => {
                    html += `
                        <div class="suggestion-item" onclick="addSuggestionToTree('symptom', '${symptom}', '${getCurrentDiseaseName()}çš„å¸¸è§ç—‡çŠ¶')">
                            <div class="suggestion-content">${symptom}</div>
                            <div class="suggestion-desc">${getCurrentDiseaseName()}çš„å¸¸è§ç—‡çŠ¶è¡¨ç°</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<div style="color: #22c55e;">âœ… ç—‡çŠ¶è¦†ç›–è¾ƒä¸ºå®Œæ•´</div>';
            }
            
            // æ·»åŠ ç°æœ‰ç—‡çŠ¶åˆ†æ
            if (existingSymptoms.length > 0) {
                html += '<div style="margin: 15px 0;"><strong>ç°æœ‰ç—‡çŠ¶:</strong><br>';
                html += `<div style="font-size: 12px; color: #6b7280;">${existingSymptoms.join('ã€')}</div></div>`;
            }
            
            const resultElement = document.createElement('div');
            resultElement.className = 'result-panel';
            resultElement.innerHTML = html;
            
            resultsDiv.appendChild(resultElement);
        }

        // è·å–ç–¾ç—…å¸¸è§ç—‡çŠ¶
        function getCommonSymptomsForDisease(diseaseName) {
            const symptomDatabase = {
                'å¤±çœ ': ['éš¾ä»¥å…¥ç¡', 'æ—©é†’', 'å¤šæ¢¦', 'ç¡çœ æµ…', 'å¿ƒçƒ¦', 'å¥å¿˜', 'å¤´æ™•', 'ç–²ä¹'],
                'èƒƒç—›': ['èƒƒè„˜ç–¼ç—›', 'èƒƒèƒ€', 'åé…¸', 'å—³æ°”', 'æ¶å¿ƒ', 'é£Ÿæ¬²ä¸æŒ¯', 'è…¹èƒ€', 'ä¾¿ç§˜'],
                'å¤´ç—›': ['å¤´éƒ¨ç–¼ç—›', 'çœ©æ™•', 'æ¶å¿ƒå‘•å', 'ç•å…‰', 'é¢ˆé¡¹å¼ºç›´', 'è€³é¸£', 'è§†ç‰©æ¨¡ç³Š'],
                'å’³å—½': ['å¹²å’³', 'å’³ç—°', 'æ°”çŸ­', 'èƒ¸é—·', 'å’½ç—’', 'å£°å˜¶', 'å‘çƒ­', 'ä¹åŠ›'],
                'è…¹æ³»': ['å¤§ä¾¿ç¨€æº', 'è…¹ç—›', 'è…¹èƒ€', 'è‚ é¸£', 'é‡Œæ€¥åé‡', 'å‘çƒ­', 'æ¶å¿ƒ', 'é£Ÿæ¬²å‡é€€']
            };
            
            return symptomDatabase[diseaseName] || ['ç›¸å…³ç—‡çŠ¶1', 'ç›¸å…³ç—‡çŠ¶2', 'ç›¸å…³ç—‡çŠ¶3'];
        }


        // æ·»åŠ å­èŠ‚ç‚¹
        function addChildNode(parentNode) {
            const nodeType = prompt('è¯·è¾“å…¥èŠ‚ç‚¹ç±»å‹ (symptom/condition/diagnosis/treatment/formula):', 'condition');
            if (!nodeType) return;
            
            const nodeName = prompt('è¯·è¾“å…¥èŠ‚ç‚¹åç§°:', 'æ–°èŠ‚ç‚¹');
            if (!nodeName) return;
            
            const newNode = {
                id: `child_${nodeCounter++}`,
                type: nodeType,
                name: nodeName,
                description: `${parentNode.name}çš„ç›¸å…³èŠ‚ç‚¹`,
                x: parentNode.x + 250,
                y: parentNode.y + (Math.random() - 0.5) * 100
            };
            
            nodes.push(newNode);
            renderNode(newNode);
            
            connections.push({
                from: parentNode.id,
                to: newNode.id
            });
            
            drawConnections();
            showResult('æˆåŠŸ', `âœ… å·²æ·»åŠ å­èŠ‚ç‚¹"${nodeName}"`, 'success');
        }

        // æ·»åŠ è¯æåˆ°æ–¹å‰‚èŠ‚ç‚¹
        function addHerbToFormula(formulaNodeId, herbName, dosage) {
            const formulaNode = nodes.find(node => node.id === formulaNodeId);
            if (!formulaNode) {
                showResult('é”™è¯¯', 'æ‰¾ä¸åˆ°æ–¹å‰‚èŠ‚ç‚¹', 'error');
                return;
            }
            
            // åˆå§‹åŒ– herbs æ•°ç»„
            if (!formulaNode.herbs) {
                formulaNode.herbs = [];
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥è¯æ
            const existingHerb = formulaNode.herbs.find(h => h.name === herbName);
            if (existingHerb) {
                existingHerb.dosage = dosage;
                showResult('æˆåŠŸ', `âœ… å·²æ›´æ–° ${herbName} ç”¨é‡ä¸º ${dosage}`, 'success');
            } else {
                formulaNode.herbs.push({ name: herbName, dosage: dosage });
                showResult('æˆåŠŸ', `âœ… å·²æ·»åŠ  ${herbName} ${dosage} åˆ°æ–¹å‰‚`, 'success');
            }
            
            // æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤º
            updateFormulaNodeDisplay(formulaNode);
        }

        // åº”ç”¨å®Œæ•´æ–¹å‰‚åˆ°èŠ‚ç‚¹
        function applyFullFormulaToNode(formulaNodeId, herbsJsonStr) {
            const formulaNode = nodes.find(node => node.id === formulaNodeId);
            if (!formulaNode) {
                showResult('é”™è¯¯', 'æ‰¾ä¸åˆ°æ–¹å‰‚èŠ‚ç‚¹', 'error');
                return;
            }
            
            try {
                const herbs = JSON.parse(herbsJsonStr.replace(/&quot;/g, '"'));
                formulaNode.herbs = herbs;
                
                updateFormulaNodeDisplay(formulaNode);
                showResult('æˆåŠŸ', `âœ… å·²åº”ç”¨å®Œæ•´æ–¹å‰‚åˆ° ${formulaNode.name}ï¼ŒåŒ…å« ${herbs.length} å‘³è¯æ`, 'success');
            } catch (error) {
                showResult('é”™è¯¯', 'æ–¹å‰‚æ•°æ®è§£æå¤±è´¥', 'error');
            }
        }

        // æ›´æ–°æ–¹å‰‚èŠ‚ç‚¹æ˜¾ç¤º
        function updateFormulaNodeDisplay(formulaNode) {
            const element = document.getElementById(formulaNode.id);
            if (!element) return;
            
            const contentDiv = element.querySelector('.node-content');
            if (contentDiv && formulaNode.herbs && formulaNode.herbs.length > 0) {
                const herbsList = formulaNode.herbs.map(h => `${h.name} ${h.dosage}`).join('ã€');
                contentDiv.innerHTML = `${formulaNode.description || ''}<br><small style="color: #059669;">è¯æ: ${herbsList}</small>`;
            }
        }

        // å¢å¼ºçš„è¯å‹æ™ºèƒ½è¯†åˆ«
        async function analyzeSyndrome() {
            console.log('è¯å‹æ™ºèƒ½è¯†åˆ«è¢«è°ƒç”¨');
            
            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            if (!getCurrentDiseaseName()) {
                alert('è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°');
                return;
            }
            
            // æ”¶é›†æ‰€æœ‰ç—‡çŠ¶ï¼ˆä»èŠ‚ç‚¹å’Œç—‡çŠ¶ç¾¤ï¼‰
            const symptomNodes = nodes.filter(node => node.type === 'symptom');
            const allSymptoms = symptomNodes.map(n => n.name);
            
            // å³ä½¿æ²¡æœ‰ç—‡çŠ¶ä¹Ÿè¿›è¡Œåˆ†æï¼ˆä½¿ç”¨ç–¾ç—…åç§°ï¼‰
            const symptomsForAnalysis = allSymptoms.length > 0 ? allSymptoms : [getCurrentDiseaseName()];

            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            if (!getCurrentDiseaseName()) {
                alert('è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°');
                return;
            }

            showLoading('æ­£åœ¨è¿›è¡Œè¯å‹æ™ºèƒ½è¯†åˆ«...');

            try {
                    const syndromeAnalysis = analyzeSyndromeLocally(getCurrentDiseaseName(), symptomsForAnalysis || []);
                
                hideLoading();
                showSyndromeAnalysisResult(syndromeAnalysis);
                
            } catch (error) {
                console.error('è¯å‹è¯†åˆ«å¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ è¯†åˆ«å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ¨æ€è¯å‹åˆ†æ - ç§»é™¤ç¡¬ç¼–ç æ–¹å‰‚
        function analyzeSyndromeLocally(diseaseName, symptoms) {
            // ğŸš¨ ç§»é™¤ç¡¬ç¼–ç æ–¹å‰‚ï¼Œæ”¹ä¸ºåŠ¨æ€åˆ†æ
            console.log(`ğŸ“‹ åŠ¨æ€è¯å‹åˆ†æ: ${diseaseName}, ç—‡çŠ¶: ${symptoms}`);
            
            const syndromeDatabase = {
                'å¤±çœ ': {
                    'å¿ƒç«æ—ºç››è¯': {
                        keywords: ['å¿ƒçƒ¦', 'å¤šæ¢¦', 'å£å¹²', 'èˆŒçº¢', 'è‹”é»„', 'å¤±çœ ', 'éš¾ä»¥å…¥ç¡'],
                        description: 'å¿ƒç«äº¢ç››ï¼Œæ‰°ä¹±ç¥æ˜',
                        treatment: 'æ¸…å¿ƒç«ï¼Œå®‰ç¥å¿—',
                        weight: 0.8
                    },
                    'å¿ƒè„¾ä¸¤è™šè¯': {
                        keywords: ['å¥å¿˜', 'å¿ƒæ‚¸', 'é¢è‰²èé»„', 'èˆŒæ·¡', 'è„‰å¼±', 'å¤±çœ ', 'ç–²ä¹', 'é£Ÿæ¬²ä¸æŒ¯'],
                        description: 'å¿ƒè„¾æ°”è¡€ä¸è¶³ï¼Œç¥å¤±æ‰€å…»',
                        treatment: 'è¡¥ç›Šå¿ƒè„¾ï¼Œå…»è¡€å®‰ç¥',
                        weight: 0.7
                    },
                    'è‚éƒåŒ–ç«è¯': {
                        keywords: ['æ˜“æ€’', 'èƒ¸èƒèƒ€æ»¡', 'å£è‹¦', 'è„‰å¼¦', 'å¤±çœ ', 'çƒ¦èº', 'å¤´ç—›'],
                        description: 'è‚éƒåŒ–ç«ï¼Œä¸Šæ‰°ç¥æ˜',
                        treatment: 'ç–è‚è§£éƒï¼Œæ¸…çƒ­å®‰ç¥',
                        weight: 0.8
                    },
                    'é˜´è™šç«æ—ºè¯': {
                        keywords: ['å¤±çœ ', 'æ—©é†’', 'äº”å¿ƒçƒ¦çƒ­', 'ç›—æ±—', 'å£å¹²', 'èˆŒçº¢å°‘è‹”'],
                        description: 'è‚¾é˜´ä¸è¶³ï¼Œè™šç«ä¸Šç‚',
                        treatment: 'æ»‹é˜´é™ç«ï¼Œå…»å¿ƒå®‰ç¥',
                        weight: 0.7
                    }
                },
                'èƒƒç—›': {
                    'è„¾èƒƒè™šå¯’è¯': {
                        keywords: ['å–œæ¸©å–œæŒ‰', 'é¢è‰²èç™½', 'èˆŒæ·¡è‹”ç™½', 'è„‰ç»†å¼±', 'èƒƒç—›', 'èƒƒèƒ€'],
                        description: 'è„¾èƒƒé˜³æ°”ä¸è¶³ï¼Œå¤±äºæ¸©ç…¦',
                        treatment: 'æ¸©ä¸­æ•£å¯’ï¼Œè¡¥æ°”å¥è„¾',
                        weight: 0.8
                    },
                    'è‚æ°”çŠ¯èƒƒè¯': {
                        keywords: ['èƒ€ç—›æ‹’æŒ‰', 'å—³æ°”', 'æƒ…å¿—ä¸é‚', 'è„‰å¼¦', 'èƒƒç—›', 'åé…¸'],
                        description: 'è‚æ°”éƒç»“ï¼Œæ¨ªé€†çŠ¯èƒƒ',
                        treatment: 'ç–è‚ç†æ°”ï¼Œå’Œèƒƒæ­¢ç—›',
                        weight: 0.7
                    }
                },
                // é€šç”¨ç—‡çŠ¶åŒ¹é…ï¼ˆé™ä½é˜ˆå€¼ï¼‰
                'é€šç”¨': {
                    'æ°”è¡€ä¸è¶³è¯': {
                        keywords: ['ç–²ä¹', 'ä¹åŠ›', 'é¢è‰²èé»„', 'å¤´æ™•', 'å¿ƒæ‚¸'],
                        description: 'æ°”è¡€äºè™šï¼Œè„è…‘å¤±å…»',
                        treatment: 'ç›Šæ°”å…»è¡€',
                        weight: 0.4
                    },
                    'ç—°æ¹¿å†…é˜»è¯': {
                        keywords: ['èƒ¸é—·', 'æ¶å¿ƒ', 'é£Ÿæ¬²ä¸æŒ¯', 'èˆŒè‹”åšè…»', 'å¤´é‡'],
                        description: 'ç—°æ¹¿å†…ç”Ÿï¼Œé˜»æ»æ°”æœº',
                        treatment: 'åŒ–ç—°é™¤æ¹¿ï¼Œç†æ°”å’Œä¸­',
                        weight: 0.4
                    }
                }
            };

            const diseaseSymptoms = syndromeDatabase[diseaseName] || {};
            const matchedSyndromes = [];

            // æ£€æŸ¥ç–¾ç—…ç‰¹å®šè¯å‹
            Object.keys(diseaseSymptoms).forEach(syndromeName => {
                const syndrome = diseaseSymptoms[syndromeName];
                const matchCount = syndrome.keywords.filter(keyword => 
                    symptoms.some(symptom => symptom.includes(keyword) || keyword.includes(symptom))
                ).length;
                
                const baseMatchRate = matchCount / syndrome.keywords.length;
                const weightedMatchRate = baseMatchRate * (syndrome.weight || 0.5);
                
                // é™ä½åŒ¹é…é˜ˆå€¼åˆ°15%ï¼Œè®©æ›´å¤šè¯å‹èƒ½è¢«è¯†åˆ«
                if (weightedMatchRate > 0.15) {
                    // ğŸš¨ ç§»é™¤ç¡¬ç¼–ç æ–¹å‰‚å­—æ®µ
                    const { formula, ...syndromeWithoutFormula } = syndrome;
                    matchedSyndromes.push({
                        name: syndromeName,
                        matchRate: weightedMatchRate,
                        confidence: Math.min(weightedMatchRate * 1.5, 1.0),
                        ...syndromeWithoutFormula,
                        // ğŸ”„ ä»ç”¨æˆ·è¯Šç–—æ€è·¯ä¸­æå–å®é™…æ–¹å‰‚
                        recommendedFormula: extractFormulaFromThinking(syndromeName)
                    });
                }
            });
            
            // æ£€æŸ¥é€šç”¨è¯å‹ï¼ˆå½“ç–¾ç—…ç‰¹å®šè¯å‹åŒ¹é…åº¦ä½æ—¶ï¼‰
            if (matchedSyndromes.length === 0 && syndromeDatabase['é€šç”¨']) {
                Object.keys(syndromeDatabase['é€šç”¨']).forEach(syndromeName => {
                    const syndrome = syndromeDatabase['é€šç”¨'][syndromeName];
                    const matchCount = syndrome.keywords.filter(keyword => 
                        symptoms.some(symptom => symptom.includes(keyword) || keyword.includes(symptom))
                    ).length;
                    
                    const matchRate = matchCount / syndrome.keywords.length;
                    
                    if (matchRate > 0.2) { // é€šç”¨è¯å‹é˜ˆå€¼ç¨é«˜
                        // ğŸš¨ ç§»é™¤ç¡¬ç¼–ç æ–¹å‰‚å­—æ®µ
                        const { formula, ...syndromeWithoutFormula } = syndrome;
                        matchedSyndromes.push({
                            name: syndromeName,
                            matchRate: matchRate,
                            confidence: matchRate * 0.8, // é€šç”¨è¯å‹ç½®ä¿¡åº¦ç¨ä½
                            isGeneric: true,
                            ...syndromeWithoutFormula,
                            // ğŸ”„ ä»ç”¨æˆ·è¯Šç–—æ€è·¯ä¸­æå–å®é™…æ–¹å‰‚
                            recommendedFormula: extractFormulaFromThinking(syndromeName)
                        });
                    }
                });
            }

            // æŒ‰åŒ¹é…åº¦æ’åº
            matchedSyndromes.sort((a, b) => b.matchRate - a.matchRate);

            return {
                matchedSyndromes,
                recommendation: matchedSyndromes.length > 0 ? matchedSyndromes[0] : null
            };
        }

        // ğŸ”„ ä»ç”¨æˆ·è¯Šç–—æ€è·¯ä¸­æå–æ–¹å‰‚çš„è¾…åŠ©å‡½æ•°
        function extractFormulaFromThinking(syndromeName) {
            const thinkingProcess = document.getElementById('doctorThought')?.value || '';
            
            if (!thinkingProcess) {
                return 'è¯·åœ¨è¯Šç–—æ€è·¯ä¸­æ˜ç¡®æ–¹å‰‚é€‰æ‹©';
            }
            
            // ç®€å•çš„æ–¹å‰‚æå–æ¨¡å¼
            const formulaPatterns = [
                /æ–¹[è¯å‰‚]?[:ï¼š]\s*([^ã€‚,ï¼Œ\n]+)/g,
                /é€‰[ç”¨è¯æ–¹]?[:ï¼š]\s*([^ã€‚,ï¼Œ\n]+)/g,
                /æ²»ç–—?[:ï¼š]\s*([^ã€‚,ï¼Œ\n]*[æ±¤æ•£ä¸¸æ–¹][^ã€‚,ï¼Œ\n]*)/g,
                /([^ã€‚,ï¼Œ\s]*[æ±¤æ•£ä¸¸æ–¹][^ã€‚,ï¼Œ\s]*)/g
            ];
            
            const extractedFormulas = [];
            for (const pattern of formulaPatterns) {
                const matches = thinkingProcess.matchAll(pattern);
                for (const match of matches) {
                    if (match[1] && match[1].trim()) {
                        extractedFormulas.push(match[1].trim());
                    }
                }
            }
            
            if (extractedFormulas.length > 0) {
                return extractedFormulas[0]; // è¿”å›ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–¹å‰‚
            }
            
            return `éœ€è¦æ ¹æ®${syndromeName}é€‰æ‹©ç›¸åº”æ–¹å‰‚`;
        }

        // æ˜¾ç¤ºè¯å‹åˆ†æç»“æœ
        function showSyndromeAnalysisResult(analysis) {
            clearResults();
            
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = '<div class="result-title">ğŸ¯ è¯å‹æ™ºèƒ½è¯†åˆ«ç»“æœ</div>';
            
            if (analysis.recommendation) {
                html += `
                    <div class="auto-analysis-panel">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #d97706;">
                            ğŸ† æ¨èè¯å‹: ${analysis.recommendation.name} 
                            <span style="font-size: 12px; color: #6b7280;">(åŒ¹é…åº¦: ${Math.round(analysis.recommendation.matchRate * 100)}%)</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>ç—…æœº:</strong> ${analysis.recommendation.description}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>æ²»æ³•:</strong> ${analysis.recommendation.treatment}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>æ¨èæ–¹å‰‚:</strong> ${analysis.recommendation.formula}
                        </div>
                        <button class="add-pathway-btn" onclick="addSyndromeToTree('${analysis.recommendation.name}', '${analysis.recommendation.description}')">
                            â• æ·»åŠ è¯å‹åˆ°å†³ç­–æ ‘
                        </button>
                        <button class="add-pathway-btn" onclick="addTreatmentToTree('${analysis.recommendation.treatment}', '${analysis.recommendation.formula}')">
                            â• æ·»åŠ æ²»ç–—æ–¹æ¡ˆ
                        </button>
                    </div>
                `;
            }

            if (analysis.matchedSyndromes.length > 1) {
                html += '<div style="margin-top: 15px;"><strong>å…¶ä»–å¯èƒ½è¯å‹:</strong><br>';
                analysis.matchedSyndromes.slice(1, 3).forEach(syndrome => {
                    html += `
                        <div class="suggestion-item" onclick="addSyndromeToTree('${syndrome.name}', '${syndrome.description}')">
                            <div class="suggestion-content">${syndrome.name}</div>
                            <div class="suggestion-desc">åŒ¹é…åº¦: ${Math.round(syndrome.matchRate * 100)}% - ${syndrome.description}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (analysis.matchedSyndromes.length === 0) {
                // æä¾›æ›´å¤šå¸®åŠ©ä¿¡æ¯
                // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
                html += `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; color: #92400e;">
                        <div style="font-weight: 600; margin-bottom: 8px;">âš ï¸ è¯å‹è¯†åˆ«å»ºè®®</div>
                        <div style="font-size: 12px; margin-bottom: 8px;">
                            å½“å‰${diseaseName}çš„ç—‡çŠ¶ä¿¡æ¯ä¸è¶³ï¼Œå»ºè®®è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š
                        </div>
                        <div style="font-size: 11px; line-height: 1.4;">
                            â€¢ è¯¦ç»†æè¿°ç—‡çŠ¶ç‰¹ç‚¹ï¼ˆå¦‚ç—›ç—›æ€§è´¨ã€å‘ä½œæ—¶é—´ï¼‰<br>
                            â€¢ æ·»åŠ ä¼´éšç—‡çŠ¶ï¼ˆå¦‚ç¡çœ ã€é¥®é£Ÿã€å¤§å°ä¾¿ï¼‰<br>
                            â€¢ æä¾›èˆŒè±¡è„‰è±¡ä¿¡æ¯<br>
                            â€¢ è®°å½•æƒ…å¿—å› ç´ å’Œèµ·ç—…åŸå› 
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="showSymptomGuidance('${diseaseName}')" style="
                                background: #f59e0b; color: white; border: none; border-radius: 6px; 
                                padding: 6px 12px; font-size: 11px; cursor: pointer;
                            ">
                                ğŸ“ è·å–ç—‡çŠ¶æŒ‡å¯¼
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const resultElement = document.createElement('div');
            resultElement.className = 'result-panel';
            resultElement.innerHTML = html;
            
            resultsDiv.appendChild(resultElement);
        }

        // æ·»åŠ è¯å‹åˆ°å†³ç­–æ ‘
        function addSyndromeToTree(syndromeName, description) {
            if (!selectedNode) {
                // è‡ªåŠ¨é€‰æ‹©æœ€åä¸€ä¸ªconditionèŠ‚ç‚¹æˆ–åˆ›å»ºæ–°ä½ç½®
                const conditionNodes = nodes.filter(n => n.type === 'condition');
                if (conditionNodes.length > 0) {
                    selectedNode = conditionNodes[conditionNodes.length - 1];
                } else {
                    showResult('æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ·»åŠ ä½ç½®', 'info');
                    return;
                }
            }

            const newNode = {
                id: `syndrome_${nodeCounter++}`,
                type: 'diagnosis',
                name: syndromeName,
                description: description,
                x: selectedNode.x + 250,
                y: selectedNode.y
            };
            
            nodes.push(newNode);
            renderNode(newNode);
            
            connections.push({
                from: selectedNode.id,
                to: newNode.id
            });
            
            drawConnections();
            showResult('æˆåŠŸ', `âœ… å·²æ·»åŠ è¯å‹"${syndromeName}"åˆ°å†³ç­–æ ‘`, 'success');
        }

        // æ·»åŠ æ²»ç–—æ–¹æ¡ˆåˆ°å†³ç­–æ ‘
        function addTreatmentToTree(treatmentMethod, formulaName) {
            const diagnosisNodes = nodes.filter(n => n.type === 'diagnosis');
            if (diagnosisNodes.length === 0) {
                showResult('æç¤º', 'è¯·å…ˆæ·»åŠ è¯Šæ–­èŠ‚ç‚¹', 'info');
                return;
            }

            const lastDiagnosisNode = diagnosisNodes[diagnosisNodes.length - 1];
            
            // æ·»åŠ æ²»ç–—èŠ‚ç‚¹
            const treatmentNode = {
                id: `treatment_${nodeCounter++}`,
                type: 'treatment',
                name: 'æ²»ç–—æ–¹æ¡ˆ',
                description: treatmentMethod,
                x: lastDiagnosisNode.x + 250,
                y: lastDiagnosisNode.y
            };
            
            nodes.push(treatmentNode);
            renderNode(treatmentNode);
            
            connections.push({
                from: lastDiagnosisNode.id,
                to: treatmentNode.id
            });

            // æ·»åŠ æ–¹å‰‚èŠ‚ç‚¹
            const formulaNode = {
                id: `formula_${nodeCounter++}`,
                type: 'formula',
                name: formulaName,
                description: 'æ¨èæ–¹å‰‚',
                x: treatmentNode.x + 250,
                y: treatmentNode.y
            };
            
            nodes.push(formulaNode);
            renderNode(formulaNode);
            
            connections.push({
                from: treatmentNode.id,
                to: formulaNode.id
            });
            
            drawConnections();
            showResult('æˆåŠŸ', `âœ… å·²æ·»åŠ æ²»ç–—æ–¹æ¡ˆå’Œæ–¹å‰‚åˆ°å†³ç­–æ ‘`, 'success');
        }

        // ç”ŸæˆåŸºç¡€è¯Šç–—è·¯å¾„ï¼ˆæ— ç—‡çŠ¶æ—¶ï¼‰
        function generateBasicPathway(diseaseName) {
            const basicSteps = [
                {
                    type: 'inquiry',
                    title: 'é—®è¯Šé‡‡é›†',
                    content: `è¯¦ç»†äº†è§£${diseaseName}ç›¸å…³ç—‡çŠ¶`,
                    action: 'collect_symptoms'
                },
                {
                    type: 'examination',
                    title: 'ä½“æ ¼æ£€æŸ¥',
                    content: 'æœ›é—»é—®åˆ‡å››è¯Šåˆå‚',
                    action: 'physical_exam'
                },
                {
                    type: 'analysis',
                    title: 'è¾¨è¯åˆ†æ',
                    content: `æ ¹æ®ç—‡çŠ¶ç‰¹ç‚¹è¿›è¡Œ${diseaseName}çš„è¯å‹åˆ¤æ–­`,
                    action: 'syndrome_analysis'
                },
                {
                    type: 'treatment',
                    title: 'æ²»ç–—æ–¹æ¡ˆ',
                    content: 'åˆ¶å®šé’ˆå¯¹æ€§çš„ä¸­åŒ»æ²»ç–—æ–¹æ¡ˆ',
                    action: 'treatment_plan'
                }
            ];
            
            return {
                pathway: basicSteps,
                message: `ä¸º${diseaseName}ç”Ÿæˆçš„åŸºç¡€è¯Šç–—è·¯å¾„`
            };
        }
        
        // ç”Ÿæˆé€šç”¨è¯Šç–—è·¯å¾„ï¼ˆæœ‰ç—‡çŠ¶ä½†æ— æ˜ç¡®è¯å‹ï¼‰
        function generateGenericPathway(diseaseName, symptoms) {
            const genericSteps = [
                {
                    type: 'analysis',
                    title: 'ç—‡çŠ¶åˆ†æ',
                    content: `å½“å‰ç—‡çŠ¶: ${symptoms.join('ã€')}ï¼Œéœ€è¿›ä¸€æ­¥åˆ†æè¾¨è¯`,
                    action: 'symptom_analysis'
                },
                {
                    type: 'differential',
                    title: 'é‰´åˆ«è¯Šæ–­',
                    content: `æ’é™¤${diseaseName}çš„å…¶ä»–å¯èƒ½è¯å‹`,
                    action: 'differential_diagnosis'
                },
                {
                    type: 'supplementary',
                    title: 'è¡¥å……æ£€æŸ¥',
                    content: 'å®Œå–„å››è¯Šä¿¡æ¯ï¼Œæ˜ç¡®è¯å‹',
                    action: 'supplementary_exam'
                },
                {
                    type: 'treatment',
                    title: 'åˆ†å‹æ²»ç–—',
                    content: 'æ ¹æ®æœ€ç»ˆè¯å‹é€‰æ‹©åˆé€‚æ²»æ³•',
                    action: 'targeted_treatment'
                }
            ];
            
            return {
                pathway: genericSteps,
                syndrome: null,
                message: `åŸºäºç°æœ‰ç—‡çŠ¶ç”Ÿæˆçš„${diseaseName}é€šç”¨è¯Šç–—è·¯å¾„`
            };
        }
        
        // å¢å¼ºçš„æ™ºèƒ½è¯Šç–—è·¯å¾„ç”Ÿæˆ
        async function generateAutoPathway() {
            console.log('æ™ºèƒ½è¯Šç–—è·¯å¾„è¢«è°ƒç”¨');
            
            // ç›´æ¥ä½¿ç”¨getCurrentDiseaseName()ï¼Œä¸å£°æ˜å±€éƒ¨å˜é‡
            if (!getCurrentDiseaseName()) {
                alert('è¯·å…ˆè¾“å…¥ç–¾ç—…åç§°');
                return;
            }
            
            showLoading('æ­£åœ¨ç”Ÿæˆæ™ºèƒ½è¯Šç–—è·¯å¾„...');

            try {
                // æ”¶é›†ç—‡çŠ¶ï¼ˆä»èŠ‚ç‚¹å’Œç—‡çŠ¶ç¾¤ï¼‰
                const symptomNodes = nodes.filter(node => node.type === 'symptom');
                const allSymptoms = symptomNodes.map(n => n.name);
                
                // åŸºäºç°æœ‰ç—‡çŠ¶ç”Ÿæˆå®Œæ•´è·¯å¾„
                const pathwayData = generatePathwayFromSymptoms(diseaseName, allSymptoms || []);
                
                hideLoading();
                showPathwayGenerationResult(pathwayData);
                
            } catch (error) {
                console.error('è·¯å¾„ç”Ÿæˆå¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¢å¼ºçš„è¯Šç–—è·¯å¾„ç”Ÿæˆ
        function generatePathwayFromSymptoms(diseaseName, symptoms) {
            // å…ˆè¿›è¡Œè¯å‹åˆ†æ
            const syndromeAnalysis = analyzeSyndromeLocally(diseaseName, symptoms);
            const recommendedSyndrome = syndromeAnalysis.recommendation;
            
            // é™ä½é˜ˆå€¼ï¼Œå³ä½¿æ²¡æœ‰æ˜ç¡®è¯å‹ä¹Ÿç”ŸæˆåŸºç¡€è·¯å¾„
            if (!recommendedSyndrome && symptoms.length === 0) {
                // å®Œå…¨æ²¡æœ‰ç—‡çŠ¶æ—¶çš„é»˜è®¤è·¯å¾„
                return generateBasicPathway(diseaseName);
            }
            
            if (!recommendedSyndrome && symptoms.length > 0) {
                // æœ‰ç—‡çŠ¶ä½†æ²¡æœ‰åŒ¹é…è¯å‹æ—¶çš„é€šç”¨è·¯å¾„
                return generateGenericPathway(diseaseName, symptoms);
            }

            // ç”Ÿæˆå®Œæ•´è·¯å¾„æ­¥éª¤
            const pathway = [
                {
                    type: 'analysis',
                    title: 'ç—‡çŠ¶åˆ†æ',
                    content: `å½“å‰ç—‡çŠ¶: ${symptoms.join('ã€')}`,
                    action: 'review_symptoms'
                },
                {
                    type: 'syndrome',
                    title: 'è¯å‹è¯Šæ–­',
                    content: `${recommendedSyndrome.name} (åŒ¹é…åº¦: ${Math.round(recommendedSyndrome.matchRate * 100)}%)`,
                    description: recommendedSyndrome.description,
                    action: 'add_syndrome'
                },
                {
                    type: 'treatment',
                    title: 'æ²»ç–—åŸåˆ™',
                    content: recommendedSyndrome.treatment,
                    action: 'add_treatment'
                },
                {
                    type: 'formula',
                    title: 'æ–¹è¯é€‰æ‹©',
                    content: recommendedSyndrome.formula,
                    action: 'add_formula'
                }
            ];

            return {
                pathway: pathway,
                syndrome: recommendedSyndrome,
                message: 'åŸºäºç°æœ‰ç—‡çŠ¶ç”Ÿæˆçš„æ™ºèƒ½è¯Šç–—è·¯å¾„'
            };
        }

        // æ˜¾ç¤ºè·¯å¾„ç”Ÿæˆç»“æœ
        function showPathwayGenerationResult(pathwayData) {
            clearResults();
            
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = '<div class="result-title">ğŸ¤– æ™ºèƒ½è¯Šç–—è·¯å¾„</div>';
            
            if (pathwayData.pathway.length > 0) {
                html += `<div style="margin-bottom: 15px; color: #059669; font-size: 12px;">${pathwayData.message}</div>`;
                
                pathwayData.pathway.forEach((step, index) => {
                    html += `
                        <div class="pathway-step">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 5px;">
                                ${index + 1}. ${step.title}
                            </div>
                            <div style="font-size: 13px; margin-bottom: 8px;">${step.content}</div>
                            ${step.description ? `<div style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">${step.description}</div>` : ''}
                            <button class="add-pathway-btn" onclick="executePathwayStep('${step.action}', '${step.title}', '${step.content.replace(/'/g, "\\'")}')">
                                â• æ·»åŠ åˆ°å†³ç­–æ ‘
                            </button>
                        </div>
                    `;
                });

                html += `
                    <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px;">
                        <button class="apply-formula-btn" onclick="applyFullPathway('${JSON.stringify(pathwayData).replace(/"/g, "&quot;")}')">
                            ğŸš€ åº”ç”¨å®Œæ•´è·¯å¾„
                        </button>
                    </div>
                `;
            } else {
                html += `<div style="color: #f59e0b;">${pathwayData.message}</div>`;
            }
            
            const resultElement = document.createElement('div');
            resultElement.className = 'result-panel';
            resultElement.innerHTML = html;
            
            resultsDiv.appendChild(resultElement);
        }

        // æ‰§è¡Œè·¯å¾„æ­¥éª¤
        function executePathwayStep(action, title, content) {
            const lastNode = nodes.length > 0 ? nodes[nodes.length - 1] : null;
            const baseX = lastNode ? lastNode.x + 250 : 50;
            const baseY = lastNode ? lastNode.y : 100;

            let nodeType, nodeName, nodeDescription;

            switch (action) {
                case 'add_syndrome':
                    nodeType = 'diagnosis';
                    nodeName = content.split(' (')[0]; // ç§»é™¤åŒ¹é…åº¦ä¿¡æ¯
                    nodeDescription = title;
                    break;
                case 'add_treatment':
                    nodeType = 'treatment';
                    nodeName = title;
                    nodeDescription = content;
                    break;
                case 'add_formula':
                    nodeType = 'formula';
                    nodeName = content;
                    nodeDescription = title;
                    break;
                default:
                    showResult('æç¤º', `å·²è®°å½•: ${title}`, 'info');
                    return;
            }

            const newNode = {
                id: `pathway_${nodeCounter++}`,
                type: nodeType,
                name: nodeName,
                description: nodeDescription,
                x: baseX,
                y: baseY + (Math.random() - 0.5) * 50
            };
            
            nodes.push(newNode);
            renderNode(newNode);
            
            if (lastNode) {
                connections.push({
                    from: lastNode.id,
                    to: newNode.id
                });
                drawConnections();
            }
            
            showResult('æˆåŠŸ', `âœ… å·²æ·»åŠ ${title}åˆ°å†³ç­–æ ‘`, 'success');
        }

        // åº”ç”¨å®Œæ•´è·¯å¾„
        function applyFullPathway(pathwayJsonStr) {
            try {
                const pathwayData = JSON.parse(pathwayJsonStr.replace(/&quot;/g, '"'));
                
                let previousNode = nodes.length > 0 ? nodes[nodes.length - 1] : null;
                let x = previousNode ? previousNode.x + 250 : 300;
                const baseY = previousNode ? previousNode.y : 100;
                
                pathwayData.pathway.forEach((step, index) => {
                    let nodeType, nodeName, nodeDescription;

                    switch (step.action) {
                        case 'add_syndrome':
                            nodeType = 'diagnosis';
                            nodeName = step.content.split(' (')[0];
                            nodeDescription = step.description || step.title;
                            break;
                        case 'add_treatment':
                            nodeType = 'treatment';
                            nodeName = step.title;
                            nodeDescription = step.content;
                            break;
                        case 'add_formula':
                            nodeType = 'formula';
                            nodeName = step.content;
                            nodeDescription = step.title;
                            break;
                        default:
                            return;
                    }

                    const newNode = {
                        id: `full_pathway_${nodeCounter++}`,
                        type: nodeType,
                        name: nodeName,
                        description: nodeDescription,
                        x: x,
                        y: baseY + (index * 20) - 40
                    };
                    
                    nodes.push(newNode);
                    renderNode(newNode);
                    
                    if (previousNode) {
                        connections.push({
                            from: previousNode.id,
                            to: newNode.id
                        });
                    }
                    
                    previousNode = newNode;
                    x += 250;
                });
                
                drawConnections();
                showResult('æˆåŠŸ', `âœ… å·²åº”ç”¨å®Œæ•´è¯Šç–—è·¯å¾„ï¼ŒåŒ…å«${pathwayData.pathway.filter(s => s.action !== 'review_symptoms').length}ä¸ªæ­¥éª¤`, 'success');
                
            } catch (error) {
                showResult('é”™è¯¯', 'è·¯å¾„æ•°æ®è§£æå¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºç—‡çŠ¶æŒ‡å¯¼
        function showSymptomGuidance(diseaseName) {
            const guidance = {
                'å¤±çœ ': [
                    'å…¥ç¡æƒ…å†µï¼šéš¾ä»¥å…¥ç¡ã€è¾—è½¬åä¾§ã€å…¥ç¡æ—¶é—´è¶…è¿‡30åˆ†é’Ÿ',
                    'ç¡çœ ç»´æŒï¼šæ—©é†’ã€å¤šæ¢¦ã€ç¡çœ æµ…ã€æ˜“æƒŠé†’',
                    'ä¼´éšç—‡çŠ¶ï¼šå¿ƒçƒ¦ã€å¤´æ™•ã€å¥å¿˜ã€ç–²ä¹ä¹åŠ›',
                    'æƒ…å¿—å› ç´ ï¼šç„¦è™‘ã€æŠ‘éƒã€å·¥ä½œå‹åŠ›ã€æƒ…ç»ªæ³¢åŠ¨',
                    'èˆŒè±¡è„‰è±¡ï¼šèˆŒè´¨ã€èˆŒè‹”ã€è„‰è±¡ï¼ˆæ•°ã€æœ‰åŠ›ã€æ»‘æ¶©ç­‰ï¼‰'
                ],
                'èƒƒç—›': [
                    'ç—›ç—›ç‰¹ç‚¹ï¼šèƒ€ç—›ã€åˆºç—›ã€éšç—›ã€ç»­ç—›ã€é˜µå‘æ€§ç—›ç—›',
                    'ç—›ç—›è¯±å› ï¼šé£Ÿåç—›ã€ç©ºè…¹ç—›ã€æƒ…ç»ªæ¿€åŠ¨ååŠ é‡',
                    'ä¼´éšç—‡çŠ¶ï¼šèƒƒèƒ€ã€åé…¸ã€å—³æ°”ã€æ¶å¿ƒå‘•å',
                    'é£®é£Ÿæƒ…å†µï¼šé£Ÿæ¬²ä¸æŒ¯ã€å–œæŒ‰å–œæ¸©ã€å–œå‡‰æ‹’æŒ‰',
                    'å¤§å°ä¾¿ï¼šå¤§ä¾¿æƒ…å†µã€å°ä¾¿é¢œè‰²åŠé‡'
                ]
            };
            
            const diseaseGuidance = guidance[diseaseName] || [
                'è¯¦ç»†æè¿°ä¸»è¦ç—‡çŠ¶çš„ç‰¹ç‚¹å’Œå‘ä½œè§„å¾‹',
                'è®°å½•ä¼´éšå‡ºç°çš„å…¶ä»–ä¸é€‚ç—‡çŠ¶',
                'æ³¨æ„è§‚å¯ŸèˆŒè±¡å’Œè„‰è±¡çš„å˜åŒ–',
                'è€ƒè™‘ç–¾ç—…çš„èµ·å› å’Œè¯±å‘å› ç´ '
            ];
            
            alert(`${diseaseName}ç—‡çŠ¶é‡‡é›†æŒ‡å¯¼ï¼š\n\n${diseaseGuidance.map((item, index) => `${index + 1}. ${item}`).join('\n\n')}\n\nè¯·æ ¹æ®ä»¥ä¸ŠæŒ‡å¯¼è¡¥å……ç—‡çŠ¶ä¿¡æ¯ï¼Œæé«˜è¯å‹è¯†åˆ«çš„å‡†ç¡®æ€§ã€‚`);
        }
        
        // URLå‚æ•°æ£€æŸ¥å‡½æ•°ï¼ˆåœ¨ä¸»åˆå§‹åŒ–ä¸­è°ƒç”¨ï¼‰
        function checkURLParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const presetSymptoms = urlParams.get('symptoms');
                const presetDisease = urlParams.get('disease');
                
                if (presetDisease) {
                    const diseaseInput = document.getElementById('diseaseName');
                    if (diseaseInput) {
                        diseaseInput.value = presetDisease;
                        console.log('è®¾ç½®é¢„è®¾ç–¾ç—…:', presetDisease);
                    }
                }
                
                if (presetSymptoms) {
                    console.log('å‘ç°é¢„è®¾ç—‡çŠ¶:', presetSymptoms);
                    // TODO: åç»­å¯ä»¥æ·»åŠ è‡ªåŠ¨ç”Ÿæˆç—‡çŠ¶ç¾¤åŠŸèƒ½
                }
            } catch (error) {
                console.error('URLå‚æ•°æ£€æŸ¥å‡ºé”™:', error);
            }
        }
        
        console.log('å†³ç­–æ ‘æ„å»ºå™¨åŠ è½½å®Œæˆ');
        
        // ç´§æ€¥ä¿®å¤ï¼šå¼ºåˆ¶é‡æ–°ç»‘å®šä¸»è¦æŒ‰é’®äº‹ä»¶
        setTimeout(function() {
            console.log('å¼ºåˆ¶é‡æ–°ç»‘å®šäº‹ä»¶...');
            const generateBtn = document.getElementById('generateBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const clearBtn = document.getElementById('clearBtn');
            const aiModeToggle = document.getElementById('aiModeToggle');
            
            if (generateBtn) {
                generateBtn.onclick = function() {
                    console.log('å¼ºåˆ¶ç»‘å®šçš„generateAITreeè¢«è°ƒç”¨');
                    generateAITree();
                };
                console.log('generateBtné‡æ–°ç»‘å®šæˆåŠŸ');
            }
            
            if (analyzeBtn) {
                analyzeBtn.onclick = function() {
                    console.log('å¼ºåˆ¶ç»‘å®šçš„analyzeCurrentTreeè¢«è°ƒç”¨');
                    analyzeCurrentTree();
                };
                console.log('analyzeBtné‡æ–°ç»‘å®šæˆåŠŸ');
            }
            
            if (clearBtn) {
                clearBtn.onclick = function() {
                    console.log('å¼ºåˆ¶ç»‘å®šçš„clearCanvasè¢«è°ƒç”¨');
                    clearCanvas();
                };
                console.log('clearBtné‡æ–°ç»‘å®šæˆåŠŸ');
            }
            
            // ğŸ”§ å¼ºåˆ¶ä¿®å¤AIæ¨¡å¼åˆ‡æ¢
            if (aiModeToggle) {
                console.log('ğŸ”§ å¼ºåˆ¶ç»‘å®šAIæ¨¡å¼åˆ‡æ¢...');
                console.log('  å½“å‰AIçŠ¶æ€:', aiStatus);
                
                aiModeToggle.onchange = function() {
                    console.log('ğŸ”„ AIæ¨¡å¼åˆ‡æ¢è§¦å‘!');
                    console.log('  - åˆ‡æ¢çŠ¶æ€:', this.checked);
                    console.log('  - AIå¯ç”¨æ€§:', aiStatus.ai_enabled);
                    
                    const useAI = this.checked && aiStatus.ai_enabled;
                    console.log('  - æœ€ç»ˆæ¨¡å¼:', useAI ? 'AIæ¨¡å¼' : 'æ¨¡æ¿æ¨¡å¼');
                    
                    // ç«‹å³æ›´æ–°UIæ˜¾ç¤º
                    const aiModeText = document.getElementById('aiModeText');
                    const generateBtnText = document.getElementById('generateBtnText');
                    const generateBtnIcon = document.getElementById('generateBtnIcon');
                    
                    if (useAI) {
                        aiModeText.textContent = 'AIæ™ºèƒ½æ¨¡å¼';
                        aiModeText.style.color = '#3b82f6';
                        if (generateBtnText) generateBtnText.textContent = 'AIæ™ºèƒ½ç”Ÿæˆ';
                        if (generateBtnIcon) generateBtnIcon.textContent = 'ğŸ¤–';
                    } else {
                        aiModeText.textContent = 'æ ‡å‡†æ¨¡æ¿æ¨¡å¼';
                        aiModeText.style.color = '#6b7280';
                        if (generateBtnText) generateBtnText.textContent = 'æ ‡å‡†æ¨¡æ¿ç”Ÿæˆ';
                        if (generateBtnIcon) generateBtnIcon.textContent = 'ğŸ“‹';
                    }
                    
                    console.log('âœ… UIæ›´æ–°å®Œæˆ');
                };
                
                // è§¦å‘åˆå§‹çŠ¶æ€è®¾ç½®
                const event = new Event('change');
                aiModeToggle.dispatchEvent(event);
                
                console.log('âœ… AIæ¨¡å¼åˆ‡æ¢å¼ºåˆ¶ç»‘å®šå®Œæˆ');
            
            // ğŸ”§ å¼ºåˆ¶ç»‘å®šå³é”®èœå•éšè—äº‹ä»¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
            console.log('ğŸ”§ å¼ºåˆ¶ç»‘å®šå³é”®èœå•éšè—äº‹ä»¶...');
            document.addEventListener('click', function(e) {
                console.log('ğŸ–±ï¸ Force-bound click detected, target:', e.target.tagName, e.target.className);
                
                const isContextMenuClick = e.target.closest('.context-menu');
                if (!isContextMenuClick) {
                    console.log('ğŸ—‘ï¸ Force hiding context menu');
                    const menu = document.getElementById('contextMenu');
                    if (menu) {
                        menu.remove();
                        console.log('âœ… Context menu removed by force binding');
                    }
                }
            }, true); // ä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿ä¼˜å…ˆæ‰§è¡Œ
            
            console.log('âœ… å³é”®èœå•éšè—äº‹ä»¶å¼ºåˆ¶ç»‘å®šå®Œæˆ');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°aiModeToggleå…ƒç´ ');
            }
        }, 1500);

        // ======================== å†å²å†³ç­–æ ‘ç®¡ç†åŠŸèƒ½ ========================

        async function viewHistoryTrees() {
            console.log('æŸ¥çœ‹å†å²å†³ç­–æ ‘');
            document.getElementById('historyModal').style.display = 'block';
            await loadHistoryList();
        }

        async function loadHistoryList() {
            const container = document.getElementById('historyListContainer');

            try {
                const doctorId = getCurrentDoctorId();
                console.log('ğŸ” æŸ¥è¯¢å†å²å†³ç­–æ ‘ - åŒ»ç”ŸID:', doctorId);
                console.log('ğŸ” å½“å‰ç”¨æˆ·ä¿¡æ¯:', currentUser);
                console.log('ğŸ” localStorage userData:', localStorage.getItem('userData'));

                const response = await fetch(`/api/get_doctor_patterns/${doctorId}`, {
                    headers: getAuthHeaders()
                });

                console.log('ğŸ” APIå“åº”çŠ¶æ€:', response.status, response.statusText);

                const data = await response.json();

                console.log('ğŸ” APIè¿”å›æ•°æ®:', data);
                console.log('ğŸ” data.success:', data.success);
                console.log('ğŸ” data.data:', data.data);
                if (data.data) {
                    console.log('ğŸ” data.data.patterns:', data.data.patterns);
                    console.log('ğŸ” patternsæ•°é‡:', data.data.patterns ? data.data.patterns.length : 'undefined');
                }

                if (data.success && data.data.patterns && data.data.patterns.length > 0) {
                    console.log('âœ… æ‰¾åˆ°å†³ç­–æ ‘ï¼Œå‡†å¤‡æ˜¾ç¤º:', data.data.patterns.length, 'æ¡');
                    displayHistoryList(data.data.patterns);
                } else {
                    console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å†³ç­–æ ‘æˆ–æ•°æ®æ ¼å¼é”™è¯¯');
                    console.log('âš ï¸ åˆ¤æ–­æ¡ä»¶: success=', data.success, ', hasPatterns=', !!(data.data && data.data.patterns), ', length=', data.data && data.data.patterns ? data.data.patterns.length : 0);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px;">ğŸ“‚</div>
                            <div style="margin-top: 10px;">æš‚æ— å†å²å†³ç­–æ ‘</div>
                            <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
                                ä¿å­˜æ‚¨çš„å†³ç­–æ ‘åï¼Œå°†åœ¨è¿™é‡Œæ˜¾ç¤º
                            </div>
                            <div style="font-size: 10px; color: #d1d5db; margin-top: 8px;">
                                è°ƒè¯•: åŒ»ç”ŸID=${doctorId}, APIæˆåŠŸ=${data.success}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <div style="font-size: 48px;">âš ï¸</div>
                        <div style="margin-top: 10px;">åŠ è½½å¤±è´¥ï¼š${error.message}</div>
                    </div>
                `;
            }
        }

        function displayHistoryList(patterns) {
            const container = document.getElementById('historyListContainer');
            let html = '';

            patterns.forEach(pattern => {
                const createdDate = new Date(pattern.created_at).toLocaleString('zh-CN');
                const nodeCount = pattern.tree_structure && pattern.tree_structure.nodes ?
                    pattern.tree_structure.nodes.length : 0;

                html += `
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f3f4f6'"
                         onmouseout="this.style.background='#f9fafb'"
                         onclick="loadHistoryTree('${pattern.pattern_id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 6px;">
                                    ${pattern.disease_name}
                                </div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                                    ${pattern.thinking_process.substring(0, 100)}${pattern.thinking_process.length > 100 ? '...' : ''}
                                </div>
                                <div style="font-size: 11px; color: #9ca3af;">
                                    åˆ›å»ºæ—¶é—´ï¼š${createdDate} | èŠ‚ç‚¹æ•°ï¼š${nodeCount}
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteHistoryTree('${pattern.pattern_id}')"
                                    style="background: #fee2e2; color: #dc2626; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function loadHistoryTree(patternId) {
            try {
                showLoading('æ­£åœ¨åŠ è½½å†³ç­–æ ‘...');

                const doctorId = getCurrentDoctorId();
                const response = await fetch(`/api/get_doctor_patterns/${doctorId}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    const pattern = data.data.patterns.find(p => p.pattern_id === patternId);

                    if (pattern) {
                        // æ¢å¤ç–¾ç—…åç§°
                        document.getElementById('diseaseName').value = pattern.disease_name;

                        // æ¢å¤è¯Šç–—æ€è·¯
                        document.getElementById('doctorThought').value = pattern.thinking_process;

                        // æ¢å¤å†³ç­–æ ‘èŠ‚ç‚¹
                        if (pattern.tree_structure && pattern.tree_structure.nodes) {
                            clearCanvas();
                            nodes = pattern.tree_structure.nodes;
                            connections = pattern.tree_structure.connections || [];

                            // é‡æ–°æ¸²æŸ“æ‰€æœ‰èŠ‚ç‚¹
                            nodes.forEach(node => renderNode(node));
                            drawConnections();
                            updateCanvas();
                        }

                        hideLoading();
                        closeHistoryModal();
                        showResult('æˆåŠŸ', `âœ… å·²åŠ è½½å†³ç­–æ ‘ï¼š${pattern.disease_name}`, 'success');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å†³ç­–æ ‘å¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `âŒ åŠ è½½å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        function deleteHistoryTree(patternId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå†³ç­–æ ‘å—ï¼Ÿ')) {
                return;
            }

            showResult('æç¤º', 'åˆ é™¤åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function getCurrentDoctorId() {
            console.log('ğŸ” getCurrentDoctorId è¢«è°ƒç”¨');
            console.log('ğŸ“Š å½“å‰çŠ¶æ€:', {
                hasCurrentUser: !!currentUser,
                currentUserData: currentUser,
                hasLocalStorage: !!localStorage.getItem('userData')
            });

            // ä¼˜å…ˆä½¿ç”¨currentUserï¼ˆæ›´å¯é ï¼‰
            if (currentUser && currentUser.user_id) {
                console.log('âœ… ä» currentUser è·å– user_id:', currentUser.user_id);
                return currentUser.user_id;
            }

            // å¤‡ç”¨æ–¹æ¡ˆ
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    console.log('ğŸ“¦ ä» localStorage è§£æåˆ°ç”¨æˆ·æ•°æ®:', user);
                    if (user.user_id) {
                        console.log('âœ… ä» localStorage è·å– user_id:', user.user_id);
                        return user.user_id;
                    }
                } catch (e) {
                    console.error('âŒ è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                }
            }

            // ğŸ”§ æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å›ºå®šçš„åŒ¿ååŒ»ç”ŸID
            // è¿™ä¸ªIDä¸åç«¯ _create_or_get_temp_doctor_identity è¿”å›çš„IDä¸€è‡´
            console.warn('âš ï¸ æ— æ³•è·å–ç”¨æˆ·IDï¼Œä½¿ç”¨åŒ¿ååŒ»ç”ŸID');
            return 'anonymous_doctor';
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            console.log('ğŸ”‘ getAuthHeadersè°ƒç”¨:', {
                hasToken: !!token,
                tokenPreview: token ? token.substring(0, 20) + '...' : 'null'
            });
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // åŠ è½½åŒ»ç”Ÿçš„å†å²å†³ç­–æ ‘åˆ—è¡¨
        async function loadDoctorHistoryTrees() {
            console.log('ğŸ“š loadDoctorHistoryTrees è¢«è°ƒç”¨');

            const doctorId = getCurrentDoctorId();
            console.log('ğŸ‘¨â€âš•ï¸ å½“å‰åŒ»ç”ŸID:', doctorId);
            console.log('ğŸ‘¤ currentUser:', currentUser);
            console.log('ğŸ” isAuthenticated:', isAuthenticated);

            if (!doctorId) {
                console.error('âŒ æ— æ³•è·å–åŒ»ç”ŸID');
                return;
            }

            const myTreesSection = document.getElementById('myTreesSection');
            const myTreesList = document.getElementById('myTreesList');

            console.log('ğŸ“‹ DOMå…ƒç´ æ£€æŸ¥:', {
                hasSection: !!myTreesSection,
                hasList: !!myTreesList
            });

            try {
                const headers = getAuthHeaders();
                console.log('ğŸ”‘ è¯·æ±‚å¤´:', headers);
                console.log('ğŸ“¡ å‘èµ·APIè¯·æ±‚:', `/api/get_doctor_patterns/${doctorId}`);

                const response = await fetch(`/api/get_doctor_patterns/${doctorId}`, {
                    headers: headers
                });

                console.log('ğŸ“¡ APIå“åº”:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                if (!response.ok) {
                    throw new Error(`åŠ è½½å†å²è®°å½•å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ğŸ“„ APIè¿”å›æ•°æ®:', data);
                console.log('ğŸ“Š å†³ç­–æ ‘æ•°é‡:', data.data?.patterns?.length || 0);

                if (data.success && data.data.patterns && data.data.patterns.length > 0) {
                    console.log('âœ… æ‰¾åˆ°å†³ç­–æ ‘,å¼€å§‹æ˜¾ç¤º:', data.data.patterns.length, 'ä¸ª');
                    displayMyTreesList(data.data.patterns);
                    myTreesSection.style.display = 'block';
                    console.log('âœ… å†å²å†³ç­–æ ‘æ˜¾ç¤ºå®Œæˆ');
                } else {
                    console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å†³ç­–æ ‘,æ˜¾ç¤ºç©ºçŠ¶æ€');
                    myTreesList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“‚</div>
                            <div style="font-size: 12px;">æš‚æ— ä¿å­˜çš„å†³ç­–æ ‘</div>
                            <div style="font-size: 11px; margin-top: 5px; color: #d1d5db;">åˆ›å»ºå¹¶ä¿å­˜åå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                        </div>
                    `;
                    myTreesSection.style.display = 'block';
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å†å²å†³ç­–æ ‘å¤±è´¥:', error);
                myTreesList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef4444;">
                        <div style="font-size: 32px; margin-bottom: 10px;">âš ï¸</div>
                        <div style="font-size: 12px;">åŠ è½½å¤±è´¥: ${error.message}</div>
                    </div>
                `;
                myTreesSection.style.display = 'block';
            }
        }

        // æ˜¾ç¤ºæˆ‘çš„å†³ç­–æ ‘åˆ—è¡¨
        function displayMyTreesList(patterns) {
            const myTreesList = document.getElementById('myTreesList');
            let html = '';

            patterns.forEach((pattern, index) => {
                const createdDate = new Date(pattern.created_at).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });

                const nodeCount = pattern.tree_structure && pattern.tree_structure.nodes ?
                    pattern.tree_structure.nodes.length : 0;

                html += `
                    <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid #e5e7eb;"
                         onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';"
                         onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb';"
                         onclick="loadTreeFromHistory('${pattern.pattern_id}')">
                        <div style="font-weight: 600; color: #1e40af; font-size: 13px; margin-bottom: 4px;">
                            ${pattern.disease_name}
                        </div>
                        <div style="font-size: 10px; color: #9ca3af; display: flex; justify-content: space-between; align-items: center;">
                            <span>${createdDate}</span>
                            <span style="background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 10px;">
                                ${nodeCount} èŠ‚ç‚¹
                            </span>
                        </div>
                    </div>
                `;
            });

            myTreesList.innerHTML = html;
        }

        // ä»å†å²è®°å½•åŠ è½½å†³ç­–æ ‘
        async function loadTreeFromHistory(patternId) {
            try {
                showLoading('æ­£åœ¨åŠ è½½å†³ç­–æ ‘...');

                const doctorId = getCurrentDoctorId();
                const response = await fetch(`/api/get_doctor_patterns/${doctorId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();

                if (data.success && data.data.patterns) {
                    const pattern = data.data.patterns.find(p => p.pattern_id === patternId);

                    if (pattern && pattern.tree_structure) {
                        // æ¸…ç©ºå½“å‰ç”»å¸ƒ
                        clearCanvas();

                        // è®¾ç½®ç–¾ç—…åç§°
                        document.getElementById('diseaseName').value = pattern.disease_name;

                        // è®¾ç½®è¯Šç–—æ€è·¯
                        if (pattern.thinking_process) {
                            document.getElementById('doctorThought').value = pattern.thinking_process;
                        }

                        // åŠ è½½èŠ‚ç‚¹å’Œè¿æ¥
                        if (pattern.tree_structure.nodes && pattern.tree_structure.nodes.length > 0) {
                            nodes = pattern.tree_structure.nodes;
                            connections = pattern.tree_structure.connections || [];

                            // æ¸²æŸ“æ‰€æœ‰èŠ‚ç‚¹
                            nodes.forEach(node => {
                                renderNode(node);
                            });

                            // ç»˜åˆ¶è¿æ¥çº¿
                            setTimeout(() => {
                                drawConnections();
                                updateCanvas();  // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ updateCanvasè°ƒç”¨ï¼Œç¡®ä¿å·¥å…·æ æ˜¾ç¤º
                                hideLoading();
                                showResult('æˆåŠŸ', `âœ… å·²åŠ è½½å†³ç­–æ ‘ï¼š${pattern.disease_name}`, 'success');
                            }, 100);
                        } else {
                            hideLoading();
                            showResult('æç¤º', 'è¯¥å†³ç­–æ ‘æ²¡æœ‰èŠ‚ç‚¹æ•°æ®', 'warning');
                        }
                    } else {
                        throw new Error('æœªæ‰¾åˆ°è¯¥å†³ç­–æ ‘æ•°æ®');
                    }
                } else {
                    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('åŠ è½½å†³ç­–æ ‘å¤±è´¥:', error);
                hideLoading();
                showResult('é”™è¯¯', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç»‘å®šå†å²è®°å½•æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const viewHistoryBtn = document.getElementById('viewHistoryBtn');
                if (viewHistoryBtn) {
                    viewHistoryBtn.addEventListener('click', viewHistoryTrees);
                    console.log('âœ… å†å²å†³ç­–æ ‘æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                }
            }, 500);
        });

        // ======================== å†³ç­–æ ‘ä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½ ========================

        let currentTimeRange = 'all';  // å½“å‰æ—¶é—´èŒƒå›´

        // æ‰“å¼€ä½¿ç”¨ç»Ÿè®¡å¼¹çª—
        async function openUsageStatsModal() {
            if (!isAuthenticated || !currentUser) {
                alert('âš ï¸ è¯·å…ˆç™»å½•');
                return;
            }

            document.getElementById('usageStatsModal').style.display = 'flex';
            await loadUsageStatistics();
        }

        // å…³é—­ä½¿ç”¨ç»Ÿè®¡å¼¹çª—
        function closeUsageStatsModal() {
            document.getElementById('usageStatsModal').style.display = 'none';
        }

        // æ—¶é—´èŒƒå›´ç­›é€‰
        function filterByTimeRange(range) {
            currentTimeRange = range;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.range === range) {
                    btn.classList.add('active');
                }
            });

            // é‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
            loadUsageStatistics();
        }

        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        function refreshUsageStats() {
            loadUsageStatistics();
        }

        // åŠ è½½ä½¿ç”¨ç»Ÿè®¡æ•°æ®
        async function loadUsageStatistics() {
            try {
                // ğŸ”§ ä½¿ç”¨getCurrentDoctorId()è·å–åŒ»ç”ŸIDï¼ˆä¼šè¿”å›anonymous_doctorä½œä¸ºå¤‡ç”¨ï¼‰
                const doctorId = getCurrentDoctorId();
                console.log('ğŸ” è·å–ä½¿ç”¨ç»Ÿè®¡ - åŒ»ç”ŸID:', doctorId);

                const response = await fetch(`/api/doctor-decision-tree/usage-stats/${doctorId}?time_range=${currentTimeRange}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
                }

                const result = await response.json();
                if (result.success) {
                    renderUsageStatistics(result.data);
                } else {
                    throw new Error(result.message || 'è·å–ç»Ÿè®¡å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ä½¿ç”¨ç»Ÿè®¡å¤±è´¥:', error);
                alert(`åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }

        // æ¸²æŸ“ä½¿ç”¨ç»Ÿè®¡æ•°æ®
        function renderUsageStatistics(data) {
            const { overall, patterns } = data;

            // 1. æ¸²æŸ“æ€»ä½“ç»Ÿè®¡
            const overallStatsHtml = `
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h4>ä¿å­˜æ•°é‡</h4>
                    <div class="stat-value">${overall.total_patterns || 0}</div>
                    <div class="stat-unit">ä¸ªå†³ç­–æ ‘</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    <h4>æ€»è°ƒç”¨æ•°</h4>
                    <div class="stat-value">${overall.total_calls || 0}</div>
                    <div class="stat-unit">æ¬¡</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    <h4>æˆåŠŸç‡</h4>
                    <div class="stat-value">${overall.success_calls && overall.total_calls ? Math.round((overall.success_calls / overall.total_calls) * 100) : 0}%</div>
                    <div class="stat-unit">ç”Ÿæˆå¤„æ–¹</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                    <h4>è¦†ç›–ç‡</h4>
                    <div class="stat-value">${overall.coverage_rate || 0}%</div>
                    <div class="stat-unit">é—®è¯Šè¦†ç›–</div>
                </div>
            `;
            document.getElementById('overallStats').innerHTML = overallStatsHtml;

            // 2. æ¸²æŸ“å†³ç­–æ ‘åˆ—è¡¨
            if (patterns && patterns.length > 0) {
                const patternsHtml = patterns.map(pattern => `
                    <div class="pattern-stat-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 5px 0; color: #1f2937; font-size: 16px;">
                                    ${pattern.disease_name || 'æœªå‘½å'}
                                </h4>
                                <div style="font-size: 12px; color: #6b7280;">
                                    åˆ›å»ºäº: ${formatDate(pattern.pattern_created_at)}
                                </div>
                            </div>
                            <button class="btn btn-sm" onclick="viewPatternDetail('${pattern.pattern_id}')"
                                    style="background: #3b82f6; color: white; font-size: 12px; padding: 6px 12px;">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #6b7280;">è°ƒç”¨æ¬¡æ•°</div>
                                <div style="font-size: 20px; font-weight: bold; color: #1f2937;">${pattern.call_count || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #6b7280;">æˆåŠŸæ¬¡æ•°</div>
                                <div style="font-size: 20px; font-weight: bold; color: #10b981;">${pattern.success_count || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #6b7280;">æˆåŠŸç‡</div>
                                <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${pattern.success_rate || 0}%</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #6b7280;">ä½¿ç”¨ç‡</div>
                                <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">${pattern.usage_rate || 0}%</div>
                            </div>
                        </div>

                        ${pattern.last_used_at ? `
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                                æœ€åä½¿ç”¨: ${formatDate(pattern.last_used_at)}
                            </div>
                        ` : ''}

                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: ${pattern.usage_rate || 0}%"></div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('patternStatsList').innerHTML = patternsHtml;
            } else {
                document.getElementById('patternStatsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“Š</div>
                        <div style="font-size: 16px;">æš‚æ— å†³ç­–æ ‘ä½¿ç”¨æ•°æ®</div>
                        <div style="font-size: 14px; margin-top: 8px;">åˆ›å»ºå¹¶ä¿å­˜å†³ç­–æ ‘åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºä½¿ç”¨ç»Ÿè®¡</div>
                    </div>
                `;
            }
        }

        // æŸ¥çœ‹å†³ç­–æ ‘è¯¦æƒ…
        async function viewPatternDetail(patternId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('æœªç™»å½•');
                }

                const response = await fetch(`/api/doctor-decision-tree/usage-detail/${patternId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('è·å–è¯¦æƒ…å¤±è´¥');
                }

                const result = await response.json();
                if (result.success) {
                    renderPatternDetail(result.data);
                    document.getElementById('usageDetailModal').style.display = 'flex';
                } else {
                    throw new Error(result.message || 'è·å–è¯¦æƒ…å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                alert(`åŠ è½½è¯¦æƒ…å¤±è´¥: ${error.message}`);
            }
        }

        // æ¸²æŸ“å†³ç­–æ ‘è¯¦æƒ…
        function renderPatternDetail(data) {
            const { pattern_info, usage_records, total_count } = data;

            document.getElementById('detailModalTitle').textContent = `${pattern_info.disease_name} - ä½¿ç”¨è¯¦æƒ…`;

            let html = `
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #1f2937;">åŸºæœ¬ä¿¡æ¯</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                        <div><span style="color: #6b7280;">ç–¾ç—…åç§°:</span> <strong>${pattern_info.disease_name}</strong></div>
                        <div><span style="color: #6b7280;">åˆ›å»ºæ—¶é—´:</span> ${formatDate(pattern_info.created_at)}</div>
                        <div><span style="color: #6b7280;">ä½¿ç”¨æ¬¡æ•°:</span> <strong>${total_count}</strong>æ¬¡</div>
                        <div><span style="color: #6b7280;">æœ€åä½¿ç”¨:</span> ${pattern_info.last_used_at ? formatDate(pattern_info.last_used_at) : 'æœªä½¿ç”¨'}</div>
                    </div>
                </div>

                <h3 style="margin: 0 0 15px 0; color: #1f2937;">æœ€è¿‘ä½¿ç”¨è®°å½•</h3>
            `;

            if (usage_records && usage_records.length > 0) {
                html += `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">æ—¶é—´</th>
                                    <th style="padding: 12px; text-align: left;">æ‚£è€…ID</th>
                                    <th style="padding: 12px; text-align: center;">åŒ¹é…åº¦</th>
                                    <th style="padding: 12px; text-align: center;">çŠ¶æ€</th>
                                    <th style="padding: 12px; text-align: center;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usage_records.map(record => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">${formatDate(record.consultation_date)}</td>
                                        <td style="padding: 12px;">${maskPatientId(record.patient_id)}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${record.pattern_match_score ? `<span style="color: #10b981; font-weight: bold;">${(record.pattern_match_score * 100).toFixed(0)}%</span>` : '-'}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${getStatusBadge(record.prescription_status || record.consultation_status)}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button class="btn btn-sm" onclick="viewConsultationDetail('${record.consultation_id}')"
                                                    style="background: #6b7280; color: white; font-size: 12px; padding: 4px 8px;">
                                                æŸ¥çœ‹
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += '<div style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— ä½¿ç”¨è®°å½•</div>';
            }

            document.getElementById('usageDetailContent').innerHTML = html;
        }

        // æŸ¥çœ‹é—®è¯Šè¯¦æƒ…
        async function viewConsultationDetail(consultationId) {
            try {
                console.log('ğŸ” åŒ»ç”ŸæŸ¥çœ‹é—®è¯Šè¯¦æƒ…:', consultationId);

                // æ˜¾ç¤ºåŠ è½½æç¤º
                showResult('åŠ è½½ä¸­', 'æ­£åœ¨è·å–é—®è¯Šè¯¦æƒ…...', 'info');

                // è°ƒç”¨APIè·å–é—®è¯Šè¯¦æƒ…(éœ€è¦æºå¸¦è®¤è¯token)
                const response = await fetch(`/api/consultation/${consultationId}/detail`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`è·å–è¯¦æƒ…å¤±è´¥: ${response.status}`);
                }

                const result = await response.json();
                console.log('ğŸ“„ è·å–åˆ°çš„é—®è¯Šè¯¦æƒ…:', result);

                if (!result.success) {
                    throw new Error(result.message || 'è·å–é—®è¯Šè¯¦æƒ…å¤±è´¥');
                }

                // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
                displayConsultationDetailModal(result.data);

            } catch (error) {
                console.error('âŒ è·å–é—®è¯Šè¯¦æƒ…å¤±è´¥:', error);
                showResult('é”™è¯¯', `è·å–é—®è¯Šè¯¦æƒ…å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ - ä¸é—®è¯Šé¡µé¢ç›¸åŒçš„æ ¼å¼åŒ–é€»è¾‘
        function formatMessage(content) {
            if (!content) return '';

            // å¢å¼ºçš„Markdownå¤„ç† - æ˜ç¡®çš„å±‚æ¬¡å’Œæ ·å¼
            return content
                // å¤„ç†ã€å¤„æ–¹ã€‘æ ‡ç­¾ - ç‰¹æ®Šé«˜äº®æ ·å¼
                .replace(/\*\*ã€å¤„æ–¹ã€‘\*\*/g, '<div style="background: linear-gradient(135deg, #2d5aa0, #4a7bc8); color: white; padding: 10px 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; font-size: 16px; text-align: center;">ğŸ“‹ ä¸­è¯å¤„æ–¹</div>')
                // å¤„ç†ã€ç”¨æ³•ã€‘ã€æ³¨æ„ã€‘ç­‰æ ‡ç­¾
                .replace(/\*\*ã€(ç”¨æ³•|æ³¨æ„|ç¦å¿Œ|åŠŸæ•ˆ)ã€‘\*\*/g, '<div style="background: #f3f4f6; color: #374151; padding: 8px 12px; border-radius: 6px; margin: 10px 0; font-weight: bold; border-left: 4px solid #6b7280;">$1</div>')
                // å¤„ç†å…¶ä»–ç²—ä½“æ ‡ç­¾ã€xxxã€‘
                .replace(/\*\*ã€(.*?)ã€‘\*\*/g, '<strong style="color: #2d5aa0; font-size: 15px; background: #e0f2fe; padding: 2px 6px; border-radius: 4px;">ã€$1ã€‘</strong>')
                // å¤„ç†å…¶ä»–ç²—ä½“æ–‡æœ¬
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937; font-weight: bold;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color: #6b7280;">$1</em>')
                // å¤„ç†#####æ ‡è®° - è½¬æ¢ä¸ºåˆ†å‰²çº¿
                .replace(/#{5,}/g, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb; background: linear-gradient(to right, #e5e7eb, transparent);">')
                // å¤„ç†###æ ‡è®° - è½¬æ¢ä¸ºæ˜æ˜¾çš„å°æ ‡é¢˜
                .replace(/###\s*(.*?)(?=\n|$)/g, '<h4 style="margin: 20px 0 12px 0; color: #2d5aa0; font-size: 17px; font-weight: bold; padding-left: 8px; border-left: 4px solid #2d5aa0; background: #f8fafc;">$1</h4>')
                // å¤„ç†##æ ‡è®° - è½¬æ¢ä¸ºæ›´å¤§çš„ä¸­æ ‡é¢˜
                .replace(/##\s*(.*?)(?=\n|$)/g, '<h3 style="margin: 25px 0 15px 0; color: #1f2937; font-size: 19px; font-weight: bold; padding: 8px 12px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 6px;">$1</h3>')
                // å¤„ç†#æ ‡è®° - è½¬æ¢ä¸ºå¤§æ ‡é¢˜
                .replace(/^#\s*(.*?)(?=\n|$)/gm, '<h2 style="margin: 30px 0 20px 0; color: #111827; font-size: 22px; font-weight: bold; text-align: center; padding: 12px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px;">$1</h2>')
                // å¤„ç†è¯æåˆ—è¡¨ - ç‰¹æ®Šæ ·å¼
                .replace(/([ä¸€-é¾Ÿ\u4e00-\u9fff]+)\s+(\d+)g/g, '<span style="display: inline-block; background: #ecfdf5; color: #065f46; padding: 2px 6px; margin: 1px 3px; border-radius: 4px; font-weight: 500; border: 1px solid #d1fae5;">$1 <strong>$2g</strong></span>')
                .replace(/\n\n/g, '<br><br>')  // æ®µè½é—´è·
                .replace(/\n/g, '<br>');       // æ™®é€šæ¢è¡Œ
        }

        // æ˜¾ç¤ºé—®è¯Šè¯¦æƒ…å¼¹çª—
        function displayConsultationDetailModal(consultation) {
            // è§£æå¯¹è¯è®°å½•
            let conversationHistory = [];
            if (consultation.conversation_log) {
                try {
                    const logData = JSON.parse(consultation.conversation_log);
                    if (logData.conversation_history && Array.isArray(logData.conversation_history)) {
                        conversationHistory = logData.conversation_history;
                    }
                } catch (e) {
                    console.error('è§£æå¯¹è¯è®°å½•å¤±è´¥:', e);
                }
            }

            // è·å–åŒ»ç”Ÿä¿¡æ¯
            const doctorId = consultation.selected_doctor_id || 'unknown';
            const doctorName = getDoctorDisplayName(doctorId);

            // æ ¼å¼åŒ–æ—¶é—´
            const createdTime = consultation.created_at ? new Date(consultation.created_at).toLocaleString('zh-CN') : '-';
            const updatedTime = consultation.updated_at ? new Date(consultation.updated_at).toLocaleString('zh-CN') : '-';

            // æ„å»ºå¯¹è¯å†å²HTML
            const conversationHTML = conversationHistory.length > 0 ?
                conversationHistory.map((conv, index) => `
                    <div class="conversation-turn" style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <div class="patient-message" style="margin-bottom: 10px;">
                            <strong style="color: #3b82f6;">æ‚£è€… (ç¬¬${index + 1}è½®):</strong>
                            <p style="margin: 5px 0; padding: 10px; background: white; border-radius: 4px;">${conv.patient_query || ''}</p>
                        </div>
                        <div class="doctor-message" style="margin-bottom: 10px;">
                            <strong style="color: #10b981;">${doctorName}:</strong>
                            <div style="margin: 5px 0; padding: 10px; background: white; border-radius: 4px; line-height: 1.6;">${formatMessage(conv.ai_response || '')}</div>
                        </div>
                        <div class="turn-timestamp" style="text-align: right; font-size: 12px; color: #6b7280;">
                            ${conv.timestamp ? new Date(conv.timestamp).toLocaleString('zh-CN') : ''}
                        </div>
                    </div>
                `).join('') :
                '<p style="text-align: center; color: #6b7280;">æš‚æ— å¯¹è¯è®°å½•</p>';

            // å¤„æ–¹ä¿¡æ¯
            const prescription = consultation.prescription;
            const prescriptionHTML = prescription ? `
                <div class="detail-section" style="margin-bottom: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #10b981;">ğŸŒ¿ å¤„æ–¹ä¿¡æ¯</h3>
                    <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                        <div style="margin-bottom: 5px;"><strong>è¯Šæ–­:</strong> ${prescription.diagnosis || 'æœªè®°å½•'}</div>
                        <div style="margin-bottom: 5px;"><strong>å¤„æ–¹å†…å®¹:</strong></div>
                        <div style="padding: 10px; background: #f9fafb; border-radius: 4px; white-space: pre-wrap;">${prescription.prescription_text || 'æœªè®°å½•'}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                        <div><strong>å¤„æ–¹çŠ¶æ€:</strong> ${getPrescriptionStatusText(prescription.status)}</div>
                        <div><strong>å®¡æ ¸çŠ¶æ€:</strong> ${getReviewStatusText(prescription.review_status)}</div>
                        <div><strong>æ”¯ä»˜çŠ¶æ€:</strong> ${getPaymentStatusText(prescription.payment_status)}</div>
                        <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${prescription.created_at ? new Date(prescription.created_at).toLocaleString('zh-CN') : '-'}</div>
                    </div>
                </div>
            ` : '<p style="color: #6b7280;">æœ¬æ¬¡é—®è¯Šæœªå¼€å…·å¤„æ–¹</p>';

            // å†³ç­–æ ‘ä¿¡æ¯
            const patternHTML = consultation.used_pattern ? `
                <div class="detail-section" style="margin-bottom: 20px; padding: 15px; background: #eff6ff; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #3b82f6;">ğŸŒ³ ä½¿ç”¨çš„å†³ç­–æ ‘</h3>
                    <div style="background: white; padding: 10px; border-radius: 4px;">
                        <div style="margin-bottom: 5px;"><strong>ç–¾ç—…åç§°:</strong> ${consultation.used_pattern.disease_name}</div>
                        <div style="margin-bottom: 5px;"><strong>åŒ¹é…åˆ†æ•°:</strong> ${consultation.pattern_match_score || '-'}</div>
                        ${consultation.used_pattern.thinking_process ? `
                            <div style="margin-top: 10px;">
                                <strong>è¯Šç–—æ€è·¯:</strong>
                                <div style="padding: 10px; background: #f9fafb; border-radius: 4px; margin-top: 5px; max-height: 100px; overflow-y: auto;">
                                    ${consultation.used_pattern.thinking_process}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : '';

            // åˆ›å»ºå¼¹çª—
            const modal = document.createElement('div');
            modal.id = 'consultationDetailModal';
            modal.style.cssText = 'display: flex; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 1000px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 90%;">
                    <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e5e7eb; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; color: #1f2937;">ğŸ“‹ é—®è¯Šè¯¦æƒ…</h2>
                            <button onclick="document.getElementById('consultationDetailModal').remove()"
                                    style="background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280; line-height: 1;">
                                &times;
                            </button>
                        </div>
                    </div>

                    <div style="padding: 20px;">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="detail-section" style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <h3 style="margin-top: 0; color: #374151;">ğŸ“Š åŸºæœ¬ä¿¡æ¯</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px;">
                                <div><strong>é—®è¯ŠID:</strong> ${consultation.uuid || '-'}</div>
                                <div><strong>æ‚£è€…ID:</strong> ${consultation.patient_id || '-'}</div>
                                <div><strong>åŒ»ç”Ÿ:</strong> ${doctorName}</div>
                                <div><strong>é—®è¯ŠçŠ¶æ€:</strong> ${getConsultationStatusText(consultation.status)}</div>
                                <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${createdTime}</div>
                                <div><strong>æ›´æ–°æ—¶é—´:</strong> ${updatedTime}</div>
                                <div><strong>å¯¹è¯è½®æ¬¡:</strong> ${conversationHistory.length}è½®</div>
                            </div>
                        </div>

                        <!-- å†³ç­–æ ‘ä¿¡æ¯ -->
                        ${patternHTML}

                        <!-- å¤„æ–¹ä¿¡æ¯ -->
                        ${prescriptionHTML}

                        <!-- å¯¹è¯å†å² -->
                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h3 style="color: #374151;">ğŸ’¬ å¯¹è¯è®°å½•</h3>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${conversationHTML}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–åŒ»ç”Ÿæ˜¾ç¤ºåç§°
        function getDoctorDisplayName(doctorId) {
            const doctorMap = {
                'zhang_zhongjing': 'å¼ ä»²æ™¯',
                'ye_tianshi': 'å¶å¤©å£«',
                'li_dongyuan': 'æä¸œå£',
                'zheng_qinan': 'éƒ‘é’¦å®‰',
                'liu_duzhou': 'åˆ˜æ¸¡èˆŸ'
            };
            return doctorMap[doctorId] || doctorId;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–é—®è¯ŠçŠ¶æ€æ–‡æœ¬
        function getConsultationStatusText(status) {
            const statusMap = {
                'active': '<span style="color: #3b82f6;">â³ è¿›è¡Œä¸­</span>',
                'completed': '<span style="color: #10b981;">âœ… å·²å®Œæˆ</span>',
                'cancelled': '<span style="color: #6b7280;">âŒ å·²å–æ¶ˆ</span>'
            };
            return statusMap[status] || status || '-';
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–å¤„æ–¹çŠ¶æ€æ–‡æœ¬
        function getPrescriptionStatusText(status) {
            const statusMap = {
                'draft': '<span style="color: #6b7280;">è‰ç¨¿</span>',
                'pending': '<span style="color: #f59e0b;">å¾…å®¡æ ¸</span>',
                'approved': '<span style="color: #10b981;">å·²é€šè¿‡</span>',
                'rejected': '<span style="color: #ef4444;">å·²æ‹’ç»</span>'
            };
            return statusMap[status] || status || '-';
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–å®¡æ ¸çŠ¶æ€æ–‡æœ¬
        function getReviewStatusText(status) {
            const statusMap = {
                'pending': '<span style="color: #f59e0b;">å¾…å®¡æ ¸</span>',
                'approved': '<span style="color: #10b981;">å·²æ‰¹å‡†</span>',
                'rejected': '<span style="color: #ef4444;">å·²æ‹’ç»</span>',
                'revision_required': '<span style="color: #f59e0b;">éœ€ä¿®æ”¹</span>'
            };
            return statusMap[status] || status || '-';
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ”¯ä»˜çŠ¶æ€æ–‡æœ¬
        function getPaymentStatusText(status) {
            const statusMap = {
                'unpaid': '<span style="color: #6b7280;">æœªæ”¯ä»˜</span>',
                'pending': '<span style="color: #f59e0b;">å¾…æ”¯ä»˜</span>',
                'paid': '<span style="color: #10b981;">å·²æ”¯ä»˜</span>',
                'refunded': '<span style="color: #6b7280;">å·²é€€æ¬¾</span>'
            };
            return statusMap[status] || status || '-';
        }

        // å…³é—­è¯¦æƒ…å¼¹çª—
        function closeUsageDetailModal() {
            document.getElementById('usageDetailModal').style.display = 'none';
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                if (hours === 0) {
                    const minutes = Math.floor(diff / (1000 * 60));
                    return minutes < 1 ? 'åˆšåˆš' : `${minutes}åˆ†é’Ÿå‰`;
                }
                return `${hours}å°æ—¶å‰`;
            } else if (days === 1) {
                return 'æ˜¨å¤©';
            } else if (days < 7) {
                return `${days}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè„±æ•æ‚£è€…ID
        function maskPatientId(patientId) {
            if (!patientId) return '-';
            if (patientId.length > 8) {
                return patientId.substring(0, 4) + '****' + patientId.substring(patientId.length - 4);
            }
            return patientId;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–çŠ¶æ€å¾½ç« 
        function getStatusBadge(status) {
            const statusMap = {
                'reviewed': '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">å·²å®¡æŸ¥</span>',
                'pending': '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">å¾…å¤„ç†</span>',
                'completed': '<span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">å·²å®Œæˆ</span>',
            };
            return statusMap[status] || '<span style="color: #6b7280;">-</span>';
        }

        // ç»‘å®šä½¿ç”¨ç»Ÿè®¡æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const viewUsageStatsBtn = document.getElementById('viewUsageStatsBtn');
                if (viewUsageStatsBtn) {
                    viewUsageStatsBtn.addEventListener('click', openUsageStatsModal);
                    console.log('âœ… ä½¿ç”¨ç»Ÿè®¡æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                }
            }, 500);
        });

</script>