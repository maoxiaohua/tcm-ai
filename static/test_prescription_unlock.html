<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤„æ–¹è§£é”æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .test-title {
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .test-result {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            min-height: 100px;
        }
        
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 0;
        }
        
        .button:hover {
            background: #2563eb;
        }
        
        .success { color: #059669; }
        .error { color: #dc2626; }
        .info { color: #0891b2; }
    </style>
</head>
<body>
    <h1>ğŸ“‹ å¤„æ–¹è§£é”åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <div class="test-title">ğŸ” 1. å¤„æ–¹ç®¡ç†å™¨çŠ¶æ€æ£€æŸ¥</div>
        <button class="button" onclick="checkManagerStatus()">æ£€æŸ¥ç®¡ç†å™¨çŠ¶æ€</button>
        <div id="managerStatus" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">ğŸ¥ 2. æµ‹è¯•å¤„æ–¹APIè°ƒç”¨</div>
        <input type="number" id="prescriptionId" placeholder="è¾“å…¥å¤„æ–¹ID" value="89">
        <button class="button" onclick="testPrescriptionAPI()">æµ‹è¯•APIè°ƒç”¨</button>
        <div id="apiResult" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">ğŸ’Š 3. æµ‹è¯•å¤„æ–¹å†…å®¹å¤„ç†</div>
        <button class="button" onclick="testPrescriptionProcessing()">æµ‹è¯•å¤„æ–¹å¤„ç†</button>
        <div id="processingResult" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">ğŸ”’ 4. æµ‹è¯•æ”¯ä»˜çŠ¶æ€æ£€æŸ¥</div>
        <button class="button" onclick="testPaymentStatus()">æµ‹è¯•æ”¯ä»˜çŠ¶æ€</button>
        <div id="paymentResult" class="test-result"></div>
    </div>
    
    <script src="/static/js/simple_prescription_manager.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let testPrescriptionManager = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ å¤„æ–¹è§£é”æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // åˆå§‹åŒ–å¤„æ–¹ç®¡ç†å™¨
            if (typeof SimplePrescriptionManager !== 'undefined') {
                testPrescriptionManager = new SimplePrescriptionManager();
                log('managerStatus', 'âœ… å¤„æ–¹ç®¡ç†å™¨å·²åˆå§‹åŒ–', 'success');
            } else {
                log('managerStatus', 'âŒ å¤„æ–¹ç®¡ç†å™¨æœªåŠ è½½', 'error');
            }
        });
        
        // å·¥å…·å‡½æ•°
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML += `<div class="${className}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        // æµ‹è¯•å‡½æ•°
        function checkManagerStatus() {
            clearLog('managerStatus');
            
            if (!testPrescriptionManager) {
                log('managerStatus', 'âŒ å¤„æ–¹ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            log('managerStatus', 'âœ… å¤„æ–¹ç®¡ç†å™¨çŠ¶æ€æ­£å¸¸', 'success');
            log('managerStatus', `ğŸ“Š æ”¯ä»˜çŠ¶æ€ç¼“å­˜: ${testPrescriptionManager.paymentStatus.size} æ¡è®°å½•`, 'info');
            log('managerStatus', `ğŸ“¦ åŸå§‹å†…å®¹ç¼“å­˜: ${testPrescriptionManager.originalContent.size} æ¡è®°å½•`, 'info');
        }
        
        async function testPrescriptionAPI() {
            clearLog('apiResult');
            
            const prescriptionId = document.getElementById('prescriptionId').value;
            if (!prescriptionId) {
                log('apiResult', 'âŒ è¯·è¾“å…¥å¤„æ–¹ID', 'error');
                return;
            }
            
            log('apiResult', `ğŸ”„ æ­£åœ¨è°ƒç”¨API: /api/prescription/${prescriptionId}`, 'info');
            
            try {
                const response = await fetch(`/api/prescription/${prescriptionId}`);
                const data = await response.json();
                
                if (data.success) {
                    log('apiResult', 'âœ… APIè°ƒç”¨æˆåŠŸ', 'success');
                    log('apiResult', `ğŸ“‹ å¤„æ–¹ID: ${data.prescription.id}`, 'info');
                    log('apiResult', `ğŸ’³ æ”¯ä»˜çŠ¶æ€: ${data.prescription.payment_status}`, 'info');
                    log('apiResult', `ğŸ”“ å¯è§çŠ¶æ€: ${data.prescription.is_visible_to_patient ? 'å·²è§£é”' : 'é”å®š'}`, data.prescription.is_visible_to_patient ? 'success' : 'error');
                    log('apiResult', `â° è§£é”æ—¶é—´: ${data.prescription.visibility_unlock_time || 'æœªè§£é”'}`, 'info');
                } else {
                    log('apiResult', 'âŒ APIè°ƒç”¨å¤±è´¥', 'error');
                    log('apiResult', `é”™è¯¯ä¿¡æ¯: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log('apiResult', 'âŒ APIè°ƒç”¨å¼‚å¸¸', 'error');
                log('apiResult', `å¼‚å¸¸ä¿¡æ¯: ${error.message}`, 'error');
            }
        }
        
        async function testPrescriptionProcessing() {
            clearLog('processingResult');
            
            if (!testPrescriptionManager) {
                log('processingResult', 'âŒ å¤„æ–¹ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // æ¨¡æ‹Ÿå¤„æ–¹å†…å®¹
            const testContent = `
ğŸ©º ä¸“ä¸šè¯Šæ–­åˆ†æ

è¾¨è¯åˆ†æï¼šæ ¹æ®æ‚£è€…ç›®å‰æä¾›çš„ç—‡çŠ¶ï¼šå£å¹²å¤šé¥®ã€å¤šå°¿ã€æ¶ˆç˜¦ã€æ˜“é¥¥å¤šé£Ÿï¼ŒèˆŒè‹”è–„ç™½æ·¡çº¢ï¼Œæ— å‘çƒ­ã€æ— æ±—ã€å¤§å°ä¾¿æ­£å¸¸ï¼Œç»“åˆã€Šä¼¤å¯’è®ºã€‹å…­ç»è¾¨è¯ç†è®ºåŠç°ä»£åŒ»å­¦"ç³–å°¿ç—…"è¯Šæ–­ï¼Œåˆæ­¥åˆ¤æ–­ä¸ºé˜³æ˜ç‡¥çƒ­å†…ç››ï¼Œæ°”é˜´ä¸¤è™šä¹‹è¯

ğŸ“‹ ä¸ªæ€§åŒ–å¤„æ–¹æ–¹æ¡ˆ
ååŒ»ä¸“æ–¹

æ–¹å‰‚ç»„æˆé¢„è§ˆ (å…±11å‘³è¯æ)
- ç”Ÿåœ°é»„ ***g
- çŸ¥æ¯ ***g
+ 9å‘³è¯æ è§£é”æŸ¥çœ‹

å®Œæ•´å¤„æ–¹åŒ…å«
âš–ï¸ ç²¾ç¡®å‰‚é‡é…æ¯”
ğŸ¯ ä¸ªäººä½“è´¨è°ƒæ•´
ğŸ“– è¯¦ç»†ç…æœæŒ‡å¯¼
âš ï¸ ç”¨è¯æ³¨æ„äº‹é¡¹

ğŸ”“ è§£é”å®Œæ•´å¤„æ–¹ Â¥88
ğŸ”’ å®‰å…¨æ”¯ä»˜
ğŸ’¯ ä¸“ä¸šä¿éšœ
ğŸ å«ä»£ç…æœåŠ¡
            `;
            
            log('processingResult', 'ğŸ”„ æ­£åœ¨å¤„ç†æµ‹è¯•å¤„æ–¹å†…å®¹...', 'info');
            
            try {
                const processedContent = await testPrescriptionManager.processContent(testContent);
                log('processingResult', 'âœ… å¤„æ–¹å†…å®¹å¤„ç†å®Œæˆ', 'success');
                log('processingResult', `ğŸ“„ å¤„ç†åHTMLé•¿åº¦: ${processedContent.length} å­—ç¬¦`, 'info');
                
                // åœ¨ç»“æœåŒºåŸŸæ˜¾ç¤ºå¤„ç†åçš„å†…å®¹
                document.getElementById('processingResult').innerHTML += 
                    `<div style="border-top: 1px solid #ddd; margin-top: 16px; padding-top: 16px;">
                        <strong>å¤„ç†ç»“æœé¢„è§ˆ:</strong><br>
                        ${processedContent}
                    </div>`;
                    
            } catch (error) {
                log('processingResult', 'âŒ å¤„æ–¹å†…å®¹å¤„ç†å¤±è´¥', 'error');
                log('processingResult', `é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
            }
        }
        
        async function testPaymentStatus() {
            clearLog('paymentResult');
            
            if (!testPrescriptionManager) {
                log('paymentResult', 'âŒ å¤„æ–¹ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // æµ‹è¯•ä¸åŒçš„å¤„æ–¹IDæ”¯ä»˜çŠ¶æ€
            const testIds = ['89', 'rx_test123', 'rx_nonexistent'];
            
            for (const testId of testIds) {
                log('paymentResult', `ğŸ”„ æ£€æŸ¥å¤„æ–¹ ${testId} çš„æ”¯ä»˜çŠ¶æ€...`, 'info');
                
                try {
                    const isPaid = await testPrescriptionManager.isPaid(testId);
                    log('paymentResult', `ğŸ“‹ å¤„æ–¹ ${testId}: ${isPaid ? 'âœ… å·²æ”¯ä»˜' : 'âŒ æœªæ”¯ä»˜'}`, isPaid ? 'success' : 'error');
                } catch (error) {
                    log('paymentResult', `âŒ æ£€æŸ¥å¤„æ–¹ ${testId} å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }
    </script>
</body>
</html>