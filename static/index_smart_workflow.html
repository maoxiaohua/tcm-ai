<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ±‡ä¸­åŒ» - AIæ™ºèƒ½é—®è¯Šå·¥ä½œæµ</title>
    
    <!-- Open Graph / å¾®ä¿¡åˆ†äº«ä¼˜åŒ– -->
    <meta property="og:title" content="ğŸ¥ AI ä¸­åŒ»æ™ºèƒ½é—®è¯ŠåŠ©æ‰‹ - ä¸“ä¸šç‰ˆ">
    <meta property="og:description" content="åŸºäºAIçš„ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿï¼Œæ”¯æŒç—‡çŠ¶é—®è¯Šã€è¯å€™åˆ†æã€æ–¹å‰‚æ¨èã€‚é›†æˆ5å¤§ä¸­åŒ»æµæ´¾ï¼Œæä¾›ä¸ªæ€§åŒ–ä¸­åŒ»æ²»ç–—å»ºè®®ã€‚é€‚ç”¨äºä¸´åºŠè¾…åŠ©è¯Šæ–­ã€‚">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="AIä¸­åŒ»æ™ºèƒ½é—®è¯ŠåŠ©æ‰‹ - ä¸“ä¸šåŒ»ç–—è¯Šæ–­å·¥å…·">
    <meta property="og:url" content="https://mxh0510.cn/">
    <meta property="og:site_name" content="TCM AI ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ">
    
    <!-- å¾®ä¿¡åˆ†äº«ä¸“ç”¨æ ‡ç­¾ -->
    <meta name="description" content="AIä¸­åŒ»æ™ºèƒ½é—®è¯ŠåŠ©æ‰‹ï¼Œä¸“ä¸šçš„ä¸­åŒ»è¯Šæ–­è¾…åŠ©å·¥å…·ï¼Œæ”¯æŒç—‡çŠ¶åˆ†æã€è¯å€™åˆ¤æ–­ã€æ–¹å‰‚æ¨è">
    <meta name="keywords" content="ä¸­åŒ»,AIè¯Šæ–­,æ™ºèƒ½é—®è¯Š,ä¸­è¯æ–¹å‰‚,è¯å€™åˆ†æ,ä¼ ç»Ÿä¸­åŒ»,äººå·¥æ™ºèƒ½">
    <meta name="author" content="TCM AI Team">
    
    <!-- å¾®ä¿¡å°ç¨‹åºåˆ†äº«å¡ç‰‡ä¼˜åŒ– -->
    <meta property="wx:card" content="summary_large_image">
    <meta property="wx:title" content="ğŸ¥ AI ä¸­åŒ»æ™ºèƒ½é—®è¯ŠåŠ©æ‰‹">
    <meta property="wx:description" content="ä¸“ä¸šAIä¸­åŒ»è¯Šæ–­è¾…åŠ©å·¥å…·ï¼Œé›†æˆ5å¤§æµæ´¾ï¼Œæä¾›ä¸ªæ€§åŒ–æ²»ç–—å»ºè®®">
    <meta property="wx:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- å¾®ä¿¡å®‰å…¨éªŒè¯ -->
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <!-- å¾®ä¿¡éªŒè¯æ–‡ä»¶æ ‡è¯† -->
    <meta name="wechat-enable" content="true">
    <meta name="applicable-device" content="mobile">
    
    <!-- Twitter Card æ ‡ç­¾ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ğŸ¥ AI ä¸­åŒ»æ™ºèƒ½é—®è¯ŠåŠ©æ‰‹">
    <meta name="twitter:description" content="åŸºäºAIçš„ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿï¼Œä¸“ä¸šåŒ»ç–—è¾…åŠ©å·¥å…·">
    <meta name="twitter:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- ç‰ˆæœ¬æ ‡è¯†: v1.2.4 æ›´æ–°æ—¶é—´: 2025-08-03 20:20 åˆ†äº«ä¼˜åŒ–ç‰ˆ -->
    <!-- ğŸ”§ ä¿®å¤è¿æ¥è¶…æ—¶ - ä½¿ç”¨å¼‚æ­¥åŠ è½½å’Œè¶…æ—¶å¤„ç† -->
    <script>
        // å¼‚æ­¥åŠ è½½marked.jsï¼Œé¿å…CDNè¶…æ—¶é˜»å¡é¡µé¢
        (function() {
            // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º5ç§’
            const timeout = setTimeout(function() {
                if (!window.marked) {
                    console.warn('âš ï¸ marked.js CDNåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨æœ¬åœ°é™çº§æ–¹æ¡ˆ');
                    initializeMarkedFallback();
                }
            }, 5000);

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            script.async = true;
            
            script.onload = function() {
                clearTimeout(timeout);
                console.log('âœ… marked.js CDNåŠ è½½æˆåŠŸ');
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                console.warn('âš ï¸ marked.js CDNåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é™çº§æ–¹æ¡ˆ');
                initializeMarkedFallback();
            };
            
            document.head.appendChild(script);
            
            // é™çº§æ–¹æ¡ˆï¼šç®€å•çš„Markdownè§£æå™¨
            function initializeMarkedFallback() {
                window.marked = {
                    parse: function(markdown) {
                        if (!markdown) return '';
                        
                        return markdown
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **ç²—ä½“**
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *æ–œä½“*
                            .replace(/`(.*?)`/g, '<code>$1</code>')           // `ä»£ç `
                            .replace(/\n\n/g, '</p><p>')                       // æ®µè½
                            .replace(/\n/g, '<br>')                           // æ¢è¡Œ
                            .replace(/^/, '<p>')                              // å¼€å§‹æ®µè½
                            .replace(/$/, '</p>');                            // ç»“æŸæ®µè½
                    }
                };
                console.log('âœ… marked.js æœ¬åœ°é™çº§æ–¹æ¡ˆå·²å°±ç»ª');
            }
        })();
    </script>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <!-- ç»Ÿä¸€è®¤è¯ç®¡ç†å™¨ -->
    <script src="/static/js/auth_manager.js"></script>
    
    <!-- ğŸ”§ å­—ä½“ä¼˜åŒ–ï¼šé¢„è¿æ¥+è¶…æ—¶+é™çº§ -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" 
          rel="stylesheet" media="print" onload="this.media='all'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    </noscript>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            background: #f5f7fa;
            overflow: hidden;
        }

        /* ä¸»å¸ƒå±€å®¹å™¨ */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .history-btn, .new-chat-btn, .auth-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .history-btn:hover, .new-chat-btn:hover, .auth-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .history-btn {
            background: rgba(255,255,255,0.15);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
        }


        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥æ­£ç¡®ç¼©å° */
            background: #f5f7fa;
        }



        /* ç—…å†ç®¡ç†å·¥å…·æ  */
        .medical-records-toolbar {
            padding: 12px 16px;
            background: #40414f;
            border-bottom: 1px solid #565869;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-title {
            color: #ececf1;
            font-size: 14px;
            font-weight: 600;
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            background: #565869;
            border: 1px solid #6b7280;
            color: #ececf1;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #6b7280;
        }

        .toolbar-btn.danger:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .toolbar-btn.success:hover {
            background: #10b981;
            border-color: #10b981;
        }

        /* è¯„ä»·å¼¹çª—æ ·å¼ */
        .rating-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .rating-modal.show {
            display: flex;
        }

        .rating-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }

        .rating-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .rating-header h3 {
            color: #374151;
            margin-bottom: 8px;
        }

        .rating-section {
            margin-bottom: 20px;
        }

        .rating-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .star-rating {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: #d1d5db;
            transition: color 0.2s;
        }

        .star.active,
        .star:hover {
            color: #fbbf24;
        }

        .rating-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        .rating-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .rating-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .rating-btn.primary {
            background: #667eea;
            color: white;
        }

        .rating-btn.primary:hover {
            background: #5a67d8;
        }

        .rating-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .rating-btn.secondary:hover {
            background: #e5e7eb;
        }

        /* å¯¹è¯åˆ—è¡¨é¡¹æ ·å¼è¡¥å…… - ChatGPTé£æ ¼ */
        .conversation-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .conversation-title {
            font-weight: 500;
            color: #ececf1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 8px;
        }

        .conversation-delete {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 16px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            margin-left: auto;
        }

        .conversation-item:hover .conversation-delete {
            opacity: 1;
        }

        .conversation-delete:hover {
            background: #ff6b6b;
            color: white;
        }

        .conversation-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-doctor {
            font-size: 12px;
            color: #40a9ff;
            font-weight: 500;
        }

        .conversation-time {
            font-size: 11px;
            color: #8e8ea0;
        }

        .conversation-meta {
            font-size: 11px;
            color: #565869;
        }

        .conversation-item-empty {
            padding: 16px;
            text-align: center;
        }

        /* è¾¹æ æ”¶èµ·æŒ‰é’® */
        .sidebar-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            z-index: 10;
        }

        .sidebar-toggle:hover {
            background: #40414f;
            color: white;
        }

        /* è¾¹æ æŠ˜å çŠ¶æ€ */
        .conversation-sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        /* å¯¹è¯å†å²è§¦å‘æŒ‰é’® */
        .conversation-history-trigger {
            position: fixed;
            top: 80px;
            left: 10px;
            z-index: 998;
            background: #40414f;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .conversation-history-trigger:hover {
            background: #565869;
            transform: translateX(2px);
        }
        
        .conversation-history-trigger.hidden {
            display: none;
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼ */
        @media (max-width: 768px) {
            .conversation-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                display: flex; /* ç§»åŠ¨ç«¯æ€»æ˜¯æ˜¾ç¤ºflex */
            }

            .conversation-sidebar.mobile-open {
                transform: translateX(0);
            }

            .conversation-sidebar.show {
                display: flex; /* ç¡®ä¿ç§»åŠ¨ç«¯æ˜¾ç¤º */
            }

            .content-wrapper {
                width: 100%;
            }

            .mobile-sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
            }
            
            /* éšè—æ¡Œé¢ç«¯è§¦å‘æŒ‰é’® */
            .conversation-history-trigger {
                display: none;
            }
            
            /* ç¡®ä¿ä¾§è¾¹æ åœ¨ç§»åŠ¨ç«¯æ­£ç¡®æ˜¾ç¤º */
            .main-content {
                position: relative;
            }
        }

            .mobile-sidebar-overlay.show {
                display: block;
            }
        }

        /* å†…å®¹å®¹å™¨ - å æ®å‰©ä½™ç©ºé—´ */
        .content-wrapper {
            display: flex;
            flex: 1;
            min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥æ­£ç¡®ç¼©å° */
            width: 100%;
            max-width: 1400px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* å·¦ä¾§æ  */
        .sidebar {
            width: 400px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* åŒ»ç”Ÿé€‰æ‹©åŒºåŸŸ */
        .doctor-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doctors-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .doctor-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }

        .doctor-card:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .doctor-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .doctor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .doctor-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .doctor-details h3 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }

        .doctor-school {
            font-size: 12px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 8px;
            border-radius: 8px;
        }

        .selection-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .doctor-card.selected .selection-indicator {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .doctor-specialty {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* å·¥å…·åŒºåŸŸ */
        .tools-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .tool-group {
            margin-bottom: 20px;
        }

        .tool-group:last-child {
            margin-bottom: 0;
        }

        .tool-title {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* å¤šå›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .upload-section {
            margin-bottom: 15px;
        }

        .upload-subtitle {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .upload-status {
            margin-top: 15px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 13px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        /* ç§»åŠ¨ç«¯å›¾ç‰‡é€‰æ‹©å¼¹çª— - å¾®ä¿¡å…¼å®¹ä¿®å¤ */
        .mobile-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999999;  /* æé«˜z-indexå±‚çº§ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .mobile-modal-hidden {
            display: none !important;
        }
        
        .mobile-modal-visible {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .mobile-image-modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 350px;
            min-width: 280px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            position: relative;
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-options {
            padding: 20px;
        }

        .image-option-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .image-option-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .image-option-btn:last-child {
            margin-bottom: 0;
        }

        .option-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .option-text {
            text-align: left;
        }

        .option-text strong {
            display: block;
            margin-bottom: 4px;
            color: #111827;
        }

        .option-text span {
            color: #6b7280;
            font-size: 13px;
        }

        .upload-status-mobile {
            padding: 15px 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .mobile-status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .mobile-status-item:last-child {
            margin-bottom: 0;
        }

        /* å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šé€‚é… */
        @media screen and (max-width: 480px) {
            .mobile-image-modal {
                padding: 15px;
            }
            
            .mobile-image-modal-content {
                max-width: calc(100vw - 30px);
                min-width: 260px;
            }
            
            .modal-header {
                padding: 15px 15px 10px 15px;
            }
            
            .modal-header h3 {
                font-size: 16px;
            }
            
            .modal-options {
                padding: 15px;
            }
            
            .image-option-btn {
                padding: 12px;
            }
        }

        /* æå°å±å¹•é€‚é… */
        @media screen and (max-width: 360px) {
            .mobile-image-modal-content {
                max-width: calc(100vw - 20px);
                border-radius: 8px;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-options {
                padding: 12px;
            }
        }

        .upload-text {
            font-size: 13px;
            color: #6b7280;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-btn {
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .voice-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .voice-btn.recording {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .auto-speak {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }

        /* å³ä¾§å¯¹è¯åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥æ­£ç¡®ç¼©å° */
            background: white;
        }

        /* å½“å‰åŒ»ç”Ÿä¿¡æ¯æ¡ */
        .current-doctor-bar {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .current-doctor-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .current-doctor-info h2 {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .current-doctor-desc {
            font-size: 14px;
            color: #6b7280;
        }

        /* å¯¹è¯æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fafafa;
        }

        .message {
            display: flex;
            margin-bottom: 24px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 12px;
        }

        .user .message-avatar {
            background: #10b981;
            color: white;
        }

        .ai .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .user .message-content {
            background: #10b981;
            color: white;
        }

        .message-content::before {
            content: '';
            position: absolute;
            top: 20px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .ai .message-content::before {
            left: -16px;
            border-right-color: white;
        }

        .user .message-content::before {
            right: -16px;
            border-left-color: #10b981;
        }

        .message-text {
            line-height: 1.6;
            font-size: 14px;
            word-wrap: break-word;
            white-space: normal;
        }
        .message-text h3, .message-text h4 {
            margin: 12px 0 8px 0;
            line-height: 1.4;
        }
        .message-text strong {
            font-weight: 600;
        }
        .message-text hr {
            margin: 12px 0;
            border: none;
            border-top: 1px solid #e5e7eb;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
        }

        /* åé¦ˆæŒ‰é’® */
        .feedback-controls {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .feedback-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .rating-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .rating-btn {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            border-top: 1px solid #e5e7eb;
            padding: 20px 24px;
            background: white;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 12px 16px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #5a67d8;
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é»˜è®¤éšè—ç§»åŠ¨ç«¯å®¹å™¨ */
        .mobile-page-container {
            display: none;
        }
        
        /* å¼ºåˆ¶æ˜¾ç¤ºç§»åŠ¨ç«¯å®¹å™¨åœ¨å°å±å¹•ä¸Š */
        @media (max-width: 768px) {
            .mobile-page-container {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: relative !important;
                width: 200% !important;
                height: 100vh !important;
                z-index: 999 !important;
                overflow: hidden !important;
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1440px) {
            .content-wrapper {
                max-width: 95%;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                position: relative;
                overflow: hidden;
            }
            
            /* éšè—æ¡Œé¢ç«¯å¸ƒå±€ï¼Œé¿å…ä¸ç§»åŠ¨ç«¯å¸ƒå±€å†²çª */
            .content-wrapper {
                display: none !important;
            }
            
            /* ç§»åŠ¨ç«¯æ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
            .mobile-messages-container .message {
                margin-bottom: 16px;
                display: flex;
                align-items: flex-end;
                gap: 8px;
                width: 100%;
                clear: both;
            }
            
            .mobile-messages-container .message.user {
                justify-content: flex-end;
                flex-direction: row-reverse;
            }
            
            .mobile-messages-container .message-content {
                max-width: 80%;
                padding: 12px 16px;
                border-radius: 18px;
                word-wrap: break-word;
                line-height: 1.4;
                display: block;
            }
            
            .mobile-messages-container .message.user .message-content {
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                border-bottom-right-radius: 6px;
            }
            
            .mobile-messages-container .message.ai .message-content {
                background: white;
                color: #374151;
                border: 1px solid #e5e7eb;
                border-bottom-left-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .mobile-messages-container .message-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                flex-shrink: 0;
            }
            
            .mobile-messages-container .message.user .message-avatar {
                background: #3b82f6;
                color: white;
            }
            
            .mobile-messages-container .message.ai .message-avatar {
                background: #f3f4f6;
                color: #6b7280;
            }
            
            /* ç§»åŠ¨ç«¯é¡µé¢å®¹å™¨ */
            .mobile-page-container {
                display: flex !important; /* è¦†ç›–é»˜è®¤çš„éšè— */
                position: relative;
                width: 200%;
                height: 100vh;
                min-height: 100vh;
                transition: transform 0.3s ease-in-out;
                overflow: hidden;
            }
            
            .mobile-page-container.show-chat {
                transform: translateX(-50%);
            }
            
            /* åŒ»ç”Ÿé€‰æ‹©é¡µé¢ */
            .mobile-doctor-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .mobile-doctor-header {
                padding: 20px;
                text-align: center;
                color: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }

            .mobile-header-content {
                flex: 1;
            }
            
            .mobile-doctor-header h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .mobile-doctor-header p {
                font-size: 0.9rem;
                opacity: 0.9;
            }

            .mobile-header-actions {
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            }

            .mobile-action-btn {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                font-weight: 500;
                min-width: 60px;
            }

            .mobile-action-btn:hover,
            .mobile-action-btn:active {
                background: rgba(255,255,255,0.25);
                transform: translateY(-1px);
            }

            .mobile-chat-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .mobile-action-btn-small {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px;
                border-radius: 12px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .mobile-action-btn-small:hover,
            .mobile-action-btn-small:active {
                background: rgba(255,255,255,0.25);
                transform: scale(1.05);
            }
            
            .mobile-doctors-container {
                flex: 1;
                background: white;
                border-radius: 20px 20px 0 0;
                padding: 24px 16px 30px 16px; /* ä¼˜åŒ–åº•éƒ¨å†…è¾¹è· */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
                max-height: calc(100vh - 160px); /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…æº¢å‡º */
            }
            
            .mobile-doctors-title {
                text-align: center;
                font-size: 1.2rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 20px;
            }
            
            .mobile-doctors-grid {
                display: block; /* æ”¹ä¸ºblockæé«˜å…¼å®¹æ€§ */
                width: 100%;
            }
            
            /* å¦‚æœæµè§ˆå™¨æ”¯æŒGridï¼Œåˆ™ä½¿ç”¨Gridå¸ƒå±€ */
            @supports (display: grid) {
                .mobile-doctors-grid {
                    display: grid;
                    grid-template-columns: 1fr;
                    gap: 16px;
                }
            }
            
            .mobile-doctor-card {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                padding: 16px;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 8px; /* å¢åŠ å¡ç‰‡é—´è· */
                min-height: 120px; /* ç¡®ä¿å¡ç‰‡æœ€å°é«˜åº¦ */
            }
            
            .mobile-doctor-card:hover,
            .mobile-doctor-card:active,
            .mobile-doctor-card.selected {
                border-color: #3b82f6;
                background: linear-gradient(135deg, #eff6ff, #f0f9ff);
                transform: translateY(-1px);
                box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
            }
            
            .mobile-doctor-card.selected .mobile-doctor-avatar {
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
            }
            
            .mobile-doctor-info {
                display: flex;
                align-items: flex-start;
                margin-bottom: 12px;
                gap: 12px;
            }
            
            .mobile-doctor-avatar {
                font-size: 2.2rem;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
                border-radius: 50%;
                border: 2px solid #3b82f6;
            }
            
            .mobile-doctor-details {
                flex: 1;
            }
            
            .mobile-doctor-details h3 {
                font-size: 1.05rem;
                font-weight: 600;
                color: #374151;
                margin: 0 0 4px 0;
                line-height: 1.3;
            }
            
            .mobile-doctor-details .school {
                font-size: 0.8rem;
                color: #6b7280;
                margin: 0;
            }
            
            .mobile-doctor-specialty {
                font-size: 0.85rem;
                color: #4b5563;
                line-height: 1.4;
                margin-top: 8px;
            }
            
            .mobile-doctor-specialty strong {
                color: #374151;
                font-weight: 500;
            }
            
            /* èŠå¤©é¡µé¢ */
            .mobile-chat-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: white;
                position: relative;
                overflow: hidden;
            }
            
            .mobile-chat-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                flex-shrink: 0;
            }
            
            .mobile-back-btn {
                background: none;
                border: none;
                color: white;
                font-size: 1.2rem;
                padding: 8px;
                margin-right: 12px;
                cursor: pointer;
                border-radius: 50%;
                transition: background 0.2s;
            }
            
            .mobile-back-btn:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .mobile-current-doctor {
                flex: 1;
                display: flex;
                align-items: center;
            }
            
            .mobile-current-doctor .avatar {
                font-size: 1.5rem;
                margin-right: 12px;
            }
            
            .mobile-current-doctor .info h2 {
                font-size: 1rem;
                margin-bottom: 2px;
            }
            
            .mobile-current-doctor .info p {
                font-size: 0.8rem;
                opacity: 0.9;
            }
            
            .mobile-messages-container {
                flex: 1;
                padding: 16px 12px;
                overflow-y: auto;
                overflow-x: hidden;
                background: #f9fafb;
                -webkit-overflow-scrolling: touch;
                min-height: 0;
                display: block;
                position: relative;
                scroll-behavior: smooth;
            }
            
            .mobile-input-container {
                padding: 12px 16px;
                background: white;
                border-top: 1px solid #e5e7eb;
                flex-shrink: 0;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
                position: relative; /* æ¢å¤ç›¸å¯¹å®šä½ */
                z-index: 10;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .mobile-input-helper {
                display: flex !important;
                align-items: center;
                gap: 8px;
                margin-bottom: 10px;
                padding: 0 4px;
                flex-wrap: wrap;
                min-height: 40px;
                width: 100%;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .mobile-guidance-trigger {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 18px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
            }

            .mobile-guidance-trigger:hover,
            .mobile-guidance-trigger:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            }

            .mobile-upload-trigger {
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 18px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 4px;
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
            }

            .mobile-upload-trigger:hover,
            .mobile-upload-trigger:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }

            .mobile-upload-trigger.has-file {
                background: linear-gradient(135deg, #10b981, #059669);
                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
            }

            .mobile-helper-text {
                font-size: 11px;
                color: #6b7280;
                flex: 1;
                min-width: 120px;
                text-align: right;
            }
            
            .mobile-input-wrapper {
                display: flex;
                gap: 8px;
                align-items: flex-end;
                width: 100%;
                margin-top: 8px;
            }
            
            .mobile-input-wrapper textarea {
                flex: 1;
                border: 1px solid #d1d5db;
                border-radius: 20px;
                padding: 12px 16px;
                font-size: 16px;
                resize: none;
                max-height: 100px;
                min-height: 44px;
                -webkit-appearance: none;
                -webkit-border-radius: 20px;
                line-height: 1.4;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            }
            
            .mobile-send-btn {
                width: 44px;
                height: 44px;
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 1.2rem;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            }
            
            .mobile-send-btn:hover,
            .mobile-send-btn:active {
                transform: translateY(-1px) scale(1.05);
                box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            }
            
            .mobile-send-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            .mobile-send-btn:hover {
                background: #2563eb;
            }
            
            .mobile-send-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }
            
            /* PCç«¯å…ƒç´ æ­£å¸¸æ˜¾ç¤º - ç§»é™¤äº†éšè—è§„åˆ™ */
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            
            .header-title h1 {
                font-size: 1.1rem;
            }
            
            .header-subtitle {
                font-size: 0.7rem;
            }
            
            .messages-container {
                padding: 8px;
            }
            
            .message-content {
                max-width: 95%;
                font-size: 0.85rem;
                padding: 10px 12px;
            }
            
            .input-container {
                padding: 8px;
            }
            
            .new-chat-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            /* ç§»åŠ¨ç«¯æ¶ˆæ¯ä¼˜åŒ– */
            .mobile-messages-container {
                padding: 12px 8px;
            }
            
            .mobile-input-container {
                padding: 8px 12px;
            }
            
            .mobile-input-wrapper textarea {
                font-size: 15px;
            }
            
            .message.ai .message-content,
            .message.user .message-content {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 14px;
            }
            
            .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .sidebar {
                max-height: 120px !important;
            }
            
            .doctor-section {
                padding: 6px 8px !important;
            }
            
            .doctor-card {
                min-width: 100px !important;
                padding: 6px 8px !important;
            }
        }
        
        @media (max-width: 320px) {
            .header-title h1 {
                font-size: 1.0rem;
            }
            
            .message-content {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .input-wrapper input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .sidebar {
                max-height: 100px !important;
            }
            
            .doctor-section {
                padding: 4px 6px !important;
            }
            
            .doctor-section .section-title {
                font-size: 0.8rem !important;
                margin-bottom: 4px !important;
            }
            
            .doctor-card {
                min-width: 90px !important;
                padding: 4px 6px !important;
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-name {
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-desc {
                font-size: 0.6rem !important;
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .messages-container::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .messages-container::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* é—®è¯ŠæŒ‡å¯¼æ ·å¼ */
        .input-helper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .guidance-trigger {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 10px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .guidance-trigger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .helper-text {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }

        .guidance-tips {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            animation: fadeInScale 0.3s ease-out;
        }

        .tips-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tips-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        /* ç™»å½•æ¨¡æ€æ¡†æ ·å¼ */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .login-modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }

        .login-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .login-form {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .login-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .login-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .login-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .login-btn.secondary:hover {
            background: #e5e7eb;
        }

        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tips-content {
            padding: 20px;
        }

        .tip-section {
            margin-bottom: 20px;
        }

        .tip-section h5 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .tip-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .tip-section li {
            margin-bottom: 5px;
            color: #666;
            line-height: 1.4;
        }

        .tip-footer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tip-footer p {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .guidance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .guidance-tips {
                max-width: 95vw;
                max-height: 80vh;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
                border-radius: 16px;
                padding: 0;
            }
            
            .tips-header {
                padding: 16px 20px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .tips-header h4 {
                font-size: 18px;
                margin: 0;
            }
            
            .tips-content {
                padding: 16px 20px;
                max-height: calc(80vh - 80px);
                overflow-y: auto;
            }
            
            .tip-section {
                margin-bottom: 16px;
            }
            
            .tip-section h5 {
                font-size: 15px;
                margin-bottom: 8px;
                color: #374151;
            }
            
            .tip-section ul {
                padding-left: 16px;
                margin: 0;
            }
            
            .tip-section li {
                font-size: 14px;
                line-height: 1.5;
                margin-bottom: 4px;
                color: #4b5563;
            }
            
            .close-btn {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }
            
            .input-helper {
                display: flex !important;
                padding: 0 12px;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 12px;
            }
            
            .guidance-trigger {
                font-size: 14px !important;
                padding: 8px 12px !important;
                border-radius: 6px !important;
                min-height: 36px;
            }
            
            .helper-text {
                font-size: 11px;
                line-height: 1.3;
                flex: 1;
                min-width: 100%;
                margin-top: 4px;
            }
        }

        /* å¯¹è¯çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .conversation-state-indicator {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 12px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .state-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 13px;
            color: #374151;
        }

        .state-icon {
            font-size: 14px;
        }

        .state-label {
            font-weight: 500;
        }

        /* ç¡®è®¤å¤„æ–¹æ¨¡æ€æ¡† */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-modal .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            margin: 20px;
            text-align: center;
        }

        .confirmation-modal h3 {
            margin-bottom: 16px;
            color: #374151;
        }

        .confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .confirmation-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .continue-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* ===== PCç«¯å¸ƒå±€å¼ºåˆ¶ä¿®å¤ ===== */
        @media (min-width: 769px) {
            /* ç¡®ä¿æ¡Œé¢ç«¯å¸ƒå±€æ­£ç¡® */
            .app-container {
                height: 100vh !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .main-content {
                flex: 1 !important;
                display: flex !important;
                height: calc(100vh - 70px) !important; /* å‡å»headeré«˜åº¦ */
            }
            
            .content-wrapper {
                flex: 1 !important;
                display: flex !important;
                max-height: 100% !important;
            }
            
            .sidebar {
                width: 400px !important;
                flex-shrink: 0 !important;
                height: 100% !important;
                max-height: none !important; /* ç§»é™¤å¯èƒ½çš„é«˜åº¦é™åˆ¶ */
            }
            
            .chat-area {
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                height: 100% !important;
                max-height: 100% !important;
            }
            
            .messages-container {
                flex: 1 !important;
                overflow-y: auto !important;
                height: 0 !important; /* å¼ºåˆ¶flexç”Ÿæ•ˆ */
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ç§»åŠ¨ç«¯é¡µé¢å®¹å™¨ -->
        <div class="mobile-page-container" id="mobilePageContainer">
            <!-- åŒ»ç”Ÿé€‰æ‹©é¡µé¢ -->
            <div class="mobile-doctor-page">
                <div class="mobile-doctor-header">
                    <div class="mobile-header-content">
                        <h1>AI ä¸­åŒ»æ™ºèƒ½é—®è¯Š</h1>
                        <p>ä¼ ç»Ÿä¸­åŒ» Ã— äººå·¥æ™ºèƒ½</p>
                    </div>
                    <div class="mobile-header-actions">
                        <button class="mobile-action-btn" onclick="showMobileNavigation()" title="é¡µé¢å¯¼èˆª">
                            ğŸ”— å¯¼èˆª
                        </button>
                        <button class="mobile-action-btn" onclick="openRegisterPage()" title="æ³¨å†Œè´¦æˆ·">
                            ğŸ‘¤ æ³¨å†Œ
                        </button>
                        <button class="mobile-action-btn" onclick="openHistoryPage()" title="æŸ¥çœ‹å†å²">
                            ğŸ“‹ å†å²
                        </button>
                    </div>
                </div>
                <div class="mobile-doctors-container">
                    <h2 class="mobile-doctors-title">ğŸ‘¨â€âš•ï¸ ä¸­åŒ»å¸ˆå›¢é˜Ÿ</h2>
                    <div class="mobile-doctors-grid" id="mobileDoctorsGrid">
                        <!-- åŒ»ç”Ÿå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- èŠå¤©é¡µé¢ -->
            <div class="mobile-chat-page">
                <div class="mobile-chat-header">
                    <button class="mobile-back-btn" onclick="showMobileDoctorPage()">â†</button>
                    <div class="mobile-current-doctor">
                        <div class="avatar" id="mobileDoctorAvatar">ğŸ¤–</div>
                        <div class="info">
                            <h2 id="mobileDoctorName">åŒ»å¸ˆå§“å</h2>
                            <p id="mobileDoctorDesc">åŒ»å¸ˆæè¿°</p>
                        </div>
                    </div>
                    <div class="mobile-chat-actions">
                        <button class="mobile-action-btn-small" onclick="openRegisterPage()" title="æ³¨å†Œ">
                            ğŸ‘¤
                        </button>
                        <button class="mobile-action-btn-small" onclick="openMobileSidebar()" title="å¯¹è¯åˆ—è¡¨">
                            ğŸ“‹
                        </button>
                        <button class="mobile-action-btn-small" onclick="createNewConversation()" title="æ–°å¯¹è¯">
                            âœ¨
                        </button>
                    </div>
                </div>
                <div class="mobile-messages-container" id="mobileMessagesContainer">
                    <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="mobile-input-container">
                    <div class="mobile-input-helper">
                        <button onclick="showGuidance()" class="mobile-guidance-trigger">ğŸ’¡ é—®è¯ŠæŒ‡å¯¼</button>
                        <button onclick="showMobileImageOptions()" class="mobile-upload-trigger" id="mobileUploadTrigger">
                            ğŸ“· <span id="mobileUploadText">ä¸Šä¼ èˆŒè‹”å’Œé¢è±¡ç…§ç‰‡</span>
                        </button>
                        <span class="mobile-helper-text">ä¸çŸ¥é“æ€ä¹ˆæè¿°ç—‡çŠ¶ï¼Ÿ</span>
                    </div>
                    <!-- ç§»åŠ¨ç«¯å¤šå›¾ç‰‡ä¸Šä¼  -->
                    <input type="file" id="mobileTongueUpload" accept="image/*" style="display: none;" onchange="handleMobileTongueUpload(event)">
                    <input type="file" id="mobileFaceUpload" accept="image/*" style="display: none;" onchange="handleMobileFaceUpload(event)">
                    
                    <!-- ç§»åŠ¨ç«¯å›¾ç‰‡é€‰æ‹©å¼¹çª—å·²ç§»åŠ¨åˆ°bodyåº•éƒ¨ -->
                    <div class="mobile-input-wrapper">
                        <textarea 
                            id="mobileMessageInput" 
                            placeholder="è¯·æè¿°æ‚¨çš„ç—‡çŠ¶æˆ–é—®é¢˜..."
                            rows="1"
                            onkeydown="handleMobileKeyPress(event)"
                            oninput="adjustMobileTextareaHeight()"
                            onfocus="ensureMobileInputVisible()"
                            onblur="handleMobileInputBlur()"
                            style="resize: none; outline: none;"
                        ></textarea>
                        <button class="mobile-send-btn" id="mobileSendBtn" onclick="sendMobileMessage()">â†’</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¡Œé¢ç«¯ï¼šé¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>AI ä¸­åŒ»æ™ºèƒ½é—®è¯Š</h1>
                    <p class="header-subtitle">ä¼ ç»Ÿä¸­åŒ» Ã— äººå·¥æ™ºèƒ½ - ä¸“ä¸šç‰ˆ</p>
                </div>
                <div class="header-actions">
                    <!-- è‡ªåŠ¨åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ (è‡ªåŠ¨æ˜¾ç¤ºï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ) -->
                    <!-- æœªç™»å½•çŠ¶æ€ -->
                    <div id="authButtons" style="display: flex; gap: 12px;">
                        <button class="auth-btn" onclick="showLoginModal()" title="ç”¨æˆ·ç™»å½•">
                            ğŸ” ç™»å½•
                        </button>
                        <button class="history-btn" onclick="openRegisterPage()" title="æ³¨å†Œè´¦æˆ·">
                            ğŸ‘¤ æ³¨å†Œ
                        </button>
                    </div>
                    
                    <!-- å·²ç™»å½•çŠ¶æ€ -->
                    <div id="userInfo" class="user-info" style="display: none;">
                        <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                        <span class="user-name" id="userName">æ¸¸å®¢</span>
                        <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                    </div>
                    
                    <button class="history-btn" onclick="window.location.href='/static/prescription_checker_v2.html'" title="å¤„æ–¹å®‰å…¨æ£€æµ‹" id="prescriptionCheckerBtn">
                        ğŸ’Š å¤„æ–¹æ£€æµ‹
                    </button>
                    <button class="history-btn" onclick="openHistoryPage()" title="æŸ¥çœ‹é—®è¯Šå†å²" id="historyBtn">
                        ğŸ“‹ å†å²è®°å½•
                    </button>
                    <button class="new-chat-btn" onclick="createNewConversation()">
                        âœ¨ æ–°å¯¹è¯
                    </button>
                </div>
            </div>
        </header>


        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">

            <div class="content-wrapper">
                <!-- å·¦ä¾§æ  -->
                <aside class="sidebar">
                <!-- åŒ»ç”Ÿé€‰æ‹©åŒºåŸŸ -->
                <div class="doctor-section">
                    <h3 class="section-title">ğŸ‘¨â€âš•ï¸ é€‰æ‹©åŒ»å¸ˆ</h3>
                    <div class="doctors-grid" id="doctorsGrid">
                        <!-- åŒ»ç”Ÿå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å·¥å…·åŒºåŸŸ -->
                <div class="tools-section">
                    <!-- å¤šå›¾ç‰‡ä¸Šä¼  - èˆŒè¯Š + é¢è¯Š -->
                    <div class="tool-group">
                        <h4 class="tool-title">ğŸ“¸ å›¾åƒè¯Šæ–­</h4>
                        
                        <!-- èˆŒè¯Šå›¾ç‰‡ä¸Šä¼  -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">ğŸ‘… èˆŒè¯Šå›¾ç‰‡</h5>
                            <div class="upload-area" id="tongueUploadArea" onclick="triggerTongueUpload()">
                                <div class="upload-icon">ğŸ“·</div>
                                <div class="upload-text">ç‚¹å‡»ä¸Šä¼ èˆŒè¯Šç…§ç‰‡</div>
                            </div>
                            <input type="file" id="tongueImageUpload" accept="image/*" style="display: none;" onchange="handleTongueImageUpload(event)">
                        </div>
                        
                        <!-- é¢è¯Šå›¾ç‰‡ä¸Šä¼  -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">ğŸ˜Š é¢è¯Šå›¾ç‰‡</h5>
                            <div class="upload-area" id="faceUploadArea" onclick="triggerFaceUpload()">
                                <div class="upload-icon">ğŸ“·</div>
                                <div class="upload-text">ç‚¹å‡»ä¸Šä¼ é¢è¯Šç…§ç‰‡</div>
                            </div>
                            <input type="file" id="faceImageUpload" accept="image/*" style="display: none;" onchange="handleFaceImageUpload(event)">
                        </div>
                        
                        <!-- ä¸Šä¼ çŠ¶æ€ -->
                        <div class="upload-status" id="uploadStatus" style="display: none;">
                            <div class="status-item" id="tongueStatus">ğŸ‘… èˆŒè¯Š: <span>æœªä¸Šä¼ </span></div>
                            <div class="status-item" id="faceStatus">ğŸ˜Š é¢è¯Š: <span>æœªä¸Šä¼ </span></div>
                        </div>
                    </div>

                    <!-- è¯­éŸ³åŠŸèƒ½ -->
                    <div class="tool-group">
                        <h4 class="tool-title">ğŸ¤ è¯­éŸ³åŠŸèƒ½</h4>
                        <div class="voice-controls">
                            <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">
                                å¼€å§‹è¯­éŸ³è¾“å…¥
                            </button>
                            <label class="auto-speak">
                                <input type="checkbox" id="autoSpeak">
                                <span>è‡ªåŠ¨æœ—è¯»å›å¤</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- å³ä¾§å¯¹è¯åŒºåŸŸ -->
            <main class="chat-area">
                <!-- å½“å‰åŒ»ç”Ÿä¿¡æ¯æ¡ -->
                <div class="current-doctor-bar" id="currentDoctorBar">
                    <div class="current-doctor-avatar" id="currentDoctorAvatar">ğŸ¤–</div>
                    <div class="current-doctor-info">
                        <h2 id="currentDoctorName">è¯·é€‰æ‹©åŒ»å¸ˆ</h2>
                        <p class="current-doctor-desc" id="currentDoctorDesc">å½“å‰åŒ»å¸ˆï¼šå¼ ä»²æ™¯</p>
                    </div>
                </div>

                <!-- å¯¹è¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div id="conversationStateIndicator" class="conversation-state-indicator">
                    <div class="state-indicator">
                        <span class="state-icon">ğŸ”„</span>
                        <span class="state-label">åˆå§‹é—®è¯Š</span>
                    </div>
                </div>

                <!-- å¯¹è¯æ¶ˆæ¯åŒºåŸŸ -->
                <div class="messages-container" id="messagesContainer">
                    <!-- é»˜è®¤åŒ»ç”Ÿå·²é€‰ä¸­ï¼Œä¸éœ€è¦é€‰æ‹©æç¤º -->
                </div>

                <!-- åŠ è½½åŠ¨ç”» -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <div>AIæ­£åœ¨æ€è€ƒä¸­...</div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="input-area">
                    <div class="input-helper">
                        <button onclick="showGuidance()" class="guidance-trigger">ğŸ’¡ é—®è¯ŠæŒ‡å¯¼</button>
                        <span class="helper-text">ä¸çŸ¥é“æ€ä¹ˆæè¿°ç—‡çŠ¶ï¼Ÿç‚¹å‡»æŸ¥çœ‹é—®è¯ŠæŒ‡å¯¼</span>
                    </div>
                    <div class="input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="è¯·æè¿°æ‚¨çš„ç—‡çŠ¶æˆ–é—®é¢˜..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                            oninput="adjustTextareaHeight()"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            â†’
                        </button>
                    </div>
                </div>
            </main>
            </div> <!-- end content-wrapper -->
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentConversationId = '';
        let selectedDoctor = 'jin_daifu'; // é»˜è®¤é‡‘å¤§å¤«
        let isVoiceRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        
        // è®¤è¯ç›¸å…³å˜é‡
        let currentUser = null;
        let userToken = null;

        // åŒ»ç”Ÿæ•°æ®ï¼ˆåŠ¨æ€åŠ è½½ï¼‰
        let doctors = {};
        
        // åŒ»ç”Ÿé»˜è®¤å¤´åƒæ˜ å°„ï¼ˆç”¨äºAPIè¿”å›çš„åŒ»ç”Ÿæ•°æ®ï¼‰
        const doctorAvatarMap = {
            "jin_daifu": "ğŸ‘¨â€âš•ï¸",
            "zhang_zhongjing": "ğŸ¯",
            "ye_tianshi": "ğŸŒ¿"
        };
        
        // ä»APIåŠ è½½åŒ»ç”Ÿåˆ—è¡¨
        async function loadDoctors() {
            try {
                const response = await fetch('/api/doctors/list');
                const result = await response.json();
                
                if (result.success && result.doctors) {
                    // è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼
                    doctors = {};
                    result.doctors.forEach(doctor => {
                        const doctorCode = doctor.doctor_code;
                        
                        // è§£æspecialtiesï¼ˆå¯èƒ½æ˜¯JSONå­—ç¬¦ä¸²ï¼‰
                        let specialty = "ä¸­åŒ»å…¨ç§‘";
                        if (doctor.specialties) {
                            try {
                                const specs = JSON.parse(doctor.specialties);
                                specialty = Array.isArray(specs) ? specs.join('ã€') : doctor.specialties;
                            } catch {
                                specialty = doctor.specialties;
                            }
                        }
                        
                        // ğŸ”§ ä¿®å¤specialty.splité”™è¯¯ - ç¡®ä¿specialtyæ˜¯å­—ç¬¦ä¸²
                        const specialtyStr = String(specialty || "ä¸­åŒ»");
                        
                        doctors[doctorCode] = {
                            "name": doctor.name,
                            "school": specialtyStr.split('ã€')[0] || "ä¸­åŒ»",
                            "avatar": doctorAvatarMap[doctorCode] || "ğŸ‘¨â€âš•ï¸",
                            "specialty": specialtyStr,
                            "introduction": doctor.introduction || `${doctor.name}åŒ»å¸ˆï¼Œæ“…é•¿${specialtyStr}ç­‰ç–¾ç—…çš„è¯Šæ²»ã€‚`
                        };
                    });
                    
                    console.log('âœ… åŒ»ç”Ÿåˆ—è¡¨åŠ è½½æˆåŠŸ:', Object.keys(doctors).length, 'ä½åŒ»ç”Ÿ');
                    
                    // æ›´æ–°åŒ»ç”Ÿé€‰æ‹©å™¨
                    updateDoctorSelector();
                } else {
                    console.error('âŒ åŒ»ç”Ÿåˆ—è¡¨åŠ è½½å¤±è´¥:', result.message);
                    // ä½¿ç”¨é»˜è®¤åŒ»ç”Ÿæ•°æ®ä½œä¸ºå¤‡é€‰
                    loadDefaultDoctors();
                }
            } catch (error) {
                console.error('âŒ åŠ è½½åŒ»ç”Ÿåˆ—è¡¨å¼‚å¸¸:', error);
                // ä½¿ç”¨é»˜è®¤åŒ»ç”Ÿæ•°æ®ä½œä¸ºå¤‡é€‰
                loadDefaultDoctors();
            }
        }
        
        // åŠ è½½é»˜è®¤åŒ»ç”Ÿæ•°æ®ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
        function loadDefaultDoctors() {
            doctors = {
                "jin_daifu": {
                    "name": "é‡‘å¤§å¤«",
                    "school": "ç»æ–¹å¤§å¸ˆ", 
                    "avatar": "ğŸ‘¨â€âš•ï¸",
                    "specialty": "ç»æ–¹åº”ç”¨ã€ç–‘éš¾æ‚ç—‡ã€ç»¼åˆè¯Šç–—",
                    "introduction": "ç»æ–¹å¤§å¸ˆï¼Œæ·±é€šå¤å…¸åŒ»å­¦ï¼Œæ“…é•¿è¿ç”¨ç»å…¸æ–¹å‰‚è§£å†³ç°ä»£ç–‘éš¾æ‚ç—‡ï¼Œä¸´åºŠç»éªŒä¸°å¯Œã€‚"
                },
                "zhang_zhongjing": {
                    "name": "å¼ ä»²æ™¯",
                    "school": "ä¼¤å¯’æ´¾", 
                    "avatar": "ğŸ¯",
                    "specialty": "å¤–æ„Ÿç—…ã€å†…ä¼¤æ‚ç—…ã€æ€¥ç—‡",
                    "introduction": "ä¼¤å¯’æ´¾ä»¥ã€Šä¼¤å¯’è®ºã€‹ä¸ºç†è®ºåŸºç¡€ï¼Œæ“…é•¿å…­ç»è¾¨è¯ï¼Œæ²»ç–—å¤–æ„Ÿçƒ­ç—…å’Œå†…ä¼¤æ‚ç—…ã€‚ç”¨è¯ç²¾å‡†ï¼Œæ–¹è¯å¯¹åº”ã€‚"
                },
                "ye_tianshi": {
                    "name": "å¶å¤©å£«",
                    "school": "æ¸©ç—…æ´¾",
                    "avatar": "ğŸŒ¿",
                    "specialty": "æ¸©ç—…ã€æ—¶ä»¤ç—…è¯ã€å†…ç§‘æ‚ç—‡",
                    "introduction": "æ¸©ç—…æ´¾åˆ›å§‹äººï¼Œä»¥ã€Šæ¸©çƒ­è®ºã€‹è‘—ç§°ï¼Œæ“…é•¿å«æ°”è¥è¡€è¾¨è¯ï¼Œæ²»ç–—å­£èŠ‚æ€§ç–¾ç—…å’Œå†…ç§‘ç–‘éš¾æ‚ç—‡ã€‚"
                }
            };
            console.log('âš ï¸ ä½¿ç”¨é»˜è®¤åŒ»ç”Ÿæ•°æ®');
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        
        /**
         * åˆå§‹åŒ–æ˜Ÿçº§è¯„ä»·äº¤äº’
         */
        function initializeStarRatings() {
            // ä¸ºæ‰€æœ‰æ˜Ÿæ˜Ÿæ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('star')) {
                    const ratingGroup = e.target.closest('.star-rating');
                    if (ratingGroup) {
                        const category = ratingGroup.getAttribute('data-category');
                        const stars = ratingGroup.querySelectorAll('.star');
                        const rating = Array.from(stars).indexOf(e.target) + 1;
                        
                        handleStarRating(category, rating);
                    }
                }
            });
            
            // ä¸ºæ˜Ÿæ˜Ÿæ·»åŠ hoveræ•ˆæœ
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('star')) {
                    const ratingGroup = e.target.closest('.star-rating');
                    if (ratingGroup) {
                        const stars = ratingGroup.querySelectorAll('.star');
                        const hoverIndex = Array.from(stars).indexOf(e.target);
                        
                        stars.forEach((star, index) => {
                            if (index <= hoverIndex) {
                                star.style.color = '#ffd700';
                            } else {
                                star.style.color = '#ddd';
                            }
                        });
                    }
                }
            });
            
            // æ¢å¤æ˜Ÿæ˜ŸåŸæœ¬çš„çŠ¶æ€ï¼ˆé¼ æ ‡ç¦»å¼€æ—¶ï¼‰
            document.addEventListener('mouseout', function(e) {
                if (e.target.classList.contains('star')) {
                    const ratingGroup = e.target.closest('.star-rating');
                    if (ratingGroup) {
                        const stars = ratingGroup.querySelectorAll('.star');
                        const currentRating = parseInt(ratingGroup.getAttribute('data-rating') || '0');
                        
                        stars.forEach((star, index) => {
                            if (index < currentRating) {
                                star.style.color = '#ffd700';
                            } else {
                                star.style.color = '#ddd';
                            }
                        });
                    }
                }
            });
        }
        
        /**
         * ç»‘å®šè¯„ä»·æ¨¡æ€æ¡†äº‹ä»¶
         */
        function bindEvaluationModalEvents() {
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            const modal = document.getElementById('evaluationModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideEvaluationModal();
                    }
                });
            }
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('evaluationModal');
                    if (modal && modal.style.display === 'flex') {
                        hideEvaluationModal();
                    }
                    
                    const statsModal = document.getElementById('statisticsModal');
                    if (statsModal) {
                        closeStatisticsModal();
                    }
                }
            });
        }

        // æ¸…ç†æ—§çš„localStorageæ•°æ®ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
        function cleanupOldUserData() {
            // æ¸…ç†æ—§æ ¼å¼çš„å†å²è®°å½•ï¼ˆä¸å«ç”¨æˆ·IDçš„ï¼‰
            const keys = Object.keys(localStorage);
            const oldHistoryKeys = keys.filter(key => 
                key.startsWith('tcm_doctor_history_') && 
                !key.includes('guest_portal_') && 
                !key.includes('smart_user_') &&
                !key.match(/tcm_doctor_history_[\w\-]+_[\w\-]+/)  // ä¸åŒ¹é…æ–°æ ¼å¼ userId_doctorId
            );
            
            oldHistoryKeys.forEach(key => {
                localStorage.removeItem(key);
                console.log('æ™ºèƒ½å·¥ä½œæµé¡µé¢å·²æ¸…ç†æ—§å†å²è®°å½•:', key);
            });
        }

        async function initializeApp() {
            console.log('ğŸš€ åˆå§‹åŒ–TCM-AIæ™ºèƒ½å·¥ä½œæµç³»ç»Ÿ');
            
            // ğŸ” ç”¨æˆ·çŠ¶æ€æ£€æµ‹å’Œç®¡ç†
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const hasRealUser = !!(currentUser.id || currentUser.user_id);
            
            console.log('ğŸ‘¤ ç”¨æˆ·çŠ¶æ€æ£€æµ‹:', hasRealUser ? 'çœŸå®ç™»å½•ç”¨æˆ·' : 'è®¿å®¢æ¨¡å¼');
            if (hasRealUser) {
                console.log('ğŸ”‘ ç™»å½•ç”¨æˆ·ä¿¡æ¯:', currentUser.username || currentUser.name || currentUser.id);
            }
            
            // è®¾ç½®åˆå§‹ç”¨æˆ·çŠ¶æ€
            window.lastKnownUser = localStorage.getItem('currentUser');
            
            // ğŸ”‘ æ–°å¢ï¼šæ£€æŸ¥URLå‚æ•°æ˜¯å¦éœ€è¦æ¢å¤ä¼šè¯
            const urlParams = new URLSearchParams(window.location.search);
            const restoreSessionId = urlParams.get('restore_session');
            if (restoreSessionId) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°ä¼šè¯æ¢å¤è¯·æ±‚:', restoreSessionId);
                // å»¶è¿Ÿæ¢å¤ï¼Œç­‰å¾…é¡µé¢å®Œå…¨åˆå§‹åŒ–
                setTimeout(() => {
                    restoreSessionFromHistory(restoreSessionId);
                }, 2000);
                
                // æ¸…é™¤URLå‚æ•°é¿å…é‡å¤æ¢å¤
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
            
            // é¦–å…ˆæ¸…ç†æ—§æ•°æ®ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
            cleanupOldUserData();
            
            // ğŸ”„ å®šæœŸæ£€æµ‹ç”¨æˆ·çŠ¶æ€å˜åŒ–ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(() => {
                detectUserChange();
            }, 5000);
            
            // ğŸ”§ å…ˆåŠ è½½åŒ»ç”Ÿåˆ—è¡¨ï¼Œå†æ¸²æŸ“åŒ»ç”Ÿå¡ç‰‡
            await loadDoctors();
            renderDoctorCards();
            loadConversationHistory(); // è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨generateConversationIdå¦‚æœéœ€è¦
            
            // ğŸ”„ åˆå§‹åŒ–ChatGPTé£æ ¼å¯¹è¯ç®¡ç†ç³»ç»Ÿ
            initConversationManager();
            
            // è®¾ç½®é»˜è®¤åŒ»ç”Ÿ - é‡‘å¤§å¤«ï¼ˆç»æ–¹å¤§å¸ˆï¼‰
            // ğŸ”§ ä¿®å¤é‡å¤æ¬¢è¿æ¶ˆæ¯ï¼šè·³è¿‡å†å²è®°å½•åŠ è½½ï¼Œå› ä¸ºloadConversationHistoryå·²ç»å¤„ç†äº†
            setDefaultDoctor('jin_daifu', true);
            
            // ğŸ§¹ æš´éœ²å…¨å±€æ¸…ç†å‡½æ•°ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
            window.clearCurrentUserData = clearCurrentUserData;
            window.switchUserContext = switchUserContext;
            
            // ğŸ”‘ ä¿®å¤ï¼šç¡®ä¿åœ¨é¡µé¢å®Œå…¨å‡†å¤‡å¥½åå†æ¢å¤å¤„æ–¹çŠ¶æ€
            // ğŸ”‘ æ—§çš„ç»Ÿä¸€æ¢å¤æœºåˆ¶å·²ç¦ç”¨ï¼Œä½¿ç”¨æ–°çš„ç®€åŒ–ç‰ˆæ¢å¤ç³»ç»Ÿ
            function startUnifiedPrescriptionRecovery() {
                console.log('âš ï¸ æ—§çš„ç»Ÿä¸€æ¢å¤æœºåˆ¶å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨ç®€åŒ–ç‰ˆæ¢å¤ç³»ç»Ÿ');
                // åŠŸèƒ½å·²è½¬ç§»åˆ° /static/js/simple_recovery.js
            }
            
            // ğŸ”‘ ä½¿ç”¨æ–°çš„ç®€åŒ–ç‰ˆæ¢å¤ç³»ç»Ÿï¼Œæ›¿ä»£å¤æ‚çš„ç»Ÿä¸€æ¢å¤æœºåˆ¶
            // setTimeout(startUnifiedPrescriptionRecovery, 3000);
            console.log('ğŸ”„ å°†ä½¿ç”¨ç®€åŒ–ç‰ˆå¤„æ–¹æ¢å¤ç³»ç»Ÿ...');
            
            // ğŸ”— æ·»åŠ é¡µé¢çº§ç”¨æˆ·ç®¡ç†æ§åˆ¶
            addUserManagementControls();
            
            // æ·»åŠ è°ƒè¯•åŠŸèƒ½ï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒæˆ–ç‰¹å®šæ¡ä»¶ä¸‹ï¼‰
            if (isDebugMode()) {
                console.log('ğŸ”§ è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
                console.log('ğŸ“‹ å¯ç”¨è°ƒè¯•å‘½ä»¤:');
                console.log('  - diagnoseHistoryIssues(): è¯Šæ–­å†å²è®°å½•é—®é¢˜');
                console.log('  - checkLocalStorageUsage(): æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ');
                console.log('  - cleanOldHistoryRecords(): æ¸…ç†æ—§çš„å†å²è®°å½•');
                console.log('  - clearCurrentUserData(): æ¸…ç†å½“å‰ç”¨æˆ·æ•°æ®');
                console.log('  - switchUserContext(): åˆ‡æ¢ç”¨æˆ·ä¸Šä¸‹æ–‡');
                
                // å°†è°ƒè¯•å‡½æ•°æš´éœ²åˆ°å…¨å±€
                window.diagnoseHistoryIssues = diagnoseHistoryIssues;
                window.checkLocalStorageUsage = checkLocalStorageUsage;
                window.cleanOldHistoryRecords = cleanOldHistoryRecords;
                
                // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œä¸€æ¬¡è¯Šæ–­
                setTimeout(() => {
                    console.log('\nğŸ” è‡ªåŠ¨å†å²è®°å½•è¯Šæ–­:');
                    diagnoseHistoryIssues();
                }, 1000);
            }
        }
        
        // è®¾ç½®é»˜è®¤åŒ»ç”Ÿï¼ˆä¸ä¼šæœ‰ç¡®è®¤æç¤ºï¼‰
        function setDefaultDoctor(doctorKey, skipHistoryLoad = false) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // æ›´æ–°UIæ˜¾ç¤º
            const cards = document.querySelectorAll('.doctor-card');
            cards.forEach((card, index) => {
                if (Object.keys(doctors)[index] === doctorKey) {
                    card.classList.add('selected');
                }
            });
            
            // æ›´æ–°é¡¶éƒ¨åŒ»ç”Ÿä¿¡æ¯æ¡
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `æ“…é•¿ï¼š${doctor.specialty}`;
            
            // ğŸ”§ ä¿®å¤é‡å¤åŠ è½½é—®é¢˜ï¼šåªåœ¨éè·³è¿‡æ¨¡å¼ä¸‹åŠ è½½å†å²è®°å½•
            if (!skipHistoryLoad) {
                loadDoctorHistory(doctorKey);
            }
        }

        // ç”Ÿæˆå¯¹è¯ID - åŸºäºç”¨æˆ·IDéš”ç¦»
        function generateConversationId() {
            const userId = getCurrentUserId();
            
            currentConversationId = 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            
            // ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºå­˜å‚¨keyï¼Œç¡®ä¿ä¸åŒç”¨æˆ·éš”ç¦»
            const storageKey = `conversationId_${userId}`;
            localStorage.setItem(storageKey, currentConversationId);
        }
        
        // è·å–å½“å‰ç”¨æˆ·ID
        function getCurrentUserId() {
            // ğŸš¨ é‡è¦ï¼šæ™ºèƒ½å·¥ä½œæµé¡µé¢(index_smart_workflow.html)åªä½¿ç”¨ç™»å½•ç”¨æˆ·æ•°æ®
            // è¿™ç¡®ä¿ä¸æ¸¸å®¢é¡µé¢çš„æ•°æ®å®Œå…¨éš”ç¦»
            
            // ğŸ”‘ æ–°å¢ï¼šæ£€æŸ¥URLå‚æ•°ä¸­çš„ç”¨æˆ·IDï¼ˆä»å†å²é¡µé¢è·³è½¬ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            if (urlUserId && urlUserId !== 'anonymous') {
                console.log('ğŸ”— ä»URLå‚æ•°è·å–ç”¨æˆ·ID:', urlUserId);
                // å°†URLç”¨æˆ·IDå­˜å‚¨åˆ°localStorageï¼Œç¡®ä¿åç»­ä½¿ç”¨
                localStorage.setItem('currentUserId', urlUserId);
                // æ¸…ç†URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤å¤„ç†
                if (window.history && window.history.replaceState) {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
                return urlUserId;
            }
            
            // ğŸ”‘ ä¼˜å…ˆä½¿ç”¨çœŸå®ç™»å½•ç”¨æˆ·ä¿¡æ¯ - æ£€æŸ¥å¤šä¸ªå­˜å‚¨ä½ç½®
            let realUser = null;
            
            // ğŸ”‘ ä¿®å¤ï¼šä¼˜å…ˆæ£€æŸ¥currentUserå­˜å‚¨ï¼ˆæ›´å¯é ï¼‰
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.id || currentUser.user_id || currentUser.global_user_id) {
                // è¿‡æ»¤æ‰ä¸´æ—¶ç”¨æˆ·IDï¼Œåªä½¿ç”¨çœŸå®ç™»å½•ç”¨æˆ·
                const userId = currentUser.global_user_id || currentUser.user_id || currentUser.id;
                if (userId && !userId.startsWith('temp_user_') && !userId.startsWith('smart_user_') && userId !== 'anonymous') {
                    realUser = currentUser;
                    console.log('ğŸ”‘ ä»currentUserè·å–çœŸå®ç”¨æˆ·:', realUser);
                }
            }
            
            // æ£€æŸ¥userDataå­˜å‚¨ï¼ˆå¤‡é€‰ï¼‰
            if (!realUser) {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.id || userData.user_id || userData.global_user_id) {
                    const userId = userData.global_user_id || userData.user_id || userData.id;
                    if (userId && userId !== 'anonymous') {
                        realUser = userData;
                        console.log('ğŸ”‘ ä»userDataè·å–çœŸå®ç”¨æˆ·:', realUser);
                    }
                }
            }
            
            // å¦‚æœæ‰¾åˆ°çœŸå®ç”¨æˆ·
            if (realUser) {
                // ğŸ”‘ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨global_user_idï¼Œç„¶åæ˜¯user_idï¼Œæœ€åæ˜¯id
                const userId = realUser.global_user_id || realUser.user_id || realUser.id;
                if (userId && userId !== 'undefined' && userId !== null) {
                    console.log('ğŸ”‘ ä½¿ç”¨çœŸå®ç™»å½•ç”¨æˆ·ID:', userId);
                    return userId; // ç›´æ¥è¿”å›ç”¨æˆ·IDï¼Œä¸åŠ å‰ç¼€é¿å…æ··æ·†
                }
            }
            
            // âš ï¸ è®¿å®¢æ¨¡å¼ - æ™ºèƒ½å·¥ä½œæµç¨‹é¡µé¢çš„ä¸´æ—¶ç”¨æˆ·ID
            const smartUser = localStorage.getItem('currentUserId');
            if (smartUser) {
                console.log('ğŸ”„ ä½¿ç”¨å·²æœ‰ä¸´æ—¶è®¿å®¢ç”¨æˆ·ID:', smartUser);
                return smartUser; // å·²æœ‰smart_user_å‰ç¼€
            }
            
            // ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¯¹è¯IDç›¸å…³çš„ç”¨æˆ·ä¿¡æ¯
            // å¦‚æœç”¨æˆ·ä¹‹å‰è¿›è¡Œè¿‡é—®è¯Šï¼Œå°è¯•ä»å¯¹è¯IDä¸­æ¢å¤ç”¨æˆ·ID
            const allStorageKeys = Object.keys(localStorage);
            const conversationKeys = allStorageKeys.filter(key => key.startsWith('conversationId_'));
            
            if (conversationKeys.length > 0) {
                // ä»å¯¹è¯ID keyä¸­æå–ç”¨æˆ·IDï¼ˆæ ¼å¼ï¼šconversationId_{userId}ï¼‰
                const existingUserId = conversationKeys[0].replace('conversationId_', '');
                console.log('ğŸ”„ ä»å¯¹è¯IDæ¢å¤ç”¨æˆ·ID:', existingUserId);
                localStorage.setItem('currentUserId', existingUserId);
                return existingUserId;
            }
            
            // ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥å†å²è®°å½•é”®ï¼Œå°è¯•æ¢å¤ç”¨æˆ·ID
            const historyKeys = allStorageKeys.filter(key => key.startsWith('tcm_doctor_history_'));
            if (historyKeys.length > 0) {
                // ä»å†å²è®°å½•keyä¸­æå–ç”¨æˆ·IDï¼ˆæ ¼å¼ï¼štcm_doctor_history_{userId}_{doctorId}ï¼‰
                const historyKey = historyKeys[0];
                const parts = historyKey.split('_');
                if (parts.length >= 4) {
                    const existingUserId = parts.slice(3, -1).join('_'); // å¤„ç†ç”¨æˆ·IDä¸­å¯èƒ½åŒ…å«ä¸‹åˆ’çº¿çš„æƒ…å†µ
                    console.log('ğŸ”„ ä»å†å²è®°å½•æ¢å¤ç”¨æˆ·ID:', existingUserId);
                    localStorage.setItem('currentUserId', existingUserId);
                    return existingUserId;
                }
            }
            
            // ğŸ†• ç”Ÿæˆæ–°çš„è®¿å®¢ç”¨æˆ·IDï¼ˆåªæœ‰åœ¨å®Œå…¨æ²¡æœ‰å†å²è®°å½•æ—¶ï¼‰
            const newSmartId = 'smart_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('currentUserId', newSmartId);
            console.log('ğŸ†• ç”Ÿæˆå…¨æ–°è®¿å®¢ç”¨æˆ·ID:', newSmartId);
            return newSmartId;
        }

        /**
         * ğŸ§¹ æ¸…ç†å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºç™»å‡ºï¼‰
         */
        function clearCurrentUserData() {
            try {
                const currentUserId = getCurrentUserId();
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†ç”¨æˆ·æ•°æ®ï¼Œç”¨æˆ·ID:', currentUserId);
                
                // 1. æ¸…ç†å½“å‰ç”¨æˆ·çš„æ‰€æœ‰å†å²è®°å½•
                const keys = Object.keys(localStorage);
                const userHistoryKeys = keys.filter(key => 
                    key.includes(`_${currentUserId}_`) || 
                    key.endsWith(`_${currentUserId}`)
                );
                
                let cleanedCount = 0;
                userHistoryKeys.forEach(key => {
                    localStorage.removeItem(key);
                    cleanedCount++;
                    console.log('ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·æ•°æ®:', key);
                });
                
                // 2. æ¸…ç†ç”¨æˆ·è®¤è¯ä¿¡æ¯
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userToken');
                localStorage.removeItem('currentUserId');
                
                // 3. é‡ç½®å…¨å±€å˜é‡
                window.currentUser = null;
                window.userToken = null;
                window.currentConversationId = null;
                window.selectedDoctor = null;
                
                // 4. æ¸…ç†UIçŠ¶æ€
                clearAllMessages();
                resetDoctorSelection();
                
                console.log(`âœ… ç”¨æˆ·æ•°æ®æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤ ${cleanedCount} é¡¹æ•°æ®`);
                return cleanedCount;
                
            } catch (error) {
                console.error('âŒ æ¸…ç†ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                return 0;
            }
        }

        /**
         * ğŸ”„ åˆ‡æ¢ç”¨æˆ·æ—¶çš„æ•°æ®éš”ç¦»å¤„ç†
         */
        function switchUserContext() {
            try {
                // æ¸…ç†ä¹‹å‰ç”¨æˆ·çš„UIçŠ¶æ€
                clearAllMessages();
                resetDoctorSelection();
                
                // é‡æ–°åˆå§‹åŒ–æ–°ç”¨æˆ·çš„çŠ¶æ€
                const newUserId = getCurrentUserId();
                console.log('ğŸ”„ åˆ‡æ¢åˆ°ç”¨æˆ·ä¸Šä¸‹æ–‡:', newUserId);
                
                // åŠ è½½æ–°ç”¨æˆ·çš„å†å²è®°å½•
                setTimeout(() => {
                    loadUserHistoryForAllDoctors();
                }, 100);
                
            } catch (error) {
                console.error('âŒ åˆ‡æ¢ç”¨æˆ·ä¸Šä¸‹æ–‡å¤±è´¥:', error);
            }
        }

        /**
         * ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰æ¶ˆæ¯
         */
        function clearAllMessages() {
            const containers = ['messagesContainer', 'mobileMessagesContainer'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    console.log('ğŸ—‘ï¸ æ¸…ç†æ¶ˆæ¯å®¹å™¨:', containerId);
                }
            });
        }

        /**
         * ğŸ”„ é‡ç½®åŒ»ç”Ÿé€‰æ‹©çŠ¶æ€
         */
        function resetDoctorSelection() {
            window.selectedDoctor = null;
            
            // é‡ç½®åŒ»ç”Ÿé€‰æ‹©UI
            const doctorCards = document.querySelectorAll('.doctor-card');
            doctorCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            // é‡ç½®æ‰‹æœºç‰ˆåŒ»ç”Ÿé€‰æ‹©
            const mobileDoctorSelect = document.getElementById('mobileDoctorSelect');
            if (mobileDoctorSelect) {
                mobileDoctorSelect.value = '';
            }
            
            console.log('ğŸ”„ åŒ»ç”Ÿé€‰æ‹©çŠ¶æ€å·²é‡ç½®');
        }

        /**
         * ä¿å­˜å¯¹è¯åˆ°æœåŠ¡å™¨æ•°æ®åº“
         */
        async function saveConversationToServer(messages, doctorId) {
            // åªä¸ºå·²ç™»å½•ç”¨æˆ·ä¿å­˜åˆ°æœåŠ¡å™¨
            if (!currentUser || !userToken) {
                console.log('ğŸ“ è®¿å®¢ç”¨æˆ·ï¼Œè·³è¿‡æœåŠ¡å™¨ä¿å­˜');
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸´æ—¶ç”¨æˆ·ID
                if (userId && (userId.startsWith('temp_user_') || userId.startsWith('smart_user_') || userId.startsWith('guest_'))) {
                    console.log('ğŸ“ ä¸´æ—¶ç”¨æˆ·ï¼Œè·³è¿‡æœåŠ¡å™¨ä¿å­˜');
                    return;
                }
                
                // æå–ä¸»è¦ç—‡çŠ¶ï¼ˆä»ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼‰
                const firstUserMessage = messages.find(msg => msg.type === 'user');
                const chiefComplaint = firstUserMessage ? firstUserMessage.content.substring(0, 100) : 'é—®è¯Šå’¨è¯¢';
                
                // æ„å»ºæœåŠ¡å™¨ä¿å­˜çš„æ•°æ®
                const serverData = {
                    consultation_id: currentConversationId,
                    patient_id: userId,
                    doctor_id: doctorId,
                    conversation_log: JSON.stringify(messages),
                    status: 'completed',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const response = await fetch('/api/consultation/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(serverData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('âœ… å¯¹è¯å·²ä¿å­˜åˆ°æœåŠ¡å™¨æ•°æ®åº“:', currentConversationId);
                        console.log('ğŸ“Š ä¿å­˜è¯¦æƒ…:', {
                            consultation_id: serverData.consultation_id,
                            patient_id: serverData.patient_id,
                            doctor_id: serverData.doctor_id,
                            message_count: serverData.message_count
                        });
                    } else {
                        console.warn('âš ï¸ æœåŠ¡å™¨ä¿å­˜å“åº”å¼‚å¸¸:', result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.warn('âš ï¸ æœåŠ¡å™¨ä¿å­˜å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status, 'é”™è¯¯:', errorText);
                }
                
            } catch (error) {
                console.error('âŒ ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥:', error);
                // ä¸å½±å“æ­£å¸¸æµç¨‹ï¼Œåªè®°å½•é”™è¯¯
            }
        }

        /**
         * ğŸ” æ£€æµ‹ç”¨æˆ·çŠ¶æ€å˜åŒ–
         */
        function detectUserChange() {
            const currentStoredUser = localStorage.getItem('currentUser');
            const lastKnownUser = window.lastKnownUser || null;
            
            if (currentStoredUser !== lastKnownUser) {
                console.log('ğŸ” æ£€æµ‹åˆ°ç”¨æˆ·çŠ¶æ€å˜åŒ–');
                console.log('ä¹‹å‰ç”¨æˆ·:', lastKnownUser);
                console.log('å½“å‰ç”¨æˆ·:', currentStoredUser);
                
                window.lastKnownUser = currentStoredUser;
                
                // ç”¨æˆ·çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œæ‰§è¡Œåˆ‡æ¢å¤„ç†
                handleUserSwitch();
                return true;
            }
            
            return false;
        }

        /**
         * ğŸ”„ å¤„ç†ç”¨æˆ·åˆ‡æ¢
         */
        function handleUserSwitch() {
            console.log('ğŸ”„ å¼€å§‹å¤„ç†ç”¨æˆ·åˆ‡æ¢...');
            
            // 1. æ¸…ç†å½“å‰é¡µé¢çŠ¶æ€
            clearAllMessages();
            resetDoctorSelection();
            
            // 2. æ¸…ç†æ—§ç”¨æˆ·çš„ä¼šè¯æ•°æ®
            clearCurrentUserData();
            
            // 3. é‡æ–°åˆå§‹åŒ–å½“å‰ç”¨æˆ·
            const newUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (newUser.id || newUser.user_id) {
                currentUser = newUser;
                console.log('ğŸ”‘ åˆ‡æ¢åˆ°è®¤è¯ç”¨æˆ·:', newUser.username || newUser.display_name);
                
                // 4. é‡æ–°åŠ è½½è¯¥ç”¨æˆ·çš„æ•°æ®
                loadConversationHistory();
                updateUserInterface(true);
            } else {
                console.log('âš ï¸ åˆ‡æ¢åˆ°è®¿å®¢æ¨¡å¼');
                currentUser = null;
                userToken = null;
                updateUserInterface(false);
            }
            
            // 5. æ˜¾ç¤ºåˆ‡æ¢é€šçŸ¥
            showMessage('ç”¨æˆ·èº«ä»½å·²æ›´æ–°', 'info');
        }

        /**
         * ğŸ§¹ æ¸…ç†å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®
         */
        function clearCurrentUserData() {
            try {
                const currentUserId = getCurrentUserId();
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†ç”¨æˆ·æ•°æ®ï¼Œç”¨æˆ·ID:', currentUserId);
                
                // 1. æ¸…ç†å½“å‰ç”¨æˆ·çš„æ‰€æœ‰å†å²è®°å½•
                const keys = Object.keys(localStorage);
                const userHistoryKeys = keys.filter(key => 
                    key.includes(`_${currentUserId}_`) || 
                    key.endsWith(`_${currentUserId}`) ||
                    key.startsWith(`tcm_doctor_history_${currentUserId}`) ||
                    key.startsWith(`conversationId_${currentUserId}`)
                );
                
                let cleanedCount = 0;
                userHistoryKeys.forEach(key => {
                    localStorage.removeItem(key);
                    cleanedCount++;
                    console.log('ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·æ•°æ®:', key);
                });
                
                // 2. é‡ç½®å…¨å±€å˜é‡
                window.currentConversationId = null;
                window.selectedDoctor = null;
                
                // 3. æ¸…ç†UIçŠ¶æ€
                clearAllMessages();
                resetDoctorSelection();
                
                console.log(`âœ… ç”¨æˆ·æ•°æ®æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤ ${cleanedCount} é¡¹æ•°æ®`);
                return cleanedCount;
            } catch (error) {
                console.error('âŒ ç”¨æˆ·æ•°æ®æ¸…ç†å¤±è´¥:', error);
                return 0;
            }
        }

        /**
         * ğŸ§¹ æ¸…ç†æ—§ç”¨æˆ·æ•°æ®ï¼ˆé˜²æ­¢æ•°æ®æ³„éœ²ï¼‰
         */
        function cleanupOldUserData() {
            const currentUserId = getCurrentUserId();
            const keys = Object.keys(localStorage);
            
            // æŸ¥æ‰¾å…¶ä»–ç”¨æˆ·çš„æ•°æ®
            const otherUserKeys = keys.filter(key => 
                (key.includes('real_user_') || key.includes('smart_user_') || key.includes('usr_')) && 
                !key.includes(currentUserId)
            );
            
            if (otherUserKeys.length > 0) {
                console.log('ğŸ§¹ æ¸…ç†å…¶ä»–ç”¨æˆ·çš„é—ç•™æ•°æ®:', otherUserKeys.length, 'é¡¹');
                otherUserKeys.forEach(key => {
                    localStorage.removeItem(key);
                    console.log('ğŸ—‘ï¸ åˆ é™¤é—ç•™æ•°æ®:', key);
                });
            }
        }

        /**
         * ğŸ”„ åˆ‡æ¢ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆä¾›è°ƒè¯•ä½¿ç”¨ï¼‰
         */
        function switchUserContext() {
            handleUserSwitch();
            updateCurrentUserDisplay();
            return true;
        }

        /**
         * ğŸ”— æ·»åŠ é¡µé¢çº§ç”¨æˆ·ç®¡ç†æ§åˆ¶
         */
        function addUserManagementControls() {
            // åªåœ¨è°ƒè¯•æ¨¡å¼æˆ–ç‰¹å®šæƒ…å†µä¸‹æ˜¾ç¤º
            if (!isDebugMode()) return;
            
            const controlsHTML = `
                <div id="userManagementPanel" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; z-index: 9999; font-size: 12px; max-width: 200px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</div>
                    <div id="currentUserDisplay" style="margin-bottom: 8px; font-size: 11px;"></div>
                    <button onclick="testUserDataIsolation()" style="width: 100%; margin-bottom: 4px; padding: 4px; font-size: 11px;">ğŸ” æµ‹è¯•æ•°æ®éš”ç¦»</button>
                    <button onclick="clearCurrentUserData() && showMessage('ç”¨æˆ·æ•°æ®å·²æ¸…ç†', 'success')" style="width: 100%; margin-bottom: 4px; padding: 4px; font-size: 11px;">ğŸ§¹ æ¸…ç†å½“å‰ç”¨æˆ·</button>
                    <button onclick="switchUserContext() && showMessage('ç”¨æˆ·ä¸Šä¸‹æ–‡å·²åˆ‡æ¢', 'info')" style="width: 100%; padding: 4px; font-size: 11px;">ğŸ”„ åˆ‡æ¢ç”¨æˆ·ä¸Šä¸‹æ–‡</button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', controlsHTML);
            updateCurrentUserDisplay();
            
            // æ¯5ç§’æ›´æ–°ä¸€æ¬¡ç”¨æˆ·æ˜¾ç¤º
            setInterval(updateCurrentUserDisplay, 5000);
        }

        /**
         * ğŸ”„ æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
         */
        function updateCurrentUserDisplay() {
            const display = document.getElementById('currentUserDisplay');
            if (!display) return;
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const currentUserId = getCurrentUserId();
            
            if (currentUser.id || currentUser.user_id) {
                display.innerHTML = `ğŸ”‘ çœŸå®ç”¨æˆ·<br>${currentUser.username || currentUser.name || 'N/A'}<br>ID: ${currentUserId}`;
            } else {
                display.innerHTML = `ğŸ‘¤ è®¿å®¢ç”¨æˆ·<br>ID: ${currentUserId}`;
            }
        }

        

        /**
         * ğŸ§ª æµ‹è¯•ç”¨æˆ·æ•°æ®éš”ç¦»
         */
        function testUserDataIsolation() {
            console.log('ğŸ§ª å¼€å§‹ç”¨æˆ·æ•°æ®éš”ç¦»æµ‹è¯•');
            
            const currentUserId = getCurrentUserId();
            const allKeys = Object.keys(localStorage);
            
            console.log('å½“å‰ç”¨æˆ·ID:', currentUserId);
            console.log('localStorageæ€»é”®æ•°:', allKeys.length);
            
            // æŸ¥æ‰¾å½“å‰ç”¨æˆ·ç›¸å…³çš„æ•°æ®
            const userKeys = allKeys.filter(key => 
                key.includes(currentUserId) ||
                key.includes('currentUser') ||
                key.includes('userToken') ||
                key.includes('currentUserId')
            );
            
            console.log('å½“å‰ç”¨æˆ·ç›¸å…³æ•°æ®é”®:', userKeys);
            
            // æŸ¥æ‰¾å…¶ä»–ç”¨æˆ·çš„æ•°æ®ï¼ˆæ³„éœ²æ£€æµ‹ï¼‰
            const otherUserKeys = allKeys.filter(key => 
                (key.includes('real_user_') || key.includes('smart_user_')) && 
                !key.includes(currentUserId)
            );
            
            console.log('å…¶ä»–ç”¨æˆ·æ•°æ®é”®ï¼ˆæ•°æ®æ³„éœ²æ£€æµ‹ï¼‰:', otherUserKeys);
            
            if (otherUserKeys.length > 0) {
                console.warn('âš ï¸ æ£€æµ‹åˆ°å…¶ä»–ç”¨æˆ·æ•°æ®ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®æ³„éœ²');
                showMessage(`è­¦å‘Šï¼šæ£€æµ‹åˆ°${otherUserKeys.length}ä¸ªå…¶ä»–ç”¨æˆ·æ•°æ®é¡¹`, 'warning');
            } else {
                console.log('âœ… æ•°æ®éš”ç¦»æ­£å¸¸');
                showMessage('æ•°æ®éš”ç¦»æµ‹è¯•é€šè¿‡', 'success');
            }
            
            return {
                currentUserId,
                userKeys: userKeys.length,
                otherUserKeys: otherUserKeys.length,
                isolated: otherUserKeys.length === 0
            };
        }

        // å…¨å±€å˜é‡ï¼šæ¨èåŒ»ç”Ÿåˆ—è¡¨ - AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤
        // let recommendedDoctors = [];
        // let isUsingRecommendedDoctors = false;

        // è·å–AIæ¨èåŒ»ç”Ÿ - AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤
        // async function getRecommendedDoctors(symptoms) {
        //     // AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤ï¼Œè¿”å›ç©ºæ•°ç»„
        //     return [];
        // }

        // æ¸²æŸ“åŒ»ç”Ÿå¡ç‰‡ - å·²ç®€åŒ–ï¼Œç§»é™¤AIæ¨èåŠŸèƒ½
        function renderDoctorCards() {
            const container = document.getElementById('doctorsGrid');
            container.innerHTML = '';
            
            // ç›´æ¥ä½¿ç”¨é»˜è®¤åŒ»ç”Ÿåˆ—è¡¨
            Object.entries(doctors).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'doctor-card';
                card.onclick = () => selectDoctor(key, doctor);
                
                card.innerHTML = `
                    <div class="doctor-header">
                        <div class="doctor-info">
                            <div class="doctor-avatar">${doctor.avatar}</div>
                            <div class="doctor-details">
                                <h3>${doctor.name}</h3>
                                <span class="doctor-school">${doctor.school}</span>
                            </div>
                        </div>
                        <div class="selection-indicator">
                            <span style="font-size: 12px;">âœ“</span>
                        </div>
                    </div>
                    <div class="doctor-specialty">
                        <strong>æ“…é•¿ï¼š</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // ä¸ºåŒ»ç”Ÿåˆ†é…å¤´åƒ
        function getAvatarForDoctor(doctorName) {
            const avatarMap = {
                'å¼ ä»²æ™¯': 'ğŸ¯',
                'é‡‘å¤§å¤«': 'ğŸ¯',  // é‡‘å¤§å¤«ä½¿ç”¨å¼ ä»²æ™¯çš„å¤´åƒ
                'å¶å¤©å£«': 'ğŸŒ¡ï¸', 
                'æä¸œå£': 'ğŸŒ±',
                'éƒ‘é’¦å®‰': 'ğŸ”¥',
                'åˆ˜æ¸¡èˆŸ': 'âš–ï¸'
            };
            return avatarMap[doctorName] || 'ğŸ‘¨â€âš•ï¸';
        }
        
        // æ›´æ–°åŒ»ç”Ÿé€‰æ‹©å™¨ï¼ˆåœ¨åŒ»ç”Ÿæ•°æ®åŠ è½½åè°ƒç”¨ï¼‰
        function updateDoctorSelector() {
            // æ›´æ–°å½“å‰åŒ»ç”Ÿæ˜¾ç¤º
            const currentDoctorDesc = document.getElementById('currentDoctorDesc');
            if (currentDoctorDesc && selectedDoctor && doctors[selectedDoctor]) {
                currentDoctorDesc.textContent = `å½“å‰åŒ»å¸ˆï¼š${doctors[selectedDoctor].name}`;
            }
            
            // ç¡®ä¿ç¬¬ä¸€ä¸ªåŒ»ç”Ÿè¢«è®¾ä¸ºé»˜è®¤
            if (Object.keys(doctors).length > 0 && !selectedDoctor) {
                const firstDoctorKey = Object.keys(doctors)[0];
                selectedDoctor = firstDoctorKey;
            }
            
            // ğŸ”‘ ä¿®å¤ï¼šæ›´æ–°ç§»åŠ¨ç«¯åŒ»ç”Ÿæ˜¾ç¤º
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                renderMobileDoctorCards();
                
                // æ›´æ–°ç§»åŠ¨ç«¯å½“å‰åŒ»ç”Ÿä¿¡æ¯
                if (selectedDoctor && doctors[selectedDoctor]) {
                    const doctor = doctors[selectedDoctor];
                    const mobileDoctorAvatar = document.getElementById('mobileDoctorAvatar');
                    const mobileDoctorName = document.getElementById('mobileDoctorName');
                    const mobileDoctorDesc = document.getElementById('mobileDoctorDesc');
                    
                    if (mobileDoctorAvatar) mobileDoctorAvatar.textContent = doctor.avatar;
                    if (mobileDoctorName) mobileDoctorName.textContent = doctor.name;
                    if (mobileDoctorDesc) mobileDoctorDesc.textContent = doctor.school;
                }
            }
        }

        // æ·»åŠ åŒ»ç”Ÿåˆ‡æ¢æŒ‰é’® - AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤
        // function addDoctorToggleButton(container) {
        //     // AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤ï¼Œä¸å†éœ€è¦åˆ‡æ¢æŒ‰é’®
        // }

        // æ™ºèƒ½æ¨èåŒ»ç”Ÿï¼ˆåŸºäºç”¨æˆ·è¾“å…¥çš„ç—‡çŠ¶ï¼‰- AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤
        // async function recommendDoctorsForSymptoms(userInput) {
        //     // AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤ï¼Œä¸å†å¤„ç†ç—‡çŠ¶æ¨è
        // }

        // ä»æ–‡æœ¬ä¸­æå–ç—‡çŠ¶å…³é”®è¯
        function extractSymptomsFromText(text) {
            const symptomKeywords = [
                'å¤´ç—›', 'å¤´ç–¼', 'å¤´æ™•', 'çœ©æ™•', 'å¤±çœ ', 'ç„¦è™‘', 'æŠ‘éƒ', 'å¿ƒæ‚¸', 'èƒ¸é—·', 'ä¹åŠ›', 'å‘çƒ­',
                'èƒƒç—›', 'èƒƒç–¼', 'è‚šå­ç–¼', 'è‚šå­ç—›', 'è…¹ç—›', 'è…¹èƒ€', 'è…¹æ³»', 'ä¾¿ç§˜', 'é£Ÿæ¬²ä¸æŒ¯', 'æ¶ˆåŒ–ä¸è‰¯', 
                'å’³å—½', 'å“®å–˜', 'é¼»ç‚', 'æ°”å–˜', 'æ„Ÿå†’', 'å‘çƒ§', 'å–‰å’™ç—›', 'å’½ç—›', 'æµé¼»æ¶•',
                'æœˆç»ä¸è°ƒ', 'ç—›ç»', 'ç™½å¸¦å¼‚å¸¸', 'ä¸å­•', 'æ›´å¹´æœŸ', 'å¦‡ç§‘', 'å°å„¿å‘çƒ­', 'å°å„¿å’³å—½', 'å°å„¿è…¹æ³»',
                'æ¹¿ç–¹', 'ç—¤ç–®', 'çš®è‚¤ç—…', 'é’æ˜¥ç—˜', 'è…°ç—›', 'å…³èŠ‚ç—›', 'é¢ˆæ¤ç—…', 'è†ç›–ç—›', 'è€³é¸£', 'å¬åŠ›ä¸‹é™', 'é¼»å¡',
                'ç‰™ç—›', 'å£è…”æºƒç–¡', 'ä¾¿è¡€', 'å°¿é¢‘', 'å°¿æ€¥', 'æ°´è‚¿', 'å‡ºæ±—', 'ç›—æ±—', 'æ‰‹è„šå†°å‡‰', 'å››è‚¢æ— åŠ›'
            ];
            
            const foundSymptoms = [];
            for (const symptom of symptomKeywords) {
                if (text.includes(symptom)) {
                    foundSymptoms.push(symptom);
                }
            }
            return foundSymptoms;
        }
        
        // ç—‡çŠ¶åŒä¹‰è¯æ˜ å°„
        function getSymptomSynonyms() {
            return {
                'è…¹ç—›': ['è‚šå­ç–¼', 'è‚šå­ç—›', 'è…¹éƒ¨ç–¼ç—›', 'è…¹éƒ¨ä¸é€‚'],
                'è‚šå­ç–¼': ['è…¹ç—›', 'è‚šå­ç—›', 'è…¹éƒ¨ç–¼ç—›'],
                'å¤´ç—›': ['å¤´ç–¼', 'å¤´éƒ¨ç–¼ç—›'],
                'èƒƒç—›': ['èƒƒç–¼', 'èƒƒéƒ¨ç–¼ç—›', 'èƒƒä¸èˆ’æœ'],
                'å‘çƒ­': ['å‘çƒ§', 'ä½“æ¸©å‡é«˜'],
                'å’½ç—›': ['å–‰å’™ç—›', 'å’½å–‰ç–¼ç—›']
            };
        }
        
        // æ£€æŸ¥ç—‡çŠ¶æ˜¯å¦ç›¸å…³ï¼ˆè€ƒè™‘åŒä¹‰è¯å’ŒåŒ»å­¦å…³è”ï¼‰
        function isSymptomsRelated(userSymptoms, aiSymptom) {
            const synonyms = getSymptomSynonyms();
            
            // ç›´æ¥åŒ¹é…
            if (userSymptoms.includes(aiSymptom)) {
                return true;
            }
            
            // åŒä¹‰è¯æ£€æŸ¥
            for (const userSymptom of userSymptoms) {
                if (synonyms[userSymptom] && synonyms[userSymptom].includes(aiSymptom)) {
                    return true;
                }
                if (synonyms[aiSymptom] && synonyms[aiSymptom].includes(userSymptom)) {
                    return true;
                }
            }
            
            // åŒ»å­¦å…³è”æ€§æ£€æŸ¥ï¼ˆå¸¸è§çš„ç—‡çŠ¶ç»„åˆï¼‰
            const medicalAssociations = {
                'è…¹ç—›': ['è…¹æ³»', 'ä¾¿ç§˜', 'é£Ÿæ¬²ä¸æŒ¯', 'è…¹èƒ€'],
                'è‚šå­ç–¼': ['è…¹æ³»', 'ä¾¿ç§˜', 'é£Ÿæ¬²ä¸æŒ¯', 'è…¹èƒ€'],
                'å¤´ç—›': ['å¤´æ™•', 'çœ©æ™•', 'å¤±çœ '],
                'å‘çƒ­': ['ä¹åŠ›', 'å‡ºæ±—'],
                'æ„Ÿå†’': ['å’³å—½', 'æµé¼»æ¶•', 'é¼»å¡', 'å–‰å’™ç—›']
            };
            
            for (const userSymptom of userSymptoms) {
                if (medicalAssociations[userSymptom] && medicalAssociations[userSymptom].includes(aiSymptom)) {
                    return true;
                }
            }
            
            return false;
        }

        // é€‰æ‹©åŒ»ç”Ÿï¼ˆæ”¯æŒé»˜è®¤åŒ»ç”Ÿå’Œæ¨èåŒ»ç”Ÿï¼‰
        function selectDoctor(doctorKey, doctorData = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            // æ£€æŸ¥æ˜¯å¦æœ‰çœŸæ­£çš„å¯¹è¯å†…å®¹ï¼ˆç”¨æˆ·æ¶ˆæ¯æˆ–AIå›å¤ï¼‰
            const userMessages = messagesContainer.querySelectorAll('.message.user');
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            const hasExistingMessages = userMessages.length > 0 || aiMessages.length > 0;
            
            // åˆ‡æ¢åŒ»ç”Ÿæ—¶ä¿å­˜å½“å‰åŒ»ç”Ÿçš„å¯¹è¯å†å²ï¼Œä¸å†æ¸…ç©ºå†å²è®°å½•
            if (selectedDoctor && selectedDoctor !== doctorKey && hasExistingMessages) {
                // ä¿å­˜å½“å‰åŒ»ç”Ÿçš„å¯¹è¯å†å²
                saveCurrentDoctorHistory();
            }
            
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });

            // æ·»åŠ æ–°çš„é€‰ä¸­çŠ¶æ€
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }

            const previousDoctor = selectedDoctor;
            selectedDoctor = doctorKey;
            
            // è·å–åŒ»ç”Ÿä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„doctorDataï¼Œç„¶åæ˜¯é»˜è®¤doctorså¯¹è±¡ï¼‰
            const doctor = doctorData || doctors[doctorKey] || {
                name: 'åŒ»ç”Ÿ',
                school: 'ä¸­åŒ»å¸ˆ', 
                avatar: 'ğŸ‘¨â€âš•ï¸',
                specialty: 'ä¸­åŒ»å†…ç§‘'
            };

            // æ›´æ–°é¡¶éƒ¨åŒ»ç”Ÿä¿¡æ¯æ¡
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `æ“…é•¿ï¼š${doctor.specialty}`;

            // åˆ‡æ¢åŒ»ç”Ÿæ—¶ç”Ÿæˆæ–°çš„å¯¹è¯IDï¼Œç¡®ä¿AIèº«ä»½æ­£ç¡®åˆ‡æ¢
            if (previousDoctor && previousDoctor !== doctorKey) {
                // ç”Ÿæˆæ–°çš„å¯¹è¯IDï¼Œå¼ºåˆ¶å¼€å§‹æ–°å¯¹è¯
                generateConversationId();
            }
            
            // åŠ è½½å½“å‰åŒ»ç”Ÿçš„å¯¹è¯å†å²ï¼Œä¸æ¸…ç©ºå†å²è®°å½•
            if (!previousDoctor || previousDoctor !== doctorKey) {
                // åŠ è½½è¯¥åŒ»ç”Ÿçš„å†å²å¯¹è¯
                loadDoctorHistory(doctorKey);
            }
            
            // æ˜¾ç¤ºè¾“å…¥æ¡†
            const inputContainer = document.querySelector('.input-container');
            if (inputContainer) {
                inputContainer.classList.add('show');
            }
            
            // ç§»åŠ¨ç«¯ï¼šå…³é—­åŒ»ç”Ÿé€‰æ‹©æµ®å±‚
            if (window.innerWidth <= 768) {
                closeMobileDoctorSelector();
            }
        }

        // æ·»åŠ æ¶ˆæ¯
        async function addMessage(sender, content, showFeedback = false, isPaid = false, prescriptionId = null) {
            console.log('ğŸ” addMessageè¢«è°ƒç”¨:', {
                sender,
                contentLength: content ? content.length : 0,
                contentPreview: content ? content.substring(0, 50) + '...' : 'null',
                showFeedback,
                isPaid,
                prescriptionId
            });
            
            const container = document.getElementById('messagesContainer');
            if (!container) {
                console.error('âŒ æ‰¾ä¸åˆ°messagesContainer');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // ğŸ†• ä½¿ç”¨å¤„æ–¹æ¸²æŸ“å™¨å¤„ç†å†…å®¹
            let processedContent = content;
            if (sender === 'ai') {
                console.log('ğŸ” å¤„æ–¹æ¸²æŸ“æ£€æŸ¥:', {
                    prescriptionRendererå­˜åœ¨: !!window.prescriptionRenderer,
                    isPaid: isPaid,
                    prescriptionId: prescriptionId,
                    å†…å®¹é•¿åº¦: content.length
                });
                
                if (window.simplePrescriptionManager) {
                    // ä½¿ç”¨ç®€åŒ–ç‰ˆå¤„æ–¹ç®¡ç†å™¨
                    console.log('âœ… ä½¿ç”¨ç®€åŒ–ç‰ˆå¤„æ–¹ç®¡ç†å™¨å¤„ç†å†…å®¹');
                    processedContent = await window.simplePrescriptionManager.processContent(content, prescriptionId);
                } else if (window.prescriptionContentRenderer) {
                    // å¤‡ç”¨ï¼šä½¿ç”¨åŸæ¥çš„å¤„æ–¹æ¸²æŸ“å™¨
                    console.log('âš ï¸ ä½¿ç”¨å¤‡ç”¨å¤„æ–¹æ¸²æŸ“å™¨');
                    processedContent = window.prescriptionContentRenderer.renderContent(content, prescriptionId);
                    
                    // ğŸ”§ ä¿å­˜åŸå§‹å†…å®¹ç”¨äºæ”¯ä»˜åè§£é”
                    if (prescriptionId && content) {
                        // å°†åŸå§‹å†…å®¹ä¿å­˜åˆ°å³å°†åˆ›å»ºçš„æ¶ˆæ¯å…ƒç´ ä¸­
                        setTimeout(() => {
                            const messages = document.querySelectorAll('.message.ai');
                            const lastMessage = messages[messages.length - 1];
                            if (lastMessage) {
                                const messageTextEl = lastMessage.querySelector('.message-text');
                                if (messageTextEl && !messageTextEl.getAttribute('data-original-content')) {
                                    messageTextEl.setAttribute('data-original-content', content);
                                    console.log('âœ… å·²ä¿å­˜åŸå§‹å†…å®¹ç”¨äºæ”¯ä»˜åè§£é”');
                                }
                            }
                        }, 100);
                    }
                } else {
                    // æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ ¼å¼åŒ–å†…å®¹
                    console.log('âš ï¸ ç®€åŒ–ç‰ˆå¤„æ–¹ç®¡ç†å™¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸºç¡€æ ¼å¼åŒ–');
                    processedContent = formatMessage(content);
                }
            }
            
            // å¦‚æœæœ‰å¤„æ–¹IDï¼Œä¿å­˜åˆ°å…ƒç´ å±æ€§ä¸­
            if (prescriptionId) {
                messageDiv.setAttribute('data-prescription-id', prescriptionId);
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'ğŸ‘¤' : (selectedDoctor ? doctors[selectedDoctor].avatar : 'ğŸ¤–')}</div>
                <div class="message-content">
                    <div class="message-text">${processedContent}</div>
                    <div class="message-time">${timeStr}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">è¿™ä¸ªå›ç­”æœ‰å¸®åŠ©å—ï¼Ÿ</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">ğŸ˜Š å¾ˆå¥½</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">ğŸ‘ ä¸é”™</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">ğŸ‘Œ è¿˜è¡Œ</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">ğŸ‘ ä¸å¥½</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">ğŸ˜ å¾ˆå·®</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            // è‡ªåŠ¨æœ—è¯»AIå›å¤
            if (sender === 'ai' && document.getElementById('autoSpeak').checked) {
                speakText(content);
            }
            
            // è‡ªåŠ¨ä¿å­˜å½“å‰åŒ»ç”Ÿçš„å¯¹è¯å†å²
            if (selectedDoctor) {
                setTimeout(() => saveCurrentDoctorHistory(), 100); // å»¶è¿Ÿ100msç¡®ä¿DOMæ›´æ–°å®Œæˆ
                
                // ğŸ”„ è‡ªåŠ¨æ›´æ–°ChatGPTé£æ ¼å¯¹è¯ç®¡ç†ç³»ç»Ÿ
                setTimeout(() => {
                    updateConversationListAfterMessage();
                }, 200);
            }
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessage(content) {
            if (!content) return '';
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¯Šç–—æ–¹æ¡ˆXMLæ ‡ç­¾
            if (content.includes('<è¯Šç–—æ–¹æ¡ˆ>')) {
                return formatTCMPrescription(content);
            }
            
            // å¢å¼ºçš„Markdownå¤„ç† - æ˜ç¡®çš„å±‚æ¬¡å’Œæ ·å¼
            return content
                // å¤„ç†ã€å¤„æ–¹ã€‘æ ‡ç­¾ - ç‰¹æ®Šé«˜äº®æ ·å¼
                .replace(/\*\*ã€å¤„æ–¹ã€‘\*\*/g, '<div style="background: linear-gradient(135deg, #2d5aa0, #4a7bc8); color: white; padding: 10px 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; font-size: 16px; text-align: center;">ğŸ“‹ ä¸­è¯å¤„æ–¹</div>')
                // å¤„ç†ã€ç”¨æ³•ã€‘ã€æ³¨æ„ã€‘ç­‰æ ‡ç­¾
                .replace(/\*\*ã€(ç”¨æ³•|æ³¨æ„|ç¦å¿Œ|åŠŸæ•ˆ)ã€‘\*\*/g, '<div style="background: #f3f4f6; color: #374151; padding: 8px 12px; border-radius: 6px; margin: 10px 0; font-weight: bold; border-left: 4px solid #6b7280;">$1</div>')
                // å¤„ç†å…¶ä»–ç²—ä½“æ ‡ç­¾ã€xxxã€‘
                .replace(/\*\*ã€(.*?)ã€‘\*\*/g, '<strong style="color: #2d5aa0; font-size: 15px; background: #e0f2fe; padding: 2px 6px; border-radius: 4px;">ã€$1ã€‘</strong>')
                // å¤„ç†å…¶ä»–ç²—ä½“æ–‡æœ¬
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937; font-weight: bold;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color: #6b7280;">$1</em>')
                // å¤„ç†#####æ ‡è®° - è½¬æ¢ä¸ºåˆ†å‰²çº¿
                .replace(/#{5,}/g, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb; background: linear-gradient(to right, #e5e7eb, transparent);">')
                // å¤„ç†###æ ‡è®° - è½¬æ¢ä¸ºæ˜æ˜¾çš„å°æ ‡é¢˜
                .replace(/###\s*(.*?)(?=\n|$)/g, '<h4 style="margin: 20px 0 12px 0; color: #2d5aa0; font-size: 17px; font-weight: bold; padding-left: 8px; border-left: 4px solid #2d5aa0; background: #f8fafc;">$1</h4>')
                // å¤„ç†##æ ‡è®° - è½¬æ¢ä¸ºæ›´å¤§çš„ä¸­æ ‡é¢˜  
                .replace(/##\s*(.*?)(?=\n|$)/g, '<h3 style="margin: 25px 0 15px 0; color: #1f2937; font-size: 19px; font-weight: bold; padding: 8px 12px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 6px;">$1</h3>')
                // å¤„ç†#æ ‡è®° - è½¬æ¢ä¸ºå¤§æ ‡é¢˜
                .replace(/^#\s*(.*?)(?=\n|$)/gm, '<h2 style="margin: 30px 0 20px 0; color: #111827; font-size: 22px; font-weight: bold; text-align: center; padding: 12px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px;">$1</h2>')
                // å¤„ç†è¯æåˆ—è¡¨ - ç‰¹æ®Šæ ·å¼
                .replace(/([ä¸€-é¾Ÿ\u4e00-\u9fff]+)\s+(\d+)g/g, '<span style="display: inline-block; background: #ecfdf5; color: #065f46; padding: 2px 6px; margin: 1px 3px; border-radius: 4px; font-weight: 500; border: 1px solid #d1fae5;">$1 <strong>$2g</strong></span>')
                .replace(/\n\n/g, '<br><br>')  // æ®µè½é—´è·
                .replace(/\n/g, '<br>')        // æ™®é€šæ¢è¡Œ
                .replace(/(\d+\.\s)/g, '<br><span style="color: #2d5aa0; font-weight: bold;">$1</span>') // æ•°å­—åˆ—è¡¨æ ·å¼
                .replace(/^<br>/, '');         // ç§»é™¤å¼€å¤´çš„æ¢è¡Œ
        }

        // æ ¼å¼åŒ–ä¸­åŒ»å¤„æ–¹ - å…¨æ–°è®¾è®¡
        function formatTCMPrescription(content) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«XMLæ ¼å¼
            const hasXMLFormat = content.includes('<è¯Šç–—æ–¹æ¡ˆ>');
            
            if (hasXMLFormat) {
                return formatXMLPrescription(content);
            } else {
                // å¦‚æœæ²¡æœ‰XMLæ ¼å¼ï¼Œå°è¯•æ™ºèƒ½è§£ææ–‡æœ¬æ ¼å¼
                return formatTextPrescription(content);
            }
        }

        // XMLæ ¼å¼å¤„æ–¹è§£æ
        function formatXMLPrescription(content) {
            const prescriptionMatch = content.match(/<è¯Šç–—æ–¹æ¡ˆ>([\s\S]*?)<\/è¯Šç–—æ–¹æ¡ˆ>/);
            if (!prescriptionMatch) {
                return formatTextPrescription(content);
            }
            
            const prescriptionContent = prescriptionMatch[1];
            let formattedHTML = '<div class="modern-tcm-report">';
            
            // å®šä¹‰å„ä¸ªéƒ¨åˆ†çš„é…ç½®
            const sections = [
                { name: 'ä¸»è¯‰', key: 'ä¸»è¯‰', icon: 'ğŸ©º', color: '#ef4444' },
                { name: 'ç°ç—…å²', key: 'ç°ç—…å²', icon: 'ğŸ“‹', color: '#3b82f6' },
                { name: 'æœ›è¯Šæ‰€è§', key: 'æœ›è¯Šæ‰€è§', icon: 'ğŸ‘ï¸', color: '#10b981' },
                { name: 'ç—…æœºåˆ†æ', key: 'ç—…æœºåˆ†æ', icon: 'ğŸ§ ', color: '#8b5cf6' },
                { name: 'è¯å‹è¯Šæ–­', key: 'è¯å‹è¯Šæ–­', icon: 'ğŸ¯', color: '#f59e0b' },
                { name: 'æ²»æ³•', key: 'æ²»æ³•', icon: 'âš¡', color: '#06b6d4' },
                { name: 'æ–¹å‰‚é€‰ç”¨', key: 'æ–¹å‰‚é€‰ç”¨', icon: 'ğŸ“œ', color: '#84cc16' },
                { name: 'å¤„æ–¹å»ºè®®', key: 'å¤„æ–¹å»ºè®®', icon: 'ğŸ’Š', color: '#ec4899', special: 'prescription' },
                { name: 'ç…æœæ–¹æ³•', key: 'ç…æœæ–¹æ³•', icon: 'ğŸ”¥', color: '#f97316' },
                { name: 'éšè¯åŠ å‡', key: 'éšè¯åŠ å‡', icon: 'âš–ï¸', color: '#6366f1' },
                { name: 'ç”Ÿæ´»è°ƒæ‘„', key: 'ç”Ÿæ´»è°ƒæ‘„', icon: 'ğŸŒ±', color: '#059669' },
                { name: 'å¤è¯Šå»ºè®®', key: 'å¤è¯Šå»ºè®®', icon: 'ğŸ“…', color: '#dc2626' }
            ];
            
            sections.forEach(section => {
                const regex = new RegExp(`<${section.key}>(.*?)<\/${section.key}>`, 's');
                const match = prescriptionContent.match(regex);
                
                if (match) {
                    let sectionContent = match[1].trim()
                        .replace(/\*\*(.*?)\*\*/g, '<span class="highlight-term">$1</span>')
                        .replace(/\n/g, '<br>');
                    
                    // ç‰¹æ®Šå¤„ç†å¤„æ–¹å»ºè®®
                    if (section.special === 'prescription') {
                        sectionContent = formatModernPrescription(sectionContent);
                    }
                    
                    formattedHTML += `
                        <div class="modern-tcm-section" style="--section-color: ${section.color}">
                            <div class="section-header">
                                <span class="section-icon">${section.icon}</span>
                                <span class="section-title">${section.name}</span>
                            </div>
                            <div class="section-content">${sectionContent}</div>
                        </div>
                    `;
                }
            });
            
            formattedHTML += '</div>';
            
            // å¤„ç†XMLå¤–çš„å†…å®¹
            const beforeMatch = content.substring(0, content.indexOf('<è¯Šç–—æ–¹æ¡ˆ>'));
            const afterMatch = content.substring(content.indexOf('</è¯Šç–—æ–¹æ¡ˆ>') + 7);
            
            let result = '';
            if (beforeMatch.trim()) {
                result += '<div class="pre-prescription">' + formatMessage(beforeMatch) + '</div>';
            }
            result += formattedHTML;
            if (afterMatch.trim()) {
                result += '<div class="post-prescription">' + formatMessage(afterMatch) + '</div>';
            }
            
            return result;
        }

        // æ–‡æœ¬æ ¼å¼å¤„æ–¹æ™ºèƒ½è§£æ
        function formatTextPrescription(content) {
            let formattedHTML = '<div class="text-tcm-report">';
            
            // æŒ‰æ®µè½åˆ†æ
            const paragraphs = content.split('\n\n');
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡é¢˜è¡Œ
                    if (paragraph.includes('**') && paragraph.length < 50) {
                        formattedHTML += `<div class="text-section-header">${formatMessage(paragraph)}</div>`;
                    } else {
                        formattedHTML += `<div class="text-section-content">${formatMessage(paragraph)}</div>`;
                    }
                }
            });
            
            formattedHTML += '</div>';
            return formattedHTML;
        }

        // ç°ä»£åŒ–å¤„æ–¹æ ¼å¼åŒ–
        function formatModernPrescription(prescriptionText) {
            // å¤šç§è¯ææ ¼å¼è¯†åˆ«
            const herbs = [];
            let originalText = prescriptionText;
            
            // æ¨¡å¼åŒ¹é…è¯æåç§°å’Œå‰‚é‡
            const patterns = [
                /<span class="highlight-term">(.*?)<\/span>\s*(\d+(?:\.\d+)?g?)/g,
                /\*\*(.*?)\*\*\s*(\d+(?:\.\d+)?g?)/g,
                /<strong>(.*?)<\/strong>\s*(\d+(?:\.\d+)?g?)/g,
                /([^\s\dï¼Œã€‚ï¼›ã€\-]+)\s*(\d+(?:\.\d+)?g)/g
            ];
            
            let usedPattern = null;
            
            for (let pattern of patterns) {
                pattern.lastIndex = 0; // é‡ç½®æ­£åˆ™è¡¨è¾¾å¼çš„lastIndex
                let match;
                let tempHerbs = [];
                
                while ((match = pattern.exec(originalText)) !== null) {
                    const herbName = match[1].trim();
                    const dosage = match[2];
                    
                    // æ’é™¤éè¯æè¯æ±‡å’Œé‡å¤é¡¹
                    if (!['å…±', 'ç…', 'æœ', 'ç”¨', 'æ¯', 'æ¬¡', 'æ—¥', 'æ°´', 'ç…æœ', 'åˆ†æœ', 'æ–¹', 'è¯'].includes(herbName) 
                        && herbName.length > 0 && herbName.length < 10) {
                        
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        if (!tempHerbs.some(h => h.name === herbName)) {
                            tempHerbs.push({
                                name: herbName,
                                dosage: dosage,
                                fullMatch: match[0]
                            });
                        }
                    }
                }
                
                if (tempHerbs.length > 0) {
                    herbs.push(...tempHerbs);
                    usedPattern = pattern;
                    break; // æ‰¾åˆ°åŒ¹é…å°±åœæ­¢
                }
            }
            
            if (herbs.length > 0) {
                let modernHTML = '<div class="modern-prescription-grid">';
                herbs.forEach((herb, index) => {
                    modernHTML += `
                        <div class="herb-card" style="animation-delay: ${index * 0.1}s">
                            <div class="herb-name-modern">
                                ${herb.name} 
                                <span class="herb-dosage-inline">${herb.dosage}</span>
                            </div>
                        </div>
                    `;
                });
                modernHTML += '</div>';
                
                // ç§»é™¤å·²ç»æ˜¾ç¤ºçš„è¯æä¿¡æ¯ï¼Œé¿å…é‡å¤
                let remainingText = originalText;
                herbs.forEach(herb => {
                    // ç§»é™¤å„ç§å¯èƒ½çš„è¯ææ ¼å¼
                    remainingText = remainingText
                        .replace(new RegExp(`\\*\\*${herb.name}\\*\\*\\s*${herb.dosage}[ï¼Œã€]*`, 'g'), '')
                        .replace(new RegExp(`<strong>${herb.name}</strong>\\s*${herb.dosage}[ï¼Œã€]*`, 'g'), '')
                        .replace(new RegExp(`<span class="highlight-term">${herb.name}</span>\\s*${herb.dosage}[ï¼Œã€]*`, 'g'), '')
                        .replace(new RegExp(`${herb.name}\\s*${herb.dosage}[ï¼Œã€]*`, 'g'), '');
                });
                
                // æ¸…ç†å¤šä½™çš„æ ‡ç‚¹å’Œç©ºç™½
                remainingText = remainingText
                    .replace(/<[^>]*>/g, '') // ç§»é™¤HTMLæ ‡ç­¾
                    .replace(/\*\*/g, '') // ç§»é™¤markdownæ ‡è®°
                    .replace(/[ï¼Œã€]{2,}/g, 'ã€') // åˆå¹¶å¤šä¸ªæ ‡ç‚¹
                    .replace(/^[ï¼Œã€\s]+|[ï¼Œã€\s]+$/g, '') // ç§»é™¤é¦–å°¾æ ‡ç‚¹
                    .trim();
                
                // åªæœ‰å½“å‰©ä½™æ–‡æœ¬æœ‰å®é™…å†…å®¹æ—¶æ‰æ˜¾ç¤º
                if (remainingText && remainingText.length > 5) {
                    modernHTML += `<div class="prescription-notes">${remainingText}</div>`;
                }
                
                return modernHTML;
            }
            
            // å¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°è¯æï¼Œè¿”å›æ ¼å¼åŒ–çš„æ–‡æœ¬
            return `<div class="prescription-text">${prescriptionText}</div>`;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä½åŒ»å¸ˆ');
                }
                return;
            }

            // ğŸ†• çŠ¶æ€ç®¡ç†é›†æˆï¼šåˆ†æç”¨æˆ·æ¶ˆæ¯å¹¶æ›´æ–°çŠ¶æ€
            if (window.conversationStateManager) {
                const analysis = window.conversationStateManager.analyzeMessage(message, false);
                if (analysis.suggestedNextState) {
                    window.conversationStateManager.setState(
                        analysis.suggestedNextState,
                        `ç”¨æˆ·æ¶ˆæ¯åˆ†æ: ${analysis.isEndingMessage ? 'ç»“æŸæ„å›¾' : 'ç»§ç»­é—®è¯Š'}`
                    );
                }
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            await addMessage('user', message);
            input.value = '';
            adjustTextareaHeight();
            
            // æ™ºèƒ½æ¨èåŒ»ç”Ÿ - AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤
            // ä¸å†è¿›è¡Œç—‡çŠ¶æ£€æµ‹å’ŒåŒ»ç”Ÿæ¨è

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const sendBtn = document.getElementById('sendBtn');
            const loading = document.getElementById('loading');
            sendBtn.disabled = true;
            loading.style.display = 'block';

                        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šè·å–å½“å‰å¯¹è¯å†å²ä»¥ç»´æŒä¸Šä¸‹æ–‡è¿ç»­æ€§
                const conversationHistory = getCurrentConversationHistory();
                
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor,
                        patient_id: getCurrentUserId(), // ğŸ”‘ ä¿®å¤ï¼šæ·»åŠ ç”¨æˆ·ID
                        conversation_history: conversationHistory // ä¼ é€’å¯¹è¯å†å²
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                
                // ğŸ” è°ƒè¯•ï¼šæ‰“å°å®Œæ•´APIå“åº”
                console.log('ğŸ” PCç«¯APIå®Œæ•´å“åº”:', responseData);
                
                // å¤„ç†æ–°çš„APIå“åº”æ ¼å¼
                let aiReply;
                if (responseData.success && responseData.data && responseData.data.reply) {
                    aiReply = responseData.data.reply;
                    console.log('âœ… PCç«¯ä½¿ç”¨æ–°æ ¼å¼ï¼Œå›å¤å†…å®¹é•¿åº¦:', aiReply.length);
                } else if (responseData.reply) {
                    aiReply = responseData.reply; // å…¼å®¹æ—§æ ¼å¼
                    console.log('âœ… PCç«¯ä½¿ç”¨æ—§æ ¼å¼ï¼Œå›å¤å†…å®¹é•¿åº¦:', aiReply.length);
                } else {
                    console.error('âŒ PCç«¯APIå“åº”æ ¼å¼é”™è¯¯ï¼Œå“åº”ç»“æ„:', Object.keys(responseData));
                    throw new Error('APIå“åº”æ ¼å¼é”™è¯¯: æœªæ‰¾åˆ°replyå­—æ®µ');
                }
                
                // åŒ»ç–—å®‰å…¨æ£€æŸ¥
                const aiWarnings = checkMedicalSafety(aiReply);
                if (aiWarnings.length > 0) {
                    showMedicalWarnings(aiWarnings);
                    // è®°å½•AIå“åº”ä¸­çš„å®‰å…¨é—®é¢˜
                    aiWarnings.forEach(warning => {
                        logSecurityEvent(`ai_${warning.type}`, aiReply, warning);
                    });
                }
                
                // æ£€æŸ¥ç—‡çŠ¶ç¼–é€ 
                detectSymptomFabrication(message, aiReply);
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå¤„æ–¹æ£€æµ‹å’Œæ”¯ä»˜çŠ¶æ€åˆ†ç¦»ç®¡ç†
                const containsActualPrescription = containsPrescription(aiReply);
                const isTemporaryAdvice = window.prescriptionContentRenderer ? 
                    window.prescriptionContentRenderer.containsPrescription(aiReply) === false : false;
                
                // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºç‚¹è¯„ - æ‰€æœ‰AIå›å¤éƒ½å¯ä»¥ç‚¹è¯„
                const shouldShowFeedback = true;
                
                // å¤„æ–¹ç›¸å…³çŠ¶æ€ç®¡ç† - ä¿®å¤å¤„æ–¹IDä¸ºç©ºçš„é—®é¢˜
                let prescriptionId = responseData.data?.prescription_id || null;
                const isPaid = responseData.data?.is_paid || false;
                
                // ğŸ”‘ å…³é”®ï¼šå¦‚æœæœ‰çœŸå®å¤„æ–¹IDï¼Œå­˜å‚¨æ˜ å°„å…³ç³»å’ŒçŠ¶æ€
                if (prescriptionId && responseData.data?.contains_prescription) {
                    // å¤„æ–¹å“ˆå¸ŒIDå°†åœ¨ç®€åŒ–å¤„æ–¹ç®¡ç†å™¨ä¸­ç”Ÿæˆï¼Œè¿™é‡Œå…ˆè®°å½•çœŸå®ID
                    window.lastRealPrescriptionId = prescriptionId;
                    // ğŸ”‘ æ–°å¢ï¼šå­˜å‚¨å®Œæ•´çš„å¤„æ–¹æ•°æ®ï¼ŒåŒ…æ‹¬çŠ¶æ€ä¿¡æ¯
                    window.lastPrescriptionData = responseData.data.prescription_data || {};
                    window.lastPrescriptionData.prescription_id = prescriptionId;
                    
                    console.log(`ğŸ“‹ è·å–åˆ°çœŸå®å¤„æ–¹ID: ${prescriptionId}`);
                    console.log(`ğŸ“‹ å¤„æ–¹æ•°æ®:`, window.lastPrescriptionData);
                }
                
                // ğŸ”§ å¦‚æœAPIæ²¡æœ‰è¿”å›å¤„æ–¹IDï¼Œä½†å“åº”åŒ…å«å¤„æ–¹å†…å®¹ï¼Œåˆ™è°ƒç”¨åç«¯åˆ›å»ºå¤„æ–¹
                if (!prescriptionId && responseData.reply && 
                    (responseData.reply.includes('å¤„æ–¹') || responseData.reply.includes('æ–¹å‰‚') || 
                     responseData.reply.includes('å›è¯') || responseData.reply.includes('è‡£è¯'))) {
                    
                    // ğŸ”‘ å…³é”®ä¿®å¤ï¼šè°ƒç”¨åç«¯APIåˆ›å»ºå¤„æ–¹å¹¶ä¿å­˜åˆ°æ•°æ®åº“
                    try {
                        const userId = getCurrentUserId();
                        const conversationId = currentConversationId || generateConversationId();
                        
                        // ğŸ”‘ ä¿®å¤ï¼šæ·»åŠ åŒ»ç”ŸIDåˆ°å¤„æ–¹æ•°æ®
                        const doctorIdMapping = {
                            'zhang_zhongjing': 4,
                            'ye_tianshi': 2,
                            'li_dongyuan': 3,
                            'zheng_qin_an': 6,
                            'liu_duzhou': 5,
                            'jin_daifu': 1
                        };
                        
                        const prescriptionData = {
                            patient_id: userId,
                            conversation_id: conversationId,
                            doctor_id: doctorIdMapping[selectedDoctor] || 1, // ğŸ†• æ·»åŠ åŒ»ç”ŸID
                            patient_name: currentUser?.display_name || currentUser?.username || 'ç”¨æˆ·',
                            symptoms: (responseData.data?.symptoms_summary || 'ç”¨æˆ·é—®è¯Š'),
                            diagnosis: (responseData.data?.diagnosis_summary || selectedDoctor + 'åŒ»ç”Ÿè¯Šæ–­'),
                            ai_prescription: responseData.reply
                        };
                        
                        console.log('ğŸ”„ è°ƒç”¨åç«¯åˆ›å»ºå¤„æ–¹:', prescriptionData);
                        
                        const createResponse = await fetch('/api/prescription/create', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(prescriptionData)
                        });
                        
                        if (createResponse.ok) {
                            const createResult = await createResponse.json();
                            if (createResult.success) {
                                prescriptionId = createResult.prescription_id;
                                console.log('âœ… å¤„æ–¹åˆ›å»ºæˆåŠŸï¼ŒID:', prescriptionId);
                            } else {
                                console.warn('âš ï¸ å¤„æ–¹åˆ›å»ºè¿”å›å¤±è´¥:', createResult.message);
                                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¸´æ—¶ID
                                prescriptionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                        } else {
                            console.warn('âš ï¸ å¤„æ–¹åˆ›å»ºAPIè°ƒç”¨å¤±è´¥:', createResponse.status);
                            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¸´æ—¶ID
                            prescriptionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                    } catch (error) {
                        console.error('âŒ å¤„æ–¹åˆ›å»ºå¼‚å¸¸:', error);
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¸´æ—¶ID
                        prescriptionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    console.log('ğŸ†• æœ€ç»ˆå¤„æ–¹ID:', prescriptionId);
                }
                
                console.log('ğŸ” å‰ç«¯å¤„æ–¹çŠ¶æ€åˆ†æ:', {
                    containsActualPrescription: containsActualPrescription,
                    isTemporaryAdvice: isTemporaryAdvice,
                    prescriptionId: prescriptionId,
                    isPaid: isPaid,
                    backendContainsPrescription: responseData.data?.contains_prescription
                });
                
                // ğŸš¨ å…³é”®é€»è¾‘ï¼šå®Œæ•´å¤„æ–¹ä¸”æœªä»˜è´¹æ—¶éœ€è¦æ”¯ä»˜
                const needsPayment = containsActualPrescription && !isTemporaryAdvice && !isPaid;
                
                // ğŸ†• çŠ¶æ€ç®¡ç†é›†æˆï¼šåˆ†æAIæ¶ˆæ¯å¹¶æ›´æ–°çŠ¶æ€
                if (window.conversationStateManager) {
                    const analysis = window.conversationStateManager.analyzeMessage(aiReply, true);
                    if (analysis.suggestedNextState) {
                        window.conversationStateManager.setState(
                            analysis.suggestedNextState, 
                            `AIå›å¤åˆ†æ: ${analysis.containsPrescription ? 'åŒ…å«å¤„æ–¹' : 'æ™®é€šå›å¤'}`
                        );
                    }
                }
                
                console.log('ğŸ” PCç«¯å³å°†æ·»åŠ AIæ¶ˆæ¯:', {
                    aiReply: aiReply.substring(0, 100) + '...',
                    shouldShowFeedback,
                    containsActualPrescription,
                    isTemporaryAdvice,
                    needsPayment,
                    isPaid,
                    prescriptionId
                });
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ ¹æ®å¤„æ–¹çŠ¶æ€å†³å®šæ˜¾ç¤ºæ¨¡å¼
                await addMessage('ai', aiReply, shouldShowFeedback, isPaid, prescriptionId);
                
                // è®°å½•è¯Šæ–­é˜¶æ®µ
                if (shouldShowFeedback) {
                    console.log('æ£€æµ‹åˆ°å¤„æ–¹å†…å®¹ï¼Œæ˜¾ç¤ºç‚¹è¯„åŠŸèƒ½ï¼Œå¤„æ–¹ID:', prescriptionId, 'æ”¯ä»˜çŠ¶æ€:', isPaid);
                } else {
                    console.log('æ™®é€šå¯¹è¯ï¼Œä¸æ˜¾ç¤ºç‚¹è¯„');
                }

            } catch (error) {
                addMessage('ai', `æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼š${error.message}`);
            } finally {
                sendBtn.disabled = false;
                loading.style.display = 'none';
                input.focus();
            }
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // æ‰“å¼€æ³¨å†Œé¡µé¢
        function openRegisterPage() {
            window.open('/nav', '_blank');
        }

        // æ‰“å¼€ç—…å†è®°å½•é¡µé¢
        function openHistoryPage() {
            // è·³è½¬åˆ°ç”¨æˆ·å†å²é¡µé¢
            window.open('/history', '_blank');
        }

        // æ˜¾ç¤ºç—…å†è®°å½•æ¨¡æ€æ¡†
        async function showMedicalRecordsModal() {
            try {
                // è·å–ç”¨æˆ·çš„ç—…å†è®°å½•
                const response = await fetch('/api/medical-records/list', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('è·å–ç—…å†è®°å½•å¤±è´¥', 'error');
                    return;
                }
                
                createMedicalRecordsModal(result.data || []);
                
            } catch (error) {
                console.error('è·å–ç—…å†è®°å½•å¤±è´¥:', error);
                showMessage('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // åˆ›å»ºç—…å†è®°å½•æ¨¡æ€æ¡†
        function createMedicalRecordsModal(records) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†
            let modal = document.getElementById('medicalRecordsModal');
            if (modal) {
                modal.remove();
            }
            
            modal = document.createElement('div');
            modal.id = 'medicalRecordsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1004;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 800px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 20px; font-weight: 600;">ğŸ“‹ æˆ‘çš„ç—…å†è®°å½•</h3>
                        <button onclick="hideMedicalRecordsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <button onclick="showAllRecords()" id="allRecordsBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: #3b82f6; color: white; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                å…¨éƒ¨è®°å½•
                            </button>
                            <button onclick="showConsultationRecords()" id="consultationBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: white; color: #3b82f6; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                é—®è¯Šè®°å½•
                            </button>
                            <button onclick="showPrescriptionRecords()" id="prescriptionBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: white; color: #3b82f6; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                å¤„æ–¹è®°å½•
                            </button>
                        </div>
                        <div id="recordsContainer">
                            ${records.length > 0 ? generateRecordsHTML(records) : '<div style="text-align: center; color: #6b7280; padding: 40px;">æš‚æ— ç—…å†è®°å½•</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ç”Ÿæˆç—…å†è®°å½•HTML
        function generateRecordsHTML(records) {
            return records.map(record => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px;">${record.doctor_name || 'åŒ»ç”Ÿ'} - ${record.type === 'consultation' ? 'é—®è¯Šè®°å½•' : 'å¤„æ–¹è®°å½•'}</h4>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 13px;">${new Date(record.created_at).toLocaleString()}</p>
                        </div>
                        <span style="padding: 4px 12px; background: ${record.status === 'completed' ? '#dcfce7' : '#fef3c7'}; color: ${record.status === 'completed' ? '#166534' : '#92400e'}; border-radius: 12px; font-size: 12px;">
                            ${record.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                        </span>
                    </div>
                    
                    ${record.symptoms ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">ä¸»è¦ç—‡çŠ¶ï¼š</strong>
                            <span style="color: #6b7280; font-size: 14px;">${record.symptoms}</span>
                        </div>
                    ` : ''}
                    
                    ${record.diagnosis ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">è¯Šæ–­ç»“æœï¼š</strong>
                            <span style="color: #6b7280; font-size: 14px;">${record.diagnosis}</span>
                        </div>
                    ` : ''}
                    
                    ${record.prescription ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">å¤„æ–¹å†…å®¹ï¼š</strong>
                            <div style="background: #f8fafc; border-radius: 6px; padding: 12px; margin-top: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${record.prescription}</div>
                        </div>
                    ` : ''}
                    
                    ${record.payment_amount ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">è´¹ç”¨ï¼š</strong>
                            <span style="color: #ef4444; font-size: 14px; font-weight: 500;">Â¥ ${record.payment_amount}</span>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <button onclick="viewRecordDetail('${record.id}')" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; color: #374151;">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        ${record.type === 'prescription' && record.status === 'completed' ? `
                            <button onclick="reorderPrescription('${record.id}')" style="padding: 6px 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 12px; cursor: pointer; color: #3b82f6;">
                                é‡æ–°è´­ä¹°
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // éšè—ç—…å†è®°å½•æ¨¡æ€æ¡†
        function hideMedicalRecordsModal() {
            const modal = document.getElementById('medicalRecordsModal');
            if (modal) {
                modal.remove();
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰è®°å½•
        async function showAllRecords() {
            updateRecordFilter('all');
            const response = await fetch('/api/medical-records/list', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // æ˜¾ç¤ºé—®è¯Šè®°å½•
        async function showConsultationRecords() {
            updateRecordFilter('consultation');
            const response = await fetch('/api/medical-records/list?type=consultation', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // æ˜¾ç¤ºå¤„æ–¹è®°å½•
        async function showPrescriptionRecords() {
            updateRecordFilter('prescription');
            const response = await fetch('/api/medical-records/list?type=prescription', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // æ›´æ–°è®°å½•è¿‡æ»¤å™¨æ ·å¼
        function updateRecordFilter(type) {
            const buttons = ['allRecordsBtn', 'consultationBtn', 'prescriptionBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((type === 'all' && btnId === 'allRecordsBtn') ||
                        (type === 'consultation' && btnId === 'consultationBtn') ||
                        (type === 'prescription' && btnId === 'prescriptionBtn')) {
                        btn.style.background = '#3b82f6';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#3b82f6';
                    }
                }
            });
        }

        // æ›´æ–°è®°å½•å®¹å™¨
        function updateRecordsContainer(records) {
            const container = document.getElementById('recordsContainer');
            if (container) {
                container.innerHTML = records.length > 0 ? generateRecordsHTML(records) : '<div style="text-align: center; color: #6b7280; padding: 40px;">æš‚æ— ç›¸å…³è®°å½•</div>';
            }
        }

        // æŸ¥çœ‹è®°å½•è¯¦æƒ…
        async function viewRecordDetail(recordId) {
            try {
                const response = await fetch(`/api/user/conversation/${recordId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const record = await response.json();
                    
                    // æ˜¾ç¤ºè¯¦ç»†çš„è®°å½•ä¿¡æ¯
                    showRecordDetailModal(record);
                } else {
                    showMessage('è·å–è®°å½•è¯¦æƒ…å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è·å–è®°å½•è¯¦æƒ…å¤±è´¥:', error);
                showMessage('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // é‡æ–°è´­ä¹°å¤„æ–¹
        async function reorderPrescription(recordId) {
            try {
                const response = await fetch(`/api/prescription/reorder/${recordId}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    hideMedicalRecordsModal();
                    showPaymentModal(result.data.prescription_id, result.data.amount);
                } else {
                    showMessage(result.message || 'é‡æ–°è´­ä¹°å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('é‡æ–°è´­ä¹°å¤±è´¥:', error);
                showMessage('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }
        
        // è·å–åŒ»ç”Ÿæ˜¾ç¤ºåç§°ï¼ˆåŠ¨æ€ä»doctorså¯¹è±¡è·å–ï¼‰
        function getDoctorDisplayName(doctorKey) {
            // ä¼˜å…ˆä»åŠ è½½çš„åŒ»ç”Ÿæ•°æ®ä¸­è·å–
            if (doctors[doctorKey] && doctors[doctorKey].name) {
                return doctors[doctorKey].name;
            }
            
            // å¤‡é€‰ï¼šç¡¬ç¼–ç æ˜ å°„ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
            const doctorNames = {
                'jin_daifu': 'é‡‘å¤§å¤«',
                'zhang_zhongjing': 'å¼ ä»²æ™¯',
                'ye_tianshi': 'å¶å¤©å£«'
            };
            return doctorNames[doctorKey] || doctorKey || 'åŒ»ç”Ÿ';
        }
        
        // æ˜¾ç¤ºè®°å½•è¯¦æƒ…æ¨¡æ€æ¡†
        function showRecordDetailModal(record) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†
            let detailModal = document.getElementById('recordDetailModal');
            if (detailModal) {
                detailModal.remove();
            }
            
            const doctorName = getDoctorDisplayName(record.doctor_name);
            const visitDate = new Date(record.created_at).toLocaleString('zh-CN');
            
            detailModal = document.createElement('div');
            detailModal.id = 'recordDetailModal';
            detailModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1005;
            `;
            
            detailModal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ“‹ å¯¹è¯è¯¦æƒ… - ${doctorName}</h3>
                        <button onclick="closeRecordDetailModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="background: #f8f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #667eea; font-size: 16px;">åŸºæœ¬ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><strong>å°±è¯Šæ—¶é—´:</strong> ${visitDate}</div>
                                <div><strong>å°±è¯Šæ¬¡æ•°:</strong> ç¬¬${record.session_count || 1}æ¬¡</div>
                                <div><strong>ä¸»è¯‰:</strong> ${record.chief_complaint || 'æœªè®°å½•'}</div>
                                <div><strong>å¯¹è¯è½®æ•°:</strong> ${record.total_conversations || 0}è½®</div>
                            </div>
                        </div>
                        
                        ${record.diagnosis_summary ? `
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #3b82f6; font-size: 16px;">è¯Šç–—è®°å½•</h4>
                                <div style="line-height: 1.6; color: #374151;">
                                    <p style="margin-bottom: 12px;"><strong>è¯Šæ–­æ‘˜è¦:</strong> ${record.diagnosis_summary}</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${record.prescription_given && record.prescription_given !== 'æœªå¼€æ–¹' ? `
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #10b981; font-size: 16px;">å¤„æ–¹å†…å®¹</h4>
                                <div style="background: white; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 14px; line-height: 1.5; white-space: pre-wrap; max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db;">
${record.prescription_given}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: #fefce8; border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #eab308; font-size: 16px;">å¯¹è¯çŠ¶æ€</h4>
                            <div style="display: flex; align-items: center;">
                                <span style="padding: 6px 16px; background: ${record.session_status === 'completed' ? '#dcfce7' : '#fef3c7'}; color: ${record.session_status === 'completed' ? '#166534' : '#92400e'}; border-radius: 20px; font-size: 14px; font-weight: 500;">
                                    ${record.session_status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 20px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
                        <button onclick="closeRecordDetailModal()" style="padding: 10px 20px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; color: #374151;">å…³é—­</button>
                        <button onclick="exportConversation('${record.session_id}')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ“„ å¯¼å‡ºç—…å†</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(detailModal);
        }
        
        // å…³é—­è®°å½•è¯¦æƒ…æ¨¡æ€æ¡†
        function closeRecordDetailModal() {
            const modal = document.getElementById('recordDetailModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // å¯¼å‡ºå•ä¸ªå¯¹è¯
        async function exportConversation(sessionId) {
            try {
                const response = await fetch(`/api/user/conversation/${sessionId}/export`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TCM_ç—…å†_${sessionId.slice(0,8)}_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
                    closeRecordDetailModal();
                    showMessage('å¯¼å‡ºæˆåŠŸ', 'success');
                } else {
                    showMessage('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showMessage('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }


        // ç§»åŠ¨ç«¯ç®€åŒ–å¯¼èˆª
        function showMobileNavigation() {
            const navigationHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 12px; padding: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="text-align: center; font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #374151;">
                            ğŸ“± æ‚£è€…æœåŠ¡å¯¼èˆª
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/', '_blank'); this.parentElement.parentElement.parentElement.remove();">ğŸ  ä¸»é¡µ - AIä¸­åŒ»é—®è¯Š</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/nav', '_blank'); this.parentElement.parentElement.parentElement.remove();">ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/history', '_blank'); this.parentElement.parentElement.parentElement.remove();">ğŸ“‹ å†å²è®°å½•</button>
                        </div>
                        
                        <button style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 500;" onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', navigationHtml);
        }

        // å¼€å§‹æ–°å¯¹è¯
        async function startNewChat() {
            if (!selectedDoctor) {
                alert('è¯·å…ˆé€‰æ‹©åŒ»ç”Ÿå†æ¸…ç©ºå¯¹è¯è®°å½•');
                return;
            }
            
            const choice = confirm('ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯è®°å½•\n\nè¿™å°†æ¸…ç©ºå½“å‰åŒ»ç”Ÿçš„æ‰€æœ‰å¯¹è¯è®°å½•ï¼ŒåŒ…æ‹¬ï¼š\nâ€¢ æœ¬åœ°å­˜å‚¨çš„æ¶ˆæ¯\nâ€¢ æœåŠ¡å™¨ç«¯çš„å¯¹è¯å†å²\nâ€¢ å·²ä¿å­˜çš„é—®è¯ŠçŠ¶æ€\n\nç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ');
            
            if (choice) {
                try {
                    const userId = getCurrentUserId();
                    
                    // 1. æ¸…ç©ºæœ¬åœ°å­˜å‚¨
                    const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                    localStorage.removeItem(historyKey);
                    
                    // 2. æ¸…ç©ºæœåŠ¡å™¨ç«¯å¯¹è¯è®°å½•
                    const response = await fetch('/api/conversation/clear', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            user_id: userId,
                            doctor_id: selectedDoctor,
                            clear_type: 'all' // æ¸…ç©ºæ‰€æœ‰ç›¸å…³è®°å½•
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            console.log(`âœ… å·²æ¸…ç©º${selectedDoctor}åŒ»ç”Ÿçš„å®Œæ•´å¯¹è¯è®°å½•`);
                            showMessage(`å·²æ¸…ç©º${getDoctorDisplayName(selectedDoctor)}çš„å¯¹è¯è®°å½•`, 'success');
                        } else {
                            console.warn('æœåŠ¡å™¨æ¸…ç©ºå¤±è´¥ï¼Œä½†æœ¬åœ°å·²æ¸…ç©º');
                            showMessage('æœ¬åœ°è®°å½•å·²æ¸…ç©ºï¼ŒæœåŠ¡å™¨æ¸…ç©ºå¤±è´¥', 'warning');
                        }
                    } else {
                        console.warn('æœåŠ¡å™¨æ¸…ç©ºè¯·æ±‚å¤±è´¥ï¼Œä½†æœ¬åœ°å·²æ¸…ç©º');
                        showMessage('æœ¬åœ°è®°å½•å·²æ¸…ç©ºï¼ŒæœåŠ¡å™¨æ¸…ç©ºå¤±è´¥', 'warning');
                    }
                    
                    // 3. ç”Ÿæˆæ–°çš„å¯¹è¯ID
                    generateConversationId();
                    
                    // 4. æ¸…ç©ºé¡µé¢æ˜¾ç¤ºå¹¶é‡æ–°åŠ è½½ç©ºç™½çŠ¶æ€
                    clearAllMessages();
                    loadDoctorHistory(selectedDoctor);
                    
                } catch (error) {
                    console.error('æ¸…ç©ºå¯¹è¯è®°å½•å¤±è´¥:', error);
                    showMessage('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } else {
                // ç”¨æˆ·é€‰æ‹©ä¿æŒå†å²è®°å½•ï¼Œä»€ä¹ˆéƒ½ä¸åš
                console.log('ç”¨æˆ·é€‰æ‹©ä¿æŒå†å²è®°å½•ä¸å˜');
                
                // éšè—è¾“å…¥æ¡†
                const inputContainer = document.querySelector('.input-container');
                if (inputContainer) {
                    inputContainer.classList.remove('show');
                }
            }
        }

        // ========== ChatGPTé£æ ¼å¯¹è¯ç®¡ç†ç³»ç»Ÿ ==========
        
        // å¯¹è¯å†å²æ•°æ®
        let conversationHistory = [];
        
        // åˆå§‹åŒ–å¯¹è¯ç®¡ç†ç³»ç»Ÿ
        function initConversationManager() {
            loadConversationIndex(); // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å‡½æ•°å
            renderConversationList();
        }
        
        // åˆ›å»ºæ–°å¯¹è¯ï¼ˆChatGPTé£æ ¼ï¼‰
        async function createNewConversation() {
            try {
                const userId = getCurrentUserId();
                
                // å¦‚æœå½“å‰æœ‰å¯¹è¯å†…å®¹ï¼Œå…ˆä¿å­˜åˆ°å†å²è®°å½•
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                if (messagesContainer && messagesContainer.children.length > 0) {
                    await saveCurrentConversationToHistory();
                }
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå®Œæ•´æ¸…ç†æ‰€æœ‰å­˜å‚¨æœºåˆ¶
                await clearAllConversationData(userId);
                
                // æ¸…ç©ºå½“å‰å¯¹è¯æ˜¾ç¤º
                clearAllMessages();
                
                // ç”Ÿæˆæ–°çš„å¯¹è¯ID
                generateConversationId();
                
                // é‡ç½®å¯¹è¯çŠ¶æ€
                resetConversationState();
                
                // æ›´æ–°å¯¹è¯åˆ—è¡¨
                renderConversationList();
                
                console.log('âœ… æ–°å¯¹è¯åˆ›å»ºæˆåŠŸ');
                showMessage('æ–°å¯¹è¯å·²å¼€å§‹', 'success');
                
            } catch (error) {
                console.error('âŒ åˆ›å»ºæ–°å¯¹è¯å¤±è´¥:', error);
                showMessage('åˆ›å»ºæ–°å¯¹è¯å¤±è´¥', 'error');
            }
        }
        
        // ğŸ”‘ æ–°å¢ï¼šå®Œæ•´æ¸…ç†æ‰€æœ‰å¯¹è¯æ•°æ®çš„å‡½æ•°
        async function clearAllConversationData(userId) {
            try {
                if (!selectedDoctor) {
                    console.log('âš ï¸ æ²¡æœ‰é€‰æ‹©åŒ»ç”Ÿï¼Œè·³è¿‡æ•°æ®æ¸…ç†');
                    return;
                }
                
                console.log(`ğŸ§¹ å¼€å§‹æ¸…ç†ç”¨æˆ· ${userId} ä¸åŒ»ç”Ÿ ${selectedDoctor} çš„æ‰€æœ‰å¯¹è¯æ•°æ®`);
                
                // 1. æ¸…ç†localStorageä¸­çš„åŒ»ç”Ÿå†å²è®°å½•
                const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                localStorage.removeItem(historyKey);
                console.log(`ğŸ—‘ï¸ æ¸…ç†localStorageåŒ»ç”Ÿå†å²è®°å½•: ${historyKey}`);
                
                // 2. æ¸…ç†ChatGPTé£æ ¼å¯¹è¯è®°å½•ï¼ˆå½“å‰å¯¹è¯ï¼‰
                if (currentConversationId) {
                    const conversationKey = `conversation_${userId}_${currentConversationId}`;
                    localStorage.removeItem(conversationKey);
                    console.log(`ğŸ—‘ï¸ æ¸…ç†ChatGPTå¯¹è¯è®°å½•: ${conversationKey}`);
                }
                
                // 3. æ¸…ç†å¯¹è¯ç´¢å¼•ä¸­çš„ç›¸å…³è®°å½•
                const indexKey = `conversation_index_${userId}`;
                let index = JSON.parse(localStorage.getItem(indexKey) || '[]');
                const originalLength = index.length;
                index = index.filter(item => item.doctor !== selectedDoctor);
                if (index.length !== originalLength) {
                    localStorage.setItem(indexKey, JSON.stringify(index));
                    console.log(`ğŸ—‘ï¸ æ¸…ç†å¯¹è¯ç´¢å¼•ï¼Œåˆ é™¤äº† ${originalLength - index.length} æ¡è®°å½•`);
                }
                
                // 4. æ¸…ç†æ¶ˆæ¯å®¹å™¨çš„åŒ»ç”Ÿæ ‡è®°
                const containers = ['messagesContainer', 'mobileMessagesContainer'];
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.removeAttribute('data-current-doctor');
                        console.log(`ğŸ—‘ï¸ æ¸…ç†å®¹å™¨æ ‡è®°: ${containerId}`);
                    }
                });
                
                // 5. æ¸…ç†æœåŠ¡ç«¯æ•°æ®ï¼ˆå¯é€‰ï¼Œè°¨æ…æ“ä½œï¼‰
                try {
                    const response = await fetch('/api/conversation/clear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            doctor_id: selectedDoctor,
                            clear_type: 'all'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`âœ… æœåŠ¡ç«¯æ•°æ®æ¸…ç†æˆåŠŸ: ${result.message}`);
                    } else {
                        console.warn('âš ï¸ æœåŠ¡ç«¯æ•°æ®æ¸…ç†å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ');
                    }
                } catch (error) {
                    console.warn('âš ï¸ æœåŠ¡ç«¯æ•°æ®æ¸…ç†å‡ºé”™ï¼Œä½†ç»§ç»­æ‰§è¡Œ:', error);
                }
                
                console.log('âœ… æ‰€æœ‰å¯¹è¯æ•°æ®æ¸…ç†å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æ¸…ç†å¯¹è¯æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }
        
        // ä¿å­˜å½“å‰å¯¹è¯åˆ°å†å²è®°å½•
        async function saveCurrentConversationToHistory() {
            try {
                const userId = getCurrentUserId();
                if (!userId || !selectedDoctor) {
                    return;
                }
                
                // ä»DOMä¸­æå–å½“å‰æ¶ˆæ¯
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                
                if (!messagesContainer || messagesContainer.children.length === 0) {
                    return;
                }
                
                // æå–æ¶ˆæ¯å†…å®¹
                const extractedMessages = [];
                const messageElements = messagesContainer.querySelectorAll('.message');
                
                messageElements.forEach((messageEl, index) => {
                    const isUser = messageEl.classList.contains('user');
                    const messageTextEl = messageEl.querySelector('.message-text');
                    const content = messageTextEl ? messageTextEl.textContent.trim() : '';
                    
                    if (content) {
                        extractedMessages.push({
                            id: `msg_${Date.now()}_${index}`,
                            sender: isUser ? 'user' : 'ai',
                            content: content,
                            timestamp: new Date().toISOString(),
                            doctorKey: selectedDoctor
                        });
                    }
                });
                
                if (extractedMessages.length === 0) {
                    return;
                }
                
                const conversation = {
                    id: currentConversationId || generateConversationId(),
                    title: generateConversationTitle(extractedMessages),
                    doctor: selectedDoctor,
                    doctorName: getDoctorDisplayName(selectedDoctor),
                    messages: extractedMessages,
                    createdAt: extractedMessages[0]?.timestamp || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    messageCount: extractedMessages.length
                };
                
                // ä¿å­˜åˆ°localStorage
                const storageKey = `conversation_${userId}_${conversation.id}`;
                localStorage.setItem(storageKey, JSON.stringify(conversation));
                
                // æ›´æ–°å¯¹è¯ç´¢å¼•
                await updateConversationIndex(userId, conversation);
                
                console.log('ğŸ’¾ å¯¹è¯å·²ä¿å­˜åˆ°å†å²è®°å½•:', conversation.title);
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å¯¹è¯å†å²å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å¯¹è¯ç´¢å¼•
        async function updateConversationIndex(userId, conversation) {
            try {
                const indexKey = `conversation_index_${userId}`;
                let index = JSON.parse(localStorage.getItem(indexKey) || '[]');
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existingIndex = index.findIndex(item => item.id === conversation.id);
                
                const indexItem = {
                    id: conversation.id,
                    title: conversation.title,
                    doctor: conversation.doctor,
                    doctorName: conversation.doctorName,
                    createdAt: conversation.createdAt,
                    updatedAt: conversation.updatedAt,
                    messageCount: conversation.messageCount
                };
                
                if (existingIndex >= 0) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    index[existingIndex] = indexItem;
                } else {
                    // æ·»åŠ æ–°è®°å½•
                    index.unshift(indexItem);
                }
                
                // ä¿æŒæœ€å¤š50ä¸ªå¯¹è¯è®°å½•
                if (index.length > 50) {
                    const removedItems = index.slice(50);
                    index = index.slice(0, 50);
                    
                    // æ¸…ç†è¢«ç§»é™¤çš„å¯¹è¯æ•°æ®
                    removedItems.forEach(item => {
                        const storageKey = `conversation_${userId}_${item.id}`;
                        localStorage.removeItem(storageKey);
                    });
                }
                
                localStorage.setItem(indexKey, JSON.stringify(index));
                conversationHistory = index;
                
            } catch (error) {
                console.error('âŒ æ›´æ–°å¯¹è¯ç´¢å¼•å¤±è´¥:', error);
            }
        }
        
        // ç”Ÿæˆå¯¹è¯æ ‡é¢˜
        function generateConversationTitle(messages) {
            if (!messages || messages.length === 0) {
                return 'æ–°å¯¹è¯';
            }
            
            // ä»ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¸­æå–å…³é”®è¯ä½œä¸ºæ ‡é¢˜
            const firstUserMessage = messages.find(msg => msg.sender === 'user' || msg.type === 'user');
            if (firstUserMessage && firstUserMessage.content) {
                let title = firstUserMessage.content.slice(0, 20);
                if (firstUserMessage.content.length > 20) {
                    title += '...';
                }
                return title;
            }
            
            return `å¯¹è¯ ${new Date().toLocaleDateString()}`;
        }
        
        // åŠ è½½å¯¹è¯å†å²ç´¢å¼•
        function loadConversationIndex() {
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                const indexKey = `conversation_index_${userId}`;
                conversationHistory = JSON.parse(localStorage.getItem(indexKey) || '[]');
                
                console.log(`ğŸ“‹ åŠ è½½äº†${conversationHistory.length}ä¸ªå†å²å¯¹è¯`);
                
            } catch (error) {
                console.error('âŒ åŠ è½½å¯¹è¯å†å²å¤±è´¥:', error);
                conversationHistory = [];
            }
        }
        
        // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
        function renderConversationList() {
            const listContainer = document.getElementById('conversationList');
            if (!listContainer) return;
            
            if (conversationHistory.length === 0) {
                listContainer.innerHTML = `
                    <div class="conversation-item-empty">
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ’¬</div>
                            <div style="font-size: 14px;">æš‚æ— å†å²å¯¹è¯</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const currentId = currentConversationId;
            
            const listHTML = conversationHistory.map(conversation => {
                const isActive = conversation.id === currentId;
                const timeStr = formatConversationTime(conversation.updatedAt);
                
                return `
                    <div class="conversation-item ${isActive ? 'active' : ''}" 
                         onclick="loadConversation('${conversation.id}')"
                         data-conversation-id="${conversation.id}">
                        <div class="conversation-item-header">
                            <div class="conversation-title">${conversation.title}</div>
                            <button class="conversation-delete" 
                                    onclick="event.stopPropagation(); deleteConversation('${conversation.id}')"
                                    title="åˆ é™¤å¯¹è¯">
                                Ã—
                            </button>
                        </div>
                        <div class="conversation-info">
                            <span class="conversation-doctor">${conversation.doctorName}</span>
                            <span class="conversation-time">${timeStr}</span>
                        </div>
                        <div class="conversation-meta">
                            ${conversation.messageCount} æ¡æ¶ˆæ¯
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = listHTML;
        }
        
        // æ ¼å¼åŒ–å¯¹è¯æ—¶é—´
        function formatConversationTime(dateStr) {
            try {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return 'æ˜¨å¤©';
                } else if (diffDays < 7) {
                    return `${diffDays}å¤©å‰`;
                } else {
                    return date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
                }
            } catch {
                return '';
            }
        }
        
        // åŠ è½½æŒ‡å®šå¯¹è¯
        async function loadConversation(conversationId) {
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                // ä¿å­˜å½“å‰å¯¹è¯ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                if (messagesContainer && messagesContainer.children.length > 0 && currentConversationId !== conversationId) {
                    await saveCurrentConversationToHistory();
                }
                
                // ä»localStorageåŠ è½½å¯¹è¯æ•°æ®
                const storageKey = `conversation_${userId}_${conversationId}`;
                const conversationData = localStorage.getItem(storageKey);
                
                if (!conversationData) {
                    showMessage('å¯¹è¯è®°å½•ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const conversation = JSON.parse(conversationData);
                
                // æ¸…ç©ºå½“å‰æ˜¾ç¤º
                clearAllMessages();
                
                // è®¾ç½®å¯¹è¯çŠ¶æ€
                currentConversationId = conversationId;
                selectedDoctor = conversation.doctor;
                
                // æ›´æ–°UI
                updateDoctorSelection(conversation.doctor);
                
                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
                conversation.messages.forEach(message => {
                    const sender = message.sender || message.type; // å…¼å®¹æ–°æ—§æ ¼å¼
                    if (sender === 'user') {
                        addMessage('user', message.content);
                    } else if (sender === 'ai') {
                        addMessage('ai', message.content, false, false, message.prescriptionData);
                    }
                });
                
                // æ›´æ–°å¯¹è¯åˆ—è¡¨æ˜¾ç¤º
                renderConversationList();
                
                // ä¿å­˜å½“å‰å¯¹è¯ID
                const storageKeyConv = `conversationId_${userId}`;
                localStorage.setItem(storageKeyConv, conversationId);
                
                console.log('âœ… å¯¹è¯åŠ è½½æˆåŠŸ:', conversation.title);
                showMessage('å¯¹è¯å·²åˆ‡æ¢', 'success');
                
            } catch (error) {
                console.error('âŒ åŠ è½½å¯¹è¯å¤±è´¥:', error);
                showMessage('åŠ è½½å¯¹è¯å¤±è´¥', 'error');
            }
        }
        
        // åˆ é™¤å¯¹è¯
        async function deleteConversation(conversationId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                // ä»localStorageåˆ é™¤å¯¹è¯æ•°æ®
                const storageKey = `conversation_${userId}_${conversationId}`;
                localStorage.removeItem(storageKey);
                
                // ä»ç´¢å¼•ä¸­ç§»é™¤
                const indexKey = `conversation_index_${userId}`;
                let index = JSON.parse(localStorage.getItem(indexKey) || '[]');
                index = index.filter(item => item.id !== conversationId);
                localStorage.setItem(indexKey, JSON.stringify(index));
                
                // æ›´æ–°å†…å­˜ä¸­çš„å†å²è®°å½•
                conversationHistory = index;
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯
                if (currentConversationId === conversationId) {
                    clearAllMessages();
                    generateConversationId();
                    resetConversationState();
                }
                
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                renderConversationList();
                
                console.log('ğŸ—‘ï¸ å¯¹è¯å·²åˆ é™¤:', conversationId);
                showMessage('å¯¹è¯å·²åˆ é™¤', 'success');
                
            } catch (error) {
                console.error('âŒ åˆ é™¤å¯¹è¯å¤±è´¥:', error);
                showMessage('åˆ é™¤å¯¹è¯å¤±è´¥', 'error');
            }
        }
        
        // é‡ç½®å¯¹è¯çŠ¶æ€
        function resetConversationState() {
            messages = [];
            currentStage = 'initial_inquiry';
            // ä¿æŒselectedDoctorä¸å˜ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥ç»§ç»­å’ŒåŒä¸€ä¸ªåŒ»ç”Ÿå¯¹è¯
        }
        
        // æ›´æ–°åŒ»ç”Ÿé€‰æ‹©å™¨æ˜¾ç¤º
        function updateDoctorSelection(doctorKey) {
            const doctorSelector = document.getElementById('doctorSelector');
            if (doctorSelector) {
                doctorSelector.value = doctorKey;
            }
            
            // è§¦å‘åŒ»ç”Ÿé€‰æ‹©äº‹ä»¶ï¼Œä½†ä¸ç”Ÿæˆæ–°çš„å¯¹è¯ID
            const originalConversationId = currentConversationId;
            selectDoctor(doctorKey);
            currentConversationId = originalConversationId;
        }
        
        
        // ç§»åŠ¨ç«¯è¾¹æ æ§åˆ¶
        function openMobileSidebar() {
            const sidebar = document.getElementById('conversationSidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            
            sidebar.classList.add('show', 'mobile-open');
            sidebar.classList.remove('collapsed');
            overlay.style.display = 'block';
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('conversationSidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            const trigger = document.getElementById('conversationHistoryTrigger');
            
            sidebar.classList.remove('show', 'mobile-open');
            sidebar.classList.add('collapsed');
            overlay.style.display = 'none';
            if (trigger) trigger.textContent = 'ğŸ’¬ å¯¹è¯';
        }
        
        // æ¶ˆæ¯å‘é€åæ›´æ–°å¯¹è¯åˆ—è¡¨
        async function updateConversationListAfterMessage() {
            try {
                // é‡å»ºmessagesæ•°ç»„ï¼ˆä»DOMè·å–å½“å‰æ‰€æœ‰æ¶ˆæ¯ï¼‰
                const messageElements = document.querySelectorAll('.message');
                const currentMessages = [];
                
                messageElements.forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    const prescriptionData = messageEl.getAttribute('data-prescription-id');
                    
                    if (textEl) {
                        const messageData = {
                            type: isUser ? 'user' : 'ai',
                            content: textEl.textContent.trim(),
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: new Date().toISOString()
                        };
                        
                        if (prescriptionData) {
                            messageData.prescriptionData = { prescriptionId: prescriptionData };
                        }
                        
                        currentMessages.push(messageData);
                    }
                });
                
                // æ›´æ–°å…¨å±€messagesæ•°ç»„
                messages = currentMessages;
                
                // å¦‚æœæœ‰æ¶ˆæ¯ï¼Œè‡ªåŠ¨ä¿å­˜å½“å‰å¯¹è¯
                if (messages.length > 0) {
                    await saveCurrentConversationToHistory();
                    renderConversationList();
                }
                
            } catch (error) {
                console.error('âŒ æ›´æ–°å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // å¤šå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        let tongueImage = null;
        let faceImage = null;

        // æ¡Œé¢ç«¯ - èˆŒè¯Šå›¾ç‰‡ä¸Šä¼ 
        function triggerTongueUpload() {
            document.getElementById('tongueImageUpload').click();
        }

        function handleTongueImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                const uploadArea = document.getElementById('tongueUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">èˆŒè¯Šç…§ç‰‡å·²é€‰æ‹©</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // æ¡Œé¢ç«¯ - é¢è¯Šå›¾ç‰‡ä¸Šä¼ 
        function triggerFaceUpload() {
            document.getElementById('faceImageUpload').click();
        }

        function handleFaceImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                const uploadArea = document.getElementById('faceUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">é¢è¯Šç…§ç‰‡å·²é€‰æ‹©</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // ç§»åŠ¨ç«¯ - æ˜¾ç¤ºå›¾ç‰‡é€‰æ‹©å¼¹çª—ï¼ˆå¾®ä¿¡å…¼å®¹ä¼˜åŒ–å¢å¼ºç‰ˆï¼‰
        function showMobileImageOptions() {
            console.log('ğŸ”„ å°è¯•æ˜¾ç¤ºç§»åŠ¨ç«¯å›¾ç‰‡é€‰æ‹©å¼¹çª—...');
            
            try {
                const modal = document.getElementById('mobileImageModal');
                console.log('ğŸ” å¼¹çª—å…ƒç´ æŸ¥æ‰¾ç»“æœ:', modal ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                
                if (modal) {
                    // æ–¹æ³•1: ç«‹å³æ˜¾ç¤ºå¼¹çª—
                    console.log('ğŸ“± æ–¹æ³•1: ç«‹å³æ˜¾ç¤ºå¼¹çª—');
                    setModalVisible(modal);
                    
                    // æ–¹æ³•2: å»¶è¿Ÿ100mså†æ¬¡ç¡®è®¤æ˜¾ç¤ºï¼ˆå¤„ç†æ¸²æŸ“å»¶è¿Ÿï¼‰
                    setTimeout(() => {
                        console.log('ğŸ“± æ–¹æ³•2: å»¶è¿Ÿç¡®è®¤æ˜¾ç¤º');
                        const computedStyle = window.getComputedStyle(modal);
                        if (computedStyle.display === 'none') {
                            console.log('âš ï¸  å¼¹çª—ä»æœªæ˜¾ç¤ºï¼Œå¼ºåˆ¶æ˜¾ç¤º');
                            forceShowModal(modal);
                        } else {
                            console.log('âœ… å¼¹çª—æ˜¾ç¤ºæˆåŠŸ');
                        }
                    }, 100);
                    
                    // æ–¹æ³•3: å¾®ä¿¡ç¯å¢ƒç‰¹æ®Šå¤„ç†
                    if (isWeChatBrowser()) {
                        setTimeout(() => {
                            console.log('ğŸ“± æ–¹æ³•3: å¾®ä¿¡ç¯å¢ƒç‰¹æ®Šå¤„ç†');
                            wechatModalFix(modal);
                        }, 200);
                    }
                    
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°ç§»åŠ¨ç«¯å›¾ç‰‡é€‰æ‹©å¼¹çª—å…ƒç´ ï¼Œä½¿ç”¨fallbackæ–¹æ³•');
                    // Fallback: ç›´æ¥è§¦å‘æ–‡ä»¶é€‰æ‹©
                    if (confirm('ğŸ“· é€‰æ‹©å›¾ç‰‡ç±»å‹ï¼š\n\nç¡®å®š = ğŸ‘… èˆŒè¯Šç…§ç‰‡\nå–æ¶ˆ = ğŸ˜Š é¢è¯Šç…§ç‰‡')) {
                        console.log('ç”¨æˆ·é€‰æ‹©èˆŒè¯Šç…§ç‰‡');
                        document.getElementById('mobileTongueUpload').click();
                    } else {
                        console.log('ç”¨æˆ·é€‰æ‹©é¢è¯Šç…§ç‰‡');
                        document.getElementById('mobileFaceUpload').click();
                    }
                }
            } catch (error) {
                console.error('âŒ æ˜¾ç¤ºå¼¹çª—æ—¶å‡ºé”™:', error);
                // æœ€ç®€å•çš„fallback
                alert('å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•\n\né”™è¯¯: ' + error.message);
            }
        }
        
        // è®¾ç½®å¼¹çª—å¯è§çš„æ ¸å¿ƒå‡½æ•°
        function setModalVisible(modal) {
            console.log('ğŸ¯ è®¾ç½®å¼¹çª—æ ·å¼...');
            
            // ä½¿ç”¨CSSç±»åˆ‡æ¢ï¼ˆæ›´å¯é ï¼‰
            modal.classList.remove('mobile-modal-hidden');
            modal.classList.add('mobile-modal-visible');
            
            // åŒæ—¶è®¾ç½®å†…è”æ ·å¼ä½œä¸ºåŒé‡ä¿é™©
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0, 0, 0, 0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
            
            console.log('âœ… å¼¹çª—æ ·å¼è®¾ç½®å®Œæˆ - ç±»åå’Œå†…è”æ ·å¼åŒé‡è®¾ç½®');
        }
        
        // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—
        function forceShowModal(modal) {
            console.log('ğŸ”¥ å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—');
            
            // å®Œå…¨é‡ç½®æ ·å¼
            modal.removeAttribute('style');
            modal.removeAttribute('class');
            
            // ä½¿ç”¨ !important å¼ºåˆ¶æ˜¾ç¤º
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.8) !important;
                z-index: 999999 !important;
                justify-content: center !important;
                align-items: center !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            console.log('ğŸ”¥ å¼ºåˆ¶æ ·å¼åº”ç”¨å®Œæˆ');
        }
        
        // å¾®ä¿¡ç¯å¢ƒç‰¹æ®Šä¿®å¤
        function wechatModalFix(modal) {
            console.log('ğŸ”§ å¾®ä¿¡ç¯å¢ƒä¿®å¤');
            
            // å¾®ä¿¡æµè§ˆå™¨å¯èƒ½éœ€è¦è§¦å‘é‡ç»˜
            modal.style.transform = 'translateZ(0)';
            modal.offsetHeight; // å¼ºåˆ¶é‡ç»˜
            modal.style.transform = '';
            
            // ç¡®ä¿å†…å®¹å…ƒç´ ä¹Ÿå¯è§
            const content = modal.querySelector('.mobile-image-modal-content');
            if (content) {
                content.style.display = 'block';
                content.style.visibility = 'visible';
                content.style.opacity = '1';
                console.log('ğŸ”§ å¼¹çª—å†…å®¹å…ƒç´ æ ·å¼ä¿®å¤å®Œæˆ');
            }
        }
        
        // æ£€æµ‹æ˜¯å¦ä¸ºå¾®ä¿¡æµè§ˆå™¨
        function isWeChatBrowser() {
            return navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1;
        }

        function closeMobileImageModal() {
            console.log('ğŸ”„ å…³é—­ç§»åŠ¨ç«¯å›¾ç‰‡é€‰æ‹©å¼¹çª—');
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                // ä½¿ç”¨CSSç±»éšè—
                modal.classList.remove('mobile-modal-visible');
                modal.classList.add('mobile-modal-hidden');
                
                // åŒæ—¶è®¾ç½®å†…è”æ ·å¼
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                
                // æ¢å¤èƒŒæ™¯æ»šåŠ¨
                document.body.style.overflow = 'auto';
                
                console.log('âœ… ç§»åŠ¨ç«¯å›¾ç‰‡é€‰æ‹©å¼¹çª—å·²å…³é—­');
            } else {
                console.error('âŒ æœªæ‰¾åˆ°å¼¹çª—å…ƒç´ ');
            }
        }

        // è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥å¼¹çª—çŠ¶æ€
        function debugModalState() {
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                console.log('å¼¹çª—å…ƒç´ å­˜åœ¨');
                console.log('å¼¹çª—display:', window.getComputedStyle(modal).display);
                console.log('å¼¹çª—ä½ç½®:', modal.getBoundingClientRect());
                console.log('å¼¹çª—zIndex:', window.getComputedStyle(modal).zIndex);
                console.log('å±å¹•å°ºå¯¸:', window.innerWidth + 'x' + window.innerHeight);
            } else {
                console.error('å¼¹çª—å…ƒç´ ä¸å­˜åœ¨');
            }
        }

        // ç§»åŠ¨ç«¯ - èˆŒè¯Šå›¾ç‰‡ä¸Šä¼ 
        function triggerMobileTongueUpload() {
            closeMobileImageModal();
            document.getElementById('mobileTongueUpload').click();
        }

        function handleMobileTongueUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // ç§»åŠ¨ç«¯ - é¢è¯Šå›¾ç‰‡ä¸Šä¼ 
        function triggerMobileFaceUpload() {
            closeMobileImageModal();
            document.getElementById('mobileFaceUpload').click();
        }

        function handleMobileFaceUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // æ›´æ–°ä¸Šä¼ çŠ¶æ€æ˜¾ç¤º
        function updateUploadStatus() {
            const statusDiv = document.getElementById('uploadStatus');
            const tongueStatus = document.getElementById('tongueStatus').querySelector('span');
            const faceStatus = document.getElementById('faceStatus').querySelector('span');

            tongueStatus.textContent = tongueImage ? 'å·²ä¸Šä¼ ' : 'æœªä¸Šä¼ ';
            faceStatus.textContent = faceImage ? 'å·²ä¸Šä¼ ' : 'æœªä¸Šä¼ ';

            if (tongueImage || faceImage) {
                statusDiv.style.display = 'block';
            }
        }

        // æ›´æ–°ç§»åŠ¨ç«¯ä¸Šä¼ çŠ¶æ€
        function updateMobileUploadStatus() {
            const mobileTongueStatus = document.getElementById('mobileTongueStatus').querySelector('span');
            const mobileFaceStatus = document.getElementById('mobileFaceStatus').querySelector('span');

            mobileTongueStatus.textContent = tongueImage ? 'å·²ä¸Šä¼ ' : 'æœªä¸Šä¼ ';
            mobileFaceStatus.textContent = faceImage ? 'å·²ä¸Šä¼ ' : 'æœªä¸Šä¼ ';

            // æ›´æ–°è§¦å‘æŒ‰é’®æ–‡æœ¬
            const uploadText = document.getElementById('mobileUploadText');
            const uploadedCount = (tongueImage ? 1 : 0) + (faceImage ? 1 : 0);
            if (uploadedCount > 0) {
                uploadText.textContent = `å·²é€‰æ‹© ${uploadedCount} å¼ å›¾ç‰‡`;
            }
        }

        // å¤šå›¾ç‰‡ä¸Šä¼ æ ¸å¿ƒå‡½æ•°
        async function uploadImages() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡éœ€è¦ä¸Šä¼ 
            if (!tongueImage && !faceImage) {
                return;
            }

            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!checkNetworkStatus()) {
                return;
            }

            const formData = new FormData();
            formData.append('conversation_id', currentConversationId);
            
            // æ ¹æ®å›¾ç‰‡ç±»å‹åˆ†åˆ«æ·»åŠ 
            if (tongueImage) {
                formData.append('tongue_image', tongueImage);
            }
            if (faceImage) {
                formData.append('face_image', faceImage);
            }

            try {
                // æ„å»ºä¸Šä¼ æç¤ºæ¶ˆæ¯
                let uploadMessage = 'ğŸ“· æ­£åœ¨åˆ†æ';
                if (tongueImage && faceImage) {
                    uploadMessage += 'èˆŒè¯Šå’Œé¢è¯Šå›¾ç‰‡...';
                } else if (tongueImage) {
                    uploadMessage += 'èˆŒè¯Šå›¾ç‰‡...';
                } else if (faceImage) {
                    uploadMessage += 'é¢è¯Šå›¾ç‰‡...';
                }
                
                addMessage('user', uploadMessage);
                
                const response = await fetch('/analyze_images', {
                    method: 'POST',
                    body: formData,
                    // æ·»åŠ è¶…æ—¶æ§åˆ¶
                    signal: AbortSignal.timeout(120000), // 2åˆ†é’Ÿè¶…æ—¶
                    headers: {
                        // ä¸è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®multipart/form-data
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const analysisResult = `å›¾åƒåˆ†æç»“æœï¼š
${data.analysis_result}`;  
                const shouldShowImageFeedback = containsPrescription(analysisResult);
                addMessage('ai', analysisResult, shouldShowImageFeedback);

                // åˆ†æå®Œæˆåæ¸…ç©ºå›¾ç‰‡ç¼“å­˜ï¼Œå…è®¸ç”¨æˆ·é‡æ–°ä¸Šä¼ 
                resetImageUploads();

            } catch (error) {
                console.error('ğŸ“· å›¾åƒä¸Šä¼ å®Œæ•´é”™è¯¯ä¿¡æ¯:', error);
                
                let errorMessage = 'å›¾åƒåˆ†æå¤±è´¥ï¼š';
                
                if (error.message.includes('502')) {
                    errorMessage += 'æœåŠ¡å™¨æš‚æ—¶æ— æ³•å¤„ç†è¯·æ±‚ (502)ã€‚å¯èƒ½åŸå› ï¼š\n';
                    errorMessage += 'â€¢ AIæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•\n';
                    errorMessage += 'â€¢ å›¾ç‰‡å¤„ç†è¶…æ—¶\n';
                    errorMessage += 'â€¢ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('timeout')) {
                    errorMessage += 'è¯·æ±‚è¶…æ—¶ã€‚è¯·æ£€æŸ¥ï¼š\n';
                    errorMessage += 'â€¢ ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š\n';
                    errorMessage += 'â€¢ å›¾ç‰‡å¤§å°æ˜¯å¦è¿‡å¤§\n';
                    errorMessage += 'â€¢ ç¨åé‡è¯•';
                } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                    errorMessage += 'ç½‘ç»œè¿æ¥é—®é¢˜ã€‚è¯·æ£€æŸ¥ï¼š\n';
                    errorMessage += 'â€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n';
                    errorMessage += 'â€¢ æ˜¯å¦ä½¿ç”¨äº†ä»£ç†æˆ–VPN\n';
                    errorMessage += 'â€¢ åˆ·æ–°é¡µé¢åé‡è¯•';
                } else {
                    errorMessage += error.message;
                }
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒæ˜¾ç¤ºï¼‰
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    errorMessage += `\n\n[è°ƒè¯•ä¿¡æ¯]\nå¯¹è¯ID: ${currentConversationId}\né”™è¯¯ç±»å‹: ${error.constructor.name}\næ—¶é—´: ${new Date().toLocaleString()}`;
                }
                
                addMessage('ai', errorMessage);
                
                // é‡ç½®ä¸Šä¼ çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·é‡è¯•
                resetImageUploads();
            }
        }

        // é‡ç½®å›¾ç‰‡ä¸Šä¼ çŠ¶æ€
        function resetImageUploads() {
            tongueImage = null;
            faceImage = null;
            
            // é‡ç½®æ¡Œé¢ç«¯ç•Œé¢
            const tongueUploadArea = document.getElementById('tongueUploadArea');
            const faceUploadArea = document.getElementById('faceUploadArea');
            
            if (tongueUploadArea) {
                tongueUploadArea.classList.remove('has-file');
                tongueUploadArea.innerHTML = `
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">ç‚¹å‡»ä¸Šä¼ èˆŒè¯Šç…§ç‰‡</div>
                `;
            }
            
            if (faceUploadArea) {
                faceUploadArea.classList.remove('has-file');
                faceUploadArea.innerHTML = `
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">ç‚¹å‡»ä¸Šä¼ é¢è¯Šç…§ç‰‡</div>
                `;
            }

            // éšè—ä¸Šä¼ çŠ¶æ€
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }

            // é‡ç½®ç§»åŠ¨ç«¯æŒ‰é’®æ–‡æœ¬
            const uploadText = document.getElementById('mobileUploadText');
            if (uploadText) {
                uploadText.textContent = 'ä¸Šä¼ èˆŒè‹”å’Œé¢è±¡ç…§ç‰‡';
            }
        }

        // ä¿ç•™åŸuploadImageå‡½æ•°ä½œä¸ºå…¼å®¹æ€§æ”¯æŒï¼ˆå·²åºŸå¼ƒä½¿ç”¨ï¼‰
        async function uploadImage(file) {
            console.warn('uploadImageå‡½æ•°å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨uploadImageså‡½æ•°');
            // å¯é€‰ï¼šä¸ºäº†å…¼å®¹æ€§ï¼Œå°†å•å›¾ç‰‡è½¬æ¢ä¸ºå¤šå›¾ç‰‡æ¨¡å¼
            tongueImage = file; // å‡è®¾å•å›¾ç‰‡é»˜è®¤ä¸ºèˆŒè¯Š
            uploadImages();
        }

        // è¯­éŸ³åŠŸèƒ½
        function toggleVoiceRecording() {
            if (isVoiceRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        async function startVoiceRecording() {
                        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processVoiceInput(audioBlob);
                };

                mediaRecorder.start();
                isVoiceRecording = true;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = 'åœæ­¢å½•éŸ³';
                voiceBtn.classList.add('recording');

            } catch (error) {
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && isVoiceRecording) {
                mediaRecorder.stop();
                isVoiceRecording = false;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = 'å¼€å§‹è¯­éŸ³è¾“å…¥';
                voiceBtn.classList.remove('recording');
            }
        }

        async function processVoiceInput(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'voice.webm');

                        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/speech_to_text', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.text) {
                    document.getElementById('messageInput').value = data.text;
                    adjustTextareaHeight();
                }

            } catch (error) {
                addMessage('ai', `è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼š${error.message}`);
            }
        }

        // è¯­éŸ³åˆæˆ
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
            }
        }

        
        // æ£€æµ‹å›å¤æ˜¯å¦åŒ…å«å¤„æ–¹ï¼ˆä½¿ç”¨æ¸²æŸ“å™¨çš„ç»Ÿä¸€é€»è¾‘ï¼‰
        function containsPrescription(text) {
            // é˜²æ­¢undefinedé”™è¯¯
            if (!text || typeof text !== 'string') {
                console.warn('containsPrescription: æ— æ•ˆçš„æ–‡æœ¬å‚æ•°', text);
                return false;
            }
            
            // ä½¿ç”¨å¤„æ–¹æ¸²æŸ“å™¨çš„ç»Ÿä¸€æ£€æµ‹é€»è¾‘
            if (window.prescriptionContentRenderer) {
                return window.prescriptionContentRenderer.containsPrescription(text);
            }
            
            // å¤‡ç”¨æ£€æµ‹é€»è¾‘ï¼ˆå¦‚æœæ¸²æŸ“å™¨æœªåŠ è½½ï¼‰
            const hasHerbs = /[å½“å½’|å…šå‚|é»„èŠª|ç™½æœ¯|èŒ¯è‹“|ç”˜è‰|ç”Ÿåœ°|ç†Ÿåœ°|å·èŠ|ç™½èŠ|æŸ´èƒ¡|é»„èŠ©|åŠå¤|é™ˆçš®]/.test(text);
            const hasDosage = /\d+[å…‹g]/.test(text);
            const hasPrescriptionKeyword = /å¤„æ–¹|æ–¹å‰‚|è¯æ–¹|ç»„æ–¹/.test(text);
            
            return (hasHerbs && hasDosage) || hasPrescriptionKeyword;
        }

        // é—ç•™ä»£ç ä¿ç•™ï¼ˆä¸ºäº†å‘åå…¼å®¹ï¼‰
        function containsPrescription_legacy(text) {
            // å¤„æ–¹å…³é”®è¯æ£€æµ‹
            const prescriptionKeywords = [
                'å¤„æ–¹', 'æ–¹å‰‚', 'è¯æ–¹', 'ä¸­è¯', 'æœç”¨', 'ç…æœ', 'æ¯æ—¥', 'å…‹', 'g',
                'æ–¹ç”¨', 'æ–¹å–', 'ç»„æˆ', 'ç”¨æ³•', 'ç”¨é‡', 'ç…ç…®', 'æœæ³•',
                'å…šå‚', 'é»„èŠª', 'å½“å½’', 'ç™½æœ¯', 'èŒ¯è‹“', 'ç”˜è‰', 'ç”Ÿåœ°', 'ç†Ÿåœ°',
                'å·èŠ', 'ç™½èŠ', 'æŸ´èƒ¡', 'é»„èŠ©', 'åŠå¤', 'é™ˆçš®', 'æ³å£³', 'æ¡”æ¢—'
            ];
            
            // XMLæ ¼å¼å¤„æ–¹æ£€æµ‹
            const xmlPrescriptionPattern = /<prescription>.*?<\/prescription>/s;
            if (xmlPrescriptionPattern.test(text)) {
                return true;
            }
            
            // æ ‡å‡†å¤„æ–¹æ ¼å¼æ£€æµ‹
            const standardPrescriptionPattern = /ã€å¤„æ–¹ã€‘|ã€æ–¹å‰‚ã€‘|ã€è¯æ–¹ã€‘|ã€ä¸­è¯å¤„æ–¹ã€‘/;
            if (standardPrescriptionPattern.test(text)) {
                return true;
            }
            
            // å…³é”®è¯ç»„åˆæ£€æµ‹ - è‡³å°‘åŒ…å«2ä¸ªå¤„æ–¹ç›¸å…³è¯æ±‡
            let keywordCount = 0;
            for (const keyword of prescriptionKeywords) {
                if (text.includes(keyword)) {
                    keywordCount++;
                }
            }
            
            return keywordCount >= 2;
        }

        // åé¦ˆè¯„åˆ†
        function rateFeedback(button, rating) {
            const ratingButtons = button.parentElement.querySelectorAll('.rating-btn');
            ratingButtons.forEach(btn => btn.disabled = true);
            
            button.style.backgroundColor = '#10b981';
            button.style.color = 'white';
            
            submitFeedback(rating);
        }

        async function submitFeedback(rating) {
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!checkNetworkStatus()) {
                return;
            }
            
            try {
                const response = await fetch('/api/review/feedback', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        doctor_id: selectedDoctor,
                        rating: rating,
                        feedback_type: 'consultation',
                        user_id: currentUser ? currentUser.id : null,
                        timestamp: new Date().toISOString()
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`æ„Ÿè°¢æ‚¨çš„${rating}æ˜Ÿè¯„ä»·ï¼`, 'success');
                } else {
                    console.error('åé¦ˆæäº¤å¤±è´¥:', result.message);
                }
                
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // ===================== è®¤è¯ç³»ç»Ÿ =====================
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€ - ä½¿ç”¨ç»Ÿä¸€è®¤è¯ç®¡ç†å™¨
        function checkLoginStatus() {
            console.log('ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€...');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è®¿å®¢æ¨¡å¼
            const urlParams = new URLSearchParams(window.location.search);
            const isGuestMode = urlParams.get('mode') === 'guest';
            
            // ä½¿ç”¨authManageræ£€æŸ¥ç™»å½•çŠ¶æ€
            const user = window.authManager.getCurrentUser();
            const token = window.authManager.getToken();
            
            console.log('ğŸ“‹ ç™»å½•çŠ¶æ€æ£€æŸ¥ç»“æœ:', {
                isGuestMode,
                isLoggedIn: window.authManager.isLoggedIn(),
                hasUser: !!user,
                hasToken: !!token,
                username: user?.username || user?.display_name
            });
            
            if (window.authManager.isLoggedIn()) {
                // å·²ç™»å½• - ç›´æ¥ä½¿ç”¨
                currentUser = user;
                userToken = token;
                console.log('âœ… ç™»å½•çŠ¶æ€æœ‰æ•ˆï¼Œç”¨æˆ·:', user.username || user.display_name, 'è§’è‰²:', user.primary_role);
                updateUserInterface(true);
            } else if (token) {
                // æœ‰tokenä½†ç”¨æˆ·ä¿¡æ¯ç¼ºå¤± - å°è¯•ä»åç«¯éªŒè¯
                console.log('âš ï¸ æœ‰tokenä½†ç¼ºå°‘å®Œæ•´ç”¨æˆ·æ•°æ®ï¼Œå°è¯•éªŒè¯...');
                verifyTokenAndLoadUserData(token);
            } else if (isGuestMode) {
                // è®¿å®¢æ¨¡å¼ - å…è®¸æ— ç™»å½•è®¿é—®
                console.log('â„¹ï¸ è®¿å®¢æ¨¡å¼ï¼šå…è®¸æ— ç™»å½•è®¿é—®');
                updateUserInterface(false);
            } else {
                // éè®¿å®¢æ¨¡å¼ä¸”æ— token - è·³è½¬åˆ°ç™»å½•é¡µ
                console.log('âŒ æœªæ£€æµ‹åˆ°æœ‰æ•ˆç™»å½•çŠ¶æ€ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                showMessage('è¯·å…ˆç™»å½•åä½¿ç”¨æ™ºèƒ½é—®è¯ŠæœåŠ¡', 'warning');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
        }
        
        // éªŒè¯tokenå¹¶åŠ è½½ç”¨æˆ·æ•°æ® - ä½¿ç”¨ç»Ÿä¸€è®¤è¯ç®¡ç†å™¨
        async function verifyTokenAndLoadUserData(token) {
            console.log('ğŸ”„ éªŒè¯tokenå¹¶åŠ è½½ç”¨æˆ·æ•°æ®...');
            
            const user = await window.authManager.verifyToken(token);
            
            if (user) {
                currentUser = user;
                userToken = token;
                console.log('âœ… ä»åç«¯éªŒè¯æˆåŠŸï¼Œç”¨æˆ·:', user.username || user.display_name);
                updateUserInterface(true);
            } else {
                console.log('âŒ TokenéªŒè¯å¤±è´¥ï¼Œæ¸…é™¤æ•°æ®');
                window.authManager.clearLoginState();
                // è·³è½¬åˆ°ç™»å½•é¡µ
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1000);
            }
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserInterface(isLoggedIn) {
            console.log('ğŸ”„ å¼€å§‹æ›´æ–°ç”¨æˆ·ç•Œé¢ï¼Œç™»å½•çŠ¶æ€:', isLoggedIn);
            
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!authButtons || !userInfo || !userAvatar || !userName) {
                console.error('âŒ ç”¨æˆ·ç•Œé¢å…ƒç´ ç¼ºå¤±:', {
                    authButtons: !!authButtons,
                    userInfo: !!userInfo,
                    userAvatar: !!userAvatar,
                    userName: !!userName
                });
                return;
            }
            
            if (isLoggedIn) {
                // ä»å¤šä¸ªæ¥æºè·å–ç”¨æˆ·æ•°æ®
                let userData = null;
                
                // 1. å°è¯•ä»å…¨å±€å˜é‡è·å–
                if (currentUser) {
                    userData = currentUser;
                    console.log('ğŸ”‘ ä»å…¨å±€å˜é‡è·å–ç”¨æˆ·æ•°æ®:', userData);
                }
                
                // 2. å°è¯•ä»localStorageè·å–
                if (!userData) {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        try {
                            userData = JSON.parse(storedUser);
                            console.log('ğŸ”‘ ä»localStorageè·å–ç”¨æˆ·æ•°æ®:', userData);
                        } catch (e) {
                            console.error('âŒ è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                        }
                    }
                }
                
                // 3. å°è¯•ä»authManagerè·å–
                if (!userData && window.authManager) {
                    userData = window.authManager.getCurrentUser();
                    if (userData) {
                        console.log('ğŸ”‘ ä»authManagerè·å–ç”¨æˆ·æ•°æ®:', userData);
                    }
                }
                
                if (userData) {
                    // éšè—ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    authButtons.style.display = 'none';
                    userInfo.style.display = 'flex';
                    
                    // å¤„ç†ç”¨æˆ·æ˜¾ç¤ºåç§°
                    let displayName = 'ç”¨æˆ·';
                    if (userData.username) {
                        displayName = userData.username;
                    } else if (userData.name) {
                        displayName = userData.name;
                    } else if (userData.display_name) {
                        displayName = userData.display_name;
                    } else if (userData.phone) {
                        displayName = userData.phone;
                    } else if (userData.user_id || userData.id || userData.global_user_id) {
                        // å°†user_idè½¬æ¢ä¸ºå‹å¥½çš„æ˜¾ç¤ºåç§°
                        const userId = userData.global_user_id || userData.user_id || userData.id;
                        if (userId.includes('patient')) {
                            displayName = 'æ‚£è€…ç”¨æˆ·';
                        } else if (userId.includes('doctor')) {
                            displayName = 'åŒ»ç”Ÿç”¨æˆ·';
                        } else if (userId.includes('admin')) {
                            displayName = 'ç®¡ç†å‘˜';
                        } else {
                            displayName = userId.substring(0, 12) + '...';
                        }
                    }
                    
                    // æ›´æ–°DOM
                    userName.textContent = displayName;
                    userAvatar.textContent = displayName.charAt(0).toUpperCase();
                    
                    // åŒæ­¥å…¨å±€å˜é‡
                    if (!currentUser) {
                        currentUser = userData;
                    }
                    
                    console.log('âœ… ç”¨æˆ·ç•Œé¢æ›´æ–°å®Œæˆ - å·²ç™»å½•çŠ¶æ€:', {
                        displayName,
                        userId: userData.global_user_id || userData.user_id || userData.id,
                        userDataKeys: Object.keys(userData)
                    });
                } else {
                    // userDataä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
                    console.warn('âš ï¸ ç™»å½•çŠ¶æ€ä¸ºtrueä½†æ— æ³•è·å–ç”¨æˆ·æ•°æ®ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®');
                    authButtons.style.display = 'flex';
                    userInfo.style.display = 'none';
                }
            } else {
                // æœªç™»å½•çŠ¶æ€
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
                console.log('â„¹ï¸ ç”¨æˆ·ç•Œé¢æ›´æ–°å®Œæˆ - æœªç™»å½•çŠ¶æ€');
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // éšè—ç™»å½•æ¨¡æ€æ¡†
        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'none';
        }

        // æ‰§è¡Œç™»å½•
        async function performLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.user) {
                    // ç™»å½•æˆåŠŸ
                    currentUser = result.user;
                    userToken = result.token;
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('userData', JSON.stringify(currentUser));
                    localStorage.setItem('userToken', userToken);
                    
                    // æ›´æ–°ç•Œé¢
                    updateUserInterface(true);
                    hideLoginModal();
                    
                    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                    const welcomeName = currentUser.username || currentUser.name || currentUser.phone || 'ç”¨æˆ·';
                    showMessage(`æ¬¢è¿å›æ¥ï¼Œ${welcomeName}ï¼`, 'success');
                    
                } else {
                    errorDiv.textContent = result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                errorDiv.style.display = 'block';
            }
        }

        // æ³¨æ„ï¼šåŸæœ‰çš„æ‰‹åŠ¨åŒæ­¥åŠŸèƒ½å·²è¢«è‡ªåŠ¨åŒæ­¥ç®¡ç†å™¨æ›¿ä»£
        // æ–°çš„è‡ªåŠ¨åŒæ­¥ç³»ç»Ÿæ— éœ€æ‰‹åŠ¨æ“ä½œï¼Œå°†è‡ªåŠ¨åœ¨åå°è¿è¡Œ

        // é€€å‡ºç™»å½•
        function logout() {
            console.log('ğŸšª ç”¨æˆ·é€€å‡ºç™»å½•');
            
            // ä½¿ç”¨ç»Ÿä¸€è®¤è¯ç®¡ç†å™¨æ¸…é™¤ç™»å½•çŠ¶æ€
            window.authManager.clearLoginState();
            
            currentUser = null;
            userToken = null;
            
            // æ›´æ–°ç•Œé¢
            updateUserInterface(false);
            
            // æ˜¾ç¤ºé€€å‡ºæ¶ˆæ¯
            showMessage('æ­£åœ¨é€€å‡ºç™»å½•...', 'info');
            
            // é€€å‡ºåè·³è½¬åˆ°ç™»å½•é¡µé¢
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        }

        // æ¸…é™¤ç”¨æˆ·æ•°æ®
        function clearUserData() {
            // æ¸…é™¤åŸºç¡€ç”¨æˆ·ä¿¡æ¯
            localStorage.removeItem('userData');
            localStorage.removeItem('userToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('patientToken');
            localStorage.removeItem('doctorToken');
            localStorage.removeItem('adminToken');
            
            // ğŸš¨ å®‰å…¨ä¿®å¤ï¼šæ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„å¯¹è¯å†å²æ•°æ®
            const userId = getCurrentUserId();
            if (userId) {
                const keys = Object.keys(localStorage);
                const userDataKeys = keys.filter(key => 
                    key.startsWith(`tcm_doctor_history_${userId}_`) ||
                    key.startsWith(`conversationId_${userId}`) ||
                    key.startsWith(`followup_shown_`) ||
                    key.includes(userId)
                );
                
                userDataKeys.forEach(key => {
                    localStorage.removeItem(key);
                    console.log(`ğŸ§¹ å·²æ¸…é™¤ç”¨æˆ·æ•°æ®: ${key}`);
                });
                
                console.log(`ğŸ§¹ ç”¨æˆ·(${userId})é€€å‡ºï¼šå·²æ¸…é™¤${userDataKeys.length}é¡¹ç›¸å…³æ•°æ®`);
            }
            
            // æ¸…é™¤å…¨å±€å˜é‡
            currentUser = null;
            userToken = null;
            currentConversationId = null;
            selectedDoctor = null;
            
            // æ¸…é™¤é¡µé¢ä¸Šçš„å¯¹è¯å†…å®¹
            const containers = ['messagesContainer', 'mobileMessagesContainer'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                }
            });
            
            console.log('ğŸ§¹ ç”¨æˆ·æ•°æ®æ¸…é™¤å®Œæˆ');
        }

        // ğŸ”‘ è·å–å½“å‰å¯¹è¯å†å²ï¼Œç”¨äºç»´æŒä¸Šä¸‹æ–‡è¿ç»­æ€§
        function getCurrentConversationHistory() {
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            if (!messagesContainer) {
                console.warn('æœªæ‰¾åˆ°æ¶ˆæ¯å®¹å™¨ï¼Œè¿”å›ç©ºå†å²');
                return [];
            }
            
            const history = [];
            const messages = messagesContainer.querySelectorAll('.message');
            
            messages.forEach(messageEl => {
                const isUser = messageEl.classList.contains('user');
                const textEl = messageEl.querySelector('.message-text');
                
                if (textEl && textEl.textContent.trim()) {
                    history.push({
                        role: isUser ? 'user' : 'assistant',
                        content: textEl.textContent.trim()
                    });
                }
            });
            
            console.log(`ğŸ”„ è·å–å¯¹è¯å†å²: ${history.length}æ¡æ¶ˆæ¯`);
            return history;
        }

        // ğŸ”‘ æ ‡è®°å¤„æ–¹ä¸ºå·²æ”¯ä»˜çŠ¶æ€å¹¶é‡æ–°æ¸²æŸ“å®Œæ•´å†…å®¹
        async function markPrescriptionAsPaid(prescriptionId) {
            console.log('ğŸ”„ æ ‡è®°å¤„æ–¹ä¸ºå·²æ”¯ä»˜:', prescriptionId);
            
            // ğŸ†• å…³é”®ä¿®å¤ï¼šæ”¯ä»˜æˆåŠŸåå°†å¤„æ–¹æäº¤ç»™åŒ»ç”Ÿå®¡æ ¸
            try {
                console.log('ğŸ”„ æ”¯ä»˜æˆåŠŸï¼Œæ­£åœ¨æäº¤å¤„æ–¹ç»™åŒ»ç”Ÿå®¡æ ¸...', { prescriptionId, type: typeof prescriptionId });
                const submitResponse = await fetch('/api/prescription-review/payment-confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        prescription_id: prescriptionId,  // ğŸ”‘ ä¿®å¤ï¼šç§»é™¤parseIntï¼Œprescription_idåº”è¯¥å·²ç»æ˜¯æ­£ç¡®çš„æ•´æ•°
                        payment_amount: 80.00,
                        payment_method: 'alipay'
                    })
                });
                
                const submitResult = await submitResponse.json();
                console.log('ğŸ“‹ å¤„æ–¹æäº¤å®¡æ ¸ç»“æœ:', submitResult);
                
                if (submitResult.success) {
                    console.log('âœ… å¤„æ–¹å·²æˆåŠŸæäº¤åŒ»ç”Ÿå®¡æ ¸');
                    // æ˜¾ç¤ºå®¡æ ¸ç­‰å¾…æç¤º
                    showMessage('âœ… æ”¯ä»˜æˆåŠŸï¼å¤„æ–¹å·²æäº¤åŒ»ç”Ÿå®¡æ ¸ï¼Œå®¡æ ¸å®Œæˆåå³å¯é…è¯', 'success');
                    
                    // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå¦‚æœæäº¤å®¡æ ¸æˆåŠŸï¼Œä¸æ˜¾ç¤ºå®Œæ•´å¤„æ–¹ï¼Œåªæ˜¾ç¤ºç­‰å¾…å®¡æ ¸çŠ¶æ€
                    updatePrescriptionToReviewStatus(prescriptionId);
                    
                    // ğŸ”‘ æ–°å¢ï¼šåŒæ­¥çŠ¶æ€åˆ°æœåŠ¡å™¨ï¼ˆå¤„æ–¹çŠ¶æ€å·²ç»é€šè¿‡payment-confirm APIåŒæ­¥äº†ï¼‰
                    await syncPrescriptionStatusToServer(prescriptionId, 'pending_review', {
                        action: 'payment_confirmed',
                        timestamp: new Date().toISOString()
                    });
                    
                    return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåé¢çš„å®Œæ•´å¤„æ–¹æ˜¾ç¤ºé€»è¾‘
                } else {
                    console.warn('âš ï¸ å¤„æ–¹æäº¤å®¡æ ¸å¤±è´¥:', submitResult.message);
                }
            } catch (error) {
                console.error('âŒ å¤„æ–¹æäº¤å®¡æ ¸å¼‚å¸¸:', error);
            }
            
            // æ£€æµ‹å½“å‰æ˜¯ç§»åŠ¨ç«¯è¿˜æ˜¯PCç«¯
            const isMobile = window.innerWidth <= 768;
            console.log('ğŸ” å±å¹•æ£€æµ‹:', { windowWidth: window.innerWidth, isMobile });
            
            // ä¼˜å…ˆå°è¯•PCç«¯å®¹å™¨ï¼Œå†å°è¯•ç§»åŠ¨ç«¯å®¹å™¨
            let messagesContainer = document.getElementById('messagesContainer');
            let containerType = 'PC';
            
            if (!messagesContainer) {
                messagesContainer = document.getElementById('mobileMessagesContainer');
                containerType = 'Mobile';
            }
            
            console.log('ğŸ“± ä½¿ç”¨å®¹å™¨ç±»å‹:', containerType);
            
            if (!messagesContainer) {
                console.error('âŒ æœªæ‰¾åˆ°ä»»ä½•æ¶ˆæ¯å®¹å™¨');
                return;
            }
            
            // æŸ¥æ‰¾åŒ…å«å¤„æ–¹çš„AIæ¶ˆæ¯
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            
            console.log('ğŸ” æ‰¾åˆ°AIæ¶ˆæ¯æ•°é‡:', aiMessages.length);
            
            for (let i = 0; i < aiMessages.length; i++) {
                const messageDiv = aiMessages[i];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤„æ–¹IDåŒ¹é…æˆ–æ”¯ä»˜æŒ‰é’®
                const msgPrescriptionId = messageDiv.getAttribute('data-prescription-id');
                const hasPaymentButton = messageDiv.querySelector('.prescription-actions');
                
                console.log(`ğŸ“‹ æ¶ˆæ¯ ${i+1}:`, {
                    msgPrescriptionId,
                    hasPaymentButton: !!hasPaymentButton,
                    targetPrescriptionId: prescriptionId
                });
                
                // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«å¤„æ–¹å†…å®¹
                const messageContent = messageDiv.innerHTML || '';
                const hasUnlockButton = messageContent.includes('è§£é”å®Œæ•´å¤„æ–¹') || messageContent.includes('ç¡®è®¤å¤„æ–¹å¹¶æ”¯ä»˜');
                const hasPrescriptionContent = messageContent.includes('å¤„æ–¹') || messageContent.includes('æ–¹å‰‚') || messageContent.includes('è¯æ');
                
                console.log(`ğŸ” æ¶ˆæ¯ ${i+1} å†…å®¹æ£€æŸ¥:`, {
                    hasUnlockButton,
                    hasPrescriptionContent,
                    contentLength: messageContent.length
                });
                
                // å¦‚æœæŒ‡å®šäº†å¤„æ–¹IDï¼Œä¼˜å…ˆåŒ¹é…ID
                if (prescriptionId && msgPrescriptionId && msgPrescriptionId !== prescriptionId) {
                    console.log(`â­ï¸ è·³è¿‡æ¶ˆæ¯ ${i+1} - IDä¸åŒ¹é…`);
                    continue; // è·³è¿‡ä¸åŒ¹é…çš„å¤„æ–¹
                }
                
                // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„å¤„æ–¹IDï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¤„æ–¹ç›¸å…³å†…å®¹
                const shouldProcess = msgPrescriptionId || hasPaymentButton || hasUnlockButton || 
                    (hasPrescriptionContent && messageContent.length > 1000); // é•¿å†…å®¹å¾ˆå¯èƒ½æ˜¯å¤„æ–¹
                
                if (!shouldProcess) {
                    console.log(`â­ï¸ è·³è¿‡æ¶ˆæ¯ ${i+1} - ä¸æ˜¯å¤„æ–¹ç›¸å…³æ¶ˆæ¯`);
                    continue;
                }
                
                console.log(`âœ… å¤„ç†æ¶ˆæ¯ ${i+1} - å¼€å§‹è·å–åŸå§‹å¤„æ–¹å†…å®¹`);
                
                // è·å–åŸå§‹å¤„æ–¹å†…å®¹ï¼ˆå¼‚æ­¥ä»APIè·å–ï¼‰
                let originalContent = await getOriginalPrescriptionContent(messageDiv, prescriptionId);
                
                // å¦‚æœAPIè·å–å¤±è´¥ï¼Œå°è¯•è·å–å®Œæ•´å¤„æ–¹å†…å®¹
                if (!originalContent) {
                    try {
                        console.log('[æ”¯ä»˜] å°è¯•è·å–å®Œæ•´å¤„æ–¹å†…å®¹...');
                        const fullContentResponse = await fetch(`/api/prescription/${prescriptionId}/full-content`);
                        if (fullContentResponse.ok) {
                            const fullContentData = await fullContentResponse.json();
                            if (fullContentData.success && fullContentData.prescription) {
                                originalContent = fullContentData.prescription.full_content;
                                console.log('[æ”¯ä»˜] è·å–åˆ°å®Œæ•´å¤„æ–¹å†…å®¹ï¼Œé•¿åº¦:', originalContent.length);
                            }
                        }
                    } catch (fullContentError) {
                        console.log('[æ”¯ä»˜] è·å–å®Œæ•´å†…å®¹å¤±è´¥:', fullContentError);
                    }
                }
                
                // æœ€ç»ˆfallbackï¼šä½¿ç”¨DOMå†…å®¹
                if (!originalContent) {
                    console.log('âš ï¸ APIè·å–å¤±è´¥ï¼Œä½¿ç”¨DOMå†…å®¹ä½œä¸ºå¤‡ç”¨');
                    const contentDiv = messageDiv.querySelector('.message-text') || messageDiv.querySelector('.message-content');
                    if (contentDiv) {
                        originalContent = contentDiv.innerHTML;
                        console.log('ğŸ“„ ä»DOMè·å–å†…å®¹é•¿åº¦:', originalContent.length);
                    }
                }
                
                if (originalContent) {
                    console.log('ğŸ”„ é‡æ–°æ¸²æŸ“å¤„æ–¹å†…å®¹ä¸ºå·²æ”¯ä»˜çŠ¶æ€');
                    
                    // ç›´æ¥æ˜¾ç¤ºå®Œæ•´åŸå§‹å†…å®¹ï¼Œç»•è¿‡å¤„æ–¹æ¸²æŸ“å™¨çš„å¤æ‚é€»è¾‘
                    console.log('âœ… ç›´æ¥æ˜¾ç¤ºå®Œæ•´å¤„æ–¹å†…å®¹ï¼ˆå·²æ”¯ä»˜ï¼‰');
                    console.log('ğŸ“‹ åŸå§‹å¤„æ–¹å†…å®¹é¢„è§ˆ:', originalContent.substring(0, 200) + '...');
                    
                    let newContent;
                    
                    // å¦‚æœåŸå§‹å†…å®¹å·²ç»åŒ…å«HTMLï¼Œç›´æ¥ä½¿ç”¨
                    if (originalContent.includes('<div') || originalContent.includes('<p')) {
                        newContent = originalContent;
                    } else {
                        // å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œè¿›è¡Œæ ¼å¼åŒ–
                        newContent = formatMessage(originalContent);
                    }
                    
                    // ç§»é™¤ä»»ä½•éšè—çš„å†…å®¹æ ‡è®°å’Œé¢„è§ˆé™åˆ¶
                    newContent = newContent.replace(/\*\*\*/g, '15');
                    newContent = newContent.replace(/è§£é”æŸ¥çœ‹/g, '');
                    newContent = newContent.replace(/\+ \d+ å‘³è¯æ/g, '');
                    newContent = newContent.replace(/æ–¹å‰‚ç»„æˆé¢„è§ˆ/g, 'å®Œæ•´æ–¹å‰‚ç»„æˆ');
                    newContent = newContent.replace(/é¢„è§ˆ/g, 'å®Œæ•´');
                    
                    // ç§»é™¤æ”¯ä»˜ç›¸å…³çš„æŒ‰é’®å’Œæç¤º
                    newContent = newContent.replace(/<div[^>]*è§£é”å®Œæ•´å¤„æ–¹[^>]*>.*?<\/div>/gs, '');
                    newContent = newContent.replace(/<button[^>]*ç¡®è®¤å¤„æ–¹å¹¶æ”¯ä»˜[^>]*>.*?<\/button>/gs, '');
                    newContent = newContent.replace(/ğŸ”’ è§£é”å®Œæ•´å¤„æ–¹/g, '');
                    newContent = newContent.replace(/ğŸ’³ ç¡®è®¤å¤„æ–¹å¹¶æ”¯ä»˜.*?Â¥\d+/g, '');
                    
                    // å¦‚æœå†…å®¹å¤ªçŸ­ï¼Œå¯èƒ½æ˜¯è¢«è¿‡åº¦å¤„ç†äº†ï¼Œå°è¯•æ¢å¤
                    if (newContent.length < 500 && originalContent.length > 1000) {
                        console.log('âš ï¸ å¤„ç†åå†…å®¹è¿‡çŸ­ï¼Œä½¿ç”¨åŸå§‹å†…å®¹');
                        newContent = originalContent;
                    }
                    
                    console.log('ğŸ“Š å†…å®¹å¤„ç†ç»“æœ:', {
                        åŸå§‹é•¿åº¦: originalContent.length,
                        å¤„ç†åé•¿åº¦: newContent.length,
                        åŒ…å«è¯æ: newContent.includes('è¯æ') || newContent.includes('æ–¹å‰‚')
                    });
                    
                    // æ·»åŠ æ”¯ä»˜æˆåŠŸæ ‡è¯†
                    newContent += `
                        <div class="prescription-paid" style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 13px; color: #059669; margin-bottom: 8px;">
                                <strong>âœ… å¤„æ–¹å·²è§£é”</strong> - æ”¯ä»˜æˆåŠŸï¼Œå®Œæ•´å¤„æ–¹å†…å®¹å·²æ˜¾ç¤º
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="showDecorationInfo('${prescriptionId || 'unknown'}')" 
                                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                    ğŸµ è”ç³»ä»£ç…æœåŠ¡
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // æ›´æ–°æ¶ˆæ¯å†…å®¹ - å°è¯•å¤šä¸ªå¯èƒ½çš„é€‰æ‹©å™¨
                    let contentDiv = messageDiv.querySelector('.message-text');
                    if (!contentDiv) {
                        contentDiv = messageDiv.querySelector('.message-content .message-text');
                    }
                    if (!contentDiv) {
                        contentDiv = messageDiv.querySelector('.content');
                    }
                    if (!contentDiv) {
                        contentDiv = messageDiv.querySelector('.message-content');
                    }
                    
                    console.log('ğŸ” æ‰¾åˆ°å†…å®¹å®¹å™¨:', !!contentDiv, contentDiv?.className);
                    
                    if (contentDiv) {
                        console.log('âœ… æ›´æ–°å¤„æ–¹å†…å®¹ - åŸé•¿åº¦:', contentDiv.innerHTML.length, 'æ–°é•¿åº¦:', newContent.length);
                        contentDiv.innerHTML = newContent;
                    } else {
                        console.error('âŒ æœªæ‰¾åˆ°å†…å®¹å®¹å™¨ï¼Œæ— æ³•æ›´æ–°å¤„æ–¹');
                    }
                    
                    // æ ‡è®°å¤„æ–¹IDå’Œæ”¯ä»˜çŠ¶æ€
                    if (prescriptionId) {
                        messageDiv.setAttribute('data-prescription-id', prescriptionId);
                        messageDiv.setAttribute('data-paid', 'true');
                    }
                    
                    console.log('âœ… å·²æ›´æ–°å¤„æ–¹å†…å®¹ä¸ºå·²æ”¯ä»˜çŠ¶æ€');
                }
            }
            
            // ğŸ”‘ å…³é”®ï¼šç«‹å³ä¿å­˜æ›´æ–°åçš„çŠ¶æ€
            if (selectedDoctor) {
                saveCurrentDoctorHistory();
                console.log('âœ… å·²ä¿å­˜æ”¯ä»˜çŠ¶æ€åˆ°å†å²è®°å½•');
            }
        }
        
        // ğŸ†• æ›´æ–°å¤„æ–¹æ˜¾ç¤ºä¸ºç­‰å¾…å®¡æ ¸çŠ¶æ€
        function updatePrescriptionToReviewStatus(prescriptionId) {
            console.log('ğŸ”„ æ›´æ–°å¤„æ–¹ä¸ºç­‰å¾…å®¡æ ¸çŠ¶æ€:', prescriptionId);
            
            // æŸ¥æ‰¾åŒ…å«å¤„æ–¹çš„æ¶ˆæ¯
            const messagesContainer = document.getElementById('messagesContainer') || document.getElementById('mobileMessagesContainer');
            if (!messagesContainer) return;
            
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            
            for (let messageDiv of aiMessages) {
                const msgPrescriptionId = messageDiv.getAttribute('data-prescription-id');
                const messageContent = messageDiv.innerHTML || '';
                const hasPrescriptionContent = messageContent.includes('å¤„æ–¹') || messageContent.includes('æ–¹å‰‚');
                
                // å¦‚æœæ˜¯ç›®æ ‡å¤„æ–¹æ¶ˆæ¯
                if ((prescriptionId && msgPrescriptionId === prescriptionId) || 
                    (!prescriptionId && hasPrescriptionContent)) {
                    
                    const contentDiv = messageDiv.querySelector('.message-text') || messageDiv.querySelector('.message-content');
                    if (contentDiv) {
                        // æ›¿æ¢ä¸ºç­‰å¾…å®¡æ ¸çŠ¶æ€
                        contentDiv.innerHTML = `
                            <div class="prescription-review-waiting" style="padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border-left: 4px solid #f59e0b; margin: 15px 0;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">â³</div>
                                    <h3 style="color: #92400e; margin: 0; font-size: 18px;">å¤„æ–¹ç­‰å¾…åŒ»ç”Ÿå®¡æ ¸ä¸­</h3>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; margin: 10px 0;">
                                    <p style="margin: 0; color: #78350f; font-size: 14px; line-height: 1.6;">
                                        âœ… <strong>æ”¯ä»˜å·²å®Œæˆ</strong><br>
                                        ğŸ” å¤„æ–¹æ­£åœ¨ç”±ä¸“ä¸šåŒ»ç”Ÿå®¡æ ¸ä¸­<br>
                                        ğŸ“‹ å®¡æ ¸å®Œæˆåæ‚¨å°†æ”¶åˆ°é€šçŸ¥<br>
                                        ğŸ’Š å®¡æ ¸é€šè¿‡åå³å¯é…è¯
                                    </p>
                                </div>
                                
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="checkPrescriptionStatus('${prescriptionId}')" 
                                            style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                        ğŸ” æŸ¥çœ‹å®¡æ ¸çŠ¶æ€
                                    </button>
                                </div>
                                
                                <div style="font-size: 12px; color: #92400e; text-align: center; margin-top: 10px; opacity: 0.8;">
                                    å¤„æ–¹ID: ${prescriptionId}
                                </div>
                            </div>
                        `;
                        
                        // æ ‡è®°å¤„æ–¹çŠ¶æ€
                        messageDiv.setAttribute('data-prescription-status', 'pending_review');
                        messageDiv.setAttribute('data-prescription-id', prescriptionId);
                        
                        // ğŸ”‘ å…³é”®ä¿®å¤ï¼šåŒæ­¥çŠ¶æ€åˆ°localStorageï¼Œç¡®ä¿åˆ·æ–°åèƒ½æ¢å¤
                        syncPrescriptionStatusToStorage(prescriptionId, 'pending_review');
                        
                        console.log('âœ… å·²æ›´æ–°å¤„æ–¹æ˜¾ç¤ºä¸ºç­‰å¾…å®¡æ ¸çŠ¶æ€');
                    }
                    break;
                }
            }
        }
        
        // ğŸ†• åŒæ­¥å¤„æ–¹çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        function syncPrescriptionStatusToStorage(prescriptionId, status) {
            try {
                const userId = getCurrentUserId();
                const storageKey = `prescription_status_${userId}`;
                let prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                prescriptionStatuses[prescriptionId] = {
                    status: status,
                    timestamp: Date.now(),
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.setItem(storageKey, JSON.stringify(prescriptionStatuses));
                console.log('ğŸ’¾ å·²åŒæ­¥å¤„æ–¹çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨:', prescriptionId, status);
                
            } catch (error) {
                console.error('âŒ åŒæ­¥å¤„æ–¹çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // ğŸ†• ä»æœ¬åœ°å­˜å‚¨è·å–å¤„æ–¹çŠ¶æ€
        function getPrescriptionStatusFromStorage(prescriptionId) {
            try {
                const userId = getCurrentUserId();
                const storageKey = `prescription_status_${userId}`;
                const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                const statusData = prescriptionStatuses[prescriptionId];
                return statusData ? statusData.status : null;
                
            } catch (error) {
                console.error('âŒ è·å–å¤„æ–¹çŠ¶æ€å¤±è´¥:', error);
                return null;
            }
        }
        
        // ğŸ†• æ£€æŸ¥å¤„æ–¹å®¡æ ¸çŠ¶æ€ - å¢å¼ºå®æ—¶åŒæ­¥
        async function checkPrescriptionStatus(prescriptionId) {
            try {
                console.log('ğŸ” æ£€æŸ¥å¤„æ–¹å®¡æ ¸çŠ¶æ€:', prescriptionId);
                
                const response = await fetch(`/api/prescription-review/status/${prescriptionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ğŸ“‹ å¤„æ–¹çŠ¶æ€:', result);
                    
                    if (result.success && result.data) {
                        const statusData = result.data;
                        
                        if (statusData.is_reviewed) {
                            // å®¡æ ¸å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆå¤„æ–¹
                            showMessage('âœ… å¤„æ–¹å®¡æ ¸å·²å®Œæˆï¼', 'success');
                            await markPrescriptionAsCompleted(prescriptionId, statusData);
                            
                            // ğŸ”‘ åŒæ­¥çŠ¶æ€æ›´æ–°åˆ°æœ¬åœ°å­˜å‚¨
                            syncPrescriptionStatusToStorage(prescriptionId, 'approved');
                        } else {
                            // ä»åœ¨å®¡æ ¸ä¸­
                            showMessage(`â³ å¤„æ–¹ä»åœ¨å®¡æ ¸ä¸­ï¼ŒçŠ¶æ€ï¼š${statusData.status_description}`, 'info');
                        }
                    }
                } else {
                    // ğŸ”‘ ä¿®å¤ï¼šæ”¹è¿›é”™è¯¯å¤„ç†ï¼Œæä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    const errorMsg = result.message || 'æ— æ³•è·å–å¤„æ–¹çŠ¶æ€';
                    if (result.error_code === 'PRESCRIPTION_NOT_FOUND') {
                        console.warn('å¤„æ–¹ä¸å­˜åœ¨:', prescriptionId);
                        showMessage(`âš ï¸ å¤„æ–¹è®°å½•ä¸å­˜åœ¨(ID: ${prescriptionId})`, 'warning');
                    } else {
                        showMessage(`âŒ ${errorMsg}`, 'error');
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥å¤„æ–¹çŠ¶æ€å¤±è´¥:', error);
                // ğŸ”‘ ä¿®å¤ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„ç½‘ç»œé”™è¯¯
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showMessage('âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®', 'error');
                } else if (error.name === 'SyntaxError') {
                    showMessage('âŒ æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯', 'error');
                } else {
                    showMessage('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            }
        }
        
        // ğŸ†• å¯åŠ¨å®æ—¶åŒæ­¥æ£€æŸ¥æœºåˆ¶
        function startPrescriptionStatusPolling() {
            const userId = getCurrentUserId();
            const storageKey = `prescription_status_${userId}`;
            
            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡å¤„æ–¹çŠ¶æ€
            setInterval(async () => {
                try {
                    const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                    
                    // æ£€æŸ¥æ‰€æœ‰å¾…å®¡æ ¸çš„å¤„æ–¹
                    for (const [prescriptionId, statusData] of Object.entries(prescriptionStatuses)) {
                        if (statusData.status === 'pending_review') {
                            // æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸï¼ˆè¶…è¿‡24å°æ—¶ä¸å†æ£€æŸ¥ï¼‰
                            const hoursAgo = (Date.now() - statusData.timestamp) / (1000 * 60 * 60);
                            if (hoursAgo < 24 && prescriptionId && prescriptionId !== 'undefined') {
                                await checkPrescriptionStatusSilently(prescriptionId);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('å®šæœŸæ£€æŸ¥å¤„æ–¹çŠ¶æ€å¤±è´¥:', error);
                }
            }, 30000); // 30ç§’æ£€æŸ¥ä¸€æ¬¡
            
            console.log('âœ… å·²å¯åŠ¨å¤„æ–¹çŠ¶æ€å®æ—¶åŒæ­¥æ£€æŸ¥');
        }
        
        // ğŸ†• é™é»˜æ£€æŸ¥å¤„æ–¹çŠ¶æ€ï¼ˆä¸æ˜¾ç¤ºUIæç¤ºï¼‰
        async function checkPrescriptionStatusSilently(prescriptionId) {
            try {
                const response = await fetch(`/api/prescription-review/status/${prescriptionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.is_reviewed) {
                        // å®¡æ ¸å®Œæˆï¼Œè‡ªåŠ¨æ›´æ–°ç•Œé¢
                        console.log('ğŸ”” æ£€æµ‹åˆ°å¤„æ–¹å®¡æ ¸å®Œæˆ:', prescriptionId);
                        showMessage('ğŸ”” æ‚¨æœ‰å¤„æ–¹å®¡æ ¸å®Œæˆï¼Œæ­£åœ¨æ›´æ–°æ˜¾ç¤º...', 'success');
                        
                        await markPrescriptionAsCompleted(prescriptionId, result.data);
                        syncPrescriptionStatusToStorage(prescriptionId, 'approved');
                        
                        // æ’­æ”¾é€šçŸ¥éŸ³æ•ˆï¼ˆå¦‚æœå¯èƒ½ï¼‰
                        if ('Audio' in window) {
                            try {
                                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFAg+ltryxnkpBSl+zPLZizEIGGS57OObTgwKT6fh8LZnHgg2jdXzzn8vBSF0xe/ekkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4GMIzU8tGAMgUfcsLu45hEDBFYrOLtrVwWBDqU2fLIfSwGJHfH8N+QQAoUXrTp6qtWFAg+ltrzxnkpBSl+zPLZizEIGGS56+OcTgwKT6fh8LZnHgg2jdT0z4AuBSJ0xe/gkkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4GMIzU8tGAMgUfcsLu45hEDBFYrOLtrVwWBDqU2fLIfSwGJHfH8N+QQAoUXrTp6qtWFAg+ltrzxnkpBSl+zPLZizEIGGS56+OcTgwKT6fh8LZnHgg2jdT0z4AuBSJ0xe/gkkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4GMIzU8tGAMgUfcsLu45hEDBFYrOLtrVwWBDqU2fLIfSwGJHfH8N+QQAoUXrTp6qtWFAg+ltrzxnkpBSl+zPLZizEIGGS56+OcTgwKT6fh8LZnHgg2jdT0z4AuBSJ0xe/gkkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4=');
                                audio.volume = 0.3;
                                audio.play();
                            } catch (e) {
                                // å¿½ç•¥éŸ³æ•ˆæ’­æ”¾é”™è¯¯
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('é™é»˜æ£€æŸ¥å¤„æ–¹çŠ¶æ€å¤±è´¥:', prescriptionId, error);
                // ğŸ”‘ å¦‚æœæ˜¯å¤„æ–¹ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œä»æœ¬åœ°å­˜å‚¨ä¸­ç§»é™¤
                if (error.message && error.message.includes('ä¸å­˜åœ¨')) {
                    try {
                        const userId = getCurrentUserId();
                        const storageKey = `prescription_status_${userId}`;
                        const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                        if (prescriptionStatuses[prescriptionId]) {
                            delete prescriptionStatuses[prescriptionId];
                            localStorage.setItem(storageKey, JSON.stringify(prescriptionStatuses));
                            console.log('å·²æ¸…ç†æ— æ•ˆå¤„æ–¹ID:', prescriptionId);
                        }
                    } catch (cleanupError) {
                        console.warn('æ¸…ç†æ— æ•ˆå¤„æ–¹IDå¤±è´¥:', cleanupError);
                    }
                }
            }
        }
        
        // ğŸ†• æ¢å¤æ‰€æœ‰å¾…å®¡æ ¸å¤„æ–¹çŠ¶æ€ - é¡µé¢åˆ·æ–°åç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
        function restoreAllPendingPrescriptions() {
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                const storageKey = `prescription_status_${userId}`;
                const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                console.log('ğŸ”„ æ£€æŸ¥å¹¶æ¢å¤æ‰€æœ‰å¾…å®¡æ ¸å¤„æ–¹çŠ¶æ€:', prescriptionStatuses);
                
                // éå†æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„å¤„æ–¹çŠ¶æ€
                for (const [prescriptionId, statusData] of Object.entries(prescriptionStatuses)) {
                    if (statusData.status === 'pending_review') {
                        console.log('ğŸ”„ æ¢å¤å¾…å®¡æ ¸å¤„æ–¹:', prescriptionId);
                        updatePrescriptionToReviewStatus(prescriptionId);
                    }
                }
                
                console.log('âœ… å¤„æ–¹çŠ¶æ€æ¢å¤æ£€æŸ¥å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æ¢å¤å¤„æ–¹çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // ğŸ†• æ ‡è®°å¤„æ–¹ä¸ºå®¡æ ¸å®ŒæˆçŠ¶æ€
        async function markPrescriptionAsCompleted(prescriptionId, statusData) {
            console.log('ğŸ“‹ å¤„æ–¹å®¡æ ¸å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆå¤„æ–¹');
            
            // ğŸ”‘ å…³é”®ä¿®å¤ï¼šåŒ»ç”Ÿå®¡æ ¸å®Œæˆåæ‰æ˜¾ç¤ºå®Œæ•´å¤„æ–¹ï¼Œä¸èµ°æ”¯ä»˜æµç¨‹
            try {
                // æŸ¥æ‰¾å¤„æ–¹æ¶ˆæ¯å…ƒç´ 
                const messagesContainer = document.getElementById('messagesContainer') || document.getElementById('mobileMessagesContainer');
                if (!messagesContainer) return;
                
                const messageElements = messagesContainer.querySelectorAll('.message.ai');
                
                for (let messageDiv of messageElements) {
                    const msgPrescriptionId = messageDiv.getAttribute('data-prescription-id');
                    if (msgPrescriptionId === prescriptionId) {
                        const contentDiv = messageDiv.querySelector('.message-text') || messageDiv.querySelector('.message-content');
                        if (contentDiv) {
                            // è·å–å®¡æ ¸åçš„å®Œæ•´å¤„æ–¹å†…å®¹
                            const finalPrescription = statusData.final_prescription || statusData.doctor_prescription || "å®¡æ ¸å®Œæˆçš„å¤„æ–¹å†…å®¹";
                            
                            contentDiv.innerHTML = `
                                <div class="prescription-approved" style="padding: 20px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 12px; border-left: 4px solid #22c55e; margin: 15px 0;">
                                    <div style="text-align: center; margin-bottom: 15px;">
                                        <div style="font-size: 2em; margin-bottom: 10px;">âœ…</div>
                                        <h3 style="color: #15803d; margin: 0; font-size: 18px;">åŒ»ç”Ÿå®¡æ ¸é€šè¿‡</h3>
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; margin: 15px 0;">
                                        <div style="color: #15803d; font-size: 16px; font-weight: 600; margin-bottom: 15px;">
                                            å®¡æ ¸é€šè¿‡çš„å¤„æ–¹ï¼š
                                        </div>
                                        <div style="color: #374151; line-height: 1.6; white-space: pre-wrap;">
                                            ${finalPrescription}
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 15px;">
                                        <div style="color: #059669; font-size: 14px; margin-bottom: 10px;">
                                            âœ… åŒ»ç”Ÿå®¡æ ¸å·²å®Œæˆ<br>
                                            ğŸ’Š æ‚¨å¯ä»¥å‡­æ­¤å¤„æ–¹é…è¯
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #059669; text-align: center; margin-top: 10px;">
                                        å¤„æ–¹ID: ${prescriptionId}
                                    </div>
                                </div>
                            `;
                            
                            // æ ‡è®°ä¸ºå®¡æ ¸å®ŒæˆçŠ¶æ€
                            messageDiv.setAttribute('data-prescription-status', 'approved');
                            syncPrescriptionStatusToStorage(prescriptionId, 'approved');
                            
                            console.log('âœ… å·²æ˜¾ç¤ºå®¡æ ¸é€šè¿‡çš„æœ€ç»ˆå¤„æ–¹');
                        }
                        break;
                    }
                }
            } catch (error) {
                console.error('âŒ æ˜¾ç¤ºå®¡æ ¸å®Œæˆå¤„æ–¹å¤±è´¥:', error);
            }
        }

        // è·å–åŸå§‹å¤„æ–¹å†…å®¹çš„è¾…åŠ©å‡½æ•°ï¼ˆä»APIè·å–ï¼‰
        async function getOriginalPrescriptionContent(messageDiv, prescriptionId) {
            // ä¼˜å…ˆä»APIè·å–åŸå§‹å¤„æ–¹å†…å®¹
            if (prescriptionId) {
                try {
                    console.log('ğŸ”„ ä»APIè·å–å¤„æ–¹è¯¦æƒ…:', prescriptionId);
                    const response = await fetch(`/api/prescription/${prescriptionId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.prescription) {
                            const prescriptionData = result.prescription;
                            // è¿”å›AIå¤„æ–¹å†…å®¹ï¼ˆåŸå§‹å†…å®¹ï¼‰
                            const originalContent = prescriptionData.ai_prescription || prescriptionData.doctor_prescription;
                            if (originalContent) {
                                console.log('âœ… ä»APIæˆåŠŸè·å–åŸå§‹å¤„æ–¹å†…å®¹');
                                return originalContent;
                            }
                        }
                    }
                } catch (error) {
                    console.error('âŒ APIè·å–å¤„æ–¹å†…å®¹å¤±è´¥:', error);
                }
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆ1ï¼šä»å†å²è®°å½•è·å–åŸå§‹å†…å®¹
            const currentHistory = getCurrentDoctorHistory();
            if (currentHistory && currentHistory.length > 0) {
                // ä»æœ€è¿‘çš„æ¶ˆæ¯ä¸­æŸ¥æ‰¾å¤„æ–¹å†…å®¹
                for (let i = currentHistory.length - 1; i >= 0; i--) {
                    const msg = currentHistory[i];
                    if (msg.type === 'ai' && (msg.prescriptionId === prescriptionId || msg.prescriptionData?.prescriptionId === prescriptionId)) {
                        console.log('âœ… ä»å†å²è®°å½•æ‰¾åˆ°åŸå§‹å¤„æ–¹å†…å®¹');
                        return msg.originalContent || msg.content;
                    }
                }
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆ2ï¼šä»DOMè·å–ï¼ˆå¯èƒ½å·²ç»è¢«å¤„æ–¹æ¸²æŸ“å™¨ä¿®æ”¹è¿‡ï¼‰
            const contentDiv = messageDiv.querySelector('.message-text');
            if (contentDiv) {
                // å°è¯•è·å–æœªä¿®æ”¹çš„æ–‡æœ¬å†…å®¹
                const textContent = contentDiv.textContent || contentDiv.innerText;
                if (textContent && textContent.length > 100) {
                    console.log('âš ï¸ ä»DOMè·å–å¤„æ–¹å†…å®¹ï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰');
                    return textContent;
                }
            }
            
            console.warn('âŒ æ— æ³•è·å–åŸå§‹å¤„æ–¹å†…å®¹');
            return null;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            // åˆ›å»ºæ¶ˆæ¯æç¤ºå…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            switch (type) {
                case 'success':
                    messageDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    messageDiv.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                case 'info':
                default:
                    messageDiv.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                    break;
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // è·å–è®¤è¯å¤´
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // ğŸ”‘ ä¿®å¤ï¼šä½¿ç”¨authManagerè·å–æ­£ç¡®çš„token
            const token = window.authManager ? window.authManager.getToken() : userToken;
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                console.log('ğŸ”‘ ä½¿ç”¨è®¤è¯token:', token.substring(0, 20) + '...');
            } else {
                console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°è®¤è¯token');
            }
            
            return headers;
        }

        // ===================== è®¤è¯ç³»ç»Ÿç»“æŸ =====================

        // ===================== å¤„æ–¹ç®¡ç†ç³»ç»Ÿ =====================
        
        // ä»å¯¹è¯å†å²ä¸­æå–ç—‡çŠ¶å’Œè¯Šæ–­ä¿¡æ¯
        function extractConversationSummary() {
            const container = document.getElementById('messagesContainer');
            let symptoms = '';
            let diagnosis = '';
            
            if (container) {
                const messages = container.querySelectorAll('.message');
                const userMessages = [];
                const aiMessages = [];
                
                messages.forEach(messageEl => {
                    const textEl = messageEl.querySelector('.message-text');
                    if (textEl) {
                        const content = textEl.textContent.trim();
                        if (messageEl.classList.contains('user')) {
                            userMessages.push(content);
                        } else if (messageEl.classList.contains('ai')) {
                            aiMessages.push(content);
                        }
                    }
                });
                
                // æå–ç”¨æˆ·æè¿°çš„ç—‡çŠ¶
                symptoms = userMessages.join(' | ').substring(0, 500); // é™åˆ¶é•¿åº¦
                
                // æå–AIçš„è¯Šæ–­ä¿¡æ¯
                const lastAiMessage = aiMessages[aiMessages.length - 1] || '';
                if (lastAiMessage.includes('è¯å€™') || lastAiMessage.includes('è¯Šæ–­')) {
                    diagnosis = lastAiMessage.substring(0, 300); // æå–è¯Šæ–­ä¿¡æ¯
                }
            }
            
            return {
                symptoms: symptoms || 'æ‚£è€…ç—‡çŠ¶æè¿°',
                diagnosis: diagnosis || 'AIä¸­åŒ»è¯Šæ–­'
            };
        }
        
        // ç¡®è®¤å¤„æ–¹å¹¶æ”¯ä»˜
        async function confirmPrescription(encodedPrescription) {
            try {
                const prescriptionContent = decodeURIComponent(atob(encodedPrescription));
                
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                if (!currentUser || !userToken) {
                    showMessage('è¯·å…ˆç™»å½•åå†ç¡®è®¤å¤„æ–¹', 'error');
                    showLoginModal();
                    return;
                }
                
                // åˆ›å»ºå¤„æ–¹ç¡®è®¤æ¨¡æ€æ¡†
                showPrescriptionConfirmModal(prescriptionContent);
                
            } catch (error) {
                console.error('å¤„æ–¹ç¡®è®¤å¤±è´¥:', error);
                showMessage('å¤„æ–¹æ•°æ®è§£æå¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºå¤„æ–¹ç¡®è®¤æ¨¡æ€æ¡†
        function showPrescriptionConfirmModal(prescriptionContent) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†
            let modal = document.getElementById('prescriptionModal');
            if (!modal) {
                // åˆ›å»ºå¤„æ–¹ç¡®è®¤æ¨¡æ€æ¡†
                modal = document.createElement('div');
                modal.id = 'prescriptionModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1001;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">ğŸ“‹ å¤„æ–¹ç¡®è®¤</h3>
                        </div>
                        <div style="padding: 24px;">
                            <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <h4 style="margin: 0 0 12px 0; color: #374151;">å¤„æ–¹å†…å®¹ï¼š</h4>
                                <div id="prescriptionContent" style="font-family: monospace; white-space: pre-wrap; line-height: 1.6; color: #1f2937;"></div>
                            </div>
                            
                            <div style="background: #fef3c7; border-radius: 8px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0 0 12px 0; color: #92400e;">âš ï¸ é‡è¦æé†’ï¼š</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 14px;">
                                    <li>æ­¤ä¸ºAIç”Ÿæˆçš„å»ºè®®å¤„æ–¹ï¼Œä»…ä¾›å‚è€ƒ</li>
                                    <li>ç¡®è®¤å¤„æ–¹å°†è¿›å…¥æ”¯ä»˜æµç¨‹ï¼Œæ”¯ä»˜åå¯è”ç³»ä»£ç…æœåŠ¡</li>
                                    <li>å»ºè®®åœ¨ä¸“ä¸šåŒ»ç”ŸæŒ‡å¯¼ä¸‹ä½¿ç”¨</li>
                                    <li>å¦‚æœ‰ä¸é€‚ï¼Œè¯·ç«‹å³åœè¯å¹¶å°±åŒ»</li>
                                </ul>
                            </div>
                            
                            <div style="background: #e0f2fe; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px 0; color: #0277bd;">ğŸ’° è´¹ç”¨è¯´æ˜ï¼š</h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>å¤„æ–¹è´¹ç”¨ï¼š</span>
                                    <span style="font-weight: bold;">Â¥ 50.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>ä»£ç…è´¹ç”¨ï¼š</span>
                                    <span style="font-weight: bold;">Â¥ 30.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #b3e5fc;">
                                    <span style="font-weight: bold;">æ€»è®¡ï¼š</span>
                                    <span style="font-weight: bold; color: #0277bd; font-size: 18px;">Â¥ 80.00</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button onclick="hidePrescriptionModal()" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; background: #f9fafb; color: #374151; border-radius: 8px; cursor: pointer;">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="proceedToPayment()" style="flex: 1; padding: 12px; border: none; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    ç¡®è®¤å¹¶æ”¯ä»˜ Â¥80.00
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // æ›´æ–°å¤„æ–¹å†…å®¹
            const contentDiv = modal.querySelector('#prescriptionContent');
            contentDiv.textContent = prescriptionContent;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';
        }

        // éšè—å¤„æ–¹ç¡®è®¤æ¨¡æ€æ¡†
        function hidePrescriptionModal() {
            const modal = document.getElementById('prescriptionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // è¿›å…¥æ”¯ä»˜æµç¨‹
        async function proceedToPayment() {
            try {
                // è·å–å¤„æ–¹å†…å®¹
                const prescriptionContent = document.getElementById('prescriptionContent').textContent;
                
                // ç¡®ä¿ç”¨æˆ·ä¿¡æ¯å­˜åœ¨
                if (!currentUser) {
                    showMessage('ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    return;
                }
                
                // ä»å¯¹è¯å†å²ä¸­æå–ç—‡çŠ¶å’Œè¯Šæ–­ä¿¡æ¯
                const conversationSummary = extractConversationSummary();
                
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                // ğŸ”‘ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·IDæ˜ å°„ï¼Œç¡®ä¿æ•°æ®å…³è”æ­£ç¡®
                const userId = getCurrentUserId(); // ä½¿ç”¨ç»Ÿä¸€çš„ç”¨æˆ·IDè·å–æ–¹å¼
                const requestData = {
                    patient_id: userId,
                    conversation_id: currentConversationId || generateConversationId(),
                    patient_name: currentUser.username || currentUser.display_name || currentUser.name || 'æ‚£è€…',
                    patient_phone: currentUser.phone || '',
                    symptoms: conversationSummary.symptoms,
                    diagnosis: conversationSummary.diagnosis,
                    ai_prescription: prescriptionContent
                };
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('å‘é€å¤„æ–¹åˆ›å»ºè¯·æ±‚:', requestData);
                console.log('è®¤è¯å¤´:', getAuthHeaders());
                
                // æŒ‰ç…§åç«¯APIæ ¼å¼å‘é€æ•°æ®
                const response = await fetch('/api/prescription/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                
                const result = await response.json();
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('å¤„æ–¹åˆ›å»ºå“åº”:', result);
                
                if (result.success && result.prescription_id) {
                    // ğŸ”‘ ä¿®å¤ï¼šå¤„æ–¹åˆ›å»ºæˆåŠŸåæ›´æ–°é—®è¯ŠçŠ¶æ€ä¸ºå®Œæˆ
                    await updateConsultationStatus('completed', result.prescription_id);
                    
                    // å¤„æ–¹åˆ›å»ºæˆåŠŸï¼Œè¿›å…¥æ”¯ä»˜æµç¨‹
                    hidePrescriptionModal();
                    showPaymentModal(result.prescription_id, 80.00);
                } else {
                    // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                    const errorMsg = result.message || result.detail || 'å¤„æ–¹åˆ›å»ºå¤±è´¥';
                    console.error('å¤„æ–¹åˆ›å»ºå¤±è´¥:', result);
                    showMessage(errorMsg, 'error');
                }
                
            } catch (error) {
                console.error('æ”¯ä»˜æµç¨‹å¯åŠ¨å¤±è´¥:', error);
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€', 'error');
                } else {
                    showMessage(`æœåŠ¡æš‚æ—¶ä¸å¯ç”¨: ${error.message}`, 'error');
                }
            }
        }

        // å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿ
        function consultDoctor() {
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•åå†å’¨è¯¢åŒ»ç”Ÿ', 'error');
                showLoginModal();
                return;
            }
            
            // è·å–å½“å‰å¤„æ–¹å†…å®¹
            const prescriptionElement = document.querySelector('.prescription-content');
            const prescriptionContent = prescriptionElement ? prescriptionElement.textContent : '';
            
            if (!prescriptionContent) {
                showMessage('è¯·å…ˆç”Ÿæˆå¤„æ–¹åå†å’¨è¯¢åŒ»ç”Ÿ', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŒ»ç”Ÿå’¨è¯¢å¯¹è¯æ¡†
            showDoctorConsultationModal(prescriptionContent);
        }
        
        // æ˜¾ç¤ºåŒ»ç”Ÿå’¨è¯¢å¯¹è¯æ¡†
        function showDoctorConsultationModal(prescriptionContent) {
            // åˆ›å»ºåŒ»ç”Ÿå’¨è¯¢æ¨¡æ€æ¡†
            let modal = document.getElementById('doctorConsultationModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'doctorConsultationModal';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="hideDoctorConsultationModal()">
                        <div class="modal-content doctor-consultation-modal" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3>ğŸ’¬ å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿ</h3>
                                <button class="close-btn" onclick="hideDoctorConsultationModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="consultation-info">
                                    <p>æ‚¨å¯ä»¥å°±ä»¥ä¸‹AIç”Ÿæˆçš„å¤„æ–¹å’¨è¯¢æˆ‘ä»¬çš„ä¸“ä¸šä¸­åŒ»å¸ˆï¼š</p>
                                    <div class="prescription-preview">
                                        ${prescriptionContent}
                                    </div>
                                </div>
                                <div class="doctor-list">
                                    <h4>é€‰æ‹©å’¨è¯¢åŒ»ç”Ÿï¼š</h4>
                                    <div class="available-doctors">
                                        <div class="doctor-card" onclick="startConsultation('å¼ åŒ»ç”Ÿ', 'zhangyi')">
                                            <div class="doctor-avatar">å¼ </div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">å¼ åŒ»ç”Ÿ</div>
                                                <div class="doctor-specialty">ä¸­åŒ»å†…ç§‘ â€¢ åœ¨çº¿</div>
                                                <div class="doctor-experience">20å¹´ç»éªŒ</div>
                                            </div>
                                            <div class="consult-btn">ğŸ’¬ å’¨è¯¢</div>
                                        </div>
                                        <div class="doctor-card" onclick="startConsultation('æåŒ»ç”Ÿ', 'liwang')">
                                            <div class="doctor-avatar">æ</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">æåŒ»ç”Ÿ</div>
                                                <div class="doctor-specialty">ä¸­åŒ»å¦‡ç§‘ â€¢ åœ¨çº¿</div>
                                                <div class="doctor-experience">15å¹´ç»éªŒ</div>
                                            </div>
                                            <div class="consult-btn">ğŸ’¬ å’¨è¯¢</div>
                                        </div>
                                        <div class="doctor-card" onclick="startConsultation('ç‹åŒ»ç”Ÿ', 'wanglin')">
                                            <div class="doctor-avatar">ç‹</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">ç‹åŒ»ç”Ÿ</div>
                                                <div class="doctor-specialty">ä¸­åŒ»å„¿ç§‘ â€¢ åœ¨çº¿</div>
                                                <div class="doctor-experience">18å¹´ç»éªŒ</div>
                                            </div>
                                            <div class="consult-btn">ğŸ’¬ å’¨è¯¢</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="consultation-notice">
                                    <p><strong>ğŸ’¡ å’¨è¯¢è¯´æ˜ï¼š</strong></p>
                                    <ul>
                                        <li>ä¸“ä¸šåŒ»ç”Ÿå°†ä¸ºæ‚¨è§£ç­”å¤„æ–¹ç›¸å…³é—®é¢˜</li>
                                        <li>å¯ä»¥è¯¢é—®è¯æåŠŸæ•ˆã€ç”¨æ³•ç”¨é‡ç­‰</li>
                                        <li>åŒ»ç”Ÿä¼šæ ¹æ®æ‚¨çš„å…·ä½“æƒ…å†µè°ƒæ•´å¤„æ–¹</li>
                                        <li>å’¨è¯¢è´¹ç”¨ï¼š50å…ƒ/æ¬¡ï¼Œçº¦15åˆ†é’Ÿ</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="hideDoctorConsultationModal()">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // æ·»åŠ æ ·å¼
                if (!document.getElementById('doctorConsultationStyles')) {
                    const styles = document.createElement('style');
                    styles.id = 'doctorConsultationStyles';
                    styles.innerHTML = `
                        .doctor-consultation-modal {
                            width: 90%;
                            max-width: 600px;
                            max-height: 80vh;
                            overflow-y: auto;
                        }
                        .prescription-preview {
                            background: #f8f9fa;
                            border: 1px solid #e9ecef;
                            border-radius: 8px;
                            padding: 15px;
                            margin: 10px 0;
                            font-size: 14px;
                            line-height: 1.6;
                            max-height: 150px;
                            overflow-y: auto;
                        }
                        .available-doctors {
                            display: grid;
                            gap: 10px;
                            margin-top: 10px;
                        }
                        .doctor-card {
                            display: flex;
                            align-items: center;
                            padding: 15px;
                            border: 2px solid #e9ecef;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            background: white;
                        }
                        .doctor-card:hover {
                            border-color: #10b981;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
                            transform: translateY(-2px);
                        }
                        .doctor-avatar {
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 18px;
                            margin-right: 15px;
                        }
                        .doctor-info {
                            flex: 1;
                        }
                        .doctor-name {
                            font-weight: 600;
                            font-size: 16px;
                            margin-bottom: 4px;
                        }
                        .doctor-specialty {
                            color: #10b981;
                            font-size: 14px;
                            margin-bottom: 2px;
                        }
                        .doctor-experience {
                            color: #6b7280;
                            font-size: 12px;
                        }
                        .consult-btn {
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: 500;
                        }
                        .consultation-notice {
                            background: #f0f9ff;
                            border: 1px solid #bae6fd;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        .consultation-notice ul {
                            margin: 8px 0 0 20px;
                        }
                        .consultation-notice li {
                            margin-bottom: 4px;
                            font-size: 14px;
                        }
                    `;
                    document.head.appendChild(styles);
                }
            }
            
            modal.style.display = 'flex';
            showMessage('è¯·é€‰æ‹©æ‚¨æƒ³è¦å’¨è¯¢çš„åŒ»ç”Ÿ', 'info');
        }
        
        // éšè—åŒ»ç”Ÿå’¨è¯¢å¯¹è¯æ¡†
        function hideDoctorConsultationModal() {
            const modal = document.getElementById('doctorConsultationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // å¼€å§‹ä¸åŒ»ç”Ÿçš„å’¨è¯¢
        function startConsultation(doctorName, doctorId) {
            hideDoctorConsultationModal();
            showMessage(`æ­£åœ¨è¿æ¥${doctorName}ï¼Œè¯·ç¨å€™...`, 'info');
            
            // æ¨¡æ‹Ÿè¿æ¥åŒ»ç”Ÿ
            setTimeout(() => {
                showMessage(`å·²æˆåŠŸè¿æ¥${doctorName}ï¼æ‚¨å¯ä»¥å¼€å§‹å’¨è¯¢äº†`, 'success');
                
                // è¿™é‡Œå¯ä»¥é›†æˆçœŸå®çš„åŒ»ç”Ÿå’¨è¯¢ç³»ç»Ÿ
                // æ¯”å¦‚æ‰“å¼€èŠå¤©çª—å£ã€WebSocketè¿æ¥ç­‰
                showDoctorChatInterface(doctorName, doctorId);
            }, 2000);
        }
        
        // æ˜¾ç¤ºåŒ»ç”ŸèŠå¤©ç•Œé¢ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function showDoctorChatInterface(doctorName, doctorId) {
            showMessage(`${doctorName}ï¼šæ‚¨å¥½ï¼æˆ‘å·²ç»çœ‹åˆ°æ‚¨çš„å¤„æ–¹ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥éšæ—¶é—®æˆ‘ã€‚`, 'info');
            
            // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥é›†æˆçœŸå®çš„èŠå¤©ç³»ç»Ÿ
            // æ¯”å¦‚ï¼š
            // - WebSocketå®æ—¶é€šä¿¡
            // - èŠå¤©è®°å½•å­˜å‚¨
            // - æ–‡ä»¶ä¼ è¾“åŠŸèƒ½
            // - è§†é¢‘é€šè¯åŠŸèƒ½ç­‰
        }

        // ä¿å­˜å¤„æ–¹
        async function savePrescription(encodedPrescription) {
            try {
                const prescriptionContent = decodeURIComponent(atob(encodedPrescription));
                
                if (!currentUser) {
                    showMessage('è¯·å…ˆç™»å½•åå†ä¿å­˜å¤„æ–¹', 'error');
                    showLoginModal();
                    return;
                }
                
                const response = await fetch('/api/prescription/save', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        content: prescriptionContent,
                        doctor_id: selectedDoctor,
                        status: 'saved'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('å¤„æ–¹å·²ä¿å­˜åˆ°æ‚¨çš„ç—…å†è®°å½•ä¸­', 'success');
                } else {
                    showMessage(result.message || 'å¤„æ–¹ä¿å­˜å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('ä¿å­˜å¤„æ–¹å¤±è´¥:', error);
                showMessage('ä¿å­˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // æ˜¾ç¤ºæ”¯ä»˜æ¨¡æ€æ¡†
        // è·å–å¤„æ–¹å†…å®¹çš„è¾…åŠ©å‡½æ•°
        function getPrescriptionContent() {
            // ä»æœ€æ–°çš„AIæ¶ˆæ¯ä¸­è·å–å¤„æ–¹å†…å®¹
            const messages = document.querySelectorAll('.message');
            let prescriptionContent = '';
            
            // ä»åå¾€å‰æŸ¥æ‰¾åŒ…å«å¤„æ–¹çš„AIæ¶ˆæ¯
            for (let i = messages.length - 1; i >= 0; i--) {
                const message = messages[i];
                const messageText = message.querySelector('.message-text');
                
                if (message.classList.contains('ai-message') && messageText) {
                    const content = messageText.textContent || messageText.innerText || '';
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤„æ–¹ç›¸å…³å†…å®¹
                    if (content.includes('å¤„æ–¹') || content.includes('æ–¹å‰‚') || content.includes('è¯æ') || 
                        content.includes('å›è¯') || content.includes('è‡£è¯') || content.includes('ä½è¯') || content.includes('ä½¿è¯')) {
                        prescriptionContent = content;
                        break;
                    }
                }
            }
            
            return prescriptionContent;
        }

        function showPaymentModal(prescriptionId, amount) {
            // è·å–å¤„æ–¹å†…å®¹
            const prescriptionContent = getPrescriptionContent();
            let formattedContent = '';
            
            if (prescriptionContent && window.prescriptionContentRenderer) {
                formattedContent = window.prescriptionContentRenderer.formatRegularContent(prescriptionContent);
            } else {
                formattedContent = '<p class="no-content">æ­£åœ¨åŠ è½½å¤„æ–¹å†…å®¹...</p>';
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†
            let modal = document.getElementById('paymentModal');
            if (!modal) {
                // åˆ›å»ºæ”¯ä»˜æ¨¡æ€æ¡†
                modal = document.createElement('div');
                modal.id = 'paymentModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1002;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; text-align: center; position: sticky; top: 0; z-index: 1;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">ğŸ“‹ å¤„æ–¹ç¡®è®¤ä¸æ”¯ä»˜</h3>
                        </div>
                        
                        <div style="padding: 24px;">
                            <div style="margin-bottom: 24px; background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                    ğŸ“‹ é—®è¯Šæ±‡æ€»ä¿¡æ¯
                                </h4>
                                <div id="prescriptionModalContent">
                                    ${formattedContent}
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; border: 1px solid #3b82f6;">
                                <div style="font-size: 32px; font-weight: bold; color: #1e40af; margin-bottom: 8px;">Â¥ ${amount.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #1e40af;">åŒ…å«ï¼šå¤„æ–¹è¯Šç–—è´¹ + ä»£ç…æœåŠ¡è´¹</div>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <button onclick="payWithAlipay('${prescriptionId}', ${amount})" 
                                        style="width: 100%; padding: 16px; border: 2px solid #1677ff; background: #f0f8ff; color: #1677ff; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    ğŸ’™ æ”¯ä»˜å®æ”¯ä»˜
                                </button>
                                <button onclick="payWithWechat('${prescriptionId}', ${amount})" 
                                        style="width: 100%; padding: 16px; border: 2px solid #07c160; background: #f0fff4; color: #07c160; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    ğŸ’š å¾®ä¿¡æ”¯ä»˜
                                </button>
                            </div>
                            
                            <div style="text-align: center;">
                                <button onclick="hidePaymentModal()" 
                                        style="color: #6b7280; background: none; border: none; cursor: pointer; text-decoration: underline; font-size: 14px;">
                                    å–æ¶ˆæ”¯ä»˜
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } else {
                // æ›´æ–°å·²å­˜åœ¨çš„æ¨¡æ€æ¡†å†…å®¹
                const contentDiv = modal.querySelector('#prescriptionModalContent');
                if (contentDiv) {
                    contentDiv.innerHTML = formattedContent;
                }
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';
        }

        // éšè—æ”¯ä»˜æ¨¡æ€æ¡†
        function hidePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // æ”¯ä»˜å®æ”¯ä»˜
        async function payWithAlipay(prescriptionId, amount) {
            try {
                const response = await fetch('/api/payment/alipay/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        prescription_id: prescriptionId,
                        amount: amount,
                        payment_method: 'alipay'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // æ˜¾ç¤ºæ”¯ä»˜å®æ“ä½œé€‰æ‹©
                    hidePaymentModal();
                    showAlipayOptions(result.data.payment_url, result.data.payment_id, prescriptionId);
                } else {
                    showMessage(result.message || 'æ”¯ä»˜åˆ›å»ºå¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥:', error);
                showMessage('æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // æ˜¾ç¤ºæ”¯ä»˜å®æ“ä½œé€‰æ‹©
        function showAlipayOptions(paymentUrl, paymentId, prescriptionId) {
            let modal = document.getElementById('alipayOptionsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'alipayOptionsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1003;
                `;
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 32px; text-align: center; max-width: 400px;">
                    <h3 style="margin: 0 0 20px 0; color: #1677ff;">ğŸ’™ æ”¯ä»˜å®æ”¯ä»˜</h3>
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 60px;">ğŸ’°</div>
                        <div style="margin-top: 12px; color: #666; font-size: 14px;">è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="window.open('${paymentUrl}', '_blank'); pollPaymentStatus('${paymentId}'); hideAlipayOptionsModal();" 
                                style="padding: 12px 20px; background: #1677ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            ğŸŒ è·³è½¬æ”¯ä»˜å®ç½‘é¡µæ”¯ä»˜
                        </button>
                        <button onclick="testAlipayPaymentSuccess('${paymentId}', '${prescriptionId}')" 
                                style="padding: 12px 20px; background: #52c41a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            âœ… æµ‹è¯•æ”¯ä»˜æˆåŠŸ
                        </button>
                        <button onclick="hideAlipayOptionsModal()" 
                                style="padding: 8px 20px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            å–æ¶ˆæ”¯ä»˜
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // éšè—æ”¯ä»˜å®é€‰é¡¹æ¨¡æ€æ¡†
        function hideAlipayOptionsModal() {
            const modal = document.getElementById('alipayOptionsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // æµ‹è¯•æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸ
        async function testAlipayPaymentSuccess(paymentId, prescriptionId) {
            try {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€ (è°ƒè¯•ä¿¡æ¯)
                console.log('ğŸ”„ ç”¨æˆ·ç™»å½•çŠ¶æ€ - Token:', !!userToken, 'User:', !!currentUser);
                
                const encodedOrderNo = encodeURIComponent(paymentId);
                console.log('ğŸ”„ æµ‹è¯•æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸï¼Œorder_no:', paymentId);
                
                const response = await fetch(`/api/payment/alipay/test-success?order_no=${encodedOrderNo}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                console.log('ğŸ”„ æ”¯ä»˜å®APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ æ”¯ä»˜å®APIé”™è¯¯å“åº”:', errorText);
                    showMessage(`æ”¯ä»˜APIé”™è¯¯: ${response.status}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('ğŸ“‹ æ”¯ä»˜å®APIå“åº”ç»“æœ:', result);
                
                if (result.success) {
                    hideAlipayOptionsModal();
                    showMessage('æµ‹è¯•æ”¯ä»˜æˆåŠŸï¼æ‚¨çš„å¤„æ–¹å·²è§£é”', 'success');
                    
                    // æ›´æ–°UIä¸­çš„å¤„æ–¹çŠ¶æ€ä¸ºå·²æ”¯ä»˜
                    await markPrescriptionAsPaid(result.prescription_id || prescriptionId);
                    
                    // æ˜¾ç¤ºä»£ç…æœåŠ¡ä¿¡æ¯
                    setTimeout(() => {
                        showDecorationInfo(result.prescription_id || prescriptionId);
                    }, 2000);
                } else {
                    console.error('âŒ æ”¯ä»˜å®æ”¯ä»˜æµ‹è¯•å¤±è´¥:', result);
                    showMessage(result.message || result.error?.message || 'æµ‹è¯•æ”¯ä»˜å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('æµ‹è¯•æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥:', error);
                showMessage('æµ‹è¯•æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // å¾®ä¿¡æ”¯ä»˜
        async function payWithWechat(prescriptionId, amount) {
            try {
                const response = await fetch('/api/payment/wechat/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        prescription_id: prescriptionId,
                        amount: amount,
                        payment_method: 'wechat'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // æ˜¾ç¤ºå¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
                    hidePaymentModal();
                    showWechatQRCode(result.data.qr_code, result.data.payment_id);
                } else {
                    showMessage(result.message || 'æ”¯ä»˜åˆ›å»ºå¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('å¾®ä¿¡æ”¯ä»˜å¤±è´¥:', error);
                showMessage('æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // æ˜¾ç¤ºå¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
        function showWechatQRCode(qrCode, paymentId) {
            let modal = document.getElementById('wechatQRModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'wechatQRModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1003;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 32px; text-align: center; max-width: 350px;">
                        <h3 style="margin: 0 0 20px 0; color: #07c160;">ğŸ’š å¾®ä¿¡æ”¯ä»˜</h3>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 100px;">ğŸ“±</div>
                            <div style="margin-top: 12px; color: #666; font-size: 14px;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç æ”¯ä»˜</div>
                        </div>
                        <div style="color: #666; font-size: 12px; margin-bottom: 20px;">
                            æ”¯ä»˜å®Œæˆåé¡µé¢å°†è‡ªåŠ¨æ›´æ–°
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="testWechatPaymentSuccess('${paymentId}')" 
                                    style="padding: 8px 16px; background: #07c160; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                âœ… æµ‹è¯•æ”¯ä»˜æˆåŠŸ
                            </button>
                            <button onclick="hideWechatQRModal()" 
                                    style="padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                å–æ¶ˆæ”¯ä»˜
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
            modal.style.display = 'flex';
            pollPaymentStatus(paymentId);
        }

        // éšè—å¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
        function hideWechatQRModal() {
            const modal = document.getElementById('wechatQRModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // è½®è¯¢æ”¯ä»˜çŠ¶æ€
        async function pollPaymentStatus(paymentId) {
            const maxAttempts = 60; // æœ€å¤šè½®è¯¢60æ¬¡ (5åˆ†é’Ÿ)
            let attempts = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/payment/status/${paymentId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        if (result.data.status === 'paid') {
                            // æ”¯ä»˜æˆåŠŸ
                            hideWechatQRModal();
                            hidePaymentModal();
                            showMessage('æ”¯ä»˜æˆåŠŸï¼æ‚¨çš„å¤„æ–¹å·²ç¡®è®¤', 'success');
                            
                            // ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ›´æ–°UIä¸­çš„å¤„æ–¹çŠ¶æ€ä¸ºå·²æ”¯ä»˜
                            await markPrescriptionAsPaid(result.data.prescription_id);
                            
                            // æ˜¾ç¤ºä»£ç…æœåŠ¡ä¿¡æ¯
                            setTimeout(() => {
                                showDecorationInfo(result.data.prescription_id);
                            }, 2000);
                            
                            return;
                        } else if (result.data.status === 'failed' || result.data.status === 'cancelled') {
                            // æ”¯ä»˜å¤±è´¥
                            hideWechatQRModal();
                            hidePaymentModal();
                            showMessage('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                            return;
                        }
                    }
                    
                    // ç»§ç»­è½®è¯¢
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000); // 5ç§’åå†æ¬¡è½®è¯¢
                    } else {
                        // è¶…æ—¶
                        hideWechatQRModal();
                        hidePaymentModal();
                        showMessage('æ”¯ä»˜è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
                    }
                    
                } catch (error) {
                    console.error('æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    }
                }
            };
            
            // å¼€å§‹è½®è¯¢
            poll();
        }

        // æµ‹è¯•å¾®ä¿¡æ”¯ä»˜æˆåŠŸ
        async function testWechatPaymentSuccess(paymentId) {
            try {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€ (è°ƒè¯•ä¿¡æ¯)
                console.log('ğŸ”„ ç”¨æˆ·ç™»å½•çŠ¶æ€ - Token:', !!userToken, 'User:', !!currentUser);
                
                // ä»paymentIdä¸­æå–order_no (paymentIdå®é™…ä¸Šå°±æ˜¯order_no)
                const encodedOrderNo = encodeURIComponent(paymentId);
                console.log('ğŸ”„ æµ‹è¯•å¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼Œorder_no:', paymentId);
                
                const response = await fetch(`/api/payment/wechat/test-success?order_no=${encodedOrderNo}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                console.log('ğŸ”„ å¾®ä¿¡æ”¯ä»˜APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ å¾®ä¿¡æ”¯ä»˜APIé”™è¯¯å“åº”:', errorText);
                    showMessage(`æ”¯ä»˜APIé”™è¯¯: ${response.status}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('ğŸ“‹ å¾®ä¿¡æ”¯ä»˜APIå“åº”ç»“æœ:', result);
                
                if (result.success) {
                    hideWechatQRModal();
                    hidePaymentModal();
                    showMessage('æµ‹è¯•æ”¯ä»˜æˆåŠŸï¼æ‚¨çš„å¤„æ–¹å·²è§£é”', 'success');
                    
                    // æ›´æ–°UIä¸­çš„å¤„æ–¹çŠ¶æ€ä¸ºå·²æ”¯ä»˜
                    await markPrescriptionAsPaid(result.prescription_id);
                    
                    // æ˜¾ç¤ºä»£ç…æœåŠ¡ä¿¡æ¯
                    setTimeout(() => {
                        showDecorationInfo(result.prescription_id);
                    }, 2000);
                } else {
                    console.error('âŒ å¾®ä¿¡æ”¯ä»˜æµ‹è¯•å¤±è´¥:', result);
                    showMessage(result.message || result.error?.message || 'æµ‹è¯•æ”¯ä»˜å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('æµ‹è¯•å¾®ä¿¡æ”¯ä»˜å¤±è´¥:', error);
                showMessage('æµ‹è¯•æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // æ˜¾ç¤ºä»£ç…æœåŠ¡ä¿¡æ¯
        function showDecorationInfo(prescriptionId) {
            showMessage('ä»£ç…æœåŠ¡å·²å¯åŠ¨ï¼Œæˆ‘ä»¬å°†åœ¨24å°æ—¶å†…è”ç³»æ‚¨å®‰æ’é…é€', 'success');
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä»£ç…æœåŠ¡çš„è¯¦ç»†ä¿¡æ¯
            // ä¾‹å¦‚è·³è½¬åˆ°è®¢å•é¡µé¢ç­‰
        }

        // ===================== å¤„æ–¹ç®¡ç†ç³»ç»Ÿç»“æŸ =====================

        // ===================== åŒ»ç–—å®‰å…¨ä¿éšœç³»ç»Ÿ =====================
        
        // æ£€æŸ¥æ¶ˆæ¯ä¸­çš„åŒ»ç–—å®‰å…¨é—®é¢˜
        function checkMedicalSafety(content) {
            const warnings = [];
            
            // é˜²æ­¢undefinedé”™è¯¯
            if (!content || typeof content !== 'string') {
                console.warn('checkMedicalSafety: æ— æ•ˆçš„å†…å®¹å‚æ•°', content);
                return warnings;
            }
            
            // æ£€æŸ¥è¥¿è¯ç›¸å…³å†…å®¹
            const westernMedicineKeywords = ['é˜¿å¸åŒ¹æ—', 'æ„Ÿå†’çµ', 'æŠ—ç”Ÿç´ ', 'é’éœ‰ç´ ', 'å¤´å­¢', 'å¸ƒæ´›èŠ¬', 'å¯¹ä¹™é…°æ°¨åŸºé…š'];
            for (const keyword of westernMedicineKeywords) {
                if (content.includes(keyword)) {
                    warnings.push({
                        type: 'western_medicine',
                        message: `æ£€æµ‹åˆ°è¥¿è¯æˆåˆ†"${keyword}"ï¼Œæœ¬ç³»ç»Ÿä»…æä¾›ä¸­åŒ»è¯Šç–—å»ºè®®`
                    });
                }
            }
            
            // æ£€æŸ¥å±é™©ç—‡çŠ¶
            const dangerousSymptoms = ['èƒ¸ç—›', 'å‘¼å¸å›°éš¾', 'æ„è¯†æ¨¡ç³Š', 'å¤§å‡ºè¡€', 'é«˜çƒ­ä¸é€€', 'å‰§çƒˆè…¹ç—›'];
            for (const symptom of dangerousSymptoms) {
                if (content.includes(symptom)) {
                    warnings.push({
                        type: 'emergency',
                        message: `"${symptom}"å¯èƒ½ä¸ºæ€¥ç—‡ï¼Œå»ºè®®ç«‹å³å°±åŒ»`
                    });
                }
            }
            
            // æ£€æŸ¥å­•å¦‡ç¦ç”¨è¯æ
            const pregnancyForbidden = ['çº¢èŠ±', 'æ¡ƒä»', 'ç‰›è†', 'å¤§é»„', 'èŠ’ç¡', 'é™„å­', 'è‚‰æ¡‚'];
            if (content.includes('å­•å¦‡') || content.includes('æ€€å­•')) {
                for (const herb of pregnancyForbidden) {
                    if (content.includes(herb)) {
                        warnings.push({
                            type: 'pregnancy_risk',
                            message: `"${herb}"å­•å¦‡ç¦ç”¨ï¼Œè¯·è°¨æ…ä½¿ç”¨`
                        });
                    }
                }
            }
            
            return warnings;
        }

        // æ˜¾ç¤ºåŒ»ç–—å®‰å…¨è­¦å‘Š
        function showMedicalWarnings(warnings) {
            if (warnings.length === 0) return;
            
            const warningContainer = document.createElement('div');
            warningContainer.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                max-width: 300px;
                z-index: 10001;
                animation: slideInRight 0.3s ease-out;
            `;
            
            warnings.forEach((warning, index) => {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    font-size: 13px;
                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                `;
                
                warningDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span>âš ï¸</span>
                        <strong>åŒ»ç–—å®‰å…¨æé†’</strong>
                    </div>
                    <div>${warning.message}</div>
                `;
                
                warningContainer.appendChild(warningDiv);
                
                // è‡ªåŠ¨ç§»é™¤è­¦å‘Š
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.style.animation = 'slideOutRight 0.3s ease-out';
                        setTimeout(() => {
                            if (warningDiv.parentNode) {
                                warningDiv.parentNode.removeChild(warningDiv);
                            }
                        }, 300);
                    }
                }, 8000 + index * 1000); // é”™å¼€ç§»é™¤æ—¶é—´
            });
            
            document.body.appendChild(warningContainer);
            
            // å®¹å™¨è‡ªæ¸…ç†
            setTimeout(() => {
                if (warningContainer.parentNode && warningContainer.children.length === 0) {
                    warningContainer.parentNode.removeChild(warningContainer);
                }
            }, 15000);
        }

        // è®°å½•å®‰å…¨äº‹ä»¶
        async function logSecurityEvent(eventType, content, details = {}) {
            try {
                const response = await fetch('/api/security/log-event', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        event_type: eventType,
                        content: content,
                        details: details,
                        user_id: currentUser ? currentUser.id : null,
                        conversation_id: currentConversationId,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('å®‰å…¨äº‹ä»¶è®°å½•å¤±è´¥:', result.message);
                }
                
            } catch (error) {
                console.error('å®‰å…¨äº‹ä»¶è®°å½•å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥ç—‡çŠ¶ç¼–é€ 
        function detectSymptomFabrication(userInput, aiResponse) {
            // é˜²æ­¢undefinedé”™è¯¯
            if (!userInput || typeof userInput !== 'string' || !aiResponse || typeof aiResponse !== 'string') {
                console.warn('detectSymptomFabrication: æ— æ•ˆçš„å‚æ•°', {userInput, aiResponse});
                return;
            }
            
            // æ£€æŸ¥AIæ˜¯å¦æ·»åŠ äº†ç”¨æˆ·æœªæåŠçš„ç—‡çŠ¶ï¼ˆæ™ºèƒ½æ£€æµ‹ï¼‰
            const userSymptoms = extractSymptomsFromText(userInput);
            const aiSymptoms = extractSymptomsFromText(aiResponse);
            
            // ä½¿ç”¨æ™ºèƒ½å…³è”æ€§æ£€æŸ¥ï¼Œè¿‡æ»¤æ‰åŒ»å­¦ä¸Šåˆç†çš„ç—‡çŠ¶
            const fabricatedSymptoms = aiSymptoms.filter(symptom => 
                !isSymptomsRelated(userSymptoms, symptom)
            );
            
            // åªæœ‰å½“AIæ·»åŠ äº†æ˜æ˜¾ä¸ç›¸å…³çš„ç—‡çŠ¶æ—¶æ‰æŠ¥è­¦
            if (fabricatedSymptoms.length > 0 && userSymptoms.length > 0) {
                // è®¡ç®—ç¼–é€ ç—‡çŠ¶çš„æ¯”ä¾‹ï¼Œé¿å…è¯¯æŠ¥
                const fabricationRatio = fabricatedSymptoms.length / aiSymptoms.length;
                
                // åªæœ‰å½“ç¼–é€ æ¯”ä¾‹è¶…è¿‡50%ä¸”ç”¨æˆ·æ˜ç¡®æè¿°äº†ç—‡çŠ¶æ—¶æ‰æŠ¥è­¦
                if (fabricationRatio > 0.5) {
                    logSecurityEvent('symptom_fabrication', aiResponse, {
                        user_symptoms: userSymptoms,
                        ai_symptoms: aiSymptoms,
                        fabricated: fabricatedSymptoms,
                        fabrication_ratio: fabricationRatio
                    });
                    
                    showMedicalWarnings([{
                        type: 'symptom_fabrication',
                        message: `AIå¯èƒ½æ·»åŠ äº†æ‚¨æœªæè¿°çš„ç—‡çŠ¶ï¼Œè¯·æ ¸å®: ${fabricatedSymptoms.join(', ')}`
                    }]);
                }
            }
        }

        // å¢å¼ºç‰ˆæœ¬çš„æ¶ˆæ¯å‘é€ï¼Œæ·»åŠ å®‰å…¨æ£€æŸ¥
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            // æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„å®‰å…¨æ€§
            const userWarnings = checkMedicalSafety(message);
            if (userWarnings.length > 0) {
                showMedicalWarnings(userWarnings);
                // è®°å½•å®‰å…¨äº‹ä»¶
                userWarnings.forEach(warning => {
                    logSecurityEvent(warning.type, message, warning);
                });
            }
            
            // è°ƒç”¨åŸå§‹å‘é€å‡½æ•°
            return originalSendMessage.call(this);
        };

        // ===================== åŒ»ç–—å®‰å…¨ä¿éšœç³»ç»Ÿç»“æŸ =====================

        // ===================== éšè®¿æé†’ç³»ç»Ÿ =====================
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥éšè®¿æé†’
        document.addEventListener('DOMContentLoaded', function() {
            checkFollowUpReminders();
        });

        // æ£€æŸ¥éšè®¿æé†’
        async function checkFollowUpReminders() {
            if (!currentUser || !userToken) return;
            
            try {
                const response = await fetch('/api/follow-up/reminders', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    // æ˜¾ç¤ºéšè®¿æé†’
                    showFollowUpReminders(result.data);
                }
                
            } catch (error) {
                console.error('è·å–éšè®¿æé†’å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºéšè®¿æé†’
        function showFollowUpReminders(reminders) {
            // æ£€æŸ¥æ˜¯å¦å·²æ˜¾ç¤ºè¿‡æé†’
            const today = new Date().toDateString();
            const shownToday = localStorage.getItem(`followup_shown_${today}`);
            
            if (shownToday) return;
            
            const reminderContainer = document.createElement('div');
            reminderContainer.id = 'followUpContainer';
            reminderContainer.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                max-width: 350px;
                z-index: 10002;
                animation: slideInRight 0.3s ease-out;
            `;
            
            reminderContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px; padding: 16px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">ğŸ””</span>
                            <strong style="font-size: 16px;">éšè®¿æé†’</strong>
                        </div>
                        <button onclick="dismissFollowUpReminders()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px;">Ã—</button>
                    </div>
                    
                    <div style="font-size: 14px; line-height: 1.5; margin-bottom: 12px;">
                        æ‚¨æœ‰ <strong>${reminders.length}</strong> æ¡éšè®¿æé†’
                    </div>
                    
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${reminders.slice(0, 3).map(reminder => `
                            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 8px; font-size: 13px;">
                                <div style="font-weight: 500; margin-bottom: 4px;">${reminder.title}</div>
                                <div style="opacity: 0.9;">${reminder.message}</div>
                                <div style="font-size: 11px; opacity: 0.8; margin-top: 6px;">
                                    ${new Date(reminder.scheduled_date).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="viewAllFollowUps()" style="flex: 1; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            æŸ¥çœ‹å…¨éƒ¨
                        </button>
                        <button onclick="scheduleFollowUp()" style="flex: 1; background: white; border: none; color: #059669; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                            æ–°å»ºéšè®¿
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(reminderContainer);
            
            // æ ‡è®°ä»Šå¤©å·²æ˜¾ç¤º
            localStorage.setItem(`followup_shown_${today}`, 'true');
            
            // 10ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                dismissFollowUpReminders();
            }, 10000);
        }

        // å…³é—­éšè®¿æé†’
        function dismissFollowUpReminders() {
            const container = document.getElementById('followUpContainer');
            if (container) {
                container.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }, 300);
            }
        }

        // æŸ¥çœ‹æ‰€æœ‰éšè®¿
        function viewAllFollowUps() {
            dismissFollowUpReminders();
            showFollowUpModal();
        }

        // æ˜¾ç¤ºéšè®¿ç®¡ç†æ¨¡æ€æ¡†
        async function showFollowUpModal() {
            try {
                const response = await fetch('/api/follow-up/list', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('è·å–éšè®¿è®°å½•å¤±è´¥', 'error');
                    return;
                }
                
                createFollowUpModal(result.data || []);
                
            } catch (error) {
                console.error('è·å–éšè®¿è®°å½•å¤±è´¥:', error);
                showMessage('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // åˆ›å»ºéšè®¿ç®¡ç†æ¨¡æ€æ¡†
        function createFollowUpModal(followUps) {
            let modal = document.getElementById('followUpModal');
            if (modal) {
                modal.remove();
            }
            
            modal = document.createElement('div');
            modal.id = 'followUpModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1005;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 20px; font-weight: 600;">ğŸ”” éšè®¿ç®¡ç†</h3>
                        <button onclick="hideFollowUpModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px;">
                                <button onclick="showActiveFollowUps()" id="activeFollowUpsBtn" style="padding: 8px 16px; border: 2px solid #10b981; background: #10b981; color: white; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    å¾…éšè®¿
                                </button>
                                <button onclick="showCompletedFollowUps()" id="completedFollowUpsBtn" style="padding: 8px 16px; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    å·²å®Œæˆ
                                </button>
                            </div>
                            <button onclick="scheduleNewFollowUp()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                                + æ–°å»ºéšè®¿
                            </button>
                        </div>
                        
                        <div id="followUpContainer">
                            ${followUps.length > 0 ? generateFollowUpHTML(followUps) : '<div style="text-align: center; color: #6b7280; padding: 40px;">æš‚æ— éšè®¿è®°å½•</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ç”Ÿæˆéšè®¿è®°å½•HTML
        function generateFollowUpHTML(followUps) {
            return followUps.map(followUp => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px;">${followUp.title}</h4>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 13px;">éšè®¿æ—¶é—´: ${new Date(followUp.scheduled_date).toLocaleString()}</p>
                        </div>
                        <span style="padding: 4px 12px; background: ${followUp.status === 'completed' ? '#dcfce7' : followUp.status === 'overdue' ? '#fee2e2' : '#fef3c7'}; color: ${followUp.status === 'completed' ? '#166534' : followUp.status === 'overdue' ? '#dc2626' : '#92400e'}; border-radius: 12px; font-size: 12px;">
                            ${followUp.status === 'completed' ? 'å·²å®Œæˆ' : followUp.status === 'overdue' ? 'å·²é€¾æœŸ' : 'å¾…éšè®¿'}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 12px; font-size: 14px; color: #374151;">
                        ${followUp.message}
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        ${followUp.status === 'pending' ? `
                            <button onclick="completeFollowUp('${followUp.id}')" style="padding: 6px 12px; background: #dcfce7; border: 1px solid #10b981; border-radius: 6px; font-size: 12px; cursor: pointer; color: #059669;">
                                æ ‡è®°å®Œæˆ
                            </button>
                            <button onclick="postponeFollowUp('${followUp.id}')" style="padding: 6px 12px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; font-size: 12px; cursor: pointer; color: #d97706;">
                                å»¶æœŸéšè®¿
                            </button>
                        ` : ''}
                        <button onclick="viewFollowUpDetail('${followUp.id}')" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; color: #374151;">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // éšè—éšè®¿æ¨¡æ€æ¡†
        function hideFollowUpModal() {
            const modal = document.getElementById('followUpModal');
            if (modal) {
                modal.remove();
            }
        }

        // æ–°å»ºéšè®¿
        function scheduleFollowUp() {
            dismissFollowUpReminders();
            scheduleNewFollowUp();
        }

        // å®‰æ’æ–°éšè®¿
        function scheduleNewFollowUp() {
            // ç®€åŒ–ç‰ˆæ–°å»ºéšè®¿å¯¹è¯æ¡†
            const title = prompt('è¯·è¾“å…¥éšè®¿æ ‡é¢˜:', 'è¯ç‰©ç–—æ•ˆè·Ÿè¸ª');
            if (!title) return;
            
            const days = prompt('å‡ å¤©åéšè®¿? (è¾“å…¥å¤©æ•°)', '7');
            if (!days || isNaN(days)) return;
            
            const message = prompt('éšè®¿æé†’å†…å®¹:', 'è¯·é—®ç”¨è¯åç—‡çŠ¶æ˜¯å¦æœ‰æ‰€æ”¹å–„ï¼Ÿæ˜¯å¦æœ‰ä¸é€‚ååº”ï¼Ÿ');
            if (!message) return;
            
            createFollowUpReminder(title, parseInt(days), message);
        }

        // åˆ›å»ºéšè®¿æé†’
        async function createFollowUpReminder(title, days, message) {
            try {
                const response = await fetch('/api/follow-up/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        title: title,
                        message: message,
                        days_after: days,
                        doctor_id: selectedDoctor,
                        related_consultation_id: currentConversationId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`éšè®¿æé†’å·²è®¾ç½®ï¼Œå°†åœ¨${days}å¤©åæé†’`, 'success');
                    // å¦‚æœéšè®¿æ¨¡æ€æ¡†æ‰“å¼€ï¼Œåˆ·æ–°å†…å®¹
                    const modal = document.getElementById('followUpModal');
                    if (modal) {
                        showFollowUpModal(); // é‡æ–°åŠ è½½
                    }
                } else {
                    showMessage(result.message || 'è®¾ç½®éšè®¿æé†’å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('åˆ›å»ºéšè®¿æé†’å¤±è´¥:', error);
                showMessage('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // å®Œæˆéšè®¿
        async function completeFollowUp(followUpId) {
            try {
                const response = await fetch(`/api/follow-up/${followUpId}/complete`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('éšè®¿å·²æ ‡è®°å®Œæˆ', 'success');
                    showFollowUpModal(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showMessage(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('å®Œæˆéšè®¿å¤±è´¥:', error);
                showMessage('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // å»¶æœŸéšè®¿
        async function postponeFollowUp(followUpId) {
            const days = prompt('å»¶æœŸå‡ å¤©?', '3');
            if (!days || isNaN(days)) return;
            
            try {
                const response = await fetch(`/api/follow-up/${followUpId}/postpone`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        postpone_days: parseInt(days)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`éšè®¿å·²å»¶æœŸ${days}å¤©`, 'success');
                    showFollowUpModal(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showMessage(result.message || 'å»¶æœŸå¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('å»¶æœŸéšè®¿å¤±è´¥:', error);
                showMessage('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'error');
            }
        }

        // æŸ¥çœ‹éšè®¿è¯¦æƒ…
        function viewFollowUpDetail(followUpId) {
            showMessage('éšè®¿è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // æ˜¾ç¤ºå¾…éšè®¿
        async function showActiveFollowUps() {
            updateFollowUpFilter('active');
            const response = await fetch('/api/follow-up/list?status=pending', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateFollowUpContainer(result.data || []);
        }

        // æ˜¾ç¤ºå·²å®Œæˆéšè®¿
        async function showCompletedFollowUps() {
            updateFollowUpFilter('completed');
            const response = await fetch('/api/follow-up/list?status=completed', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateFollowUpContainer(result.data || []);
        }

        // æ›´æ–°éšè®¿è¿‡æ»¤å™¨æ ·å¼
        function updateFollowUpFilter(type) {
            const buttons = ['activeFollowUpsBtn', 'completedFollowUpsBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((type === 'active' && btnId === 'activeFollowUpsBtn') ||
                        (type === 'completed' && btnId === 'completedFollowUpsBtn')) {
                        btn.style.background = '#10b981';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#10b981';
                    }
                }
            });
        }

        // æ›´æ–°éšè®¿å®¹å™¨
        function updateFollowUpContainer(followUps) {
            const container = document.getElementById('followUpContainer');
            if (container) {
                container.innerHTML = followUps.length > 0 ? generateFollowUpHTML(followUps) : '<div style="text-align: center; color: #6b7280; padding: 40px;">æš‚æ— ç›¸å…³è®°å½•</div>';
            }
        }

        // ===================== éšè®¿æé†’ç³»ç»Ÿç»“æŸ =====================

        // ===================== å¤šè®¾å¤‡ä¼šè¯åŒæ­¥ç³»ç»Ÿ =====================
        
        let syncInterval = null;
        let lastSyncTime = 0;
        let isInitialSync = true;
        
        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨åŒæ­¥
        document.addEventListener('DOMContentLoaded', function() {
            if (currentUser && userToken) {
                startSessionSync();
            }
        });

        // å¯åŠ¨ä¼šè¯åŒæ­¥
        function startSessionSync() {
            if (!currentUser || !userToken) return;
            
            // é¦–æ¬¡åŒæ­¥
            syncSessionFromServer();
            
            // è®¾ç½®å®šæœŸåŒæ­¥ (æ¯30ç§’)
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(() => {
                syncSessionFromServer();
            }, 30000); // 30ç§’åŒæ­¥ä¸€æ¬¡
            
            // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åŒæ­¥
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && currentUser) {
                    syncSessionFromServer();
                }
            });
        }

        // åœæ­¢ä¼šè¯åŒæ­¥
        function stopSessionSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // ä»æœåŠ¡å™¨åŒæ­¥ä¼šè¯çŠ¶æ€ - æš‚æ—¶ç¦ç”¨ï¼ŒAPIä¸å­˜åœ¨
        async function syncSessionFromServer() {
            // æš‚æ—¶ç¦ç”¨å¤šè®¾å¤‡åŒæ­¥åŠŸèƒ½
            // TODO: å®ç° /api/session/sync æ¥å£åå¯ç”¨
            return;
            
            try {
                const response = await fetch('/api/session/sync', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        doctor_id: selectedDoctor,
                        last_sync_time: lastSyncTime,
                        device_info: getDeviceInfo()
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    handleSyncData(result.data);
                    lastSyncTime = Date.now();
                }
                
            } catch (error) {
                console.error('ä¼šè¯åŒæ­¥å¤±è´¥:', error);
            }
        }

        // å¤„ç†åŒæ­¥æ•°æ®
        function handleSyncData(syncData) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
            if (syncData.new_messages && syncData.new_messages.length > 0) {
                syncData.new_messages.forEach(message => {
                    if (isInitialSync) return; // é¦–æ¬¡åŒæ­¥ä¸æ˜¾ç¤ºé€šçŸ¥
                    
                    // æ·»åŠ åŒæ­¥çš„æ¶ˆæ¯åˆ°ç•Œé¢
                    addSyncedMessage(message);
                });
                
                // æ˜¾ç¤ºåŒæ­¥é€šçŸ¥
                if (!isInitialSync && syncData.new_messages.length > 0) {
                    showSyncNotification(`åŒæ­¥äº†${syncData.new_messages.length}æ¡æ–°æ¶ˆæ¯`);
                }
            }
            
            // åŒæ­¥åŒ»ç”Ÿé€‰æ‹©
            if (syncData.selected_doctor && syncData.selected_doctor !== selectedDoctor) {
                if (!isInitialSync) {
                    showSyncNotification(`å·²åˆ‡æ¢åˆ°${getDoctorName(syncData.selected_doctor)}`);
                }
                selectedDoctor = syncData.selected_doctor;
                updateDoctorSelection();
            }
            
            // åŒæ­¥å¯¹è¯ID
            if (syncData.conversation_id && syncData.conversation_id !== currentConversationId) {
                currentConversationId = syncData.conversation_id;
                const userId = getCurrentUserId();
                const storageKey = `conversationId_${userId}`;
                localStorage.setItem(storageKey, currentConversationId);
            }
            
            isInitialSync = false;
        }

        // æ·»åŠ åŒæ­¥çš„æ¶ˆæ¯
        function addSyncedMessage(message) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨
            const existingMessages = container.querySelectorAll('.message');
            const messageExists = Array.from(existingMessages).some(msgEl => {
                const timeEl = msgEl.querySelector('.message-time');
                const textEl = msgEl.querySelector('.message-text');
                return timeEl && textEl && 
                       timeEl.textContent === message.time && 
                       textEl.textContent.trim() === message.content.trim();
            });
            
            if (!messageExists) {
                addMessageWithTime(message.sender, message.content, message.time, message.show_feedback);
            }
        }

        // è·å–è®¾å¤‡ä¿¡æ¯
        function getDeviceInfo() {
            return {
                user_agent: navigator.userAgent,
                screen_resolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                device_type: window.innerWidth <= 768 ? 'mobile' : 'desktop'
            };
        }

        // è·å–åŒ»ç”Ÿåç§°
        function getDoctorName(doctorId) {
            return doctors[doctorId] ? doctors[doctorId].name : 'åŒ»ç”Ÿ';
        }

        // æ˜¾ç¤ºåŒæ­¥é€šçŸ¥
        function showSyncNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 13px;
                z-index: 10003;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                animation: syncNotification 3s ease-out forwards;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 12px;">ğŸ”„</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // åŒæ­¥å½“å‰çŠ¶æ€åˆ°æœåŠ¡å™¨
        async function syncSessionToServer() {
            if (!currentUser || !userToken) return;
            
            try {
                // è·å–å½“å‰æ‰€æœ‰æ¶ˆæ¯
                const messages = [];
                const container = document.getElementById('messagesContainer');
                if (container) {
                    container.querySelectorAll('.message').forEach(messageEl => {
                        const isUser = messageEl.classList.contains('user');
                        const textEl = messageEl.querySelector('.message-text');
                        const timeEl = messageEl.querySelector('.message-time');
                        
                        if (textEl && timeEl) {
                            messages.push({
                                sender: isUser ? 'user' : 'ai',
                                content: textEl.textContent.trim(),
                                time: timeEl.textContent,
                                timestamp: Date.now()
                            });
                        }
                    });
                }
                
                // ğŸ”‘ ä¿®å¤ï¼šåŒ¹é…APIæœŸæœ›çš„å‚æ•°æ ¼å¼
                const userId = getCurrentUserId();
                const response = await fetch('/api/session/update', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        user_id: userId,
                        session_data: {
                            conversation_id: currentConversationId,
                            doctor_id: selectedDoctor,
                            messages: messages,
                            device_info: getDeviceInfo(),
                            sync_time: Date.now()
                        }
                    })
                });
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (response.status === 404) {
                    console.log('ğŸ”„ ä¼šè¯åŒæ­¥åŠŸèƒ½æš‚æœªå¯ç”¨ (404)');
                    return; // ä¼˜é›…å¤„ç†404ï¼Œä¸æŠ¥é”™
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (!result.success) {
                    console.error('ä¼šè¯çŠ¶æ€ä¸Šä¼ å¤±è´¥:', result.message);
                }
                
            } catch (error) {
                console.error('ä¼šè¯çŠ¶æ€ä¸Šä¼ å¤±è´¥:', error);
            }
        }

        // å¢å¼ºåŒ»ç”Ÿé€‰æ‹©ï¼Œæ·»åŠ åŒæ­¥åŠŸèƒ½
        const originalSelectDoctor = selectDoctor;
        selectDoctor = function(doctorId) {
            originalSelectDoctor.call(this, doctorId);
            
            // åŒæ­¥åŒ»ç”Ÿé€‰æ‹©åˆ°æœåŠ¡å™¨
            if (currentUser && userToken) {
                syncSessionToServer();
            }
        };

        // å¢å¼ºæ¶ˆæ¯å‘é€ï¼Œæ·»åŠ åŒæ­¥åŠŸèƒ½
        const originalAddMessage = addMessage;
        const originalAddMobileMessage = addMobileMessage;
        
        addMessage = function(sender, content, showFeedback = false) {
            originalAddMessage.call(this, sender, content, showFeedback);
            
            // ğŸ”‘ ä¿®å¤ï¼šåªå¯¹ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤è¿›è¡ŒåŒæ­¥ï¼Œè·³è¿‡æ¬¢è¿æ¶ˆæ¯
            if (currentUser && userToken && !content.includes('è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶')) {
                setTimeout(() => {
                    syncSessionToServer();
                }, 500); // å»¶è¿Ÿ500msç¡®ä¿DOMæ›´æ–°å®Œæˆ
            }
        };
        
        addMobileMessage = function(sender, content, showFeedback = false, isPaid = false, prescriptionId = null) {
            originalAddMobileMessage.call(this, sender, content, showFeedback, isPaid, prescriptionId);
            
            // ğŸ”‘ ä¿®å¤ï¼šåªå¯¹ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤è¿›è¡ŒåŒæ­¥ï¼Œè·³è¿‡æ¬¢è¿æ¶ˆæ¯
            if (currentUser && userToken && !content.includes('è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶')) {
                setTimeout(() => {
                    syncSessionToServer();
                }, 500);
            }
        };

        // ç™»å½•æ—¶å¯åŠ¨åŒæ­¥
        const originalUpdateUserInterface = updateUserInterface;
        updateUserInterface = function(isLoggedIn) {
            originalUpdateUserInterface.call(this, isLoggedIn);
            
            if (isLoggedIn && currentUser) {
                startSessionSync();
            } else {
                stopSessionSync();
            }
        };

        // ğŸ”‘ æ›´æ–°é—®è¯ŠçŠ¶æ€
        async function updateConsultationStatus(status, prescriptionId = null) {
            if (!currentUser || !userToken) return;
            
            try {
                const userId = getCurrentUserId();
                const payload = {
                    patient_id: userId,
                    status: status,
                    prescription_id: prescriptionId,
                    conversation_log: JSON.stringify(getAllMessages()),
                    symptoms_analysis: JSON.stringify(extractConversationSummary()),
                    updated_at: new Date().toISOString()
                };
                
                console.log('æ›´æ–°é—®è¯ŠçŠ¶æ€:', payload);
                
                const response = await fetch('/api/consultation/update-status', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('é—®è¯ŠçŠ¶æ€æ›´æ–°æˆåŠŸ:', result);
                } else {
                    console.error('é—®è¯ŠçŠ¶æ€æ›´æ–°å¤±è´¥:', response.status);
                }
                
            } catch (error) {
                console.error('æ›´æ–°é—®è¯ŠçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // ğŸ”‘ è·å–æ‰€æœ‰æ¶ˆæ¯ç”¨äºä¿å­˜å®Œæ•´å¯¹è¯å†å²
        function getAllMessages() {
            const messages = [];
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.querySelectorAll('.message').forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    
                    if (textEl) {
                        messages.push({
                            sender: isUser ? 'user' : 'ai',
                            content: textEl.textContent.trim(),
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: Date.now()
                        });
                    }
                });
            }
            return messages;
        }

        // é¡µé¢å¸è½½æ—¶åœæ­¢åŒæ­¥
        window.addEventListener('beforeunload', function() {
            stopSessionSync();
            // æœ€åä¸€æ¬¡åŒæ­¥
            if (currentUser && userToken) {
                syncSessionToServer();
            }
        });

        // æ·»åŠ CSSåŠ¨ç”»
        const syncAnimationCSS = `
            @keyframes syncNotification {
                0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                10% { opacity: 1; transform: translateX(-50%) translateY(0); }
                90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            }
        `;
        
        // æ·»åŠ æ ·å¼åˆ°é¡µé¢
        const styleSheet = document.createElement('style');
        styleSheet.textContent = syncAnimationCSS;
        document.head.appendChild(styleSheet);

        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨
        function createSyncIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'syncIndicator';
            indicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #10b981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
                z-index: 10004;
                animation: pulse 2s infinite;
                display: none;
            `;
            
            // æ·»åŠ è„‰å†²åŠ¨ç”»
            const pulseCSS = `
                @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                    70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
                }
            `;
            
            if (!document.getElementById('pulseStyle')) {
                const pulseStyle = document.createElement('style');
                pulseStyle.id = 'pulseStyle';
                pulseStyle.textContent = pulseCSS;
                document.head.appendChild(pulseStyle);
            }
            
            document.body.appendChild(indicator);
            
            // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæç¤º
            indicator.title = 'å¤šè®¾å¤‡åŒæ­¥å·²å¯ç”¨';
            
            return indicator;
        }

        // æ˜¾ç¤º/éšè—åŒæ­¥æŒ‡ç¤ºå™¨
        function showSyncIndicator() {
            let indicator = document.getElementById('syncIndicator');
            if (!indicator) {
                indicator = createSyncIndicator();
            }
            indicator.style.display = 'block';
        }

        function hideSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // åœ¨ç”¨æˆ·ç™»å½•æ—¶æ˜¾ç¤ºåŒæ­¥æŒ‡ç¤ºå™¨
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (currentUser && userToken) {
                    showSyncIndicator();
                }
            }, 1000);
        });

        // ===================== å¤šè®¾å¤‡ä¼šè¯åŒæ­¥ç³»ç»Ÿç»“æŸ =====================

        // ğŸ” è°ƒè¯•ç”¨æˆ·IDå’Œå†å²è®°å½•
        function debugUserIdAndHistory() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const currentUserId = getCurrentUserId();
            
            console.log('=== ç”¨æˆ·IDè°ƒè¯•ä¿¡æ¯ ===');
            console.log('currentUserå¯¹è±¡:', currentUser);
            console.log('currentUser.id:', currentUser.id);
            console.log('currentUser.user_id:', currentUser.user_id);
            console.log('userDataå¯¹è±¡:', userData);
            console.log('userData.id:', userData.id);
            console.log('userData.user_id:', userData.user_id);
            console.log('getCurrentUserId()è¿”å›å€¼:', currentUserId);
            
            const keys = Object.keys(localStorage);
            const allHistoryKeys = keys.filter(key => key.startsWith('tcm_doctor_history_'));
            const userHistoryKeys = keys.filter(key => key.startsWith(`tcm_doctor_history_${currentUserId}_`));
            
            console.log('=== å†å²è®°å½•è°ƒè¯•ä¿¡æ¯ ===');
            console.log('æ‰€æœ‰å†å²è®°å½•é”®å:', allHistoryKeys);
            console.log('å½“å‰ç”¨æˆ·å†å²è®°å½•é”®å:', userHistoryKeys);
            console.log('å†å²è®°å½•æ€»æ•°:', allHistoryKeys.length);
            console.log('å½“å‰ç”¨æˆ·å†å²è®°å½•æ•°:', userHistoryKeys.length);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰maoxiaohuaç›¸å…³çš„è®°å½•
            const maoxiaohuaKeys = keys.filter(key => key.includes('maoxiaohua') || key.includes('02f16099'));
            console.log('maoxiaohuaç›¸å…³é”®å:', maoxiaohuaKeys);
        }

        // å†å²è®°å½•ç®¡ç†ç³»ç»Ÿ
        function saveCurrentDoctorHistory() {
            if (!selectedDoctor) return;
            
            try {
                const messages = [];
                
                // æ£€æµ‹å½“å‰æ˜¯ç§»åŠ¨ç«¯è¿˜æ˜¯PCç«¯
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                
                if (!messagesContainer) {
                    console.warn('æœªæ‰¾åˆ°æ¶ˆæ¯å®¹å™¨ï¼Œè·³è¿‡ä¿å­˜');
                    return;
                }
                
                // æå–æ‰€æœ‰æ¶ˆæ¯
                messagesContainer.querySelectorAll('.message').forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    
                    if (textEl && textEl.innerHTML.trim()) {
                        const messageData = {
                            type: isUser ? 'user' : 'ai',
                            content: textEl.innerHTML,
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: Date.now()
                        };
                        
                        // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”åŒ…å«å¤„æ–¹ï¼Œä¿å­˜å¤„æ–¹çŠ¶æ€
                        if (!isUser) {
                            const prescriptionId = messageEl.getAttribute('data-prescription-id');
                            const isPaid = messageEl.querySelector('.prescription-paid') !== null;
                            const hasActions = messageEl.querySelector('.prescription-actions') !== null;
                            
                            if (prescriptionId || isPaid || hasActions) {
                                messageData.prescriptionData = {
                                    prescriptionId: prescriptionId,
                                    isPaid: isPaid,
                                    hasActions: hasActions
                                };
                                
                                // ğŸ”§ å…³é”®ä¿®å¤ï¼šå¦‚æœå¤„æ–¹å·²æ”¯ä»˜ï¼Œå°è¯•è·å–å¹¶ä¿å­˜åŸå§‹å®Œæ•´å†…å®¹
                                if (isPaid) {
                                    const originalContent = messageEl.getAttribute('data-original-content');
                                    if (originalContent) {
                                        messageData.originalContent = originalContent;
                                        console.log('ğŸ’¾ ä¿å­˜äº†å·²æ”¯ä»˜å¤„æ–¹çš„åŸå§‹å†…å®¹');
                                    }
                                }
                            }
                        }
                        
                        messages.push(messageData);
                    }
                });
                
                // å¦‚æœæ²¡æœ‰æ¶ˆæ¯åˆ™ä¸ä¿å­˜
                if (messages.length === 0) {
                    console.log('æ²¡æœ‰æ¶ˆæ¯éœ€è¦ä¿å­˜');
                    return;
                }
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆé˜²æ­¢localStorageæº¢å‡ºï¼‰
                const maxMessages = 50; // æœ€å¤šä¿å­˜50æ¡æ¶ˆæ¯
                const trimmedMessages = messages.slice(-maxMessages);
                
                // ä¿å­˜åˆ°localStorage
                const userId = getCurrentUserId();
                const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                const dataToSave = JSON.stringify({
                    messages: trimmedMessages,
                    lastUpdated: new Date().toISOString(),
                    doctor: selectedDoctor,
                    version: '2.1', // å¢å¼ºç‰ˆæœ¬å·
                    saveCount: (JSON.parse(localStorage.getItem(historyKey) || '{}').saveCount || 0) + 1
                });
                
                // éªŒè¯localStorageå¯ç”¨æ€§
                if (typeof(Storage) === "undefined") {
                    console.error('æµè§ˆå™¨ä¸æ”¯æŒlocalStorage');
                    return;
                }
                
                localStorage.setItem(historyKey, dataToSave);
                console.log(`âœ… å·²ä¿å­˜${selectedDoctor}åŒ»ç”Ÿçš„${trimmedMessages.length}æ¡å¯¹è¯è®°å½• (ç¬¬${JSON.parse(dataToSave).saveCount}æ¬¡ä¿å­˜)`);
                
                // ç«‹å³éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
                const savedData = localStorage.getItem(historyKey);
                if (!savedData) {
                    console.error('âŒ ä¿å­˜éªŒè¯å¤±è´¥ï¼Œæ•°æ®æœªæ­£ç¡®å­˜å‚¨');
                    // å°è¯•é‡æ–°ä¿å­˜
                    setTimeout(() => {
                        localStorage.setItem(historyKey, dataToSave);
                        console.log('ğŸ”„ é‡è¯•ä¿å­˜å®Œæˆ');
                    }, 100);
                } else {
                    console.log('âœ… ä¿å­˜éªŒè¯æˆåŠŸ');
                }
                
                // æ£€æŸ¥localStorageä½¿ç”¨æƒ…å†µ
                checkLocalStorageUsage();
                
                // ğŸš€ æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨æ•°æ®åº“
                saveConversationToServer(trimmedMessages, selectedDoctor);
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
                // å¦‚æœæ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æ—§è®°å½•
                if (error.name === 'QuotaExceededError') {
                    cleanOldHistoryRecords();
                    // é‡è¯•ä¿å­˜ï¼ˆåªä¿å­˜æœ€è¿‘çš„æ¶ˆæ¯ï¼‰
                    try {
                        const recentMessages = messages.slice(-20);
                        const userId = getCurrentUserId();
                        const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                        localStorage.setItem(historyKey, JSON.stringify({
                            messages: recentMessages,
                            lastUpdated: new Date().toISOString(),
                            doctor: selectedDoctor,
                            version: '2.0'
                        }));
                        console.log(`ç©ºé—´ä¸è¶³ï¼Œå·²ä¿å­˜æœ€è¿‘${recentMessages.length}æ¡è®°å½•`);
                    } catch (retryError) {
                        console.error('é‡è¯•ä¿å­˜ä¹Ÿå¤±è´¥:', retryError);
                    }
                }
            }
        }
        
        // ğŸ†• ä»æœåŠ¡å™¨åŠ è½½ç‰¹å®šåŒ»ç”Ÿçš„å†å²è®°å½•
        async function loadDoctorHistoryFromServer(doctorKey, userId) {
            try {
                console.log(`ğŸŒ ä»æœåŠ¡å™¨åŠ è½½${doctorKey}åŒ»ç”Ÿçš„å†å²è®°å½•...`);
                
                // ğŸ”‘ ä¿®å¤ï¼šæ·»åŠ è¶…æ—¶æ§åˆ¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶
                
                const response = await fetch(`/api/conversation/history/${userId}?doctor_id=${doctorKey}`, {
                    headers: getAuthHeaders(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.warn(`âŒ æœåŠ¡å™¨è¯·æ±‚å¤±è´¥: ${response.status}`);
                    return false;
                }
                
                const result = await response.json();
                console.log('ğŸ“‹ åŒ»ç”Ÿå†å²è®°å½•å“åº”:', result);
                
                if (result.success && result.data && result.data.messages) {
                    const messages = result.data.messages;
                    
                    if (messages.length > 0) {
                        console.log(`ğŸ“¥ æ¢å¤${doctorKey}åŒ»ç”Ÿçš„ ${messages.length} æ¡æ¶ˆæ¯`);
                        
                        // æ¸…ç©ºå½“å‰æ¶ˆæ¯
                        clearAllMessages();
                        
                        // é€æ¡æ¢å¤æ¶ˆæ¯
                        await processServerMessages(messages);
                        
                        showSyncNotification(`âœ… å·²ä»äº‘ç«¯æ¢å¤ä¸${doctorKey}åŒ»ç”Ÿçš„å¯¹è¯`, 'server_restored');
                        return true;
                    } else {
                        // ğŸ”‘ ä¿®å¤ï¼šæœåŠ¡å™¨è¿”å›ç©ºæ•°æ®æ—¶çš„å¤„ç†
                        console.log(`ğŸ“­ ${doctorKey}åŒ»ç”Ÿæš‚æ— å†å²å¯¹è¯è®°å½•`);
                        return true; // è¿”å›trueè¡¨ç¤ºæœåŠ¡å™¨å“åº”æ­£å¸¸ï¼Œåªæ˜¯æ²¡æœ‰æ•°æ®
                    }
                }
                
                return false;
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn(`â° åŠ è½½${doctorKey}åŒ»ç”Ÿå†å²è¶…æ—¶ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼`);
                } else {
                    console.error(`âŒ ä»æœåŠ¡å™¨åŠ è½½${doctorKey}åŒ»ç”Ÿå†å²å¤±è´¥:`, error);
                }
                return false;
            }
        }

        async function loadDoctorHistory(doctorKey) {
            const userId = getCurrentUserId();
            
            // ğŸ”‘ ä¿®å¤ï¼šå¯¹äºä¸´æ—¶ç”¨æˆ·æˆ–è®¾å¤‡ç”¨æˆ·ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ¨¡å¼
            if (userId.startsWith('temp_user_') || userId.startsWith('device_')) {
                console.log(`ğŸ“± ä¸´æ—¶ç”¨æˆ·(${userId})ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ¨¡å¼åŠ è½½${doctorKey}åŒ»ç”Ÿå†å²`);
            } else {
                // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆä»æœåŠ¡å™¨åŠ è½½ç‰¹å®šåŒ»ç”Ÿçš„å†å²
                const serverLoaded = await loadDoctorHistoryFromServer(doctorKey, userId);
                
                if (serverLoaded) {
                    console.log(`âœ… ä»æœåŠ¡å™¨æˆåŠŸåŠ è½½${doctorKey}åŒ»ç”Ÿçš„å†å²è®°å½•`);
                    return;
                }
                
                console.log(`âš ï¸ æœåŠ¡å™¨åŠ è½½å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°æ¨¡å¼åŠ è½½${doctorKey}åŒ»ç”Ÿå†å²`);
            }
            
            // æ£€æµ‹å½“å‰æ˜¯ç§»åŠ¨ç«¯è¿˜æ˜¯PCç«¯
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            if (!messagesContainer) return;
            
            // ğŸ”‘ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç©ºæ¶ˆæ¯å®¹å™¨ï¼ŒåŠ å¼ºæ–°å¯¹è¯æ£€æµ‹
            const currentMessages = messagesContainer.querySelectorAll('.message');
            const currentDoctorAttr = messagesContainer.getAttribute('data-current-doctor');
            const isNewConversation = !currentConversationId || currentConversationId.length === 0;
            
            const shouldClearMessages = currentMessages.length === 0 || 
                                       !currentDoctorAttr ||
                                       currentDoctorAttr !== doctorKey ||
                                       isNewConversation; // æ–°å¢ï¼šå¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œå¼ºåˆ¶æ¸…ç©º
            
            if (shouldClearMessages) {
                // æ¸…ç©ºå½“å‰æ¶ˆæ¯ï¼ˆåˆ‡æ¢åŒ»ç”Ÿã€æ²¡æœ‰æ¶ˆæ¯ã€æˆ–æ–°å¯¹è¯æ—¶ï¼‰
                messagesContainer.innerHTML = '';
                console.log(`ğŸ§¹ æ¸…ç©ºæ¶ˆæ¯å®¹å™¨ï¼Œå‡†å¤‡åŠ è½½${doctorKey}åŒ»ç”Ÿçš„å†å²è®°å½•ï¼ˆisNewConversation: ${isNewConversation}ï¼‰`);
            } else {
                console.log(`âš¡ ä¿æŒå½“å‰${doctorKey}åŒ»ç”Ÿçš„æ¶ˆæ¯ï¼Œè·³è¿‡é‡æ–°åŠ è½½`);
                // å¦‚æœæ˜¯åŒä¸€ä¸ªåŒ»ç”Ÿä¸”æœ‰æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›ï¼Œä¸é‡æ–°åŠ è½½
                messagesContainer.setAttribute('data-current-doctor', doctorKey);
                return;
            }
            
            // æ ‡è®°å½“å‰åŒ»ç”Ÿ
            messagesContainer.setAttribute('data-current-doctor', doctorKey);
            
            // ç§»åŠ¨ç«¯éœ€è¦é‡ç½®æ ·å¼
            if (isMobile) {
                messagesContainer.style.display = 'block';
                messagesContainer.style.alignItems = 'flex-start';
                messagesContainer.style.justifyContent = 'flex-start';
            }

            // ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ™ºèƒ½åŠ è½½ç­–ç•¥ - ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼Œé¿å…äº‘ç«¯ç©ºæ•°æ®è¦†ç›–
            let messages = [];
            let loadedFromServer = false;
            let loadedFromLocal = false;
            
            // 1. é¦–å…ˆæ£€æŸ¥localStorageæ˜¯å¦æœ‰æ•°æ®
            const historyKey = `tcm_doctor_history_${userId}_${doctorKey}`;
            const storedHistory = localStorage.getItem(historyKey);
            
            if (storedHistory) {
                try {
                    const historyData = JSON.parse(storedHistory);
                    if (historyData.messages && historyData.messages.length > 0) {
                        messages = historyData.messages;
                        loadedFromLocal = true;
                        console.log(`ğŸ“± ä»localStorageåŠ è½½${doctorKey}åŒ»ç”Ÿçš„${messages.length}æ¡å¯¹è¯å†å²`);
                        console.log(`ğŸ” è°ƒè¯•: æœ¬åœ°æ¶ˆæ¯=`, messages);
                        
                        // ğŸ”‘ ä¿®å¤ï¼šæ›´å‹å¥½çš„æœ¬åœ°æ¢å¤æç¤º
                        const doctorName = getDoctorDisplayName(doctorKey) || doctorKey;
                        showSyncNotification(`ğŸ“± å·²ä»æœ¬åœ°æ¢å¤ä¸${doctorName}çš„å¯¹è¯è®°å½•`, 'local_fallback');
                    }
                } catch (error) {
                    console.warn('è§£ææœ¬åœ°å†å²è®°å½•å¤±è´¥:', error);
                }
            }
            
            // 2. å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œå†å°è¯•ä»æœåŠ¡å™¨åŠ è½½
            if (!loadedFromLocal && !userId.startsWith('temp_user_') && !userId.startsWith('device_')) {
                try {
                    console.log(`ğŸŒ æœ¬åœ°æ— æ•°æ®ï¼Œä»æœåŠ¡å™¨åŠ è½½${doctorKey}åŒ»ç”Ÿçš„å¯¹è¯å†å²...`);
                    console.log(`ğŸ” è°ƒè¯•: ç”¨æˆ·ID=${userId}, åŒ»ç”ŸID=${doctorKey}`);
                    const apiUrl = `/api/conversation/history/${userId}?doctor_id=${doctorKey}`;
                    console.log(`ğŸ” è°ƒè¯•: API URL=${apiUrl}`);
                    
                    const response = await fetch(apiUrl);
                    console.log(`ğŸ” è°ƒè¯•: å“åº”çŠ¶æ€=${response.status}, OK=${response.ok}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`ğŸ” è°ƒè¯•: APIå“åº”=`, result);
                        
                        if (result.success && result.data && result.data.messages && result.data.messages.length > 0) {
                            messages = result.data.messages;
                            loadedFromServer = true;
                            console.log(`âœ… ä»æœåŠ¡å™¨åŠ è½½${doctorKey}åŒ»ç”Ÿçš„${messages.length}æ¡å¯¹è¯å†å²`);
                            console.log(`ğŸ” è°ƒè¯•: åŠ è½½çš„æ¶ˆæ¯=`, messages);
                            showSyncNotification('âœ… å·²ä»äº‘ç«¯åŒæ­¥å¯¹è¯å†å²', 'server_restored');
                        } else {
                            console.warn(`âš ï¸ æœåŠ¡å™¨è¿”å›ç©ºæ•°æ®æˆ–æ ¼å¼ä¸æ­£ç¡®:`, result);
                        }
                    } else {
                        console.error(`âŒ APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
                        const errorText = await response.text();
                        console.error(`âŒ é”™è¯¯è¯¦æƒ…: ${errorText}`);
                    }
                } catch (error) {
                    console.warn('æœåŠ¡å™¨åŠ è½½å¯¹è¯å†å²å¤±è´¥:', error);
                }
            } else if (loadedFromLocal) {
                console.log(`ğŸ“± å·²ä»æœ¬åœ°åŠ è½½æ•°æ®ï¼Œè·³è¿‡æœåŠ¡å™¨æŸ¥è¯¢`);
            } else {
                console.log(`âš ï¸ è·³è¿‡æœåŠ¡å™¨åŠ è½½ï¼Œä¸´æ—¶ç”¨æˆ·ID: ${userId}`);
            }
            
            // 3. æœ€ç»ˆæ£€æŸ¥ï¼šå¦‚æœè¿˜æ˜¯æ²¡æœ‰æ•°æ®ï¼Œåˆ™æ— å†å²è®°å½•
            if (!loadedFromLocal && !loadedFromServer) {
                const historyKey = `tcm_doctor_history_${userId}_${doctorKey}`;
                const storedHistory = localStorage.getItem(historyKey);
                
                if (storedHistory) {
                    try {
                        let historyData = JSON.parse(storedHistory);
                        
                        // å…¼å®¹æ—§æ ¼å¼å’Œæ–°æ ¼å¼
                        if (Array.isArray(historyData)) {
                            messages = historyData;
                            console.log(`ğŸ“± ä»æœ¬åœ°åŠ è½½${doctorKey}åŒ»ç”Ÿçš„${messages.length}æ¡å†å²è®°å½•ï¼ˆæ—§æ ¼å¼ï¼‰`);
                        } else if (historyData.messages && Array.isArray(historyData.messages)) {
                            messages = historyData.messages;
                            console.log(`ğŸ“± ä»æœ¬åœ°åŠ è½½${doctorKey}åŒ»ç”Ÿçš„${messages.length}æ¡å†å²è®°å½•ï¼ˆ${historyData.version || '1.0'}ç‰ˆæœ¬ï¼‰`);
                        }
                        
                        if (messages.length > 0) {
                            showSyncNotification('ğŸ“­ æš‚æ— å†å²å¯¹è¯ï¼Œå¼€å§‹æ–°çš„é—®è¯Š', 'info');
                        }
                    } catch (error) {
                        console.error('æœ¬åœ°å†å²è®°å½•è§£æå¤±è´¥:', error);
                    }
                }
            }
            
            // 3. æ¸²æŸ“åŠ è½½çš„å¯¹è¯å†å²
            if (messages.length > 0) {
                // æ¢å¤å†å²æ¶ˆæ¯
                messages.forEach(msg => {
                    // å¯¹äºAIæ¶ˆæ¯ï¼Œæ£€æµ‹æ˜¯å¦åŒ…å«å¤„æ–¹ä»¥å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯„ä»·ç³»ç»Ÿ
                    const shouldShowFeedback = msg.type === 'ai' && containsPrescription(msg.content);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¤„æ–¹æ•°æ®
                    const prescriptionData = msg.prescriptionData;
                    const isPaid = prescriptionData ? prescriptionData.isPaid : false;
                    const prescriptionId = prescriptionData ? prescriptionData.prescriptionId : null;
                    
                    // ğŸ”§ ä¿®å¤ï¼šå¯¹äºå·²æ”¯ä»˜çš„å¤„æ–¹ï¼Œç¡®ä¿æ˜¾ç¤ºå®Œæ•´æ ¼å¼åŒ–å†…å®¹è€Œä¸æ˜¯é¢„è§ˆç‰ˆæœ¬
                    let displayContent = msg.content;
                    if (isPaid && prescriptionData && msg.type === 'ai' && containsPrescription(msg.content)) {
                        console.log('ğŸ”„ æ¢å¤å·²æ”¯ä»˜å¤„æ–¹çš„å®Œæ•´æ ¼å¼ï¼Œå¤„æ–¹ID:', prescriptionId);
                        // æ¸…ç†å¯èƒ½å­˜åœ¨çš„é¢„è§ˆé™åˆ¶æ ‡è®°
                        displayContent = msg.content
                            .replace(/\*\*\*/g, '15')
                            .replace(/è§£é”æŸ¥çœ‹/g, '')
                            .replace(/\+ \d+ å‘³è¯æ/g, '')
                            .replace(/æ–¹å‰‚ç»„æˆé¢„è§ˆ/g, 'å®Œæ•´æ–¹å‰‚ç»„æˆ')
                            .replace(/é¢„è§ˆ/g, 'å®Œæ•´');
                    }
                    
                    if (isMobile) {
                        addMobileMessage(msg.type, displayContent, shouldShowFeedback, isPaid, prescriptionId);
                    } else {
                        addMessageWithTime(msg.type, displayContent, msg.time, shouldShowFeedback, isPaid, prescriptionId);
                    }
                });
                
                // å¦‚æœæœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                console.log(`å†å²è®°å½•è¯¦æƒ…: å…±${messages.length}æ¡æ¶ˆæ¯ï¼Œç¬¬ä¸€æ¡=${messages[0].time || 'æœªçŸ¥æ—¶é—´'}, æœ€åä¸€æ¡=${messages[messages.length-1].time || 'æœªçŸ¥æ—¶é—´'}`);
                
                // ğŸ”„ å¦‚æœä»æœ¬åœ°åŠ è½½æˆåŠŸï¼Œå¼‚æ­¥åŒæ­¥åˆ°æœåŠ¡å™¨
                if (loadedFromLocal && !userId.startsWith('temp_user_') && !userId.startsWith('device_')) {
                    setTimeout(() => {
                        console.log(`ğŸ”„ å°†æœ¬åœ°æ•°æ®åŒæ­¥åˆ°æœåŠ¡å™¨...`);
                        syncLocalHistoryToServer(userId, doctorKey, messages);
                    }, 2000); // å»¶è¿Ÿ2ç§’ï¼Œç¡®ä¿é¡µé¢æ¸²æŸ“å®Œæˆ
                }
            } else {
                // æ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                console.log(`${doctorKey}åŒ»ç”Ÿæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯`);
                addWelcomeMessage(doctorKey);
            }
        }

        // ğŸŒ åŒæ­¥æœ¬åœ°å†å²è®°å½•åˆ°æœåŠ¡å™¨
        async function syncLocalHistoryToServer(userId, doctorKey, messages) {
            try {
                console.log(`ğŸ”„ å°†${doctorKey}åŒ»ç”Ÿçš„${messages.length}æ¡æœ¬åœ°æ¶ˆæ¯åŒæ­¥åˆ°æœåŠ¡å™¨...`);
                
                const response = await fetch('/api/conversation/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        doctor_id: doctorKey,
                        state_data: {
                            messages: messages,
                            sync_type: 'history_upload',
                            currentState: 'active',
                            conversationData: {
                                messageCount: messages.length,
                                lastActivity: new Date().toISOString()
                            }
                        },
                        device_info: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log(`âœ… ${doctorKey}åŒ»ç”Ÿçš„å¯¹è¯å†å²å·²åŒæ­¥åˆ°æœåŠ¡å™¨`);
                    }
                }
            } catch (error) {
                console.warn('åŒæ­¥å†å²è®°å½•åˆ°æœåŠ¡å™¨å¤±è´¥:', error);
            }
        }

        // ğŸ”” æ˜¾ç¤ºåŒæ­¥çŠ¶æ€é€šçŸ¥
        function showSyncNotification(message, type = 'info') {
            const notification = document.createElement('div');
            
            // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
            let bgColor, textColor, borderColor, icon;
            switch(type) {
                case 'server_restored':
                    bgColor = '#e8f5e8';
                    textColor = '#2e7d32';
                    borderColor = '#4caf50';
                    icon = 'â˜ï¸';
                    break;
                case 'local_fallback':
                    bgColor = '#fff3e0';
                    textColor = '#f57c00';
                    borderColor = '#ff9800';
                    icon = 'ğŸ“±';
                    break;
                default:
                    bgColor = '#e3f2fd';
                    textColor = '#1976d2';
                    borderColor = '#2196f3';
                    icon = 'â„¹ï¸';
            }
            
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${bgColor};
                color: ${textColor};
                padding: 12px 16px;
                border-radius: 8px;
                border-left: 4px solid ${borderColor};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1002;
                font-size: 14px;
                max-width: 250px;
                animation: slideInRight 0.3s ease;
            `;
            
            const icons = {
                'server_restored': 'â˜ï¸',
                'local_restored': 'ğŸ“±',
                'sync_success': 'âœ…'
            };
            
            notification.innerHTML = `${icon} ${message}`;
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        function addWelcomeMessage(doctorKey) {
            const doctor = doctors[doctorKey];
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            // ğŸ”§ ä¿®å¤é‡å¤æ¬¢è¿æ¶ˆæ¯é—®é¢˜ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ¶ˆæ¯å­˜åœ¨
            if (messagesContainer && messagesContainer.children.length > 0) {
                console.log(`${doctor.name}åŒ»ç”Ÿçš„æ¬¢è¿æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤æ·»åŠ `);
                return;
            }
            
            const welcomeMessage = `æ‚¨å¥½ï¼æˆ‘æ˜¯${doctor.name}ï¼Œ${doctor.school}ä¼ äººã€‚è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘å°†ä¸ºæ‚¨è¿›è¡Œä¸“ä¸šçš„ä¸­åŒ»åˆ†æã€‚`;
            console.log(`æ·»åŠ ${doctor.name}åŒ»ç”Ÿçš„æ¬¢è¿æ¶ˆæ¯`);
            
            // ğŸ”‘ ä¿®å¤ï¼šä½¿ç”¨åŸå§‹å‡½æ•°è€Œä¸æ˜¯å¢å¼ºç‰ˆæœ¬ï¼Œé¿å…è§¦å‘æ•°æ®ä¿å­˜
            if (isMobile) {
                originalAddMobileMessage('ai', welcomeMessage);
            } else {
                originalAddMessage('ai', welcomeMessage);
            }
        }
        
        function addMessageWithTime(sender, content, timeStr, showFeedback = false, isPaid = false, prescriptionId = null) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // æ£€æµ‹æ˜¯å¦åŒ…å«å¤„æ–¹
            const containsPrescriptionContent = containsPrescription(content);
            
            // å¦‚æœæœ‰å¤„æ–¹IDï¼Œä¿å­˜åˆ°å…ƒç´ å±æ€§ä¸­
            if (prescriptionId) {
                messageDiv.setAttribute('data-prescription-id', prescriptionId);
            }
            
            // ğŸ”§ ä¿®å¤é‡å¤æ”¯ä»˜æŒ‰é’®ï¼šä¸»é¡µé¢é€»è¾‘åªå¤„ç†å·²æ”¯ä»˜çŠ¶æ€ï¼Œæœªæ”¯ä»˜çŠ¶æ€ç”±prescription_rendererå¤„ç†
            let prescriptionActionsHtml = '';
            if (sender === 'ai' && containsPrescriptionContent && isPaid) {
                // åªåœ¨å·²æ”¯ä»˜æ—¶æ˜¾ç¤ºä»£ç…æœåŠ¡æŒ‰é’®
                prescriptionActionsHtml = `
                    <div class="prescription-paid" style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="font-size: 13px; color: #059669; margin-bottom: 8px;">
                            <strong>âœ… å¤„æ–¹å·²è§£é”</strong> - æ”¯ä»˜æˆåŠŸï¼Œæ‚¨å¯ä»¥è”ç³»ä»£ç…æœåŠ¡
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="showDecorationInfo('${prescriptionId}')" 
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                ğŸµ è”ç³»ä»£ç…æœåŠ¡
                            </button>
                        </div>
                    </div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'ğŸ‘¤' : (selectedDoctor ? doctors[selectedDoctor].avatar : 'ğŸ¤–')}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    <div class="message-time">${timeStr}</div>
                    ${prescriptionActionsHtml}
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">è¿™ä¸ªå›ç­”æœ‰å¸®åŠ©å—ï¼Ÿ</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">ğŸ˜Š å¾ˆå¥½</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">ğŸ‘ ä¸é”™</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">ğŸ‘Œ è¿˜è¡Œ</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">ğŸ‘ ä¸å¥½</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">ğŸ˜ å¾ˆå·®</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // åŠ è½½å¯¹è¯å†å² - åŸºäºç”¨æˆ·IDéš”ç¦»å¹¶æ”¯æŒåŒ»ç–—è®°å½•ç®¡ç†
        // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆä»æœåŠ¡å™¨æ¢å¤æ•°æ®ï¼Œç¡®ä¿å¤šç«¯ä¸€è‡´æ€§
        async function loadConversationHistory() {
            const userId = getCurrentUserId();
            
            console.log('ğŸ”„ å¼€å§‹åŠ è½½å¯¹è¯å†å²ï¼Œç”¨æˆ·ID:', userId);
            
            // 1. ä¼˜å…ˆå°è¯•ä»æœåŠ¡å™¨æ¢å¤æ•°æ®
            const serverRestored = await loadConversationFromServer(userId);
            
            if (!serverRestored) {
                console.log('âš ï¸ æœåŠ¡å™¨æ¢å¤å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°æ¨¡å¼');
                
                // 2. é™çº§ï¼šä»localStorageæ¢å¤å¯¹è¯ID
                const storageKey = `conversationId_${userId}`;
                const storedId = localStorage.getItem(storageKey);
                if (storedId) {
                    currentConversationId = storedId;
                    console.log(`ğŸ“± ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¯¹è¯ID: ${currentConversationId}`);
                } else {
                    generateConversationId();
                    console.log(`ğŸ†• ç”Ÿæˆæ–°å¯¹è¯ID: ${currentConversationId}`);
                }
                
                // 3. åŠ è½½æœ¬åœ°å†å²è®°å½•
                loadAndDisplayAllConversations();
                
                // 4. æ˜¾ç¤ºé™çº§æç¤º
                showSyncNotification('âš ï¸ å·²ä»æœ¬åœ°ç¼“å­˜æ¢å¤ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥', 'local_fallback');
            }
            
            // 5. å¦‚æœæœ‰é€‰ä¸­çš„åŒ»ç”Ÿï¼ŒåŠ è½½è¯¥åŒ»ç”Ÿçš„å†å²è®°å½•
            if (selectedDoctor) {
                await loadDoctorHistoryFromServer(selectedDoctor, userId);
            }
        }
        
        // ğŸ†• ä»æœåŠ¡å™¨åŠ è½½å¯¹è¯å†å²
        async function loadConversationFromServer(userId) {
            try {
                console.log('ğŸŒ å°è¯•ä»æœåŠ¡å™¨æ¢å¤å¯¹è¯å†å²...');
                
                const response = await fetch(`/api/conversation/history/${userId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    console.warn(`âŒ æœåŠ¡å™¨è¯·æ±‚å¤±è´¥: ${response.status}`);
                    return false;
                }
                
                const result = await response.json();
                console.log('ğŸ“‹ æœåŠ¡å™¨å“åº”:', result);
                
                if (result.success && result.data) {
                    const { messages, conversation_states, consultation_records } = result.data;
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showSyncNotification(`âœ… å·²ä»äº‘ç«¯æ¢å¤ ${messages?.length || 0} æ¡å¯¹è¯è®°å½•`, 'server_restored');
                    
                    // å¤„ç†å¯¹è¯çŠ¶æ€
                    if (conversation_states && conversation_states.length > 0) {
                        const latestState = conversation_states[0];
                        currentConversationId = latestState.conversation_id;
                        console.log('ğŸ”„ æ¢å¤å¯¹è¯ID:', currentConversationId);
                    }
                    
                    // å¤„ç†æ¶ˆæ¯å†å² - åŠ è½½æ‰€æœ‰åŒ»ç”Ÿçš„æ¶ˆæ¯
                    if (messages && messages.length > 0) {
                        console.log(`ğŸ“¥ æ¢å¤ ${messages.length} æ¡æ¶ˆæ¯`);
                        await processServerMessages(messages);
                    }
                    
                    // å¤„ç†é—®è¯Šè®°å½•
                    if (consultation_records && consultation_records.length > 0) {
                        console.log(`ğŸ“‹ æ¢å¤ ${consultation_records.length} æ¡é—®è¯Šè®°å½•`);
                        await processConsultationRecords(consultation_records);
                    }
                    
                    return true;
                } else {
                    console.warn('âŒ æœåŠ¡å™¨è¿”å›ç©ºæ•°æ®');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ ä»æœåŠ¡å™¨æ¢å¤å¤±è´¥:', error);
                return false;
            }
        }
        
        // ğŸ†• å¤„ç†æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯
        async function processServerMessages(messages) {
            try {
                // æŒ‰æ—¶é—´æ’åºæ¶ˆæ¯
                messages.sort((a, b) => new Date(a.timestamp || a.time) - new Date(b.timestamp || b.time));
                
                // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯
                clearAllMessages();
                
                // é€æ¡æ¢å¤æ¶ˆæ¯
                for (const message of messages) {
                    const messageType = message.type; // 'user' æˆ– 'ai'
                    const content = message.content;
                    const prescriptionData = message.prescriptionData || null;
                    
                    // ç¡®å®šæ˜¯å¦åŒ…å«å¤„æ–¹ä¸”å·²æ”¯ä»˜
                    const isPaid = prescriptionData ? prescriptionData.isPaid : false;
                    const prescriptionId = prescriptionData ? prescriptionData.prescriptionId : null;
                    
                    if (messageType === 'user') {
                        // æ¢å¤ç”¨æˆ·æ¶ˆæ¯
                        await addMessage('user', content);
                    } else if (messageType === 'ai') {
                        // æ¢å¤AIæ¶ˆæ¯ï¼ŒåŒ…å«å¤„æ–¹çŠ¶æ€
                        await addMessage('ai', content, false, isPaid, prescriptionId);
                        
                        // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå¦‚æœæ˜¯å·²æ”¯ä»˜ä½†ç­‰å¾…å®¡æ ¸çš„å¤„æ–¹ï¼Œæ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                        if (isPaid && prescriptionId) {
                            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„å¤„æ–¹çŠ¶æ€
                            const localStatus = getPrescriptionStatusFromStorage(prescriptionId);
                            if (localStatus === 'pending_review') {
                                setTimeout(() => {
                                    updatePrescriptionToReviewStatus(prescriptionId);
                                    console.log('ğŸ”„ å·²æ¢å¤å¤„æ–¹ç­‰å¾…å®¡æ ¸çŠ¶æ€:', prescriptionId);
                                }, 100);
                            }
                        }
                    }
                    
                    // æ·»åŠ å°å»¶è¿Ÿä»¥ç¡®ä¿æ¶ˆæ¯æŒ‰é¡ºåºæ˜¾ç¤º
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                console.log('âœ… æ¶ˆæ¯æ¢å¤å®Œæˆ');
                
                // ğŸ”‘ ç§»é™¤é¢å¤–çš„æ¢å¤è°ƒç”¨ï¼Œé¿å…ä¸ç»Ÿä¸€æ¢å¤æœºåˆ¶å†²çª
                // setTimeout(() => {
                //     restoreAllPendingPrescriptions();
                // }, 200);
                
            } catch (error) {
                console.error('âŒ å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // ğŸ†• å¤„ç†é—®è¯Šè®°å½•
        async function processConsultationRecords(records) {
            try {
                // è¿™é‡Œå¯ä»¥æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
                console.log('ğŸ“‹ å¤„ç†é—®è¯Šè®°å½•:', records.length);
                
                // å¦‚æœæœ‰å†å²è®°å½•å®¹å™¨ï¼Œæ›´æ–°æ˜¾ç¤º
                const historyContainer = document.querySelector('.conversation-list');
                if (historyContainer && records.length > 0) {
                    // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°å†å²è®°å½•æ˜¾ç¤º
                    console.log('ğŸ“± æ›´æ–°å†å²è®°å½•æ˜¾ç¤º');
                }
                
            } catch (error) {
                console.error('âŒ å¤„ç†é—®è¯Šè®°å½•å¤±è´¥:', error);
            }
        }
        
        /**
         * åŠ è½½å¹¶æ˜¾ç¤ºæ‰€æœ‰å†å²å¯¹è¯è®°å½•
         */
        function loadAndDisplayAllConversations() {
            const userId = getCurrentUserId();
            const historyContainer = document.querySelector('.conversation-list');
            
            if (!historyContainer) {
                console.log('å†å²è®°å½•å®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½');
                return;
            }
            
            try {
                let allConversations = [];
                
                // éå†æ‰€æœ‰åŒ»ç”Ÿï¼Œæ”¶é›†å†å²è®°å½•
                Object.keys(doctors).forEach(doctorKey => {
                    const historyKey = `tcm_doctor_history_${userId}_${doctorKey}`;
                    const doctorHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
                    
                    doctorHistory.forEach(session => {
                        allConversations.push({
                            ...session,
                            doctorKey: doctorKey,
                            doctorInfo: doctors[doctorKey]
                        });
                    });
                });
                
                // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                allConversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // ç”ŸæˆHTML
                if (allConversations.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— é—®è¯Šå†å²</div>';
                    return;
                }
                
                let historyHTML = '';
                allConversations.forEach(session => {
                    const sessionId = session.id || session.conversationId;
                    const isEvaluated = isSessionEvaluated(sessionId);
                    const shortId = sessionId ? sessionId.slice(-6) : 'æœªçŸ¥';
                    const timeStr = new Date(session.timestamp).toLocaleString('zh-CN');
                    
                    // è·å–å¯¹è¯æ¦‚è¦
                    let summary = 'é—®è¯Šè®°å½•';
                    if (session.conversation && session.conversation.length > 0) {
                        const firstUserMsg = session.conversation.find(msg => msg.type === 'user');
                        if (firstUserMsg && firstUserMsg.content) {
                            summary = firstUserMsg.content.substring(0, 30) + (firstUserMsg.content.length > 30 ? '...' : '');
                        }
                    }
                    
                    historyHTML += `
                        <div class="conversation-item" data-session-id="${sessionId}" onclick="showConversationDetails('${sessionId}', '${session.doctorKey}')" style="cursor: pointer;">
                            <div class="conversation-header">
                                <div class="doctor-info">
                                    <span class="doctor-avatar">${session.doctorInfo.avatar}</span>
                                    <div class="doctor-details">
                                        <div class="doctor-name">${session.doctorInfo.name}</div>
                                        <div class="session-time">${timeStr}</div>
                                    </div>
                                </div>
                                <div class="session-actions">
                                    <button class="session-details" onclick="event.stopPropagation(); showConversationDetails('${sessionId}', '${session.doctorKey}')" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ“‹</button>
                                    <button class="session-export" onclick="event.stopPropagation(); exportSession('${sessionId}')" title="å¯¼å‡ºåŒ»ç–—æŠ¥å‘Š">ğŸ“„</button>
                                    <button class="session-rate ${isEvaluated ? 'evaluated' : ''}" onclick="event.stopPropagation(); showEvaluationModal('${sessionId}')" title="${isEvaluated ? 'å·²è¯„ä»·' : 'è¯„ä»·é—®è¯Š'}">
                                        ${isEvaluated ? 'âœ…' : 'â­'}
                                    </button>
                                    <button class="session-delete" onclick="event.stopPropagation(); deleteSession('${sessionId}')" title="åˆ é™¤è®°å½•">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="conversation-summary">${summary}</div>
                            <div class="session-meta">
                                <span class="session-id">ID: ${shortId}</span>
                                ${session.diagnosis ? '<span class="has-diagnosis">å·²è¯Šæ–­</span>' : ''}
                                ${session.prescription ? '<span class="has-prescription">æœ‰å¤„æ–¹</span>' : ''}
                                <button class="view-details-btn" onclick="event.stopPropagation(); showConversationDetails('${sessionId}', '${session.doctorKey}')" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">æŸ¥çœ‹è¯¦æƒ…</button>
                            </div>
                        </div>
                    `;
                });
                
                historyContainer.innerHTML = historyHTML;
                console.log(`åŠ è½½äº† ${allConversations.length} æ¡å†å²è®°å½•`);
                
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                historyContainer.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">åŠ è½½å†å²è®°å½•å¤±è´¥</div>';
            }
        }
        
        // ğŸ†• æ˜¾ç¤ºé—®è¯Šè¯¦æƒ… - ä»æœåŠ¡å™¨è·å–å®Œæ•´ä¿¡æ¯
        async function showConversationDetails(sessionId, doctorKey) {
            console.log('ğŸ“‹ æ˜¾ç¤ºé—®è¯Šè¯¦æƒ…:', sessionId, doctorKey);
            
            try {
                const userId = getCurrentUserId();
                
                // ä»æœåŠ¡å™¨è·å–è¯¦ç»†çš„é—®è¯Šè®°å½•
                const response = await fetch(`/api/consultation/patient-history/${userId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ğŸ“‹ APIè¿”å›çš„å†å²æ•°æ®:', result);
                
                if (!result.success || !result.data) {
                    throw new Error('è·å–è¯¦æƒ…å¤±è´¥');
                }
                
                // ğŸ”‘ ä¿®å¤ï¼šæ›´å‡†ç¡®çš„ä¼šè¯åŒ¹é…é€»è¾‘
                const targetConsultation = result.data.find(consultation => {
                    // å¤šç§IDåŒ¹é…æ–¹å¼
                    const matchIds = [
                        consultation.consultation_id,
                        consultation.uuid,
                        consultation.session_id,
                        consultation.conversation_id
                    ];
                    
                    console.log('ğŸ” åŒ¹é…æ£€æŸ¥:', {
                        sessionId,
                        consultation_id: consultation.consultation_id,
                        matchIds,
                        doctorMatch: consultation.doctor_id === doctorKey
                    });
                    
                    return matchIds.includes(sessionId) || 
                           (consultation.doctor_id === doctorKey && matchIds.some(id => id && id.includes(sessionId.slice(-6))));
                });
                
                if (!targetConsultation) {
                    console.warn('æœªæ‰¾åˆ°åŒ¹é…çš„é—®è¯Šè®°å½•ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®ä»¥ä¾›è°ƒè¯•');
                    console.log('æ‰€æœ‰é—®è¯Šè®°å½•:', result.data.map(c => ({
                        id: c.consultation_id,
                        doctor: c.doctor_id,
                        created: c.created_at
                    })));
                    
                    // å¦‚æœæ‰¾ä¸åˆ°ç²¾ç¡®åŒ¹é…ï¼Œé€‰æ‹©æœ€æ–°çš„è®°å½•
                    const latestConsultation = result.data[0];
                    if (latestConsultation) {
                        console.log('ğŸ”„ ä½¿ç”¨æœ€æ–°çš„é—®è¯Šè®°å½•:', latestConsultation.consultation_id);
                        showConsultationDetailsModal(latestConsultation);
                        return;
                    }
                    
                    throw new Error('æœªæ‰¾åˆ°å¯¹åº”çš„é—®è¯Šè®°å½•');
                }
                
                console.log('âœ… æ‰¾åˆ°åŒ¹é…çš„é—®è¯Šè®°å½•:', targetConsultation.consultation_id);
                
                // æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
                showConsultationDetailsModal(targetConsultation);
                
            } catch (error) {
                console.error('è·å–é—®è¯Šè¯¦æƒ…å¤±è´¥:', error);
                showMessage('è·å–é—®è¯Šè¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ğŸ†• æ˜¾ç¤ºé—®è¯Šè¯¦æƒ…æ¨¡æ€æ¡†
        function showConsultationDetailsModal(consultation) {
            console.log('ğŸ” è§£æé—®è¯Šè¯¦æƒ…æ•°æ®:', consultation);
            
            // ğŸ”‘ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µåè§£æå¯¹è¯å†å²
            let conversationHistory = [];
            try {
                // ä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„conversation_historyå­—æ®µ
                if (consultation.conversation_history && Array.isArray(consultation.conversation_history)) {
                    conversationHistory = consultation.conversation_history;
                } else if (consultation.conversation_log) {
                    const logData = typeof consultation.conversation_log === 'string' 
                        ? JSON.parse(consultation.conversation_log) 
                        : consultation.conversation_log;
                    conversationHistory = logData.conversation_history || [];
                }
            } catch (e) {
                console.warn('è§£æå¯¹è¯å†å²å¤±è´¥:', e);
            }
            
            console.log('ğŸ“œ å¯¹è¯å†å²æ•°æ®:', conversationHistory);
            
            // ğŸ”‘ ä¿®å¤ï¼šè§£æç—‡çŠ¶åˆ†æï¼Œå¤„ç†å¤šç§æ•°æ®æ ¼å¼
            let symptomsData = {};
            try {
                if (consultation.symptoms_analysis) {
                    symptomsData = typeof consultation.symptoms_analysis === 'string'
                        ? JSON.parse(consultation.symptoms_analysis)
                        : consultation.symptoms_analysis;
                } else if (consultation.prescription_info && consultation.prescription_info.symptoms) {
                    // ä»å¤„æ–¹ä¿¡æ¯ä¸­è·å–ç—‡çŠ¶
                    symptomsData.symptoms = consultation.prescription_info.symptoms;
                }
            } catch (e) {
                console.warn('è§£æç—‡çŠ¶åˆ†æå¤±è´¥:', e);
            }
            
            console.log('ğŸ” ç—‡çŠ¶åˆ†ææ•°æ®:', symptomsData);
            
            // ğŸ”‘ ä¿®å¤ï¼šè§£æä¸­åŒ»è¯å€™ï¼Œå¤„ç†å¤šç§æ•°æ®æ ¼å¼
            let syndromeData = {};
            try {
                if (consultation.tcm_syndrome) {
                    syndromeData = typeof consultation.tcm_syndrome === 'string'
                        ? JSON.parse(consultation.tcm_syndrome)
                        : consultation.tcm_syndrome;
                } else if (consultation.prescription_info && consultation.prescription_info.diagnosis) {
                    // ä»å¤„æ–¹ä¿¡æ¯ä¸­è·å–è¯Šæ–­
                    syndromeData.diagnosis = consultation.prescription_info.diagnosis;
                }
            } catch (e) {
                console.warn('è§£æä¸­åŒ»è¯å€™å¤±è´¥:', e);
            }
            
            console.log('ğŸ¥ ä¸­åŒ»è¯å€™æ•°æ®:', syndromeData);
            
            // ğŸ”‘ ä¿®å¤ï¼šè·å–å®Œæ•´çš„å¤„æ–¹ä¿¡æ¯
            const prescriptionInfo = consultation.prescription_info || {};
            console.log('ğŸ’Š å¤„æ–¹ä¿¡æ¯æ•°æ®:', prescriptionInfo);
            
            // æ„å»ºè¯¦æƒ…HTML
            const detailsHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 16px; padding: 0; max-width: 800px; max-height: 90vh; overflow: hidden; position: relative;" onclick="event.stopPropagation()">
                        <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; position: relative;">
                            <h2 style="margin: 0; font-size: 20px;">ğŸ“‹ é—®è¯Šè¯¦æƒ…</h2>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                            <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
                                é—®è¯Šæ—¶é—´: ${new Date(consultation.created_at).toLocaleString('zh-CN')}<br>
                                åŒ»ç”Ÿ: ${consultation.doctor_display_name || 'ä¸­åŒ»ä¸“å®¶'}<br>
                                çŠ¶æ€: ${consultation.status === 'completed' ? 'å·²å®Œæˆ' : consultation.status === 'pending_review' ? 'ç­‰å¾…å®¡æ ¸' : 'è¿›è¡Œä¸­'}
                            </div>
                        </div>
                        
                        <!-- æ¨¡æ€æ¡†å†…å®¹ -->
                        <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                            <!-- å¯¹è¯è®°å½• -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">ğŸ’¬ å¯¹è¯è®°å½•</h3>
                                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb;">
                                    ${conversationHistory.length > 0 ? 
                                        conversationHistory.map(msg => `
                                            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="color: #667eea; font-weight: 600; margin-bottom: 5px;">æ‚£è€…:</div>
                                                <div style="margin-bottom: 10px; line-height: 1.6;">${msg.patient_query || ''}</div>
                                                <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">åŒ»ç”Ÿ:</div>
                                                <div style="line-height: 1.6; white-space: pre-wrap;">${msg.ai_response || ''}</div>
                                            </div>
                                        `).join('') : 
                                        '<div style="color: #6b7280; text-align: center;">æš‚æ— å¯¹è¯è®°å½•</div>'
                                    }
                                </div>
                            </div>
                            
                            <!-- ç—‡çŠ¶åˆ†æ -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">ğŸ” ç—‡çŠ¶åˆ†æ</h3>
                                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f0f9ff;">
                                    ${symptomsData.symptoms || symptomsData.main_symptoms ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>ä¸»è¦ç—‡çŠ¶:</strong> ${symptomsData.symptoms || symptomsData.main_symptoms || ''}
                                        </div>
                                    ` : ''}
                                    ${symptomsData.additional_symptoms ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>ä¼´éšç—‡çŠ¶:</strong> ${symptomsData.additional_symptoms}
                                        </div>
                                    ` : ''}
                                    ${symptomsData.confidence_score ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>è¯Šæ–­ç½®ä¿¡åº¦:</strong> ${(symptomsData.confidence_score * 100).toFixed(1)}%
                                        </div>
                                    ` : ''}
                                    ${!symptomsData.symptoms && !symptomsData.main_symptoms ? 
                                        '<div style="color: #6b7280;">æš‚æ— ç—‡çŠ¶åˆ†ææ•°æ®</div>' : ''
                                    }
                                </div>
                            </div>
                            
                            <!-- ä¸­åŒ»è¾©è¯ -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">ğŸ¥ ä¸­åŒ»è¾©è¯</h3>
                                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f0fdf4;">
                                    ${syndromeData.syndrome || syndromeData.diagnosis ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>è¯å€™è¯Šæ–­:</strong> ${syndromeData.syndrome || syndromeData.diagnosis || ''}
                                        </div>
                                    ` : ''}
                                    ${syndromeData.pattern || syndromeData.tcm_pattern ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>è¯å‹åˆ†æ:</strong> ${syndromeData.pattern || syndromeData.tcm_pattern}
                                        </div>
                                    ` : ''}
                                    ${syndromeData.treatment_principle ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>æ²»åˆ™æ²»æ³•:</strong> ${syndromeData.treatment_principle}
                                        </div>
                                    ` : ''}
                                    ${!syndromeData.syndrome && !syndromeData.diagnosis ? 
                                        '<div style="color: #6b7280;">æš‚æ— è¾©è¯ä¿¡æ¯</div>' : ''
                                    }
                                </div>
                            </div>
                            
                            <!-- å¤„æ–¹ä¿¡æ¯ -->
                            ${prescriptionInfo.prescription_id ? `
                                <div style="margin-bottom: 25px;">
                                    <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">ğŸ’Š å¤„æ–¹ä¿¡æ¯</h3>
                                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #fefce8;">
                                        <div style="margin-bottom: 10px;">
                                            <strong>å¤„æ–¹ID:</strong> ${prescriptionInfo.prescription_id}
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong>å®¡æ ¸çŠ¶æ€:</strong> 
                                            <span style="color: ${prescriptionInfo.review_status === 'approved' ? '#059669' : prescriptionInfo.review_status === 'pending_review' ? '#d97706' : '#dc2626'};">
                                                ${prescriptionInfo.review_status === 'approved' ? 'å·²å®¡æ ¸é€šè¿‡' : 
                                                  prescriptionInfo.review_status === 'pending_review' ? 'ç­‰å¾…å®¡æ ¸' : 
                                                  prescriptionInfo.review_status || 'æœªçŸ¥'}
                                            </span>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong>æ”¯ä»˜çŠ¶æ€:</strong> 
                                            <span style="color: ${prescriptionInfo.payment_status === 'completed' ? '#059669' : '#d97706'};">
                                                ${prescriptionInfo.payment_status === 'completed' ? 'å·²æ”¯ä»˜' : 'å¾…æ”¯ä»˜'}
                                            </span>
                                        </div>
                                        ${prescriptionInfo.display_text ? `
                                            <div style="margin-top: 15px;">
                                                <strong>å¤„æ–¹å†…å®¹:</strong>
                                                <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 8px; line-height: 1.6; white-space: pre-wrap;">
                                                    ${prescriptionInfo.display_text}
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${prescriptionInfo.diagnosis ? `
                                            <div style="margin-top: 15px;">
                                                <strong>è¯Šæ–­:</strong> ${prescriptionInfo.diagnosis}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
                        <div style="padding: 20px; border-top: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: flex-end; gap: 10px;">
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                            <button onclick="exportSession('${consultation.uuid || consultation.conversation_id}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">å¯¼å‡ºæŠ¥å‘Š</button>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
        }

        // ç§»åŠ¨ç«¯é¡µé¢åˆ‡æ¢
        function showMobileChatPage() {
            if (window.innerWidth <= 768) {
                const container = document.getElementById('mobilePageContainer');
                container.classList.add('show-chat');
                
            }
        }
        
        function showMobileDoctorPage() {
            if (window.innerWidth <= 768) {
                document.getElementById('mobilePageContainer').classList.remove('show-chat');
            }
        }

        // ç§»åŠ¨ç«¯åŒ»ç”Ÿé€‰æ‹©ï¼ˆæ”¯æŒé»˜è®¤åŒ»ç”Ÿå’Œæ¨èåŒ»ç”Ÿï¼‰
        function selectMobileDoctor(doctorKey, doctorData = null) {
            // ä¿å­˜å½“å‰åŒ»ç”Ÿçš„å¯¹è¯å†å²
            if (selectedDoctor && selectedDoctor !== doctorKey) {
                saveCurrentDoctorHistory();
            }
            
            selectedDoctor = doctorKey;
            
            // è·å–åŒ»ç”Ÿä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„doctorDataï¼Œç„¶åæ˜¯é»˜è®¤doctorså¯¹è±¡ï¼‰
            const doctor = doctorData || doctors[doctorKey] || {
                name: 'åŒ»ç”Ÿ',
                school: 'ä¸­åŒ»å¸ˆ', 
                avatar: 'ğŸ‘¨â€âš•ï¸',
                specialty: 'ä¸­åŒ»å†…ç§‘'
            };
            
            // æ›´æ–°ç§»åŠ¨ç«¯åŒ»ç”Ÿä¿¡æ¯
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // ç”Ÿæˆæ–°çš„å¯¹è¯IDï¼Œå¼ºåˆ¶å¼€å§‹æ–°å¯¹è¯
            generateConversationId();
            
            // ç›´æ¥åŠ è½½è¯¥åŒ»ç”Ÿçš„å†å²å¯¹è¯ï¼ˆloadDoctorHistoryä¼šè‡ªåŠ¨æ¸…ç©ºå®¹å™¨ï¼‰
            loadDoctorHistory(doctorKey);
            
            // åˆ‡æ¢åˆ°èŠå¤©é¡µé¢
            showMobileChatPage();
            
            // ç¡®ä¿è¾“å…¥æ¡†å¯è§
            setTimeout(() => ensureMobileInputVisible(), 500);
        }

        // ç§»åŠ¨ç«¯æ¸²æŸ“åŒ»ç”Ÿå¡ç‰‡ - å·²ç®€åŒ–ï¼Œç§»é™¤AIæ¨èåŠŸèƒ½
        function renderMobileDoctorCards() {
            console.log('ğŸ‘¥ æ¸²æŸ“ç§»åŠ¨ç«¯åŒ»ç”Ÿå¡ç‰‡');
            const container = document.getElementById('mobileDoctorsGrid');
            if (!container) {
                console.error('âŒ æœªæ‰¾åˆ°ç§»åŠ¨ç«¯åŒ»ç”Ÿå®¹å™¨ mobileDoctorsGrid');
                return;
            }
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // å¼ºåˆ¶æ˜¾ç¤ºå®¹å™¨
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            
            console.log('ğŸ” åŒ»ç”Ÿå¯¹è±¡:', doctors);
            console.log('ğŸ” å®¹å™¨çŠ¶æ€:', {
                display: getComputedStyle(container).display,
                visibility: getComputedStyle(container).visibility,
                opacity: getComputedStyle(container).opacity
            });
            
            // ç›´æ¥ä½¿ç”¨é»˜è®¤åŒ»ç”Ÿåˆ—è¡¨
            Object.entries(doctors).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'mobile-doctor-card';
                card.onclick = () => selectMobileDoctor(key, doctor);
                
                card.innerHTML = `
                    <div class="mobile-doctor-info">
                        <div class="mobile-doctor-avatar">${doctor.avatar}</div>
                        <div class="mobile-doctor-details">
                            <h3>${doctor.name}</h3>
                            <div class="school">${doctor.school}</div>
                        </div>
                    </div>
                    <div class="mobile-doctor-specialty">
                        <strong>æ“…é•¿ï¼š</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // æ·»åŠ ç§»åŠ¨ç«¯åŒ»ç”Ÿåˆ‡æ¢æŒ‰é’® - AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤
        // function addMobileDoctorToggleButton(container) {
        //     // AIæ¨èåŒ»ç”ŸåŠŸèƒ½å·²ç§»é™¤ï¼Œä¸å†éœ€è¦åˆ‡æ¢æŒ‰é’®
        // }

        // ç§»åŠ¨ç«¯æ·»åŠ æ¶ˆæ¯
        function addMobileMessage(sender, content, showFeedback = false, isPaid = false, prescriptionId = null) {
            const container = document.getElementById('mobileMessagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // ğŸ†• ä½¿ç”¨å¤„æ–¹æ¸²æŸ“å™¨å¤„ç†å†…å®¹ï¼ˆç§»åŠ¨ç«¯ï¼‰
            let processedContent = content;
            if (sender === 'ai') {
                if (window.prescriptionContentRenderer) {
                    // ä½¿ç”¨æ–°çš„æ¨¡å—åŒ–å¤„æ–¹æ¸²æŸ“å™¨ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    processedContent = window.prescriptionContentRenderer.renderContent(content, prescriptionId);
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°å¤„ç†æ™®é€šå†…å®¹
                    processedContent = formatMessage(content);
                }
            }
            
            // å¦‚æœæœ‰å¤„æ–¹IDï¼Œä¿å­˜åˆ°å…ƒç´ å±æ€§ä¸­
            if (prescriptionId) {
                messageDiv.setAttribute('data-prescription-id', prescriptionId);
            }

            const messageContent = `
                <div class="message-avatar">
                    ${sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¥'}
                </div>
                <div class="message-content">
                    <div class="message-text">${processedContent}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">è¿™ä¸ªå›ç­”æœ‰å¸®åŠ©å—ï¼Ÿ</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">ğŸ˜Š å¾ˆå¥½</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">ğŸ‘ ä¸é”™</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">ğŸ‘Œ è¿˜è¡Œ</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">ğŸ‘ ä¸å¥½</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">ğŸ˜ å¾ˆå·®</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            container.appendChild(messageDiv);
            
            // ğŸ”§ ä¸ºç§»åŠ¨ç«¯ä¿å­˜åŸå§‹å†…å®¹ç”¨äºæ”¯ä»˜åè§£é”
            if (sender === 'ai' && prescriptionId && content && window.prescriptionContentRenderer) {
                const messageTextEl = messageDiv.querySelector('.message-text');
                if (messageTextEl && !messageTextEl.getAttribute('data-original-content')) {
                    messageTextEl.setAttribute('data-original-content', content);
                    console.log('âœ… ç§»åŠ¨ç«¯å·²ä¿å­˜åŸå§‹å†…å®¹ç”¨äºæ”¯ä»˜åè§£é”');
                }
            }
            
            // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // è‡ªåŠ¨ä¿å­˜ç§»åŠ¨ç«¯å¯¹è¯å†å²
            if (selectedDoctor) {
                setTimeout(() => {
                    saveCurrentDoctorHistory();
                    // ğŸ”„ è‡ªåŠ¨æ›´æ–°ChatGPTé£æ ¼å¯¹è¯ç®¡ç†ç³»ç»Ÿ
                    updateConversationListAfterMessage();
                }, 200); // å»¶è¿Ÿ200msç¡®ä¿DOMå’Œæ»šåŠ¨éƒ½å®Œæˆ
            }
        }

        // ç§»åŠ¨ç«¯å‘é€æ¶ˆæ¯
        async function sendMobileMessage() {
            const input = document.getElementById('mobileMessageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä½åŒ»å¸ˆ');
                }
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMobileMessage('user', message);
            input.value = '';
            adjustMobileTextareaHeight();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const sendBtn = document.getElementById('mobileSendBtn');
            sendBtn.disabled = true;
            
            // æ·»åŠ "æ­£åœ¨åˆ†æ"çš„ä¸´æ—¶æ¶ˆæ¯
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message ai loading-message';
            loadingMessage.innerHTML = `
                <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f4f6; border-radius: 50%; border-top: 2px solid #667eea; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                AIæ­£åœ¨åˆ†ææ‚¨çš„ç—‡çŠ¶...
            `;
            const container = document.getElementById('mobileMessagesContainer');
            container.appendChild(loadingMessage);
            container.scrollTop = container.scrollHeight;

            // åˆ›å»ºå¸¦è¶…æ—¶çš„AbortController
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 45000); // 45ç§’è¶…æ—¶

                        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šè·å–å½“å‰å¯¹è¯å†å²ä»¥ç»´æŒä¸Šä¸‹æ–‡è¿ç»­æ€§
                const conversationHistory = getCurrentConversationHistory();
                
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor,
                        patient_id: getCurrentUserId(), // ğŸ”‘ ä¿®å¤ï¼šæ·»åŠ ç”¨æˆ·ID
                        conversation_history: conversationHistory // ä¼ é€’å¯¹è¯å†å²
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // ğŸ” è°ƒè¯•ï¼šæ‰“å°å®Œæ•´APIå“åº”
                console.log('ğŸ” ç§»åŠ¨ç«¯APIå®Œæ•´å“åº”:', data);
                
                // å¤„ç†æ–°çš„APIå“åº”æ ¼å¼ (ç§»åŠ¨ç«¯)
                let aiReply;
                if (data.success && data.data && data.data.reply) {
                    aiReply = data.data.reply;
                    console.log('âœ… ç§»åŠ¨ç«¯ä½¿ç”¨æ–°æ ¼å¼ï¼Œå›å¤å†…å®¹é•¿åº¦:', aiReply.length);
                } else if (data.reply) {
                    aiReply = data.reply; // å…¼å®¹æ—§æ ¼å¼
                    console.log('âœ… ç§»åŠ¨ç«¯ä½¿ç”¨æ—§æ ¼å¼ï¼Œå›å¤å†…å®¹é•¿åº¦:', aiReply.length);
                } else {
                    console.error('âŒ ç§»åŠ¨ç«¯APIå“åº”æ ¼å¼é”™è¯¯ï¼Œå“åº”ç»“æ„:', Object.keys(data));
                    throw new Error('APIå“åº”æ ¼å¼é”™è¯¯: æœªæ‰¾åˆ°replyå­—æ®µ');
                }
                
                if (aiReply) {
                    // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå¤„æ–¹æ£€æµ‹å’Œæ”¯ä»˜çŠ¶æ€åˆ†ç¦»ç®¡ç†ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    const containsActualPrescription = containsPrescription(aiReply);
                    const isTemporaryAdvice = window.prescriptionContentRenderer ? 
                        !window.prescriptionContentRenderer.containsPrescription(aiReply) : false;
                    
                    // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºç‚¹è¯„ - æ‰€æœ‰AIå›å¤éƒ½å¯ä»¥ç‚¹è¯„
                    const shouldShowFeedback = true;
                    
                    // å¤„æ–¹ç›¸å…³çŠ¶æ€ç®¡ç† - ä¿®å¤å¤„æ–¹IDä¸ºç©ºçš„é—®é¢˜
                    let prescriptionId = data.data?.prescription_id || null;
                    const isPaid = data.data?.is_paid || false;
                    
                    // ğŸ”§ å¦‚æœAPIæ²¡æœ‰è¿”å›å¤„æ–¹IDï¼Œä½†å“åº”åŒ…å«å¤„æ–¹å†…å®¹ï¼Œåˆ™è°ƒç”¨åç«¯åˆ›å»ºå¤„æ–¹
                    if (!prescriptionId && data.reply && 
                        (data.reply.includes('å¤„æ–¹') || data.reply.includes('æ–¹å‰‚') || 
                         data.reply.includes('å›è¯') || data.reply.includes('è‡£è¯'))) {
                        
                        // ğŸ”‘ å…³é”®ä¿®å¤ï¼šè°ƒç”¨åç«¯APIåˆ›å»ºå¤„æ–¹å¹¶ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆç§»åŠ¨ç«¯ï¼‰
                        try {
                            const userId = getCurrentUserId();
                            const conversationId = currentConversationId || generateConversationId();
                            
                            const prescriptionData = {
                                patient_id: userId,
                                conversation_id: conversationId,
                                patient_name: currentUser?.display_name || currentUser?.username || 'ç”¨æˆ·',
                                symptoms: (data.data?.symptoms_summary || 'ç”¨æˆ·é—®è¯Š'),
                                diagnosis: (data.data?.diagnosis_summary || selectedDoctor + 'åŒ»ç”Ÿè¯Šæ–­'),
                                ai_prescription: data.reply
                            };
                            
                            console.log('ğŸ”„ ç§»åŠ¨ç«¯è°ƒç”¨åç«¯åˆ›å»ºå¤„æ–¹:', prescriptionData);
                            
                            const createResponse = await fetch('/api/prescription/create', {
                                method: 'POST',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(prescriptionData)
                            });
                            
                            if (createResponse.ok) {
                                const createResult = await createResponse.json();
                                if (createResult.success) {
                                    prescriptionId = createResult.prescription_id;
                                    console.log('âœ… ç§»åŠ¨ç«¯å¤„æ–¹åˆ›å»ºæˆåŠŸï¼ŒID:', prescriptionId);
                                } else {
                                    console.warn('âš ï¸ ç§»åŠ¨ç«¯å¤„æ–¹åˆ›å»ºè¿”å›å¤±è´¥:', createResult.message);
                                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¸´æ—¶ID
                                    prescriptionId = 'temp_mobile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                }
                            } else {
                                console.warn('âš ï¸ ç§»åŠ¨ç«¯å¤„æ–¹åˆ›å»ºAPIè°ƒç”¨å¤±è´¥:', createResponse.status);
                                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¸´æ—¶ID
                                prescriptionId = 'temp_mobile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                        } catch (error) {
                            console.error('âŒ ç§»åŠ¨ç«¯å¤„æ–¹åˆ›å»ºå¼‚å¸¸:', error);
                            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¸´æ—¶ID
                            prescriptionId = 'temp_mobile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                        
                        console.log('ğŸ†• ç§»åŠ¨ç«¯æœ€ç»ˆå¤„æ–¹ID:', prescriptionId);
                    }
                    
                    // ğŸš¨ å…³é”®é€»è¾‘ï¼šå®Œæ•´å¤„æ–¹ä¸”æœªä»˜è´¹æ—¶éœ€è¦æ”¯ä»˜
                    const needsPayment = containsActualPrescription && !isTemporaryAdvice && !isPaid;
                    
                    console.log('ğŸ” ç§»åŠ¨ç«¯å³å°†æ·»åŠ AIæ¶ˆæ¯:', {
                        aiReply: aiReply.substring(0, 100) + '...',
                        shouldShowFeedback,
                        containsActualPrescription,
                        isTemporaryAdvice,
                        needsPayment,
                        isPaid,
                        prescriptionId
                    });
                    
                    // ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ ¹æ®å¤„æ–¹çŠ¶æ€å†³å®šæ˜¾ç¤ºæ¨¡å¼
                    addMobileMessage('ai', aiReply, shouldShowFeedback, isPaid, prescriptionId);
                    
                    // è®°å½•è¯Šæ–­é˜¶æ®µ
                    if (shouldShowFeedback) {
                        console.log('ç§»åŠ¨ç«¯æ£€æµ‹åˆ°å¤„æ–¹å†…å®¹ï¼Œæ˜¾ç¤ºç‚¹è¯„åŠŸèƒ½ï¼Œå¤„æ–¹ID:', prescriptionId, 'æ”¯ä»˜çŠ¶æ€:', isPaid);
                    } else {
                        console.log('ç§»åŠ¨ç«¯æ™®é€šå¯¹è¯ï¼Œä¸æ˜¾ç¤ºç‚¹è¯„');
                    }
                } else {
                    addMobileMessage('ai', 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
                }
                
                // ä¿å­˜ç§»åŠ¨ç«¯å¯¹è¯å†å²
                setTimeout(() => {
                    saveCurrentDoctorHistory();
                    // ğŸ”„ è‡ªåŠ¨æ›´æ–°ChatGPTé£æ ¼å¯¹è¯ç®¡ç†ç³»ç»Ÿ
                    updateConversationListAfterMessage();
                }, 200);

            } catch (error) {
                console.error('Mobile API Error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMsg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = 'ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åå†è¯•';
                } else if (error.message.includes('HTTP error')) {
                    errorMsg = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                } else {
                    errorMsg = `è¿æ¥å¤±è´¥: ${error.message}`;
                }
                
                addMobileMessage('ai', errorMsg);
            } finally {
                sendBtn.disabled = false;
            }
        }

        // ç§»åŠ¨ç«¯è¾“å…¥æ¡†é«˜åº¦è°ƒæ•´
        function adjustMobileTextareaHeight() {
            const textarea = document.getElementById('mobileMessageInput');
            if (!textarea) return;
            
            textarea.style.height = '44px'; // é‡ç½®ä¸ºæœ€å°é«˜åº¦
            const newHeight = Math.min(textarea.scrollHeight, 100);
            textarea.style.height = newHeight + 'px';
        }

        // ç§»åŠ¨ç«¯é”®ç›˜äº‹ä»¶
        function handleMobileKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMobileMessage();
            }
        }
        
        
        // ç§»åŠ¨ç«¯è¾“å…¥æ¡†ç„¦ç‚¹å¤„ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function ensureMobileInputVisible() {
            const container = document.getElementById('mobileMessagesContainer');
            
            // ç®€å•æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä¸åšè¿‡å¤šå¹²é¢„
            setTimeout(() => {
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 100);
        }
        
        // è½¯é”®ç›˜æ”¶èµ·å¤„ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function handleMobileInputBlur() {
            // ä»…åšæœ€å°å¿…è¦çš„æ¸…ç†
            setTimeout(() => {
                const container = document.getElementById('mobileMessagesContainer');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 200);
        }

        // åˆ é™¤è§†å£ç›‘å¬å™¨ï¼Œé¿å…è¿‡å¤šå¹²é¢„
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç§»åŠ¨ç«¯
        document.addEventListener('DOMContentLoaded', function() {
            // è°ƒè¯•ï¼šæ£€æŸ¥ç§»åŠ¨ç«¯æ£€æµ‹
            const isMobile = window.innerWidth <= 768;
            const mobileContainer = document.getElementById('mobilePageContainer');
            console.log('ğŸ” ç§»åŠ¨ç«¯æ£€æµ‹:', {
                windowWidth: window.innerWidth,
                isMobile: isMobile,
                mobileContainer: mobileContainer,
                containerDisplay: mobileContainer ? getComputedStyle(mobileContainer).display : 'not found'
            });
            if (window.innerWidth <= 768) {
                console.log('âœ… åˆå§‹åŒ–ç§»åŠ¨ç«¯ç•Œé¢');
                
                // å¼ºåˆ¶æ˜¾ç¤ºç§»åŠ¨ç«¯å®¹å™¨
                const mobileContainer = document.getElementById('mobilePageContainer');
                if (mobileContainer) {
                    mobileContainer.style.display = 'flex';
                    console.log('âœ… å¼ºåˆ¶æ˜¾ç¤ºç§»åŠ¨ç«¯å®¹å™¨');
                }
                
                // å»¶è¿Ÿæ¸²æŸ“åŒ»ç”Ÿå¡ç‰‡ï¼Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
                setTimeout(() => {
                    renderMobileDoctorCards();
                }, 500);
                
                // ç§»åŠ¨ç«¯ä¸è®¾ç½®é»˜è®¤åŒ»ç”Ÿï¼Œè®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©
                // setMobileDefaultDoctor('zhang_zhongjing');
            } else {
                console.log('ğŸ–¥ï¸ æ¡Œé¢ç«¯æ¨¡å¼');
            }
        });
        
        // ç§»åŠ¨ç«¯è®¾ç½®é»˜è®¤åŒ»ç”Ÿ
        function setMobileDefaultDoctor(doctorKey) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // æ›´æ–°ç§»åŠ¨ç«¯åŒ»ç”Ÿä¿¡æ¯
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯åˆ°ç§»åŠ¨ç«¯
            const mobileContainer = document.getElementById('mobileMessagesContainer');
            if (mobileContainer && !mobileContainer.querySelector('.message')) {
                addMobileMessage('ai', `æ‚¨å¥½ï¼æˆ‘æ˜¯${doctor.name}ï¼Œ${doctor.school}ä¼ äººã€‚è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘å°†ä¸ºæ‚¨è¿›è¡Œä¸“ä¸šçš„ä¸­åŒ»åˆ†æã€‚`);
            }
        }
    </script>
    
    <!-- å¼€å‘è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
    <div id="mobileVersionInfo" style="display: none; position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 20px; font-size: 11px; z-index: 1000; border: 1px solid rgba(255,255,255,0.2);">
        <span style="color: #4fc3f7;">TCM v1.2.4</span> | 
        <a href="/static/wechat_debug.html" style="color: #81c784; text-decoration: none;">ç½‘ç»œè¯Šæ–­</a> | 
        <a href="javascript:location.reload(true)" style="color: #ffb74d; text-decoration: none;">åˆ·æ–°</a> |
        <span style="color: #f48fb1; cursor: pointer;" onclick="this.parentElement.style.display='none'">Ã—</span>
    </div>
    
    <script>
        // è°ƒè¯•æ¨¡å¼æ£€æµ‹ - åªæœ‰åœ¨ç‰¹å®šæ¡ä»¶ä¸‹æ‰æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function isDebugMode() {
            // æ£€æµ‹URLå‚æ•°ã€å¼€å‘ç¯å¢ƒç­‰
            const urlParams = new URLSearchParams(window.location.search);
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const hasDebugParam = urlParams.has('debug');
            const isDevPort = window.location.port === '7789' || window.location.port === '3000';
            
            return isLocalhost || hasDebugParam || isDevPort;
        }
        
        // æ·»åŠ ç‰¹æ®Šæ‰‹åŠ¿æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯çš„åŠŸèƒ½ï¼ˆä»…ä¾›å¼€å‘è°ƒè¯•ï¼‰
        let clickSequence = [];
        let debugVisible = false;
        
        document.addEventListener('click', function(e) {
            // è®°å½•ç‚¹å‡»ä½ç½®ï¼ˆåˆ†ä¸º9å®«æ ¼ï¼‰
            const x = Math.floor(e.clientX / (window.innerWidth / 3));
            const y = Math.floor(e.clientY / (window.innerHeight / 3));
            const position = y * 3 + x;
            
            clickSequence.push(position);
            if (clickSequence.length > 5) clickSequence.shift();
            
            // ç‰¹æ®Šåºåˆ—ï¼šå·¦ä¸Š-å³ä¸Š-å·¦ä¸‹-å³ä¸‹-ä¸­å¿ƒ (0-2-6-8-4)
            const debugSequence = [0, 2, 6, 8, 4];
            const isDebugSequence = clickSequence.length === 5 && 
                clickSequence.every((pos, idx) => pos === debugSequence[idx]);
            
            if (isDebugSequence && (isDebugMode() || window.location.hostname.includes('dev'))) {
                debugVisible = !debugVisible;
                document.getElementById('mobileVersionInfo').style.display = debugVisible ? 'block' : 'none';
                clickSequence = [];
                
                if (debugVisible) {
                    setTimeout(() => {
                        document.getElementById('mobileVersionInfo').style.display = 'none';
                        debugVisible = false;
                    }, 10000);
                }
            }
            
            // æ¸…ç©ºåºåˆ—
            setTimeout(() => { clickSequence = []; }, 3000);
        });
        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        function checkNetworkStatus() {
            if (!navigator.onLine) {
                addMobileMessage('ai', 'ğŸ”Œ æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®ã€‚');
                return false;
            }
            return true;
        }
        
        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', function() {
            console.log('Network is back online');
        });
        
        window.addEventListener('offline', function() {
            console.log('Network is offline');
            addMobileMessage('ai', 'ğŸ”Œ ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®ã€‚');
        });
    </script>

    <!-- å¾®ä¿¡åˆ†äº«å¢å¼ºè„šæœ¬ -->
    <script>
        // å¾®ä¿¡ç¯å¢ƒæ£€æµ‹
        function isWechat() {
            return /MicroMessenger/i.test(navigator.userAgent);
        }
        
        // æ£€æµ‹å¾®ä¿¡å…¬ä¼—å·æ¥æº
        function detectWechatSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromWechat = urlParams.get('from') === 'wechat';
            const wechatSource = urlParams.get('source') || 'unknown';
            
            return {
                fromWechat: fromWechat,
                source: wechatSource,
                isWechatBrowser: isWechat()
            };
        }
        
        // å¤„ç†å¾®ä¿¡å…¬ä¼—å·è®¿é—®
        function handleWechatPublicAccount() {
            const wechatInfo = detectWechatSource();
            
            if (wechatInfo.fromWechat || wechatInfo.isWechatBrowser) {
                console.log('å¾®ä¿¡å…¬ä¼—å·ç”¨æˆ·è®¿é—®ï¼Œæ¥æº:', wechatInfo.source);
                
                // è®°å½•å¾®ä¿¡è®¿é—®ç»Ÿè®¡
                fetch('/api/log_wechat_visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: wechatInfo.source,
                        from_wechat: wechatInfo.fromWechat,
                        is_wechat_browser: wechatInfo.isWechatBrowser,
                        timestamp: new Date().toISOString(),
                        page: 'main_app'
                    })
                }).catch(err => console.log('å¾®ä¿¡è®¿é—®è®°å½•å¤±è´¥:', err));
                
                // æ˜¾ç¤ºå¾®ä¿¡ä¸“å±æ¬¢è¿ä¿¡æ¯
                if (wechatInfo.fromWechat && wechatInfo.source === 'menu') {
                    setTimeout(() => showWechatWelcome(), 1000);
                }
                
                // å¾®ä¿¡å†…ä¼˜åŒ–ï¼šéšè—ä¸å¿…è¦çš„åˆ†äº«æŒ‰é’®
                if (wechatInfo.isWechatBrowser) {
                    const shareButtons = document.querySelectorAll('.share-button, .external-share');
                    shareButtons.forEach(btn => btn.style.display = 'none');
                }
            }
        }
        
        // æ˜¾ç¤ºå¾®ä¿¡ä¸“å±æ¬¢è¿ä¿¡æ¯
        function showWechatWelcome() {
            const welcomeHTML = `
                <div id="wechatWelcome" style="
                    position: fixed; 
                    top: 60px; 
                    left: 50%; 
                    transform: translateX(-50%); 
                    background: linear-gradient(135deg, #28a745, #20c997); 
                    color: white; 
                    padding: 12px 20px; 
                    border-radius: 25px; 
                    font-size: 13px; 
                    z-index: 9999;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    animation: slideInDown 0.6s ease-out;
                    text-align: center;
                    max-width: 280px;
                ">
                    ğŸ‰ æ¬¢è¿ä»å…¬ä¼—å·è®¿é—®ï¼<br>
                    <small>5å¤§ä¸­åŒ»æµæ´¾ï¼Œä¸“ä¸šAIé—®è¯Š</small>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', welcomeHTML);
            
            // 4ç§’åæ·¡å‡º
            setTimeout(() => {
                const welcome = document.getElementById('wechatWelcome');
                if (welcome) {
                    welcome.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    welcome.style.opacity = '0';
                    welcome.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => welcome.remove(), 500);
                }
            }, 4000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å¾®ä¿¡åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            handleWechatPublicAccount();
        });
        
        // ä¼˜åŒ–å¾®ä¿¡åˆ†äº«
        if (isWechat()) {
            // åŠ¨æ€è®¾ç½®åˆ†äº«ä¿¡æ¯
            document.title = "AIä¸­åŒ»æ™ºèƒ½é—®è¯ŠåŠ©æ‰‹";
            
            // æ·»åŠ å¾®ä¿¡åˆ†äº«å…ƒä¿¡æ¯
            var metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.content = "ä¸“ä¸šAIä¸­åŒ»è¯Šæ–­åŠ©æ‰‹ï¼Œæ™ºèƒ½ç—‡çŠ¶åˆ†æï¼Œè¯å€™åˆ¤æ–­ï¼Œä¸ªæ€§åŒ–æ–¹å‰‚æ¨è";
            }
            
            // è®°å½•å¾®ä¿¡åˆ†äº«ç»Ÿè®¡
            window.addEventListener('load', function() {
                fetch('/api/wechat_visit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        page: 'main_app',
                        is_shared: document.referrer.includes('wechat'),
                        timestamp: new Date().toISOString()
                    })
                }).catch(() => {});
            });
            
            // é¡µé¢å…³é—­æˆ–åˆ·æ–°æ—¶ä¿å­˜å†å²è®°å½•
            window.addEventListener('beforeunload', function(event) {
                // ç¡®ä¿åœ¨é¡µé¢å…³é—­å‰ä¿å­˜å½“å‰å¯¹è¯å†å²
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('é¡µé¢å…³é—­å‰å·²ä¿å­˜å†å²è®°å½•');
                }
            });
            
            // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ä¹Ÿä¿å­˜ï¼ˆåº”å¯¹æ‰‹æœºåˆ‡æ¢åº”ç”¨ç­‰åœºæ™¯ï¼‰
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('é¡µé¢éšè—æ—¶å·²ä¿å­˜å†å²è®°å½•');
                }
            });
            
            // å¢å¼ºå†å²è®°å½•ä¿æŠ¤ - å®šæœŸè‡ªåŠ¨ä¿å­˜
            setInterval(() => {
                if (selectedDoctor) {
                    const messagesContainer = document.getElementById(window.innerWidth <= 768 ? 'mobileMessagesContainer' : 'messagesContainer');
                    if (messagesContainer && messagesContainer.children.length > 0) {
                        saveCurrentDoctorHistory();
                        console.log('å®šæœŸè‡ªåŠ¨ä¿å­˜å†å²è®°å½•');
                    }
                }
            }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
            
            // æµè§ˆå™¨ç„¦ç‚¹å˜åŒ–æ—¶ä¿å­˜
            window.addEventListener('blur', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('æµè§ˆå™¨å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜å†å²è®°å½•');
                }
            });
            
            // é¡µé¢å¸è½½å‰å¼ºåˆ¶ä¿å­˜
            window.addEventListener('pagehide', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('é¡µé¢å¸è½½å‰ä¿å­˜å†å²è®°å½•');
                }
            });
        }
        
        // localStorageç®¡ç†åŠŸèƒ½
        function checkLocalStorageUsage() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length + key.length;
                    }
                }
                const sizeInMB = (totalSize / 1024 / 1024).toFixed(2);
                console.log(`LocalStorageä½¿ç”¨é‡: ${sizeInMB}MB`);
                
                // å¦‚æœè¶…è¿‡4MBï¼Œå‘å‡ºè­¦å‘Š
                if (totalSize > 4 * 1024 * 1024) {
                    console.warn('LocalStorageä½¿ç”¨é‡è¾ƒå¤§ï¼Œå¯èƒ½éœ€è¦æ¸…ç†');
                }
            } catch (error) {
                console.error('æ£€æŸ¥localStorageä½¿ç”¨é‡å¤±è´¥:', error);
            }
        }
        
        function cleanOldHistoryRecords() {
            try {
                const keys = Object.keys(localStorage);
                const userId = getCurrentUserId();
                const historyKeys = keys.filter(key => key.startsWith(`tcm_doctor_history_${userId}_`));
                
                // å¦‚æœæœ‰è¶…è¿‡10ä¸ªåŒ»ç”Ÿçš„å†å²è®°å½•ï¼Œæ¸…ç†æœ€æ—§çš„
                if (historyKeys.length > 10) {
                    const keysWithTime = historyKeys.map(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            const lastUpdated = data.lastUpdated || data.timestamp || 0;
                            return { key, lastUpdated };
                        } catch {
                            return { key, lastUpdated: 0 };
                        }
                    });
                    
                    // æŒ‰æ—¶é—´æ’åºï¼Œåˆ é™¤æœ€æ—§çš„
                    keysWithTime.sort((a, b) => new Date(a.lastUpdated) - new Date(b.lastUpdated));
                    const keysToDelete = keysWithTime.slice(0, historyKeys.length - 8); // ä¿ç•™æœ€æ–°8ä¸ª
                    
                    keysToDelete.forEach(({ key }) => {
                        localStorage.removeItem(key);
                        console.log(`å·²æ¸…ç†æ—§å†å²è®°å½•: ${key}`);
                    });
                }
            } catch (error) {
                console.error('æ¸…ç†æ—§å†å²è®°å½•å¤±è´¥:', error);
            }
        }
        
        // å†å²è®°å½•è¯Šæ–­åŠŸèƒ½
        function diagnoseHistoryIssues() {
            console.log('=== å†å²è®°å½•è¯Šæ–­ ===');
            console.log('å½“å‰åŒ»ç”Ÿ:', selectedDoctor);
            console.log('æµè§ˆå™¨ä¿¡æ¯:', navigator.userAgent);
            console.log('å±å¹•å°ºå¯¸:', window.innerWidth + 'x' + window.innerHeight);
            
            const keys = Object.keys(localStorage);
            const userId = getCurrentUserId();
            const historyKeys = keys.filter(key => key.startsWith(`tcm_doctor_history_${userId}_`));
            console.log('å†å²è®°å½•æ•°é‡:', historyKeys.length);
            
            // ğŸ” ç”¨æˆ·å†å²è®°å½•è°ƒè¯•ä¿¡æ¯
            debugUserIdAndHistory();
            
            historyKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = JSON.parse(data);
                    const messageCount = Array.isArray(parsed) ? parsed.length : (parsed.messages ? parsed.messages.length : 0);
                    console.log(`${key}: ${messageCount}æ¡æ¶ˆæ¯, å¤§å°=${(data.length/1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error(`${key}: æ•°æ®æŸå`, error);
                }
            });
            
            checkLocalStorageUsage();
            
            // æµ‹è¯•localStorageå†™å…¥
            try {
                const testKey = 'tcm_test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                console.log('âœ… localStorageå†™å…¥æµ‹è¯•æˆåŠŸ');
            } catch (error) {
                console.error('âŒ localStorageå†™å…¥æµ‹è¯•å¤±è´¥:', error);
            }
        }

        // é—®è¯ŠæŒ‡å¯¼åŠŸèƒ½
        function showGuidance() {
            const overlay = document.createElement('div');
            overlay.className = 'guidance-overlay';
            overlay.onclick = hideGuidance;
            document.body.appendChild(overlay);
            
            document.getElementById('guidanceTips').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideGuidance() {
            document.getElementById('guidanceTips').style.display = 'none';
            const overlay = document.querySelector('.guidance-overlay');
            if (overlay) {
                overlay.remove();
            }
            document.body.style.overflow = 'auto';
        }

        function toggleGuidance() {
            hideGuidance();
        }
    </script>

    <!-- é—®è¯ŠæŒ‡å¯¼æç¤º -->
    <div class="guidance-tips" id="guidanceTips" style="display: none;">
        <div class="tips-header">
            <h4>ğŸ’¡ é—®è¯ŠæŒ‡å¯¼</h4>
            <button onclick="toggleGuidance()" class="close-btn">Ã—</button>
        </div>
        <div class="tips-content">
            <div class="tip-section">
                <h5>ğŸ” ä¸»è¦ç—‡çŠ¶æè¿°</h5>
                <ul>
                    <li>ä¸»è¦ä¸é€‚æ„Ÿè§‰ï¼ˆç–¼ç—›ã€å‘çƒ­ã€å’³å—½ç­‰ï¼‰</li>
                    <li>ç—‡çŠ¶æŒç»­æ—¶é—´ï¼ˆå‡ å¤©ã€å‡ å‘¨ã€å‡ ä¸ªæœˆï¼‰</li>
                    <li>ç—‡çŠ¶ç¨‹åº¦ï¼ˆè½»å¾®ã€ä¸­ç­‰ã€ä¸¥é‡ï¼‰</li>
                    <li>å‘ä½œè§„å¾‹ï¼ˆæŒç»­æ€§ã€é—´æ­‡æ€§ã€ç‰¹å®šæ—¶é—´ï¼‰</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>ğŸ©º ä¼´éšç—‡çŠ¶</h5>
                <ul>
                    <li>ç¡çœ æƒ…å†µï¼ˆå…¥ç¡å›°éš¾ã€æ˜“é†’ã€å¤šæ¢¦ï¼‰</li>
                    <li>é£Ÿæ¬²çŠ¶å†µï¼ˆé£Ÿæ¬²ä¸æŒ¯ã€æ¶ˆåŒ–ä¸è‰¯ï¼‰</li>
                    <li>å¤§å°ä¾¿æƒ…å†µï¼ˆä¾¿ç§˜ã€è…¹æ³»ã€å°¿é¢‘ç­‰ï¼‰</li>
                    <li>æƒ…ç»ªçŠ¶æ€ï¼ˆç„¦è™‘ã€æŠ‘éƒã€çƒ¦èºï¼‰</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>ğŸ‘… èˆŒè±¡è„‰è±¡ï¼ˆå¦‚æœæ–¹ä¾¿ï¼‰</h5>
                <ul>
                    <li>èˆŒå¤´é¢œè‰²ï¼ˆæ·¡çº¢ã€çº¢ã€æš—çº¢ï¼‰</li>
                    <li>èˆŒè‹”æƒ…å†µï¼ˆè–„ç™½ã€åšé»„ã€æ— è‹”ç­‰ï¼‰</li>
                    <li>è„‰ææ„Ÿè§‰ï¼ˆå¿«æ…¢ã€å¼ºå¼±ã€è§„å¾‹æ€§ï¼‰</li>
                    <li>å¯ä¸Šä¼ èˆŒè±¡ç…§ç‰‡ä»¥ä¾¿æ›´å‡†ç¡®è¯Šæ–­</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>ğŸ“‹ å…¶ä»–é‡è¦ä¿¡æ¯</h5>
                <ul>
                    <li>æ—¢å¾€ç—…å²ï¼ˆæ…¢æ€§ç—…ã€æ‰‹æœ¯å²ï¼‰</li>
                    <li>è¿‡æ•å²ï¼ˆè¯ç‰©ã€é£Ÿç‰©è¿‡æ•ï¼‰</li>
                    <li>ç›®å‰ç”¨è¯æƒ…å†µ</li>
                    <li>ç”Ÿæ´»ä¹ æƒ¯ï¼ˆä½œæ¯ã€é¥®é£Ÿã€è¿åŠ¨ï¼‰</li>
                </ul>
            </div>
            
            <div class="tip-footer">
                <p>ğŸ’¬ <strong>æç¤º</strong>ï¼šæä¾›è¶Šè¯¦ç»†çš„ä¿¡æ¯ï¼ŒåŒ»ç”Ÿè¶Šèƒ½ç»™å‡ºå‡†ç¡®çš„è¯Šæ–­å’Œæ²»ç–—å»ºè®®</p>
            </div>
        </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯å›¾ç‰‡é€‰æ‹©å¼¹çª— - ç§»è‡³bodyåº•éƒ¨ç¡®ä¿æœ€é«˜å±‚çº§ -->
    <div class="mobile-image-modal mobile-modal-hidden" id="mobileImageModal">
        <div class="mobile-image-modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©æ‹ç…§ç±»å‹</h3>
                <button onclick="closeMobileImageModal()" class="modal-close">Ã—</button>
            </div>
            <div class="modal-options">
                <button onclick="triggerMobileTongueUpload()" class="image-option-btn">
                    <div class="option-icon">ğŸ‘…</div>
                    <div class="option-text">
                        <strong>èˆŒè¯Šæ‹ç…§</strong>
                        <span>æ‹æ‘„èˆŒå¤´ç…§ç‰‡</span>
                    </div>
                </button>
                <button onclick="triggerMobileFaceUpload()" class="image-option-btn">
                    <div class="option-icon">ğŸ˜Š</div>
                    <div class="option-text">
                        <strong>é¢è¯Šæ‹ç…§</strong>
                        <span>æ‹æ‘„é¢éƒ¨ç…§ç‰‡</span>
                    </div>
                </button>
            </div>
            <div class="upload-status-mobile" id="mobileUploadStatus">
                <div class="mobile-status-item" id="mobileTongueStatus">ğŸ‘… èˆŒè¯Š: <span>æœªä¸Šä¼ </span></div>
                <div class="mobile-status-item" id="mobileFaceStatus">ğŸ˜Š é¢è¯Š: <span>æœªä¸Šä¼ </span></div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <div class="login-header">
                <h3>ç”¨æˆ·ç™»å½•</h3>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å/æ‰‹æœºå·</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–æ‰‹æœºå·">
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="error-message" id="loginError">
                    ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç 
                </div>
                <div class="login-buttons">
                    <button class="login-btn secondary" onclick="hideLoginModal()">å–æ¶ˆ</button>
                    <button class="login-btn primary" onclick="performLogin()">ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤„æ–¹æ¸²æŸ“å™¨æ ·å¼å’Œè„šæœ¬ -->
    <link rel="stylesheet" href="/static/css/prescription_styles.css">
    <!-- ğŸ¯ ç®€åŒ–ç‰ˆå¤„æ–¹æ”¯ä»˜ç®¡ç†ç³»ç»Ÿ -->
    <script src="/static/js/simple_prescription_manager.js?v=20250926-001"></script>
    
    <!-- ğŸ”‘ ç®€åŒ–ç‰ˆå¤„æ–¹æ¢å¤ç³»ç»Ÿ - å·²ç¦ç”¨ï¼Œç”±ä¸»ç³»ç»Ÿç»Ÿä¸€ç®¡ç† -->
    <!-- <script src="/static/js/simple_recovery.js?v=20250930-001"></script> -->
    
    <!-- å¤‡ç”¨ï¼šåŸå¤„æ–¹æ”¯ä»˜ç®¡ç†ç³»ç»Ÿ (æš‚æ—¶ç¦ç”¨ï¼Œé¿å…è¯­æ³•å†²çª) -->
    <!-- <script src="/static/js/prescription_payment_manager.js?v=20250925-004"></script> -->
    <!-- <script src="/static/js/prescription_debug_helper.js?v=20250925-004"></script> -->
    <!-- <script src="/static/js/prescription_renderer.js?v=20250916-010"></script> -->
    <script>
        // ğŸ”§ è°ƒè¯•ï¼šæ£€æŸ¥å¤„æ–¹æ”¯ä»˜ç®¡ç†ç³»ç»ŸåŠ è½½çŠ¶æ€
        setTimeout(() => {
            console.log('ğŸ” å¤„æ–¹æ”¯ä»˜ç³»ç»ŸåŠ è½½æ£€æŸ¥:', {
                simplePrescriptionManager: !!window.simplePrescriptionManager,
                windowKeys: Object.keys(window).filter(k => k.includes('prescription') || k.includes('simple'))
            });
            
            if (window.simplePrescriptionManager) {
                console.log('âœ… ç®€åŒ–ç‰ˆå¤„æ–¹æ”¯ä»˜ç®¡ç†ç³»ç»ŸåŠ è½½æˆåŠŸ');
            } else {
                console.error('âŒ ç®€åŒ–ç‰ˆå¤„æ–¹æ”¯ä»˜ç®¡ç†ç³»ç»Ÿæœªæ­£ç¡®åŠ è½½');
            }
        }, 1000);
    </script>
    
    <!-- å¯¹è¯çŠ¶æ€ç®¡ç†å™¨ - åœ¨ä¸»è¦JavaScriptä»£ç ä¹‹ååŠ è½½ -->
    <script src="/static/js/conversation_state_manager.js"></script>
    
    <!-- è‡ªåŠ¨åŒæ­¥ç®¡ç†å™¨ v2.0 - æ›¿ä»£æ‰‹åŠ¨åŒæ­¥æŒ‰é’® -->
    <script src="/static/js/auto_sync_manager.js"></script>
    
    <script>
        // åˆå§‹åŒ–è‡ªåŠ¨åŒæ­¥ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ è‡ªåŠ¨åŒæ­¥ç³»ç»Ÿå·²å¯ç”¨ï¼Œå‘Šåˆ«æ‰‹åŠ¨åŒæ­¥æ—¶ä»£ï¼');
            
            // ç›‘å¬è‡ªåŠ¨åŒæ­¥äº‹ä»¶
            if (window.autoSyncManager) {
                window.autoSyncManager.addEventListener('connected', function() {
                    console.log('âœ… å®æ—¶åŒæ­¥å·²è¿æ¥ï¼Œæ‚¨çš„æ•°æ®å°†è‡ªåŠ¨åœ¨è®¾å¤‡é—´åŒæ­¥');
                });
                
                window.autoSyncManager.addEventListener('synced', function(data) {
                    console.log('ğŸ”„ è‡ªåŠ¨åŒæ­¥å®Œæˆ:', data.type);
                });
                
                window.autoSyncManager.addEventListener('conflict', function(data) {
                    console.warn('âš ï¸ æ£€æµ‹åˆ°æ•°æ®å†²çªï¼Œè¯·å¤„ç†:', data);
                });
            }
        });
    </script>
    
    <script>
        // ğŸ”‘ ä¼šè¯æ¢å¤åŠŸèƒ½ - ä»å†å²è®°å½•é‡æ–°åŠ è½½å®Œæ•´å¯¹è¯
        async function restoreSessionFromHistory(sessionId) {
            try {
                console.log('ğŸ”„ å¼€å§‹æ¢å¤å†å²ä¼šè¯:', sessionId);
                
                // æ˜¾ç¤ºæ¢å¤æç¤º
                const restoreMessage = `
                    <div class="restore-notification" style="
                        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white; padding: 15px 25px; border-radius: 8px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000;
                        font-size: 14px; font-weight: 500;
                    ">
                        ğŸ”„ æ­£åœ¨æ¢å¤å†å²å¯¹è¯ï¼Œè¯·ç¨å€™...
                    </div>
                `;
                document.body.insertAdjacentHTML('afterbegin', restoreMessage);
                
                // 1. ä»APIè·å–å®Œæ•´çš„ä¼šè¯æ•°æ®
                const userId = getCurrentUserId();
                const consultationResponse = await fetch(`/api/user/conversation/${sessionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!consultationResponse.ok) {
                    throw new Error(`è·å–ä¼šè¯æ•°æ®å¤±è´¥: ${consultationResponse.status}`);
                }
                
                const consultationData = await consultationResponse.json();
                console.log('ğŸ“„ è·å–åˆ°ä¼šè¯æ•°æ®:', consultationData);
                
                if (!consultationData.success) {
                    throw new Error('ä¼šè¯æ•°æ®è·å–å¤±è´¥');
                }
                
                // APIè¿”å›çš„æ•°æ®ç»“æ„ç›´æ¥åŒ…å«ä¼šè¯ä¿¡æ¯
                const consultation = consultationData;
                
                // 2. è§£æå¯¹è¯è®°å½•
                const conversationHistory = consultation.conversation_history || [];
                console.log('ğŸ’¬ å¯¹è¯å†å²è®°å½•æ•°é‡:', conversationHistory.length);
                
                // 3. è®¾ç½®åŒ»ç”Ÿï¼ˆå¦‚æœæŒ‡å®šäº†ï¼‰
                if (consultation.doctor_name) {
                    console.log('ğŸ‘¨â€âš•ï¸ è®¾ç½®åŒ»ç”Ÿ:', consultation.doctor_name);
                    selectDoctor(consultation.doctor_name);
                }
                
                // 4. æ¸…ç©ºå½“å‰æ¶ˆæ¯å¹¶æ¢å¤å¯¹è¯
                clearAllMessages();
                
                // 5. ä¾æ¬¡æ·»åŠ æ¯æ¡å¯¹è¯è®°å½•
                for (const message of conversationHistory) {
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    if (message.patient_query) {
                        addMessage('æ‚¨', message.patient_query, 'user', false);
                    }
                    
                    // æ·»åŠ AIå›å¤æ¶ˆæ¯
                    if (message.ai_response) {
                        // ğŸ”‘ ç®€åŒ–æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨conversation_logä¸­çš„å®Œæ•´å†…å®¹
                        // è¿™æ˜¯æœ€å‡†ç¡®çš„æ•°æ®æ¥æºï¼ŒåŒ…å«äº†å®Œæ•´çš„å¤„æ–¹è¯¦æƒ…
                        let processedContent = message.ai_response;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤„æ–¹å†…å®¹
                        if (window.simplePrescriptionManager && 
                            window.simplePrescriptionManager.containsPrescription(message.ai_response)) {
                            console.log('ğŸ’Š æ£€æµ‹åˆ°å¤„æ–¹å†…å®¹ï¼Œæ£€æŸ¥æ”¯ä»˜çŠ¶æ€');
                            
                            // ç®€åŒ–é€»è¾‘ï¼šç›´æ¥æŸ¥è¯¢æ˜¯å¦æœ‰å·²æ”¯ä»˜çš„å¤„æ–¹
                            try {
                                const prescriptionResponse = await fetch(`/api/prescription/by-consultation/${sessionId}`);
                                if (prescriptionResponse.ok) {
                                    const prescriptionData = await prescriptionResponse.json();
                                    if (prescriptionData.success && prescriptionData.prescriptions?.length > 0) {
                                        const paidPrescription = prescriptionData.prescriptions.find(p => 
                                            p.is_visible_to_patient === 1 && p.payment_status === 'paid'
                                        );
                                        
                                        if (paidPrescription) {
                                            console.log(`âœ… å¤„æ–¹å·²æ”¯ä»˜ï¼Œç›´æ¥æ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼ŒID: ${paidPrescription.id}`);
                                            // ğŸ”‘ å…³é”®ï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹ï¼Œä¸éœ€è¦å¤„ç†
                                            // å› ä¸ºconversation_logä¸­ä¿å­˜çš„å°±æ˜¯å®Œæ•´çš„å¤„æ–¹å†…å®¹
                                            processedContent = message.ai_response;
                                            
                                            // æ ‡è®°ä¸ºå·²æ”¯ä»˜çŠ¶æ€ï¼Œä¾›å¤„æ–¹ç®¡ç†å™¨è¯†åˆ«
                                            if (window.simplePrescriptionManager) {
                                                await window.simplePrescriptionManager.markAsPaid(paidPrescription.id);
                                            }
                                        } else {
                                            // æœªæ”¯ä»˜ï¼Œä½¿ç”¨å¤„æ–¹ç®¡ç†å™¨å¤„ç†ï¼ˆéšè—è¯¦æƒ…ï¼‰
                                            processedContent = await window.simplePrescriptionManager.processContent(
                                                message.ai_response, 
                                                null
                                            );
                                        }
                                    }
                                }
                            } catch (error) {
                                console.warn('âš ï¸ æŸ¥æ‰¾å¤„æ–¹çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤„ç†:', error);
                                processedContent = await window.simplePrescriptionManager.processContent(
                                    message.ai_response, 
                                    null
                                );
                            }
                        }
                        
                        addMessage(
                            doctors[consultation.doctor_name]?.name || consultation.doctor_display_name || 'ä¸­åŒ»ä¸“å®¶',
                            processedContent,
                            'ai',
                            false  // ä¸ä¿å­˜åˆ°å†å²è®°å½•ï¼Œå› ä¸ºè¿™æ˜¯æ¢å¤æ“ä½œ
                        );
                    }
                }
                
                // 6. æ£€æŸ¥æ˜¯å¦æœ‰å¤„æ–¹ç›¸å…³ä¿¡æ¯
                if (consultation.prescription_given && consultation.prescription_given !== 'æš‚æœªå¼€æ–¹') {
                    console.log('ğŸ’Š æ£€æµ‹åˆ°å¤„æ–¹ä¿¡æ¯ï¼Œè§¦å‘å¤„æ–¹çŠ¶æ€æ£€æŸ¥');
                }
                
                // 7. è®¾ç½®å½“å‰å¯¹è¯IDï¼ˆå¦‚æœéœ€è¦ï¼‰
                currentConversationId = sessionId;
                
                // 8. è§¦å‘å¤„æ–¹çŠ¶æ€æ¢å¤
                if (window.simplePrescriptionManager) {
                    setTimeout(async () => {
                        await window.simplePrescriptionManager.restorePaymentStatus();
                        console.log('âœ… å¤„æ–¹æ”¯ä»˜çŠ¶æ€æ¢å¤å®Œæˆ');
                    }, 1000);
                }
                
                // 9. ç§»é™¤æ¢å¤æç¤ºå¹¶æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                    const notification = document.querySelector('.restore-notification');
                    if (notification) {
                        notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        notification.innerHTML = 'âœ… å†å²å¯¹è¯æ¢å¤æˆåŠŸï¼';
                        
                        setTimeout(() => {
                            notification.remove();
                        }, 2000);
                    }
                }, 500);
                
                console.log('âœ… ä¼šè¯æ¢å¤å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æ¢å¤ä¼šè¯å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const notification = document.querySelector('.restore-notification');
                if (notification) {
                    notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    notification.innerHTML = 'âŒ æ¢å¤å†å²å¯¹è¯å¤±è´¥ï¼Œè¯·é‡è¯•';
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
                
                // æ·»åŠ é”™è¯¯æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
                addMessage('ç³»ç»Ÿ', `æ¢å¤å†å²å¯¹è¯å¤±è´¥ï¼š${error.message}ã€‚æ‚¨å¯ä»¥é‡æ–°å¼€å§‹å¯¹è¯ã€‚`, 'system', false);
            }
        }
        
        // ğŸ¯ æ–°å¢ï¼šè·å–æœ€æ–°é—®è¯Šä¼šè¯çš„å¤„æ–¹è¿‡æ»¤å‡½æ•°
        function getLatestConsultationPrescriptions(prescriptions) {
            if (!prescriptions || prescriptions.length === 0) {
                return [];
            }
            
            // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæ‰¾å‡ºæœ€æ–°çš„å¤„æ–¹è®°å½•
            const sortedPrescriptions = prescriptions.sort((a, b) => 
                new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
            );
            
            // è·å–æœ€æ–°å¤„æ–¹çš„consultation_idæˆ–conversation_idä½œä¸ºä¼šè¯æ ‡è¯†
            const latestPrescription = sortedPrescriptions[0];
            const latestConsultationId = latestPrescription.consultation_id || latestPrescription.conversation_id;
            
            if (!latestConsultationId) {
                console.log('âš ï¸ æœ€æ–°å¤„æ–¹æ²¡æœ‰consultation_idï¼Œè¿”å›æœ€æ–°çš„å•ä¸ªå¤„æ–¹');
                return [latestPrescription];
            }
            
            // è·å–æœ€æ–°ä¸€æ¬¡é—®è¯Šä¼šè¯çš„æ‰€æœ‰å¤„æ–¹
            const latestSessionPrescriptions = prescriptions.filter(p => 
                (p.consultation_id === latestConsultationId) || 
                (p.conversation_id === latestConsultationId && !p.consultation_id)
            );
            
            console.log(`ğŸ” æœ€æ–°é—®è¯Šä¼šè¯ID: ${latestConsultationId}`);
            console.log(`ğŸ“‹ è¯¥ä¼šè¯åŒ…å« ${latestSessionPrescriptions.length} ä¸ªå¤„æ–¹`);
            console.log(`ğŸ• ä¼šè¯æ—¶é—´: ${latestPrescription.created_at}`);
            
            return latestSessionPrescriptions;
        }
        
        // ğŸ”‘ æ–°å¢ï¼šä»æœåŠ¡å™¨æ¢å¤å¤„æ–¹çŠ¶æ€çš„æ ¸å¿ƒå‡½æ•°
        async function restorePrescriptionStatesFromServer() {
            try {
                const userId = getCurrentUserId();
                console.log('ğŸŒ ä»æœåŠ¡å™¨æ¢å¤å¤„æ–¹çŠ¶æ€ï¼Œç”¨æˆ·ID:', userId);
                
                if (!userId || userId === 'undefined' || userId === 'null') {
                    console.warn('âš ï¸ æ— æ•ˆçš„ç”¨æˆ·IDï¼Œè·³è¿‡å¤„æ–¹çŠ¶æ€æ¢å¤');
                    return;
                }
                
                // ä»æœåŠ¡å™¨è·å–ç”¨æˆ·çš„æ‰€æœ‰å¤„æ–¹
                const response = await fetch(`/api/prescription/patient/${userId}/prescriptions`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    console.warn('âš ï¸ è·å–å¤„æ–¹åˆ—è¡¨å¤±è´¥:', response.status);
                    return;
                }
                
                const result = await response.json();
                console.log('ğŸ“‹ æœåŠ¡å™¨è¿”å›çš„å¤„æ–¹åˆ—è¡¨:', result);
                
                if (result.success && result.prescriptions && result.prescriptions.length > 0) {
                    const allPrescriptions = result.prescriptions;
                    
                    // ğŸ¯ å…³é”®ä¿®æ”¹ï¼šåªæ¢å¤æœ€åä¸€æ¬¡é—®è¯Šçš„å¤„æ–¹
                    const latestSessionPrescriptions = getLatestConsultationPrescriptions(allPrescriptions);
                    let restoredCount = 0;
                    
                    // ğŸ”‘ ç¡®ä¿æ¶ˆæ¯å®¹å™¨å·²å‡†å¤‡å¥½
                    const messagesContainer = document.getElementById('messagesContainer') || document.getElementById('mobileMessagesContainer');
                    if (!messagesContainer) {
                        console.warn('âš ï¸ æ¶ˆæ¯å®¹å™¨æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿé‡è¯•...');
                        setTimeout(() => restorePrescriptionStatesFromServer(), 1000);
                        return;
                    }
                    
                    console.log(`ğŸ“Š å¤„æ–¹ç»Ÿè®¡: æ€»è®¡ ${allPrescriptions.length} ä¸ªï¼Œæ¢å¤æœ€æ–°ä¼šè¯çš„ ${latestSessionPrescriptions.length} ä¸ª`);
                    console.log(`ğŸ”„ å¼€å§‹å¤„ç† ${latestSessionPrescriptions.length} ä¸ªæœ€æ–°ä¼šè¯å¤„æ–¹çš„çŠ¶æ€æ¢å¤...`);
                    
                    for (const prescription of latestSessionPrescriptions) {
                        const prescriptionId = prescription.id;
                        const status = prescription.status;
                        const paymentStatus = prescription.payment_status;
                        
                        console.log(`ğŸ”„ å¤„ç†å¤„æ–¹ID ${prescriptionId}: status=${status}, payment=${paymentStatus}`);
                        
                        // æ ¹æ®çŠ¶æ€æ¢å¤å¤„æ–¹æ˜¾ç¤º
                        if (paymentStatus === 'paid' && status === 'pending_review') {
                            // å·²æ”¯ä»˜ä½†ç­‰å¾…å®¡æ ¸ï¼šæ˜¾ç¤ºç­‰å¾…å®¡æ ¸çŠ¶æ€
                            console.log(`ğŸ“‹ å¼€å§‹æ¢å¤ç­‰å¾…å®¡æ ¸çŠ¶æ€: ${prescriptionId}`);
                            
                            // å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå¤„æ–¹çš„æ¶ˆæ¯
                            const existingMsg = messagesContainer.querySelector(`[data-prescription-id="${prescriptionId}"]`);
                            if (!existingMsg) {
                                // åˆ›å»ºä¸€ä¸ªæ–°çš„AIæ¶ˆæ¯æ¥æ˜¾ç¤ºå¤„æ–¹çŠ¶æ€
                                const messageHtml = `
                                        <div class="message ai" data-prescription-id="${prescriptionId}" data-prescription-status="pending_review">
                                            <div class="message-avatar">ğŸ¤–</div>
                                            <div class="message-content">
                                                <div class="message-text">
                                                    <div class="prescription-review-waiting" style="padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border-left: 4px solid #f59e0b; margin: 15px 0;">
                                                        <div style="text-align: center; margin-bottom: 15px;">
                                                            <div style="font-size: 2em; margin-bottom: 10px;">â³</div>
                                                            <h3 style="color: #92400e; margin: 0; font-size: 18px;">å¤„æ–¹ç­‰å¾…åŒ»ç”Ÿå®¡æ ¸ä¸­</h3>
                                                        </div>
                                                        
                                                        <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; margin: 10px 0;">
                                                            <p style="margin: 0; color: #78350f; font-size: 14px; line-height: 1.6;">
                                                                âœ… <strong>æ”¯ä»˜å·²å®Œæˆ</strong><br>
                                                                ğŸ” å¤„æ–¹æ­£åœ¨ç”±ä¸“ä¸šåŒ»ç”Ÿå®¡æ ¸ä¸­<br>
                                                                ğŸ“‹ å®¡æ ¸å®Œæˆåæ‚¨å°†æ”¶åˆ°é€šçŸ¥<br>
                                                                ğŸ’Š å®¡æ ¸é€šè¿‡åå³å¯é…è¯
                                                            </p>
                                                        </div>
                                                        
                                                        <div style="text-align: center; margin-top: 15px;">
                                                            <button onclick="checkPrescriptionStatus('${prescriptionId}')" 
                                                                    style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                                ğŸ” æŸ¥çœ‹å®¡æ ¸çŠ¶æ€
                                                            </button>
                                                        </div>
                                                        
                                                        <div style="font-size: 12px; color: #92400e; text-align: center; margin-top: 10px; opacity: 0.8;">
                                                            å¤„æ–¹ID: ${prescriptionId}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                `;
                                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                                console.log(`âœ… åˆ›å»ºäº†æ–°çš„ç­‰å¾…å®¡æ ¸æ¶ˆæ¯: ${prescriptionId}`);
                            } else {
                                // æ›´æ–°ç°æœ‰æ¶ˆæ¯
                                updatePrescriptionToReviewStatus(prescriptionId);
                                console.log(`âœ… æ›´æ–°äº†ç°æœ‰æ¶ˆæ¯çš„ç­‰å¾…å®¡æ ¸çŠ¶æ€: ${prescriptionId}`);
                            }
                            
                            console.log(`â³ æ¢å¤ç­‰å¾…å®¡æ ¸çŠ¶æ€: ${prescriptionId}`);
                            restoredCount++;
                        } else if (status === 'doctor_approved' || status === 'doctor_modified') {
                            // åŒ»ç”Ÿå·²å®¡æ ¸å®Œæˆï¼šæ˜¾ç¤ºæœ€ç»ˆå¤„æ–¹
                            console.log(`ğŸ“‹ å¼€å§‹æ¢å¤å·²å®¡æ ¸çŠ¶æ€: ${prescriptionId}`);
                            
                            // å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå¤„æ–¹çš„æ¶ˆæ¯
                            const existingMsg = messagesContainer.querySelector(`[data-prescription-id="${prescriptionId}"]`);
                            if (!existingMsg) {
                                // åˆ›å»ºä¸€ä¸ªæ–°çš„AIæ¶ˆæ¯æ¥æ˜¾ç¤ºå®¡æ ¸å®ŒæˆçŠ¶æ€
                                const finalPrescription = prescription.doctor_prescription || prescription.ai_prescription;
                                const messageHtml = `
                                        <div class="message ai" data-prescription-id="${prescriptionId}" data-prescription-status="approved">
                                            <div class="message-avatar">ğŸ¤–</div>
                                            <div class="message-content">
                                                <div class="message-text">
                                                    <div class="prescription-approved" style="padding: 20px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 12px; border-left: 4px solid #22c55e; margin: 15px 0;">
                                                        <div style="text-align: center; margin-bottom: 15px;">
                                                            <div style="font-size: 2em; margin-bottom: 10px;">âœ…</div>
                                                            <h3 style="color: #15803d; margin: 0; font-size: 18px;">åŒ»ç”Ÿå®¡æ ¸é€šè¿‡</h3>
                                                        </div>
                                                        
                                                        <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; margin: 15px 0;">
                                                            <div style="color: #15803d; font-size: 16px; font-weight: 600; margin-bottom: 15px;">
                                                                å®¡æ ¸é€šè¿‡çš„å¤„æ–¹ï¼š
                                                            </div>
                                                            <div style="color: #374151; line-height: 1.6; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                                                                ${finalPrescription}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style="text-align: center; margin-top: 15px;">
                                                            <div style="color: #059669; font-size: 14px; margin-bottom: 10px;">
                                                                âœ… åŒ»ç”Ÿå®¡æ ¸å·²å®Œæˆ<br>
                                                                ğŸ’Š æ‚¨å¯ä»¥å‡­æ­¤å¤„æ–¹é…è¯
                                                            </div>
                                                            ${prescription.doctor_notes ? `<div style="color: #059669; font-size: 12px; margin-top: 10px; opacity: 0.8;">åŒ»ç”Ÿå¤‡æ³¨ï¼š${prescription.doctor_notes}</div>` : ''}
                                                        </div>
                                                        
                                                        <div style="font-size: 12px; color: #059669; text-align: center; margin-top: 10px;">
                                                            å¤„æ–¹ID: ${prescriptionId} | çŠ¶æ€: ${status === 'doctor_modified' ? 'åŒ»ç”Ÿå·²è°ƒæ•´' : 'å®¡æ ¸é€šè¿‡'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                                    console.log(`âœ… åˆ›å»ºäº†æ–°çš„å®¡æ ¸å®Œæˆæ¶ˆæ¯: ${prescriptionId}`);
                                } else {
                                    // æ›´æ–°ç°æœ‰æ¶ˆæ¯ä¸ºå®¡æ ¸å®ŒæˆçŠ¶æ€
                                    await markPrescriptionAsCompleted(prescriptionId, {
                                        final_prescription: prescription.doctor_prescription || prescription.ai_prescription,
                                        doctor_notes: prescription.doctor_notes,
                                        is_reviewed: true,
                                        status: status
                                    });
                                    console.log(`âœ… æ›´æ–°äº†ç°æœ‰æ¶ˆæ¯çš„å®¡æ ¸å®ŒæˆçŠ¶æ€: ${prescriptionId}`);
                                }
                            }
                            
                            console.log(`âœ… æ¢å¤å·²å®¡æ ¸çŠ¶æ€: ${prescriptionId}`);
                            restoredCount++;
                        }
                    }
                    
                    if (restoredCount > 0) {
                        showMessage(`âœ… å·²ä»äº‘ç«¯æ¢å¤ ${restoredCount} ä¸ªå¤„æ–¹çŠ¶æ€`, 'success');
                        console.log(`âœ… æ€»å…±æ¢å¤äº† ${restoredCount} ä¸ªå¤„æ–¹çŠ¶æ€`);
                    } else {
                        console.log('ğŸ“ æ²¡æœ‰éœ€è¦æ¢å¤çš„å¤„æ–¹çŠ¶æ€');
                    }
                } else {
                    console.log('ğŸ“ ç”¨æˆ·æš‚æ— å¤„æ–¹è®°å½•');
                }
                
            } catch (error) {
                console.error('âŒ ä»æœåŠ¡å™¨æ¢å¤å¤„æ–¹çŠ¶æ€å¤±è´¥:', error);
                // ğŸ”‘ ç§»é™¤é™çº§åˆ°æœ¬åœ°çš„é€»è¾‘ï¼Œé¿å…æ··ä¹±
                // console.log('ğŸ”„ é™çº§åˆ°æœ¬åœ°æ¢å¤æ–¹å¼...');
                // restoreAllPendingPrescriptions();
            }
        }
        
        // ğŸ”‘ æ–°å¢ï¼šå¤„æ–¹çŠ¶æ€äº‘ç«¯åŒæ­¥å‡½æ•°
        async function syncPrescriptionStatusToServer(prescriptionId, status, additionalData = {}) {
            try {
                console.log(`ğŸŒ åŒæ­¥å¤„æ–¹çŠ¶æ€åˆ°æœåŠ¡å™¨: ID=${prescriptionId}, status=${status}`);
                
                // è¿™é‡Œå¯ä»¥è°ƒç”¨æœåŠ¡å™¨APIåŒæ­¥çŠ¶æ€
                // æš‚æ—¶åªåšæ—¥å¿—è®°å½•ï¼Œç¨åå®ç°å…·ä½“çš„åŒæ­¥é€»è¾‘
                console.log('ğŸ“¡ å¤„æ–¹çŠ¶æ€åŒæ­¥æ•°æ®:', { prescriptionId, status, ...additionalData });
                
                return true;
            } catch (error) {
                console.error('âŒ åŒæ­¥å¤„æ–¹çŠ¶æ€åˆ°æœåŠ¡å™¨å¤±è´¥:', error);
                return false;
            }
        }
    </script>
</body>
</html>