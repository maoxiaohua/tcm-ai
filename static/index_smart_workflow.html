<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫Ê±á‰∏≠Âåª - AIÊô∫ËÉΩÈóÆËØäÂ∑•‰ΩúÊµÅ</title>
    
    <!-- Open Graph / ÂæÆ‰ø°ÂàÜ‰∫´‰ºòÂåñ -->
    <meta property="og:title" content="üè• AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã - ‰∏ì‰∏öÁâà">
    <meta property="og:description" content="Âü∫‰∫éAIÁöÑ‰∏≠ÂåªÊô∫ËÉΩËØäÊñ≠Á≥ªÁªüÔºåÊîØÊåÅÁóáÁä∂ÈóÆËØä„ÄÅËØÅÂÄôÂàÜÊûê„ÄÅÊñπÂâÇÊé®Ëçê„ÄÇÈõÜÊàê5Â§ß‰∏≠ÂåªÊµÅÊ¥æÔºåÊèê‰æõ‰∏™ÊÄßÂåñ‰∏≠ÂåªÊ≤ªÁñóÂª∫ËÆÆ„ÄÇÈÄÇÁî®‰∫é‰∏¥Â∫äËæÖÂä©ËØäÊñ≠„ÄÇ">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="AI‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã - ‰∏ì‰∏öÂåªÁñóËØäÊñ≠Â∑•ÂÖ∑">
    <meta property="og:url" content="https://mxh0510.cn/">
    <meta property="og:site_name" content="TCM AI ‰∏≠ÂåªÊô∫ËÉΩËØäÊñ≠Á≥ªÁªü">
    
    <!-- ÂæÆ‰ø°ÂàÜ‰∫´‰∏ìÁî®Ê†áÁ≠æ -->
    <meta name="description" content="AI‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©ÊâãÔºå‰∏ì‰∏öÁöÑ‰∏≠ÂåªËØäÊñ≠ËæÖÂä©Â∑•ÂÖ∑ÔºåÊîØÊåÅÁóáÁä∂ÂàÜÊûê„ÄÅËØÅÂÄôÂà§Êñ≠„ÄÅÊñπÂâÇÊé®Ëçê">
    <meta name="keywords" content="‰∏≠Âåª,AIËØäÊñ≠,Êô∫ËÉΩÈóÆËØä,‰∏≠ËçØÊñπÂâÇ,ËØÅÂÄôÂàÜÊûê,‰º†Áªü‰∏≠Âåª,‰∫∫Â∑•Êô∫ËÉΩ">
    <meta name="author" content="TCM AI Team">
    
    <!-- ÂæÆ‰ø°Â∞èÁ®ãÂ∫èÂàÜ‰∫´Âç°Áâá‰ºòÂåñ -->
    <meta property="wx:card" content="summary_large_image">
    <meta property="wx:title" content="üè• AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã">
    <meta property="wx:description" content="‰∏ì‰∏öAI‰∏≠ÂåªËØäÊñ≠ËæÖÂä©Â∑•ÂÖ∑ÔºåÈõÜÊàê5Â§ßÊµÅÊ¥æÔºåÊèê‰æõ‰∏™ÊÄßÂåñÊ≤ªÁñóÂª∫ËÆÆ">
    <meta property="wx:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- ÂæÆ‰ø°ÂÆâÂÖ®È™åËØÅ -->
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <!-- ÂæÆ‰ø°È™åËØÅÊñá‰ª∂Ê†áËØÜ -->
    <meta name="wechat-enable" content="true">
    <meta name="applicable-device" content="mobile">
    
    <!-- Twitter Card Ê†áÁ≠æ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="üè• AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã">
    <meta name="twitter:description" content="Âü∫‰∫éAIÁöÑ‰∏≠ÂåªÊô∫ËÉΩËØäÊñ≠Á≥ªÁªüÔºå‰∏ì‰∏öÂåªÁñóËæÖÂä©Â∑•ÂÖ∑">
    <meta name="twitter:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- ÁâàÊú¨Ê†áËØÜ: v1.2.4 Êõ¥Êñ∞Êó∂Èó¥: 2025-08-03 20:20 ÂàÜ‰∫´‰ºòÂåñÁâà -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            background: #f5f7fa;
            overflow: hidden;
        }

        /* ‰∏ªÂ∏ÉÂ±ÄÂÆπÂô® */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .history-btn, .new-chat-btn, .auth-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .history-btn:hover, .new-chat-btn:hover, .auth-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .history-btn {
            background: rgba(255,255,255,0.15);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
        }


        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            justify-content: center;
            background: #f5f7fa;
        }

        /* ÂÜÖÂÆπÂÆπÂô® - Â±Ö‰∏≠ÊòæÁ§∫ */
        .content-wrapper {
            display: flex;
            width: 100%;
            max-width: 1400px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Â∑¶‰æßÊ†è */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* ÂåªÁîüÈÄâÊã©Âå∫Âüü */
        .doctor-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doctors-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .doctor-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }

        .doctor-card:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .doctor-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .doctor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .doctor-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .doctor-details h3 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }

        .doctor-school {
            font-size: 12px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 8px;
            border-radius: 8px;
        }

        .selection-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .doctor-card.selected .selection-indicator {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .doctor-specialty {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* Â∑•ÂÖ∑Âå∫Âüü */
        .tools-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .tool-group {
            margin-bottom: 20px;
        }

        .tool-group:last-child {
            margin-bottom: 0;
        }

        .tool-title {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* Â§öÂõæÁâá‰∏ä‰º†Ê†∑Âºè */
        .upload-section {
            margin-bottom: 15px;
        }

        .upload-subtitle {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .upload-status {
            margin-top: 15px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 13px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        /* ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó - ÂæÆ‰ø°ÂÖºÂÆπ‰øÆÂ§ç */
        .mobile-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999999;  /* ÊèêÈ´òz-indexÂ±ÇÁ∫ßÔºåÁ°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .mobile-modal-hidden {
            display: none !important;
        }
        
        .mobile-modal-visible {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .mobile-image-modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 350px;
            min-width: 280px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            position: relative;
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-options {
            padding: 20px;
        }

        .image-option-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .image-option-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .image-option-btn:last-child {
            margin-bottom: 0;
        }

        .option-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .option-text {
            text-align: left;
        }

        .option-text strong {
            display: block;
            margin-bottom: 4px;
            color: #111827;
        }

        .option-text span {
            color: #6b7280;
            font-size: 13px;
        }

        .upload-status-mobile {
            padding: 15px 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .mobile-status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .mobile-status-item:last-child {
            margin-bottom: 0;
        }

        /* ÂæÆ‰ø°ÊµèËßàÂô®ÁâπÊÆäÈÄÇÈÖç */
        @media screen and (max-width: 480px) {
            .mobile-image-modal {
                padding: 15px;
            }
            
            .mobile-image-modal-content {
                max-width: calc(100vw - 30px);
                min-width: 260px;
            }
            
            .modal-header {
                padding: 15px 15px 10px 15px;
            }
            
            .modal-header h3 {
                font-size: 16px;
            }
            
            .modal-options {
                padding: 15px;
            }
            
            .image-option-btn {
                padding: 12px;
            }
        }

        /* ÊûÅÂ∞èÂ±èÂπïÈÄÇÈÖç */
        @media screen and (max-width: 360px) {
            .mobile-image-modal-content {
                max-width: calc(100vw - 20px);
                border-radius: 8px;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-options {
                padding: 12px;
            }
        }

        .upload-text {
            font-size: 13px;
            color: #6b7280;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-btn {
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .voice-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .voice-btn.recording {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .auto-speak {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }

        /* Âè≥‰æßÂØπËØùÂå∫Âüü */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* ÂΩìÂâçÂåªÁîü‰ø°ÊÅØÊù° */
        .current-doctor-bar {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .current-doctor-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .current-doctor-info h2 {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .current-doctor-desc {
            font-size: 14px;
            color: #6b7280;
        }

        /* ÂØπËØùÊ∂àÊÅØÂå∫Âüü */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fafafa;
        }

        .message {
            display: flex;
            margin-bottom: 24px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 12px;
        }

        .user .message-avatar {
            background: #10b981;
            color: white;
        }

        .ai .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .user .message-content {
            background: #10b981;
            color: white;
        }

        .message-content::before {
            content: '';
            position: absolute;
            top: 20px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .ai .message-content::before {
            left: -16px;
            border-right-color: white;
        }

        .user .message-content::before {
            right: -16px;
            border-left-color: #10b981;
        }

        .message-text {
            line-height: 1.6;
            font-size: 14px;
            word-wrap: break-word;
            white-space: normal;
        }
        .message-text h3, .message-text h4 {
            margin: 12px 0 8px 0;
            line-height: 1.4;
        }
        .message-text strong {
            font-weight: 600;
        }
        .message-text hr {
            margin: 12px 0;
            border: none;
            border-top: 1px solid #e5e7eb;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
        }

        /* ÂèçÈ¶àÊåâÈíÆ */
        .feedback-controls {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .feedback-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .rating-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .rating-btn {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            border-top: 1px solid #e5e7eb;
            padding: 20px 24px;
            background: white;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 12px 16px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #5a67d8;
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ÈªòËÆ§ÈöêËóèÁßªÂä®Á´ØÂÆπÂô® */
        .mobile-page-container {
            display: none;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1440px) {
            .content-wrapper {
                max-width: 95%;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                position: relative;
                overflow: hidden;
            }
            
            /* ÁßªÂä®Á´ØÈ°µÈù¢ÂÆπÂô® */
            .mobile-page-container {
                display: flex !important; /* Ë¶ÜÁõñÈªòËÆ§ÁöÑÈöêËóè */
                position: relative;
                width: 200%;
                height: 100vh;
                min-height: 100vh;
                transition: transform 0.3s ease-in-out;
                overflow: hidden;
            }
            
            .mobile-page-container.show-chat {
                transform: translateX(-50%);
            }
            
            /* ÂåªÁîüÈÄâÊã©È°µÈù¢ */
            .mobile-doctor-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .mobile-doctor-header {
                padding: 20px;
                text-align: center;
                color: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }

            .mobile-header-content {
                flex: 1;
            }
            
            .mobile-doctor-header h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .mobile-doctor-header p {
                font-size: 0.9rem;
                opacity: 0.9;
            }

            .mobile-header-actions {
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            }

            .mobile-action-btn {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                font-weight: 500;
                min-width: 60px;
            }

            .mobile-action-btn:hover,
            .mobile-action-btn:active {
                background: rgba(255,255,255,0.25);
                transform: translateY(-1px);
            }

            .mobile-chat-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .mobile-action-btn-small {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px;
                border-radius: 12px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .mobile-action-btn-small:hover,
            .mobile-action-btn-small:active {
                background: rgba(255,255,255,0.25);
                transform: scale(1.05);
            }
            
            .mobile-doctors-container {
                flex: 1;
                background: white;
                border-radius: 20px 20px 0 0;
                padding: 24px 16px 120px 16px; /* Â¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ùÈÅøÂÖçË¢´ÈÅÆÊå° */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOSÂπ≥ÊªëÊªöÂä® */
            }
            
            .mobile-doctors-title {
                text-align: center;
                font-size: 1.2rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 20px;
            }
            
            .mobile-doctors-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .mobile-doctor-card {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .mobile-doctor-card:hover,
            .mobile-doctor-card:active {
                border-color: #3b82f6;
                background: #eff6ff;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .mobile-doctor-info {
                display: flex;
                align-items: center;
                margin-bottom: 12px;
            }
            
            .mobile-doctor-avatar {
                font-size: 2.5rem;
                margin-right: 16px;
            }
            
            .mobile-doctor-details h3 {
                font-size: 1.1rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 4px;
            }
            
            .mobile-doctor-details .school {
                font-size: 0.85rem;
                color: #6b7280;
            }
            
            .mobile-doctor-specialty {
                font-size: 0.9rem;
                color: #4b5563;
                line-height: 1.4;
            }
            
            .mobile-doctor-specialty strong {
                color: #374151;
            }
            
            /* ËÅäÂ§©È°µÈù¢ */
            .mobile-chat-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: white;
            }
            
            .mobile-chat-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                flex-shrink: 0;
            }
            
            .mobile-back-btn {
                background: none;
                border: none;
                color: white;
                font-size: 1.2rem;
                padding: 8px;
                margin-right: 12px;
                cursor: pointer;
                border-radius: 50%;
                transition: background 0.2s;
            }
            
            .mobile-back-btn:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .mobile-current-doctor {
                flex: 1;
                display: flex;
                align-items: center;
            }
            
            .mobile-current-doctor .avatar {
                font-size: 1.5rem;
                margin-right: 12px;
            }
            
            .mobile-current-doctor .info h2 {
                font-size: 1rem;
                margin-bottom: 2px;
            }
            
            .mobile-current-doctor .info p {
                font-size: 0.8rem;
                opacity: 0.9;
            }
            
            .mobile-messages-container {
                flex: 1;
                padding: 16px;
                overflow-y: auto;
                background: #f9fafb;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-input-container {
                padding: 12px 16px;
                background: white;
                border-top: 1px solid #e5e7eb;
                flex-shrink: 0;
            }

            .mobile-input-helper {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
                padding: 0 4px;
                flex-wrap: wrap;
            }

            .mobile-guidance-trigger {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }

            .mobile-guidance-trigger:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            }

            .mobile-upload-trigger {
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .mobile-upload-trigger:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            }

            .mobile-upload-trigger.has-file {
                background: linear-gradient(135deg, #28a745, #20c997);
            }

            .mobile-helper-text {
                font-size: 11px;
                color: #6b7280;
                flex: 1;
                min-width: 100px;
            }
            
            .mobile-input-wrapper {
                display: flex;
                gap: 8px;
                align-items: flex-end;
            }
            
            .mobile-input-wrapper textarea {
                flex: 1;
                border: 1px solid #d1d5db;
                border-radius: 20px;
                padding: 12px 16px;
                font-size: 16px;
                resize: none;
                max-height: 100px;
                min-height: 44px;
                -webkit-appearance: none;
                -webkit-border-radius: 20px;
            }
            
            .mobile-send-btn {
                width: 44px;
                height: 44px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 1.2rem;
                cursor: pointer;
                transition: background 0.2s;
                flex-shrink: 0;
            }
            
            .mobile-send-btn:hover {
                background: #2563eb;
            }
            
            .mobile-send-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }
            
            /* PCÁ´ØÂÖÉÁ¥†Ê≠£Â∏∏ÊòæÁ§∫ - ÁßªÈô§‰∫ÜÈöêËóèËßÑÂàô */
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            
            .header-title h1 {
                font-size: 1.1rem;
            }
            
            .header-subtitle {
                font-size: 0.7rem;
            }
            
            .messages-container {
                padding: 8px;
            }
            
            .message-content {
                max-width: 95%;
                font-size: 0.85rem;
                padding: 10px 12px;
            }
            
            .input-container {
                padding: 8px;
            }
            
            .new-chat-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .sidebar {
                max-height: 120px !important;
            }
            
            .doctor-section {
                padding: 6px 8px !important;
            }
            
            .doctor-card {
                min-width: 100px !important;
                padding: 6px 8px !important;
            }
        }
        
        @media (max-width: 320px) {
            .header-title h1 {
                font-size: 1.0rem;
            }
            
            .message-content {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .input-wrapper input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .sidebar {
                max-height: 100px !important;
            }
            
            .doctor-section {
                padding: 4px 6px !important;
            }
            
            .doctor-section .section-title {
                font-size: 0.8rem !important;
                margin-bottom: 4px !important;
            }
            
            .doctor-card {
                min-width: 90px !important;
                padding: 4px 6px !important;
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-name {
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-desc {
                font-size: 0.6rem !important;
            }
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .messages-container::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .messages-container::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* ÈóÆËØäÊåáÂØºÊ†∑Âºè */
        .input-helper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .guidance-trigger {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 10px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .guidance-trigger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .helper-text {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }

        .guidance-tips {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            animation: fadeInScale 0.3s ease-out;
        }

        .tips-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tips-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        /* ÁôªÂΩïÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .login-modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }

        .login-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .login-form {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .login-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .login-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .login-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .login-btn.secondary:hover {
            background: #e5e7eb;
        }

        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tips-content {
            padding: 20px;
        }

        .tip-section {
            margin-bottom: 20px;
        }

        .tip-section h5 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .tip-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .tip-section li {
            margin-bottom: 5px;
            color: #666;
            line-height: 1.4;
        }

        .tip-footer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tip-footer p {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .guidance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            .guidance-tips {
                max-width: 95vw;
                max-height: 80vh;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
                border-radius: 16px;
                padding: 0;
            }
            
            .tips-header {
                padding: 16px 20px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .tips-header h4 {
                font-size: 18px;
                margin: 0;
            }
            
            .tips-content {
                padding: 16px 20px;
                max-height: calc(80vh - 80px);
                overflow-y: auto;
            }
            
            .tip-section {
                margin-bottom: 16px;
            }
            
            .tip-section h5 {
                font-size: 15px;
                margin-bottom: 8px;
                color: #374151;
            }
            
            .tip-section ul {
                padding-left: 16px;
                margin: 0;
            }
            
            .tip-section li {
                font-size: 14px;
                line-height: 1.5;
                margin-bottom: 4px;
                color: #4b5563;
            }
            
            .close-btn {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }
            
            .input-helper {
                display: flex !important;
                padding: 0 12px;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 12px;
            }
            
            .guidance-trigger {
                font-size: 14px !important;
                padding: 8px 12px !important;
                border-radius: 6px !important;
                min-height: 36px;
            }
            
            .helper-text {
                font-size: 11px;
                line-height: 1.3;
                flex: 1;
                min-width: 100%;
                margin-top: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ÁßªÂä®Á´ØÈ°µÈù¢ÂÆπÂô® -->
        <div class="mobile-page-container" id="mobilePageContainer">
            <!-- ÂåªÁîüÈÄâÊã©È°µÈù¢ -->
            <div class="mobile-doctor-page">
                <div class="mobile-doctor-header">
                    <div class="mobile-header-content">
                        <h1>AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØä</h1>
                        <p>‰º†Áªü‰∏≠Âåª √ó ‰∫∫Â∑•Êô∫ËÉΩ</p>
                    </div>
                    <div class="mobile-header-actions">
                        <button class="mobile-action-btn" onclick="showMobileNavigation()" title="È°µÈù¢ÂØºËà™">
                            üîó ÂØºËà™
                        </button>
                        <button class="mobile-action-btn" onclick="openRegisterPage()" title="Ê≥®ÂÜåË¥¶Êà∑">
                            üë§ Ê≥®ÂÜå
                        </button>
                        <button class="mobile-action-btn" onclick="openHistoryPage()" title="Êü•ÁúãÂéÜÂè≤">
                            üìã ÂéÜÂè≤
                        </button>
                    </div>
                </div>
                <div class="mobile-doctors-container">
                    <h2 class="mobile-doctors-title">üë®‚Äç‚öïÔ∏è ‰∏≠ÂåªÂ∏àÂõ¢Èòü</h2>
                    <div class="mobile-doctors-grid" id="mobileDoctorsGrid">
                        <!-- ÂåªÁîüÂç°ÁâáÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
            
            <!-- ËÅäÂ§©È°µÈù¢ -->
            <div class="mobile-chat-page">
                <div class="mobile-chat-header">
                    <button class="mobile-back-btn" onclick="showMobileDoctorPage()">‚Üê</button>
                    <div class="mobile-current-doctor">
                        <div class="avatar" id="mobileDoctorAvatar">ü§ñ</div>
                        <div class="info">
                            <h2 id="mobileDoctorName">ÂåªÂ∏àÂßìÂêç</h2>
                            <p id="mobileDoctorDesc">ÂåªÂ∏àÊèèËø∞</p>
                        </div>
                    </div>
                    <div class="mobile-chat-actions">
                        <button class="mobile-action-btn-small" onclick="openRegisterPage()" title="Ê≥®ÂÜå">
                            üë§
                        </button>
                        <button class="mobile-action-btn-small" onclick="openHistoryPage()" title="ÂéÜÂè≤">
                            üìã
                        </button>
                        <button class="mobile-action-btn-small" onclick="startNewChat()" title="Êñ∞ÂØπËØù">
                            ‚ú®
                        </button>
                    </div>
                </div>
                <div class="mobile-messages-container" id="mobileMessagesContainer">
                    <!-- Ê∂àÊÅØÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>
                <div class="mobile-input-container">
                    <div class="mobile-input-helper">
                        <button onclick="showGuidance()" class="mobile-guidance-trigger">üí° ÈóÆËØäÊåáÂØº</button>
                        <button onclick="showMobileImageOptions()" class="mobile-upload-trigger" id="mobileUploadTrigger">
                            üì∑ <span id="mobileUploadText">‰∏ä‰º†ËàåËãîÂíåÈù¢Ë±°ÁÖßÁâá</span>
                        </button>
                        <span class="mobile-helper-text">‰∏çÁü•ÈÅìÊÄé‰πàÊèèËø∞ÁóáÁä∂Ôºü</span>
                    </div>
                    <!-- ÁßªÂä®Á´ØÂ§öÂõæÁâá‰∏ä‰º† -->
                    <input type="file" id="mobileTongueUpload" accept="image/*" style="display: none;" onchange="handleMobileTongueUpload(event)">
                    <input type="file" id="mobileFaceUpload" accept="image/*" style="display: none;" onchange="handleMobileFaceUpload(event)">
                    
                    <!-- ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™óÂ∑≤ÁßªÂä®Âà∞bodyÂ∫ïÈÉ® -->
                    <div class="mobile-input-wrapper">
                        <textarea 
                            id="mobileMessageInput" 
                            placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÊàñÈóÆÈ¢ò..."
                            rows="1"
                            onkeydown="handleMobileKeyPress(event)"
                            oninput="adjustMobileTextareaHeight()"
                            onfocus="ensureMobileInputVisible()"
                            ontouchstart="ensureMobileInputVisible()"
                        ></textarea>
                        <button class="mobile-send-btn" id="mobileSendBtn" onclick="sendMobileMessage()">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ê°åÈù¢Á´ØÔºöÈ°∂ÈÉ®ÂØºËà™Ê†è -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>AI ‰∏≠ÂåªÊô∫ËÉΩÈóÆËØä</h1>
                    <p class="header-subtitle">‰º†Áªü‰∏≠Âåª √ó ‰∫∫Â∑•Êô∫ËÉΩ - ‰∏ì‰∏öÁâà</p>
                </div>
                <div class="header-actions">
                    <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅ -->
                    <div id="authButtons" style="display: flex; gap: 12px;">
                        <button class="auth-btn" onclick="showLoginModal()" title="Áî®Êà∑ÁôªÂΩï">
                            üîê ÁôªÂΩï
                        </button>
                        <button class="history-btn" onclick="openRegisterPage()" title="Ê≥®ÂÜåË¥¶Êà∑">
                            üë§ Ê≥®ÂÜå
                        </button>
                    </div>
                    
                    <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅ -->
                    <div id="userInfo" class="user-info" style="display: none;">
                        <div class="user-avatar" id="userAvatar">üë§</div>
                        <span class="user-name" id="userName">Ê∏∏ÂÆ¢</span>
                        <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                    </div>
                    
                    <button class="history-btn" onclick="openHistoryPage()" title="Êü•ÁúãÈóÆËØäÂéÜÂè≤" id="historyBtn">
                        üìã ÂéÜÂè≤ËÆ∞ÂΩï
                    </button>
                    <button class="new-chat-btn" onclick="startNewChat()">
                        ‚ú® Êñ∞ÂØπËØù
                    </button>
                </div>
            </div>
        </header>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <div class="main-content">
            <div class="content-wrapper">
                <!-- Â∑¶‰æßÊ†è -->
                <aside class="sidebar">
                <!-- ÂåªÁîüÈÄâÊã©Âå∫Âüü -->
                <div class="doctor-section">
                    <h3 class="section-title">üë®‚Äç‚öïÔ∏è ÈÄâÊã©ÂåªÂ∏à</h3>
                    <div class="doctors-grid" id="doctorsGrid">
                        <!-- ÂåªÁîüÂç°ÁâáÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>

                <!-- Â∑•ÂÖ∑Âå∫Âüü -->
                <div class="tools-section">
                    <!-- Â§öÂõæÁâá‰∏ä‰º† - ËàåËØä + Èù¢ËØä -->
                    <div class="tool-group">
                        <h4 class="tool-title">üì∏ ÂõæÂÉèËØäÊñ≠</h4>
                        
                        <!-- ËàåËØäÂõæÁâá‰∏ä‰º† -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">üëÖ ËàåËØäÂõæÁâá</h5>
                            <div class="upload-area" id="tongueUploadArea" onclick="triggerTongueUpload()">
                                <div class="upload-icon">üì∑</div>
                                <div class="upload-text">ÁÇπÂáª‰∏ä‰º†ËàåËØäÁÖßÁâá</div>
                            </div>
                            <input type="file" id="tongueImageUpload" accept="image/*" style="display: none;" onchange="handleTongueImageUpload(event)">
                        </div>
                        
                        <!-- Èù¢ËØäÂõæÁâá‰∏ä‰º† -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">üòä Èù¢ËØäÂõæÁâá</h5>
                            <div class="upload-area" id="faceUploadArea" onclick="triggerFaceUpload()">
                                <div class="upload-icon">üì∑</div>
                                <div class="upload-text">ÁÇπÂáª‰∏ä‰º†Èù¢ËØäÁÖßÁâá</div>
                            </div>
                            <input type="file" id="faceImageUpload" accept="image/*" style="display: none;" onchange="handleFaceImageUpload(event)">
                        </div>
                        
                        <!-- ‰∏ä‰º†Áä∂ÊÄÅ -->
                        <div class="upload-status" id="uploadStatus" style="display: none;">
                            <div class="status-item" id="tongueStatus">üëÖ ËàåËØä: <span>Êú™‰∏ä‰º†</span></div>
                            <div class="status-item" id="faceStatus">üòä Èù¢ËØä: <span>Êú™‰∏ä‰º†</span></div>
                        </div>
                    </div>

                    <!-- ËØ≠Èü≥ÂäüËÉΩ -->
                    <div class="tool-group">
                        <h4 class="tool-title">üé§ ËØ≠Èü≥ÂäüËÉΩ</h4>
                        <div class="voice-controls">
                            <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">
                                ÂºÄÂßãËØ≠Èü≥ËæìÂÖ•
                            </button>
                            <label class="auto-speak">
                                <input type="checkbox" id="autoSpeak">
                                <span>Ëá™Âä®ÊúóËØªÂõûÂ§ç</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Âè≥‰æßÂØπËØùÂå∫Âüü -->
            <main class="chat-area">
                <!-- ÂΩìÂâçÂåªÁîü‰ø°ÊÅØÊù° -->
                <div class="current-doctor-bar" id="currentDoctorBar">
                    <div class="current-doctor-avatar" id="currentDoctorAvatar">ü§ñ</div>
                    <div class="current-doctor-info">
                        <h2 id="currentDoctorName">ËØ∑ÈÄâÊã©ÂåªÂ∏à</h2>
                        <p class="current-doctor-desc" id="currentDoctorDesc">ÂΩìÂâçÂåªÂ∏àÔºöÂº†‰ª≤ÊôØ</p>
                    </div>
                </div>

                <!-- ÂØπËØùÊ∂àÊÅØÂå∫Âüü -->
                <div class="messages-container" id="messagesContainer">
                    <!-- ÈªòËÆ§ÂåªÁîüÂ∑≤ÈÄâ‰∏≠Ôºå‰∏çÈúÄË¶ÅÈÄâÊã©ÊèêÁ§∫ -->
                </div>

                <!-- Âä†ËΩΩÂä®Áîª -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <div>AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...</div>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="input-area">
                    <div class="input-helper">
                        <button onclick="showGuidance()" class="guidance-trigger">üí° ÈóÆËØäÊåáÂØº</button>
                        <span class="helper-text">‰∏çÁü•ÈÅìÊÄé‰πàÊèèËø∞ÁóáÁä∂ÔºüÁÇπÂáªÊü•ÁúãÈóÆËØäÊåáÂØº</span>
                    </div>
                    <div class="input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÊàñÈóÆÈ¢ò..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                            oninput="adjustTextareaHeight()"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            ‚Üí
                        </button>
                    </div>
                </div>
            </main>
            </div> <!-- end content-wrapper -->
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentConversationId = '';
        let selectedDoctor = 'zhang_zhongjing'; // ÈªòËÆ§Âº†‰ª≤ÊôØ
        let isVoiceRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        
        // ËÆ§ËØÅÁõ∏ÂÖ≥ÂèòÈáè
        let currentUser = null;
        let userToken = null;

        // ÂåªÁîüÊï∞ÊçÆ
        const doctors = {
            "zhang_zhongjing": {
                "name": "Âº†‰ª≤ÊôØ",
                "school": "‰º§ÂØíÊ¥æ", 
                "avatar": "üéØ",
                "specialty": "Â§ñÊÑüÁóÖ„ÄÅÂÜÖ‰º§ÊùÇÁóÖ„ÄÅÊÄ•Áóá",
                "introduction": "‰º§ÂØíÊ¥æ‰ª•„Ää‰º§ÂØíËÆ∫„Äã‰∏∫ÁêÜËÆ∫Âü∫Á°ÄÔºåÊìÖÈïøÂÖ≠ÁªèËæ®ËØÅÔºåÊ≤ªÁñóÂ§ñÊÑüÁÉ≠ÁóÖÂíåÂÜÖ‰º§ÊùÇÁóÖ„ÄÇÁî®ËçØÁ≤æÂáÜÔºåÊñπËØÅÂØπÂ∫î„ÄÇ"
            },
            "ye_tianshi": {
                "name": "Âè∂Â§©Â£´", 
                "school": "Ê∏©ÁóÖÊ¥æ",
                "avatar": "üå°Ô∏è",
                "specialty": "Ê∏©ÁóÖ„ÄÅÁÉ≠ÁóÖ„ÄÅÂÑøÁßë„ÄÅÂ¶áÁßë",
                "introduction": "Ê∏©ÁóÖÊ¥æ‰∏ìÊ≤ªÂêÑÁßçÁÉ≠ÊÄßÁñæÁóÖÔºå‰ª•Âç´Ê∞îËê•Ë°ÄËæ®ËØÅ‰∏∫ÁâπËâ≤ÔºåÁî®ËçØËΩªÊ∏ÖÁÅµÂä®„ÄÇ"
            },
            "li_dongyuan": {
                "name": "Êùé‰∏úÂû£",
                "school": "Ë°•ÂúüÊ¥æ", 
                "avatar": "üå±",
                "specialty": "ËÑæËÉÉÁóÖ„ÄÅÂÜÖ‰º§ÂèëÁÉ≠„ÄÅÊ∂àÂåñÁ≥ªÁªüÁñæÁóÖ",
                "introduction": "Ë°•ÂúüÊ¥æ‰ª•Ë∞ÉÁêÜËÑæËÉÉ‰∏∫Ê†∏ÂøÉÔºåÊìÖÈïøÊ≤ªÁñóÊ∂àÂåñÁ≥ªÁªüÁñæÁóÖÂíåÂÜÖ‰º§ÂèëÁÉ≠„ÄÇ"
            },
            "zhu_danxi": {
                "name": "Êú±‰∏πÊ∫™",
                "school": "ÊªãÈò¥Ê¥æ",
                "avatar": "üíß", 
                "specialty": "Èò¥ËôöÁÅ´Êó∫„ÄÅÂ¶áÁßëÊùÇÁóá„ÄÅÂÜÖÁßëË∞ÉÂÖª",
                "introduction": "ÊªãÈò¥Ê¥æÈáçËßÜÂÖªÈò¥Ê∏ÖÁÉ≠ÔºåÊìÖÈïøÊ≤ªÁñóÈò¥ËôöÁÅ´Êó∫ÂíåÂêÑÁßçÂÜÖÁßëË∞ÉÂÖªÔºåÁî®ËçØÂπ≥ÂíåÊúâÊïà„ÄÇ"
            },
            "liu_duzhou": {
                "name": "ÂàòÊ∏°Ëàü",
                "school": "ÁªèÊñπÊ¥æ",
                "avatar": "üìö", 
                "specialty": "ÁªèÊñπÂ∫îÁî®„ÄÅÁñëÈöæÊùÇÁóá„ÄÅÊÖ¢ÊÄßÁóÖ",
                "introduction": "ÁªèÊñπÊ¥æ‰∏•Ê†ºÊåâÁÖßÂè§‰ª£ÁªèÂÖ∏ÊñπÂâÇÊ≤ªÁñóÔºåÁâπÂà´ÊìÖÈïøÁñëÈöæÊùÇÁóáÂíåÊÖ¢ÊÄßÁñæÁóÖ„ÄÇ"
            },
            "zheng_qin_an": {
                "name": "ÈÉëÈí¶ÂÆâ",
                "school": "Êâ∂Èò≥Ê¥æ",
                "avatar": "‚òÄÔ∏è",
                "specialty": "Èò≥ËôöËØÅ„ÄÅÊÄ•Âç±ÈáçÁóá„ÄÅÁñëÈöæÊùÇÁóá", 
                "introduction": "Êâ∂Èò≥Ê¥æÈáçËßÜÈò≥Ê∞îÔºåÊìÖÈïøÊ≤ªÁñóÂêÑÁßçÈò≥ËôöÁóáÁä∂ÂíåÊÄ•Âç±ÈáçÁóá„ÄÇ"
            }
        };

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            renderDoctorCards();
            loadConversationHistory(); // Ëøô‰∏™ÂáΩÊï∞ÂÜÖÈÉ®‰ºöË∞ÉÁî®generateConversationIdÂ¶ÇÊûúÈúÄË¶Å
            
            // ËÆæÁΩÆÈªòËÆ§ÂåªÁîü - Âº†‰ª≤ÊôØÔºàÊúÄÂÖ®Èù¢ÁöÑÂåªÂ∏àÔºâ
            setDefaultDoctor('zhang_zhongjing');
            
            // Ê∑ªÂä†Ë∞ÉËØïÂäüËÉΩÔºà‰ªÖÂú®ÂºÄÂèëÁéØÂ¢ÉÊàñÁâπÂÆöÊù°‰ª∂‰∏ãÔºâ
            if (isDebugMode()) {
                console.log('üîß Ë∞ÉËØïÊ®°ÂºèÂ∑≤ÂêØÁî®');
                console.log('üìã ÂèØÁî®Ë∞ÉËØïÂëΩ‰ª§:');
                console.log('  - diagnoseHistoryIssues(): ËØäÊñ≠ÂéÜÂè≤ËÆ∞ÂΩïÈóÆÈ¢ò');
                console.log('  - checkLocalStorageUsage(): Ê£ÄÊü•Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ');
                console.log('  - cleanOldHistoryRecords(): Ê∏ÖÁêÜÊóßÁöÑÂéÜÂè≤ËÆ∞ÂΩï');
                
                // Â∞ÜË∞ÉËØïÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä
                window.diagnoseHistoryIssues = diagnoseHistoryIssues;
                window.checkLocalStorageUsage = checkLocalStorageUsage;
                window.cleanOldHistoryRecords = cleanOldHistoryRecords;
                
                // È°µÈù¢Âä†ËΩΩÂêéËá™Âä®ËøêË°å‰∏ÄÊ¨°ËØäÊñ≠
                setTimeout(() => {
                    console.log('\nüîç Ëá™Âä®ÂéÜÂè≤ËÆ∞ÂΩïËØäÊñ≠:');
                    diagnoseHistoryIssues();
                }, 1000);
            }
        }
        
        // ËÆæÁΩÆÈªòËÆ§ÂåªÁîüÔºà‰∏ç‰ºöÊúâÁ°ÆËÆ§ÊèêÁ§∫Ôºâ
        function setDefaultDoctor(doctorKey) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // Êõ¥Êñ∞UIÊòæÁ§∫
            const cards = document.querySelectorAll('.doctor-card');
            cards.forEach((card, index) => {
                if (Object.keys(doctors)[index] === doctorKey) {
                    card.classList.add('selected');
                }
            });
            
            // Êõ¥Êñ∞È°∂ÈÉ®ÂåªÁîü‰ø°ÊÅØÊù°
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `ÊìÖÈïøÔºö${doctor.specialty}`;
            
            // Âä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï
            loadDoctorHistory(doctorKey);
        }

        // ÁîüÊàêÂØπËØùID - Âü∫‰∫éÁî®Êà∑IDÈöîÁ¶ª
        function generateConversationId() {
            const userId = getCurrentUserId();
            
            currentConversationId = 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            
            // ‰ΩøÁî®Áî®Êà∑ID‰Ωú‰∏∫Â≠òÂÇ®keyÔºåÁ°Æ‰øù‰∏çÂêåÁî®Êà∑ÈöîÁ¶ª
            const storageKey = `conversationId_${userId}`;
            localStorage.setItem(storageKey, currentConversationId);
        }
        
        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ID
        function getCurrentUserId() {
            // Â∞ùËØï‰ªéÂ§ö‰∏™Êù•Ê∫êËé∑ÂèñÁî®Êà∑ID
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.id || currentUser.user_id) {
                return currentUser.id || currentUser.user_id;
            }
            
            // Êô∫ËÉΩÂ∑•‰ΩúÊµÅÁ®ãÈ°µÈù¢ÁöÑÁî®Êà∑
            const smartUser = localStorage.getItem('currentUserId');
            if (smartUser) {
                return smartUser;
            }
            
            // Ê∏∏ÂÆ¢Áî®Êà∑ - ÁîüÊàêÂîØ‰∏ÄÊ†áËØÜ
            const guestId = localStorage.getItem('guestUserId');
            if (guestId) {
                return guestId;
            }
            
            // ÁîüÊàêÊñ∞ÁöÑÊ∏∏ÂÆ¢ID
            const newGuestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('guestUserId', newGuestId);
            return newGuestId;
        }

        // ÂÖ®Â±ÄÂèòÈáèÔºöÊé®ËçêÂåªÁîüÂàóË°®
        let recommendedDoctors = [];
        let isUsingRecommendedDoctors = false;

        // Ëé∑ÂèñAIÊé®ËçêÂåªÁîü
        async function getRecommendedDoctors(symptoms) {
            try {
                const response = await fetch('/api/doctor-matching/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: currentConversationId || 'anonymous-' + Date.now(),
                        symptoms: symptoms,
                        max_results: 6
                    })
                });

                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñÊé®ËçêÂåªÁîüÂ§±Ë¥•');
                }

                const result = await response.json();
                if (result.success && result.data.recommended_doctors) {
                    return result.data.recommended_doctors;
                }
                return [];
            } catch (error) {
                console.error('Ëé∑ÂèñÊé®ËçêÂåªÁîüÈîôËØØ:', error);
                return [];
            }
        }

        // Ê∏≤ÊüìÂåªÁîüÂç°ÁâáÔºàÊîØÊåÅÈªòËÆ§ÂåªÁîüÂíåÊé®ËçêÂåªÁîüÔºâ
        function renderDoctorCards(useRecommended = false) {
            const container = document.getElementById('doctorsGrid');
            container.innerHTML = '';
            
            let doctorsToRender = {};
            
            if (useRecommended && recommendedDoctors.length > 0) {
                // ‰ΩøÁî®Êé®ËçêÂåªÁîüÔºå‰ΩÜ‰øùÊåÅÂéüÊúâÁöÑÊ†ºÂºè
                recommendedDoctors.forEach(doctor => {
                    // Â∞ÜAPIËøîÂõûÁöÑÂåªÁîüËΩ¨Êç¢‰∏∫ÂéüÊúâÊ†ºÂºè
                    const doctorId = doctor.uuid || doctor.name.toLowerCase().replace(/\s+/g, '_');
                    doctorsToRender[doctorId] = {
                        name: doctor.name,
                        school: doctor.title || '‰∏≠ÂåªÂ∏à',
                        avatar: getAvatarForDoctor(doctor.name),
                        specialty: doctor.specialties.join(', ') || '‰∏≠ÂåªÂÜÖÁßë',
                        introduction: doctor.introduction || '',
                        rating: doctor.average_rating,
                        consultationCount: doctor.consultation_count
                    };
                });
                isUsingRecommendedDoctors = true;
            } else {
                // ‰ΩøÁî®ÈªòËÆ§ÂåªÁîü
                doctorsToRender = doctors;
                isUsingRecommendedDoctors = false;
            }

            Object.entries(doctorsToRender).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'doctor-card';
                card.onclick = () => selectDoctor(key, doctor);
                
                // Ê∑ªÂä†Êé®ËçêÊ†áËØÜÂíåËØÑÂàÜ‰ø°ÊÅØ
                const recommendationBadge = isUsingRecommendedDoctors ? 
                    `<div style="background: #10b981; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 4px;">AIÊé®Ëçê</div>` : '';
                
                const ratingInfo = doctor.rating ? 
                    `<div style="font-size: 11px; color: #f59e0b; margin-top: 2px;">‚≠ê ${doctor.rating.toFixed(1)} (${doctor.consultationCount || 0}‰æã)</div>` : '';
                
                card.innerHTML = `
                    <div class="doctor-header">
                        <div class="doctor-info">
                            <div class="doctor-avatar">${doctor.avatar}</div>
                            <div class="doctor-details">
                                <h3>${doctor.name} ${recommendationBadge}</h3>
                                <span class="doctor-school">${doctor.school}</span>
                                ${ratingInfo}
                            </div>
                        </div>
                        <div class="selection-indicator">
                            <span style="font-size: 12px;">‚úì</span>
                        </div>
                    </div>
                    <div class="doctor-specialty">
                        <strong>ÊìÖÈïøÔºö</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Ê∑ªÂä†ÂàáÊç¢ÊåâÈíÆ
            addDoctorToggleButton(container);
        }

        // ‰∏∫ÂåªÁîüÂàÜÈÖçÂ§¥ÂÉè
        function getAvatarForDoctor(doctorName) {
            const avatarMap = {
                'Âº†‰ª≤ÊôØ': 'üéØ',
                'Âè∂Â§©Â£´': 'üå°Ô∏è', 
                'Êùé‰∏úÂû£': 'üå±',
                'ÈÉëÈí¶ÂÆâ': 'üî•',
                'ÂàòÊ∏°Ëàü': '‚öñÔ∏è'
            };
            return avatarMap[doctorName] || 'üë®‚Äç‚öïÔ∏è';
        }

        // Ê∑ªÂä†ÂåªÁîüÂàáÊç¢ÊåâÈíÆ
        function addDoctorToggleButton(container) {
            const toggleButton = document.createElement('div');
            toggleButton.style.cssText = `
                margin-top: 10px; 
                text-align: center; 
                padding: 8px;
                background: #f3f4f6; 
                border-radius: 8px; 
                cursor: pointer;
                font-size: 12px;
                color: #374151;
                transition: all 0.2s;
            `;
            toggleButton.innerHTML = isUsingRecommendedDoctors ? 
                'üîÑ ÂàáÊç¢Âà∞ÁªèÂÖ∏ÂêçÂåª' : 'ü§ñ ‰ΩøÁî®AIÊé®ËçêÂåªÁîü';
                
            toggleButton.onclick = () => {
                renderDoctorCards(!isUsingRecommendedDoctors);
            };
            
            toggleButton.onmouseover = () => {
                toggleButton.style.background = '#e5e7eb';
            };
            
            toggleButton.onmouseout = () => {
                toggleButton.style.background = '#f3f4f6';
            };
            
            container.appendChild(toggleButton);
        }

        // Êô∫ËÉΩÊé®ËçêÂåªÁîüÔºàÂü∫‰∫éÁî®Êà∑ËæìÂÖ•ÁöÑÁóáÁä∂Ôºâ
        async function recommendDoctorsForSymptoms(userInput) {
            const symptoms = extractSymptomsFromText(userInput);
            if (symptoms.length > 0) {
                console.log('ü§ñ Ê£ÄÊµãÂà∞ÁóáÁä∂ÔºåËé∑ÂèñAIÊé®ËçêÂåªÁîü:', symptoms);
                recommendedDoctors = await getRecommendedDoctors(symptoms);
                if (recommendedDoctors.length > 0) {
                    console.log('‚úÖ Ëé∑ÂèñÂà∞Êé®ËçêÂåªÁîü:', recommendedDoctors.length, '‰Ωç');
                    // ÈáçÊñ∞Ê∏≤ÊüìÂåªÁîüÂç°ÁâáÔºå‰ºòÂÖàÊòæÁ§∫Êé®ËçêÂåªÁîü
                    renderDoctorCards(true);
                }
            }
        }

        // ‰ªéÊñáÊú¨‰∏≠ÊèêÂèñÁóáÁä∂ÂÖ≥ÈîÆËØç
        function extractSymptomsFromText(text) {
            const symptomKeywords = [
                'Â§¥Áóõ', 'Â§¥Áñº', 'Â§¥Êôï', 'Áú©Êôï', 'Â§±Áú†', 'ÁÑ¶Ëôë', 'ÊäëÈÉÅ', 'ÂøÉÊÇ∏', 'ËÉ∏Èó∑', '‰πèÂäõ', 'ÂèëÁÉ≠',
                'ËÉÉÁóõ', 'ËÉÉÁñº', 'ËÇöÂ≠êÁñº', 'ËÇöÂ≠êÁóõ', 'ËÖπÁóõ', 'ËÖπËÉÄ', 'ËÖπÊ≥ª', '‰æøÁßò', 'È£üÊ¨≤‰∏çÊåØ', 'Ê∂àÂåñ‰∏çËâØ', 
                'Âí≥ÂóΩ', 'ÂìÆÂñò', 'ÈºªÁÇé', 'Ê∞îÂñò', 'ÊÑüÂÜí', 'ÂèëÁÉß', 'ÂñâÂíôÁóõ', 'ÂíΩÁóõ', 'ÊµÅÈºªÊ∂ï',
                'ÊúàÁªè‰∏çË∞É', 'ÁóõÁªè', 'ÁôΩÂ∏¶ÂºÇÂ∏∏', '‰∏çÂ≠ï', 'Êõ¥Âπ¥Êúü', 'Â¶áÁßë', 'Â∞èÂÑøÂèëÁÉ≠', 'Â∞èÂÑøÂí≥ÂóΩ', 'Â∞èÂÑøËÖπÊ≥ª',
                'ÊπøÁñπ', 'Áó§ÁñÆ', 'ÁöÆËÇ§ÁóÖ', 'ÈùíÊò•Áóò', 'ËÖ∞Áóõ', 'ÂÖ≥ËäÇÁóõ', 'È¢àÊ§éÁóÖ', 'ËÜùÁõñÁóõ', 'ËÄ≥È∏£', 'Âê¨Âäõ‰∏ãÈôç', 'ÈºªÂ°û',
                'ÁâôÁóõ', 'Âè£ËÖîÊ∫ÉÁñ°', '‰æøË°Ä', 'Â∞øÈ¢ë', 'Â∞øÊÄ•', 'Ê∞¥ËÇø', 'Âá∫Ê±ó', 'ÁõóÊ±ó', 'ÊâãËÑöÂÜ∞Âáâ', 'ÂõõËÇ¢Êó†Âäõ'
            ];
            
            const foundSymptoms = [];
            for (const symptom of symptomKeywords) {
                if (text.includes(symptom)) {
                    foundSymptoms.push(symptom);
                }
            }
            return foundSymptoms;
        }
        
        // ÁóáÁä∂Âêå‰πâËØçÊò†Â∞Ñ
        function getSymptomSynonyms() {
            return {
                'ËÖπÁóõ': ['ËÇöÂ≠êÁñº', 'ËÇöÂ≠êÁóõ', 'ËÖπÈÉ®ÁñºÁóõ', 'ËÖπÈÉ®‰∏çÈÄÇ'],
                'ËÇöÂ≠êÁñº': ['ËÖπÁóõ', 'ËÇöÂ≠êÁóõ', 'ËÖπÈÉ®ÁñºÁóõ'],
                'Â§¥Áóõ': ['Â§¥Áñº', 'Â§¥ÈÉ®ÁñºÁóõ'],
                'ËÉÉÁóõ': ['ËÉÉÁñº', 'ËÉÉÈÉ®ÁñºÁóõ', 'ËÉÉ‰∏çËàíÊúç'],
                'ÂèëÁÉ≠': ['ÂèëÁÉß', '‰ΩìÊ∏©ÂçáÈ´ò'],
                'ÂíΩÁóõ': ['ÂñâÂíôÁóõ', 'ÂíΩÂñâÁñºÁóõ']
            };
        }
        
        // Ê£ÄÊü•ÁóáÁä∂ÊòØÂê¶Áõ∏ÂÖ≥ÔºàËÄÉËôëÂêå‰πâËØçÂíåÂåªÂ≠¶ÂÖ≥ËÅîÔºâ
        function isSymptomsRelated(userSymptoms, aiSymptom) {
            const synonyms = getSymptomSynonyms();
            
            // Áõ¥Êé•ÂåπÈÖç
            if (userSymptoms.includes(aiSymptom)) {
                return true;
            }
            
            // Âêå‰πâËØçÊ£ÄÊü•
            for (const userSymptom of userSymptoms) {
                if (synonyms[userSymptom] && synonyms[userSymptom].includes(aiSymptom)) {
                    return true;
                }
                if (synonyms[aiSymptom] && synonyms[aiSymptom].includes(userSymptom)) {
                    return true;
                }
            }
            
            // ÂåªÂ≠¶ÂÖ≥ËÅîÊÄßÊ£ÄÊü•ÔºàÂ∏∏ËßÅÁöÑÁóáÁä∂ÁªÑÂêàÔºâ
            const medicalAssociations = {
                'ËÖπÁóõ': ['ËÖπÊ≥ª', '‰æøÁßò', 'È£üÊ¨≤‰∏çÊåØ', 'ËÖπËÉÄ'],
                'ËÇöÂ≠êÁñº': ['ËÖπÊ≥ª', '‰æøÁßò', 'È£üÊ¨≤‰∏çÊåØ', 'ËÖπËÉÄ'],
                'Â§¥Áóõ': ['Â§¥Êôï', 'Áú©Êôï', 'Â§±Áú†'],
                'ÂèëÁÉ≠': ['‰πèÂäõ', 'Âá∫Ê±ó'],
                'ÊÑüÂÜí': ['Âí≥ÂóΩ', 'ÊµÅÈºªÊ∂ï', 'ÈºªÂ°û', 'ÂñâÂíôÁóõ']
            };
            
            for (const userSymptom of userSymptoms) {
                if (medicalAssociations[userSymptom] && medicalAssociations[userSymptom].includes(aiSymptom)) {
                    return true;
                }
            }
            
            return false;
        }

        // ÈÄâÊã©ÂåªÁîüÔºàÊîØÊåÅÈªòËÆ§ÂåªÁîüÂíåÊé®ËçêÂåªÁîüÔºâ
        function selectDoctor(doctorKey, doctorData = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁúüÊ≠£ÁöÑÂØπËØùÂÜÖÂÆπÔºàÁî®Êà∑Ê∂àÊÅØÊàñAIÂõûÂ§çÔºâ
            const userMessages = messagesContainer.querySelectorAll('.message.user');
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            const hasExistingMessages = userMessages.length > 0 || aiMessages.length > 0;
            
            // ÂàáÊç¢ÂåªÁîüÊó∂‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤Ôºå‰∏çÂÜçÊ∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï
            if (selectedDoctor && selectedDoctor !== doctorKey && hasExistingMessages) {
                // ‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤
                saveCurrentDoctorHistory();
            }
            
            // ÁßªÈô§‰πãÂâçÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Ê∑ªÂä†Êñ∞ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }

            const previousDoctor = selectedDoctor;
            selectedDoctor = doctorKey;
            
            // Ëé∑ÂèñÂåªÁîü‰ø°ÊÅØÔºà‰ºòÂÖà‰ΩøÁî®‰º†ÂÖ•ÁöÑdoctorDataÔºåÁÑ∂ÂêéÊòØÈªòËÆ§doctorsÂØπË±°Ôºâ
            const doctor = doctorData || doctors[doctorKey] || {
                name: 'ÂåªÁîü',
                school: '‰∏≠ÂåªÂ∏à', 
                avatar: 'üë®‚Äç‚öïÔ∏è',
                specialty: '‰∏≠ÂåªÂÜÖÁßë'
            };

            // Êõ¥Êñ∞È°∂ÈÉ®ÂåªÁîü‰ø°ÊÅØÊù°
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `ÊìÖÈïøÔºö${doctor.specialty}`;

            // ÂàáÊç¢ÂåªÁîüÊó∂ÁîüÊàêÊñ∞ÁöÑÂØπËØùIDÔºåÁ°Æ‰øùAIË∫´‰ªΩÊ≠£Á°ÆÂàáÊç¢
            if (previousDoctor && previousDoctor !== doctorKey) {
                // ÁîüÊàêÊñ∞ÁöÑÂØπËØùIDÔºåÂº∫Âà∂ÂºÄÂßãÊñ∞ÂØπËØù
                generateConversationId();
            }
            
            // Âä†ËΩΩÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤Ôºå‰∏çÊ∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï
            if (!previousDoctor || previousDoctor !== doctorKey) {
                // Âä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ÂØπËØù
                loadDoctorHistory(doctorKey);
            }
            
            // ÊòæÁ§∫ËæìÂÖ•Ê°Ü
            const inputContainer = document.querySelector('.input-container');
            if (inputContainer) {
                inputContainer.classList.add('show');
            }
            
            // ÁßªÂä®Á´ØÔºöÂÖ≥Èó≠ÂåªÁîüÈÄâÊã©ÊµÆÂ±Ç
            if (window.innerWidth <= 768) {
                closeMobileDoctorSelector();
            }
        }

        // Ê∑ªÂä†Ê∂àÊÅØ
        function addMessage(sender, content, showFeedback = false) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´Â§ÑÊñπ
            const containsPrescriptionContent = containsPrescription(content);
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'üë§' : (selectedDoctor ? doctors[selectedDoctor].avatar : 'ü§ñ')}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    <div class="message-time">${timeStr}</div>
                    ${sender === 'ai' && containsPrescriptionContent ? `
                        <div class="prescription-actions" style="margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 13px; color: #374151; margin-bottom: 8px;">
                                <strong>üìã Â§ÑÊñπÂª∫ËÆÆ</strong> - ‰∏∫Á°Æ‰øùÁî®ËçØÂÆâÂÖ®ÔºåÂª∫ËÆÆÊÇ®Ôºö
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="confirmPrescription('${btoa(encodeURIComponent(content))}')" 
                                        style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                    üõí Á°ÆËÆ§Â§ÑÊñπÂπ∂ÊîØ‰ªò
                                </button>
                                <button onclick="consultDoctor()" 
                                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                    üë®‚Äç‚öïÔ∏è Âí®ËØ¢‰∏ì‰∏öÂåªÁîü
                                </button>
                                <button onclick="savePrescription('${btoa(encodeURIComponent(content))}')" 
                                        style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                    üíæ ‰øùÂ≠òÂ§ÑÊñπ
                                </button>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 8px; font-style: italic;">
                                ‚ö†Ô∏è Ê≠§‰∏∫AIÂª∫ËÆÆÂ§ÑÊñπÔºåÂÆûÈôÖÁî®ËçØËØ∑ÈÅµÂåªÂò±
                            </div>
                        </div>
                    ` : ''}
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">Ëøô‰∏™ÂõûÁ≠îÊúâÂ∏ÆÂä©ÂêóÔºü</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">üòä ÂæàÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">üëç ‰∏çÈîô</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">üëå ËøòË°å</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">üëé ‰∏çÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">üòû ÂæàÂ∑Æ</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            // Ëá™Âä®ÊúóËØªAIÂõûÂ§ç
            if (sender === 'ai' && document.getElementById('autoSpeak').checked) {
                speakText(content);
            }
            
            // Ëá™Âä®‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤
            if (selectedDoctor) {
                setTimeout(() => saveCurrentDoctorHistory(), 100); // Âª∂Ëøü100msÁ°Æ‰øùDOMÊõ¥Êñ∞ÂÆåÊàê
            }
        }

        // Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπ
        function formatMessage(content) {
            if (!content) return '';
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ËØäÁñóÊñπÊ°àXMLÊ†áÁ≠æ
            if (content.includes('<ËØäÁñóÊñπÊ°à>')) {
                return formatTCMPrescription(content);
            }
            
            // Â¢ûÂº∫ÁöÑMarkdownÂ§ÑÁêÜ - ÊòéÁ°ÆÁöÑÂ±ÇÊ¨°ÂíåÊ†∑Âºè
            return content
                // Â§ÑÁêÜ„ÄêÂ§ÑÊñπ„ÄëÊ†áÁ≠æ - ÁâπÊÆäÈ´ò‰∫ÆÊ†∑Âºè
                .replace(/\*\*„ÄêÂ§ÑÊñπ„Äë\*\*/g, '<div style="background: linear-gradient(135deg, #2d5aa0, #4a7bc8); color: white; padding: 10px 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; font-size: 16px; text-align: center;">üìã ‰∏≠ËçØÂ§ÑÊñπ</div>')
                // Â§ÑÁêÜ„ÄêÁî®Ê≥ï„Äë„ÄêÊ≥®ÊÑè„ÄëÁ≠âÊ†áÁ≠æ
                .replace(/\*\*„Äê(Áî®Ê≥ï|Ê≥®ÊÑè|Á¶ÅÂøå|ÂäüÊïà)„Äë\*\*/g, '<div style="background: #f3f4f6; color: #374151; padding: 8px 12px; border-radius: 6px; margin: 10px 0; font-weight: bold; border-left: 4px solid #6b7280;">$1</div>')
                // Â§ÑÁêÜÂÖ∂‰ªñÁ≤ó‰ΩìÊ†áÁ≠æ„Äêxxx„Äë
                .replace(/\*\*„Äê(.*?)„Äë\*\*/g, '<strong style="color: #2d5aa0; font-size: 15px; background: #e0f2fe; padding: 2px 6px; border-radius: 4px;">„Äê$1„Äë</strong>')
                // Â§ÑÁêÜÂÖ∂‰ªñÁ≤ó‰ΩìÊñáÊú¨
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937; font-weight: bold;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color: #6b7280;">$1</em>')
                // Â§ÑÁêÜ#####Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫ÂàÜÂâ≤Á∫ø
                .replace(/#{5,}/g, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb; background: linear-gradient(to right, #e5e7eb, transparent);">')
                // Â§ÑÁêÜ###Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫ÊòéÊòæÁöÑÂ∞èÊ†áÈ¢ò
                .replace(/###\s*(.*?)(?=\n|$)/g, '<h4 style="margin: 20px 0 12px 0; color: #2d5aa0; font-size: 17px; font-weight: bold; padding-left: 8px; border-left: 4px solid #2d5aa0; background: #f8fafc;">$1</h4>')
                // Â§ÑÁêÜ##Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫Êõ¥Â§ßÁöÑ‰∏≠Ê†áÈ¢ò  
                .replace(/##\s*(.*?)(?=\n|$)/g, '<h3 style="margin: 25px 0 15px 0; color: #1f2937; font-size: 19px; font-weight: bold; padding: 8px 12px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 6px;">$1</h3>')
                // Â§ÑÁêÜ#Ê†áËÆ∞ - ËΩ¨Êç¢‰∏∫Â§ßÊ†áÈ¢ò
                .replace(/^#\s*(.*?)(?=\n|$)/gm, '<h2 style="margin: 30px 0 20px 0; color: #111827; font-size: 22px; font-weight: bold; text-align: center; padding: 12px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px;">$1</h2>')
                // Â§ÑÁêÜËçØÊùêÂàóË°® - ÁâπÊÆäÊ†∑Âºè
                .replace(/([‰∏Ä-Èæü\u4e00-\u9fff]+)\s+(\d+)g/g, '<span style="display: inline-block; background: #ecfdf5; color: #065f46; padding: 2px 6px; margin: 1px 3px; border-radius: 4px; font-weight: 500; border: 1px solid #d1fae5;">$1 <strong>$2g</strong></span>')
                .replace(/\n\n/g, '<br><br>')  // ÊÆµËêΩÈó¥Ë∑ù
                .replace(/\n/g, '<br>')        // ÊôÆÈÄöÊç¢Ë°å
                .replace(/(\d+\.\s)/g, '<br><span style="color: #2d5aa0; font-weight: bold;">$1</span>') // Êï∞Â≠óÂàóË°®Ê†∑Âºè
                .replace(/^<br>/, '');         // ÁßªÈô§ÂºÄÂ§¥ÁöÑÊç¢Ë°å
        }

        // Ê†ºÂºèÂåñ‰∏≠ÂåªÂ§ÑÊñπ - ÂÖ®Êñ∞ËÆæËÆ°
        function formatTCMPrescription(content) {
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´XMLÊ†ºÂºè
            const hasXMLFormat = content.includes('<ËØäÁñóÊñπÊ°à>');
            
            if (hasXMLFormat) {
                return formatXMLPrescription(content);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâXMLÊ†ºÂºèÔºåÂ∞ùËØïÊô∫ËÉΩËß£ÊûêÊñáÊú¨Ê†ºÂºè
                return formatTextPrescription(content);
            }
        }

        // XMLÊ†ºÂºèÂ§ÑÊñπËß£Êûê
        function formatXMLPrescription(content) {
            const prescriptionMatch = content.match(/<ËØäÁñóÊñπÊ°à>([\s\S]*?)<\/ËØäÁñóÊñπÊ°à>/);
            if (!prescriptionMatch) {
                return formatTextPrescription(content);
            }
            
            const prescriptionContent = prescriptionMatch[1];
            let formattedHTML = '<div class="modern-tcm-report">';
            
            // ÂÆö‰πâÂêÑ‰∏™ÈÉ®ÂàÜÁöÑÈÖçÁΩÆ
            const sections = [
                { name: '‰∏ªËØâ', key: '‰∏ªËØâ', icon: 'ü©∫', color: '#ef4444' },
                { name: 'Áé∞ÁóÖÂè≤', key: 'Áé∞ÁóÖÂè≤', icon: 'üìã', color: '#3b82f6' },
                { name: 'ÊúõËØäÊâÄËßÅ', key: 'ÊúõËØäÊâÄËßÅ', icon: 'üëÅÔ∏è', color: '#10b981' },
                { name: 'ÁóÖÊú∫ÂàÜÊûê', key: 'ÁóÖÊú∫ÂàÜÊûê', icon: 'üß†', color: '#8b5cf6' },
                { name: 'ËØÅÂûãËØäÊñ≠', key: 'ËØÅÂûãËØäÊñ≠', icon: 'üéØ', color: '#f59e0b' },
                { name: 'Ê≤ªÊ≥ï', key: 'Ê≤ªÊ≥ï', icon: '‚ö°', color: '#06b6d4' },
                { name: 'ÊñπÂâÇÈÄâÁî®', key: 'ÊñπÂâÇÈÄâÁî®', icon: 'üìú', color: '#84cc16' },
                { name: 'Â§ÑÊñπÂª∫ËÆÆ', key: 'Â§ÑÊñπÂª∫ËÆÆ', icon: 'üíä', color: '#ec4899', special: 'prescription' },
                { name: 'ÁÖéÊúçÊñπÊ≥ï', key: 'ÁÖéÊúçÊñπÊ≥ï', icon: 'üî•', color: '#f97316' },
                { name: 'ÈöèËØÅÂä†Âáè', key: 'ÈöèËØÅÂä†Âáè', icon: '‚öñÔ∏è', color: '#6366f1' },
                { name: 'ÁîüÊ¥ªË∞ÉÊëÑ', key: 'ÁîüÊ¥ªË∞ÉÊëÑ', icon: 'üå±', color: '#059669' },
                { name: 'Â§çËØäÂª∫ËÆÆ', key: 'Â§çËØäÂª∫ËÆÆ', icon: 'üìÖ', color: '#dc2626' }
            ];
            
            sections.forEach(section => {
                const regex = new RegExp(`<${section.key}>(.*?)<\/${section.key}>`, 's');
                const match = prescriptionContent.match(regex);
                
                if (match) {
                    let sectionContent = match[1].trim()
                        .replace(/\*\*(.*?)\*\*/g, '<span class="highlight-term">$1</span>')
                        .replace(/\n/g, '<br>');
                    
                    // ÁâπÊÆäÂ§ÑÁêÜÂ§ÑÊñπÂª∫ËÆÆ
                    if (section.special === 'prescription') {
                        sectionContent = formatModernPrescription(sectionContent);
                    }
                    
                    formattedHTML += `
                        <div class="modern-tcm-section" style="--section-color: ${section.color}">
                            <div class="section-header">
                                <span class="section-icon">${section.icon}</span>
                                <span class="section-title">${section.name}</span>
                            </div>
                            <div class="section-content">${sectionContent}</div>
                        </div>
                    `;
                }
            });
            
            formattedHTML += '</div>';
            
            // Â§ÑÁêÜXMLÂ§ñÁöÑÂÜÖÂÆπ
            const beforeMatch = content.substring(0, content.indexOf('<ËØäÁñóÊñπÊ°à>'));
            const afterMatch = content.substring(content.indexOf('</ËØäÁñóÊñπÊ°à>') + 7);
            
            let result = '';
            if (beforeMatch.trim()) {
                result += '<div class="pre-prescription">' + formatMessage(beforeMatch) + '</div>';
            }
            result += formattedHTML;
            if (afterMatch.trim()) {
                result += '<div class="post-prescription">' + formatMessage(afterMatch) + '</div>';
            }
            
            return result;
        }

        // ÊñáÊú¨Ê†ºÂºèÂ§ÑÊñπÊô∫ËÉΩËß£Êûê
        function formatTextPrescription(content) {
            let formattedHTML = '<div class="text-tcm-report">';
            
            // ÊåâÊÆµËêΩÂàÜÊûê
            const paragraphs = content.split('\n\n');
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ†áÈ¢òË°å
                    if (paragraph.includes('**') && paragraph.length < 50) {
                        formattedHTML += `<div class="text-section-header">${formatMessage(paragraph)}</div>`;
                    } else {
                        formattedHTML += `<div class="text-section-content">${formatMessage(paragraph)}</div>`;
                    }
                }
            });
            
            formattedHTML += '</div>';
            return formattedHTML;
        }

        // Áé∞‰ª£ÂåñÂ§ÑÊñπÊ†ºÂºèÂåñ
        function formatModernPrescription(prescriptionText) {
            // Â§öÁßçËçØÊùêÊ†ºÂºèËØÜÂà´
            const herbs = [];
            let originalText = prescriptionText;
            
            // Ê®°ÂºèÂåπÈÖçËçØÊùêÂêçÁß∞ÂíåÂâÇÈáè
            const patterns = [
                /<span class="highlight-term">(.*?)<\/span>\s*(\d+(?:\.\d+)?g?)/g,
                /\*\*(.*?)\*\*\s*(\d+(?:\.\d+)?g?)/g,
                /<strong>(.*?)<\/strong>\s*(\d+(?:\.\d+)?g?)/g,
                /([^\s\dÔºå„ÄÇÔºõ„ÄÅ\-]+)\s*(\d+(?:\.\d+)?g)/g
            ];
            
            let usedPattern = null;
            
            for (let pattern of patterns) {
                pattern.lastIndex = 0; // ÈáçÁΩÆÊ≠£ÂàôË°®ËææÂºèÁöÑlastIndex
                let match;
                let tempHerbs = [];
                
                while ((match = pattern.exec(originalText)) !== null) {
                    const herbName = match[1].trim();
                    const dosage = match[2];
                    
                    // ÊéíÈô§ÈùûËçØÊùêËØçÊ±áÂíåÈáçÂ§çÈ°π
                    if (!['ÂÖ±', 'ÁÖé', 'Êúç', 'Áî®', 'ÊØè', 'Ê¨°', 'Êó•', 'Ê∞¥', 'ÁÖéÊúç', 'ÂàÜÊúç', 'Êñπ', 'ËçØ'].includes(herbName) 
                        && herbName.length > 0 && herbName.length < 10) {
                        
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
                        if (!tempHerbs.some(h => h.name === herbName)) {
                            tempHerbs.push({
                                name: herbName,
                                dosage: dosage,
                                fullMatch: match[0]
                            });
                        }
                    }
                }
                
                if (tempHerbs.length > 0) {
                    herbs.push(...tempHerbs);
                    usedPattern = pattern;
                    break; // ÊâæÂà∞ÂåπÈÖçÂ∞±ÂÅúÊ≠¢
                }
            }
            
            if (herbs.length > 0) {
                let modernHTML = '<div class="modern-prescription-grid">';
                herbs.forEach((herb, index) => {
                    modernHTML += `
                        <div class="herb-card" style="animation-delay: ${index * 0.1}s">
                            <div class="herb-name-modern">
                                ${herb.name} 
                                <span class="herb-dosage-inline">${herb.dosage}</span>
                            </div>
                        </div>
                    `;
                });
                modernHTML += '</div>';
                
                // ÁßªÈô§Â∑≤ÁªèÊòæÁ§∫ÁöÑËçØÊùê‰ø°ÊÅØÔºåÈÅøÂÖçÈáçÂ§ç
                let remainingText = originalText;
                herbs.forEach(herb => {
                    // ÁßªÈô§ÂêÑÁßçÂèØËÉΩÁöÑËçØÊùêÊ†ºÂºè
                    remainingText = remainingText
                        .replace(new RegExp(`\\*\\*${herb.name}\\*\\*\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '')
                        .replace(new RegExp(`<strong>${herb.name}</strong>\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '')
                        .replace(new RegExp(`<span class="highlight-term">${herb.name}</span>\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '')
                        .replace(new RegExp(`${herb.name}\\s*${herb.dosage}[Ôºå„ÄÅ]*`, 'g'), '');
                });
                
                // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÊ†áÁÇπÂíåÁ©∫ÁôΩ
                remainingText = remainingText
                    .replace(/<[^>]*>/g, '') // ÁßªÈô§HTMLÊ†áÁ≠æ
                    .replace(/\*\*/g, '') // ÁßªÈô§markdownÊ†áËÆ∞
                    .replace(/[Ôºå„ÄÅ]{2,}/g, '„ÄÅ') // ÂêàÂπ∂Â§ö‰∏™Ê†áÁÇπ
                    .replace(/^[Ôºå„ÄÅ\s]+|[Ôºå„ÄÅ\s]+$/g, '') // ÁßªÈô§È¶ñÂ∞æÊ†áÁÇπ
                    .trim();
                
                // Âè™ÊúâÂΩìÂâ©‰ΩôÊñáÊú¨ÊúâÂÆûÈôÖÂÜÖÂÆπÊó∂ÊâçÊòæÁ§∫
                if (remainingText && remainingText.length > 5) {
                    modernHTML += `<div class="prescription-notes">${remainingText}</div>`;
                }
                
                return modernHTML;
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâËØÜÂà´Âà∞ËçØÊùêÔºåËøîÂõûÊ†ºÂºèÂåñÁöÑÊñáÊú¨
            return `<div class="prescription-text">${prescriptionText}</div>`;
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰ΩçÂåªÂ∏à');
                }
                return;
            }

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMessage('user', message);
            input.value = '';
            adjustTextareaHeight();
            
            // Êô∫ËÉΩÊé®ËçêÂåªÁîüÔºàÂú®Áî®Êà∑ÂèëÈÄÅÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÊó∂ÔºåÊ£ÄÊµãÁóáÁä∂Âπ∂Êé®ËçêÂåªÁîüÔºâ
            if (!isUsingRecommendedDoctors) {
                // Ê£ÄÊµãÁóáÁä∂Âπ∂ÂºÇÊ≠•Êé®ËçêÂåªÁîüÔºå‰∏çÈòªÂ°ûÂΩìÂâçÂØπËØù
                recommendDoctorsForSymptoms(message).catch(error => {
                    console.warn('Êé®ËçêÂåªÁîüÂäüËÉΩÂºÇÂ∏∏:', error);
                });
            }

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const sendBtn = document.getElementById('sendBtn');
            const loading = document.getElementById('loading');
            sendBtn.disabled = true;
            loading.style.display = 'block';

                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                
                // Â§ÑÁêÜÊñ∞ÁöÑAPIÂìçÂ∫îÊ†ºÂºè
                let aiReply;
                if (responseData.success && responseData.data && responseData.data.reply) {
                    aiReply = responseData.data.reply;
                } else if (responseData.reply) {
                    aiReply = responseData.reply; // ÂÖºÂÆπÊóßÊ†ºÂºè
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ: Êú™ÊâæÂà∞replyÂ≠óÊÆµ');
                }
                
                // ÂåªÁñóÂÆâÂÖ®Ê£ÄÊü•
                const aiWarnings = checkMedicalSafety(aiReply);
                if (aiWarnings.length > 0) {
                    showMedicalWarnings(aiWarnings);
                    // ËÆ∞ÂΩïAIÂìçÂ∫î‰∏≠ÁöÑÂÆâÂÖ®ÈóÆÈ¢ò
                    aiWarnings.forEach(warning => {
                        logSecurityEvent(`ai_${warning.type}`, aiReply, warning);
                    });
                }
                
                // Ê£ÄÊü•ÁóáÁä∂ÁºñÈÄ†
                detectSymptomFabrication(message, aiReply);
                
                // Êô∫ËÉΩÂà§Êñ≠ÊòØÂê¶ÊòæÁ§∫ÁÇπËØÑ - Âè™ÊúâÂåÖÂê´Â§ÑÊñπÊó∂ÊâçÊòæÁ§∫
                const shouldShowFeedback = containsPrescription(aiReply);
                addMessage('ai', aiReply, shouldShowFeedback);
                
                // ËÆ∞ÂΩïËØäÊñ≠Èò∂ÊÆµ
                if (shouldShowFeedback) {
                    console.log('Ê£ÄÊµãÂà∞Â§ÑÊñπÂÜÖÂÆπÔºåÊòæÁ§∫ÁÇπËØÑÂäüËÉΩ');
                } else {
                    console.log('ÊôÆÈÄöÂØπËØùÔºå‰∏çÊòæÁ§∫ÁÇπËØÑ');
                }

            } catch (error) {
                addMessage('ai', `Êä±Ê≠âÔºåÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®Ôºö${error.message}`);
            } finally {
                sendBtn.disabled = false;
                loading.style.display = 'none';
                input.focus();
            }
        }

        // Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // ÊâìÂºÄÊ≥®ÂÜåÈ°µÈù¢
        function openRegisterPage() {
            window.open('/nav', '_blank');
        }

        // ÊâìÂºÄÁóÖÂéÜËÆ∞ÂΩïÈ°µÈù¢
        function openHistoryPage() {
            // Ë∑≥ËΩ¨Âà∞Áî®Êà∑ÂéÜÂè≤È°µÈù¢
            window.open('/history', '_blank');
        }

        // ÊòæÁ§∫ÁóÖÂéÜËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü
        async function showMedicalRecordsModal() {
            try {
                // Ëé∑ÂèñÁî®Êà∑ÁöÑÁóÖÂéÜËÆ∞ÂΩï
                const response = await fetch('/api/medical-records/list', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('Ëé∑ÂèñÁóÖÂéÜËÆ∞ÂΩïÂ§±Ë¥•', 'error');
                    return;
                }
                
                createMedicalRecordsModal(result.data || []);
                
            } catch (error) {
                console.error('Ëé∑ÂèñÁóÖÂéÜËÆ∞ÂΩïÂ§±Ë¥•:', error);
                showMessage('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // ÂàõÂª∫ÁóÖÂéÜËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü
        function createMedicalRecordsModal(records) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ê®°ÊÄÅÊ°Ü
            let modal = document.getElementById('medicalRecordsModal');
            if (modal) {
                modal.remove();
            }
            
            modal = document.createElement('div');
            modal.id = 'medicalRecordsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1004;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 800px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 20px; font-weight: 600;">üìã ÊàëÁöÑÁóÖÂéÜËÆ∞ÂΩï</h3>
                        <button onclick="hideMedicalRecordsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">√ó</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <button onclick="showAllRecords()" id="allRecordsBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: #3b82f6; color: white; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                ÂÖ®ÈÉ®ËÆ∞ÂΩï
                            </button>
                            <button onclick="showConsultationRecords()" id="consultationBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: white; color: #3b82f6; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                ÈóÆËØäËÆ∞ÂΩï
                            </button>
                            <button onclick="showPrescriptionRecords()" id="prescriptionBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: white; color: #3b82f6; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                Â§ÑÊñπËÆ∞ÂΩï
                            </button>
                        </div>
                        <div id="recordsContainer">
                            ${records.length > 0 ? generateRecordsHTML(records) : '<div style="text-align: center; color: #6b7280; padding: 40px;">ÊöÇÊó†ÁóÖÂéÜËÆ∞ÂΩï</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ÁîüÊàêÁóÖÂéÜËÆ∞ÂΩïHTML
        function generateRecordsHTML(records) {
            return records.map(record => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px;">${record.doctor_name || 'ÂåªÁîü'} - ${record.type === 'consultation' ? 'ÈóÆËØäËÆ∞ÂΩï' : 'Â§ÑÊñπËÆ∞ÂΩï'}</h4>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 13px;">${new Date(record.created_at).toLocaleString()}</p>
                        </div>
                        <span style="padding: 4px 12px; background: ${record.status === 'completed' ? '#dcfce7' : '#fef3c7'}; color: ${record.status === 'completed' ? '#166534' : '#92400e'}; border-radius: 12px; font-size: 12px;">
                            ${record.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}
                        </span>
                    </div>
                    
                    ${record.symptoms ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">‰∏ªË¶ÅÁóáÁä∂Ôºö</strong>
                            <span style="color: #6b7280; font-size: 14px;">${record.symptoms}</span>
                        </div>
                    ` : ''}
                    
                    ${record.diagnosis ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">ËØäÊñ≠ÁªìÊûúÔºö</strong>
                            <span style="color: #6b7280; font-size: 14px;">${record.diagnosis}</span>
                        </div>
                    ` : ''}
                    
                    ${record.prescription ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">Â§ÑÊñπÂÜÖÂÆπÔºö</strong>
                            <div style="background: #f8fafc; border-radius: 6px; padding: 12px; margin-top: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${record.prescription}</div>
                        </div>
                    ` : ''}
                    
                    ${record.payment_amount ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">Ë¥πÁî®Ôºö</strong>
                            <span style="color: #ef4444; font-size: 14px; font-weight: 500;">¬• ${record.payment_amount}</span>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <button onclick="viewRecordDetail('${record.id}')" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; color: #374151;">
                            Êü•ÁúãËØ¶ÊÉÖ
                        </button>
                        ${record.type === 'prescription' && record.status === 'completed' ? `
                            <button onclick="reorderPrescription('${record.id}')" style="padding: 6px 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 12px; cursor: pointer; color: #3b82f6;">
                                ÈáçÊñ∞Ë¥≠‰π∞
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ÈöêËóèÁóÖÂéÜËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü
        function hideMedicalRecordsModal() {
            const modal = document.getElementById('medicalRecordsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ÊòæÁ§∫ÊâÄÊúâËÆ∞ÂΩï
        async function showAllRecords() {
            updateRecordFilter('all');
            const response = await fetch('/api/medical-records/list', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // ÊòæÁ§∫ÈóÆËØäËÆ∞ÂΩï
        async function showConsultationRecords() {
            updateRecordFilter('consultation');
            const response = await fetch('/api/medical-records/list?type=consultation', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // ÊòæÁ§∫Â§ÑÊñπËÆ∞ÂΩï
        async function showPrescriptionRecords() {
            updateRecordFilter('prescription');
            const response = await fetch('/api/medical-records/list?type=prescription', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // Êõ¥Êñ∞ËÆ∞ÂΩïËøáÊª§Âô®Ê†∑Âºè
        function updateRecordFilter(type) {
            const buttons = ['allRecordsBtn', 'consultationBtn', 'prescriptionBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((type === 'all' && btnId === 'allRecordsBtn') ||
                        (type === 'consultation' && btnId === 'consultationBtn') ||
                        (type === 'prescription' && btnId === 'prescriptionBtn')) {
                        btn.style.background = '#3b82f6';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#3b82f6';
                    }
                }
            });
        }

        // Êõ¥Êñ∞ËÆ∞ÂΩïÂÆπÂô®
        function updateRecordsContainer(records) {
            const container = document.getElementById('recordsContainer');
            if (container) {
                container.innerHTML = records.length > 0 ? generateRecordsHTML(records) : '<div style="text-align: center; color: #6b7280; padding: 40px;">ÊöÇÊó†Áõ∏ÂÖ≥ËÆ∞ÂΩï</div>';
            }
        }

        // Êü•ÁúãËÆ∞ÂΩïËØ¶ÊÉÖ
        async function viewRecordDetail(recordId) {
            try {
                const response = await fetch(`/api/user/conversation/${recordId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const record = await response.json();
                    
                    // ÊòæÁ§∫ËØ¶ÁªÜÁöÑËÆ∞ÂΩï‰ø°ÊÅØ
                    showRecordDetailModal(record);
                } else {
                    showMessage('Ëé∑ÂèñËÆ∞ÂΩïËØ¶ÊÉÖÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñËÆ∞ÂΩïËØ¶ÊÉÖÂ§±Ë¥•:', error);
                showMessage('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // ÈáçÊñ∞Ë¥≠‰π∞Â§ÑÊñπ
        async function reorderPrescription(recordId) {
            try {
                const response = await fetch(`/api/prescription/reorder/${recordId}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    hideMedicalRecordsModal();
                    showPaymentModal(result.data.prescription_id, result.data.amount);
                } else {
                    showMessage(result.message || 'ÈáçÊñ∞Ë¥≠‰π∞Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ÈáçÊñ∞Ë¥≠‰π∞Â§±Ë¥•:', error);
                showMessage('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }
        
        // Ëé∑ÂèñÂåªÁîüÊòæÁ§∫ÂêçÁß∞
        function getDoctorDisplayName(doctorKey) {
            const doctorNames = {
                'zhang_zhongjing': 'Âº†‰ª≤ÊôØ',
                'ye_tianshi': 'Âè∂Â§©Â£´',
                'li_dongyuan': 'Êùé‰∏úÂû£',
                'zhu_danxi': 'Êú±‰∏πÊ∫™',
                'liu_duzhou': 'ÂàòÊ∏°Ëàü',
                'zheng_qin_an': 'ÈÉëÈí¶ÂÆâ'
            };
            return doctorNames[doctorKey] || doctorKey || 'ÂåªÁîü';
        }
        
        // ÊòæÁ§∫ËÆ∞ÂΩïËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function showRecordDetailModal(record) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ê®°ÊÄÅÊ°Ü
            let detailModal = document.getElementById('recordDetailModal');
            if (detailModal) {
                detailModal.remove();
            }
            
            const doctorName = getDoctorDisplayName(record.doctor_name);
            const visitDate = new Date(record.created_at).toLocaleString('zh-CN');
            
            detailModal = document.createElement('div');
            detailModal.id = 'recordDetailModal';
            detailModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1005;
            `;
            
            detailModal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">üìã ÂØπËØùËØ¶ÊÉÖ - ${doctorName}</h3>
                        <button onclick="closeRecordDetailModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">√ó</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="background: #f8f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #667eea; font-size: 16px;">Âü∫Êú¨‰ø°ÊÅØ</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><strong>Â∞±ËØäÊó∂Èó¥:</strong> ${visitDate}</div>
                                <div><strong>Â∞±ËØäÊ¨°Êï∞:</strong> Á¨¨${record.session_count || 1}Ê¨°</div>
                                <div><strong>‰∏ªËØâ:</strong> ${record.chief_complaint || 'Êú™ËÆ∞ÂΩï'}</div>
                                <div><strong>ÂØπËØùËΩÆÊï∞:</strong> ${record.total_conversations || 0}ËΩÆ</div>
                            </div>
                        </div>
                        
                        ${record.diagnosis_summary ? `
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #3b82f6; font-size: 16px;">ËØäÁñóËÆ∞ÂΩï</h4>
                                <div style="line-height: 1.6; color: #374151;">
                                    <p style="margin-bottom: 12px;"><strong>ËØäÊñ≠ÊëòË¶Å:</strong> ${record.diagnosis_summary}</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${record.prescription_given && record.prescription_given !== 'Êú™ÂºÄÊñπ' ? `
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #10b981; font-size: 16px;">Â§ÑÊñπÂÜÖÂÆπ</h4>
                                <div style="background: white; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 14px; line-height: 1.5; white-space: pre-wrap; max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db;">
${record.prescription_given}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: #fefce8; border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #eab308; font-size: 16px;">ÂØπËØùÁä∂ÊÄÅ</h4>
                            <div style="display: flex; align-items: center;">
                                <span style="padding: 6px 16px; background: ${record.session_status === 'completed' ? '#dcfce7' : '#fef3c7'}; color: ${record.session_status === 'completed' ? '#166534' : '#92400e'}; border-radius: 20px; font-size: 14px; font-weight: 500;">
                                    ${record.session_status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 20px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
                        <button onclick="closeRecordDetailModal()" style="padding: 10px 20px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; color: #374151;">ÂÖ≥Èó≠</button>
                        <button onclick="exportConversation('${record.session_id}')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">üìÑ ÂØºÂá∫ÁóÖÂéÜ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(detailModal);
        }
        
        // ÂÖ≥Èó≠ËÆ∞ÂΩïËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function closeRecordDetailModal() {
            const modal = document.getElementById('recordDetailModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ÂØºÂá∫Âçï‰∏™ÂØπËØù
        async function exportConversation(sessionId) {
            try {
                const response = await fetch(`/api/user/conversation/${sessionId}/export`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TCM_ÁóÖÂéÜ_${sessionId.slice(0,8)}_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
                    closeRecordDetailModal();
                    showMessage('ÂØºÂá∫ÊàêÂäü', 'success');
                } else {
                    showMessage('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                }
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                showMessage('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
            }
        }


        // ÁßªÂä®Á´ØÁÆÄÂåñÂØºËà™
        function showMobileNavigation() {
            const navigationHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 12px; padding: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="text-align: center; font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #374151;">
                            üì± ÊÇ£ËÄÖÊúçÂä°ÂØºËà™
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/', '_blank'); this.parentElement.parentElement.parentElement.remove();">üè† ‰∏ªÈ°µ - AI‰∏≠ÂåªÈóÆËØä</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/nav', '_blank'); this.parentElement.parentElement.parentElement.remove();">üë§ Áî®Êà∑Ê≥®ÂÜå</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/history', '_blank'); this.parentElement.parentElement.parentElement.remove();">üìã ÂéÜÂè≤ËÆ∞ÂΩï</button>
                        </div>
                        
                        <button style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 500;" onclick="this.parentElement.parentElement.remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', navigationHtml);
        }

        // ÂºÄÂßãÊñ∞ÂØπËØù
        function startNewChat() {
            const choice = confirm('ÂºÄÂßãÊñ∞ÂØπËØùÈÄâÈ°πÔºö\n- Á°ÆÂÆöÔºöÊ∏ÖÁ©∫ÂΩìÂâçÂåªÁîüÁöÑÂØπËØùËÆ∞ÂΩï\n- ÂèñÊ∂àÔºö‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩï‰∏çÂèò');
            if (choice) {
                // Áî®Êà∑ÈÄâÊã©Ê∏ÖÁ©∫ÂΩìÂâçÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                if (selectedDoctor) {
                    const historyKey = `tcm_doctor_history_${selectedDoctor}`;
                    localStorage.removeItem(historyKey);
                    console.log(`Â∑≤Ê∏ÖÁ©∫${selectedDoctor}ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï`);
                }
                generateConversationId();
                
                // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºàÁé∞Âú®ÊòØÁ©∫ÁöÑÔºâ
                if (selectedDoctor) {
                    loadDoctorHistory(selectedDoctor);
                }
            } else {
                // Áî®Êà∑ÈÄâÊã©‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩïÔºå‰ªÄ‰πàÈÉΩ‰∏çÂÅö
                console.log('Áî®Êà∑ÈÄâÊã©‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩï‰∏çÂèò');
                
                // ÈöêËóèËæìÂÖ•Ê°Ü
                const inputContainer = document.querySelector('.input-container');
                if (inputContainer) {
                    inputContainer.classList.remove('show');
                }
            }
        }

        // Â§öÂõæÁâá‰∏ä‰º†ÂäüËÉΩ
        let tongueImage = null;
        let faceImage = null;

        // Ê°åÈù¢Á´Ø - ËàåËØäÂõæÁâá‰∏ä‰º†
        function triggerTongueUpload() {
            document.getElementById('tongueImageUpload').click();
        }

        function handleTongueImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                const uploadArea = document.getElementById('tongueUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <div class="upload-text">ËàåËØäÁÖßÁâáÂ∑≤ÈÄâÊã©</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // Ê°åÈù¢Á´Ø - Èù¢ËØäÂõæÁâá‰∏ä‰º†
        function triggerFaceUpload() {
            document.getElementById('faceImageUpload').click();
        }

        function handleFaceImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                const uploadArea = document.getElementById('faceUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <div class="upload-text">Èù¢ËØäÁÖßÁâáÂ∑≤ÈÄâÊã©</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // ÁßªÂä®Á´Ø - ÊòæÁ§∫ÂõæÁâáÈÄâÊã©ÂºπÁ™óÔºàÂæÆ‰ø°ÂÖºÂÆπ‰ºòÂåñÂ¢ûÂº∫ÁâàÔºâ
        function showMobileImageOptions() {
            console.log('üîÑ Â∞ùËØïÊòæÁ§∫ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó...');
            
            try {
                const modal = document.getElementById('mobileImageModal');
                console.log('üîç ÂºπÁ™óÂÖÉÁ¥†Êü•ÊâæÁªìÊûú:', modal ? 'ÊâæÂà∞' : 'Êú™ÊâæÂà∞');
                
                if (modal) {
                    // ÊñπÊ≥ï1: Á´ãÂç≥ÊòæÁ§∫ÂºπÁ™ó
                    console.log('üì± ÊñπÊ≥ï1: Á´ãÂç≥ÊòæÁ§∫ÂºπÁ™ó');
                    setModalVisible(modal);
                    
                    // ÊñπÊ≥ï2: Âª∂Ëøü100msÂÜçÊ¨°Á°ÆËÆ§ÊòæÁ§∫ÔºàÂ§ÑÁêÜÊ∏≤ÊüìÂª∂ËøüÔºâ
                    setTimeout(() => {
                        console.log('üì± ÊñπÊ≥ï2: Âª∂ËøüÁ°ÆËÆ§ÊòæÁ§∫');
                        const computedStyle = window.getComputedStyle(modal);
                        if (computedStyle.display === 'none') {
                            console.log('‚ö†Ô∏è  ÂºπÁ™ó‰ªçÊú™ÊòæÁ§∫ÔºåÂº∫Âà∂ÊòæÁ§∫');
                            forceShowModal(modal);
                        } else {
                            console.log('‚úÖ ÂºπÁ™óÊòæÁ§∫ÊàêÂäü');
                        }
                    }, 100);
                    
                    // ÊñπÊ≥ï3: ÂæÆ‰ø°ÁéØÂ¢ÉÁâπÊÆäÂ§ÑÁêÜ
                    if (isWeChatBrowser()) {
                        setTimeout(() => {
                            console.log('üì± ÊñπÊ≥ï3: ÂæÆ‰ø°ÁéØÂ¢ÉÁâπÊÆäÂ§ÑÁêÜ');
                            wechatModalFix(modal);
                        }, 200);
                    }
                    
                } else {
                    console.error('‚ùå Êâæ‰∏çÂà∞ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™óÂÖÉÁ¥†Ôºå‰ΩøÁî®fallbackÊñπÊ≥ï');
                    // Fallback: Áõ¥Êé•Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
                    if (confirm('üì∑ ÈÄâÊã©ÂõæÁâáÁ±ªÂûãÔºö\n\nÁ°ÆÂÆö = üëÖ ËàåËØäÁÖßÁâá\nÂèñÊ∂à = üòä Èù¢ËØäÁÖßÁâá')) {
                        console.log('Áî®Êà∑ÈÄâÊã©ËàåËØäÁÖßÁâá');
                        document.getElementById('mobileTongueUpload').click();
                    } else {
                        console.log('Áî®Êà∑ÈÄâÊã©Èù¢ËØäÁÖßÁâá');
                        document.getElementById('mobileFaceUpload').click();
                    }
                }
            } catch (error) {
                console.error('‚ùå ÊòæÁ§∫ÂºπÁ™óÊó∂Âá∫Èîô:', error);
                // ÊúÄÁÆÄÂçïÁöÑfallback
                alert('ÂõæÁâá‰∏ä‰º†ÂäüËÉΩÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï\n\nÈîôËØØ: ' + error.message);
            }
        }
        
        // ËÆæÁΩÆÂºπÁ™óÂèØËßÅÁöÑÊ†∏ÂøÉÂáΩÊï∞
        function setModalVisible(modal) {
            console.log('üéØ ËÆæÁΩÆÂºπÁ™óÊ†∑Âºè...');
            
            // ‰ΩøÁî®CSSÁ±ªÂàáÊç¢ÔºàÊõ¥ÂèØÈù†Ôºâ
            modal.classList.remove('mobile-modal-hidden');
            modal.classList.add('mobile-modal-visible');
            
            // ÂêåÊó∂ËÆæÁΩÆÂÜÖËÅîÊ†∑Âºè‰Ωú‰∏∫ÂèåÈáç‰øùÈô©
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0, 0, 0, 0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
            document.body.style.overflow = 'hidden';
            
            console.log('‚úÖ ÂºπÁ™óÊ†∑ÂºèËÆæÁΩÆÂÆåÊàê - Á±ªÂêçÂíåÂÜÖËÅîÊ†∑ÂºèÂèåÈáçËÆæÁΩÆ');
        }
        
        // Âº∫Âà∂ÊòæÁ§∫ÂºπÁ™ó
        function forceShowModal(modal) {
            console.log('üî• Âº∫Âà∂ÊòæÁ§∫ÂºπÁ™ó');
            
            // ÂÆåÂÖ®ÈáçÁΩÆÊ†∑Âºè
            modal.removeAttribute('style');
            modal.removeAttribute('class');
            
            // ‰ΩøÁî® !important Âº∫Âà∂ÊòæÁ§∫
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.8) !important;
                z-index: 999999 !important;
                justify-content: center !important;
                align-items: center !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            console.log('üî• Âº∫Âà∂Ê†∑ÂºèÂ∫îÁî®ÂÆåÊàê');
        }
        
        // ÂæÆ‰ø°ÁéØÂ¢ÉÁâπÊÆä‰øÆÂ§ç
        function wechatModalFix(modal) {
            console.log('üîß ÂæÆ‰ø°ÁéØÂ¢É‰øÆÂ§ç');
            
            // ÂæÆ‰ø°ÊµèËßàÂô®ÂèØËÉΩÈúÄË¶ÅËß¶ÂèëÈáçÁªò
            modal.style.transform = 'translateZ(0)';
            modal.offsetHeight; // Âº∫Âà∂ÈáçÁªò
            modal.style.transform = '';
            
            // Á°Æ‰øùÂÜÖÂÆπÂÖÉÁ¥†‰πüÂèØËßÅ
            const content = modal.querySelector('.mobile-image-modal-content');
            if (content) {
                content.style.display = 'block';
                content.style.visibility = 'visible';
                content.style.opacity = '1';
                console.log('üîß ÂºπÁ™óÂÜÖÂÆπÂÖÉÁ¥†Ê†∑Âºè‰øÆÂ§çÂÆåÊàê');
            }
        }
        
        // Ê£ÄÊµãÊòØÂê¶‰∏∫ÂæÆ‰ø°ÊµèËßàÂô®
        function isWeChatBrowser() {
            return navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1;
        }

        function closeMobileImageModal() {
            console.log('üîÑ ÂÖ≥Èó≠ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó');
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                // ‰ΩøÁî®CSSÁ±ªÈöêËóè
                modal.classList.remove('mobile-modal-visible');
                modal.classList.add('mobile-modal-hidden');
                
                // ÂêåÊó∂ËÆæÁΩÆÂÜÖËÅîÊ†∑Âºè
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                
                // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
                document.body.style.overflow = 'auto';
                
                console.log('‚úÖ ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
            } else {
                console.error('‚ùå Êú™ÊâæÂà∞ÂºπÁ™óÂÖÉÁ¥†');
            }
        }

        // Ë∞ÉËØïÂáΩÊï∞ÔºöÊ£ÄÊü•ÂºπÁ™óÁä∂ÊÄÅ
        function debugModalState() {
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                console.log('ÂºπÁ™óÂÖÉÁ¥†Â≠òÂú®');
                console.log('ÂºπÁ™ódisplay:', window.getComputedStyle(modal).display);
                console.log('ÂºπÁ™ó‰ΩçÁΩÆ:', modal.getBoundingClientRect());
                console.log('ÂºπÁ™ózIndex:', window.getComputedStyle(modal).zIndex);
                console.log('Â±èÂπïÂ∞∫ÂØ∏:', window.innerWidth + 'x' + window.innerHeight);
            } else {
                console.error('ÂºπÁ™óÂÖÉÁ¥†‰∏çÂ≠òÂú®');
            }
        }

        // ÁßªÂä®Á´Ø - ËàåËØäÂõæÁâá‰∏ä‰º†
        function triggerMobileTongueUpload() {
            closeMobileImageModal();
            document.getElementById('mobileTongueUpload').click();
        }

        function handleMobileTongueUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // ÁßªÂä®Á´Ø - Èù¢ËØäÂõæÁâá‰∏ä‰º†
        function triggerMobileFaceUpload() {
            closeMobileImageModal();
            document.getElementById('mobileFaceUpload').click();
        }

        function handleMobileFaceUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // Êõ¥Êñ∞‰∏ä‰º†Áä∂ÊÄÅÊòæÁ§∫
        function updateUploadStatus() {
            const statusDiv = document.getElementById('uploadStatus');
            const tongueStatus = document.getElementById('tongueStatus').querySelector('span');
            const faceStatus = document.getElementById('faceStatus').querySelector('span');

            tongueStatus.textContent = tongueImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';
            faceStatus.textContent = faceImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';

            if (tongueImage || faceImage) {
                statusDiv.style.display = 'block';
            }
        }

        // Êõ¥Êñ∞ÁßªÂä®Á´Ø‰∏ä‰º†Áä∂ÊÄÅ
        function updateMobileUploadStatus() {
            const mobileTongueStatus = document.getElementById('mobileTongueStatus').querySelector('span');
            const mobileFaceStatus = document.getElementById('mobileFaceStatus').querySelector('span');

            mobileTongueStatus.textContent = tongueImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';
            mobileFaceStatus.textContent = faceImage ? 'Â∑≤‰∏ä‰º†' : 'Êú™‰∏ä‰º†';

            // Êõ¥Êñ∞Ëß¶ÂèëÊåâÈíÆÊñáÊú¨
            const uploadText = document.getElementById('mobileUploadText');
            const uploadedCount = (tongueImage ? 1 : 0) + (faceImage ? 1 : 0);
            if (uploadedCount > 0) {
                uploadText.textContent = `Â∑≤ÈÄâÊã© ${uploadedCount} Âº†ÂõæÁâá`;
            }
        }

        // Â§öÂõæÁâá‰∏ä‰º†Ê†∏ÂøÉÂáΩÊï∞
        async function uploadImages() {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂõæÁâáÈúÄË¶Å‰∏ä‰º†
            if (!tongueImage && !faceImage) {
                return;
            }

            // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                return;
            }

            const formData = new FormData();
            formData.append('conversation_id', currentConversationId);
            
            // Ê†πÊçÆÂõæÁâáÁ±ªÂûãÂàÜÂà´Ê∑ªÂä†
            if (tongueImage) {
                formData.append('tongue_image', tongueImage);
            }
            if (faceImage) {
                formData.append('face_image', faceImage);
            }

            try {
                // ÊûÑÂª∫‰∏ä‰º†ÊèêÁ§∫Ê∂àÊÅØ
                let uploadMessage = 'üì∑ Ê≠£Âú®ÂàÜÊûê';
                if (tongueImage && faceImage) {
                    uploadMessage += 'ËàåËØäÂíåÈù¢ËØäÂõæÁâá...';
                } else if (tongueImage) {
                    uploadMessage += 'ËàåËØäÂõæÁâá...';
                } else if (faceImage) {
                    uploadMessage += 'Èù¢ËØäÂõæÁâá...';
                }
                
                addMessage('user', uploadMessage);
                
                const response = await fetch('/analyze_images', {
                    method: 'POST',
                    body: formData,
                    // Ê∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂
                    signal: AbortSignal.timeout(120000), // 2ÂàÜÈíüË∂ÖÊó∂
                    headers: {
                        // ‰∏çËÆæÁΩÆContent-TypeÔºåËÆ©ÊµèËßàÂô®Ëá™Âä®ËÆæÁΩÆmultipart/form-data
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const analysisResult = `ÂõæÂÉèÂàÜÊûêÁªìÊûúÔºö
${data.analysis_result}`;  
                const shouldShowImageFeedback = containsPrescription(analysisResult);
                addMessage('ai', analysisResult, shouldShowImageFeedback);

                // ÂàÜÊûêÂÆåÊàêÂêéÊ∏ÖÁ©∫ÂõæÁâáÁºìÂ≠òÔºåÂÖÅËÆ∏Áî®Êà∑ÈáçÊñ∞‰∏ä‰º†
                resetImageUploads();

            } catch (error) {
                console.error('üì∑ ÂõæÂÉè‰∏ä‰º†ÂÆåÊï¥ÈîôËØØ‰ø°ÊÅØ:', error);
                
                let errorMessage = 'ÂõæÂÉèÂàÜÊûêÂ§±Ë¥•Ôºö';
                
                if (error.message.includes('502')) {
                    errorMessage += 'ÊúçÂä°Âô®ÊöÇÊó∂Êó†Ê≥ïÂ§ÑÁêÜËØ∑Ê±Ç (502)„ÄÇÂèØËÉΩÂéüÂõ†Ôºö\n';
                    errorMessage += '‚Ä¢ AIÊúçÂä°ÊöÇÊó∂ÁπÅÂøôÔºåËØ∑Á®çÂêéÈáçËØï\n';
                    errorMessage += '‚Ä¢ ÂõæÁâáÂ§ÑÁêÜË∂ÖÊó∂\n';
                    errorMessage += '‚Ä¢ ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                } else if (error.message.includes('timeout')) {
                    errorMessage += 'ËØ∑Ê±ÇË∂ÖÊó∂„ÄÇËØ∑Ê£ÄÊü•Ôºö\n';
                    errorMessage += '‚Ä¢ ÁΩëÁªúËøûÊé•ÊòØÂê¶Á®≥ÂÆö\n';
                    errorMessage += '‚Ä¢ ÂõæÁâáÂ§ßÂ∞èÊòØÂê¶ËøáÂ§ß\n';
                    errorMessage += '‚Ä¢ Á®çÂêéÈáçËØï';
                } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                    errorMessage += 'ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò„ÄÇËØ∑Ê£ÄÊü•Ôºö\n';
                    errorMessage += '‚Ä¢ ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n';
                    errorMessage += '‚Ä¢ ÊòØÂê¶‰ΩøÁî®‰∫Ü‰ª£ÁêÜÊàñVPN\n';
                    errorMessage += '‚Ä¢ Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï';
                } else {
                    errorMessage += error.message;
                }
                
                // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØÔºà‰ªÖÂú®ÂºÄÂèëÁéØÂ¢ÉÊòæÁ§∫Ôºâ
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    errorMessage += `\n\n[Ë∞ÉËØï‰ø°ÊÅØ]\nÂØπËØùID: ${currentConversationId}\nÈîôËØØÁ±ªÂûã: ${error.constructor.name}\nÊó∂Èó¥: ${new Date().toLocaleString()}`;
                }
                
                addMessage('ai', errorMessage);
                
                // ÈáçÁΩÆ‰∏ä‰º†Áä∂ÊÄÅÔºåÂÖÅËÆ∏Áî®Êà∑ÈáçËØï
                resetImageUploads();
            }
        }

        // ÈáçÁΩÆÂõæÁâá‰∏ä‰º†Áä∂ÊÄÅ
        function resetImageUploads() {
            tongueImage = null;
            faceImage = null;
            
            // ÈáçÁΩÆÊ°åÈù¢Á´ØÁïåÈù¢
            const tongueUploadArea = document.getElementById('tongueUploadArea');
            const faceUploadArea = document.getElementById('faceUploadArea');
            
            if (tongueUploadArea) {
                tongueUploadArea.classList.remove('has-file');
                tongueUploadArea.innerHTML = `
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">ÁÇπÂáª‰∏ä‰º†ËàåËØäÁÖßÁâá</div>
                `;
            }
            
            if (faceUploadArea) {
                faceUploadArea.classList.remove('has-file');
                faceUploadArea.innerHTML = `
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">ÁÇπÂáª‰∏ä‰º†Èù¢ËØäÁÖßÁâá</div>
                `;
            }

            // ÈöêËóè‰∏ä‰º†Áä∂ÊÄÅ
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }

            // ÈáçÁΩÆÁßªÂä®Á´ØÊåâÈíÆÊñáÊú¨
            const uploadText = document.getElementById('mobileUploadText');
            if (uploadText) {
                uploadText.textContent = '‰∏ä‰º†ËàåËãîÂíåÈù¢Ë±°ÁÖßÁâá';
            }
        }

        // ‰øùÁïôÂéüuploadImageÂáΩÊï∞‰Ωú‰∏∫ÂÖºÂÆπÊÄßÊîØÊåÅÔºàÂ∑≤Â∫üÂºÉ‰ΩøÁî®Ôºâ
        async function uploadImage(file) {
            console.warn('uploadImageÂáΩÊï∞Â∑≤Â∫üÂºÉÔºåËØ∑‰ΩøÁî®uploadImagesÂáΩÊï∞');
            // ÂèØÈÄâÔºö‰∏∫‰∫ÜÂÖºÂÆπÊÄßÔºåÂ∞ÜÂçïÂõæÁâáËΩ¨Êç¢‰∏∫Â§öÂõæÁâáÊ®°Âºè
            tongueImage = file; // ÂÅáËÆæÂçïÂõæÁâáÈªòËÆ§‰∏∫ËàåËØä
            uploadImages();
        }

        // ËØ≠Èü≥ÂäüËÉΩ
        function toggleVoiceRecording() {
            if (isVoiceRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        async function startVoiceRecording() {
                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processVoiceInput(audioBlob);
                };

                mediaRecorder.start();
                isVoiceRecording = true;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = 'ÂÅúÊ≠¢ÂΩïÈü≥';
                voiceBtn.classList.add('recording');

            } catch (error) {
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && isVoiceRecording) {
                mediaRecorder.stop();
                isVoiceRecording = false;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = 'ÂºÄÂßãËØ≠Èü≥ËæìÂÖ•';
                voiceBtn.classList.remove('recording');
            }
        }

        async function processVoiceInput(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'voice.webm');

                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/speech_to_text', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.text) {
                    document.getElementById('messageInput').value = data.text;
                    adjustTextareaHeight();
                }

            } catch (error) {
                addMessage('ai', `ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•Ôºö${error.message}`);
            }
        }

        // ËØ≠Èü≥ÂêàÊàê
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
            }
        }

        
        // Ê£ÄÊµãÂõûÂ§çÊòØÂê¶ÂåÖÂê´Â§ÑÊñπ
        function containsPrescription(text) {
            // Èò≤Ê≠¢undefinedÈîôËØØ
            if (!text || typeof text !== 'string') {
                console.warn('containsPrescription: Êó†ÊïàÁöÑÊñáÊú¨ÂèÇÊï∞', text);
                return false;
            }
            
            // Â§ÑÊñπÂÖ≥ÈîÆËØçÊ£ÄÊµã
            const prescriptionKeywords = [
                'Â§ÑÊñπ', 'ÊñπÂâÇ', 'ËçØÊñπ', '‰∏≠ËçØ', 'ÊúçÁî®', 'ÁÖéÊúç', 'ÊØèÊó•', 'ÂÖã', 'g',
                'ÊñπÁî®', 'ÊñπÂèñ', 'ÁªÑÊàê', 'Áî®Ê≥ï', 'Áî®Èáè', 'ÁÖéÁÖÆ', 'ÊúçÊ≥ï',
                'ÂÖöÂèÇ', 'ÈªÑËä™', 'ÂΩìÂΩí', 'ÁôΩÊúØ', 'ËåØËãì', 'ÁîòËçâ', 'ÁîüÂú∞', 'ÁÜüÂú∞',
                'Â∑ùËäé', 'ÁôΩËäç', 'Êü¥ËÉ°', 'ÈªÑËä©', 'ÂçäÂ§è', 'ÈôàÁöÆ', 'Êû≥Â£≥', 'Ê°îÊ¢ó'
            ];
            
            // XMLÊ†ºÂºèÂ§ÑÊñπÊ£ÄÊµã
            const xmlPrescriptionPattern = /<prescription>.*?<\/prescription>/s;
            if (xmlPrescriptionPattern.test(text)) {
                return true;
            }
            
            // Ê†áÂáÜÂ§ÑÊñπÊ†ºÂºèÊ£ÄÊµã
            const standardPrescriptionPattern = /„ÄêÂ§ÑÊñπ„Äë|„ÄêÊñπÂâÇ„Äë|„ÄêËçØÊñπ„Äë|„Äê‰∏≠ËçØÂ§ÑÊñπ„Äë/;
            if (standardPrescriptionPattern.test(text)) {
                return true;
            }
            
            // ÂÖ≥ÈîÆËØçÁªÑÂêàÊ£ÄÊµã - Ëá≥Â∞ëÂåÖÂê´2‰∏™Â§ÑÊñπÁõ∏ÂÖ≥ËØçÊ±á
            let keywordCount = 0;
            for (const keyword of prescriptionKeywords) {
                if (text.includes(keyword)) {
                    keywordCount++;
                }
            }
            
            return keywordCount >= 2;
        }

        // ÂèçÈ¶àËØÑÂàÜ
        function rateFeedback(button, rating) {
            const ratingButtons = button.parentElement.querySelectorAll('.rating-btn');
            ratingButtons.forEach(btn => btn.disabled = true);
            
            button.style.backgroundColor = '#10b981';
            button.style.color = 'white';
            
            submitFeedback(rating);
        }

        async function submitFeedback(rating) {
            // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                return;
            }
            
            try {
                const response = await fetch('/api/review/feedback', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        doctor_id: selectedDoctor,
                        rating: rating,
                        feedback_type: 'consultation',
                        user_id: currentUser ? currentUser.id : null,
                        timestamp: new Date().toISOString()
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`ÊÑüË∞¢ÊÇ®ÁöÑ${rating}ÊòüËØÑ‰ª∑ÔºÅ`, 'success');
                } else {
                    console.error('ÂèçÈ¶àÊèê‰∫§Â§±Ë¥•:', result.message);
                }
                
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // ===================== ËÆ§ËØÅÁ≥ªÁªü =====================
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });

        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        function checkLoginStatus() {
            // ÊåâËßíËâ≤Ê£ÄÊü•token
            const patientToken = localStorage.getItem('patientToken');
            const doctorToken = localStorage.getItem('doctorToken');
            const adminToken = localStorage.getItem('adminToken');
            const userToken = localStorage.getItem('userToken');
            
            // ‰ºòÂÖà‰ΩøÁî®ËßíËâ≤‰∏ìÁî®tokenÔºåÁÑ∂ÂêéfallbackÂà∞ÈÄöÁî®token
            const token = patientToken || doctorToken || adminToken || userToken;
            const userData = localStorage.getItem('userData');
            
            if (token) {
                // Â¶ÇÊûúÊúâtoken‰ΩÜÊ≤°ÊúâÁî®Êà∑Êï∞ÊçÆÔºåÂ∞ùËØïÈ™åËØÅtoken
                if (!userData) {
                    verifyTokenAndLoadUserData(token);
                } else {
                    try {
                        currentUser = JSON.parse(userData);
                        userToken = token;
                        updateUserInterface(true);
                    } catch (e) {
                        console.error('Áî®Êà∑Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', e);
                        verifyTokenAndLoadUserData(token);
                    }
                }
            } else {
                updateUserInterface(false);
            }
        }
        
        // È™åËØÅtokenÂπ∂Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
        async function verifyTokenAndLoadUserData(token) {
            try {
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        currentUser = data.user;
                        userToken = token;
                        localStorage.setItem('userData', JSON.stringify(currentUser));
                        updateUserInterface(true);
                        return;
                    }
                }
                
                // tokenÊó†ÊïàÔºåÊ∏ÖÈô§Êï∞ÊçÆ
                clearUserData();
            } catch (error) {
                console.error('È™åËØÅtokenÂ§±Ë¥•:', error);
                clearUserData();
            }
        }

        // Êõ¥Êñ∞Áî®Êà∑ÁïåÈù¢
        function updateUserInterface(isLoggedIn) {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (isLoggedIn && currentUser) {
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                
                // Â§ÑÁêÜÁî®Êà∑ÊòæÁ§∫ÂêçÁß∞
                let displayName = 'Áî®Êà∑';
                if (currentUser.username) {
                    displayName = currentUser.username;
                } else if (currentUser.name) {
                    displayName = currentUser.name;
                } else if (currentUser.phone) {
                    displayName = currentUser.phone;
                } else if (currentUser.user_id) {
                    // Â∞Üuser_idËΩ¨Êç¢‰∏∫ÂèãÂ•ΩÁöÑÊòæÁ§∫ÂêçÁß∞
                    if (currentUser.user_id.includes('patient')) {
                        displayName = 'ÊÇ£ËÄÖÁî®Êà∑';
                    } else if (currentUser.user_id.includes('doctor')) {
                        displayName = 'ÂåªÁîüÁî®Êà∑';
                    } else if (currentUser.user_id.includes('admin')) {
                        displayName = 'ÁÆ°ÁêÜÂëò';
                    } else {
                        displayName = currentUser.user_id;
                    }
                }
                
                userName.textContent = displayName;
                userAvatar.textContent = displayName.charAt(0).toUpperCase();
                
                console.log('Áî®Êà∑ÁïåÈù¢Êõ¥Êñ∞:', {
                    isLoggedIn,
                    currentUser,
                    displayName
                });
            } else {
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
            }
        }

        // ÊòæÁ§∫ÁôªÂΩïÊ®°ÊÄÅÊ°Ü
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // ÈöêËóèÁôªÂΩïÊ®°ÊÄÅÊ°Ü
        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'none';
        }

        // ÊâßË°åÁôªÂΩï
        async function performLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                errorDiv.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.user) {
                    // ÁôªÂΩïÊàêÂäü
                    currentUser = result.user;
                    userToken = result.token;
                    
                    // ‰øùÂ≠òÂà∞localStorage
                    localStorage.setItem('userData', JSON.stringify(currentUser));
                    localStorage.setItem('userToken', userToken);
                    
                    // Êõ¥Êñ∞ÁïåÈù¢
                    updateUserInterface(true);
                    hideLoginModal();
                    
                    // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                    const welcomeName = currentUser.username || currentUser.name || currentUser.phone || 'Áî®Êà∑';
                    showMessage(`Ê¨¢ËøéÂõûÊù•Ôºå${welcomeName}ÔºÅ`, 'success');
                    
                } else {
                    errorDiv.textContent = result.message || 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('ÁôªÂΩïËØ∑Ê±ÇÂ§±Ë¥•:', error);
                errorDiv.textContent = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                errorDiv.style.display = 'block';
            }
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            currentUser = null;
            userToken = null;
            
            // Ê∏ÖÈô§localStorage
            clearUserData();
            
            // Êõ¥Êñ∞ÁïåÈù¢
            updateUserInterface(false);
            
            // ÊòæÁ§∫ÈÄÄÂá∫Ê∂àÊÅØ
            showMessage('Â∑≤ÂÆâÂÖ®ÈÄÄÂá∫ÁôªÂΩï', 'info');
        }

        // Ê∏ÖÈô§Áî®Êà∑Êï∞ÊçÆ
        function clearUserData() {
            localStorage.removeItem('userData');
            localStorage.removeItem('userToken');
        }

        // ÊòæÁ§∫Ê∂àÊÅØÊèêÁ§∫
        function showMessage(message, type = 'info') {
            // ÂàõÂª∫Ê∂àÊÅØÊèêÁ§∫ÂÖÉÁ¥†
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÈ¢úËâ≤
            switch (type) {
                case 'success':
                    messageDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    messageDiv.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                case 'info':
                default:
                    messageDiv.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                    break;
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // Ëé∑ÂèñËÆ§ËØÅÂ§¥
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            if (userToken) {
                headers['Authorization'] = `Bearer ${userToken}`;
            }
            
            return headers;
        }

        // ===================== ËÆ§ËØÅÁ≥ªÁªüÁªìÊùü =====================

        // ===================== Â§ÑÊñπÁÆ°ÁêÜÁ≥ªÁªü =====================
        
        // ‰ªéÂØπËØùÂéÜÂè≤‰∏≠ÊèêÂèñÁóáÁä∂ÂíåËØäÊñ≠‰ø°ÊÅØ
        function extractConversationSummary() {
            const container = document.getElementById('messagesContainer');
            let symptoms = '';
            let diagnosis = '';
            
            if (container) {
                const messages = container.querySelectorAll('.message');
                const userMessages = [];
                const aiMessages = [];
                
                messages.forEach(messageEl => {
                    const textEl = messageEl.querySelector('.message-text');
                    if (textEl) {
                        const content = textEl.textContent.trim();
                        if (messageEl.classList.contains('user')) {
                            userMessages.push(content);
                        } else if (messageEl.classList.contains('ai')) {
                            aiMessages.push(content);
                        }
                    }
                });
                
                // ÊèêÂèñÁî®Êà∑ÊèèËø∞ÁöÑÁóáÁä∂
                symptoms = userMessages.join(' | ').substring(0, 500); // ÈôêÂà∂ÈïøÂ∫¶
                
                // ÊèêÂèñAIÁöÑËØäÊñ≠‰ø°ÊÅØ
                const lastAiMessage = aiMessages[aiMessages.length - 1] || '';
                if (lastAiMessage.includes('ËØÅÂÄô') || lastAiMessage.includes('ËØäÊñ≠')) {
                    diagnosis = lastAiMessage.substring(0, 300); // ÊèêÂèñËØäÊñ≠‰ø°ÊÅØ
                }
            }
            
            return {
                symptoms: symptoms || 'ÊÇ£ËÄÖÁóáÁä∂ÊèèËø∞',
                diagnosis: diagnosis || 'AI‰∏≠ÂåªËØäÊñ≠'
            };
        }
        
        // Á°ÆËÆ§Â§ÑÊñπÂπ∂ÊîØ‰ªò
        async function confirmPrescription(encodedPrescription) {
            try {
                const prescriptionContent = decodeURIComponent(atob(encodedPrescription));
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
                if (!currentUser || !userToken) {
                    showMessage('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçÁ°ÆËÆ§Â§ÑÊñπ', 'error');
                    showLoginModal();
                    return;
                }
                
                // ÂàõÂª∫Â§ÑÊñπÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
                showPrescriptionConfirmModal(prescriptionContent);
                
            } catch (error) {
                console.error('Â§ÑÊñπÁ°ÆËÆ§Â§±Ë¥•:', error);
                showMessage('Â§ÑÊñπÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•', 'error');
            }
        }

        // ÊòæÁ§∫Â§ÑÊñπÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
        function showPrescriptionConfirmModal(prescriptionContent) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ê®°ÊÄÅÊ°Ü
            let modal = document.getElementById('prescriptionModal');
            if (!modal) {
                // ÂàõÂª∫Â§ÑÊñπÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
                modal = document.createElement('div');
                modal.id = 'prescriptionModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1001;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">üìã Â§ÑÊñπÁ°ÆËÆ§</h3>
                        </div>
                        <div style="padding: 24px;">
                            <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <h4 style="margin: 0 0 12px 0; color: #374151;">Â§ÑÊñπÂÜÖÂÆπÔºö</h4>
                                <div id="prescriptionContent" style="font-family: monospace; white-space: pre-wrap; line-height: 1.6; color: #1f2937;"></div>
                            </div>
                            
                            <div style="background: #fef3c7; border-radius: 8px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0 0 12px 0; color: #92400e;">‚ö†Ô∏è ÈáçË¶ÅÊèêÈÜíÔºö</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 14px;">
                                    <li>Ê≠§‰∏∫AIÁîüÊàêÁöÑÂª∫ËÆÆÂ§ÑÊñπÔºå‰ªÖ‰æõÂèÇËÄÉ</li>
                                    <li>Á°ÆËÆ§Â§ÑÊñπÂ∞ÜËøõÂÖ•ÊîØ‰ªòÊµÅÁ®ãÔºåÊîØ‰ªòÂêéÂèØËÅîÁ≥ª‰ª£ÁÖéÊúçÂä°</li>
                                    <li>Âª∫ËÆÆÂú®‰∏ì‰∏öÂåªÁîüÊåáÂØº‰∏ã‰ΩøÁî®</li>
                                    <li>Â¶ÇÊúâ‰∏çÈÄÇÔºåËØ∑Á´ãÂç≥ÂÅúËçØÂπ∂Â∞±Âåª</li>
                                </ul>
                            </div>
                            
                            <div style="background: #e0f2fe; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px 0; color: #0277bd;">üí∞ Ë¥πÁî®ËØ¥ÊòéÔºö</h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Â§ÑÊñπË¥πÁî®Ôºö</span>
                                    <span style="font-weight: bold;">¬• 50.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>‰ª£ÁÖéË¥πÁî®Ôºö</span>
                                    <span style="font-weight: bold;">¬• 30.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #b3e5fc;">
                                    <span style="font-weight: bold;">ÊÄªËÆ°Ôºö</span>
                                    <span style="font-weight: bold; color: #0277bd; font-size: 18px;">¬• 80.00</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button onclick="hidePrescriptionModal()" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; background: #f9fafb; color: #374151; border-radius: 8px; cursor: pointer;">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="proceedToPayment()" style="flex: 1; padding: 12px; border: none; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    Á°ÆËÆ§Âπ∂ÊîØ‰ªò ¬•80.00
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // Êõ¥Êñ∞Â§ÑÊñπÂÜÖÂÆπ
            const contentDiv = modal.querySelector('#prescriptionContent');
            contentDiv.textContent = prescriptionContent;
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            modal.style.display = 'flex';
        }

        // ÈöêËóèÂ§ÑÊñπÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
        function hidePrescriptionModal() {
            const modal = document.getElementById('prescriptionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ËøõÂÖ•ÊîØ‰ªòÊµÅÁ®ã
        async function proceedToPayment() {
            try {
                // Ëé∑ÂèñÂ§ÑÊñπÂÜÖÂÆπ
                const prescriptionContent = document.getElementById('prescriptionContent').textContent;
                
                // Á°Æ‰øùÁî®Êà∑‰ø°ÊÅØÂ≠òÂú®
                if (!currentUser) {
                    showMessage('Áî®Êà∑‰ø°ÊÅØÁº∫Â§±ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                    return;
                }
                
                // ‰ªéÂØπËØùÂéÜÂè≤‰∏≠ÊèêÂèñÁóáÁä∂ÂíåËØäÊñ≠‰ø°ÊÅØ
                const conversationSummary = extractConversationSummary();
                
                // ÂáÜÂ§áËØ∑Ê±ÇÊï∞ÊçÆ
                const requestData = {
                    patient_id: currentUser.id || currentUser.user_id || 'guest',
                    conversation_id: currentConversationId || generateConversationId(),
                    patient_name: currentUser.username || currentUser.name || 'ÊÇ£ËÄÖ',
                    patient_phone: currentUser.phone || '',
                    symptoms: conversationSummary.symptoms,
                    diagnosis: conversationSummary.diagnosis,
                    ai_prescription: prescriptionContent
                };
                
                // Ë∞ÉËØï‰ø°ÊÅØ
                console.log('ÂèëÈÄÅÂ§ÑÊñπÂàõÂª∫ËØ∑Ê±Ç:', requestData);
                console.log('ËÆ§ËØÅÂ§¥:', getAuthHeaders());
                
                // ÊåâÁÖßÂêéÁ´ØAPIÊ†ºÂºèÂèëÈÄÅÊï∞ÊçÆ
                const response = await fetch('/api/prescription/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
                console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status, response.statusText);
                
                const result = await response.json();
                
                // Ë∞ÉËØï‰ø°ÊÅØ
                console.log('Â§ÑÊñπÂàõÂª∫ÂìçÂ∫î:', result);
                
                if (result.success && result.prescription_id) {
                    // Â§ÑÊñπÂàõÂª∫ÊàêÂäüÔºåËøõÂÖ•ÊîØ‰ªòÊµÅÁ®ã
                    hidePrescriptionModal();
                    showPaymentModal(result.prescription_id, 80.00);
                } else {
                    // ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
                    const errorMsg = result.message || result.detail || 'Â§ÑÊñπÂàõÂª∫Â§±Ë¥•';
                    console.error('Â§ÑÊñπÂàõÂª∫Â§±Ë¥•:', result);
                    showMessage(errorMsg, 'error');
                }
                
            } catch (error) {
                console.error('ÊîØ‰ªòÊµÅÁ®ãÂêØÂä®Â§±Ë¥•:', error);
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁΩëÁªúÈîôËØØ
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showMessage('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ', 'error');
                } else {
                    showMessage(`ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®: ${error.message}`, 'error');
                }
            }
        }

        // Âí®ËØ¢‰∏ì‰∏öÂåªÁîü
        function consultDoctor() {
            if (!currentUser) {
                showMessage('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçÂí®ËØ¢ÂåªÁîü', 'error');
                showLoginModal();
                return;
            }
            
            // Ëé∑ÂèñÂΩìÂâçÂ§ÑÊñπÂÜÖÂÆπ
            const prescriptionElement = document.querySelector('.prescription-content');
            const prescriptionContent = prescriptionElement ? prescriptionElement.textContent : '';
            
            if (!prescriptionContent) {
                showMessage('ËØ∑ÂÖàÁîüÊàêÂ§ÑÊñπÂêéÂÜçÂí®ËØ¢ÂåªÁîü', 'error');
                return;
            }
            
            // ÊòæÁ§∫ÂåªÁîüÂí®ËØ¢ÂØπËØùÊ°Ü
            showDoctorConsultationModal(prescriptionContent);
        }
        
        // ÊòæÁ§∫ÂåªÁîüÂí®ËØ¢ÂØπËØùÊ°Ü
        function showDoctorConsultationModal(prescriptionContent) {
            // ÂàõÂª∫ÂåªÁîüÂí®ËØ¢Ê®°ÊÄÅÊ°Ü
            let modal = document.getElementById('doctorConsultationModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'doctorConsultationModal';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="hideDoctorConsultationModal()">
                        <div class="modal-content doctor-consultation-modal" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3>üí¨ Âí®ËØ¢‰∏ì‰∏öÂåªÁîü</h3>
                                <button class="close-btn" onclick="hideDoctorConsultationModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="consultation-info">
                                    <p>ÊÇ®ÂèØ‰ª•Â∞±‰ª•‰∏ãAIÁîüÊàêÁöÑÂ§ÑÊñπÂí®ËØ¢Êàë‰ª¨ÁöÑ‰∏ì‰∏ö‰∏≠ÂåªÂ∏àÔºö</p>
                                    <div class="prescription-preview">
                                        ${prescriptionContent}
                                    </div>
                                </div>
                                <div class="doctor-list">
                                    <h4>ÈÄâÊã©Âí®ËØ¢ÂåªÁîüÔºö</h4>
                                    <div class="available-doctors">
                                        <div class="doctor-card" onclick="startConsultation('Âº†ÂåªÁîü', 'zhangyi')">
                                            <div class="doctor-avatar">Âº†</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">Âº†ÂåªÁîü</div>
                                                <div class="doctor-specialty">‰∏≠ÂåªÂÜÖÁßë ‚Ä¢ Âú®Á∫ø</div>
                                                <div class="doctor-experience">20Âπ¥ÁªèÈ™å</div>
                                            </div>
                                            <div class="consult-btn">üí¨ Âí®ËØ¢</div>
                                        </div>
                                        <div class="doctor-card" onclick="startConsultation('ÊùéÂåªÁîü', 'liwang')">
                                            <div class="doctor-avatar">Êùé</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">ÊùéÂåªÁîü</div>
                                                <div class="doctor-specialty">‰∏≠ÂåªÂ¶áÁßë ‚Ä¢ Âú®Á∫ø</div>
                                                <div class="doctor-experience">15Âπ¥ÁªèÈ™å</div>
                                            </div>
                                            <div class="consult-btn">üí¨ Âí®ËØ¢</div>
                                        </div>
                                        <div class="doctor-card" onclick="startConsultation('ÁéãÂåªÁîü', 'wanglin')">
                                            <div class="doctor-avatar">Áéã</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">ÁéãÂåªÁîü</div>
                                                <div class="doctor-specialty">‰∏≠ÂåªÂÑøÁßë ‚Ä¢ Âú®Á∫ø</div>
                                                <div class="doctor-experience">18Âπ¥ÁªèÈ™å</div>
                                            </div>
                                            <div class="consult-btn">üí¨ Âí®ËØ¢</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="consultation-notice">
                                    <p><strong>üí° Âí®ËØ¢ËØ¥ÊòéÔºö</strong></p>
                                    <ul>
                                        <li>‰∏ì‰∏öÂåªÁîüÂ∞Ü‰∏∫ÊÇ®Ëß£Á≠îÂ§ÑÊñπÁõ∏ÂÖ≥ÈóÆÈ¢ò</li>
                                        <li>ÂèØ‰ª•ËØ¢ÈóÆËçØÊùêÂäüÊïà„ÄÅÁî®Ê≥ïÁî®ÈáèÁ≠â</li>
                                        <li>ÂåªÁîü‰ºöÊ†πÊçÆÊÇ®ÁöÑÂÖ∑‰ΩìÊÉÖÂÜµË∞ÉÊï¥Â§ÑÊñπ</li>
                                        <li>Âí®ËØ¢Ë¥πÁî®Ôºö50ÂÖÉ/Ê¨°ÔºåÁ∫¶15ÂàÜÈíü</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="hideDoctorConsultationModal()">
                                    ÂèñÊ∂à
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Ê∑ªÂä†Ê†∑Âºè
                if (!document.getElementById('doctorConsultationStyles')) {
                    const styles = document.createElement('style');
                    styles.id = 'doctorConsultationStyles';
                    styles.innerHTML = `
                        .doctor-consultation-modal {
                            width: 90%;
                            max-width: 600px;
                            max-height: 80vh;
                            overflow-y: auto;
                        }
                        .prescription-preview {
                            background: #f8f9fa;
                            border: 1px solid #e9ecef;
                            border-radius: 8px;
                            padding: 15px;
                            margin: 10px 0;
                            font-size: 14px;
                            line-height: 1.6;
                            max-height: 150px;
                            overflow-y: auto;
                        }
                        .available-doctors {
                            display: grid;
                            gap: 10px;
                            margin-top: 10px;
                        }
                        .doctor-card {
                            display: flex;
                            align-items: center;
                            padding: 15px;
                            border: 2px solid #e9ecef;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            background: white;
                        }
                        .doctor-card:hover {
                            border-color: #10b981;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
                            transform: translateY(-2px);
                        }
                        .doctor-avatar {
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 18px;
                            margin-right: 15px;
                        }
                        .doctor-info {
                            flex: 1;
                        }
                        .doctor-name {
                            font-weight: 600;
                            font-size: 16px;
                            margin-bottom: 4px;
                        }
                        .doctor-specialty {
                            color: #10b981;
                            font-size: 14px;
                            margin-bottom: 2px;
                        }
                        .doctor-experience {
                            color: #6b7280;
                            font-size: 12px;
                        }
                        .consult-btn {
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: 500;
                        }
                        .consultation-notice {
                            background: #f0f9ff;
                            border: 1px solid #bae6fd;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        .consultation-notice ul {
                            margin: 8px 0 0 20px;
                        }
                        .consultation-notice li {
                            margin-bottom: 4px;
                            font-size: 14px;
                        }
                    `;
                    document.head.appendChild(styles);
                }
            }
            
            modal.style.display = 'flex';
            showMessage('ËØ∑ÈÄâÊã©ÊÇ®ÊÉ≥Ë¶ÅÂí®ËØ¢ÁöÑÂåªÁîü', 'info');
        }
        
        // ÈöêËóèÂåªÁîüÂí®ËØ¢ÂØπËØùÊ°Ü
        function hideDoctorConsultationModal() {
            const modal = document.getElementById('doctorConsultationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ÂºÄÂßã‰∏éÂåªÁîüÁöÑÂí®ËØ¢
        function startConsultation(doctorName, doctorId) {
            hideDoctorConsultationModal();
            showMessage(`Ê≠£Âú®ËøûÊé•${doctorName}ÔºåËØ∑Á®çÂÄô...`, 'info');
            
            // Ê®°ÊãüËøûÊé•ÂåªÁîü
            setTimeout(() => {
                showMessage(`Â∑≤ÊàêÂäüËøûÊé•${doctorName}ÔºÅÊÇ®ÂèØ‰ª•ÂºÄÂßãÂí®ËØ¢‰∫Ü`, 'success');
                
                // ËøôÈáåÂèØ‰ª•ÈõÜÊàêÁúüÂÆûÁöÑÂåªÁîüÂí®ËØ¢Á≥ªÁªü
                // ÊØîÂ¶ÇÊâìÂºÄËÅäÂ§©Á™óÂè£„ÄÅWebSocketËøûÊé•Á≠â
                showDoctorChatInterface(doctorName, doctorId);
            }, 2000);
        }
        
        // ÊòæÁ§∫ÂåªÁîüËÅäÂ§©ÁïåÈù¢ÔºàÁÆÄÂåñÁâàÊú¨Ôºâ
        function showDoctorChatInterface(doctorName, doctorId) {
            showMessage(`${doctorName}ÔºöÊÇ®Â•ΩÔºÅÊàëÂ∑≤ÁªèÁúãÂà∞ÊÇ®ÁöÑÂ§ÑÊñπÔºåÊúâ‰ªÄ‰πàÈóÆÈ¢òÂèØ‰ª•ÈöèÊó∂ÈóÆÊàë„ÄÇ`, 'info');
            
            // ÂÆûÈôÖÈ°πÁõÆ‰∏≠ËøôÈáåÂ∫îËØ•ÈõÜÊàêÁúüÂÆûÁöÑËÅäÂ§©Á≥ªÁªü
            // ÊØîÂ¶ÇÔºö
            // - WebSocketÂÆûÊó∂ÈÄö‰ø°
            // - ËÅäÂ§©ËÆ∞ÂΩïÂ≠òÂÇ®
            // - Êñá‰ª∂‰º†ËæìÂäüËÉΩ
            // - ËßÜÈ¢ëÈÄöËØùÂäüËÉΩÁ≠â
        }

        // ‰øùÂ≠òÂ§ÑÊñπ
        async function savePrescription(encodedPrescription) {
            try {
                const prescriptionContent = decodeURIComponent(atob(encodedPrescription));
                
                if (!currentUser) {
                    showMessage('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜç‰øùÂ≠òÂ§ÑÊñπ', 'error');
                    showLoginModal();
                    return;
                }
                
                const response = await fetch('/api/prescription/save', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        content: prescriptionContent,
                        doctor_id: selectedDoctor,
                        status: 'saved'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Â§ÑÊñπÂ∑≤‰øùÂ≠òÂà∞ÊÇ®ÁöÑÁóÖÂéÜËÆ∞ÂΩï‰∏≠', 'success');
                } else {
                    showMessage(result.message || 'Â§ÑÊñπ‰øùÂ≠òÂ§±Ë¥•', 'error');
                }
                
            } catch (error) {
                console.error('‰øùÂ≠òÂ§ÑÊñπÂ§±Ë¥•:', error);
                showMessage('‰øùÂ≠òÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // ÊòæÁ§∫ÊîØ‰ªòÊ®°ÊÄÅÊ°Ü
        function showPaymentModal(prescriptionId, amount) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ê®°ÊÄÅÊ°Ü
            let modal = document.getElementById('paymentModal');
            if (!modal) {
                // ÂàõÂª∫ÊîØ‰ªòÊ®°ÊÄÅÊ°Ü
                modal = document.createElement('div');
                modal.id = 'paymentModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1002;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 400px; width: 90%;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; text-align: center;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">üí≥ ÈÄâÊã©ÊîØ‰ªòÊñπÂºè</h3>
                        </div>
                        <div style="padding: 24px;">
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="font-size: 32px; font-weight: bold; color: #3b82f6;">¬• ${amount.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #6b7280;">Â§ÑÊñπË¥πÁî® + ‰ª£ÁÖéÊúçÂä°Ë¥π</div>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <button onclick="payWithAlipay('${prescriptionId}', ${amount})" 
                                        style="width: 100%; padding: 16px; border: 2px solid #1677ff; background: #f0f8ff; color: #1677ff; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üíô ÊîØ‰ªòÂÆùÊîØ‰ªò
                                </button>
                                <button onclick="payWithWechat('${prescriptionId}', ${amount})" 
                                        style="width: 100%; padding: 16px; border: 2px solid #07c160; background: #f0fff4; color: #07c160; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üíö ÂæÆ‰ø°ÊîØ‰ªò
                                </button>
                            </div>
                            
                            <div style="text-align: center;">
                                <button onclick="hidePaymentModal()" 
                                        style="color: #6b7280; background: none; border: none; cursor: pointer; text-decoration: underline; font-size: 14px;">
                                    ÂèñÊ∂àÊîØ‰ªò
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            modal.style.display = 'flex';
        }

        // ÈöêËóèÊîØ‰ªòÊ®°ÊÄÅÊ°Ü
        function hidePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ÊîØ‰ªòÂÆùÊîØ‰ªò
        async function payWithAlipay(prescriptionId, amount) {
            try {
                const response = await fetch('/api/payment/alipay/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        prescription_id: prescriptionId,
                        amount: amount,
                        payment_method: 'alipay'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Ë∑≥ËΩ¨Âà∞ÊîØ‰ªòÂÆùÊîØ‰ªòÈ°µÈù¢
                    hidePaymentModal();
                    showMessage('Ê≠£Âú®Ë∑≥ËΩ¨Âà∞ÊîØ‰ªòÂÆù...', 'info');
                    
                    // Ê®°ÊãüÊîØ‰ªòË∑≥ËΩ¨
                    setTimeout(() => {
                        window.open(result.data.payment_url || '#', '_blank');
                        // ÂºÄÂßãËΩÆËØ¢ÊîØ‰ªòÁä∂ÊÄÅ
                        pollPaymentStatus(result.data.payment_id);
                    }, 1000);
                } else {
                    showMessage(result.message || 'ÊîØ‰ªòÂàõÂª∫Â§±Ë¥•', 'error');
                }
                
            } catch (error) {
                console.error('ÊîØ‰ªòÂÆùÊîØ‰ªòÂ§±Ë¥•:', error);
                showMessage('ÊîØ‰ªòÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // ÂæÆ‰ø°ÊîØ‰ªò
        async function payWithWechat(prescriptionId, amount) {
            try {
                const response = await fetch('/api/payment/wechat/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        prescription_id: prescriptionId,
                        amount: amount,
                        payment_method: 'wechat'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // ÊòæÁ§∫ÂæÆ‰ø°ÊîØ‰ªò‰∫åÁª¥Á†Å
                    hidePaymentModal();
                    showWechatQRCode(result.data.qr_code, result.data.payment_id);
                } else {
                    showMessage(result.message || 'ÊîØ‰ªòÂàõÂª∫Â§±Ë¥•', 'error');
                }
                
            } catch (error) {
                console.error('ÂæÆ‰ø°ÊîØ‰ªòÂ§±Ë¥•:', error);
                showMessage('ÊîØ‰ªòÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // ÊòæÁ§∫ÂæÆ‰ø°ÊîØ‰ªò‰∫åÁª¥Á†Å
        function showWechatQRCode(qrCode, paymentId) {
            let modal = document.getElementById('wechatQRModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'wechatQRModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1003;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 32px; text-align: center; max-width: 350px;">
                        <h3 style="margin: 0 0 20px 0; color: #07c160;">üíö ÂæÆ‰ø°ÊîØ‰ªò</h3>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 100px;">üì±</div>
                            <div style="margin-top: 12px; color: #666; font-size: 14px;">ËØ∑‰ΩøÁî®ÂæÆ‰ø°Êâ´Êèè‰∫åÁª¥Á†ÅÊîØ‰ªò</div>
                        </div>
                        <div style="color: #666; font-size: 12px; margin-bottom: 20px;">
                            ÊîØ‰ªòÂÆåÊàêÂêéÈ°µÈù¢Â∞ÜËá™Âä®Êõ¥Êñ∞
                        </div>
                        <button onclick="hideWechatQRModal()" 
                                style="padding: 8px 20px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            ÂèñÊ∂àÊîØ‰ªò
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂπ∂ÂºÄÂßãËΩÆËØ¢ÊîØ‰ªòÁä∂ÊÄÅ
            modal.style.display = 'flex';
            pollPaymentStatus(paymentId);
        }

        // ÈöêËóèÂæÆ‰ø°ÊîØ‰ªò‰∫åÁª¥Á†Å
        function hideWechatQRModal() {
            const modal = document.getElementById('wechatQRModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ËΩÆËØ¢ÊîØ‰ªòÁä∂ÊÄÅ
        async function pollPaymentStatus(paymentId) {
            const maxAttempts = 60; // ÊúÄÂ§öËΩÆËØ¢60Ê¨° (5ÂàÜÈíü)
            let attempts = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/payment/status/${paymentId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        if (result.data.status === 'paid') {
                            // ÊîØ‰ªòÊàêÂäü
                            hideWechatQRModal();
                            hidePaymentModal();
                            showMessage('ÊîØ‰ªòÊàêÂäüÔºÅÊÇ®ÁöÑÂ§ÑÊñπÂ∑≤Á°ÆËÆ§', 'success');
                            
                            // ÊòæÁ§∫‰ª£ÁÖéÊúçÂä°‰ø°ÊÅØ
                            setTimeout(() => {
                                showDecorationInfo(result.data.prescription_id);
                            }, 2000);
                            
                            return;
                        } else if (result.data.status === 'failed' || result.data.status === 'cancelled') {
                            // ÊîØ‰ªòÂ§±Ë¥•
                            hideWechatQRModal();
                            hidePaymentModal();
                            showMessage('ÊîØ‰ªòÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                            return;
                        }
                    }
                    
                    // ÁªßÁª≠ËΩÆËØ¢
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000); // 5ÁßíÂêéÂÜçÊ¨°ËΩÆËØ¢
                    } else {
                        // Ë∂ÖÊó∂
                        hideWechatQRModal();
                        hidePaymentModal();
                        showMessage('ÊîØ‰ªòË∂ÖÊó∂ÔºåËØ∑ÈáçËØï', 'error');
                    }
                    
                } catch (error) {
                    console.error('ÊîØ‰ªòÁä∂ÊÄÅÊü•ËØ¢Â§±Ë¥•:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    }
                }
            };
            
            // ÂºÄÂßãËΩÆËØ¢
            poll();
        }

        // ÊòæÁ§∫‰ª£ÁÖéÊúçÂä°‰ø°ÊÅØ
        function showDecorationInfo(prescriptionId) {
            showMessage('‰ª£ÁÖéÊúçÂä°Â∑≤ÂêØÂä®ÔºåÊàë‰ª¨Â∞ÜÂú®24Â∞èÊó∂ÂÜÖËÅîÁ≥ªÊÇ®ÂÆâÊéíÈÖçÈÄÅ', 'success');
            
            // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Êõ¥Â§ö‰ª£ÁÖéÊúçÂä°ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
            // ‰æãÂ¶ÇË∑≥ËΩ¨Âà∞ËÆ¢ÂçïÈ°µÈù¢Á≠â
        }

        // ===================== Â§ÑÊñπÁÆ°ÁêÜÁ≥ªÁªüÁªìÊùü =====================

        // ===================== ÂåªÁñóÂÆâÂÖ®‰øùÈöúÁ≥ªÁªü =====================
        
        // Ê£ÄÊü•Ê∂àÊÅØ‰∏≠ÁöÑÂåªÁñóÂÆâÂÖ®ÈóÆÈ¢ò
        function checkMedicalSafety(content) {
            const warnings = [];
            
            // Èò≤Ê≠¢undefinedÈîôËØØ
            if (!content || typeof content !== 'string') {
                console.warn('checkMedicalSafety: Êó†ÊïàÁöÑÂÜÖÂÆπÂèÇÊï∞', content);
                return warnings;
            }
            
            // Ê£ÄÊü•Ë•øËçØÁõ∏ÂÖ≥ÂÜÖÂÆπ
            const westernMedicineKeywords = ['ÈòøÂè∏ÂåπÊûó', 'ÊÑüÂÜíÁÅµ', 'ÊäóÁîüÁ¥†', 'ÈùíÈúâÁ¥†', 'Â§¥Â≠¢', 'Â∏ÉÊ¥õËä¨', 'ÂØπ‰πôÈÖ∞Ê∞®Âü∫ÈÖö'];
            for (const keyword of westernMedicineKeywords) {
                if (content.includes(keyword)) {
                    warnings.push({
                        type: 'western_medicine',
                        message: `Ê£ÄÊµãÂà∞Ë•øËçØÊàêÂàÜ"${keyword}"ÔºåÊú¨Á≥ªÁªü‰ªÖÊèê‰æõ‰∏≠ÂåªËØäÁñóÂª∫ËÆÆ`
                    });
                }
            }
            
            // Ê£ÄÊü•Âç±Èô©ÁóáÁä∂
            const dangerousSymptoms = ['ËÉ∏Áóõ', 'ÂëºÂê∏Âõ∞Èöæ', 'ÊÑèËØÜÊ®°Á≥ä', 'Â§ßÂá∫Ë°Ä', 'È´òÁÉ≠‰∏çÈÄÄ', 'ÂâßÁÉàËÖπÁóõ'];
            for (const symptom of dangerousSymptoms) {
                if (content.includes(symptom)) {
                    warnings.push({
                        type: 'emergency',
                        message: `"${symptom}"ÂèØËÉΩ‰∏∫ÊÄ•ÁóáÔºåÂª∫ËÆÆÁ´ãÂç≥Â∞±Âåª`
                    });
                }
            }
            
            // Ê£ÄÊü•Â≠ïÂ¶áÁ¶ÅÁî®ËçØÊùê
            const pregnancyForbidden = ['Á∫¢Ëä±', 'Ê°É‰ªÅ', 'ÁâõËÜù', 'Â§ßÈªÑ', 'ËäíÁ°ù', 'ÈôÑÂ≠ê', 'ËÇâÊ°Ç'];
            if (content.includes('Â≠ïÂ¶á') || content.includes('ÊÄÄÂ≠ï')) {
                for (const herb of pregnancyForbidden) {
                    if (content.includes(herb)) {
                        warnings.push({
                            type: 'pregnancy_risk',
                            message: `"${herb}"Â≠ïÂ¶áÁ¶ÅÁî®ÔºåËØ∑Ë∞®ÊÖé‰ΩøÁî®`
                        });
                    }
                }
            }
            
            return warnings;
        }

        // ÊòæÁ§∫ÂåªÁñóÂÆâÂÖ®Ë≠¶Âëä
        function showMedicalWarnings(warnings) {
            if (warnings.length === 0) return;
            
            const warningContainer = document.createElement('div');
            warningContainer.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                max-width: 300px;
                z-index: 10001;
                animation: slideInRight 0.3s ease-out;
            `;
            
            warnings.forEach((warning, index) => {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    font-size: 13px;
                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                `;
                
                warningDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span>‚ö†Ô∏è</span>
                        <strong>ÂåªÁñóÂÆâÂÖ®ÊèêÈÜí</strong>
                    </div>
                    <div>${warning.message}</div>
                `;
                
                warningContainer.appendChild(warningDiv);
                
                // Ëá™Âä®ÁßªÈô§Ë≠¶Âëä
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.style.animation = 'slideOutRight 0.3s ease-out';
                        setTimeout(() => {
                            if (warningDiv.parentNode) {
                                warningDiv.parentNode.removeChild(warningDiv);
                            }
                        }, 300);
                    }
                }, 8000 + index * 1000); // ÈîôÂºÄÁßªÈô§Êó∂Èó¥
            });
            
            document.body.appendChild(warningContainer);
            
            // ÂÆπÂô®Ëá™Ê∏ÖÁêÜ
            setTimeout(() => {
                if (warningContainer.parentNode && warningContainer.children.length === 0) {
                    warningContainer.parentNode.removeChild(warningContainer);
                }
            }, 15000);
        }

        // ËÆ∞ÂΩïÂÆâÂÖ®‰∫ã‰ª∂
        async function logSecurityEvent(eventType, content, details = {}) {
            try {
                const response = await fetch('/api/security/log-event', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        event_type: eventType,
                        content: content,
                        details: details,
                        user_id: currentUser ? currentUser.id : null,
                        conversation_id: currentConversationId,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('ÂÆâÂÖ®‰∫ã‰ª∂ËÆ∞ÂΩïÂ§±Ë¥•:', result.message);
                }
                
            } catch (error) {
                console.error('ÂÆâÂÖ®‰∫ã‰ª∂ËÆ∞ÂΩïÂ§±Ë¥•:', error);
            }
        }

        // Ê£ÄÊü•ÁóáÁä∂ÁºñÈÄ†
        function detectSymptomFabrication(userInput, aiResponse) {
            // Èò≤Ê≠¢undefinedÈîôËØØ
            if (!userInput || typeof userInput !== 'string' || !aiResponse || typeof aiResponse !== 'string') {
                console.warn('detectSymptomFabrication: Êó†ÊïàÁöÑÂèÇÊï∞', {userInput, aiResponse});
                return;
            }
            
            // Ê£ÄÊü•AIÊòØÂê¶Ê∑ªÂä†‰∫ÜÁî®Êà∑Êú™ÊèêÂèäÁöÑÁóáÁä∂ÔºàÊô∫ËÉΩÊ£ÄÊµãÔºâ
            const userSymptoms = extractSymptomsFromText(userInput);
            const aiSymptoms = extractSymptomsFromText(aiResponse);
            
            // ‰ΩøÁî®Êô∫ËÉΩÂÖ≥ËÅîÊÄßÊ£ÄÊü•ÔºåËøáÊª§ÊéâÂåªÂ≠¶‰∏äÂêàÁêÜÁöÑÁóáÁä∂
            const fabricatedSymptoms = aiSymptoms.filter(symptom => 
                !isSymptomsRelated(userSymptoms, symptom)
            );
            
            // Âè™ÊúâÂΩìAIÊ∑ªÂä†‰∫ÜÊòéÊòæ‰∏çÁõ∏ÂÖ≥ÁöÑÁóáÁä∂Êó∂ÊâçÊä•Ë≠¶
            if (fabricatedSymptoms.length > 0 && userSymptoms.length > 0) {
                // ËÆ°ÁÆóÁºñÈÄ†ÁóáÁä∂ÁöÑÊØî‰æãÔºåÈÅøÂÖçËØØÊä•
                const fabricationRatio = fabricatedSymptoms.length / aiSymptoms.length;
                
                // Âè™ÊúâÂΩìÁºñÈÄ†ÊØî‰æãË∂ÖËøá50%‰∏îÁî®Êà∑ÊòéÁ°ÆÊèèËø∞‰∫ÜÁóáÁä∂Êó∂ÊâçÊä•Ë≠¶
                if (fabricationRatio > 0.5) {
                    logSecurityEvent('symptom_fabrication', aiResponse, {
                        user_symptoms: userSymptoms,
                        ai_symptoms: aiSymptoms,
                        fabricated: fabricatedSymptoms,
                        fabrication_ratio: fabricationRatio
                    });
                    
                    showMedicalWarnings([{
                        type: 'symptom_fabrication',
                        message: `AIÂèØËÉΩÊ∑ªÂä†‰∫ÜÊÇ®Êú™ÊèèËø∞ÁöÑÁóáÁä∂ÔºåËØ∑Ê†∏ÂÆû: ${fabricatedSymptoms.join(', ')}`
                    }]);
                }
            }
        }

        // Â¢ûÂº∫ÁâàÊú¨ÁöÑÊ∂àÊÅØÂèëÈÄÅÔºåÊ∑ªÂä†ÂÆâÂÖ®Ê£ÄÊü•
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            // Ê£ÄÊü•Áî®Êà∑ËæìÂÖ•ÁöÑÂÆâÂÖ®ÊÄß
            const userWarnings = checkMedicalSafety(message);
            if (userWarnings.length > 0) {
                showMedicalWarnings(userWarnings);
                // ËÆ∞ÂΩïÂÆâÂÖ®‰∫ã‰ª∂
                userWarnings.forEach(warning => {
                    logSecurityEvent(warning.type, message, warning);
                });
            }
            
            // Ë∞ÉÁî®ÂéüÂßãÂèëÈÄÅÂáΩÊï∞
            return originalSendMessage.call(this);
        };

        // ===================== ÂåªÁñóÂÆâÂÖ®‰øùÈöúÁ≥ªÁªüÁªìÊùü =====================

        // ===================== ÈöèËÆøÊèêÈÜíÁ≥ªÁªü =====================
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÈöèËÆøÊèêÈÜí
        document.addEventListener('DOMContentLoaded', function() {
            checkFollowUpReminders();
        });

        // Ê£ÄÊü•ÈöèËÆøÊèêÈÜí
        async function checkFollowUpReminders() {
            if (!currentUser || !userToken) return;
            
            try {
                const response = await fetch('/api/follow-up/reminders', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    // ÊòæÁ§∫ÈöèËÆøÊèêÈÜí
                    showFollowUpReminders(result.data);
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñÈöèËÆøÊèêÈÜíÂ§±Ë¥•:', error);
            }
        }

        // ÊòæÁ§∫ÈöèËÆøÊèêÈÜí
        function showFollowUpReminders(reminders) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊòæÁ§∫ËøáÊèêÈÜí
            const today = new Date().toDateString();
            const shownToday = localStorage.getItem(`followup_shown_${today}`);
            
            if (shownToday) return;
            
            const reminderContainer = document.createElement('div');
            reminderContainer.id = 'followUpContainer';
            reminderContainer.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                max-width: 350px;
                z-index: 10002;
                animation: slideInRight 0.3s ease-out;
            `;
            
            reminderContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px; padding: 16px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">üîî</span>
                            <strong style="font-size: 16px;">ÈöèËÆøÊèêÈÜí</strong>
                        </div>
                        <button onclick="dismissFollowUpReminders()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px;">√ó</button>
                    </div>
                    
                    <div style="font-size: 14px; line-height: 1.5; margin-bottom: 12px;">
                        ÊÇ®Êúâ <strong>${reminders.length}</strong> Êù°ÈöèËÆøÊèêÈÜí
                    </div>
                    
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${reminders.slice(0, 3).map(reminder => `
                            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 8px; font-size: 13px;">
                                <div style="font-weight: 500; margin-bottom: 4px;">${reminder.title}</div>
                                <div style="opacity: 0.9;">${reminder.message}</div>
                                <div style="font-size: 11px; opacity: 0.8; margin-top: 6px;">
                                    ${new Date(reminder.scheduled_date).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="viewAllFollowUps()" style="flex: 1; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            Êü•ÁúãÂÖ®ÈÉ®
                        </button>
                        <button onclick="scheduleFollowUp()" style="flex: 1; background: white; border: none; color: #059669; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                            Êñ∞Âª∫ÈöèËÆø
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(reminderContainer);
            
            // Ê†áËÆ∞‰ªäÂ§©Â∑≤ÊòæÁ§∫
            localStorage.setItem(`followup_shown_${today}`, 'true');
            
            // 10ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                dismissFollowUpReminders();
            }, 10000);
        }

        // ÂÖ≥Èó≠ÈöèËÆøÊèêÈÜí
        function dismissFollowUpReminders() {
            const container = document.getElementById('followUpContainer');
            if (container) {
                container.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }, 300);
            }
        }

        // Êü•ÁúãÊâÄÊúâÈöèËÆø
        function viewAllFollowUps() {
            dismissFollowUpReminders();
            showFollowUpModal();
        }

        // ÊòæÁ§∫ÈöèËÆøÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
        async function showFollowUpModal() {
            try {
                const response = await fetch('/api/follow-up/list', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('Ëé∑ÂèñÈöèËÆøËÆ∞ÂΩïÂ§±Ë¥•', 'error');
                    return;
                }
                
                createFollowUpModal(result.data || []);
                
            } catch (error) {
                console.error('Ëé∑ÂèñÈöèËÆøËÆ∞ÂΩïÂ§±Ë¥•:', error);
                showMessage('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // ÂàõÂª∫ÈöèËÆøÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
        function createFollowUpModal(followUps) {
            let modal = document.getElementById('followUpModal');
            if (modal) {
                modal.remove();
            }
            
            modal = document.createElement('div');
            modal.id = 'followUpModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1005;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 20px; font-weight: 600;">üîî ÈöèËÆøÁÆ°ÁêÜ</h3>
                        <button onclick="hideFollowUpModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">√ó</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px;">
                                <button onclick="showActiveFollowUps()" id="activeFollowUpsBtn" style="padding: 8px 16px; border: 2px solid #10b981; background: #10b981; color: white; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    ÂæÖÈöèËÆø
                                </button>
                                <button onclick="showCompletedFollowUps()" id="completedFollowUpsBtn" style="padding: 8px 16px; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    Â∑≤ÂÆåÊàê
                                </button>
                            </div>
                            <button onclick="scheduleNewFollowUp()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                                + Êñ∞Âª∫ÈöèËÆø
                            </button>
                        </div>
                        
                        <div id="followUpContainer">
                            ${followUps.length > 0 ? generateFollowUpHTML(followUps) : '<div style="text-align: center; color: #6b7280; padding: 40px;">ÊöÇÊó†ÈöèËÆøËÆ∞ÂΩï</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ÁîüÊàêÈöèËÆøËÆ∞ÂΩïHTML
        function generateFollowUpHTML(followUps) {
            return followUps.map(followUp => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px;">${followUp.title}</h4>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 13px;">ÈöèËÆøÊó∂Èó¥: ${new Date(followUp.scheduled_date).toLocaleString()}</p>
                        </div>
                        <span style="padding: 4px 12px; background: ${followUp.status === 'completed' ? '#dcfce7' : followUp.status === 'overdue' ? '#fee2e2' : '#fef3c7'}; color: ${followUp.status === 'completed' ? '#166534' : followUp.status === 'overdue' ? '#dc2626' : '#92400e'}; border-radius: 12px; font-size: 12px;">
                            ${followUp.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : followUp.status === 'overdue' ? 'Â∑≤ÈÄæÊúü' : 'ÂæÖÈöèËÆø'}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 12px; font-size: 14px; color: #374151;">
                        ${followUp.message}
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        ${followUp.status === 'pending' ? `
                            <button onclick="completeFollowUp('${followUp.id}')" style="padding: 6px 12px; background: #dcfce7; border: 1px solid #10b981; border-radius: 6px; font-size: 12px; cursor: pointer; color: #059669;">
                                Ê†áËÆ∞ÂÆåÊàê
                            </button>
                            <button onclick="postponeFollowUp('${followUp.id}')" style="padding: 6px 12px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; font-size: 12px; cursor: pointer; color: #d97706;">
                                Âª∂ÊúüÈöèËÆø
                            </button>
                        ` : ''}
                        <button onclick="viewFollowUpDetail('${followUp.id}')" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; color: #374151;">
                            Êü•ÁúãËØ¶ÊÉÖ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ÈöêËóèÈöèËÆøÊ®°ÊÄÅÊ°Ü
        function hideFollowUpModal() {
            const modal = document.getElementById('followUpModal');
            if (modal) {
                modal.remove();
            }
        }

        // Êñ∞Âª∫ÈöèËÆø
        function scheduleFollowUp() {
            dismissFollowUpReminders();
            scheduleNewFollowUp();
        }

        // ÂÆâÊéíÊñ∞ÈöèËÆø
        function scheduleNewFollowUp() {
            // ÁÆÄÂåñÁâàÊñ∞Âª∫ÈöèËÆøÂØπËØùÊ°Ü
            const title = prompt('ËØ∑ËæìÂÖ•ÈöèËÆøÊ†áÈ¢ò:', 'ËçØÁâ©ÁñóÊïàË∑üË∏™');
            if (!title) return;
            
            const days = prompt('Âá†Â§©ÂêéÈöèËÆø? (ËæìÂÖ•Â§©Êï∞)', '7');
            if (!days || isNaN(days)) return;
            
            const message = prompt('ÈöèËÆøÊèêÈÜíÂÜÖÂÆπ:', 'ËØ∑ÈóÆÁî®ËçØÂêéÁóáÁä∂ÊòØÂê¶ÊúâÊâÄÊîπÂñÑÔºüÊòØÂê¶Êúâ‰∏çÈÄÇÂèçÂ∫îÔºü');
            if (!message) return;
            
            createFollowUpReminder(title, parseInt(days), message);
        }

        // ÂàõÂª∫ÈöèËÆøÊèêÈÜí
        async function createFollowUpReminder(title, days, message) {
            try {
                const response = await fetch('/api/follow-up/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        title: title,
                        message: message,
                        days_after: days,
                        doctor_id: selectedDoctor,
                        related_consultation_id: currentConversationId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`ÈöèËÆøÊèêÈÜíÂ∑≤ËÆæÁΩÆÔºåÂ∞ÜÂú®${days}Â§©ÂêéÊèêÈÜí`, 'success');
                    // Â¶ÇÊûúÈöèËÆøÊ®°ÊÄÅÊ°ÜÊâìÂºÄÔºåÂà∑Êñ∞ÂÜÖÂÆπ
                    const modal = document.getElementById('followUpModal');
                    if (modal) {
                        showFollowUpModal(); // ÈáçÊñ∞Âä†ËΩΩ
                    }
                } else {
                    showMessage(result.message || 'ËÆæÁΩÆÈöèËÆøÊèêÈÜíÂ§±Ë¥•', 'error');
                }
                
            } catch (error) {
                console.error('ÂàõÂª∫ÈöèËÆøÊèêÈÜíÂ§±Ë¥•:', error);
                showMessage('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // ÂÆåÊàêÈöèËÆø
        async function completeFollowUp(followUpId) {
            try {
                const response = await fetch(`/api/follow-up/${followUpId}/complete`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('ÈöèËÆøÂ∑≤Ê†áËÆ∞ÂÆåÊàê', 'success');
                    showFollowUpModal(); // Âà∑Êñ∞ÂàóË°®
                } else {
                    showMessage(result.message || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
                
            } catch (error) {
                console.error('ÂÆåÊàêÈöèËÆøÂ§±Ë¥•:', error);
                showMessage('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // Âª∂ÊúüÈöèËÆø
        async function postponeFollowUp(followUpId) {
            const days = prompt('Âª∂ÊúüÂá†Â§©?', '3');
            if (!days || isNaN(days)) return;
            
            try {
                const response = await fetch(`/api/follow-up/${followUpId}/postpone`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        postpone_days: parseInt(days)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`ÈöèËÆøÂ∑≤Âª∂Êúü${days}Â§©`, 'success');
                    showFollowUpModal(); // Âà∑Êñ∞ÂàóË°®
                } else {
                    showMessage(result.message || 'Âª∂ÊúüÂ§±Ë¥•', 'error');
                }
                
            } catch (error) {
                console.error('Âª∂ÊúüÈöèËÆøÂ§±Ë¥•:', error);
                showMessage('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®', 'error');
            }
        }

        // Êü•ÁúãÈöèËÆøËØ¶ÊÉÖ
        function viewFollowUpDetail(followUpId) {
            showMessage('ÈöèËÆøËØ¶ÊÉÖÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }

        // ÊòæÁ§∫ÂæÖÈöèËÆø
        async function showActiveFollowUps() {
            updateFollowUpFilter('active');
            const response = await fetch('/api/follow-up/list?status=pending', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateFollowUpContainer(result.data || []);
        }

        // ÊòæÁ§∫Â∑≤ÂÆåÊàêÈöèËÆø
        async function showCompletedFollowUps() {
            updateFollowUpFilter('completed');
            const response = await fetch('/api/follow-up/list?status=completed', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateFollowUpContainer(result.data || []);
        }

        // Êõ¥Êñ∞ÈöèËÆøËøáÊª§Âô®Ê†∑Âºè
        function updateFollowUpFilter(type) {
            const buttons = ['activeFollowUpsBtn', 'completedFollowUpsBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((type === 'active' && btnId === 'activeFollowUpsBtn') ||
                        (type === 'completed' && btnId === 'completedFollowUpsBtn')) {
                        btn.style.background = '#10b981';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#10b981';
                    }
                }
            });
        }

        // Êõ¥Êñ∞ÈöèËÆøÂÆπÂô®
        function updateFollowUpContainer(followUps) {
            const container = document.getElementById('followUpContainer');
            if (container) {
                container.innerHTML = followUps.length > 0 ? generateFollowUpHTML(followUps) : '<div style="text-align: center; color: #6b7280; padding: 40px;">ÊöÇÊó†Áõ∏ÂÖ≥ËÆ∞ÂΩï</div>';
            }
        }

        // ===================== ÈöèËÆøÊèêÈÜíÁ≥ªÁªüÁªìÊùü =====================

        // ===================== Â§öËÆæÂ§á‰ºöËØùÂêåÊ≠•Á≥ªÁªü =====================
        
        let syncInterval = null;
        let lastSyncTime = 0;
        let isInitialSync = true;
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂêØÂä®ÂêåÊ≠•
        document.addEventListener('DOMContentLoaded', function() {
            if (currentUser && userToken) {
                startSessionSync();
            }
        });

        // ÂêØÂä®‰ºöËØùÂêåÊ≠•
        function startSessionSync() {
            if (!currentUser || !userToken) return;
            
            // È¶ñÊ¨°ÂêåÊ≠•
            syncSessionFromServer();
            
            // ËÆæÁΩÆÂÆöÊúüÂêåÊ≠• (ÊØè30Áßí)
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(() => {
                syncSessionFromServer();
            }, 30000); // 30ÁßíÂêåÊ≠•‰∏ÄÊ¨°
            
            // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂ÂêåÊ≠•
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && currentUser) {
                    syncSessionFromServer();
                }
            });
        }

        // ÂÅúÊ≠¢‰ºöËØùÂêåÊ≠•
        function stopSessionSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // ‰ªéÊúçÂä°Âô®ÂêåÊ≠•‰ºöËØùÁä∂ÊÄÅ
        async function syncSessionFromServer() {
            try {
                const response = await fetch('/api/session/sync', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        doctor_id: selectedDoctor,
                        last_sync_time: lastSyncTime,
                        device_info: getDeviceInfo()
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    handleSyncData(result.data);
                    lastSyncTime = Date.now();
                }
                
            } catch (error) {
                console.error('‰ºöËØùÂêåÊ≠•Â§±Ë¥•:', error);
            }
        }

        // Â§ÑÁêÜÂêåÊ≠•Êï∞ÊçÆ
        function handleSyncData(syncData) {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞Ê∂àÊÅØ
            if (syncData.new_messages && syncData.new_messages.length > 0) {
                syncData.new_messages.forEach(message => {
                    if (isInitialSync) return; // È¶ñÊ¨°ÂêåÊ≠•‰∏çÊòæÁ§∫ÈÄöÁü•
                    
                    // Ê∑ªÂä†ÂêåÊ≠•ÁöÑÊ∂àÊÅØÂà∞ÁïåÈù¢
                    addSyncedMessage(message);
                });
                
                // ÊòæÁ§∫ÂêåÊ≠•ÈÄöÁü•
                if (!isInitialSync && syncData.new_messages.length > 0) {
                    showSyncNotification(`ÂêåÊ≠•‰∫Ü${syncData.new_messages.length}Êù°Êñ∞Ê∂àÊÅØ`);
                }
            }
            
            // ÂêåÊ≠•ÂåªÁîüÈÄâÊã©
            if (syncData.selected_doctor && syncData.selected_doctor !== selectedDoctor) {
                if (!isInitialSync) {
                    showSyncNotification(`Â∑≤ÂàáÊç¢Âà∞${getDoctorName(syncData.selected_doctor)}`);
                }
                selectedDoctor = syncData.selected_doctor;
                updateDoctorSelection();
            }
            
            // ÂêåÊ≠•ÂØπËØùID
            if (syncData.conversation_id && syncData.conversation_id !== currentConversationId) {
                currentConversationId = syncData.conversation_id;
                localStorage.setItem('currentConversationId', currentConversationId);
            }
            
            isInitialSync = false;
        }

        // Ê∑ªÂä†ÂêåÊ≠•ÁöÑÊ∂àÊÅØ
        function addSyncedMessage(message) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            // Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶Â∑≤Â≠òÂú®
            const existingMessages = container.querySelectorAll('.message');
            const messageExists = Array.from(existingMessages).some(msgEl => {
                const timeEl = msgEl.querySelector('.message-time');
                const textEl = msgEl.querySelector('.message-text');
                return timeEl && textEl && 
                       timeEl.textContent === message.time && 
                       textEl.textContent.trim() === message.content.trim();
            });
            
            if (!messageExists) {
                addMessageWithTime(message.sender, message.content, message.time, message.show_feedback);
            }
        }

        // Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØ
        function getDeviceInfo() {
            return {
                user_agent: navigator.userAgent,
                screen_resolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                device_type: window.innerWidth <= 768 ? 'mobile' : 'desktop'
            };
        }

        // Ëé∑ÂèñÂåªÁîüÂêçÁß∞
        function getDoctorName(doctorId) {
            return doctors[doctorId] ? doctors[doctorId].name : 'ÂåªÁîü';
        }

        // ÊòæÁ§∫ÂêåÊ≠•ÈÄöÁü•
        function showSyncNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 13px;
                z-index: 10003;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                animation: syncNotification 3s ease-out forwards;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 12px;">üîÑ</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéÁßªÈô§
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // ÂêåÊ≠•ÂΩìÂâçÁä∂ÊÄÅÂà∞ÊúçÂä°Âô®
        async function syncSessionToServer() {
            if (!currentUser || !userToken) return;
            
            try {
                // Ëé∑ÂèñÂΩìÂâçÊâÄÊúâÊ∂àÊÅØ
                const messages = [];
                const container = document.getElementById('messagesContainer');
                if (container) {
                    container.querySelectorAll('.message').forEach(messageEl => {
                        const isUser = messageEl.classList.contains('user');
                        const textEl = messageEl.querySelector('.message-text');
                        const timeEl = messageEl.querySelector('.message-time');
                        
                        if (textEl && timeEl) {
                            messages.push({
                                sender: isUser ? 'user' : 'ai',
                                content: textEl.textContent.trim(),
                                time: timeEl.textContent,
                                timestamp: Date.now()
                            });
                        }
                    });
                }
                
                const response = await fetch('/api/session/update', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        doctor_id: selectedDoctor,
                        messages: messages,
                        device_info: getDeviceInfo(),
                        sync_time: Date.now()
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('‰ºöËØùÁä∂ÊÄÅ‰∏ä‰º†Â§±Ë¥•:', result.message);
                }
                
            } catch (error) {
                console.error('‰ºöËØùÁä∂ÊÄÅ‰∏ä‰º†Â§±Ë¥•:', error);
            }
        }

        // Â¢ûÂº∫ÂåªÁîüÈÄâÊã©ÔºåÊ∑ªÂä†ÂêåÊ≠•ÂäüËÉΩ
        const originalSelectDoctor = selectDoctor;
        selectDoctor = function(doctorId) {
            originalSelectDoctor.call(this, doctorId);
            
            // ÂêåÊ≠•ÂåªÁîüÈÄâÊã©Âà∞ÊúçÂä°Âô®
            if (currentUser && userToken) {
                syncSessionToServer();
            }
        };

        // Â¢ûÂº∫Ê∂àÊÅØÂèëÈÄÅÔºåÊ∑ªÂä†ÂêåÊ≠•ÂäüËÉΩ
        const originalAddMessage = addMessage;
        addMessage = function(sender, content, showFeedback = false) {
            originalAddMessage.call(this, sender, content, showFeedback);
            
            // ÂêåÊ≠•Êñ∞Ê∂àÊÅØÂà∞ÊúçÂä°Âô®
            if (currentUser && userToken) {
                setTimeout(() => {
                    syncSessionToServer();
                }, 500); // Âª∂Ëøü500msÁ°Æ‰øùDOMÊõ¥Êñ∞ÂÆåÊàê
            }
        };

        // ÁôªÂΩïÊó∂ÂêØÂä®ÂêåÊ≠•
        const originalUpdateUserInterface = updateUserInterface;
        updateUserInterface = function(isLoggedIn) {
            originalUpdateUserInterface.call(this, isLoggedIn);
            
            if (isLoggedIn && currentUser) {
                startSessionSync();
            } else {
                stopSessionSync();
            }
        };

        // È°µÈù¢Âç∏ËΩΩÊó∂ÂÅúÊ≠¢ÂêåÊ≠•
        window.addEventListener('beforeunload', function() {
            stopSessionSync();
            // ÊúÄÂêé‰∏ÄÊ¨°ÂêåÊ≠•
            if (currentUser && userToken) {
                syncSessionToServer();
            }
        });

        // Ê∑ªÂä†CSSÂä®Áîª
        const syncAnimationCSS = `
            @keyframes syncNotification {
                0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                10% { opacity: 1; transform: translateX(-50%) translateY(0); }
                90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            }
        `;
        
        // Ê∑ªÂä†Ê†∑ÂºèÂà∞È°µÈù¢
        const styleSheet = document.createElement('style');
        styleSheet.textContent = syncAnimationCSS;
        document.head.appendChild(styleSheet);

        // ÊòæÁ§∫ÂêåÊ≠•Áä∂ÊÄÅÊåáÁ§∫Âô®
        function createSyncIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'syncIndicator';
            indicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #10b981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
                z-index: 10004;
                animation: pulse 2s infinite;
                display: none;
            `;
            
            // Ê∑ªÂä†ËÑâÂÜ≤Âä®Áîª
            const pulseCSS = `
                @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                    70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
                }
            `;
            
            if (!document.getElementById('pulseStyle')) {
                const pulseStyle = document.createElement('style');
                pulseStyle.id = 'pulseStyle';
                pulseStyle.textContent = pulseCSS;
                document.head.appendChild(pulseStyle);
            }
            
            document.body.appendChild(indicator);
            
            // Èº†Ê†áÊÇ¨ÂÅúÊòæÁ§∫ÊèêÁ§∫
            indicator.title = 'Â§öËÆæÂ§áÂêåÊ≠•Â∑≤ÂêØÁî®';
            
            return indicator;
        }

        // ÊòæÁ§∫/ÈöêËóèÂêåÊ≠•ÊåáÁ§∫Âô®
        function showSyncIndicator() {
            let indicator = document.getElementById('syncIndicator');
            if (!indicator) {
                indicator = createSyncIndicator();
            }
            indicator.style.display = 'block';
        }

        function hideSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // Âú®Áî®Êà∑ÁôªÂΩïÊó∂ÊòæÁ§∫ÂêåÊ≠•ÊåáÁ§∫Âô®
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (currentUser && userToken) {
                    showSyncIndicator();
                }
            }, 1000);
        });

        // ===================== Â§öËÆæÂ§á‰ºöËØùÂêåÊ≠•Á≥ªÁªüÁªìÊùü =====================

        // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜÁ≥ªÁªü
        function saveCurrentDoctorHistory() {
            if (!selectedDoctor) return;
            
            try {
                const messages = [];
                
                // Ê£ÄÊµãÂΩìÂâçÊòØÁßªÂä®Á´ØËøòÊòØPCÁ´Ø
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                
                if (!messagesContainer) {
                    console.warn('Êú™ÊâæÂà∞Ê∂àÊÅØÂÆπÂô®ÔºåË∑≥Ëøá‰øùÂ≠ò');
                    return;
                }
                
                // ÊèêÂèñÊâÄÊúâÊ∂àÊÅØ
                messagesContainer.querySelectorAll('.message').forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    
                    if (textEl && textEl.innerHTML.trim()) {
                        messages.push({
                            type: isUser ? 'user' : 'ai',
                            content: textEl.innerHTML,
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: Date.now()
                        });
                    }
                });
                
                // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÂàô‰∏ç‰øùÂ≠ò
                if (messages.length === 0) {
                    console.log('Ê≤°ÊúâÊ∂àÊÅØÈúÄË¶Å‰øùÂ≠ò');
                    return;
                }
                
                // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÈáèÔºàÈò≤Ê≠¢localStorageÊ∫¢Âá∫Ôºâ
                const maxMessages = 50; // ÊúÄÂ§ö‰øùÂ≠ò50Êù°Ê∂àÊÅØ
                const trimmedMessages = messages.slice(-maxMessages);
                
                // ‰øùÂ≠òÂà∞localStorage
                const historyKey = `tcm_doctor_history_${selectedDoctor}`;
                const dataToSave = JSON.stringify({
                    messages: trimmedMessages,
                    lastUpdated: new Date().toISOString(),
                    doctor: selectedDoctor,
                    version: '2.1', // Â¢ûÂº∫ÁâàÊú¨Âè∑
                    saveCount: (JSON.parse(localStorage.getItem(historyKey) || '{}').saveCount || 0) + 1
                });
                
                // È™åËØÅlocalStorageÂèØÁî®ÊÄß
                if (typeof(Storage) === "undefined") {
                    console.error('ÊµèËßàÂô®‰∏çÊîØÊåÅlocalStorage');
                    return;
                }
                
                localStorage.setItem(historyKey, dataToSave);
                console.log(`‚úÖ Â∑≤‰øùÂ≠ò${selectedDoctor}ÂåªÁîüÁöÑ${trimmedMessages.length}Êù°ÂØπËØùËÆ∞ÂΩï (Á¨¨${JSON.parse(dataToSave).saveCount}Ê¨°‰øùÂ≠ò)`);
                
                // Á´ãÂç≥È™åËØÅ‰øùÂ≠òÊòØÂê¶ÊàêÂäü
                const savedData = localStorage.getItem(historyKey);
                if (!savedData) {
                    console.error('‚ùå ‰øùÂ≠òÈ™åËØÅÂ§±Ë¥•ÔºåÊï∞ÊçÆÊú™Ê≠£Á°ÆÂ≠òÂÇ®');
                    // Â∞ùËØïÈáçÊñ∞‰øùÂ≠ò
                    setTimeout(() => {
                        localStorage.setItem(historyKey, dataToSave);
                        console.log('üîÑ ÈáçËØï‰øùÂ≠òÂÆåÊàê');
                    }, 100);
                } else {
                    console.log('‚úÖ ‰øùÂ≠òÈ™åËØÅÊàêÂäü');
                }
                
                // Ê£ÄÊü•localStorage‰ΩøÁî®ÊÉÖÂÜµ
                checkLocalStorageUsage();
                
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊòØÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÂ∞ùËØïÊ∏ÖÁêÜÊóßËÆ∞ÂΩï
                if (error.name === 'QuotaExceededError') {
                    cleanOldHistoryRecords();
                    // ÈáçËØï‰øùÂ≠òÔºàÂè™‰øùÂ≠òÊúÄËøëÁöÑÊ∂àÊÅØÔºâ
                    try {
                        const recentMessages = messages.slice(-20);
                        const historyKey = `tcm_doctor_history_${selectedDoctor}`;
                        localStorage.setItem(historyKey, JSON.stringify({
                            messages: recentMessages,
                            lastUpdated: new Date().toISOString(),
                            doctor: selectedDoctor,
                            version: '2.0'
                        }));
                        console.log(`Á©∫Èó¥‰∏çË∂≥ÔºåÂ∑≤‰øùÂ≠òÊúÄËøë${recentMessages.length}Êù°ËÆ∞ÂΩï`);
                    } catch (retryError) {
                        console.error('ÈáçËØï‰øùÂ≠ò‰πüÂ§±Ë¥•:', retryError);
                    }
                }
            }
        }
        
        function loadDoctorHistory(doctorKey) {
            const historyKey = `tcm_doctor_history_${doctorKey}`;
            const storedHistory = localStorage.getItem(historyKey);
            
            // Ê£ÄÊµãÂΩìÂâçÊòØÁßªÂä®Á´ØËøòÊòØPCÁ´Ø
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            if (!messagesContainer) return;
            
            // Ê∏ÖÁ©∫ÂΩìÂâçÊ∂àÊÅØ
            messagesContainer.innerHTML = '';
            
            // ÁßªÂä®Á´ØÈúÄË¶ÅÈáçÁΩÆÊ†∑Âºè
            if (isMobile) {
                messagesContainer.style.display = 'block';
                messagesContainer.style.alignItems = 'flex-start';
                messagesContainer.style.justifyContent = 'flex-start';
            }
            
            if (storedHistory) {
                try {
                    let historyData = JSON.parse(storedHistory);
                    let messages = [];
                    
                    // ÂÖºÂÆπÊóßÊ†ºÂºèÂíåÊñ∞Ê†ºÂºè
                    if (Array.isArray(historyData)) {
                        // ÊóßÊ†ºÂºèÔºöÁõ¥Êé•ÊòØÊ∂àÊÅØÊï∞ÁªÑ
                        messages = historyData;
                        console.log(`Âä†ËΩΩ${doctorKey}ÂåªÁîüÁöÑ${messages.length}Êù°ÂéÜÂè≤ËÆ∞ÂΩïÔºàÊóßÊ†ºÂºèÔºâ`);
                    } else if (historyData.messages && Array.isArray(historyData.messages)) {
                        // Êñ∞Ê†ºÂºèÔºöÂåÖÂê´ÂÖÉÊï∞ÊçÆÁöÑÂØπË±°
                        messages = historyData.messages;
                        console.log(`Âä†ËΩΩ${doctorKey}ÂåªÁîüÁöÑ${messages.length}Êù°ÂéÜÂè≤ËÆ∞ÂΩïÔºà${historyData.version || '1.0'}ÁâàÊú¨ÔºåÊúÄÂêéÊõ¥Êñ∞Ôºö${historyData.lastUpdated}Ôºâ`);
                    } else {
                        throw new Error('Êú™Áü•ÁöÑÂéÜÂè≤ËÆ∞ÂΩïÊ†ºÂºè');
                    }
                    
                    // ÊÅ¢Â§çÂéÜÂè≤Ê∂àÊÅØ
                    messages.forEach(msg => {
                        // ÂØπ‰∫éAIÊ∂àÊÅØÔºåÊ£ÄÊµãÊòØÂê¶ÂåÖÂê´Â§ÑÊñπ‰ª•ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ËØÑ‰ª∑Á≥ªÁªü
                        const shouldShowFeedback = msg.type === 'ai' && containsPrescription(msg.content);
                        
                        if (isMobile) {
                            addMobileMessage(msg.type, msg.content, shouldShowFeedback);
                        } else {
                            addMessageWithTime(msg.type, msg.content, msg.time, shouldShowFeedback);
                        }
                    });
                    
                    // Â¶ÇÊûúÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÂú®ÊéßÂà∂Âè∞ÊòæÁ§∫Êõ¥Â§ö‰ø°ÊÅØ
                    if (messages.length > 0) {
                        console.log(`ÂéÜÂè≤ËÆ∞ÂΩïËØ¶ÊÉÖ: Á¨¨‰∏ÄÊù°Ê∂àÊÅØÊó∂Èó¥=${messages[0].time}, ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÊó∂Èó¥=${messages[messages.length-1].time}`);
                    }
                    
                } catch (error) {
                    console.error('Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                    console.log('ÂéüÂßãÊï∞ÊçÆ:', storedHistory.substring(0, 200) + '...');
                    addWelcomeMessage(doctorKey);
                }
            } else {
                // Ê≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                console.log(`${doctorKey}ÂåªÁîüÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ`);
                addWelcomeMessage(doctorKey);
            }
        }
        
        function addWelcomeMessage(doctorKey) {
            const doctor = doctors[doctorKey];
            const isMobile = window.innerWidth <= 768;
            const welcomeMessage = `ÊÇ®Â•ΩÔºÅÊàëÊòØ${doctor.name}Ôºå${doctor.school}‰º†‰∫∫„ÄÇËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÔºåÊàëÂ∞Ü‰∏∫ÊÇ®ËøõË°å‰∏ì‰∏öÁöÑ‰∏≠ÂåªÂàÜÊûê„ÄÇ`;
            
            if (isMobile) {
                addMobileMessage('ai', welcomeMessage);
            } else {
                addMessage('ai', welcomeMessage);
            }
        }
        
        function addMessageWithTime(sender, content, timeStr, showFeedback = false) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'üë§' : (selectedDoctor ? doctors[selectedDoctor].avatar : 'ü§ñ')}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    <div class="message-time">${timeStr}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">Ëøô‰∏™ÂõûÁ≠îÊúâÂ∏ÆÂä©ÂêóÔºü</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">üòä ÂæàÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">üëç ‰∏çÈîô</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">üëå ËøòË°å</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">üëé ‰∏çÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">üòû ÂæàÂ∑Æ</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Âä†ËΩΩÂØπËØùÂéÜÂè≤ - Âü∫‰∫éÁî®Êà∑IDÈöîÁ¶ª
        function loadConversationHistory() {
            const userId = getCurrentUserId();
            const storageKey = `conversationId_${userId}`;
            
            // Â∞ùËØïÂä†ËΩΩÂΩìÂâçÁî®Êà∑ÁöÑÂØπËØùID
            const storedId = localStorage.getItem(storageKey);
            if (storedId) {
                currentConversationId = storedId;
                console.log(`Â∑≤Âä†ËΩΩÁî®Êà∑(${userId})ÁöÑÂØπËØùID: ${currentConversationId}`);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂ≠òÂÇ®ÁöÑIDÔºåÁîüÊàêÊñ∞ÁöÑ
                generateConversationId();
                console.log(`‰∏∫Áî®Êà∑(${userId})ÁîüÊàêÊñ∞ÂØπËØùID: ${currentConversationId}`);
            }
            
            // Â¶ÇÊûúÊúâÈÄâ‰∏≠ÁöÑÂåªÁîüÔºåÂä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩï
            if (selectedDoctor) {
                loadDoctorHistory(selectedDoctor);
            }
        }

        // ÁßªÂä®Á´ØÈ°µÈù¢ÂàáÊç¢
        function showMobileChatPage() {
            if (window.innerWidth <= 768) {
                const container = document.getElementById('mobilePageContainer');
                container.classList.add('show-chat');
                
            }
        }
        
        function showMobileDoctorPage() {
            if (window.innerWidth <= 768) {
                document.getElementById('mobilePageContainer').classList.remove('show-chat');
            }
        }

        // ÁßªÂä®Á´ØÂåªÁîüÈÄâÊã©ÔºàÊîØÊåÅÈªòËÆ§ÂåªÁîüÂíåÊé®ËçêÂåªÁîüÔºâ
        function selectMobileDoctor(doctorKey, doctorData = null) {
            // ‰øùÂ≠òÂΩìÂâçÂåªÁîüÁöÑÂØπËØùÂéÜÂè≤
            if (selectedDoctor && selectedDoctor !== doctorKey) {
                saveCurrentDoctorHistory();
            }
            
            selectedDoctor = doctorKey;
            
            // Ëé∑ÂèñÂåªÁîü‰ø°ÊÅØÔºà‰ºòÂÖà‰ΩøÁî®‰º†ÂÖ•ÁöÑdoctorDataÔºåÁÑ∂ÂêéÊòØÈªòËÆ§doctorsÂØπË±°Ôºâ
            const doctor = doctorData || doctors[doctorKey] || {
                name: 'ÂåªÁîü',
                school: '‰∏≠ÂåªÂ∏à', 
                avatar: 'üë®‚Äç‚öïÔ∏è',
                specialty: '‰∏≠ÂåªÂÜÖÁßë'
            };
            
            // Êõ¥Êñ∞ÁßªÂä®Á´ØÂåªÁîü‰ø°ÊÅØ
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // ÁîüÊàêÊñ∞ÁöÑÂØπËØùIDÔºåÂº∫Âà∂ÂºÄÂßãÊñ∞ÂØπËØù
            generateConversationId();
            
            // Áõ¥Êé•Âä†ËΩΩËØ•ÂåªÁîüÁöÑÂéÜÂè≤ÂØπËØùÔºàloadDoctorHistory‰ºöËá™Âä®Ê∏ÖÁ©∫ÂÆπÂô®Ôºâ
            loadDoctorHistory(doctorKey);
            
            // ÂàáÊç¢Âà∞ËÅäÂ§©È°µÈù¢
            showMobileChatPage();
            
            // Á°Æ‰øùËæìÂÖ•Ê°ÜÂèØËßÅ
            setTimeout(() => ensureMobileInputVisible(), 500);
        }

        // ÁßªÂä®Á´ØÊ∏≤ÊüìÂåªÁîüÂç°ÁâáÔºàÊîØÊåÅÈªòËÆ§ÂåªÁîüÂíåÊé®ËçêÂåªÁîüÔºâ
        function renderMobileDoctorCards(useRecommended = false) {
            const container = document.getElementById('mobileDoctorsGrid');
            container.innerHTML = '';
            
            let doctorsToRender = {};
            
            if (useRecommended && recommendedDoctors.length > 0) {
                // ‰ΩøÁî®Êé®ËçêÂåªÁîüÔºåËΩ¨Êç¢‰∏∫ÁßªÂä®Á´ØÊ†ºÂºè
                recommendedDoctors.forEach(doctor => {
                    const doctorId = doctor.uuid || doctor.name.toLowerCase().replace(/\s+/g, '_');
                    doctorsToRender[doctorId] = {
                        name: doctor.name,
                        school: doctor.title || '‰∏≠ÂåªÂ∏à',
                        avatar: getAvatarForDoctor(doctor.name),
                        specialty: doctor.specialties.join(', ') || '‰∏≠ÂåªÂÜÖÁßë',
                        introduction: doctor.introduction || '',
                        rating: doctor.average_rating,
                        consultationCount: doctor.consultation_count
                    };
                });
                isUsingRecommendedDoctors = true;
            } else {
                // ‰ΩøÁî®ÈªòËÆ§ÂåªÁîü
                doctorsToRender = doctors;
                isUsingRecommendedDoctors = false;
            }

            Object.entries(doctorsToRender).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'mobile-doctor-card';
                card.onclick = () => selectMobileDoctor(key, doctor);
                
                // Ê∑ªÂä†Êé®ËçêÊ†áËØÜÂíåËØÑÂàÜ‰ø°ÊÅØ
                const recommendationBadge = isUsingRecommendedDoctors ? 
                    `<div style="background: #10b981; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 4px; display: inline-block;">AIÊé®Ëçê</div>` : '';
                
                const ratingInfo = doctor.rating ? 
                    `<div style="font-size: 11px; color: #f59e0b; margin-top: 2px;">‚≠ê ${doctor.rating.toFixed(1)} (${doctor.consultationCount || 0}‰æã)</div>` : '';
                
                card.innerHTML = `
                    <div class="mobile-doctor-info">
                        <div class="mobile-doctor-avatar">${doctor.avatar}</div>
                        <div class="mobile-doctor-details">
                            <h3>${doctor.name} ${recommendationBadge}</h3>
                            <div class="school">${doctor.school}</div>
                            ${ratingInfo}
                        </div>
                    </div>
                    <div class="mobile-doctor-specialty">
                        <strong>ÊìÖÈïøÔºö</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Ê∑ªÂä†ÁßªÂä®Á´ØÂàáÊç¢ÊåâÈíÆ
            addMobileDoctorToggleButton(container);
        }

        // Ê∑ªÂä†ÁßªÂä®Á´ØÂåªÁîüÂàáÊç¢ÊåâÈíÆ
        function addMobileDoctorToggleButton(container) {
            const toggleButton = document.createElement('div');
            toggleButton.style.cssText = `
                margin: 10px 16px; 
                text-align: center; 
                padding: 12px;
                background: #f3f4f6; 
                border-radius: 8px; 
                cursor: pointer;
                font-size: 14px;
                color: #374151;
                transition: all 0.2s;
                font-weight: 500;
            `;
            toggleButton.innerHTML = isUsingRecommendedDoctors ? 
                'üîÑ ÂàáÊç¢Âà∞ÁªèÂÖ∏ÂêçÂåª' : 'ü§ñ ‰ΩøÁî®AIÊé®ËçêÂåªÁîü';
                
            toggleButton.onclick = () => {
                renderMobileDoctorCards(!isUsingRecommendedDoctors);
            };
            
            container.appendChild(toggleButton);
        }

        // ÁßªÂä®Á´ØÊ∑ªÂä†Ê∂àÊÅØ
        function addMobileMessage(sender, content, showFeedback = false) {
            const container = document.getElementById('mobileMessagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Ê†ºÂºèÂåñAIÂõûÂ§çÂÜÖÂÆπÔºå‰øùÊåÅÊç¢Ë°åÂíåÊéíÁâà
            let formattedContent = content;
            if (sender === 'ai') {
                formattedContent = content
                    // ÂÖàÂ§ÑÁêÜÊ†áÈ¢òÔºàÂú®Êç¢Ë°åËΩ¨Êç¢ÂâçÔºâ
                    .replace(/### (.*?)(\n|$)/g, '<h4 style="color: #2d5aa0; margin: 15px 0 8px 0; font-size: 16px; font-weight: bold;">$1</h4>\n')
                    .replace(/## (.*?)(\n|$)/g, '<h3 style="color: #2d5aa0; margin: 18px 0 10px 0; font-size: 18px; font-weight: bold;">$1</h3>\n')
                    // Â§ÑÁêÜÂä†Á≤óÊñáÊú¨
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #333; font-weight: bold;">$1</strong>')
                    // Â§ÑÁêÜÂàÜÂâ≤Á∫ø
                    .replace(/---/g, '<hr style="border: none; border-top: 1px solid #e5e7eb; margin: 15px 0;">')
                    // Â§ÑÁêÜË°åÂÜÖ‰ª£Á†Å
                    .replace(/`([^`]+)`/g, '<code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px; font-family: monospace; color: #374151;">$1</code>')
                    // ÊúÄÂêéÂ§ÑÁêÜÊç¢Ë°åÔºàËøôÊ†∑ÂèØ‰ª•‰øùÁïôÊ†áÈ¢òÂêéÁöÑÊç¢Ë°åÔºâ
                    .replace(/\n/g, '<br>')
                    // Â§ÑÁêÜÂàóË°®È°πÔºàÊç¢Ë°åÂêéÂ§ÑÁêÜÔºâ
                    .replace(/<br>(\d+\. )/g, '<br><span style="color: #10b981; font-weight: bold;">$1</span>')
                    .replace(/^(\d+\. )/g, '<span style="color: #10b981; font-weight: bold;">$1</span>')
                    .replace(/<br>(- )/g, '<br><span style="color: #10b981;">‚Ä¢ </span>')
                    .replace(/^(- )/g, '<span style="color: #10b981;">‚Ä¢ </span>');
            }
            
            const messageContent = `
                <div class="message-content">
                    <div class="message-text">${formattedContent}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">Ëøô‰∏™ÂõûÁ≠îÊúâÂ∏ÆÂä©ÂêóÔºü</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">üòä ÂæàÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">üëç ‰∏çÈîô</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">üëå ËøòË°å</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">üëé ‰∏çÂ•Ω</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">üòû ÂæàÂ∑Æ</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            container.appendChild(messageDiv);
            
            // Âπ≥ÊªëÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // Ëá™Âä®‰øùÂ≠òÁßªÂä®Á´ØÂØπËØùÂéÜÂè≤
            if (selectedDoctor) {
                setTimeout(() => saveCurrentDoctorHistory(), 200); // Âª∂Ëøü200msÁ°Æ‰øùDOMÂíåÊªöÂä®ÈÉΩÂÆåÊàê
            }
        }

        // ÁßªÂä®Á´ØÂèëÈÄÅÊ∂àÊÅØ
        async function sendMobileMessage() {
            const input = document.getElementById('mobileMessageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰ΩçÂåªÂ∏à');
                }
                return;
            }

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMobileMessage('user', message);
            input.value = '';
            adjustMobileTextareaHeight();

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const sendBtn = document.getElementById('mobileSendBtn');
            sendBtn.disabled = true;
            
            // Ê∑ªÂä†"Ê≠£Âú®ÂàÜÊûê"ÁöÑ‰∏¥Êó∂Ê∂àÊÅØ
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message ai loading-message';
            loadingMessage.innerHTML = `
                <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f4f6; border-radius: 50%; border-top: 2px solid #667eea; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                AIÊ≠£Âú®ÂàÜÊûêÊÇ®ÁöÑÁóáÁä∂...
            `;
            const container = document.getElementById('mobileMessagesContainer');
            container.appendChild(loadingMessage);
            container.scrollTop = container.scrollHeight;

            // ÂàõÂª∫Â∏¶Ë∂ÖÊó∂ÁöÑAbortController
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 45000); // 45ÁßíË∂ÖÊó∂

                        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // Â§ÑÁêÜÊñ∞ÁöÑAPIÂìçÂ∫îÊ†ºÂºè (ÁßªÂä®Á´Ø)
                let aiReply;
                if (data.success && data.data && data.data.reply) {
                    aiReply = data.data.reply;
                } else if (data.reply) {
                    aiReply = data.reply; // ÂÖºÂÆπÊóßÊ†ºÂºè
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ: Êú™ÊâæÂà∞replyÂ≠óÊÆµ');
                }
                
                if (aiReply) {
                    // Êô∫ËÉΩÂà§Êñ≠ÊòØÂê¶ÊòæÁ§∫ËØÑ‰ª∑Á≥ªÁªü - Âè™ÊúâÂåÖÂê´Â§ÑÊñπÊó∂ÊâçÊòæÁ§∫
                    const shouldShowFeedback = containsPrescription(aiReply);
                    addMobileMessage('ai', aiReply, shouldShowFeedback);
                    
                    // ËÆ∞ÂΩïËØäÊñ≠Èò∂ÊÆµ
                    if (shouldShowFeedback) {
                        console.log('ÁßªÂä®Á´ØÊ£ÄÊµãÂà∞Â§ÑÊñπÂÜÖÂÆπÔºåÊòæÁ§∫ÁÇπËØÑÂäüËÉΩ');
                    } else {
                        console.log('ÁßªÂä®Á´ØÊôÆÈÄöÂØπËØùÔºå‰∏çÊòæÁ§∫ÁÇπËØÑ');
                    }
                } else {
                    addMobileMessage('ai', 'Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïÂõûÁ≠îÊÇ®ÁöÑÈóÆÈ¢òÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
                }
                
                // ‰øùÂ≠òÁßªÂä®Á´ØÂØπËØùÂéÜÂè≤
                setTimeout(() => saveCurrentDoctorHistory(), 100);

            } catch (error) {
                console.error('Mobile API Error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                let errorMsg = 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = 'ÁΩëÁªúËøûÊé•ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÂÜçËØï';
                } else if (error.message.includes('HTTP error')) {
                    errorMsg = `ÊúçÂä°Âô®ÈîôËØØ: ${error.message}`;
                } else {
                    errorMsg = `ËøûÊé•Â§±Ë¥•: ${error.message}`;
                }
                
                addMobileMessage('ai', errorMsg);
            } finally {
                sendBtn.disabled = false;
            }
        }

        // ÁßªÂä®Á´ØËæìÂÖ•Ê°ÜÈ´òÂ∫¶Ë∞ÉÊï¥
        function adjustMobileTextareaHeight() {
            const textarea = document.getElementById('mobileMessageInput');
            if (!textarea) return;
            
            textarea.style.height = '44px'; // ÈáçÁΩÆ‰∏∫ÊúÄÂ∞èÈ´òÂ∫¶
            const newHeight = Math.min(textarea.scrollHeight, 100);
            textarea.style.height = newHeight + 'px';
        }

        // ÁßªÂä®Á´ØÈîÆÁõò‰∫ã‰ª∂
        function handleMobileKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMobileMessage();
            }
        }
        
        
        // ÁßªÂä®Á´ØËæìÂÖ•Ê°ÜÁÑ¶ÁÇπÂ§ÑÁêÜ
        function ensureMobileInputVisible() {
            const input = document.getElementById('mobileMessageInput');
            const container = document.getElementById('mobileMessagesContainer');
            const inputContainer = document.querySelector('.mobile-input-container');
            
            if (container) {
                // ÊªöÂä®Ê∂àÊÅØÂÆπÂô®Âà∞Â∫ïÈÉ®ÔºåÁ°Æ‰øùËæìÂÖ•Ê°ÜÂå∫ÂüüÂèØËßÅ
                container.scrollTop = container.scrollHeight;
            }
            
            if (inputContainer) {
                // Á°Æ‰øùËæìÂÖ•ÂÆπÂô®ÂèØËßÅ
                setTimeout(() => {
                    inputContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 200);
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÁßªÂä®Á´Ø
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                renderMobileDoctorCards();
                // ÁßªÂä®Á´Ø‰∏çËÆæÁΩÆÈªòËÆ§ÂåªÁîüÔºåËÆ©Áî®Êà∑‰∏ªÂä®ÈÄâÊã©
                // setMobileDefaultDoctor('zhang_zhongjing');
                
            }
        });
        
        // ÁßªÂä®Á´ØËÆæÁΩÆÈªòËÆ§ÂåªÁîü
        function setMobileDefaultDoctor(doctorKey) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // Êõ¥Êñ∞ÁßªÂä®Á´ØÂåªÁîü‰ø°ÊÅØ
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // Ê∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØÂà∞ÁßªÂä®Á´Ø
            const mobileContainer = document.getElementById('mobileMessagesContainer');
            if (mobileContainer && !mobileContainer.querySelector('.message')) {
                addMobileMessage('ai', `ÊÇ®Â•ΩÔºÅÊàëÊòØ${doctor.name}Ôºå${doctor.school}‰º†‰∫∫„ÄÇËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑÁóáÁä∂ÔºåÊàëÂ∞Ü‰∏∫ÊÇ®ËøõË°å‰∏ì‰∏öÁöÑ‰∏≠ÂåªÂàÜÊûê„ÄÇ`);
            }
        }
    </script>
    
    <!-- ÂºÄÂèëË∞ÉËØï‰ø°ÊÅØÔºà‰ªÖÂºÄÂèëÊ®°ÂºèÊòæÁ§∫Ôºâ -->
    <div id="mobileVersionInfo" style="display: none; position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 20px; font-size: 11px; z-index: 1000; border: 1px solid rgba(255,255,255,0.2);">
        <span style="color: #4fc3f7;">TCM v1.2.4</span> | 
        <a href="/static/wechat_debug.html" style="color: #81c784; text-decoration: none;">ÁΩëÁªúËØäÊñ≠</a> | 
        <a href="javascript:location.reload(true)" style="color: #ffb74d; text-decoration: none;">Âà∑Êñ∞</a> |
        <span style="color: #f48fb1; cursor: pointer;" onclick="this.parentElement.style.display='none'">√ó</span>
    </div>
    
    <script>
        // Ë∞ÉËØïÊ®°ÂºèÊ£ÄÊµã - Âè™ÊúâÂú®ÁâπÂÆöÊù°‰ª∂‰∏ãÊâçÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
        function isDebugMode() {
            // Ê£ÄÊµãURLÂèÇÊï∞„ÄÅÂºÄÂèëÁéØÂ¢ÉÁ≠â
            const urlParams = new URLSearchParams(window.location.search);
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const hasDebugParam = urlParams.has('debug');
            const isDevPort = window.location.port === '7789' || window.location.port === '3000';
            
            return isLocalhost || hasDebugParam || isDevPort;
        }
        
        // Ê∑ªÂä†ÁâπÊÆäÊâãÂäøÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØÁöÑÂäüËÉΩÔºà‰ªÖ‰æõÂºÄÂèëË∞ÉËØïÔºâ
        let clickSequence = [];
        let debugVisible = false;
        
        document.addEventListener('click', function(e) {
            // ËÆ∞ÂΩïÁÇπÂáª‰ΩçÁΩÆÔºàÂàÜ‰∏∫9ÂÆ´Ê†ºÔºâ
            const x = Math.floor(e.clientX / (window.innerWidth / 3));
            const y = Math.floor(e.clientY / (window.innerHeight / 3));
            const position = y * 3 + x;
            
            clickSequence.push(position);
            if (clickSequence.length > 5) clickSequence.shift();
            
            // ÁâπÊÆäÂ∫èÂàóÔºöÂ∑¶‰∏ä-Âè≥‰∏ä-Â∑¶‰∏ã-Âè≥‰∏ã-‰∏≠ÂøÉ (0-2-6-8-4)
            const debugSequence = [0, 2, 6, 8, 4];
            const isDebugSequence = clickSequence.length === 5 && 
                clickSequence.every((pos, idx) => pos === debugSequence[idx]);
            
            if (isDebugSequence && (isDebugMode() || window.location.hostname.includes('dev'))) {
                debugVisible = !debugVisible;
                document.getElementById('mobileVersionInfo').style.display = debugVisible ? 'block' : 'none';
                clickSequence = [];
                
                if (debugVisible) {
                    setTimeout(() => {
                        document.getElementById('mobileVersionInfo').style.display = 'none';
                        debugVisible = false;
                    }, 10000);
                }
            }
            
            // Ê∏ÖÁ©∫Â∫èÂàó
            setTimeout(() => { clickSequence = []; }, 3000);
        });
        // ÁΩëÁªúÁä∂ÊÄÅÊ£ÄÊµã
        function checkNetworkStatus() {
            if (!navigator.onLine) {
                addMobileMessage('ai', 'üîå Ê£ÄÊµãÂà∞ÁΩëÁªúËøûÊé•‰∏≠Êñ≠ÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËÆæÁΩÆ„ÄÇ');
                return false;
            }
            return true;
        }
        
        // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅÂèòÂåñ
        window.addEventListener('online', function() {
            console.log('Network is back online');
        });
        
        window.addEventListener('offline', function() {
            console.log('Network is offline');
            addMobileMessage('ai', 'üîå ÁΩëÁªúËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËÆæÁΩÆ„ÄÇ');
        });
    </script>

    <!-- ÂæÆ‰ø°ÂàÜ‰∫´Â¢ûÂº∫ËÑöÊú¨ -->
    <script>
        // ÂæÆ‰ø°ÁéØÂ¢ÉÊ£ÄÊµã
        function isWechat() {
            return /MicroMessenger/i.test(navigator.userAgent);
        }
        
        // Ê£ÄÊµãÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Êù•Ê∫ê
        function detectWechatSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromWechat = urlParams.get('from') === 'wechat';
            const wechatSource = urlParams.get('source') || 'unknown';
            
            return {
                fromWechat: fromWechat,
                source: wechatSource,
                isWechatBrowser: isWechat()
            };
        }
        
        // Â§ÑÁêÜÂæÆ‰ø°ÂÖ¨‰ºóÂè∑ËÆøÈóÆ
        function handleWechatPublicAccount() {
            const wechatInfo = detectWechatSource();
            
            if (wechatInfo.fromWechat || wechatInfo.isWechatBrowser) {
                console.log('ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Áî®Êà∑ËÆøÈóÆÔºåÊù•Ê∫ê:', wechatInfo.source);
                
                // ËÆ∞ÂΩïÂæÆ‰ø°ËÆøÈóÆÁªüËÆ°
                fetch('/api/log_wechat_visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: wechatInfo.source,
                        from_wechat: wechatInfo.fromWechat,
                        is_wechat_browser: wechatInfo.isWechatBrowser,
                        timestamp: new Date().toISOString(),
                        page: 'main_app'
                    })
                }).catch(err => console.log('ÂæÆ‰ø°ËÆøÈóÆËÆ∞ÂΩïÂ§±Ë¥•:', err));
                
                // ÊòæÁ§∫ÂæÆ‰ø°‰∏ìÂ±ûÊ¨¢Ëøé‰ø°ÊÅØ
                if (wechatInfo.fromWechat && wechatInfo.source === 'menu') {
                    setTimeout(() => showWechatWelcome(), 1000);
                }
                
                // ÂæÆ‰ø°ÂÜÖ‰ºòÂåñÔºöÈöêËóè‰∏çÂøÖË¶ÅÁöÑÂàÜ‰∫´ÊåâÈíÆ
                if (wechatInfo.isWechatBrowser) {
                    const shareButtons = document.querySelectorAll('.share-button, .external-share');
                    shareButtons.forEach(btn => btn.style.display = 'none');
                }
            }
        }
        
        // ÊòæÁ§∫ÂæÆ‰ø°‰∏ìÂ±ûÊ¨¢Ëøé‰ø°ÊÅØ
        function showWechatWelcome() {
            const welcomeHTML = `
                <div id="wechatWelcome" style="
                    position: fixed; 
                    top: 60px; 
                    left: 50%; 
                    transform: translateX(-50%); 
                    background: linear-gradient(135deg, #28a745, #20c997); 
                    color: white; 
                    padding: 12px 20px; 
                    border-radius: 25px; 
                    font-size: 13px; 
                    z-index: 9999;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    animation: slideInDown 0.6s ease-out;
                    text-align: center;
                    max-width: 280px;
                ">
                    üéâ Ê¨¢Ëøé‰ªéÂÖ¨‰ºóÂè∑ËÆøÈóÆÔºÅ<br>
                    <small>5Â§ß‰∏≠ÂåªÊµÅÊ¥æÔºå‰∏ì‰∏öAIÈóÆËØä</small>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', welcomeHTML);
            
            // 4ÁßíÂêéÊ∑°Âá∫
            setTimeout(() => {
                const welcome = document.getElementById('wechatWelcome');
                if (welcome) {
                    welcome.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    welcome.style.opacity = '0';
                    welcome.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => welcome.remove(), 500);
                }
            }, 4000);
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÂæÆ‰ø°ÂäüËÉΩ
        document.addEventListener('DOMContentLoaded', function() {
            handleWechatPublicAccount();
        });
        
        // ‰ºòÂåñÂæÆ‰ø°ÂàÜ‰∫´
        if (isWechat()) {
            // Âä®ÊÄÅËÆæÁΩÆÂàÜ‰∫´‰ø°ÊÅØ
            document.title = "AI‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂä©Êâã";
            
            // Ê∑ªÂä†ÂæÆ‰ø°ÂàÜ‰∫´ÂÖÉ‰ø°ÊÅØ
            var metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.content = "‰∏ì‰∏öAI‰∏≠ÂåªËØäÊñ≠Âä©ÊâãÔºåÊô∫ËÉΩÁóáÁä∂ÂàÜÊûêÔºåËØÅÂÄôÂà§Êñ≠Ôºå‰∏™ÊÄßÂåñÊñπÂâÇÊé®Ëçê";
            }
            
            // ËÆ∞ÂΩïÂæÆ‰ø°ÂàÜ‰∫´ÁªüËÆ°
            window.addEventListener('load', function() {
                fetch('/api/wechat_visit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        page: 'main_app',
                        is_shared: document.referrer.includes('wechat'),
                        timestamp: new Date().toISOString()
                    })
                }).catch(() => {});
            });
            
            // È°µÈù¢ÂÖ≥Èó≠ÊàñÂà∑Êñ∞Êó∂‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
            window.addEventListener('beforeunload', function(event) {
                // Á°Æ‰øùÂú®È°µÈù¢ÂÖ≥Èó≠Ââç‰øùÂ≠òÂΩìÂâçÂØπËØùÂéÜÂè≤
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('È°µÈù¢ÂÖ≥Èó≠ÂâçÂ∑≤‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
            
            // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂‰πü‰øùÂ≠òÔºàÂ∫îÂØπÊâãÊú∫ÂàáÊç¢Â∫îÁî®Á≠âÂú∫ÊôØÔºâ
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('È°µÈù¢ÈöêËóèÊó∂Â∑≤‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
            
            // Â¢ûÂº∫ÂéÜÂè≤ËÆ∞ÂΩï‰øùÊä§ - ÂÆöÊúüËá™Âä®‰øùÂ≠ò
            setInterval(() => {
                if (selectedDoctor) {
                    const messagesContainer = document.getElementById(window.innerWidth <= 768 ? 'mobileMessagesContainer' : 'messagesContainer');
                    if (messagesContainer && messagesContainer.children.length > 0) {
                        saveCurrentDoctorHistory();
                        console.log('ÂÆöÊúüËá™Âä®‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                    }
                }
            }, 30000); // ÊØè30ÁßíËá™Âä®‰øùÂ≠ò‰∏ÄÊ¨°
            
            // ÊµèËßàÂô®ÁÑ¶ÁÇπÂèòÂåñÊó∂‰øùÂ≠ò
            window.addEventListener('blur', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('ÊµèËßàÂô®Â§±ÂéªÁÑ¶ÁÇπÊó∂‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
            
            // È°µÈù¢Âç∏ËΩΩÂâçÂº∫Âà∂‰øùÂ≠ò
            window.addEventListener('pagehide', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('È°µÈù¢Âç∏ËΩΩÂâç‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
                }
            });
        }
        
        // localStorageÁÆ°ÁêÜÂäüËÉΩ
        function checkLocalStorageUsage() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length + key.length;
                    }
                }
                const sizeInMB = (totalSize / 1024 / 1024).toFixed(2);
                console.log(`LocalStorage‰ΩøÁî®Èáè: ${sizeInMB}MB`);
                
                // Â¶ÇÊûúË∂ÖËøá4MBÔºåÂèëÂá∫Ë≠¶Âëä
                if (totalSize > 4 * 1024 * 1024) {
                    console.warn('LocalStorage‰ΩøÁî®ÈáèËæÉÂ§ßÔºåÂèØËÉΩÈúÄË¶ÅÊ∏ÖÁêÜ');
                }
            } catch (error) {
                console.error('Ê£ÄÊü•localStorage‰ΩøÁî®ÈáèÂ§±Ë¥•:', error);
            }
        }
        
        function cleanOldHistoryRecords() {
            try {
                const keys = Object.keys(localStorage);
                const historyKeys = keys.filter(key => key.startsWith('tcm_doctor_history_'));
                
                // Â¶ÇÊûúÊúâË∂ÖËøá10‰∏™ÂåªÁîüÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºåÊ∏ÖÁêÜÊúÄÊóßÁöÑ
                if (historyKeys.length > 10) {
                    const keysWithTime = historyKeys.map(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            const lastUpdated = data.lastUpdated || data.timestamp || 0;
                            return { key, lastUpdated };
                        } catch {
                            return { key, lastUpdated: 0 };
                        }
                    });
                    
                    // ÊåâÊó∂Èó¥ÊéíÂ∫èÔºåÂà†Èô§ÊúÄÊóßÁöÑ
                    keysWithTime.sort((a, b) => new Date(a.lastUpdated) - new Date(b.lastUpdated));
                    const keysToDelete = keysWithTime.slice(0, historyKeys.length - 8); // ‰øùÁïôÊúÄÊñ∞8‰∏™
                    
                    keysToDelete.forEach(({ key }) => {
                        localStorage.removeItem(key);
                        console.log(`Â∑≤Ê∏ÖÁêÜÊóßÂéÜÂè≤ËÆ∞ÂΩï: ${key}`);
                    });
                }
            } catch (error) {
                console.error('Ê∏ÖÁêÜÊóßÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
            }
        }
        
        // ÂéÜÂè≤ËÆ∞ÂΩïËØäÊñ≠ÂäüËÉΩ
        function diagnoseHistoryIssues() {
            console.log('=== ÂéÜÂè≤ËÆ∞ÂΩïËØäÊñ≠ ===');
            console.log('ÂΩìÂâçÂåªÁîü:', selectedDoctor);
            console.log('ÊµèËßàÂô®‰ø°ÊÅØ:', navigator.userAgent);
            console.log('Â±èÂπïÂ∞∫ÂØ∏:', window.innerWidth + 'x' + window.innerHeight);
            
            const keys = Object.keys(localStorage);
            const historyKeys = keys.filter(key => key.startsWith('tcm_doctor_history_'));
            console.log('ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè:', historyKeys.length);
            
            historyKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = JSON.parse(data);
                    const messageCount = Array.isArray(parsed) ? parsed.length : (parsed.messages ? parsed.messages.length : 0);
                    console.log(`${key}: ${messageCount}Êù°Ê∂àÊÅØ, Â§ßÂ∞è=${(data.length/1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error(`${key}: Êï∞ÊçÆÊçüÂùè`, error);
                }
            });
            
            checkLocalStorageUsage();
            
            // ÊµãËØïlocalStorageÂÜôÂÖ•
            try {
                const testKey = 'tcm_test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                console.log('‚úÖ localStorageÂÜôÂÖ•ÊµãËØïÊàêÂäü');
            } catch (error) {
                console.error('‚ùå localStorageÂÜôÂÖ•ÊµãËØïÂ§±Ë¥•:', error);
            }
        }

        // ÈóÆËØäÊåáÂØºÂäüËÉΩ
        function showGuidance() {
            const overlay = document.createElement('div');
            overlay.className = 'guidance-overlay';
            overlay.onclick = hideGuidance;
            document.body.appendChild(overlay);
            
            document.getElementById('guidanceTips').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideGuidance() {
            document.getElementById('guidanceTips').style.display = 'none';
            const overlay = document.querySelector('.guidance-overlay');
            if (overlay) {
                overlay.remove();
            }
            document.body.style.overflow = 'auto';
        }

        function toggleGuidance() {
            hideGuidance();
        }
    </script>

    <!-- ÈóÆËØäÊåáÂØºÊèêÁ§∫ -->
    <div class="guidance-tips" id="guidanceTips" style="display: none;">
        <div class="tips-header">
            <h4>üí° ÈóÆËØäÊåáÂØº</h4>
            <button onclick="toggleGuidance()" class="close-btn">√ó</button>
        </div>
        <div class="tips-content">
            <div class="tip-section">
                <h5>üîç ‰∏ªË¶ÅÁóáÁä∂ÊèèËø∞</h5>
                <ul>
                    <li>‰∏ªË¶Å‰∏çÈÄÇÊÑüËßâÔºàÁñºÁóõ„ÄÅÂèëÁÉ≠„ÄÅÂí≥ÂóΩÁ≠âÔºâ</li>
                    <li>ÁóáÁä∂ÊåÅÁª≠Êó∂Èó¥ÔºàÂá†Â§©„ÄÅÂá†Âë®„ÄÅÂá†‰∏™ÊúàÔºâ</li>
                    <li>ÁóáÁä∂Á®ãÂ∫¶ÔºàËΩªÂæÆ„ÄÅ‰∏≠Á≠â„ÄÅ‰∏•ÈáçÔºâ</li>
                    <li>Âèë‰ΩúËßÑÂæãÔºàÊåÅÁª≠ÊÄß„ÄÅÈó¥Ê≠áÊÄß„ÄÅÁâπÂÆöÊó∂Èó¥Ôºâ</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>ü©∫ ‰º¥ÈöèÁóáÁä∂</h5>
                <ul>
                    <li>Áù°Áú†ÊÉÖÂÜµÔºàÂÖ•Áù°Âõ∞Èöæ„ÄÅÊòìÈÜí„ÄÅÂ§öÊ¢¶Ôºâ</li>
                    <li>È£üÊ¨≤Áä∂ÂÜµÔºàÈ£üÊ¨≤‰∏çÊåØ„ÄÅÊ∂àÂåñ‰∏çËâØÔºâ</li>
                    <li>Â§ßÂ∞è‰æøÊÉÖÂÜµÔºà‰æøÁßò„ÄÅËÖπÊ≥ª„ÄÅÂ∞øÈ¢ëÁ≠âÔºâ</li>
                    <li>ÊÉÖÁª™Áä∂ÊÄÅÔºàÁÑ¶Ëôë„ÄÅÊäëÈÉÅ„ÄÅÁÉ¶Ë∫ÅÔºâ</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>üëÖ ËàåË±°ËÑâË±°ÔºàÂ¶ÇÊûúÊñπ‰æøÔºâ</h5>
                <ul>
                    <li>ËàåÂ§¥È¢úËâ≤ÔºàÊ∑°Á∫¢„ÄÅÁ∫¢„ÄÅÊöóÁ∫¢Ôºâ</li>
                    <li>ËàåËãîÊÉÖÂÜµÔºàËñÑÁôΩ„ÄÅÂéöÈªÑ„ÄÅÊó†ËãîÁ≠âÔºâ</li>
                    <li>ËÑâÊêèÊÑüËßâÔºàÂø´ÊÖ¢„ÄÅÂº∫Âº±„ÄÅËßÑÂæãÊÄßÔºâ</li>
                    <li>ÂèØ‰∏ä‰º†ËàåË±°ÁÖßÁâá‰ª•‰æøÊõ¥ÂáÜÁ°ÆËØäÊñ≠</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>üìã ÂÖ∂‰ªñÈáçË¶Å‰ø°ÊÅØ</h5>
                <ul>
                    <li>Êó¢ÂæÄÁóÖÂè≤ÔºàÊÖ¢ÊÄßÁóÖ„ÄÅÊâãÊúØÂè≤Ôºâ</li>
                    <li>ËøáÊïèÂè≤ÔºàËçØÁâ©„ÄÅÈ£üÁâ©ËøáÊïèÔºâ</li>
                    <li>ÁõÆÂâçÁî®ËçØÊÉÖÂÜµ</li>
                    <li>ÁîüÊ¥ª‰π†ÊÉØÔºà‰ΩúÊÅØ„ÄÅÈ•ÆÈ£ü„ÄÅËøêÂä®Ôºâ</li>
                </ul>
            </div>
            
            <div class="tip-footer">
                <p>üí¨ <strong>ÊèêÁ§∫</strong>ÔºöÊèê‰æõË∂äËØ¶ÁªÜÁöÑ‰ø°ÊÅØÔºåÂåªÁîüË∂äËÉΩÁªôÂá∫ÂáÜÁ°ÆÁöÑËØäÊñ≠ÂíåÊ≤ªÁñóÂª∫ËÆÆ</p>
            </div>
        </div>
    </div>
    
    <!-- ÁßªÂä®Á´ØÂõæÁâáÈÄâÊã©ÂºπÁ™ó - ÁßªËá≥bodyÂ∫ïÈÉ®Á°Æ‰øùÊúÄÈ´òÂ±ÇÁ∫ß -->
    <div class="mobile-image-modal mobile-modal-hidden" id="mobileImageModal">
        <div class="mobile-image-modal-content">
            <div class="modal-header">
                <h3>ÈÄâÊã©ÊãçÁÖßÁ±ªÂûã</h3>
                <button onclick="closeMobileImageModal()" class="modal-close">√ó</button>
            </div>
            <div class="modal-options">
                <button onclick="triggerMobileTongueUpload()" class="image-option-btn">
                    <div class="option-icon">üëÖ</div>
                    <div class="option-text">
                        <strong>ËàåËØäÊãçÁÖß</strong>
                        <span>ÊãçÊëÑËàåÂ§¥ÁÖßÁâá</span>
                    </div>
                </button>
                <button onclick="triggerMobileFaceUpload()" class="image-option-btn">
                    <div class="option-icon">üòä</div>
                    <div class="option-text">
                        <strong>Èù¢ËØäÊãçÁÖß</strong>
                        <span>ÊãçÊëÑÈù¢ÈÉ®ÁÖßÁâá</span>
                    </div>
                </button>
            </div>
            <div class="upload-status-mobile" id="mobileUploadStatus">
                <div class="mobile-status-item" id="mobileTongueStatus">üëÖ ËàåËØä: <span>Êú™‰∏ä‰º†</span></div>
                <div class="mobile-status-item" id="mobileFaceStatus">üòä Èù¢ËØä: <span>Êú™‰∏ä‰º†</span></div>
            </div>
        </div>
    </div>

    <!-- ÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <div class="login-header">
                <h3>Áî®Êà∑ÁôªÂΩï</h3>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label class="form-label">Áî®Êà∑Âêç/ÊâãÊú∫Âè∑</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÊàñÊâãÊú∫Âè∑">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂØÜÁ†Å</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                </div>
                <div class="error-message" id="loginError">
                    ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å
                </div>
                <div class="login-buttons">
                    <button class="login-btn secondary" onclick="hideLoginModal()">ÂèñÊ∂à</button>
                    <button class="login-btn primary" onclick="performLogin()">ÁôªÂΩï</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>