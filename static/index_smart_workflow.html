<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智汇中医 - AI智能问诊工作流</title>
    
    <!-- Open Graph / 微信分享优化 -->
    <meta property="og:title" content="🏥 AI 中医智能问诊助手 - 专业版">
    <meta property="og:description" content="基于AI的中医智能诊断系统，支持症状问诊、证候分析、方剂推荐。集成5大中医流派，提供个性化中医治疗建议。适用于临床辅助诊断。">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="AI中医智能问诊助手 - 专业医疗诊断工具">
    <meta property="og:url" content="https://mxh0510.cn/">
    <meta property="og:site_name" content="TCM AI 中医智能诊断系统">
    
    <!-- 微信分享专用标签 -->
    <meta name="description" content="AI中医智能问诊助手，专业的中医诊断辅助工具，支持症状分析、证候判断、方剂推荐">
    <meta name="keywords" content="中医,AI诊断,智能问诊,中药方剂,证候分析,传统中医,人工智能">
    <meta name="author" content="TCM AI Team">
    
    <!-- 微信小程序分享卡片优化 -->
    <meta property="wx:card" content="summary_large_image">
    <meta property="wx:title" content="🏥 AI 中医智能问诊助手">
    <meta property="wx:description" content="专业AI中医诊断辅助工具，集成5大流派，提供个性化治疗建议">
    <meta property="wx:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- 微信安全验证 -->
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <!-- 微信验证文件标识 -->
    <meta name="wechat-enable" content="true">
    <meta name="applicable-device" content="mobile">
    
    <!-- Twitter Card 标签 -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="🏥 AI 中医智能问诊助手">
    <meta name="twitter:description" content="基于AI的中医智能诊断系统，专业医疗辅助工具">
    <meta name="twitter:image" content="https://mxh0510.cn/static/tcm_share_card_enhanced.png">
    
    <!-- 版本标识: v1.2.4 更新时间: 2025-08-03 20:20 分享优化版 -->
    <!-- 🔧 修复连接超时 - 使用异步加载和超时处理 -->
    <script>
        // 异步加载marked.js，避免CDN超时阻塞页面
        (function() {
            // 设置超时时间为5秒
            const timeout = setTimeout(function() {
                if (!window.marked) {
                    console.warn('⚠️ marked.js CDN加载超时，使用本地降级方案');
                    initializeMarkedFallback();
                }
            }, 5000);

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            script.async = true;
            
            script.onload = function() {
                clearTimeout(timeout);
                console.log('✅ marked.js CDN加载成功');
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                console.warn('⚠️ marked.js CDN加载失败，使用本地降级方案');
                initializeMarkedFallback();
            };
            
            document.head.appendChild(script);
            
            // 降级方案：简单的Markdown解析器
            function initializeMarkedFallback() {
                window.marked = {
                    parse: function(markdown) {
                        if (!markdown) return '';
                        
                        return markdown
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **粗体**
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *斜体*
                            .replace(/`(.*?)`/g, '<code>$1</code>')           // `代码`
                            .replace(/\n\n/g, '</p><p>')                       // 段落
                            .replace(/\n/g, '<br>')                           // 换行
                            .replace(/^/, '<p>')                              // 开始段落
                            .replace(/$/, '</p>');                            // 结束段落
                    }
                };
                console.log('✅ marked.js 本地降级方案已就绪');
            }
        })();
    </script>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <!-- 统一认证管理器 -->
    <script src="/static/js/auth_manager.js"></script>
    
    <!-- 🔧 字体优化：预连接+超时+降级 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" 
          rel="stylesheet" media="print" onload="this.media='all'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    </noscript>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            background: #f5f7fa;
            overflow: hidden;
        }

        /* 主布局容器 */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* 顶部导航栏 */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .history-btn, .new-chat-btn, .auth-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .history-btn:hover, .new-chat-btn:hover, .auth-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .history-btn {
            background: rgba(255,255,255,0.15);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
        }


        /* 主内容区域 */
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0; /* 确保flex子元素可以正确缩小 */
            background: #f5f7fa;
        }



        /* 病历管理工具栏 */
        .medical-records-toolbar {
            padding: 12px 16px;
            background: #40414f;
            border-bottom: 1px solid #565869;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-title {
            color: #ececf1;
            font-size: 14px;
            font-weight: 600;
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            background: #565869;
            border: 1px solid #6b7280;
            color: #ececf1;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #6b7280;
        }

        .toolbar-btn.danger:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .toolbar-btn.success:hover {
            background: #10b981;
            border-color: #10b981;
        }

        /* 评价弹窗样式 */
        .rating-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .rating-modal.show {
            display: flex;
        }

        .rating-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }

        .rating-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .rating-header h3 {
            color: #374151;
            margin-bottom: 8px;
        }

        .rating-section {
            margin-bottom: 20px;
        }

        .rating-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .star-rating {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: #d1d5db;
            transition: color 0.2s;
        }

        .star.active,
        .star:hover {
            color: #fbbf24;
        }

        .rating-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        .rating-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .rating-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .rating-btn.primary {
            background: #667eea;
            color: white;
        }

        .rating-btn.primary:hover {
            background: #5a67d8;
        }

        .rating-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .rating-btn.secondary:hover {
            background: #e5e7eb;
        }

        /* 对话列表项样式补充 - ChatGPT风格 */
        .conversation-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .conversation-title {
            font-weight: 500;
            color: #ececf1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 8px;
        }

        .conversation-delete {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 16px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            margin-left: auto;
        }

        .conversation-item:hover .conversation-delete {
            opacity: 1;
        }

        .conversation-delete:hover {
            background: #ff6b6b;
            color: white;
        }

        .conversation-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-doctor {
            font-size: 12px;
            color: #40a9ff;
            font-weight: 500;
        }

        .conversation-time {
            font-size: 11px;
            color: #8e8ea0;
        }

        .conversation-meta {
            font-size: 11px;
            color: #565869;
        }

        .conversation-item-empty {
            padding: 16px;
            text-align: center;
        }

        /* 边栏收起按钮 */
        .sidebar-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            z-index: 10;
        }

        .sidebar-toggle:hover {
            background: #40414f;
            color: white;
        }

        /* 边栏折叠状态 */
        .conversation-sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        /* 对话历史触发按钮 */
        .conversation-history-trigger {
            position: fixed;
            top: 80px;
            left: 10px;
            z-index: 998;
            background: #40414f;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .conversation-history-trigger:hover {
            background: #565869;
            transform: translateX(2px);
        }
        
        .conversation-history-trigger.hidden {
            display: none;
        }

        /* 移动端响应式 */
        @media (max-width: 768px) {
            .conversation-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                display: flex; /* 移动端总是显示flex */
            }

            .conversation-sidebar.mobile-open {
                transform: translateX(0);
            }

            .conversation-sidebar.show {
                display: flex; /* 确保移动端显示 */
            }

            .content-wrapper {
                width: 100%;
            }

            .mobile-sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
            }
            
            /* 隐藏桌面端触发按钮 */
            .conversation-history-trigger {
                display: none;
            }
            
            /* 确保侧边栏在移动端正确显示 */
            .main-content {
                position: relative;
            }
        }

            .mobile-sidebar-overlay.show {
                display: block;
            }
        }

        /* 内容容器 - 占据剩余空间 */
        .content-wrapper {
            display: flex;
            flex: 1;
            min-height: 0; /* 确保flex子元素可以正确缩小 */
            width: 100%;
            max-width: 1400px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* 左侧栏 */
        .sidebar {
            width: 400px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* 医生选择区域 */
        .doctor-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doctors-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .doctor-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }

        .doctor-card:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .doctor-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .doctor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .doctor-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .doctor-details h3 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }

        .doctor-school {
            font-size: 12px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 8px;
            border-radius: 8px;
        }

        .selection-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .doctor-card.selected .selection-indicator {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .doctor-specialty {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* 工具区域 */
        .tools-section {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .tool-group {
            margin-bottom: 20px;
        }

        .tool-group:last-child {
            margin-bottom: 0;
        }

        .tool-title {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* 多图片上传样式 */
        .upload-section {
            margin-bottom: 15px;
        }

        .upload-subtitle {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .upload-status {
            margin-top: 15px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 13px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        /* 移动端图片选择弹窗 - 微信兼容修复 */
        .mobile-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999999;  /* 提高z-index层级，确保在最上层 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .mobile-modal-hidden {
            display: none !important;
        }
        
        .mobile-modal-visible {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .mobile-image-modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 350px;
            min-width: 280px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            position: relative;
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-options {
            padding: 20px;
        }

        .image-option-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .image-option-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .image-option-btn:last-child {
            margin-bottom: 0;
        }

        .option-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .option-text {
            text-align: left;
        }

        .option-text strong {
            display: block;
            margin-bottom: 4px;
            color: #111827;
        }

        .option-text span {
            color: #6b7280;
            font-size: 13px;
        }

        .upload-status-mobile {
            padding: 15px 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .mobile-status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .mobile-status-item:last-child {
            margin-bottom: 0;
        }

        /* 微信浏览器特殊适配 */
        @media screen and (max-width: 480px) {
            .mobile-image-modal {
                padding: 15px;
            }
            
            .mobile-image-modal-content {
                max-width: calc(100vw - 30px);
                min-width: 260px;
            }
            
            .modal-header {
                padding: 15px 15px 10px 15px;
            }
            
            .modal-header h3 {
                font-size: 16px;
            }
            
            .modal-options {
                padding: 15px;
            }
            
            .image-option-btn {
                padding: 12px;
            }
        }

        /* 极小屏幕适配 */
        @media screen and (max-width: 360px) {
            .mobile-image-modal-content {
                max-width: calc(100vw - 20px);
                border-radius: 8px;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-options {
                padding: 12px;
            }
        }

        .upload-text {
            font-size: 13px;
            color: #6b7280;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-btn {
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .voice-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .voice-btn.recording {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .auto-speak {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }

        /* 右侧对话区域 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* 确保flex子元素可以正确缩小 */
            background: white;
        }

        /* 当前医生信息条 */
        .current-doctor-bar {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .current-doctor-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .current-doctor-info h2 {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .current-doctor-desc {
            font-size: 14px;
            color: #6b7280;
        }

        /* 对话消息区域 */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fafafa;
        }

        .message {
            display: flex;
            margin-bottom: 24px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 12px;
        }

        .user .message-avatar {
            background: #10b981;
            color: white;
        }

        .ai .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .user .message-content {
            background: #10b981;
            color: white;
        }

        .message-content::before {
            content: '';
            position: absolute;
            top: 20px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .ai .message-content::before {
            left: -16px;
            border-right-color: white;
        }

        .user .message-content::before {
            right: -16px;
            border-left-color: #10b981;
        }

        .message-text {
            line-height: 1.6;
            font-size: 14px;
            word-wrap: break-word;
            white-space: normal;
        }
        .message-text h3, .message-text h4 {
            margin: 12px 0 8px 0;
            line-height: 1.4;
        }
        .message-text strong {
            font-weight: 600;
        }
        .message-text hr {
            margin: 12px 0;
            border: none;
            border-top: 1px solid #e5e7eb;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
        }

        /* 反馈按钮 */
        .feedback-controls {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .feedback-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .rating-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .rating-btn {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        /* 输入区域 */
        .input-area {
            border-top: 1px solid #e5e7eb;
            padding: 20px 24px;
            background: white;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 12px 16px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #5a67d8;
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 默认隐藏移动端容器 */
        .mobile-page-container {
            display: none;
        }
        
        /* 强制显示移动端容器在小屏幕上 */
        @media (max-width: 768px) {
            .mobile-page-container {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: relative !important;
                width: 200% !important;
                height: 100vh !important;
                z-index: 999 !important;
                overflow: hidden !important;
            }
        }
        
        /* 响应式设计 */
        @media (max-width: 1440px) {
            .content-wrapper {
                max-width: 95%;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                position: relative;
                overflow: hidden;
            }
            
            /* 隐藏桌面端布局，避免与移动端布局冲突 */
            .content-wrapper {
                display: none !important;
            }
            
            /* 移动端消息样式优化 */
            .mobile-messages-container .message {
                margin-bottom: 16px;
                display: flex;
                align-items: flex-end;
                gap: 8px;
                width: 100%;
                clear: both;
            }
            
            .mobile-messages-container .message.user {
                justify-content: flex-end;
                flex-direction: row-reverse;
            }
            
            .mobile-messages-container .message-content {
                max-width: 80%;
                padding: 12px 16px;
                border-radius: 18px;
                word-wrap: break-word;
                line-height: 1.4;
                display: block;
            }
            
            .mobile-messages-container .message.user .message-content {
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                border-bottom-right-radius: 6px;
            }
            
            .mobile-messages-container .message.ai .message-content {
                background: white;
                color: #374151;
                border: 1px solid #e5e7eb;
                border-bottom-left-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .mobile-messages-container .message-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                flex-shrink: 0;
            }
            
            .mobile-messages-container .message.user .message-avatar {
                background: #3b82f6;
                color: white;
            }
            
            .mobile-messages-container .message.ai .message-avatar {
                background: #f3f4f6;
                color: #6b7280;
            }
            
            /* 移动端页面容器 */
            .mobile-page-container {
                display: flex !important; /* 覆盖默认的隐藏 */
                position: relative;
                width: 200%;
                height: 100vh;
                min-height: 100vh;
                transition: transform 0.3s ease-in-out;
                overflow: hidden;
            }
            
            .mobile-page-container.show-chat {
                transform: translateX(-50%);
            }
            
            /* 医生选择页面 */
            .mobile-doctor-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .mobile-doctor-header {
                padding: 20px;
                text-align: center;
                color: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }

            .mobile-header-content {
                flex: 1;
            }
            
            .mobile-doctor-header h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .mobile-doctor-header p {
                font-size: 0.9rem;
                opacity: 0.9;
            }

            .mobile-header-actions {
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            }

            .mobile-action-btn {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                font-weight: 500;
                min-width: 60px;
            }

            .mobile-action-btn:hover,
            .mobile-action-btn:active {
                background: rgba(255,255,255,0.25);
                transform: translateY(-1px);
            }

            .mobile-chat-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .mobile-action-btn-small {
                background: rgba(255,255,255,0.15);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 6px;
                border-radius: 12px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .mobile-action-btn-small:hover,
            .mobile-action-btn-small:active {
                background: rgba(255,255,255,0.25);
                transform: scale(1.05);
            }
            
            .mobile-doctors-container {
                flex: 1;
                background: white;
                border-radius: 20px 20px 0 0;
                padding: 24px 16px 30px 16px; /* 优化底部内边距 */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOS平滑滚动 */
                max-height: calc(100vh - 160px); /* 限制最大高度，避免溢出 */
            }
            
            .mobile-doctors-title {
                text-align: center;
                font-size: 1.2rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 20px;
            }
            
            .mobile-doctors-grid {
                display: block; /* 改为block提高兼容性 */
                width: 100%;
            }
            
            /* 如果浏览器支持Grid，则使用Grid布局 */
            @supports (display: grid) {
                .mobile-doctors-grid {
                    display: grid;
                    grid-template-columns: 1fr;
                    gap: 16px;
                }
            }
            
            .mobile-doctor-card {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                padding: 16px;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 8px; /* 增加卡片间距 */
                min-height: 120px; /* 确保卡片最小高度 */
            }
            
            .mobile-doctor-card:hover,
            .mobile-doctor-card:active,
            .mobile-doctor-card.selected {
                border-color: #3b82f6;
                background: linear-gradient(135deg, #eff6ff, #f0f9ff);
                transform: translateY(-1px);
                box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
            }
            
            .mobile-doctor-card.selected .mobile-doctor-avatar {
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
            }
            
            .mobile-doctor-info {
                display: flex;
                align-items: flex-start;
                margin-bottom: 12px;
                gap: 12px;
            }
            
            .mobile-doctor-avatar {
                font-size: 2.2rem;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
                border-radius: 50%;
                border: 2px solid #3b82f6;
            }
            
            .mobile-doctor-details {
                flex: 1;
            }
            
            .mobile-doctor-details h3 {
                font-size: 1.05rem;
                font-weight: 600;
                color: #374151;
                margin: 0 0 4px 0;
                line-height: 1.3;
            }
            
            .mobile-doctor-details .school {
                font-size: 0.8rem;
                color: #6b7280;
                margin: 0;
            }
            
            .mobile-doctor-specialty {
                font-size: 0.85rem;
                color: #4b5563;
                line-height: 1.4;
                margin-top: 8px;
            }
            
            .mobile-doctor-specialty strong {
                color: #374151;
                font-weight: 500;
            }
            
            /* 聊天页面 */
            .mobile-chat-page {
                width: 50%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: white;
                position: relative;
                overflow: hidden;
            }
            
            .mobile-chat-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                flex-shrink: 0;
            }
            
            .mobile-back-btn {
                background: none;
                border: none;
                color: white;
                font-size: 1.2rem;
                padding: 8px;
                margin-right: 12px;
                cursor: pointer;
                border-radius: 50%;
                transition: background 0.2s;
            }
            
            .mobile-back-btn:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .mobile-current-doctor {
                flex: 1;
                display: flex;
                align-items: center;
            }
            
            .mobile-current-doctor .avatar {
                font-size: 1.5rem;
                margin-right: 12px;
            }
            
            .mobile-current-doctor .info h2 {
                font-size: 1rem;
                margin-bottom: 2px;
            }
            
            .mobile-current-doctor .info p {
                font-size: 0.8rem;
                opacity: 0.9;
            }
            
            .mobile-messages-container {
                flex: 1;
                padding: 16px 12px;
                overflow-y: auto;
                overflow-x: hidden;
                background: #f9fafb;
                -webkit-overflow-scrolling: touch;
                min-height: 0;
                display: block;
                position: relative;
                scroll-behavior: smooth;
            }
            
            .mobile-input-container {
                padding: 12px 16px;
                background: white;
                border-top: 1px solid #e5e7eb;
                flex-shrink: 0;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
                position: relative; /* 恢复相对定位 */
                z-index: 10;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .mobile-input-helper {
                display: flex !important;
                align-items: center;
                gap: 8px;
                margin-bottom: 10px;
                padding: 0 4px;
                flex-wrap: wrap;
                min-height: 40px;
                width: 100%;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .mobile-guidance-trigger {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 18px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
            }

            .mobile-guidance-trigger:hover,
            .mobile-guidance-trigger:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            }

            .mobile-upload-trigger {
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 18px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 4px;
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
            }

            .mobile-upload-trigger:hover,
            .mobile-upload-trigger:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }

            .mobile-upload-trigger.has-file {
                background: linear-gradient(135deg, #10b981, #059669);
                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
            }

            .mobile-helper-text {
                font-size: 11px;
                color: #6b7280;
                flex: 1;
                min-width: 120px;
                text-align: right;
            }
            
            .mobile-input-wrapper {
                display: flex;
                gap: 8px;
                align-items: flex-end;
                width: 100%;
                margin-top: 8px;
            }
            
            .mobile-input-wrapper textarea {
                flex: 1;
                border: 1px solid #d1d5db;
                border-radius: 20px;
                padding: 12px 16px;
                font-size: 16px;
                resize: none;
                max-height: 100px;
                min-height: 44px;
                -webkit-appearance: none;
                -webkit-border-radius: 20px;
                line-height: 1.4;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            }
            
            .mobile-send-btn {
                width: 44px;
                height: 44px;
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 1.2rem;
                cursor: pointer;
                transition: all 0.2s ease;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            }
            
            .mobile-send-btn:hover,
            .mobile-send-btn:active {
                transform: translateY(-1px) scale(1.05);
                box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            }
            
            .mobile-send-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            .mobile-send-btn:hover {
                background: #2563eb;
            }
            
            .mobile-send-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }
            
            /* PC端元素正常显示 - 移除了隐藏规则 */
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            
            .header-title h1 {
                font-size: 1.1rem;
            }
            
            .header-subtitle {
                font-size: 0.7rem;
            }
            
            .messages-container {
                padding: 8px;
            }
            
            .message-content {
                max-width: 95%;
                font-size: 0.85rem;
                padding: 10px 12px;
            }
            
            .input-container {
                padding: 8px;
            }
            
            .new-chat-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            /* 移动端消息优化 */
            .mobile-messages-container {
                padding: 12px 8px;
            }
            
            .mobile-input-container {
                padding: 8px 12px;
            }
            
            .mobile-input-wrapper textarea {
                font-size: 15px;
            }
            
            .message.ai .message-content,
            .message.user .message-content {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 14px;
            }
            
            .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .sidebar {
                max-height: 120px !important;
            }
            
            .doctor-section {
                padding: 6px 8px !important;
            }
            
            .doctor-card {
                min-width: 100px !important;
                padding: 6px 8px !important;
            }
        }
        
        @media (max-width: 320px) {
            .header-title h1 {
                font-size: 1.0rem;
            }
            
            .message-content {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .input-wrapper input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .sidebar {
                max-height: 100px !important;
            }
            
            .doctor-section {
                padding: 4px 6px !important;
            }
            
            .doctor-section .section-title {
                font-size: 0.8rem !important;
                margin-bottom: 4px !important;
            }
            
            .doctor-card {
                min-width: 90px !important;
                padding: 4px 6px !important;
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-name {
                font-size: 0.7rem !important;
            }
            
            .doctor-card .doctor-desc {
                font-size: 0.6rem !important;
            }
        }

        /* 滚动条样式 */
        .messages-container::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .messages-container::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* 问诊指导样式 */
        .input-helper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 16px;
        }

        .guidance-trigger {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 10px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .guidance-trigger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .helper-text {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }

        .guidance-tips {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            animation: fadeInScale 0.3s ease-out;
        }

        .tips-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tips-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        /* 登录模态框样式 */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .login-modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }

        .login-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .login-form {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .login-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .login-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .login-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .login-btn.secondary:hover {
            background: #e5e7eb;
        }

        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tips-content {
            padding: 20px;
        }

        .tip-section {
            margin-bottom: 20px;
        }

        .tip-section h5 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .tip-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .tip-section li {
            margin-bottom: 5px;
            color: #666;
            line-height: 1.4;
        }

        .tip-footer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tip-footer p {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .guidance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .guidance-tips {
                max-width: 95vw;
                max-height: 80vh;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
                border-radius: 16px;
                padding: 0;
            }
            
            .tips-header {
                padding: 16px 20px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .tips-header h4 {
                font-size: 18px;
                margin: 0;
            }
            
            .tips-content {
                padding: 16px 20px;
                max-height: calc(80vh - 80px);
                overflow-y: auto;
            }
            
            .tip-section {
                margin-bottom: 16px;
            }
            
            .tip-section h5 {
                font-size: 15px;
                margin-bottom: 8px;
                color: #374151;
            }
            
            .tip-section ul {
                padding-left: 16px;
                margin: 0;
            }
            
            .tip-section li {
                font-size: 14px;
                line-height: 1.5;
                margin-bottom: 4px;
                color: #4b5563;
            }
            
            .close-btn {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }
            
            .input-helper {
                display: flex !important;
                padding: 0 12px;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 12px;
            }
            
            .guidance-trigger {
                font-size: 14px !important;
                padding: 8px 12px !important;
                border-radius: 6px !important;
                min-height: 36px;
            }
            
            .helper-text {
                font-size: 11px;
                line-height: 1.3;
                flex: 1;
                min-width: 100%;
                margin-top: 4px;
            }
        }

        /* 对话状态指示器 */
        .conversation-state-indicator {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 12px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .state-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 13px;
            color: #374151;
        }

        .state-icon {
            font-size: 14px;
        }

        .state-label {
            font-weight: 500;
        }

        /* 确认处方模态框 */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-modal .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            margin: 20px;
            text-align: center;
        }

        .confirmation-modal h3 {
            margin-bottom: 16px;
            color: #374151;
        }

        .confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .confirmation-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .continue-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* ===== PC端布局强制修复 ===== */
        @media (min-width: 769px) {
            /* 确保桌面端布局正确 */
            .app-container {
                height: 100vh !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .main-content {
                flex: 1 !important;
                display: flex !important;
                height: calc(100vh - 70px) !important; /* 减去header高度 */
            }
            
            .content-wrapper {
                flex: 1 !important;
                display: flex !important;
                max-height: 100% !important;
            }
            
            .sidebar {
                width: 400px !important;
                flex-shrink: 0 !important;
                height: 100% !important;
                max-height: none !important; /* 移除可能的高度限制 */
            }
            
            .chat-area {
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                height: 100% !important;
                max-height: 100% !important;
            }
            
            .messages-container {
                flex: 1 !important;
                overflow-y: auto !important;
                height: 0 !important; /* 强制flex生效 */
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 移动端页面容器 -->
        <div class="mobile-page-container" id="mobilePageContainer">
            <!-- 医生选择页面 -->
            <div class="mobile-doctor-page">
                <div class="mobile-doctor-header">
                    <div class="mobile-header-content">
                        <h1>AI 中医智能问诊</h1>
                        <p>传统中医 × 人工智能</p>
                    </div>
                    <div class="mobile-header-actions">
                        <button class="mobile-action-btn" onclick="showMobileNavigation()" title="页面导航">
                            🔗 导航
                        </button>
                        <button class="mobile-action-btn" onclick="openRegisterPage()" title="注册账户">
                            👤 注册
                        </button>
                        <button class="mobile-action-btn" onclick="openHistoryPage()" title="查看历史">
                            📋 历史
                        </button>
                    </div>
                </div>
                <div class="mobile-doctors-container">
                    <h2 class="mobile-doctors-title">👨‍⚕️ 中医师团队</h2>
                    <div class="mobile-doctors-grid" id="mobileDoctorsGrid">
                        <!-- 医生卡片将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 聊天页面 -->
            <div class="mobile-chat-page">
                <div class="mobile-chat-header">
                    <button class="mobile-back-btn" onclick="showMobileDoctorPage()">←</button>
                    <div class="mobile-current-doctor">
                        <div class="avatar" id="mobileDoctorAvatar">🤖</div>
                        <div class="info">
                            <h2 id="mobileDoctorName">医师姓名</h2>
                            <p id="mobileDoctorDesc">医师描述</p>
                        </div>
                    </div>
                    <div class="mobile-chat-actions">
                        <button class="mobile-action-btn-small" onclick="openRegisterPage()" title="注册">
                            👤
                        </button>
                        <button class="mobile-action-btn-small" onclick="openMobileSidebar()" title="对话列表">
                            📋
                        </button>
                        <button class="mobile-action-btn-small" onclick="createNewConversation()" title="新对话">
                            ✨
                        </button>
                    </div>
                </div>
                <div class="mobile-messages-container" id="mobileMessagesContainer">
                    <!-- 消息将通过JavaScript动态生成 -->
                </div>
                <div class="mobile-input-container">
                    <div class="mobile-input-helper">
                        <button onclick="showGuidance()" class="mobile-guidance-trigger">💡 问诊指导</button>
                        <button onclick="showMobileImageOptions()" class="mobile-upload-trigger" id="mobileUploadTrigger">
                            📷 <span id="mobileUploadText">上传舌苔和面象照片</span>
                        </button>
                        <span class="mobile-helper-text">不知道怎么描述症状？</span>
                    </div>
                    <!-- 移动端多图片上传 -->
                    <input type="file" id="mobileTongueUpload" accept="image/*" style="display: none;" onchange="handleMobileTongueUpload(event)">
                    <input type="file" id="mobileFaceUpload" accept="image/*" style="display: none;" onchange="handleMobileFaceUpload(event)">
                    
                    <!-- 移动端图片选择弹窗已移动到body底部 -->
                    <div class="mobile-input-wrapper">
                        <textarea 
                            id="mobileMessageInput" 
                            placeholder="请描述您的症状或问题..."
                            rows="1"
                            onkeydown="handleMobileKeyPress(event)"
                            oninput="adjustMobileTextareaHeight()"
                            onfocus="ensureMobileInputVisible()"
                            onblur="handleMobileInputBlur()"
                            style="resize: none; outline: none;"
                        ></textarea>
                        <button class="mobile-send-btn" id="mobileSendBtn" onclick="sendMobileMessage()">→</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 桌面端：顶部导航栏 -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>AI 中医智能问诊</h1>
                    <p class="header-subtitle">传统中医 × 人工智能 - 专业版</p>
                </div>
                <div class="header-actions">
                    <!-- 自动同步状态指示器 (自动显示，无需手动操作) -->
                    <!-- 未登录状态 -->
                    <div id="authButtons" style="display: flex; gap: 12px;">
                        <button class="auth-btn" onclick="showLoginModal()" title="用户登录">
                            🔐 登录
                        </button>
                        <button class="history-btn" onclick="openRegisterPage()" title="注册账户">
                            👤 注册
                        </button>
                    </div>
                    
                    <!-- 已登录状态 -->
                    <div id="userInfo" class="user-info" style="display: none;">
                        <div class="user-avatar" id="userAvatar">👤</div>
                        <span class="user-name" id="userName">游客</span>
                        <button class="logout-btn" onclick="logout()">退出</button>
                    </div>
                    
                    <button class="history-btn" onclick="window.location.href='/static/prescription_checker_v2.html'" title="处方安全检测" id="prescriptionCheckerBtn">
                        💊 处方检测
                    </button>
                    <button class="history-btn" onclick="openHistoryPage()" title="查看问诊历史" id="historyBtn">
                        📋 历史记录
                    </button>
                    <button class="new-chat-btn" onclick="createNewConversation()">
                        ✨ 新对话
                    </button>
                </div>
            </div>
        </header>


        <!-- 主内容区域 -->
        <div class="main-content">

            <div class="content-wrapper">
                <!-- 左侧栏 -->
                <aside class="sidebar">
                <!-- 医生选择区域 -->
                <div class="doctor-section">
                    <h3 class="section-title">👨‍⚕️ 选择医师</h3>
                    <div class="doctors-grid" id="doctorsGrid">
                        <!-- 医生卡片将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 工具区域 -->
                <div class="tools-section">
                    <!-- 多图片上传 - 舌诊 + 面诊 -->
                    <div class="tool-group">
                        <h4 class="tool-title">📸 图像诊断</h4>
                        
                        <!-- 舌诊图片上传 -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">👅 舌诊图片</h5>
                            <div class="upload-area" id="tongueUploadArea" onclick="triggerTongueUpload()">
                                <div class="upload-icon">📷</div>
                                <div class="upload-text">点击上传舌诊照片</div>
                            </div>
                            <input type="file" id="tongueImageUpload" accept="image/*" style="display: none;" onchange="handleTongueImageUpload(event)">
                        </div>
                        
                        <!-- 面诊图片上传 -->
                        <div class="upload-section">
                            <h5 class="upload-subtitle">😊 面诊图片</h5>
                            <div class="upload-area" id="faceUploadArea" onclick="triggerFaceUpload()">
                                <div class="upload-icon">📷</div>
                                <div class="upload-text">点击上传面诊照片</div>
                            </div>
                            <input type="file" id="faceImageUpload" accept="image/*" style="display: none;" onchange="handleFaceImageUpload(event)">
                        </div>
                        
                        <!-- 上传状态 -->
                        <div class="upload-status" id="uploadStatus" style="display: none;">
                            <div class="status-item" id="tongueStatus">👅 舌诊: <span>未上传</span></div>
                            <div class="status-item" id="faceStatus">😊 面诊: <span>未上传</span></div>
                        </div>
                    </div>

                    <!-- 语音功能 -->
                    <div class="tool-group">
                        <h4 class="tool-title">🎤 语音功能</h4>
                        <div class="voice-controls">
                            <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">
                                开始语音输入
                            </button>
                            <label class="auto-speak">
                                <input type="checkbox" id="autoSpeak">
                                <span>自动朗读回复</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- 右侧对话区域 -->
            <main class="chat-area">
                <!-- 当前医生信息条 -->
                <div class="current-doctor-bar" id="currentDoctorBar">
                    <div class="current-doctor-avatar" id="currentDoctorAvatar">🤖</div>
                    <div class="current-doctor-info">
                        <h2 id="currentDoctorName">请选择医师</h2>
                        <p class="current-doctor-desc" id="currentDoctorDesc">当前医师：张仲景</p>
                    </div>
                </div>

                <!-- 对话状态指示器 -->
                <div id="conversationStateIndicator" class="conversation-state-indicator">
                    <div class="state-indicator">
                        <span class="state-icon">🔄</span>
                        <span class="state-label">初始问诊</span>
                    </div>
                </div>

                <!-- 对话消息区域 -->
                <div class="messages-container" id="messagesContainer">
                    <!-- 默认医生已选中，不需要选择提示 -->
                </div>

                <!-- 加载动画 -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <div>AI正在思考中...</div>
                </div>

                <!-- 输入区域 -->
                <div class="input-area">
                    <div class="input-helper">
                        <button onclick="showGuidance()" class="guidance-trigger">💡 问诊指导</button>
                        <span class="helper-text">不知道怎么描述症状？点击查看问诊指导</span>
                    </div>
                    <div class="input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="请描述您的症状或问题..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                            oninput="adjustTextareaHeight()"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            →
                        </button>
                    </div>
                </div>
            </main>
            </div> <!-- end content-wrapper -->
        </div>
    </div>

    <script>
        // 全局变量
        let currentConversationId = '';
        let selectedDoctor = 'jin_daifu'; // 默认金大夫
        let isVoiceRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        
        // 认证相关变量
        let currentUser = null;
        let userToken = null;

        // 医生数据（动态加载）
        let doctors = {};
        
        // 医生默认头像映射（用于API返回的医生数据）
        const doctorAvatarMap = {
            "jin_daifu": "👨‍⚕️",
            "zhang_zhongjing": "🎯",
            "ye_tianshi": "🌿"
        };
        
        // 从API加载医生列表
        async function loadDoctors() {
            try {
                const response = await fetch('/api/doctors/list');
                const result = await response.json();
                
                if (result.success && result.doctors) {
                    // 转换为前端需要的格式
                    doctors = {};
                    result.doctors.forEach(doctor => {
                        const doctorCode = doctor.doctor_code;
                        
                        // 解析specialties（可能是JSON字符串）
                        let specialty = "中医全科";
                        if (doctor.specialties) {
                            try {
                                const specs = JSON.parse(doctor.specialties);
                                specialty = Array.isArray(specs) ? specs.join('、') : doctor.specialties;
                            } catch {
                                specialty = doctor.specialties;
                            }
                        }
                        
                        // 🔧 修复specialty.split错误 - 确保specialty是字符串
                        const specialtyStr = String(specialty || "中医");
                        
                        doctors[doctorCode] = {
                            "name": doctor.name,
                            "school": specialtyStr.split('、')[0] || "中医",
                            "avatar": doctorAvatarMap[doctorCode] || "👨‍⚕️",
                            "specialty": specialtyStr,
                            "introduction": doctor.introduction || `${doctor.name}医师，擅长${specialtyStr}等疾病的诊治。`
                        };
                    });
                    
                    console.log('✅ 医生列表加载成功:', Object.keys(doctors).length, '位医生');
                    
                    // 更新医生选择器
                    updateDoctorSelector();
                } else {
                    console.error('❌ 医生列表加载失败:', result.message);
                    // 使用默认医生数据作为备选
                    loadDefaultDoctors();
                }
            } catch (error) {
                console.error('❌ 加载医生列表异常:', error);
                // 使用默认医生数据作为备选
                loadDefaultDoctors();
            }
        }
        
        // 加载默认医生数据（备选方案）
        function loadDefaultDoctors() {
            doctors = {
                "jin_daifu": {
                    "name": "金大夫",
                    "school": "经方大师", 
                    "avatar": "👨‍⚕️",
                    "specialty": "经方应用、疑难杂症、综合诊疗",
                    "introduction": "经方大师，深通古典医学，擅长运用经典方剂解决现代疑难杂症，临床经验丰富。"
                },
                "zhang_zhongjing": {
                    "name": "张仲景",
                    "school": "伤寒派", 
                    "avatar": "🎯",
                    "specialty": "外感病、内伤杂病、急症",
                    "introduction": "伤寒派以《伤寒论》为理论基础，擅长六经辨证，治疗外感热病和内伤杂病。用药精准，方证对应。"
                },
                "ye_tianshi": {
                    "name": "叶天士",
                    "school": "温病派",
                    "avatar": "🌿",
                    "specialty": "温病、时令病证、内科杂症",
                    "introduction": "温病派创始人，以《温热论》著称，擅长卫气营血辨证，治疗季节性疾病和内科疑难杂症。"
                }
            };
            console.log('⚠️ 使用默认医生数据');
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        
        /**
         * 初始化星级评价交互
         */
        function initializeStarRatings() {
            // 为所有星星添加点击事件
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('star')) {
                    const ratingGroup = e.target.closest('.star-rating');
                    if (ratingGroup) {
                        const category = ratingGroup.getAttribute('data-category');
                        const stars = ratingGroup.querySelectorAll('.star');
                        const rating = Array.from(stars).indexOf(e.target) + 1;
                        
                        handleStarRating(category, rating);
                    }
                }
            });
            
            // 为星星添加hover效果
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('star')) {
                    const ratingGroup = e.target.closest('.star-rating');
                    if (ratingGroup) {
                        const stars = ratingGroup.querySelectorAll('.star');
                        const hoverIndex = Array.from(stars).indexOf(e.target);
                        
                        stars.forEach((star, index) => {
                            if (index <= hoverIndex) {
                                star.style.color = '#ffd700';
                            } else {
                                star.style.color = '#ddd';
                            }
                        });
                    }
                }
            });
            
            // 恢复星星原本的状态（鼠标离开时）
            document.addEventListener('mouseout', function(e) {
                if (e.target.classList.contains('star')) {
                    const ratingGroup = e.target.closest('.star-rating');
                    if (ratingGroup) {
                        const stars = ratingGroup.querySelectorAll('.star');
                        const currentRating = parseInt(ratingGroup.getAttribute('data-rating') || '0');
                        
                        stars.forEach((star, index) => {
                            if (index < currentRating) {
                                star.style.color = '#ffd700';
                            } else {
                                star.style.color = '#ddd';
                            }
                        });
                    }
                }
            });
        }
        
        /**
         * 绑定评价模态框事件
         */
        function bindEvaluationModalEvents() {
            // 点击模态框背景关闭
            const modal = document.getElementById('evaluationModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideEvaluationModal();
                    }
                });
            }
            
            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('evaluationModal');
                    if (modal && modal.style.display === 'flex') {
                        hideEvaluationModal();
                    }
                    
                    const statsModal = document.getElementById('statisticsModal');
                    if (statsModal) {
                        closeStatisticsModal();
                    }
                }
            });
        }

        // 清理旧的localStorage数据，确保数据隔离
        function cleanupOldUserData() {
            // 清理旧格式的历史记录（不含用户ID的）
            const keys = Object.keys(localStorage);
            const oldHistoryKeys = keys.filter(key => 
                key.startsWith('tcm_doctor_history_') && 
                !key.includes('guest_portal_') && 
                !key.includes('smart_user_') &&
                !key.match(/tcm_doctor_history_[\w\-]+_[\w\-]+/)  // 不匹配新格式 userId_doctorId
            );
            
            oldHistoryKeys.forEach(key => {
                localStorage.removeItem(key);
                console.log('智能工作流页面已清理旧历史记录:', key);
            });
        }

        async function initializeApp() {
            console.log('🚀 初始化TCM-AI智能工作流系统');
            
            // 🔍 用户状态检测和管理
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const hasRealUser = !!(currentUser.id || currentUser.user_id);
            
            console.log('👤 用户状态检测:', hasRealUser ? '真实登录用户' : '访客模式');
            if (hasRealUser) {
                console.log('🔑 登录用户信息:', currentUser.username || currentUser.name || currentUser.id);
            }
            
            // 设置初始用户状态
            window.lastKnownUser = localStorage.getItem('currentUser');
            
            // 🔑 新增：检查URL参数是否需要恢复会话
            const urlParams = new URLSearchParams(window.location.search);
            const restoreSessionId = urlParams.get('restore_session');
            if (restoreSessionId) {
                console.log('🔄 检测到会话恢复请求:', restoreSessionId);
                // 延迟恢复，等待页面完全初始化
                setTimeout(() => {
                    restoreSessionFromHistory(restoreSessionId);
                }, 2000);
                
                // 清除URL参数避免重复恢复
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
            
            // 首先清理旧数据，确保数据隔离
            cleanupOldUserData();
            
            // 🔄 定期检测用户状态变化（每5秒检查一次）
            setInterval(() => {
                detectUserChange();
            }, 5000);
            
            // 🔧 先加载医生列表，再渲染医生卡片
            await loadDoctors();
            renderDoctorCards();
            loadConversationHistory(); // 这个函数内部会调用generateConversationId如果需要
            
            // 🔄 初始化ChatGPT风格对话管理系统
            initConversationManager();
            
            // 设置默认医生 - 金大夫（经方大师）
            // 🔧 修复重复欢迎消息：跳过历史记录加载，因为loadConversationHistory已经处理了
            setDefaultDoctor('jin_daifu', true);
            
            // 🧹 暴露全局清理函数（供外部调用）
            window.clearCurrentUserData = clearCurrentUserData;
            window.switchUserContext = switchUserContext;
            
            // 🔑 修复：确保在页面完全准备好后再恢复处方状态
            // 🔑 旧的统一恢复机制已禁用，使用新的简化版恢复系统
            function startUnifiedPrescriptionRecovery() {
                console.log('⚠️ 旧的统一恢复机制已禁用，请使用简化版恢复系统');
                // 功能已转移到 /static/js/simple_recovery.js
            }
            
            // 🔑 使用新的简化版恢复系统，替代复杂的统一恢复机制
            // setTimeout(startUnifiedPrescriptionRecovery, 3000);
            console.log('🔄 将使用简化版处方恢复系统...');
            
            // 🔗 添加页面级用户管理控制
            addUserManagementControls();
            
            // 添加调试功能（仅在开发环境或特定条件下）
            if (isDebugMode()) {
                console.log('🔧 调试模式已启用');
                console.log('📋 可用调试命令:');
                console.log('  - diagnoseHistoryIssues(): 诊断历史记录问题');
                console.log('  - checkLocalStorageUsage(): 检查存储使用情况');
                console.log('  - cleanOldHistoryRecords(): 清理旧的历史记录');
                console.log('  - clearCurrentUserData(): 清理当前用户数据');
                console.log('  - switchUserContext(): 切换用户上下文');
                
                // 将调试函数暴露到全局
                window.diagnoseHistoryIssues = diagnoseHistoryIssues;
                window.checkLocalStorageUsage = checkLocalStorageUsage;
                window.cleanOldHistoryRecords = cleanOldHistoryRecords;
                
                // 页面加载后自动运行一次诊断
                setTimeout(() => {
                    console.log('\n🔍 自动历史记录诊断:');
                    diagnoseHistoryIssues();
                }, 1000);
            }
        }
        
        // 设置默认医生（不会有确认提示）
        function setDefaultDoctor(doctorKey, skipHistoryLoad = false) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // 更新UI显示
            const cards = document.querySelectorAll('.doctor-card');
            cards.forEach((card, index) => {
                if (Object.keys(doctors)[index] === doctorKey) {
                    card.classList.add('selected');
                }
            });
            
            // 更新顶部医生信息条
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `擅长：${doctor.specialty}`;
            
            // 🔧 修复重复加载问题：只在非跳过模式下加载历史记录
            if (!skipHistoryLoad) {
                loadDoctorHistory(doctorKey);
            }
        }

        // 生成对话ID - 基于用户ID隔离
        function generateConversationId() {
            const userId = getCurrentUserId();
            
            currentConversationId = 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            
            // 使用用户ID作为存储key，确保不同用户隔离
            const storageKey = `conversationId_${userId}`;
            localStorage.setItem(storageKey, currentConversationId);
        }
        
        // 获取当前用户ID
        function getCurrentUserId() {
            // 🚨 重要：智能工作流页面(index_smart_workflow.html)只使用登录用户数据
            // 这确保与游客页面的数据完全隔离
            
            // 🔑 新增：检查URL参数中的用户ID（从历史页面跳转）
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            if (urlUserId && urlUserId !== 'anonymous') {
                console.log('🔗 从URL参数获取用户ID:', urlUserId);
                // 将URL用户ID存储到localStorage，确保后续使用
                localStorage.setItem('currentUserId', urlUserId);
                // 清理URL参数，避免刷新时重复处理
                if (window.history && window.history.replaceState) {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
                return urlUserId;
            }
            
            // 🔑 优先使用真实登录用户信息 - 检查多个存储位置
            let realUser = null;
            
            // 🔑 修复：优先检查currentUser存储（更可靠）
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.id || currentUser.user_id || currentUser.global_user_id) {
                // 过滤掉临时用户ID，只使用真实登录用户
                const userId = currentUser.global_user_id || currentUser.user_id || currentUser.id;
                if (userId && !userId.startsWith('temp_user_') && !userId.startsWith('smart_user_') && userId !== 'anonymous') {
                    realUser = currentUser;
                    console.log('🔑 从currentUser获取真实用户:', realUser);
                }
            }
            
            // 检查userData存储（备选）
            if (!realUser) {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.id || userData.user_id || userData.global_user_id) {
                    const userId = userData.global_user_id || userData.user_id || userData.id;
                    if (userId && userId !== 'anonymous') {
                        realUser = userData;
                        console.log('🔑 从userData获取真实用户:', realUser);
                    }
                }
            }
            
            // 如果找到真实用户
            if (realUser) {
                // 🔑 修复：优先使用global_user_id，然后是user_id，最后是id
                const userId = realUser.global_user_id || realUser.user_id || realUser.id;
                if (userId && userId !== 'undefined' && userId !== null) {
                    console.log('🔑 使用真实登录用户ID:', userId);
                    return userId; // 直接返回用户ID，不加前缀避免混淆
                }
            }
            
            // ⚠️ 访客模式 - 智能工作流程页面的临时用户ID
            const smartUser = localStorage.getItem('currentUserId');
            if (smartUser) {
                console.log('🔄 使用已有临时访客用户ID:', smartUser);
                return smartUser; // 已有smart_user_前缀
            }
            
            // 🔑 关键修复：检查是否有对话ID相关的用户信息
            // 如果用户之前进行过问诊，尝试从对话ID中恢复用户ID
            const allStorageKeys = Object.keys(localStorage);
            const conversationKeys = allStorageKeys.filter(key => key.startsWith('conversationId_'));
            
            if (conversationKeys.length > 0) {
                // 从对话ID key中提取用户ID（格式：conversationId_{userId}）
                const existingUserId = conversationKeys[0].replace('conversationId_', '');
                console.log('🔄 从对话ID恢复用户ID:', existingUserId);
                localStorage.setItem('currentUserId', existingUserId);
                return existingUserId;
            }
            
            // 🔑 关键修复：检查历史记录键，尝试恢复用户ID
            const historyKeys = allStorageKeys.filter(key => key.startsWith('tcm_doctor_history_'));
            if (historyKeys.length > 0) {
                // 从历史记录key中提取用户ID（格式：tcm_doctor_history_{userId}_{doctorId}）
                const historyKey = historyKeys[0];
                const parts = historyKey.split('_');
                if (parts.length >= 4) {
                    const existingUserId = parts.slice(3, -1).join('_'); // 处理用户ID中可能包含下划线的情况
                    console.log('🔄 从历史记录恢复用户ID:', existingUserId);
                    localStorage.setItem('currentUserId', existingUserId);
                    return existingUserId;
                }
            }
            
            // 🆕 生成新的访客用户ID（只有在完全没有历史记录时）
            const newSmartId = 'smart_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('currentUserId', newSmartId);
            console.log('🆕 生成全新访客用户ID:', newSmartId);
            return newSmartId;
        }

        /**
         * 🧹 清理当前用户的所有数据（用于登出）
         */
        function clearCurrentUserData() {
            try {
                const currentUserId = getCurrentUserId();
                console.log('🧹 开始清理用户数据，用户ID:', currentUserId);
                
                // 1. 清理当前用户的所有历史记录
                const keys = Object.keys(localStorage);
                const userHistoryKeys = keys.filter(key => 
                    key.includes(`_${currentUserId}_`) || 
                    key.endsWith(`_${currentUserId}`)
                );
                
                let cleanedCount = 0;
                userHistoryKeys.forEach(key => {
                    localStorage.removeItem(key);
                    cleanedCount++;
                    console.log('🗑️ 删除用户数据:', key);
                });
                
                // 2. 清理用户认证信息
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userToken');
                localStorage.removeItem('currentUserId');
                
                // 3. 重置全局变量
                window.currentUser = null;
                window.userToken = null;
                window.currentConversationId = null;
                window.selectedDoctor = null;
                
                // 4. 清理UI状态
                clearAllMessages();
                resetDoctorSelection();
                
                console.log(`✅ 用户数据清理完成，共删除 ${cleanedCount} 项数据`);
                return cleanedCount;
                
            } catch (error) {
                console.error('❌ 清理用户数据失败:', error);
                return 0;
            }
        }

        /**
         * 🔄 切换用户时的数据隔离处理
         */
        function switchUserContext() {
            try {
                // 清理之前用户的UI状态
                clearAllMessages();
                resetDoctorSelection();
                
                // 重新初始化新用户的状态
                const newUserId = getCurrentUserId();
                console.log('🔄 切换到用户上下文:', newUserId);
                
                // 加载新用户的历史记录
                setTimeout(() => {
                    loadUserHistoryForAllDoctors();
                }, 100);
                
            } catch (error) {
                console.error('❌ 切换用户上下文失败:', error);
            }
        }

        /**
         * 🗑️ 清理所有消息
         */
        function clearAllMessages() {
            const containers = ['messagesContainer', 'mobileMessagesContainer'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    console.log('🗑️ 清理消息容器:', containerId);
                }
            });
        }

        /**
         * 🔄 重置医生选择状态
         */
        function resetDoctorSelection() {
            window.selectedDoctor = null;
            
            // 重置医生选择UI
            const doctorCards = document.querySelectorAll('.doctor-card');
            doctorCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            // 重置手机版医生选择
            const mobileDoctorSelect = document.getElementById('mobileDoctorSelect');
            if (mobileDoctorSelect) {
                mobileDoctorSelect.value = '';
            }
            
            console.log('🔄 医生选择状态已重置');
        }

        /**
         * 保存对话到服务器数据库
         */
        async function saveConversationToServer(messages, doctorId) {
            // 只为已登录用户保存到服务器
            if (!currentUser || !userToken) {
                console.log('📝 访客用户，跳过服务器保存');
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                
                // 检查是否是临时用户ID
                if (userId && (userId.startsWith('temp_user_') || userId.startsWith('smart_user_') || userId.startsWith('guest_'))) {
                    console.log('📝 临时用户，跳过服务器保存');
                    return;
                }
                
                // 提取主要症状（从第一条用户消息）
                const firstUserMessage = messages.find(msg => msg.type === 'user');
                const chiefComplaint = firstUserMessage ? firstUserMessage.content.substring(0, 100) : '问诊咨询';
                
                // 构建服务器保存的数据
                const serverData = {
                    consultation_id: currentConversationId,
                    patient_id: userId,
                    doctor_id: doctorId,
                    conversation_log: JSON.stringify(messages),
                    status: 'completed',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const response = await fetch('/api/consultation/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(serverData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('✅ 对话已保存到服务器数据库:', currentConversationId);
                        console.log('📊 保存详情:', {
                            consultation_id: serverData.consultation_id,
                            patient_id: serverData.patient_id,
                            doctor_id: serverData.doctor_id,
                            message_count: serverData.message_count
                        });
                    } else {
                        console.warn('⚠️ 服务器保存响应异常:', result.message);
                    }
                } else {
                    const errorText = await response.text();
                    console.warn('⚠️ 服务器保存失败，状态码:', response.status, '错误:', errorText);
                }
                
            } catch (error) {
                console.error('❌ 保存到服务器失败:', error);
                // 不影响正常流程，只记录错误
            }
        }

        /**
         * 🔍 检测用户状态变化
         */
        function detectUserChange() {
            const currentStoredUser = localStorage.getItem('currentUser');
            const lastKnownUser = window.lastKnownUser || null;
            
            if (currentStoredUser !== lastKnownUser) {
                console.log('🔍 检测到用户状态变化');
                console.log('之前用户:', lastKnownUser);
                console.log('当前用户:', currentStoredUser);
                
                window.lastKnownUser = currentStoredUser;
                
                // 用户状态发生变化，执行切换处理
                handleUserSwitch();
                return true;
            }
            
            return false;
        }

        /**
         * 🔄 处理用户切换
         */
        function handleUserSwitch() {
            console.log('🔄 开始处理用户切换...');
            
            // 1. 清理当前页面状态
            clearAllMessages();
            resetDoctorSelection();
            
            // 2. 清理旧用户的会话数据
            clearCurrentUserData();
            
            // 3. 重新初始化当前用户
            const newUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (newUser.id || newUser.user_id) {
                currentUser = newUser;
                console.log('🔑 切换到认证用户:', newUser.username || newUser.display_name);
                
                // 4. 重新加载该用户的数据
                loadConversationHistory();
                updateUserInterface(true);
            } else {
                console.log('⚠️ 切换到访客模式');
                currentUser = null;
                userToken = null;
                updateUserInterface(false);
            }
            
            // 5. 显示切换通知
            showMessage('用户身份已更新', 'info');
        }

        /**
         * 🧹 清理当前用户的所有数据
         */
        function clearCurrentUserData() {
            try {
                const currentUserId = getCurrentUserId();
                console.log('🧹 开始清理用户数据，用户ID:', currentUserId);
                
                // 1. 清理当前用户的所有历史记录
                const keys = Object.keys(localStorage);
                const userHistoryKeys = keys.filter(key => 
                    key.includes(`_${currentUserId}_`) || 
                    key.endsWith(`_${currentUserId}`) ||
                    key.startsWith(`tcm_doctor_history_${currentUserId}`) ||
                    key.startsWith(`conversationId_${currentUserId}`)
                );
                
                let cleanedCount = 0;
                userHistoryKeys.forEach(key => {
                    localStorage.removeItem(key);
                    cleanedCount++;
                    console.log('🗑️ 删除用户数据:', key);
                });
                
                // 2. 重置全局变量
                window.currentConversationId = null;
                window.selectedDoctor = null;
                
                // 3. 清理UI状态
                clearAllMessages();
                resetDoctorSelection();
                
                console.log(`✅ 用户数据清理完成，共删除 ${cleanedCount} 项数据`);
                return cleanedCount;
            } catch (error) {
                console.error('❌ 用户数据清理失败:', error);
                return 0;
            }
        }

        /**
         * 🧹 清理旧用户数据（防止数据泄露）
         */
        function cleanupOldUserData() {
            const currentUserId = getCurrentUserId();
            const keys = Object.keys(localStorage);
            
            // 查找其他用户的数据
            const otherUserKeys = keys.filter(key => 
                (key.includes('real_user_') || key.includes('smart_user_') || key.includes('usr_')) && 
                !key.includes(currentUserId)
            );
            
            if (otherUserKeys.length > 0) {
                console.log('🧹 清理其他用户的遗留数据:', otherUserKeys.length, '项');
                otherUserKeys.forEach(key => {
                    localStorage.removeItem(key);
                    console.log('🗑️ 删除遗留数据:', key);
                });
            }
        }

        /**
         * 🔄 切换用户上下文（供调试使用）
         */
        function switchUserContext() {
            handleUserSwitch();
            updateCurrentUserDisplay();
            return true;
        }

        /**
         * 🔗 添加页面级用户管理控制
         */
        function addUserManagementControls() {
            // 只在调试模式或特定情况下显示
            if (!isDebugMode()) return;
            
            const controlsHTML = `
                <div id="userManagementPanel" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; z-index: 9999; font-size: 12px; max-width: 200px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">👤 用户管理</div>
                    <div id="currentUserDisplay" style="margin-bottom: 8px; font-size: 11px;"></div>
                    <button onclick="testUserDataIsolation()" style="width: 100%; margin-bottom: 4px; padding: 4px; font-size: 11px;">🔍 测试数据隔离</button>
                    <button onclick="clearCurrentUserData() && showMessage('用户数据已清理', 'success')" style="width: 100%; margin-bottom: 4px; padding: 4px; font-size: 11px;">🧹 清理当前用户</button>
                    <button onclick="switchUserContext() && showMessage('用户上下文已切换', 'info')" style="width: 100%; padding: 4px; font-size: 11px;">🔄 切换用户上下文</button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', controlsHTML);
            updateCurrentUserDisplay();
            
            // 每5秒更新一次用户显示
            setInterval(updateCurrentUserDisplay, 5000);
        }

        /**
         * 🔄 更新当前用户显示
         */
        function updateCurrentUserDisplay() {
            const display = document.getElementById('currentUserDisplay');
            if (!display) return;
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const currentUserId = getCurrentUserId();
            
            if (currentUser.id || currentUser.user_id) {
                display.innerHTML = `🔑 真实用户<br>${currentUser.username || currentUser.name || 'N/A'}<br>ID: ${currentUserId}`;
            } else {
                display.innerHTML = `👤 访客用户<br>ID: ${currentUserId}`;
            }
        }

        

        /**
         * 🧪 测试用户数据隔离
         */
        function testUserDataIsolation() {
            console.log('🧪 开始用户数据隔离测试');
            
            const currentUserId = getCurrentUserId();
            const allKeys = Object.keys(localStorage);
            
            console.log('当前用户ID:', currentUserId);
            console.log('localStorage总键数:', allKeys.length);
            
            // 查找当前用户相关的数据
            const userKeys = allKeys.filter(key => 
                key.includes(currentUserId) ||
                key.includes('currentUser') ||
                key.includes('userToken') ||
                key.includes('currentUserId')
            );
            
            console.log('当前用户相关数据键:', userKeys);
            
            // 查找其他用户的数据（泄露检测）
            const otherUserKeys = allKeys.filter(key => 
                (key.includes('real_user_') || key.includes('smart_user_')) && 
                !key.includes(currentUserId)
            );
            
            console.log('其他用户数据键（数据泄露检测）:', otherUserKeys);
            
            if (otherUserKeys.length > 0) {
                console.warn('⚠️ 检测到其他用户数据，可能存在数据泄露');
                showMessage(`警告：检测到${otherUserKeys.length}个其他用户数据项`, 'warning');
            } else {
                console.log('✅ 数据隔离正常');
                showMessage('数据隔离测试通过', 'success');
            }
            
            return {
                currentUserId,
                userKeys: userKeys.length,
                otherUserKeys: otherUserKeys.length,
                isolated: otherUserKeys.length === 0
            };
        }

        // 全局变量：推荐医生列表 - AI推荐医生功能已移除
        // let recommendedDoctors = [];
        // let isUsingRecommendedDoctors = false;

        // 获取AI推荐医生 - AI推荐医生功能已移除
        // async function getRecommendedDoctors(symptoms) {
        //     // AI推荐医生功能已移除，返回空数组
        //     return [];
        // }

        // 渲染医生卡片 - 已简化，移除AI推荐功能
        function renderDoctorCards() {
            const container = document.getElementById('doctorsGrid');
            container.innerHTML = '';
            
            // 直接使用默认医生列表
            Object.entries(doctors).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'doctor-card';
                card.onclick = () => selectDoctor(key, doctor);
                
                card.innerHTML = `
                    <div class="doctor-header">
                        <div class="doctor-info">
                            <div class="doctor-avatar">${doctor.avatar}</div>
                            <div class="doctor-details">
                                <h3>${doctor.name}</h3>
                                <span class="doctor-school">${doctor.school}</span>
                            </div>
                        </div>
                        <div class="selection-indicator">
                            <span style="font-size: 12px;">✓</span>
                        </div>
                    </div>
                    <div class="doctor-specialty">
                        <strong>擅长：</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // 为医生分配头像
        function getAvatarForDoctor(doctorName) {
            const avatarMap = {
                '张仲景': '🎯',
                '金大夫': '🎯',  // 金大夫使用张仲景的头像
                '叶天士': '🌡️', 
                '李东垣': '🌱',
                '郑钦安': '🔥',
                '刘渡舟': '⚖️'
            };
            return avatarMap[doctorName] || '👨‍⚕️';
        }
        
        // 更新医生选择器（在医生数据加载后调用）
        function updateDoctorSelector() {
            // 更新当前医生显示
            const currentDoctorDesc = document.getElementById('currentDoctorDesc');
            if (currentDoctorDesc && selectedDoctor && doctors[selectedDoctor]) {
                currentDoctorDesc.textContent = `当前医师：${doctors[selectedDoctor].name}`;
            }
            
            // 确保第一个医生被设为默认
            if (Object.keys(doctors).length > 0 && !selectedDoctor) {
                const firstDoctorKey = Object.keys(doctors)[0];
                selectedDoctor = firstDoctorKey;
            }
            
            // 🔑 修复：更新移动端医生显示
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                renderMobileDoctorCards();
                
                // 更新移动端当前医生信息
                if (selectedDoctor && doctors[selectedDoctor]) {
                    const doctor = doctors[selectedDoctor];
                    const mobileDoctorAvatar = document.getElementById('mobileDoctorAvatar');
                    const mobileDoctorName = document.getElementById('mobileDoctorName');
                    const mobileDoctorDesc = document.getElementById('mobileDoctorDesc');
                    
                    if (mobileDoctorAvatar) mobileDoctorAvatar.textContent = doctor.avatar;
                    if (mobileDoctorName) mobileDoctorName.textContent = doctor.name;
                    if (mobileDoctorDesc) mobileDoctorDesc.textContent = doctor.school;
                }
            }
        }

        // 添加医生切换按钮 - AI推荐医生功能已移除
        // function addDoctorToggleButton(container) {
        //     // AI推荐医生功能已移除，不再需要切换按钮
        // }

        // 智能推荐医生（基于用户输入的症状）- AI推荐医生功能已移除
        // async function recommendDoctorsForSymptoms(userInput) {
        //     // AI推荐医生功能已移除，不再处理症状推荐
        // }

        // 从文本中提取症状关键词
        function extractSymptomsFromText(text) {
            const symptomKeywords = [
                '头痛', '头疼', '头晕', '眩晕', '失眠', '焦虑', '抑郁', '心悸', '胸闷', '乏力', '发热',
                '胃痛', '胃疼', '肚子疼', '肚子痛', '腹痛', '腹胀', '腹泻', '便秘', '食欲不振', '消化不良', 
                '咳嗽', '哮喘', '鼻炎', '气喘', '感冒', '发烧', '喉咙痛', '咽痛', '流鼻涕',
                '月经不调', '痛经', '白带异常', '不孕', '更年期', '妇科', '小儿发热', '小儿咳嗽', '小儿腹泻',
                '湿疹', '痤疮', '皮肤病', '青春痘', '腰痛', '关节痛', '颈椎病', '膝盖痛', '耳鸣', '听力下降', '鼻塞',
                '牙痛', '口腔溃疡', '便血', '尿频', '尿急', '水肿', '出汗', '盗汗', '手脚冰凉', '四肢无力'
            ];
            
            const foundSymptoms = [];
            for (const symptom of symptomKeywords) {
                if (text.includes(symptom)) {
                    foundSymptoms.push(symptom);
                }
            }
            return foundSymptoms;
        }
        
        // 症状同义词映射
        function getSymptomSynonyms() {
            return {
                '腹痛': ['肚子疼', '肚子痛', '腹部疼痛', '腹部不适'],
                '肚子疼': ['腹痛', '肚子痛', '腹部疼痛'],
                '头痛': ['头疼', '头部疼痛'],
                '胃痛': ['胃疼', '胃部疼痛', '胃不舒服'],
                '发热': ['发烧', '体温升高'],
                '咽痛': ['喉咙痛', '咽喉疼痛']
            };
        }
        
        // 检查症状是否相关（考虑同义词和医学关联）
        function isSymptomsRelated(userSymptoms, aiSymptom) {
            const synonyms = getSymptomSynonyms();
            
            // 直接匹配
            if (userSymptoms.includes(aiSymptom)) {
                return true;
            }
            
            // 同义词检查
            for (const userSymptom of userSymptoms) {
                if (synonyms[userSymptom] && synonyms[userSymptom].includes(aiSymptom)) {
                    return true;
                }
                if (synonyms[aiSymptom] && synonyms[aiSymptom].includes(userSymptom)) {
                    return true;
                }
            }
            
            // 医学关联性检查（常见的症状组合）
            const medicalAssociations = {
                '腹痛': ['腹泻', '便秘', '食欲不振', '腹胀'],
                '肚子疼': ['腹泻', '便秘', '食欲不振', '腹胀'],
                '头痛': ['头晕', '眩晕', '失眠'],
                '发热': ['乏力', '出汗'],
                '感冒': ['咳嗽', '流鼻涕', '鼻塞', '喉咙痛']
            };
            
            for (const userSymptom of userSymptoms) {
                if (medicalAssociations[userSymptom] && medicalAssociations[userSymptom].includes(aiSymptom)) {
                    return true;
                }
            }
            
            return false;
        }

        // 选择医生（支持默认医生和推荐医生）
        function selectDoctor(doctorKey, doctorData = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            // 检查是否有真正的对话内容（用户消息或AI回复）
            const userMessages = messagesContainer.querySelectorAll('.message.user');
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            const hasExistingMessages = userMessages.length > 0 || aiMessages.length > 0;
            
            // 切换医生时保存当前医生的对话历史，不再清空历史记录
            if (selectedDoctor && selectedDoctor !== doctorKey && hasExistingMessages) {
                // 保存当前医生的对话历史
                saveCurrentDoctorHistory();
            }
            
            // 移除之前的选中状态
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });

            // 添加新的选中状态
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }

            const previousDoctor = selectedDoctor;
            selectedDoctor = doctorKey;
            
            // 获取医生信息（优先使用传入的doctorData，然后是默认doctors对象）
            const doctor = doctorData || doctors[doctorKey] || {
                name: '医生',
                school: '中医师', 
                avatar: '👨‍⚕️',
                specialty: '中医内科'
            };

            // 更新顶部医生信息条
            document.getElementById('currentDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('currentDoctorName').textContent = `${doctor.name} - ${doctor.school}`;
            document.getElementById('currentDoctorDesc').textContent = `擅长：${doctor.specialty}`;

            // 切换医生时生成新的对话ID，确保AI身份正确切换
            if (previousDoctor && previousDoctor !== doctorKey) {
                // 生成新的对话ID，强制开始新对话
                generateConversationId();
            }
            
            // 加载当前医生的对话历史，不清空历史记录
            if (!previousDoctor || previousDoctor !== doctorKey) {
                // 加载该医生的历史对话
                loadDoctorHistory(doctorKey);
            }
            
            // 显示输入框
            const inputContainer = document.querySelector('.input-container');
            if (inputContainer) {
                inputContainer.classList.add('show');
            }
            
            // 移动端：关闭医生选择浮层
            if (window.innerWidth <= 768) {
                closeMobileDoctorSelector();
            }
        }

        // 添加消息
        async function addMessage(sender, content, showFeedback = false, isPaid = false, prescriptionId = null) {
            console.log('🔍 addMessage被调用:', {
                sender,
                contentLength: content ? content.length : 0,
                contentPreview: content ? content.substring(0, 50) + '...' : 'null',
                showFeedback,
                isPaid,
                prescriptionId
            });
            
            const container = document.getElementById('messagesContainer');
            if (!container) {
                console.error('❌ 找不到messagesContainer');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // 🆕 使用处方渲染器处理内容
            let processedContent = content;
            if (sender === 'ai') {
                console.log('🔍 处方渲染检查:', {
                    prescriptionRenderer存在: !!window.prescriptionRenderer,
                    isPaid: isPaid,
                    prescriptionId: prescriptionId,
                    内容长度: content.length
                });
                
                if (window.simplePrescriptionManager) {
                    // 使用简化版处方管理器
                    console.log('✅ 使用简化版处方管理器处理内容');
                    processedContent = await window.simplePrescriptionManager.processContent(content, prescriptionId);
                } else if (window.prescriptionContentRenderer) {
                    // 备用：使用原来的处方渲染器
                    console.log('⚠️ 使用备用处方渲染器');
                    processedContent = window.prescriptionContentRenderer.renderContent(content, prescriptionId);
                    
                    // 🔧 保存原始内容用于支付后解锁
                    if (prescriptionId && content) {
                        // 将原始内容保存到即将创建的消息元素中
                        setTimeout(() => {
                            const messages = document.querySelectorAll('.message.ai');
                            const lastMessage = messages[messages.length - 1];
                            if (lastMessage) {
                                const messageTextEl = lastMessage.querySelector('.message-text');
                                if (messageTextEl && !messageTextEl.getAttribute('data-original-content')) {
                                    messageTextEl.setAttribute('data-original-content', content);
                                    console.log('✅ 已保存原始内容用于支付后解锁');
                                }
                            }
                        }, 100);
                    }
                } else {
                    // 最终备用方案：直接格式化内容
                    console.log('⚠️ 简化版处方管理器不存在，使用基础格式化');
                    processedContent = formatMessage(content);
                }
            }
            
            // 如果有处方ID，保存到元素属性中
            if (prescriptionId) {
                messageDiv.setAttribute('data-prescription-id', prescriptionId);
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? '👤' : (selectedDoctor ? doctors[selectedDoctor].avatar : '🤖')}</div>
                <div class="message-content">
                    <div class="message-text">${processedContent}</div>
                    <div class="message-time">${timeStr}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">这个回答有帮助吗？</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">😊 很好</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">👍 不错</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">👌 还行</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">👎 不好</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">😞 很差</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            // 自动朗读AI回复
            if (sender === 'ai' && document.getElementById('autoSpeak').checked) {
                speakText(content);
            }
            
            // 自动保存当前医生的对话历史
            if (selectedDoctor) {
                setTimeout(() => saveCurrentDoctorHistory(), 100); // 延迟100ms确保DOM更新完成
                
                // 🔄 自动更新ChatGPT风格对话管理系统
                setTimeout(() => {
                    updateConversationListAfterMessage();
                }, 200);
            }
        }

        // 格式化消息内容
        function formatMessage(content) {
            if (!content) return '';
            
            // 检查是否包含诊疗方案XML标签
            if (content.includes('<诊疗方案>')) {
                return formatTCMPrescription(content);
            }
            
            // 增强的Markdown处理 - 明确的层次和样式
            return content
                // 处理【处方】标签 - 特殊高亮样式
                .replace(/\*\*【处方】\*\*/g, '<div style="background: linear-gradient(135deg, #2d5aa0, #4a7bc8); color: white; padding: 10px 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; font-size: 16px; text-align: center;">📋 中药处方</div>')
                // 处理【用法】【注意】等标签
                .replace(/\*\*【(用法|注意|禁忌|功效)】\*\*/g, '<div style="background: #f3f4f6; color: #374151; padding: 8px 12px; border-radius: 6px; margin: 10px 0; font-weight: bold; border-left: 4px solid #6b7280;">$1</div>')
                // 处理其他粗体标签【xxx】
                .replace(/\*\*【(.*?)】\*\*/g, '<strong style="color: #2d5aa0; font-size: 15px; background: #e0f2fe; padding: 2px 6px; border-radius: 4px;">【$1】</strong>')
                // 处理其他粗体文本
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937; font-weight: bold;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color: #6b7280;">$1</em>')
                // 处理#####标记 - 转换为分割线
                .replace(/#{5,}/g, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb; background: linear-gradient(to right, #e5e7eb, transparent);">')
                // 处理###标记 - 转换为明显的小标题
                .replace(/###\s*(.*?)(?=\n|$)/g, '<h4 style="margin: 20px 0 12px 0; color: #2d5aa0; font-size: 17px; font-weight: bold; padding-left: 8px; border-left: 4px solid #2d5aa0; background: #f8fafc;">$1</h4>')
                // 处理##标记 - 转换为更大的中标题  
                .replace(/##\s*(.*?)(?=\n|$)/g, '<h3 style="margin: 25px 0 15px 0; color: #1f2937; font-size: 19px; font-weight: bold; padding: 8px 12px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 6px;">$1</h3>')
                // 处理#标记 - 转换为大标题
                .replace(/^#\s*(.*?)(?=\n|$)/gm, '<h2 style="margin: 30px 0 20px 0; color: #111827; font-size: 22px; font-weight: bold; text-align: center; padding: 12px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px;">$1</h2>')
                // 处理药材列表 - 特殊样式
                .replace(/([一-龟\u4e00-\u9fff]+)\s+(\d+)g/g, '<span style="display: inline-block; background: #ecfdf5; color: #065f46; padding: 2px 6px; margin: 1px 3px; border-radius: 4px; font-weight: 500; border: 1px solid #d1fae5;">$1 <strong>$2g</strong></span>')
                .replace(/\n\n/g, '<br><br>')  // 段落间距
                .replace(/\n/g, '<br>')        // 普通换行
                .replace(/(\d+\.\s)/g, '<br><span style="color: #2d5aa0; font-weight: bold;">$1</span>') // 数字列表样式
                .replace(/^<br>/, '');         // 移除开头的换行
        }

        // 格式化中医处方 - 全新设计
        function formatTCMPrescription(content) {
            // 检查是否包含XML格式
            const hasXMLFormat = content.includes('<诊疗方案>');
            
            if (hasXMLFormat) {
                return formatXMLPrescription(content);
            } else {
                // 如果没有XML格式，尝试智能解析文本格式
                return formatTextPrescription(content);
            }
        }

        // XML格式处方解析
        function formatXMLPrescription(content) {
            const prescriptionMatch = content.match(/<诊疗方案>([\s\S]*?)<\/诊疗方案>/);
            if (!prescriptionMatch) {
                return formatTextPrescription(content);
            }
            
            const prescriptionContent = prescriptionMatch[1];
            let formattedHTML = '<div class="modern-tcm-report">';
            
            // 定义各个部分的配置
            const sections = [
                { name: '主诉', key: '主诉', icon: '🩺', color: '#ef4444' },
                { name: '现病史', key: '现病史', icon: '📋', color: '#3b82f6' },
                { name: '望诊所见', key: '望诊所见', icon: '👁️', color: '#10b981' },
                { name: '病机分析', key: '病机分析', icon: '🧠', color: '#8b5cf6' },
                { name: '证型诊断', key: '证型诊断', icon: '🎯', color: '#f59e0b' },
                { name: '治法', key: '治法', icon: '⚡', color: '#06b6d4' },
                { name: '方剂选用', key: '方剂选用', icon: '📜', color: '#84cc16' },
                { name: '处方建议', key: '处方建议', icon: '💊', color: '#ec4899', special: 'prescription' },
                { name: '煎服方法', key: '煎服方法', icon: '🔥', color: '#f97316' },
                { name: '随证加减', key: '随证加减', icon: '⚖️', color: '#6366f1' },
                { name: '生活调摄', key: '生活调摄', icon: '🌱', color: '#059669' },
                { name: '复诊建议', key: '复诊建议', icon: '📅', color: '#dc2626' }
            ];
            
            sections.forEach(section => {
                const regex = new RegExp(`<${section.key}>(.*?)<\/${section.key}>`, 's');
                const match = prescriptionContent.match(regex);
                
                if (match) {
                    let sectionContent = match[1].trim()
                        .replace(/\*\*(.*?)\*\*/g, '<span class="highlight-term">$1</span>')
                        .replace(/\n/g, '<br>');
                    
                    // 特殊处理处方建议
                    if (section.special === 'prescription') {
                        sectionContent = formatModernPrescription(sectionContent);
                    }
                    
                    formattedHTML += `
                        <div class="modern-tcm-section" style="--section-color: ${section.color}">
                            <div class="section-header">
                                <span class="section-icon">${section.icon}</span>
                                <span class="section-title">${section.name}</span>
                            </div>
                            <div class="section-content">${sectionContent}</div>
                        </div>
                    `;
                }
            });
            
            formattedHTML += '</div>';
            
            // 处理XML外的内容
            const beforeMatch = content.substring(0, content.indexOf('<诊疗方案>'));
            const afterMatch = content.substring(content.indexOf('</诊疗方案>') + 7);
            
            let result = '';
            if (beforeMatch.trim()) {
                result += '<div class="pre-prescription">' + formatMessage(beforeMatch) + '</div>';
            }
            result += formattedHTML;
            if (afterMatch.trim()) {
                result += '<div class="post-prescription">' + formatMessage(afterMatch) + '</div>';
            }
            
            return result;
        }

        // 文本格式处方智能解析
        function formatTextPrescription(content) {
            let formattedHTML = '<div class="text-tcm-report">';
            
            // 按段落分析
            const paragraphs = content.split('\n\n');
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    // 检查是否是标题行
                    if (paragraph.includes('**') && paragraph.length < 50) {
                        formattedHTML += `<div class="text-section-header">${formatMessage(paragraph)}</div>`;
                    } else {
                        formattedHTML += `<div class="text-section-content">${formatMessage(paragraph)}</div>`;
                    }
                }
            });
            
            formattedHTML += '</div>';
            return formattedHTML;
        }

        // 现代化处方格式化
        function formatModernPrescription(prescriptionText) {
            // 多种药材格式识别
            const herbs = [];
            let originalText = prescriptionText;
            
            // 模式匹配药材名称和剂量
            const patterns = [
                /<span class="highlight-term">(.*?)<\/span>\s*(\d+(?:\.\d+)?g?)/g,
                /\*\*(.*?)\*\*\s*(\d+(?:\.\d+)?g?)/g,
                /<strong>(.*?)<\/strong>\s*(\d+(?:\.\d+)?g?)/g,
                /([^\s\d，。；、\-]+)\s*(\d+(?:\.\d+)?g)/g
            ];
            
            let usedPattern = null;
            
            for (let pattern of patterns) {
                pattern.lastIndex = 0; // 重置正则表达式的lastIndex
                let match;
                let tempHerbs = [];
                
                while ((match = pattern.exec(originalText)) !== null) {
                    const herbName = match[1].trim();
                    const dosage = match[2];
                    
                    // 排除非药材词汇和重复项
                    if (!['共', '煎', '服', '用', '每', '次', '日', '水', '煎服', '分服', '方', '药'].includes(herbName) 
                        && herbName.length > 0 && herbName.length < 10) {
                        
                        // 检查是否已存在
                        if (!tempHerbs.some(h => h.name === herbName)) {
                            tempHerbs.push({
                                name: herbName,
                                dosage: dosage,
                                fullMatch: match[0]
                            });
                        }
                    }
                }
                
                if (tempHerbs.length > 0) {
                    herbs.push(...tempHerbs);
                    usedPattern = pattern;
                    break; // 找到匹配就停止
                }
            }
            
            if (herbs.length > 0) {
                let modernHTML = '<div class="modern-prescription-grid">';
                herbs.forEach((herb, index) => {
                    modernHTML += `
                        <div class="herb-card" style="animation-delay: ${index * 0.1}s">
                            <div class="herb-name-modern">
                                ${herb.name} 
                                <span class="herb-dosage-inline">${herb.dosage}</span>
                            </div>
                        </div>
                    `;
                });
                modernHTML += '</div>';
                
                // 移除已经显示的药材信息，避免重复
                let remainingText = originalText;
                herbs.forEach(herb => {
                    // 移除各种可能的药材格式
                    remainingText = remainingText
                        .replace(new RegExp(`\\*\\*${herb.name}\\*\\*\\s*${herb.dosage}[，、]*`, 'g'), '')
                        .replace(new RegExp(`<strong>${herb.name}</strong>\\s*${herb.dosage}[，、]*`, 'g'), '')
                        .replace(new RegExp(`<span class="highlight-term">${herb.name}</span>\\s*${herb.dosage}[，、]*`, 'g'), '')
                        .replace(new RegExp(`${herb.name}\\s*${herb.dosage}[，、]*`, 'g'), '');
                });
                
                // 清理多余的标点和空白
                remainingText = remainingText
                    .replace(/<[^>]*>/g, '') // 移除HTML标签
                    .replace(/\*\*/g, '') // 移除markdown标记
                    .replace(/[，、]{2,}/g, '、') // 合并多个标点
                    .replace(/^[，、\s]+|[，、\s]+$/g, '') // 移除首尾标点
                    .trim();
                
                // 只有当剩余文本有实际内容时才显示
                if (remainingText && remainingText.length > 5) {
                    modernHTML += `<div class="prescription-notes">${remainingText}</div>`;
                }
                
                return modernHTML;
            }
            
            // 如果没有识别到药材，返回格式化的文本
            return `<div class="prescription-text">${prescriptionText}</div>`;
        }

        // 发送消息
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('请先选择一位医师');
                }
                return;
            }

            // 🆕 状态管理集成：分析用户消息并更新状态
            if (window.conversationStateManager) {
                const analysis = window.conversationStateManager.analyzeMessage(message, false);
                if (analysis.suggestedNextState) {
                    window.conversationStateManager.setState(
                        analysis.suggestedNextState,
                        `用户消息分析: ${analysis.isEndingMessage ? '结束意图' : '继续问诊'}`
                    );
                }
            }

            // 添加用户消息
            await addMessage('user', message);
            input.value = '';
            adjustTextareaHeight();
            
            // 智能推荐医生 - AI推荐医生功能已移除
            // 不再进行症状检测和医生推荐

            // 显示加载状态
            const sendBtn = document.getElementById('sendBtn');
            const loading = document.getElementById('loading');
            sendBtn.disabled = true;
            loading.style.display = 'block';

                        // 检查网络状态
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                // 🔑 关键修复：获取当前对话历史以维持上下文连续性
                const conversationHistory = getCurrentConversationHistory();
                
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor,
                        patient_id: getCurrentUserId(), // 🔑 修复：添加用户ID
                        conversation_history: conversationHistory // 传递对话历史
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                
                // 🔍 调试：打印完整API响应
                console.log('🔍 PC端API完整响应:', responseData);
                
                // 处理新的API响应格式
                let aiReply;
                if (responseData.success && responseData.data && responseData.data.reply) {
                    aiReply = responseData.data.reply;
                    console.log('✅ PC端使用新格式，回复内容长度:', aiReply.length);
                } else if (responseData.reply) {
                    aiReply = responseData.reply; // 兼容旧格式
                    console.log('✅ PC端使用旧格式，回复内容长度:', aiReply.length);
                } else {
                    console.error('❌ PC端API响应格式错误，响应结构:', Object.keys(responseData));
                    throw new Error('API响应格式错误: 未找到reply字段');
                }
                
                // 医疗安全检查
                const aiWarnings = checkMedicalSafety(aiReply);
                if (aiWarnings.length > 0) {
                    showMedicalWarnings(aiWarnings);
                    // 记录AI响应中的安全问题
                    aiWarnings.forEach(warning => {
                        logSecurityEvent(`ai_${warning.type}`, aiReply, warning);
                    });
                }
                
                // 检查症状编造
                detectSymptomFabrication(message, aiReply);
                
                // 🔑 关键修复：处方检测和支付状态分离管理
                const containsActualPrescription = containsPrescription(aiReply);
                const isTemporaryAdvice = window.prescriptionContentRenderer ? 
                    window.prescriptionContentRenderer.containsPrescription(aiReply) === false : false;
                
                // 智能判断是否显示点评 - 所有AI回复都可以点评
                const shouldShowFeedback = true;
                
                // 处方相关状态管理 - 修复处方ID为空的问题
                let prescriptionId = responseData.data?.prescription_id || null;
                const isPaid = responseData.data?.is_paid || false;
                
                // 🔑 关键：如果有真实处方ID，存储映射关系和状态
                if (prescriptionId && responseData.data?.contains_prescription) {
                    // 处方哈希ID将在简化处方管理器中生成，这里先记录真实ID
                    window.lastRealPrescriptionId = prescriptionId;
                    // 🔑 新增：存储完整的处方数据，包括状态信息
                    window.lastPrescriptionData = responseData.data.prescription_data || {};
                    window.lastPrescriptionData.prescription_id = prescriptionId;
                    
                    console.log(`📋 获取到真实处方ID: ${prescriptionId}`);
                    console.log(`📋 处方数据:`, window.lastPrescriptionData);
                }
                
                // 🔧 如果API没有返回处方ID，但响应包含处方内容，则调用后端创建处方
                if (!prescriptionId && responseData.reply && 
                    (responseData.reply.includes('处方') || responseData.reply.includes('方剂') || 
                     responseData.reply.includes('君药') || responseData.reply.includes('臣药'))) {
                    
                    // 🔑 关键修复：调用后端API创建处方并保存到数据库
                    try {
                        const userId = getCurrentUserId();
                        const conversationId = currentConversationId || generateConversationId();
                        
                        // 🔑 修复：添加医生ID到处方数据
                        const doctorIdMapping = {
                            'zhang_zhongjing': 4,
                            'ye_tianshi': 2,
                            'li_dongyuan': 3,
                            'zheng_qin_an': 6,
                            'liu_duzhou': 5,
                            'jin_daifu': 1
                        };
                        
                        const prescriptionData = {
                            patient_id: userId,
                            conversation_id: conversationId,
                            doctor_id: doctorIdMapping[selectedDoctor] || 1, // 🆕 添加医生ID
                            patient_name: currentUser?.display_name || currentUser?.username || '用户',
                            symptoms: (responseData.data?.symptoms_summary || '用户问诊'),
                            diagnosis: (responseData.data?.diagnosis_summary || selectedDoctor + '医生诊断'),
                            ai_prescription: responseData.reply
                        };
                        
                        console.log('🔄 调用后端创建处方:', prescriptionData);
                        
                        const createResponse = await fetch('/api/prescription/create', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(prescriptionData)
                        });
                        
                        if (createResponse.ok) {
                            const createResult = await createResponse.json();
                            if (createResult.success) {
                                prescriptionId = createResult.prescription_id;
                                console.log('✅ 处方创建成功，ID:', prescriptionId);
                            } else {
                                console.warn('⚠️ 处方创建返回失败:', createResult.message);
                                // 备用方案：使用临时ID
                                prescriptionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                        } else {
                            console.warn('⚠️ 处方创建API调用失败:', createResponse.status);
                            // 备用方案：使用临时ID
                            prescriptionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                    } catch (error) {
                        console.error('❌ 处方创建异常:', error);
                        // 备用方案：使用临时ID
                        prescriptionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    console.log('🆕 最终处方ID:', prescriptionId);
                }
                
                console.log('🔍 前端处方状态分析:', {
                    containsActualPrescription: containsActualPrescription,
                    isTemporaryAdvice: isTemporaryAdvice,
                    prescriptionId: prescriptionId,
                    isPaid: isPaid,
                    backendContainsPrescription: responseData.data?.contains_prescription
                });
                
                // 🚨 关键逻辑：完整处方且未付费时需要支付
                const needsPayment = containsActualPrescription && !isTemporaryAdvice && !isPaid;
                
                // 🆕 状态管理集成：分析AI消息并更新状态
                if (window.conversationStateManager) {
                    const analysis = window.conversationStateManager.analyzeMessage(aiReply, true);
                    if (analysis.suggestedNextState) {
                        window.conversationStateManager.setState(
                            analysis.suggestedNextState, 
                            `AI回复分析: ${analysis.containsPrescription ? '包含处方' : '普通回复'}`
                        );
                    }
                }
                
                console.log('🔍 PC端即将添加AI消息:', {
                    aiReply: aiReply.substring(0, 100) + '...',
                    shouldShowFeedback,
                    containsActualPrescription,
                    isTemporaryAdvice,
                    needsPayment,
                    isPaid,
                    prescriptionId
                });
                
                // 🔑 关键修复：根据处方状态决定显示模式
                await addMessage('ai', aiReply, shouldShowFeedback, isPaid, prescriptionId);
                
                // 记录诊断阶段
                if (shouldShowFeedback) {
                    console.log('检测到处方内容，显示点评功能，处方ID:', prescriptionId, '支付状态:', isPaid);
                } else {
                    console.log('普通对话，不显示点评');
                }

            } catch (error) {
                addMessage('ai', `抱歉，服务暂时不可用：${error.message}`);
            } finally {
                sendBtn.disabled = false;
                loading.style.display = 'none';
                input.focus();
            }
        }

        // 处理键盘事件
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 调整输入框高度
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // 打开注册页面
        function openRegisterPage() {
            window.open('/nav', '_blank');
        }

        // 打开病历记录页面
        function openHistoryPage() {
            // 跳转到用户历史页面
            window.open('/history', '_blank');
        }

        // 显示病历记录模态框
        async function showMedicalRecordsModal() {
            try {
                // 获取用户的病历记录
                const response = await fetch('/api/medical-records/list', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('获取病历记录失败', 'error');
                    return;
                }
                
                createMedicalRecordsModal(result.data || []);
                
            } catch (error) {
                console.error('获取病历记录失败:', error);
                showMessage('服务暂时不可用', 'error');
            }
        }

        // 创建病历记录模态框
        function createMedicalRecordsModal(records) {
            // 检查是否已存在模态框
            let modal = document.getElementById('medicalRecordsModal');
            if (modal) {
                modal.remove();
            }
            
            modal = document.createElement('div');
            modal.id = 'medicalRecordsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1004;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 800px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 20px; font-weight: 600;">📋 我的病历记录</h3>
                        <button onclick="hideMedicalRecordsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <button onclick="showAllRecords()" id="allRecordsBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: #3b82f6; color: white; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                全部记录
                            </button>
                            <button onclick="showConsultationRecords()" id="consultationBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: white; color: #3b82f6; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                问诊记录
                            </button>
                            <button onclick="showPrescriptionRecords()" id="prescriptionBtn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: white; color: #3b82f6; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                处方记录
                            </button>
                        </div>
                        <div id="recordsContainer">
                            ${records.length > 0 ? generateRecordsHTML(records) : '<div style="text-align: center; color: #6b7280; padding: 40px;">暂无病历记录</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 生成病历记录HTML
        function generateRecordsHTML(records) {
            return records.map(record => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px;">${record.doctor_name || '医生'} - ${record.type === 'consultation' ? '问诊记录' : '处方记录'}</h4>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 13px;">${new Date(record.created_at).toLocaleString()}</p>
                        </div>
                        <span style="padding: 4px 12px; background: ${record.status === 'completed' ? '#dcfce7' : '#fef3c7'}; color: ${record.status === 'completed' ? '#166534' : '#92400e'}; border-radius: 12px; font-size: 12px;">
                            ${record.status === 'completed' ? '已完成' : '进行中'}
                        </span>
                    </div>
                    
                    ${record.symptoms ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">主要症状：</strong>
                            <span style="color: #6b7280; font-size: 14px;">${record.symptoms}</span>
                        </div>
                    ` : ''}
                    
                    ${record.diagnosis ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">诊断结果：</strong>
                            <span style="color: #6b7280; font-size: 14px;">${record.diagnosis}</span>
                        </div>
                    ` : ''}
                    
                    ${record.prescription ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">处方内容：</strong>
                            <div style="background: #f8fafc; border-radius: 6px; padding: 12px; margin-top: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${record.prescription}</div>
                        </div>
                    ` : ''}
                    
                    ${record.payment_amount ? `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #374151; font-size: 14px;">费用：</strong>
                            <span style="color: #ef4444; font-size: 14px; font-weight: 500;">¥ ${record.payment_amount}</span>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <button onclick="viewRecordDetail('${record.id}')" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; color: #374151;">
                            查看详情
                        </button>
                        ${record.type === 'prescription' && record.status === 'completed' ? `
                            <button onclick="reorderPrescription('${record.id}')" style="padding: 6px 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 12px; cursor: pointer; color: #3b82f6;">
                                重新购买
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // 隐藏病历记录模态框
        function hideMedicalRecordsModal() {
            const modal = document.getElementById('medicalRecordsModal');
            if (modal) {
                modal.remove();
            }
        }

        // 显示所有记录
        async function showAllRecords() {
            updateRecordFilter('all');
            const response = await fetch('/api/medical-records/list', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // 显示问诊记录
        async function showConsultationRecords() {
            updateRecordFilter('consultation');
            const response = await fetch('/api/medical-records/list?type=consultation', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // 显示处方记录
        async function showPrescriptionRecords() {
            updateRecordFilter('prescription');
            const response = await fetch('/api/medical-records/list?type=prescription', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateRecordsContainer(result.data || []);
        }

        // 更新记录过滤器样式
        function updateRecordFilter(type) {
            const buttons = ['allRecordsBtn', 'consultationBtn', 'prescriptionBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((type === 'all' && btnId === 'allRecordsBtn') ||
                        (type === 'consultation' && btnId === 'consultationBtn') ||
                        (type === 'prescription' && btnId === 'prescriptionBtn')) {
                        btn.style.background = '#3b82f6';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#3b82f6';
                    }
                }
            });
        }

        // 更新记录容器
        function updateRecordsContainer(records) {
            const container = document.getElementById('recordsContainer');
            if (container) {
                container.innerHTML = records.length > 0 ? generateRecordsHTML(records) : '<div style="text-align: center; color: #6b7280; padding: 40px;">暂无相关记录</div>';
            }
        }

        // 查看记录详情
        async function viewRecordDetail(recordId) {
            try {
                const response = await fetch(`/api/user/conversation/${recordId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const record = await response.json();
                    
                    // 显示详细的记录信息
                    showRecordDetailModal(record);
                } else {
                    showMessage('获取记录详情失败', 'error');
                }
            } catch (error) {
                console.error('获取记录详情失败:', error);
                showMessage('服务暂时不可用', 'error');
            }
        }

        // 重新购买处方
        async function reorderPrescription(recordId) {
            try {
                const response = await fetch(`/api/prescription/reorder/${recordId}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    hideMedicalRecordsModal();
                    showPaymentModal(result.data.prescription_id, result.data.amount);
                } else {
                    showMessage(result.message || '重新购买失败', 'error');
                }
            } catch (error) {
                console.error('重新购买失败:', error);
                showMessage('服务暂时不可用', 'error');
            }
        }
        
        // 获取医生显示名称（动态从doctors对象获取）
        function getDoctorDisplayName(doctorKey) {
            // 优先从加载的医生数据中获取
            if (doctors[doctorKey] && doctors[doctorKey].name) {
                return doctors[doctorKey].name;
            }
            
            // 备选：硬编码映射（兼容旧数据）
            const doctorNames = {
                'jin_daifu': '金大夫',
                'zhang_zhongjing': '张仲景',
                'ye_tianshi': '叶天士'
            };
            return doctorNames[doctorKey] || doctorKey || '医生';
        }
        
        // 显示记录详情模态框
        function showRecordDetailModal(record) {
            // 检查是否已存在模态框
            let detailModal = document.getElementById('recordDetailModal');
            if (detailModal) {
                detailModal.remove();
            }
            
            const doctorName = getDoctorDisplayName(record.doctor_name);
            const visitDate = new Date(record.created_at).toLocaleString('zh-CN');
            
            detailModal = document.createElement('div');
            detailModal.id = 'recordDetailModal';
            detailModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1005;
            `;
            
            detailModal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">📋 对话详情 - ${doctorName}</h3>
                        <button onclick="closeRecordDetailModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="background: #f8f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #667eea; font-size: 16px;">基本信息</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><strong>就诊时间:</strong> ${visitDate}</div>
                                <div><strong>就诊次数:</strong> 第${record.session_count || 1}次</div>
                                <div><strong>主诉:</strong> ${record.chief_complaint || '未记录'}</div>
                                <div><strong>对话轮数:</strong> ${record.total_conversations || 0}轮</div>
                            </div>
                        </div>
                        
                        ${record.diagnosis_summary ? `
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #3b82f6; font-size: 16px;">诊疗记录</h4>
                                <div style="line-height: 1.6; color: #374151;">
                                    <p style="margin-bottom: 12px;"><strong>诊断摘要:</strong> ${record.diagnosis_summary}</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${record.prescription_given && record.prescription_given !== '未开方' ? `
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #10b981; font-size: 16px;">处方内容</h4>
                                <div style="background: white; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 14px; line-height: 1.5; white-space: pre-wrap; max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db;">
${record.prescription_given}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: #fefce8; border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #eab308; font-size: 16px;">对话状态</h4>
                            <div style="display: flex; align-items: center;">
                                <span style="padding: 6px 16px; background: ${record.session_status === 'completed' ? '#dcfce7' : '#fef3c7'}; color: ${record.session_status === 'completed' ? '#166534' : '#92400e'}; border-radius: 20px; font-size: 14px; font-weight: 500;">
                                    ${record.session_status === 'completed' ? '已完成' : '进行中'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 20px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
                        <button onclick="closeRecordDetailModal()" style="padding: 10px 20px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; color: #374151;">关闭</button>
                        <button onclick="exportConversation('${record.session_id}')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">📄 导出病历</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(detailModal);
        }
        
        // 关闭记录详情模态框
        function closeRecordDetailModal() {
            const modal = document.getElementById('recordDetailModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 导出单个对话
        async function exportConversation(sessionId) {
            try {
                const response = await fetch(`/api/user/conversation/${sessionId}/export`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TCM_病历_${sessionId.slice(0,8)}_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // 关闭详情模态框
                    closeRecordDetailModal();
                    showMessage('导出成功', 'success');
                } else {
                    showMessage('导出失败，请重试', 'error');
                }
            } catch (error) {
                console.error('导出失败:', error);
                showMessage('导出失败，请检查网络连接', 'error');
            }
        }


        // 移动端简化导航
        function showMobileNavigation() {
            const navigationHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 12px; padding: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="text-align: center; font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #374151;">
                            📱 患者服务导航
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/', '_blank'); this.parentElement.parentElement.parentElement.remove();">🏠 主页 - AI中医问诊</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/nav', '_blank'); this.parentElement.parentElement.parentElement.remove();">👤 用户注册</button>
                            <button style="display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: none; border-radius: 8px; text-align: left;" onclick="window.open('/history', '_blank'); this.parentElement.parentElement.parentElement.remove();">📋 历史记录</button>
                        </div>
                        
                        <button style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 500;" onclick="this.parentElement.parentElement.remove()">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', navigationHtml);
        }

        // 开始新对话
        async function startNewChat() {
            if (!selectedDoctor) {
                alert('请先选择医生再清空对话记录');
                return;
            }
            
            const choice = confirm('🗑️ 清空对话记录\n\n这将清空当前医生的所有对话记录，包括：\n• 本地存储的消息\n• 服务器端的对话历史\n• 已保存的问诊状态\n\n确定要清空吗？');
            
            if (choice) {
                try {
                    const userId = getCurrentUserId();
                    
                    // 1. 清空本地存储
                    const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                    localStorage.removeItem(historyKey);
                    
                    // 2. 清空服务器端对话记录
                    const response = await fetch('/api/conversation/clear', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            user_id: userId,
                            doctor_id: selectedDoctor,
                            clear_type: 'all' // 清空所有相关记录
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            console.log(`✅ 已清空${selectedDoctor}医生的完整对话记录`);
                            showMessage(`已清空${getDoctorDisplayName(selectedDoctor)}的对话记录`, 'success');
                        } else {
                            console.warn('服务器清空失败，但本地已清空');
                            showMessage('本地记录已清空，服务器清空失败', 'warning');
                        }
                    } else {
                        console.warn('服务器清空请求失败，但本地已清空');
                        showMessage('本地记录已清空，服务器清空失败', 'warning');
                    }
                    
                    // 3. 生成新的对话ID
                    generateConversationId();
                    
                    // 4. 清空页面显示并重新加载空白状态
                    clearAllMessages();
                    loadDoctorHistory(selectedDoctor);
                    
                } catch (error) {
                    console.error('清空对话记录失败:', error);
                    showMessage('清空失败，请重试', 'error');
                }
            } else {
                // 用户选择保持历史记录，什么都不做
                console.log('用户选择保持历史记录不变');
                
                // 隐藏输入框
                const inputContainer = document.querySelector('.input-container');
                if (inputContainer) {
                    inputContainer.classList.remove('show');
                }
            }
        }

        // ========== ChatGPT风格对话管理系统 ==========
        
        // 对话历史数据
        let conversationHistory = [];
        
        // 初始化对话管理系统
        function initConversationManager() {
            loadConversationIndex(); // 修复：使用正确的函数名
            renderConversationList();
        }
        
        // 创建新对话（ChatGPT风格）
        async function createNewConversation() {
            try {
                const userId = getCurrentUserId();
                
                // 如果当前有对话内容，先保存到历史记录
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                if (messagesContainer && messagesContainer.children.length > 0) {
                    await saveCurrentConversationToHistory();
                }
                
                // 🔑 关键修复：完整清理所有存储机制
                await clearAllConversationData(userId);
                
                // 清空当前对话显示
                clearAllMessages();
                
                // 生成新的对话ID
                generateConversationId();
                
                // 重置对话状态
                resetConversationState();
                
                // 更新对话列表
                renderConversationList();
                
                console.log('✅ 新对话创建成功');
                showMessage('新对话已开始', 'success');
                
            } catch (error) {
                console.error('❌ 创建新对话失败:', error);
                showMessage('创建新对话失败', 'error');
            }
        }
        
        // 🔑 新增：完整清理所有对话数据的函数
        async function clearAllConversationData(userId) {
            try {
                if (!selectedDoctor) {
                    console.log('⚠️ 没有选择医生，跳过数据清理');
                    return;
                }
                
                console.log(`🧹 开始清理用户 ${userId} 与医生 ${selectedDoctor} 的所有对话数据`);
                
                // 1. 清理localStorage中的医生历史记录
                const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                localStorage.removeItem(historyKey);
                console.log(`🗑️ 清理localStorage医生历史记录: ${historyKey}`);
                
                // 2. 清理ChatGPT风格对话记录（当前对话）
                if (currentConversationId) {
                    const conversationKey = `conversation_${userId}_${currentConversationId}`;
                    localStorage.removeItem(conversationKey);
                    console.log(`🗑️ 清理ChatGPT对话记录: ${conversationKey}`);
                }
                
                // 3. 清理对话索引中的相关记录
                const indexKey = `conversation_index_${userId}`;
                let index = JSON.parse(localStorage.getItem(indexKey) || '[]');
                const originalLength = index.length;
                index = index.filter(item => item.doctor !== selectedDoctor);
                if (index.length !== originalLength) {
                    localStorage.setItem(indexKey, JSON.stringify(index));
                    console.log(`🗑️ 清理对话索引，删除了 ${originalLength - index.length} 条记录`);
                }
                
                // 4. 清理消息容器的医生标记
                const containers = ['messagesContainer', 'mobileMessagesContainer'];
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.removeAttribute('data-current-doctor');
                        console.log(`🗑️ 清理容器标记: ${containerId}`);
                    }
                });
                
                // 5. 清理服务端数据（可选，谨慎操作）
                try {
                    const response = await fetch('/api/conversation/clear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            doctor_id: selectedDoctor,
                            clear_type: 'all'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`✅ 服务端数据清理成功: ${result.message}`);
                    } else {
                        console.warn('⚠️ 服务端数据清理失败，但继续执行');
                    }
                } catch (error) {
                    console.warn('⚠️ 服务端数据清理出错，但继续执行:', error);
                }
                
                console.log('✅ 所有对话数据清理完成');
                
            } catch (error) {
                console.error('❌ 清理对话数据失败:', error);
                throw error;
            }
        }
        
        // 保存当前对话到历史记录
        async function saveCurrentConversationToHistory() {
            try {
                const userId = getCurrentUserId();
                if (!userId || !selectedDoctor) {
                    return;
                }
                
                // 从DOM中提取当前消息
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                
                if (!messagesContainer || messagesContainer.children.length === 0) {
                    return;
                }
                
                // 提取消息内容
                const extractedMessages = [];
                const messageElements = messagesContainer.querySelectorAll('.message');
                
                messageElements.forEach((messageEl, index) => {
                    const isUser = messageEl.classList.contains('user');
                    const messageTextEl = messageEl.querySelector('.message-text');
                    const content = messageTextEl ? messageTextEl.textContent.trim() : '';
                    
                    if (content) {
                        extractedMessages.push({
                            id: `msg_${Date.now()}_${index}`,
                            sender: isUser ? 'user' : 'ai',
                            content: content,
                            timestamp: new Date().toISOString(),
                            doctorKey: selectedDoctor
                        });
                    }
                });
                
                if (extractedMessages.length === 0) {
                    return;
                }
                
                const conversation = {
                    id: currentConversationId || generateConversationId(),
                    title: generateConversationTitle(extractedMessages),
                    doctor: selectedDoctor,
                    doctorName: getDoctorDisplayName(selectedDoctor),
                    messages: extractedMessages,
                    createdAt: extractedMessages[0]?.timestamp || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    messageCount: extractedMessages.length
                };
                
                // 保存到localStorage
                const storageKey = `conversation_${userId}_${conversation.id}`;
                localStorage.setItem(storageKey, JSON.stringify(conversation));
                
                // 更新对话索引
                await updateConversationIndex(userId, conversation);
                
                console.log('💾 对话已保存到历史记录:', conversation.title);
                
            } catch (error) {
                console.error('❌ 保存对话历史失败:', error);
            }
        }
        
        // 更新对话索引
        async function updateConversationIndex(userId, conversation) {
            try {
                const indexKey = `conversation_index_${userId}`;
                let index = JSON.parse(localStorage.getItem(indexKey) || '[]');
                
                // 检查是否已存在
                const existingIndex = index.findIndex(item => item.id === conversation.id);
                
                const indexItem = {
                    id: conversation.id,
                    title: conversation.title,
                    doctor: conversation.doctor,
                    doctorName: conversation.doctorName,
                    createdAt: conversation.createdAt,
                    updatedAt: conversation.updatedAt,
                    messageCount: conversation.messageCount
                };
                
                if (existingIndex >= 0) {
                    // 更新现有记录
                    index[existingIndex] = indexItem;
                } else {
                    // 添加新记录
                    index.unshift(indexItem);
                }
                
                // 保持最多50个对话记录
                if (index.length > 50) {
                    const removedItems = index.slice(50);
                    index = index.slice(0, 50);
                    
                    // 清理被移除的对话数据
                    removedItems.forEach(item => {
                        const storageKey = `conversation_${userId}_${item.id}`;
                        localStorage.removeItem(storageKey);
                    });
                }
                
                localStorage.setItem(indexKey, JSON.stringify(index));
                conversationHistory = index;
                
            } catch (error) {
                console.error('❌ 更新对话索引失败:', error);
            }
        }
        
        // 生成对话标题
        function generateConversationTitle(messages) {
            if (!messages || messages.length === 0) {
                return '新对话';
            }
            
            // 从第一条用户消息中提取关键词作为标题
            const firstUserMessage = messages.find(msg => msg.sender === 'user' || msg.type === 'user');
            if (firstUserMessage && firstUserMessage.content) {
                let title = firstUserMessage.content.slice(0, 20);
                if (firstUserMessage.content.length > 20) {
                    title += '...';
                }
                return title;
            }
            
            return `对话 ${new Date().toLocaleDateString()}`;
        }
        
        // 加载对话历史索引
        function loadConversationIndex() {
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                const indexKey = `conversation_index_${userId}`;
                conversationHistory = JSON.parse(localStorage.getItem(indexKey) || '[]');
                
                console.log(`📋 加载了${conversationHistory.length}个历史对话`);
                
            } catch (error) {
                console.error('❌ 加载对话历史失败:', error);
                conversationHistory = [];
            }
        }
        
        // 渲染对话列表
        function renderConversationList() {
            const listContainer = document.getElementById('conversationList');
            if (!listContainer) return;
            
            if (conversationHistory.length === 0) {
                listContainer.innerHTML = `
                    <div class="conversation-item-empty">
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            <div style="font-size: 24px; margin-bottom: 8px;">💬</div>
                            <div style="font-size: 14px;">暂无历史对话</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const currentId = currentConversationId;
            
            const listHTML = conversationHistory.map(conversation => {
                const isActive = conversation.id === currentId;
                const timeStr = formatConversationTime(conversation.updatedAt);
                
                return `
                    <div class="conversation-item ${isActive ? 'active' : ''}" 
                         onclick="loadConversation('${conversation.id}')"
                         data-conversation-id="${conversation.id}">
                        <div class="conversation-item-header">
                            <div class="conversation-title">${conversation.title}</div>
                            <button class="conversation-delete" 
                                    onclick="event.stopPropagation(); deleteConversation('${conversation.id}')"
                                    title="删除对话">
                                ×
                            </button>
                        </div>
                        <div class="conversation-info">
                            <span class="conversation-doctor">${conversation.doctorName}</span>
                            <span class="conversation-time">${timeStr}</span>
                        </div>
                        <div class="conversation-meta">
                            ${conversation.messageCount} 条消息
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = listHTML;
        }
        
        // 格式化对话时间
        function formatConversationTime(dateStr) {
            try {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return '昨天';
                } else if (diffDays < 7) {
                    return `${diffDays}天前`;
                } else {
                    return date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
                }
            } catch {
                return '';
            }
        }
        
        // 加载指定对话
        async function loadConversation(conversationId) {
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                // 保存当前对话（如果有内容）
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                if (messagesContainer && messagesContainer.children.length > 0 && currentConversationId !== conversationId) {
                    await saveCurrentConversationToHistory();
                }
                
                // 从localStorage加载对话数据
                const storageKey = `conversation_${userId}_${conversationId}`;
                const conversationData = localStorage.getItem(storageKey);
                
                if (!conversationData) {
                    showMessage('对话记录不存在', 'error');
                    return;
                }
                
                const conversation = JSON.parse(conversationData);
                
                // 清空当前显示
                clearAllMessages();
                
                // 设置对话状态
                currentConversationId = conversationId;
                selectedDoctor = conversation.doctor;
                
                // 更新UI
                updateDoctorSelection(conversation.doctor);
                
                // 重新渲染消息
                conversation.messages.forEach(message => {
                    const sender = message.sender || message.type; // 兼容新旧格式
                    if (sender === 'user') {
                        addMessage('user', message.content);
                    } else if (sender === 'ai') {
                        addMessage('ai', message.content, false, false, message.prescriptionData);
                    }
                });
                
                // 更新对话列表显示
                renderConversationList();
                
                // 保存当前对话ID
                const storageKeyConv = `conversationId_${userId}`;
                localStorage.setItem(storageKeyConv, conversationId);
                
                console.log('✅ 对话加载成功:', conversation.title);
                showMessage('对话已切换', 'success');
                
            } catch (error) {
                console.error('❌ 加载对话失败:', error);
                showMessage('加载对话失败', 'error');
            }
        }
        
        // 删除对话
        async function deleteConversation(conversationId) {
            if (!confirm('确定要删除这个对话吗？此操作不可恢复。')) {
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                // 从localStorage删除对话数据
                const storageKey = `conversation_${userId}_${conversationId}`;
                localStorage.removeItem(storageKey);
                
                // 从索引中移除
                const indexKey = `conversation_index_${userId}`;
                let index = JSON.parse(localStorage.getItem(indexKey) || '[]');
                index = index.filter(item => item.id !== conversationId);
                localStorage.setItem(indexKey, JSON.stringify(index));
                
                // 更新内存中的历史记录
                conversationHistory = index;
                
                // 如果删除的是当前对话，创建新对话
                if (currentConversationId === conversationId) {
                    clearAllMessages();
                    generateConversationId();
                    resetConversationState();
                }
                
                // 重新渲染列表
                renderConversationList();
                
                console.log('🗑️ 对话已删除:', conversationId);
                showMessage('对话已删除', 'success');
                
            } catch (error) {
                console.error('❌ 删除对话失败:', error);
                showMessage('删除对话失败', 'error');
            }
        }
        
        // 重置对话状态
        function resetConversationState() {
            messages = [];
            currentStage = 'initial_inquiry';
            // 保持selectedDoctor不变，这样用户可以继续和同一个医生对话
        }
        
        // 更新医生选择器显示
        function updateDoctorSelection(doctorKey) {
            const doctorSelector = document.getElementById('doctorSelector');
            if (doctorSelector) {
                doctorSelector.value = doctorKey;
            }
            
            // 触发医生选择事件，但不生成新的对话ID
            const originalConversationId = currentConversationId;
            selectDoctor(doctorKey);
            currentConversationId = originalConversationId;
        }
        
        
        // 移动端边栏控制
        function openMobileSidebar() {
            const sidebar = document.getElementById('conversationSidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            
            sidebar.classList.add('show', 'mobile-open');
            sidebar.classList.remove('collapsed');
            overlay.style.display = 'block';
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('conversationSidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            const trigger = document.getElementById('conversationHistoryTrigger');
            
            sidebar.classList.remove('show', 'mobile-open');
            sidebar.classList.add('collapsed');
            overlay.style.display = 'none';
            if (trigger) trigger.textContent = '💬 对话';
        }
        
        // 消息发送后更新对话列表
        async function updateConversationListAfterMessage() {
            try {
                // 重建messages数组（从DOM获取当前所有消息）
                const messageElements = document.querySelectorAll('.message');
                const currentMessages = [];
                
                messageElements.forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    const prescriptionData = messageEl.getAttribute('data-prescription-id');
                    
                    if (textEl) {
                        const messageData = {
                            type: isUser ? 'user' : 'ai',
                            content: textEl.textContent.trim(),
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: new Date().toISOString()
                        };
                        
                        if (prescriptionData) {
                            messageData.prescriptionData = { prescriptionId: prescriptionData };
                        }
                        
                        currentMessages.push(messageData);
                    }
                });
                
                // 更新全局messages数组
                messages = currentMessages;
                
                // 如果有消息，自动保存当前对话
                if (messages.length > 0) {
                    await saveCurrentConversationToHistory();
                    renderConversationList();
                }
                
            } catch (error) {
                console.error('❌ 更新对话列表失败:', error);
            }
        }

        // 多图片上传功能
        let tongueImage = null;
        let faceImage = null;

        // 桌面端 - 舌诊图片上传
        function triggerTongueUpload() {
            document.getElementById('tongueImageUpload').click();
        }

        function handleTongueImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                const uploadArea = document.getElementById('tongueUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <div class="upload-text">舌诊照片已选择</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // 桌面端 - 面诊图片上传
        function triggerFaceUpload() {
            document.getElementById('faceImageUpload').click();
        }

        function handleFaceImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                const uploadArea = document.getElementById('faceUploadArea');
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <div class="upload-text">面诊照片已选择</div>
                `;
                updateUploadStatus();
                uploadImages();
            }
        }

        // 移动端 - 显示图片选择弹窗（微信兼容优化增强版）
        function showMobileImageOptions() {
            console.log('🔄 尝试显示移动端图片选择弹窗...');
            
            try {
                const modal = document.getElementById('mobileImageModal');
                console.log('🔍 弹窗元素查找结果:', modal ? '找到' : '未找到');
                
                if (modal) {
                    // 方法1: 立即显示弹窗
                    console.log('📱 方法1: 立即显示弹窗');
                    setModalVisible(modal);
                    
                    // 方法2: 延迟100ms再次确认显示（处理渲染延迟）
                    setTimeout(() => {
                        console.log('📱 方法2: 延迟确认显示');
                        const computedStyle = window.getComputedStyle(modal);
                        if (computedStyle.display === 'none') {
                            console.log('⚠️  弹窗仍未显示，强制显示');
                            forceShowModal(modal);
                        } else {
                            console.log('✅ 弹窗显示成功');
                        }
                    }, 100);
                    
                    // 方法3: 微信环境特殊处理
                    if (isWeChatBrowser()) {
                        setTimeout(() => {
                            console.log('📱 方法3: 微信环境特殊处理');
                            wechatModalFix(modal);
                        }, 200);
                    }
                    
                } else {
                    console.error('❌ 找不到移动端图片选择弹窗元素，使用fallback方法');
                    // Fallback: 直接触发文件选择
                    if (confirm('📷 选择图片类型：\n\n确定 = 👅 舌诊照片\n取消 = 😊 面诊照片')) {
                        console.log('用户选择舌诊照片');
                        document.getElementById('mobileTongueUpload').click();
                    } else {
                        console.log('用户选择面诊照片');
                        document.getElementById('mobileFaceUpload').click();
                    }
                }
            } catch (error) {
                console.error('❌ 显示弹窗时出错:', error);
                // 最简单的fallback
                alert('图片上传功能暂时不可用，请稍后重试\n\n错误: ' + error.message);
            }
        }
        
        // 设置弹窗可见的核心函数
        function setModalVisible(modal) {
            console.log('🎯 设置弹窗样式...');
            
            // 使用CSS类切换（更可靠）
            modal.classList.remove('mobile-modal-hidden');
            modal.classList.add('mobile-modal-visible');
            
            // 同时设置内联样式作为双重保险
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0, 0, 0, 0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            // 阻止背景滚动
            document.body.style.overflow = 'hidden';
            
            console.log('✅ 弹窗样式设置完成 - 类名和内联样式双重设置');
        }
        
        // 强制显示弹窗
        function forceShowModal(modal) {
            console.log('🔥 强制显示弹窗');
            
            // 完全重置样式
            modal.removeAttribute('style');
            modal.removeAttribute('class');
            
            // 使用 !important 强制显示
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.8) !important;
                z-index: 999999 !important;
                justify-content: center !important;
                align-items: center !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            console.log('🔥 强制样式应用完成');
        }
        
        // 微信环境特殊修复
        function wechatModalFix(modal) {
            console.log('🔧 微信环境修复');
            
            // 微信浏览器可能需要触发重绘
            modal.style.transform = 'translateZ(0)';
            modal.offsetHeight; // 强制重绘
            modal.style.transform = '';
            
            // 确保内容元素也可见
            const content = modal.querySelector('.mobile-image-modal-content');
            if (content) {
                content.style.display = 'block';
                content.style.visibility = 'visible';
                content.style.opacity = '1';
                console.log('🔧 弹窗内容元素样式修复完成');
            }
        }
        
        // 检测是否为微信浏览器
        function isWeChatBrowser() {
            return navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1;
        }

        function closeMobileImageModal() {
            console.log('🔄 关闭移动端图片选择弹窗');
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                // 使用CSS类隐藏
                modal.classList.remove('mobile-modal-visible');
                modal.classList.add('mobile-modal-hidden');
                
                // 同时设置内联样式
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                
                // 恢复背景滚动
                document.body.style.overflow = 'auto';
                
                console.log('✅ 移动端图片选择弹窗已关闭');
            } else {
                console.error('❌ 未找到弹窗元素');
            }
        }

        // 调试函数：检查弹窗状态
        function debugModalState() {
            const modal = document.getElementById('mobileImageModal');
            if (modal) {
                console.log('弹窗元素存在');
                console.log('弹窗display:', window.getComputedStyle(modal).display);
                console.log('弹窗位置:', modal.getBoundingClientRect());
                console.log('弹窗zIndex:', window.getComputedStyle(modal).zIndex);
                console.log('屏幕尺寸:', window.innerWidth + 'x' + window.innerHeight);
            } else {
                console.error('弹窗元素不存在');
            }
        }

        // 移动端 - 舌诊图片上传
        function triggerMobileTongueUpload() {
            closeMobileImageModal();
            document.getElementById('mobileTongueUpload').click();
        }

        function handleMobileTongueUpload(event) {
            const file = event.target.files[0];
            if (file) {
                tongueImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // 移动端 - 面诊图片上传
        function triggerMobileFaceUpload() {
            closeMobileImageModal();
            document.getElementById('mobileFaceUpload').click();
        }

        function handleMobileFaceUpload(event) {
            const file = event.target.files[0];
            if (file) {
                faceImage = file;
                updateMobileUploadStatus();
                uploadImages();
            }
        }

        // 更新上传状态显示
        function updateUploadStatus() {
            const statusDiv = document.getElementById('uploadStatus');
            const tongueStatus = document.getElementById('tongueStatus').querySelector('span');
            const faceStatus = document.getElementById('faceStatus').querySelector('span');

            tongueStatus.textContent = tongueImage ? '已上传' : '未上传';
            faceStatus.textContent = faceImage ? '已上传' : '未上传';

            if (tongueImage || faceImage) {
                statusDiv.style.display = 'block';
            }
        }

        // 更新移动端上传状态
        function updateMobileUploadStatus() {
            const mobileTongueStatus = document.getElementById('mobileTongueStatus').querySelector('span');
            const mobileFaceStatus = document.getElementById('mobileFaceStatus').querySelector('span');

            mobileTongueStatus.textContent = tongueImage ? '已上传' : '未上传';
            mobileFaceStatus.textContent = faceImage ? '已上传' : '未上传';

            // 更新触发按钮文本
            const uploadText = document.getElementById('mobileUploadText');
            const uploadedCount = (tongueImage ? 1 : 0) + (faceImage ? 1 : 0);
            if (uploadedCount > 0) {
                uploadText.textContent = `已选择 ${uploadedCount} 张图片`;
            }
        }

        // 多图片上传核心函数
        async function uploadImages() {
            // 检查是否有图片需要上传
            if (!tongueImage && !faceImage) {
                return;
            }

            // 检查网络状态
            if (!checkNetworkStatus()) {
                return;
            }

            const formData = new FormData();
            formData.append('conversation_id', currentConversationId);
            
            // 根据图片类型分别添加
            if (tongueImage) {
                formData.append('tongue_image', tongueImage);
            }
            if (faceImage) {
                formData.append('face_image', faceImage);
            }

            try {
                // 构建上传提示消息
                let uploadMessage = '📷 正在分析';
                if (tongueImage && faceImage) {
                    uploadMessage += '舌诊和面诊图片...';
                } else if (tongueImage) {
                    uploadMessage += '舌诊图片...';
                } else if (faceImage) {
                    uploadMessage += '面诊图片...';
                }
                
                addMessage('user', uploadMessage);
                
                const response = await fetch('/analyze_images', {
                    method: 'POST',
                    body: formData,
                    // 添加超时控制
                    signal: AbortSignal.timeout(120000), // 2分钟超时
                    headers: {
                        // 不设置Content-Type，让浏览器自动设置multipart/form-data
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const analysisResult = `图像分析结果：
${data.analysis_result}`;  
                const shouldShowImageFeedback = containsPrescription(analysisResult);
                addMessage('ai', analysisResult, shouldShowImageFeedback);

                // 分析完成后清空图片缓存，允许用户重新上传
                resetImageUploads();

            } catch (error) {
                console.error('📷 图像上传完整错误信息:', error);
                
                let errorMessage = '图像分析失败：';
                
                if (error.message.includes('502')) {
                    errorMessage += '服务器暂时无法处理请求 (502)。可能原因：\n';
                    errorMessage += '• AI服务暂时繁忙，请稍后重试\n';
                    errorMessage += '• 图片处理超时\n';
                    errorMessage += '• 请检查网络连接';
                } else if (error.message.includes('timeout')) {
                    errorMessage += '请求超时。请检查：\n';
                    errorMessage += '• 网络连接是否稳定\n';
                    errorMessage += '• 图片大小是否过大\n';
                    errorMessage += '• 稍后重试';
                } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                    errorMessage += '网络连接问题。请检查：\n';
                    errorMessage += '• 网络连接是否正常\n';
                    errorMessage += '• 是否使用了代理或VPN\n';
                    errorMessage += '• 刷新页面后重试';
                } else {
                    errorMessage += error.message;
                }
                
                // 添加调试信息（仅在开发环境显示）
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    errorMessage += `\n\n[调试信息]\n对话ID: ${currentConversationId}\n错误类型: ${error.constructor.name}\n时间: ${new Date().toLocaleString()}`;
                }
                
                addMessage('ai', errorMessage);
                
                // 重置上传状态，允许用户重试
                resetImageUploads();
            }
        }

        // 重置图片上传状态
        function resetImageUploads() {
            tongueImage = null;
            faceImage = null;
            
            // 重置桌面端界面
            const tongueUploadArea = document.getElementById('tongueUploadArea');
            const faceUploadArea = document.getElementById('faceUploadArea');
            
            if (tongueUploadArea) {
                tongueUploadArea.classList.remove('has-file');
                tongueUploadArea.innerHTML = `
                    <div class="upload-icon">📷</div>
                    <div class="upload-text">点击上传舌诊照片</div>
                `;
            }
            
            if (faceUploadArea) {
                faceUploadArea.classList.remove('has-file');
                faceUploadArea.innerHTML = `
                    <div class="upload-icon">📷</div>
                    <div class="upload-text">点击上传面诊照片</div>
                `;
            }

            // 隐藏上传状态
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }

            // 重置移动端按钮文本
            const uploadText = document.getElementById('mobileUploadText');
            if (uploadText) {
                uploadText.textContent = '上传舌苔和面象照片';
            }
        }

        // 保留原uploadImage函数作为兼容性支持（已废弃使用）
        async function uploadImage(file) {
            console.warn('uploadImage函数已废弃，请使用uploadImages函数');
            // 可选：为了兼容性，将单图片转换为多图片模式
            tongueImage = file; // 假设单图片默认为舌诊
            uploadImages();
        }

        // 语音功能
        function toggleVoiceRecording() {
            if (isVoiceRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        async function startVoiceRecording() {
                        // 检查网络状态
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processVoiceInput(audioBlob);
                };

                mediaRecorder.start();
                isVoiceRecording = true;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = '停止录音';
                voiceBtn.classList.add('recording');

            } catch (error) {
                alert('无法访问麦克风，请检查权限设置');
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && isVoiceRecording) {
                mediaRecorder.stop();
                isVoiceRecording = false;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = '开始语音输入';
                voiceBtn.classList.remove('recording');
            }
        }

        async function processVoiceInput(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'voice.webm');

                        // 检查网络状态
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                const response = await fetch('/speech_to_text', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.text) {
                    document.getElementById('messageInput').value = data.text;
                    adjustTextareaHeight();
                }

            } catch (error) {
                addMessage('ai', `语音识别失败：${error.message}`);
            }
        }

        // 语音合成
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
            }
        }

        
        // 检测回复是否包含处方（使用渲染器的统一逻辑）
        function containsPrescription(text) {
            // 防止undefined错误
            if (!text || typeof text !== 'string') {
                console.warn('containsPrescription: 无效的文本参数', text);
                return false;
            }
            
            // 使用处方渲染器的统一检测逻辑
            if (window.prescriptionContentRenderer) {
                return window.prescriptionContentRenderer.containsPrescription(text);
            }
            
            // 备用检测逻辑（如果渲染器未加载）
            const hasHerbs = /[当归|党参|黄芪|白术|茯苓|甘草|生地|熟地|川芎|白芍|柴胡|黄芩|半夏|陈皮]/.test(text);
            const hasDosage = /\d+[克g]/.test(text);
            const hasPrescriptionKeyword = /处方|方剂|药方|组方/.test(text);
            
            return (hasHerbs && hasDosage) || hasPrescriptionKeyword;
        }

        // 遗留代码保留（为了向后兼容）
        function containsPrescription_legacy(text) {
            // 处方关键词检测
            const prescriptionKeywords = [
                '处方', '方剂', '药方', '中药', '服用', '煎服', '每日', '克', 'g',
                '方用', '方取', '组成', '用法', '用量', '煎煮', '服法',
                '党参', '黄芪', '当归', '白术', '茯苓', '甘草', '生地', '熟地',
                '川芎', '白芍', '柴胡', '黄芩', '半夏', '陈皮', '枳壳', '桔梗'
            ];
            
            // XML格式处方检测
            const xmlPrescriptionPattern = /<prescription>.*?<\/prescription>/s;
            if (xmlPrescriptionPattern.test(text)) {
                return true;
            }
            
            // 标准处方格式检测
            const standardPrescriptionPattern = /【处方】|【方剂】|【药方】|【中药处方】/;
            if (standardPrescriptionPattern.test(text)) {
                return true;
            }
            
            // 关键词组合检测 - 至少包含2个处方相关词汇
            let keywordCount = 0;
            for (const keyword of prescriptionKeywords) {
                if (text.includes(keyword)) {
                    keywordCount++;
                }
            }
            
            return keywordCount >= 2;
        }

        // 反馈评分
        function rateFeedback(button, rating) {
            const ratingButtons = button.parentElement.querySelectorAll('.rating-btn');
            ratingButtons.forEach(btn => btn.disabled = true);
            
            button.style.backgroundColor = '#10b981';
            button.style.color = 'white';
            
            submitFeedback(rating);
        }

        async function submitFeedback(rating) {
            // 检查网络状态
            if (!checkNetworkStatus()) {
                return;
            }
            
            try {
                const response = await fetch('/api/review/feedback', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        doctor_id: selectedDoctor,
                        rating: rating,
                        feedback_type: 'consultation',
                        user_id: currentUser ? currentUser.id : null,
                        timestamp: new Date().toISOString()
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`感谢您的${rating}星评价！`, 'success');
                } else {
                    console.error('反馈提交失败:', result.message);
                }
                
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // ===================== 认证系统 =====================
        
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });

        // 检查登录状态 - 使用统一认证管理器
        function checkLoginStatus() {
            console.log('🔍 检查登录状态...');
            
            // 检查是否是访客模式
            const urlParams = new URLSearchParams(window.location.search);
            const isGuestMode = urlParams.get('mode') === 'guest';
            
            // 使用authManager检查登录状态
            const user = window.authManager.getCurrentUser();
            const token = window.authManager.getToken();
            
            console.log('📋 登录状态检查结果:', {
                isGuestMode,
                isLoggedIn: window.authManager.isLoggedIn(),
                hasUser: !!user,
                hasToken: !!token,
                username: user?.username || user?.display_name
            });
            
            if (window.authManager.isLoggedIn()) {
                // 已登录 - 直接使用
                currentUser = user;
                userToken = token;
                console.log('✅ 登录状态有效，用户:', user.username || user.display_name, '角色:', user.primary_role);
                updateUserInterface(true);
            } else if (token) {
                // 有token但用户信息缺失 - 尝试从后端验证
                console.log('⚠️ 有token但缺少完整用户数据，尝试验证...');
                verifyTokenAndLoadUserData(token);
            } else if (isGuestMode) {
                // 访客模式 - 允许无登录访问
                console.log('ℹ️ 访客模式：允许无登录访问');
                updateUserInterface(false);
            } else {
                // 非访客模式且无token - 跳转到登录页
                console.log('❌ 未检测到有效登录状态，跳转到登录页面');
                showMessage('请先登录后使用智能问诊服务', 'warning');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
        }
        
        // 验证token并加载用户数据 - 使用统一认证管理器
        async function verifyTokenAndLoadUserData(token) {
            console.log('🔄 验证token并加载用户数据...');
            
            const user = await window.authManager.verifyToken(token);
            
            if (user) {
                currentUser = user;
                userToken = token;
                console.log('✅ 从后端验证成功，用户:', user.username || user.display_name);
                updateUserInterface(true);
            } else {
                console.log('❌ Token验证失败，清除数据');
                window.authManager.clearLoginState();
                // 跳转到登录页
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1000);
            }
        }

        // 更新用户界面
        function updateUserInterface(isLoggedIn) {
            console.log('🔄 开始更新用户界面，登录状态:', isLoggedIn);
            
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            // 检查必要的DOM元素是否存在
            if (!authButtons || !userInfo || !userAvatar || !userName) {
                console.error('❌ 用户界面元素缺失:', {
                    authButtons: !!authButtons,
                    userInfo: !!userInfo,
                    userAvatar: !!userAvatar,
                    userName: !!userName
                });
                return;
            }
            
            if (isLoggedIn) {
                // 从多个来源获取用户数据
                let userData = null;
                
                // 1. 尝试从全局变量获取
                if (currentUser) {
                    userData = currentUser;
                    console.log('🔑 从全局变量获取用户数据:', userData);
                }
                
                // 2. 尝试从localStorage获取
                if (!userData) {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        try {
                            userData = JSON.parse(storedUser);
                            console.log('🔑 从localStorage获取用户数据:', userData);
                        } catch (e) {
                            console.error('❌ 解析用户数据失败:', e);
                        }
                    }
                }
                
                // 3. 尝试从authManager获取
                if (!userData && window.authManager) {
                    userData = window.authManager.getCurrentUser();
                    if (userData) {
                        console.log('🔑 从authManager获取用户数据:', userData);
                    }
                }
                
                if (userData) {
                    // 隐藏登录按钮，显示用户信息
                    authButtons.style.display = 'none';
                    userInfo.style.display = 'flex';
                    
                    // 处理用户显示名称
                    let displayName = '用户';
                    if (userData.username) {
                        displayName = userData.username;
                    } else if (userData.name) {
                        displayName = userData.name;
                    } else if (userData.display_name) {
                        displayName = userData.display_name;
                    } else if (userData.phone) {
                        displayName = userData.phone;
                    } else if (userData.user_id || userData.id || userData.global_user_id) {
                        // 将user_id转换为友好的显示名称
                        const userId = userData.global_user_id || userData.user_id || userData.id;
                        if (userId.includes('patient')) {
                            displayName = '患者用户';
                        } else if (userId.includes('doctor')) {
                            displayName = '医生用户';
                        } else if (userId.includes('admin')) {
                            displayName = '管理员';
                        } else {
                            displayName = userId.substring(0, 12) + '...';
                        }
                    }
                    
                    // 更新DOM
                    userName.textContent = displayName;
                    userAvatar.textContent = displayName.charAt(0).toUpperCase();
                    
                    // 同步全局变量
                    if (!currentUser) {
                        currentUser = userData;
                    }
                    
                    console.log('✅ 用户界面更新完成 - 已登录状态:', {
                        displayName,
                        userId: userData.global_user_id || userData.user_id || userData.id,
                        userDataKeys: Object.keys(userData)
                    });
                } else {
                    // userData不存在，显示未登录状态
                    console.warn('⚠️ 登录状态为true但无法获取用户数据，显示登录按钮');
                    authButtons.style.display = 'flex';
                    userInfo.style.display = 'none';
                }
            } else {
                // 未登录状态
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
                console.log('ℹ️ 用户界面更新完成 - 未登录状态');
            }
        }

        // 显示登录模态框
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
            
            // 清空表单
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // 隐藏登录模态框
        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'none';
        }

        // 执行登录
        async function performLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                errorDiv.textContent = '请输入用户名和密码';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.user) {
                    // 登录成功
                    currentUser = result.user;
                    userToken = result.token;
                    
                    // 保存到localStorage
                    localStorage.setItem('userData', JSON.stringify(currentUser));
                    localStorage.setItem('userToken', userToken);
                    
                    // 更新界面
                    updateUserInterface(true);
                    hideLoginModal();
                    
                    // 显示欢迎消息
                    const welcomeName = currentUser.username || currentUser.name || currentUser.phone || '用户';
                    showMessage(`欢迎回来，${welcomeName}！`, 'success');
                    
                } else {
                    errorDiv.textContent = result.message || '登录失败，请检查用户名和密码';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('登录请求失败:', error);
                errorDiv.textContent = '网络错误，请检查网络连接';
                errorDiv.style.display = 'block';
            }
        }

        // 注意：原有的手动同步功能已被自动同步管理器替代
        // 新的自动同步系统无需手动操作，将自动在后台运行

        // 退出登录
        function logout() {
            console.log('🚪 用户退出登录');
            
            // 使用统一认证管理器清除登录状态
            window.authManager.clearLoginState();
            
            currentUser = null;
            userToken = null;
            
            // 更新界面
            updateUserInterface(false);
            
            // 显示退出消息
            showMessage('正在退出登录...', 'info');
            
            // 退出后跳转到登录页面
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        }

        // 清除用户数据
        function clearUserData() {
            // 清除基础用户信息
            localStorage.removeItem('userData');
            localStorage.removeItem('userToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('patientToken');
            localStorage.removeItem('doctorToken');
            localStorage.removeItem('adminToken');
            
            // 🚨 安全修复：清除所有用户相关的对话历史数据
            const userId = getCurrentUserId();
            if (userId) {
                const keys = Object.keys(localStorage);
                const userDataKeys = keys.filter(key => 
                    key.startsWith(`tcm_doctor_history_${userId}_`) ||
                    key.startsWith(`conversationId_${userId}`) ||
                    key.startsWith(`followup_shown_`) ||
                    key.includes(userId)
                );
                
                userDataKeys.forEach(key => {
                    localStorage.removeItem(key);
                    console.log(`🧹 已清除用户数据: ${key}`);
                });
                
                console.log(`🧹 用户(${userId})退出：已清除${userDataKeys.length}项相关数据`);
            }
            
            // 清除全局变量
            currentUser = null;
            userToken = null;
            currentConversationId = null;
            selectedDoctor = null;
            
            // 清除页面上的对话内容
            const containers = ['messagesContainer', 'mobileMessagesContainer'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                }
            });
            
            console.log('🧹 用户数据清除完成');
        }

        // 🔑 获取当前对话历史，用于维持上下文连续性
        function getCurrentConversationHistory() {
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            if (!messagesContainer) {
                console.warn('未找到消息容器，返回空历史');
                return [];
            }
            
            const history = [];
            const messages = messagesContainer.querySelectorAll('.message');
            
            messages.forEach(messageEl => {
                const isUser = messageEl.classList.contains('user');
                const textEl = messageEl.querySelector('.message-text');
                
                if (textEl && textEl.textContent.trim()) {
                    history.push({
                        role: isUser ? 'user' : 'assistant',
                        content: textEl.textContent.trim()
                    });
                }
            });
            
            console.log(`🔄 获取对话历史: ${history.length}条消息`);
            return history;
        }

        // 🔑 标记处方为已支付状态并重新渲染完整内容
        async function markPrescriptionAsPaid(prescriptionId) {
            console.log('🔄 标记处方为已支付:', prescriptionId);
            
            // 🆕 关键修复：支付成功后将处方提交给医生审核
            try {
                console.log('🔄 支付成功，正在提交处方给医生审核...', { prescriptionId, type: typeof prescriptionId });
                const submitResponse = await fetch('/api/prescription-review/payment-confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        prescription_id: prescriptionId,  // 🔑 修复：移除parseInt，prescription_id应该已经是正确的整数
                        payment_amount: 80.00,
                        payment_method: 'alipay'
                    })
                });
                
                const submitResult = await submitResponse.json();
                console.log('📋 处方提交审核结果:', submitResult);
                
                if (submitResult.success) {
                    console.log('✅ 处方已成功提交医生审核');
                    // 显示审核等待提示
                    showMessage('✅ 支付成功！处方已提交医生审核，审核完成后即可配药', 'success');
                    
                    // 🔑 关键修复：如果提交审核成功，不显示完整处方，只显示等待审核状态
                    updatePrescriptionToReviewStatus(prescriptionId);
                    
                    // 🔑 新增：同步状态到服务器（处方状态已经通过payment-confirm API同步了）
                    await syncPrescriptionStatusToServer(prescriptionId, 'pending_review', {
                        action: 'payment_confirmed',
                        timestamp: new Date().toISOString()
                    });
                    
                    return; // 提前返回，不执行后面的完整处方显示逻辑
                } else {
                    console.warn('⚠️ 处方提交审核失败:', submitResult.message);
                }
            } catch (error) {
                console.error('❌ 处方提交审核异常:', error);
            }
            
            // 检测当前是移动端还是PC端
            const isMobile = window.innerWidth <= 768;
            console.log('🔍 屏幕检测:', { windowWidth: window.innerWidth, isMobile });
            
            // 优先尝试PC端容器，再尝试移动端容器
            let messagesContainer = document.getElementById('messagesContainer');
            let containerType = 'PC';
            
            if (!messagesContainer) {
                messagesContainer = document.getElementById('mobileMessagesContainer');
                containerType = 'Mobile';
            }
            
            console.log('📱 使用容器类型:', containerType);
            
            if (!messagesContainer) {
                console.error('❌ 未找到任何消息容器');
                return;
            }
            
            // 查找包含处方的AI消息
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            
            console.log('🔍 找到AI消息数量:', aiMessages.length);
            
            for (let i = 0; i < aiMessages.length; i++) {
                const messageDiv = aiMessages[i];
                
                // 检查是否有处方ID匹配或支付按钮
                const msgPrescriptionId = messageDiv.getAttribute('data-prescription-id');
                const hasPaymentButton = messageDiv.querySelector('.prescription-actions');
                
                console.log(`📋 消息 ${i+1}:`, {
                    msgPrescriptionId,
                    hasPaymentButton: !!hasPaymentButton,
                    targetPrescriptionId: prescriptionId
                });
                
                // 检查消息是否包含处方内容
                const messageContent = messageDiv.innerHTML || '';
                const hasUnlockButton = messageContent.includes('解锁完整处方') || messageContent.includes('确认处方并支付');
                const hasPrescriptionContent = messageContent.includes('处方') || messageContent.includes('方剂') || messageContent.includes('药材');
                
                console.log(`🔍 消息 ${i+1} 内容检查:`, {
                    hasUnlockButton,
                    hasPrescriptionContent,
                    contentLength: messageContent.length
                });
                
                // 如果指定了处方ID，优先匹配ID
                if (prescriptionId && msgPrescriptionId && msgPrescriptionId !== prescriptionId) {
                    console.log(`⏭️ 跳过消息 ${i+1} - ID不匹配`);
                    continue; // 跳过不匹配的处方
                }
                
                // 如果没有明确的处方ID，检查是否有处方相关内容
                const shouldProcess = msgPrescriptionId || hasPaymentButton || hasUnlockButton || 
                    (hasPrescriptionContent && messageContent.length > 1000); // 长内容很可能是处方
                
                if (!shouldProcess) {
                    console.log(`⏭️ 跳过消息 ${i+1} - 不是处方相关消息`);
                    continue;
                }
                
                console.log(`✅ 处理消息 ${i+1} - 开始获取原始处方内容`);
                
                // 获取原始处方内容（异步从API获取）
                let originalContent = await getOriginalPrescriptionContent(messageDiv, prescriptionId);
                
                // 如果API获取失败，尝试获取完整处方内容
                if (!originalContent) {
                    try {
                        console.log('[支付] 尝试获取完整处方内容...');
                        const fullContentResponse = await fetch(`/api/prescription/${prescriptionId}/full-content`);
                        if (fullContentResponse.ok) {
                            const fullContentData = await fullContentResponse.json();
                            if (fullContentData.success && fullContentData.prescription) {
                                originalContent = fullContentData.prescription.full_content;
                                console.log('[支付] 获取到完整处方内容，长度:', originalContent.length);
                            }
                        }
                    } catch (fullContentError) {
                        console.log('[支付] 获取完整内容失败:', fullContentError);
                    }
                }
                
                // 最终fallback：使用DOM内容
                if (!originalContent) {
                    console.log('⚠️ API获取失败，使用DOM内容作为备用');
                    const contentDiv = messageDiv.querySelector('.message-text') || messageDiv.querySelector('.message-content');
                    if (contentDiv) {
                        originalContent = contentDiv.innerHTML;
                        console.log('📄 从DOM获取内容长度:', originalContent.length);
                    }
                }
                
                if (originalContent) {
                    console.log('🔄 重新渲染处方内容为已支付状态');
                    
                    // 直接显示完整原始内容，绕过处方渲染器的复杂逻辑
                    console.log('✅ 直接显示完整处方内容（已支付）');
                    console.log('📋 原始处方内容预览:', originalContent.substring(0, 200) + '...');
                    
                    let newContent;
                    
                    // 如果原始内容已经包含HTML，直接使用
                    if (originalContent.includes('<div') || originalContent.includes('<p')) {
                        newContent = originalContent;
                    } else {
                        // 如果是纯文本，进行格式化
                        newContent = formatMessage(originalContent);
                    }
                    
                    // 移除任何隐藏的内容标记和预览限制
                    newContent = newContent.replace(/\*\*\*/g, '15');
                    newContent = newContent.replace(/解锁查看/g, '');
                    newContent = newContent.replace(/\+ \d+ 味药材/g, '');
                    newContent = newContent.replace(/方剂组成预览/g, '完整方剂组成');
                    newContent = newContent.replace(/预览/g, '完整');
                    
                    // 移除支付相关的按钮和提示
                    newContent = newContent.replace(/<div[^>]*解锁完整处方[^>]*>.*?<\/div>/gs, '');
                    newContent = newContent.replace(/<button[^>]*确认处方并支付[^>]*>.*?<\/button>/gs, '');
                    newContent = newContent.replace(/🔒 解锁完整处方/g, '');
                    newContent = newContent.replace(/💳 确认处方并支付.*?¥\d+/g, '');
                    
                    // 如果内容太短，可能是被过度处理了，尝试恢复
                    if (newContent.length < 500 && originalContent.length > 1000) {
                        console.log('⚠️ 处理后内容过短，使用原始内容');
                        newContent = originalContent;
                    }
                    
                    console.log('📊 内容处理结果:', {
                        原始长度: originalContent.length,
                        处理后长度: newContent.length,
                        包含药材: newContent.includes('药材') || newContent.includes('方剂')
                    });
                    
                    // 添加支付成功标识
                    newContent += `
                        <div class="prescription-paid" style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 13px; color: #059669; margin-bottom: 8px;">
                                <strong>✅ 处方已解锁</strong> - 支付成功，完整处方内容已显示
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="showDecorationInfo('${prescriptionId || 'unknown'}')" 
                                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                    🍵 联系代煎服务
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 更新消息内容 - 尝试多个可能的选择器
                    let contentDiv = messageDiv.querySelector('.message-text');
                    if (!contentDiv) {
                        contentDiv = messageDiv.querySelector('.message-content .message-text');
                    }
                    if (!contentDiv) {
                        contentDiv = messageDiv.querySelector('.content');
                    }
                    if (!contentDiv) {
                        contentDiv = messageDiv.querySelector('.message-content');
                    }
                    
                    console.log('🔍 找到内容容器:', !!contentDiv, contentDiv?.className);
                    
                    if (contentDiv) {
                        console.log('✅ 更新处方内容 - 原长度:', contentDiv.innerHTML.length, '新长度:', newContent.length);
                        contentDiv.innerHTML = newContent;
                    } else {
                        console.error('❌ 未找到内容容器，无法更新处方');
                    }
                    
                    // 标记处方ID和支付状态
                    if (prescriptionId) {
                        messageDiv.setAttribute('data-prescription-id', prescriptionId);
                        messageDiv.setAttribute('data-paid', 'true');
                    }
                    
                    console.log('✅ 已更新处方内容为已支付状态');
                }
            }
            
            // 🔑 关键：立即保存更新后的状态
            if (selectedDoctor) {
                saveCurrentDoctorHistory();
                console.log('✅ 已保存支付状态到历史记录');
            }
        }
        
        // 🆕 更新处方显示为等待审核状态
        function updatePrescriptionToReviewStatus(prescriptionId) {
            console.log('🔄 更新处方为等待审核状态:', prescriptionId);
            
            // 查找包含处方的消息
            const messagesContainer = document.getElementById('messagesContainer') || document.getElementById('mobileMessagesContainer');
            if (!messagesContainer) return;
            
            const aiMessages = messagesContainer.querySelectorAll('.message.ai');
            
            for (let messageDiv of aiMessages) {
                const msgPrescriptionId = messageDiv.getAttribute('data-prescription-id');
                const messageContent = messageDiv.innerHTML || '';
                const hasPrescriptionContent = messageContent.includes('处方') || messageContent.includes('方剂');
                
                // 如果是目标处方消息
                if ((prescriptionId && msgPrescriptionId === prescriptionId) || 
                    (!prescriptionId && hasPrescriptionContent)) {
                    
                    const contentDiv = messageDiv.querySelector('.message-text') || messageDiv.querySelector('.message-content');
                    if (contentDiv) {
                        // 替换为等待审核状态
                        contentDiv.innerHTML = `
                            <div class="prescription-review-waiting" style="padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border-left: 4px solid #f59e0b; margin: 15px 0;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">⏳</div>
                                    <h3 style="color: #92400e; margin: 0; font-size: 18px;">处方等待医生审核中</h3>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; margin: 10px 0;">
                                    <p style="margin: 0; color: #78350f; font-size: 14px; line-height: 1.6;">
                                        ✅ <strong>支付已完成</strong><br>
                                        🔍 处方正在由专业医生审核中<br>
                                        📋 审核完成后您将收到通知<br>
                                        💊 审核通过后即可配药
                                    </p>
                                </div>
                                
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="checkPrescriptionStatus('${prescriptionId}')" 
                                            style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                        🔍 查看审核状态
                                    </button>
                                </div>
                                
                                <div style="font-size: 12px; color: #92400e; text-align: center; margin-top: 10px; opacity: 0.8;">
                                    处方ID: ${prescriptionId}
                                </div>
                            </div>
                        `;
                        
                        // 标记处方状态
                        messageDiv.setAttribute('data-prescription-status', 'pending_review');
                        messageDiv.setAttribute('data-prescription-id', prescriptionId);
                        
                        // 🔑 关键修复：同步状态到localStorage，确保刷新后能恢复
                        syncPrescriptionStatusToStorage(prescriptionId, 'pending_review');
                        
                        console.log('✅ 已更新处方显示为等待审核状态');
                    }
                    break;
                }
            }
        }
        
        // 🆕 同步处方状态到本地存储
        function syncPrescriptionStatusToStorage(prescriptionId, status) {
            try {
                const userId = getCurrentUserId();
                const storageKey = `prescription_status_${userId}`;
                let prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                prescriptionStatuses[prescriptionId] = {
                    status: status,
                    timestamp: Date.now(),
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.setItem(storageKey, JSON.stringify(prescriptionStatuses));
                console.log('💾 已同步处方状态到本地存储:', prescriptionId, status);
                
            } catch (error) {
                console.error('❌ 同步处方状态失败:', error);
            }
        }
        
        // 🆕 从本地存储获取处方状态
        function getPrescriptionStatusFromStorage(prescriptionId) {
            try {
                const userId = getCurrentUserId();
                const storageKey = `prescription_status_${userId}`;
                const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                const statusData = prescriptionStatuses[prescriptionId];
                return statusData ? statusData.status : null;
                
            } catch (error) {
                console.error('❌ 获取处方状态失败:', error);
                return null;
            }
        }
        
        // 🆕 检查处方审核状态 - 增强实时同步
        async function checkPrescriptionStatus(prescriptionId) {
            try {
                console.log('🔍 检查处方审核状态:', prescriptionId);
                
                const response = await fetch(`/api/prescription-review/status/${prescriptionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('📋 处方状态:', result);
                    
                    if (result.success && result.data) {
                        const statusData = result.data;
                        
                        if (statusData.is_reviewed) {
                            // 审核完成，显示最终处方
                            showMessage('✅ 处方审核已完成！', 'success');
                            await markPrescriptionAsCompleted(prescriptionId, statusData);
                            
                            // 🔑 同步状态更新到本地存储
                            syncPrescriptionStatusToStorage(prescriptionId, 'approved');
                        } else {
                            // 仍在审核中
                            showMessage(`⏳ 处方仍在审核中，状态：${statusData.status_description}`, 'info');
                        }
                    }
                } else {
                    // 🔑 修复：改进错误处理，提供更具体的错误信息
                    const errorMsg = result.message || '无法获取处方状态';
                    if (result.error_code === 'PRESCRIPTION_NOT_FOUND') {
                        console.warn('处方不存在:', prescriptionId);
                        showMessage(`⚠️ 处方记录不存在(ID: ${prescriptionId})`, 'warning');
                    } else {
                        showMessage(`❌ ${errorMsg}`, 'error');
                    }
                }
            } catch (error) {
                console.error('检查处方状态失败:', error);
                // 🔑 修复：区分不同类型的网络错误
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showMessage('❌ 网络连接失败，请检查网络设置', 'error');
                } else if (error.name === 'SyntaxError') {
                    showMessage('❌ 服务器响应格式错误', 'error');
                } else {
                    showMessage('❌ 网络错误，请稍后重试', 'error');
                }
            }
        }
        
        // 🆕 启动实时同步检查机制
        function startPrescriptionStatusPolling() {
            const userId = getCurrentUserId();
            const storageKey = `prescription_status_${userId}`;
            
            // 每30秒检查一次处方状态
            setInterval(async () => {
                try {
                    const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                    
                    // 检查所有待审核的处方
                    for (const [prescriptionId, statusData] of Object.entries(prescriptionStatuses)) {
                        if (statusData.status === 'pending_review') {
                            // 检查是否已过期（超过24小时不再检查）
                            const hoursAgo = (Date.now() - statusData.timestamp) / (1000 * 60 * 60);
                            if (hoursAgo < 24 && prescriptionId && prescriptionId !== 'undefined') {
                                await checkPrescriptionStatusSilently(prescriptionId);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('定期检查处方状态失败:', error);
                }
            }, 30000); // 30秒检查一次
            
            console.log('✅ 已启动处方状态实时同步检查');
        }
        
        // 🆕 静默检查处方状态（不显示UI提示）
        async function checkPrescriptionStatusSilently(prescriptionId) {
            try {
                const response = await fetch(`/api/prescription-review/status/${prescriptionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.is_reviewed) {
                        // 审核完成，自动更新界面
                        console.log('🔔 检测到处方审核完成:', prescriptionId);
                        showMessage('🔔 您有处方审核完成，正在更新显示...', 'success');
                        
                        await markPrescriptionAsCompleted(prescriptionId, result.data);
                        syncPrescriptionStatusToStorage(prescriptionId, 'approved');
                        
                        // 播放通知音效（如果可能）
                        if ('Audio' in window) {
                            try {
                                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFAg+ltryxnkpBSl+zPLZizEIGGS57OObTgwKT6fh8LZnHgg2jdXzzn8vBSF0xe/ekkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4GMIzU8tGAMgUfcsLu45hEDBFYrOLtrVwWBDqU2fLIfSwGJHfH8N+QQAoUXrTp6qtWFAg+ltrzxnkpBSl+zPLZizEIGGS56+OcTgwKT6fh8LZnHgg2jdT0z4AuBSJ0xe/gkkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4GMIzU8tGAMgUfcsLu45hEDBFYrOLtrVwWBDqU2fLIfSwGJHfH8N+QQAoUXrTp6qtWFAg+ltrzxnkpBSl+zPLZizEIGGS56+OcTgwKT6fh8LZnHgg2jdT0z4AuBSJ0xe/gkkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4GMIzU8tGAMgUfcsLu45hEDBFYrOLtrVwWBDqU2fLIfSwGJHfH8N+QQAoUXrTp6qtWFAg+ltrzxnkpBSl+zPLZizEIGGS56+OcTgwKT6fh8LZnHgg2jdT0z4AuBSJ0xe/gkkILElyx5+2rWRUGPJPY88p9KwUme8rx2o4yBxZiturjpVITC0ml4e+3aB4=');
                                audio.volume = 0.3;
                                audio.play();
                            } catch (e) {
                                // 忽略音效播放错误
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('静默检查处方状态失败:', prescriptionId, error);
                // 🔑 如果是处方不存在的错误，从本地存储中移除
                if (error.message && error.message.includes('不存在')) {
                    try {
                        const userId = getCurrentUserId();
                        const storageKey = `prescription_status_${userId}`;
                        const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                        if (prescriptionStatuses[prescriptionId]) {
                            delete prescriptionStatuses[prescriptionId];
                            localStorage.setItem(storageKey, JSON.stringify(prescriptionStatuses));
                            console.log('已清理无效处方ID:', prescriptionId);
                        }
                    } catch (cleanupError) {
                        console.warn('清理无效处方ID失败:', cleanupError);
                    }
                }
            }
        }
        
        // 🆕 恢复所有待审核处方状态 - 页面刷新后确保状态一致性
        function restoreAllPendingPrescriptions() {
            try {
                const userId = getCurrentUserId();
                if (!userId) return;
                
                const storageKey = `prescription_status_${userId}`;
                const prescriptionStatuses = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                console.log('🔄 检查并恢复所有待审核处方状态:', prescriptionStatuses);
                
                // 遍历所有本地存储的处方状态
                for (const [prescriptionId, statusData] of Object.entries(prescriptionStatuses)) {
                    if (statusData.status === 'pending_review') {
                        console.log('🔄 恢复待审核处方:', prescriptionId);
                        updatePrescriptionToReviewStatus(prescriptionId);
                    }
                }
                
                console.log('✅ 处方状态恢复检查完成');
                
            } catch (error) {
                console.error('❌ 恢复处方状态失败:', error);
            }
        }
        
        // 🆕 标记处方为审核完成状态
        async function markPrescriptionAsCompleted(prescriptionId, statusData) {
            console.log('📋 处方审核完成，显示最终处方');
            
            // 🔑 关键修复：医生审核完成后才显示完整处方，不走支付流程
            try {
                // 查找处方消息元素
                const messagesContainer = document.getElementById('messagesContainer') || document.getElementById('mobileMessagesContainer');
                if (!messagesContainer) return;
                
                const messageElements = messagesContainer.querySelectorAll('.message.ai');
                
                for (let messageDiv of messageElements) {
                    const msgPrescriptionId = messageDiv.getAttribute('data-prescription-id');
                    if (msgPrescriptionId === prescriptionId) {
                        const contentDiv = messageDiv.querySelector('.message-text') || messageDiv.querySelector('.message-content');
                        if (contentDiv) {
                            // 获取审核后的完整处方内容
                            const finalPrescription = statusData.final_prescription || statusData.doctor_prescription || "审核完成的处方内容";
                            
                            contentDiv.innerHTML = `
                                <div class="prescription-approved" style="padding: 20px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 12px; border-left: 4px solid #22c55e; margin: 15px 0;">
                                    <div style="text-align: center; margin-bottom: 15px;">
                                        <div style="font-size: 2em; margin-bottom: 10px;">✅</div>
                                        <h3 style="color: #15803d; margin: 0; font-size: 18px;">医生审核通过</h3>
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; margin: 15px 0;">
                                        <div style="color: #15803d; font-size: 16px; font-weight: 600; margin-bottom: 15px;">
                                            审核通过的处方：
                                        </div>
                                        <div style="color: #374151; line-height: 1.6; white-space: pre-wrap;">
                                            ${finalPrescription}
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 15px;">
                                        <div style="color: #059669; font-size: 14px; margin-bottom: 10px;">
                                            ✅ 医生审核已完成<br>
                                            💊 您可以凭此处方配药
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #059669; text-align: center; margin-top: 10px;">
                                        处方ID: ${prescriptionId}
                                    </div>
                                </div>
                            `;
                            
                            // 标记为审核完成状态
                            messageDiv.setAttribute('data-prescription-status', 'approved');
                            syncPrescriptionStatusToStorage(prescriptionId, 'approved');
                            
                            console.log('✅ 已显示审核通过的最终处方');
                        }
                        break;
                    }
                }
            } catch (error) {
                console.error('❌ 显示审核完成处方失败:', error);
            }
        }

        // 获取原始处方内容的辅助函数（从API获取）
        async function getOriginalPrescriptionContent(messageDiv, prescriptionId) {
            // 优先从API获取原始处方内容
            if (prescriptionId) {
                try {
                    console.log('🔄 从API获取处方详情:', prescriptionId);
                    const response = await fetch(`/api/prescription/${prescriptionId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.prescription) {
                            const prescriptionData = result.prescription;
                            // 返回AI处方内容（原始内容）
                            const originalContent = prescriptionData.ai_prescription || prescriptionData.doctor_prescription;
                            if (originalContent) {
                                console.log('✅ 从API成功获取原始处方内容');
                                return originalContent;
                            }
                        }
                    }
                } catch (error) {
                    console.error('❌ API获取处方内容失败:', error);
                }
            }
            
            // 备用方案1：从历史记录获取原始内容
            const currentHistory = getCurrentDoctorHistory();
            if (currentHistory && currentHistory.length > 0) {
                // 从最近的消息中查找处方内容
                for (let i = currentHistory.length - 1; i >= 0; i--) {
                    const msg = currentHistory[i];
                    if (msg.type === 'ai' && (msg.prescriptionId === prescriptionId || msg.prescriptionData?.prescriptionId === prescriptionId)) {
                        console.log('✅ 从历史记录找到原始处方内容');
                        return msg.originalContent || msg.content;
                    }
                }
            }
            
            // 备用方案2：从DOM获取（可能已经被处方渲染器修改过）
            const contentDiv = messageDiv.querySelector('.message-text');
            if (contentDiv) {
                // 尝试获取未修改的文本内容
                const textContent = contentDiv.textContent || contentDiv.innerText;
                if (textContent && textContent.length > 100) {
                    console.log('⚠️ 从DOM获取处方内容（可能不完整）');
                    return textContent;
                }
            }
            
            console.warn('❌ 无法获取原始处方内容');
            return null;
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            // 创建消息提示元素
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // 根据类型设置颜色
            switch (type) {
                case 'success':
                    messageDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    messageDiv.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                case 'info':
                default:
                    messageDiv.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                    break;
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // 获取认证头
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // 🔑 修复：使用authManager获取正确的token
            const token = window.authManager ? window.authManager.getToken() : userToken;
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                console.log('🔑 使用认证token:', token.substring(0, 20) + '...');
            } else {
                console.log('⚠️ 没有找到认证token');
            }
            
            return headers;
        }

        // ===================== 认证系统结束 =====================

        // ===================== 处方管理系统 =====================
        
        // 从对话历史中提取症状和诊断信息
        function extractConversationSummary() {
            const container = document.getElementById('messagesContainer');
            let symptoms = '';
            let diagnosis = '';
            
            if (container) {
                const messages = container.querySelectorAll('.message');
                const userMessages = [];
                const aiMessages = [];
                
                messages.forEach(messageEl => {
                    const textEl = messageEl.querySelector('.message-text');
                    if (textEl) {
                        const content = textEl.textContent.trim();
                        if (messageEl.classList.contains('user')) {
                            userMessages.push(content);
                        } else if (messageEl.classList.contains('ai')) {
                            aiMessages.push(content);
                        }
                    }
                });
                
                // 提取用户描述的症状
                symptoms = userMessages.join(' | ').substring(0, 500); // 限制长度
                
                // 提取AI的诊断信息
                const lastAiMessage = aiMessages[aiMessages.length - 1] || '';
                if (lastAiMessage.includes('证候') || lastAiMessage.includes('诊断')) {
                    diagnosis = lastAiMessage.substring(0, 300); // 提取诊断信息
                }
            }
            
            return {
                symptoms: symptoms || '患者症状描述',
                diagnosis: diagnosis || 'AI中医诊断'
            };
        }
        
        // 确认处方并支付
        async function confirmPrescription(encodedPrescription) {
            try {
                const prescriptionContent = decodeURIComponent(atob(encodedPrescription));
                
                // 检查是否已登录
                if (!currentUser || !userToken) {
                    showMessage('请先登录后再确认处方', 'error');
                    showLoginModal();
                    return;
                }
                
                // 创建处方确认模态框
                showPrescriptionConfirmModal(prescriptionContent);
                
            } catch (error) {
                console.error('处方确认失败:', error);
                showMessage('处方数据解析失败', 'error');
            }
        }

        // 显示处方确认模态框
        function showPrescriptionConfirmModal(prescriptionContent) {
            // 检查是否已存在模态框
            let modal = document.getElementById('prescriptionModal');
            if (!modal) {
                // 创建处方确认模态框
                modal = document.createElement('div');
                modal.id = 'prescriptionModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1001;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">📋 处方确认</h3>
                        </div>
                        <div style="padding: 24px;">
                            <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <h4 style="margin: 0 0 12px 0; color: #374151;">处方内容：</h4>
                                <div id="prescriptionContent" style="font-family: monospace; white-space: pre-wrap; line-height: 1.6; color: #1f2937;"></div>
                            </div>
                            
                            <div style="background: #fef3c7; border-radius: 8px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0 0 12px 0; color: #92400e;">⚠️ 重要提醒：</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 14px;">
                                    <li>此为AI生成的建议处方，仅供参考</li>
                                    <li>确认处方将进入支付流程，支付后可联系代煎服务</li>
                                    <li>建议在专业医生指导下使用</li>
                                    <li>如有不适，请立即停药并就医</li>
                                </ul>
                            </div>
                            
                            <div style="background: #e0f2fe; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px 0; color: #0277bd;">💰 费用说明：</h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>处方费用：</span>
                                    <span style="font-weight: bold;">¥ 50.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>代煎费用：</span>
                                    <span style="font-weight: bold;">¥ 30.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #b3e5fc;">
                                    <span style="font-weight: bold;">总计：</span>
                                    <span style="font-weight: bold; color: #0277bd; font-size: 18px;">¥ 80.00</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button onclick="hidePrescriptionModal()" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; background: #f9fafb; color: #374151; border-radius: 8px; cursor: pointer;">
                                    取消
                                </button>
                                <button onclick="proceedToPayment()" style="flex: 1; padding: 12px; border: none; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    确认并支付 ¥80.00
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // 更新处方内容
            const contentDiv = modal.querySelector('#prescriptionContent');
            contentDiv.textContent = prescriptionContent;
            
            // 显示模态框
            modal.style.display = 'flex';
        }

        // 隐藏处方确认模态框
        function hidePrescriptionModal() {
            const modal = document.getElementById('prescriptionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 进入支付流程
        async function proceedToPayment() {
            try {
                // 获取处方内容
                const prescriptionContent = document.getElementById('prescriptionContent').textContent;
                
                // 确保用户信息存在
                if (!currentUser) {
                    showMessage('用户信息缺失，请重新登录', 'error');
                    return;
                }
                
                // 从对话历史中提取症状和诊断信息
                const conversationSummary = extractConversationSummary();
                
                // 准备请求数据
                // 🔑 修复：使用正确的用户ID映射，确保数据关联正确
                const userId = getCurrentUserId(); // 使用统一的用户ID获取方式
                const requestData = {
                    patient_id: userId,
                    conversation_id: currentConversationId || generateConversationId(),
                    patient_name: currentUser.username || currentUser.display_name || currentUser.name || '患者',
                    patient_phone: currentUser.phone || '',
                    symptoms: conversationSummary.symptoms,
                    diagnosis: conversationSummary.diagnosis,
                    ai_prescription: prescriptionContent
                };
                
                // 调试信息
                console.log('发送处方创建请求:', requestData);
                console.log('认证头:', getAuthHeaders());
                
                // 按照后端API格式发送数据
                const response = await fetch('/api/prescription/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                // 检查响应状态
                console.log('响应状态:', response.status, response.statusText);
                
                const result = await response.json();
                
                // 调试信息
                console.log('处方创建响应:', result);
                
                if (result.success && result.prescription_id) {
                    // 🔑 修复：处方创建成功后更新问诊状态为完成
                    await updateConsultationStatus('completed', result.prescription_id);
                    
                    // 处方创建成功，进入支付流程
                    hidePrescriptionModal();
                    showPaymentModal(result.prescription_id, 80.00);
                } else {
                    // 显示详细错误信息
                    const errorMsg = result.message || result.detail || '处方创建失败';
                    console.error('处方创建失败:', result);
                    showMessage(errorMsg, 'error');
                }
                
            } catch (error) {
                console.error('支付流程启动失败:', error);
                // 检查是否是网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showMessage('网络连接失败，请检查网络状态', 'error');
                } else {
                    showMessage(`服务暂时不可用: ${error.message}`, 'error');
                }
            }
        }

        // 咨询专业医生
        function consultDoctor() {
            if (!currentUser) {
                showMessage('请先登录后再咨询医生', 'error');
                showLoginModal();
                return;
            }
            
            // 获取当前处方内容
            const prescriptionElement = document.querySelector('.prescription-content');
            const prescriptionContent = prescriptionElement ? prescriptionElement.textContent : '';
            
            if (!prescriptionContent) {
                showMessage('请先生成处方后再咨询医生', 'error');
                return;
            }
            
            // 显示医生咨询对话框
            showDoctorConsultationModal(prescriptionContent);
        }
        
        // 显示医生咨询对话框
        function showDoctorConsultationModal(prescriptionContent) {
            // 创建医生咨询模态框
            let modal = document.getElementById('doctorConsultationModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'doctorConsultationModal';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="hideDoctorConsultationModal()">
                        <div class="modal-content doctor-consultation-modal" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3>💬 咨询专业医生</h3>
                                <button class="close-btn" onclick="hideDoctorConsultationModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="consultation-info">
                                    <p>您可以就以下AI生成的处方咨询我们的专业中医师：</p>
                                    <div class="prescription-preview">
                                        ${prescriptionContent}
                                    </div>
                                </div>
                                <div class="doctor-list">
                                    <h4>选择咨询医生：</h4>
                                    <div class="available-doctors">
                                        <div class="doctor-card" onclick="startConsultation('张医生', 'zhangyi')">
                                            <div class="doctor-avatar">张</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">张医生</div>
                                                <div class="doctor-specialty">中医内科 • 在线</div>
                                                <div class="doctor-experience">20年经验</div>
                                            </div>
                                            <div class="consult-btn">💬 咨询</div>
                                        </div>
                                        <div class="doctor-card" onclick="startConsultation('李医生', 'liwang')">
                                            <div class="doctor-avatar">李</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">李医生</div>
                                                <div class="doctor-specialty">中医妇科 • 在线</div>
                                                <div class="doctor-experience">15年经验</div>
                                            </div>
                                            <div class="consult-btn">💬 咨询</div>
                                        </div>
                                        <div class="doctor-card" onclick="startConsultation('王医生', 'wanglin')">
                                            <div class="doctor-avatar">王</div>
                                            <div class="doctor-info">
                                                <div class="doctor-name">王医生</div>
                                                <div class="doctor-specialty">中医儿科 • 在线</div>
                                                <div class="doctor-experience">18年经验</div>
                                            </div>
                                            <div class="consult-btn">💬 咨询</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="consultation-notice">
                                    <p><strong>💡 咨询说明：</strong></p>
                                    <ul>
                                        <li>专业医生将为您解答处方相关问题</li>
                                        <li>可以询问药材功效、用法用量等</li>
                                        <li>医生会根据您的具体情况调整处方</li>
                                        <li>咨询费用：50元/次，约15分钟</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="hideDoctorConsultationModal()">
                                    取消
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // 添加样式
                if (!document.getElementById('doctorConsultationStyles')) {
                    const styles = document.createElement('style');
                    styles.id = 'doctorConsultationStyles';
                    styles.innerHTML = `
                        .doctor-consultation-modal {
                            width: 90%;
                            max-width: 600px;
                            max-height: 80vh;
                            overflow-y: auto;
                        }
                        .prescription-preview {
                            background: #f8f9fa;
                            border: 1px solid #e9ecef;
                            border-radius: 8px;
                            padding: 15px;
                            margin: 10px 0;
                            font-size: 14px;
                            line-height: 1.6;
                            max-height: 150px;
                            overflow-y: auto;
                        }
                        .available-doctors {
                            display: grid;
                            gap: 10px;
                            margin-top: 10px;
                        }
                        .doctor-card {
                            display: flex;
                            align-items: center;
                            padding: 15px;
                            border: 2px solid #e9ecef;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            background: white;
                        }
                        .doctor-card:hover {
                            border-color: #10b981;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
                            transform: translateY(-2px);
                        }
                        .doctor-avatar {
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 18px;
                            margin-right: 15px;
                        }
                        .doctor-info {
                            flex: 1;
                        }
                        .doctor-name {
                            font-weight: 600;
                            font-size: 16px;
                            margin-bottom: 4px;
                        }
                        .doctor-specialty {
                            color: #10b981;
                            font-size: 14px;
                            margin-bottom: 2px;
                        }
                        .doctor-experience {
                            color: #6b7280;
                            font-size: 12px;
                        }
                        .consult-btn {
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: 500;
                        }
                        .consultation-notice {
                            background: #f0f9ff;
                            border: 1px solid #bae6fd;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        .consultation-notice ul {
                            margin: 8px 0 0 20px;
                        }
                        .consultation-notice li {
                            margin-bottom: 4px;
                            font-size: 14px;
                        }
                    `;
                    document.head.appendChild(styles);
                }
            }
            
            modal.style.display = 'flex';
            showMessage('请选择您想要咨询的医生', 'info');
        }
        
        // 隐藏医生咨询对话框
        function hideDoctorConsultationModal() {
            const modal = document.getElementById('doctorConsultationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 开始与医生的咨询
        function startConsultation(doctorName, doctorId) {
            hideDoctorConsultationModal();
            showMessage(`正在连接${doctorName}，请稍候...`, 'info');
            
            // 模拟连接医生
            setTimeout(() => {
                showMessage(`已成功连接${doctorName}！您可以开始咨询了`, 'success');
                
                // 这里可以集成真实的医生咨询系统
                // 比如打开聊天窗口、WebSocket连接等
                showDoctorChatInterface(doctorName, doctorId);
            }, 2000);
        }
        
        // 显示医生聊天界面（简化版本）
        function showDoctorChatInterface(doctorName, doctorId) {
            showMessage(`${doctorName}：您好！我已经看到您的处方，有什么问题可以随时问我。`, 'info');
            
            // 实际项目中这里应该集成真实的聊天系统
            // 比如：
            // - WebSocket实时通信
            // - 聊天记录存储
            // - 文件传输功能
            // - 视频通话功能等
        }

        // 保存处方
        async function savePrescription(encodedPrescription) {
            try {
                const prescriptionContent = decodeURIComponent(atob(encodedPrescription));
                
                if (!currentUser) {
                    showMessage('请先登录后再保存处方', 'error');
                    showLoginModal();
                    return;
                }
                
                const response = await fetch('/api/prescription/save', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        content: prescriptionContent,
                        doctor_id: selectedDoctor,
                        status: 'saved'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('处方已保存到您的病历记录中', 'success');
                } else {
                    showMessage(result.message || '处方保存失败', 'error');
                }
                
            } catch (error) {
                console.error('保存处方失败:', error);
                showMessage('保存服务暂时不可用', 'error');
            }
        }

        // 显示支付模态框
        // 获取处方内容的辅助函数
        function getPrescriptionContent() {
            // 从最新的AI消息中获取处方内容
            const messages = document.querySelectorAll('.message');
            let prescriptionContent = '';
            
            // 从后往前查找包含处方的AI消息
            for (let i = messages.length - 1; i >= 0; i--) {
                const message = messages[i];
                const messageText = message.querySelector('.message-text');
                
                if (message.classList.contains('ai-message') && messageText) {
                    const content = messageText.textContent || messageText.innerText || '';
                    
                    // 检查是否包含处方相关内容
                    if (content.includes('处方') || content.includes('方剂') || content.includes('药材') || 
                        content.includes('君药') || content.includes('臣药') || content.includes('佐药') || content.includes('使药')) {
                        prescriptionContent = content;
                        break;
                    }
                }
            }
            
            return prescriptionContent;
        }

        function showPaymentModal(prescriptionId, amount) {
            // 获取处方内容
            const prescriptionContent = getPrescriptionContent();
            let formattedContent = '';
            
            if (prescriptionContent && window.prescriptionContentRenderer) {
                formattedContent = window.prescriptionContentRenderer.formatRegularContent(prescriptionContent);
            } else {
                formattedContent = '<p class="no-content">正在加载处方内容...</p>';
            }
            
            // 检查是否已存在模态框
            let modal = document.getElementById('paymentModal');
            if (!modal) {
                // 创建支付模态框
                modal = document.createElement('div');
                modal.id = 'paymentModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1002;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; text-align: center; position: sticky; top: 0; z-index: 1;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">📋 处方确认与支付</h3>
                        </div>
                        
                        <div style="padding: 24px;">
                            <div style="margin-bottom: 24px; background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                    📋 问诊汇总信息
                                </h4>
                                <div id="prescriptionModalContent">
                                    ${formattedContent}
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; border: 1px solid #3b82f6;">
                                <div style="font-size: 32px; font-weight: bold; color: #1e40af; margin-bottom: 8px;">¥ ${amount.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #1e40af;">包含：处方诊疗费 + 代煎服务费</div>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <button onclick="payWithAlipay('${prescriptionId}', ${amount})" 
                                        style="width: 100%; padding: 16px; border: 2px solid #1677ff; background: #f0f8ff; color: #1677ff; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    💙 支付宝支付
                                </button>
                                <button onclick="payWithWechat('${prescriptionId}', ${amount})" 
                                        style="width: 100%; padding: 16px; border: 2px solid #07c160; background: #f0fff4; color: #07c160; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    💚 微信支付
                                </button>
                            </div>
                            
                            <div style="text-align: center;">
                                <button onclick="hidePaymentModal()" 
                                        style="color: #6b7280; background: none; border: none; cursor: pointer; text-decoration: underline; font-size: 14px;">
                                    取消支付
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } else {
                // 更新已存在的模态框内容
                const contentDiv = modal.querySelector('#prescriptionModalContent');
                if (contentDiv) {
                    contentDiv.innerHTML = formattedContent;
                }
            }
            
            // 显示模态框
            modal.style.display = 'flex';
        }

        // 隐藏支付模态框
        function hidePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 支付宝支付
        async function payWithAlipay(prescriptionId, amount) {
            try {
                const response = await fetch('/api/payment/alipay/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        prescription_id: prescriptionId,
                        amount: amount,
                        payment_method: 'alipay'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 显示支付宝操作选择
                    hidePaymentModal();
                    showAlipayOptions(result.data.payment_url, result.data.payment_id, prescriptionId);
                } else {
                    showMessage(result.message || '支付创建失败', 'error');
                }
                
            } catch (error) {
                console.error('支付宝支付失败:', error);
                showMessage('支付服务暂时不可用', 'error');
            }
        }

        // 显示支付宝操作选择
        function showAlipayOptions(paymentUrl, paymentId, prescriptionId) {
            let modal = document.getElementById('alipayOptionsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'alipayOptionsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1003;
                `;
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 32px; text-align: center; max-width: 400px;">
                    <h3 style="margin: 0 0 20px 0; color: #1677ff;">💙 支付宝支付</h3>
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 60px;">💰</div>
                        <div style="margin-top: 12px; color: #666; font-size: 14px;">请选择支付方式</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="window.open('${paymentUrl}', '_blank'); pollPaymentStatus('${paymentId}'); hideAlipayOptionsModal();" 
                                style="padding: 12px 20px; background: #1677ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            🌐 跳转支付宝网页支付
                        </button>
                        <button onclick="testAlipayPaymentSuccess('${paymentId}', '${prescriptionId}')" 
                                style="padding: 12px 20px; background: #52c41a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            ✅ 测试支付成功
                        </button>
                        <button onclick="hideAlipayOptionsModal()" 
                                style="padding: 8px 20px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            取消支付
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // 隐藏支付宝选项模态框
        function hideAlipayOptionsModal() {
            const modal = document.getElementById('alipayOptionsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 测试支付宝支付成功
        async function testAlipayPaymentSuccess(paymentId, prescriptionId) {
            try {
                // 检查登录状态 (调试信息)
                console.log('🔄 用户登录状态 - Token:', !!userToken, 'User:', !!currentUser);
                
                const encodedOrderNo = encodeURIComponent(paymentId);
                console.log('🔄 测试支付宝支付成功，order_no:', paymentId);
                
                const response = await fetch(`/api/payment/alipay/test-success?order_no=${encodedOrderNo}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                console.log('🔄 支付宝API响应状态:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ 支付宝API错误响应:', errorText);
                    showMessage(`支付API错误: ${response.status}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('📋 支付宝API响应结果:', result);
                
                if (result.success) {
                    hideAlipayOptionsModal();
                    showMessage('测试支付成功！您的处方已解锁', 'success');
                    
                    // 更新UI中的处方状态为已支付
                    await markPrescriptionAsPaid(result.prescription_id || prescriptionId);
                    
                    // 显示代煎服务信息
                    setTimeout(() => {
                        showDecorationInfo(result.prescription_id || prescriptionId);
                    }, 2000);
                } else {
                    console.error('❌ 支付宝支付测试失败:', result);
                    showMessage(result.message || result.error?.message || '测试支付失败', 'error');
                }
                
            } catch (error) {
                console.error('测试支付宝支付失败:', error);
                showMessage('测试支付服务暂时不可用', 'error');
            }
        }

        // 微信支付
        async function payWithWechat(prescriptionId, amount) {
            try {
                const response = await fetch('/api/payment/wechat/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        prescription_id: prescriptionId,
                        amount: amount,
                        payment_method: 'wechat'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 显示微信支付二维码
                    hidePaymentModal();
                    showWechatQRCode(result.data.qr_code, result.data.payment_id);
                } else {
                    showMessage(result.message || '支付创建失败', 'error');
                }
                
            } catch (error) {
                console.error('微信支付失败:', error);
                showMessage('支付服务暂时不可用', 'error');
            }
        }

        // 显示微信支付二维码
        function showWechatQRCode(qrCode, paymentId) {
            let modal = document.getElementById('wechatQRModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'wechatQRModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1003;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 32px; text-align: center; max-width: 350px;">
                        <h3 style="margin: 0 0 20px 0; color: #07c160;">💚 微信支付</h3>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 100px;">📱</div>
                            <div style="margin-top: 12px; color: #666; font-size: 14px;">请使用微信扫描二维码支付</div>
                        </div>
                        <div style="color: #666; font-size: 12px; margin-bottom: 20px;">
                            支付完成后页面将自动更新
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="testWechatPaymentSuccess('${paymentId}')" 
                                    style="padding: 8px 16px; background: #07c160; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                ✅ 测试支付成功
                            </button>
                            <button onclick="hideWechatQRModal()" 
                                    style="padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                取消支付
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // 显示模态框并开始轮询支付状态
            modal.style.display = 'flex';
            pollPaymentStatus(paymentId);
        }

        // 隐藏微信支付二维码
        function hideWechatQRModal() {
            const modal = document.getElementById('wechatQRModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 轮询支付状态
        async function pollPaymentStatus(paymentId) {
            const maxAttempts = 60; // 最多轮询60次 (5分钟)
            let attempts = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/payment/status/${paymentId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        if (result.data.status === 'paid') {
                            // 支付成功
                            hideWechatQRModal();
                            hidePaymentModal();
                            showMessage('支付成功！您的处方已确认', 'success');
                            
                            // 🔑 关键修复：更新UI中的处方状态为已支付
                            await markPrescriptionAsPaid(result.data.prescription_id);
                            
                            // 显示代煎服务信息
                            setTimeout(() => {
                                showDecorationInfo(result.data.prescription_id);
                            }, 2000);
                            
                            return;
                        } else if (result.data.status === 'failed' || result.data.status === 'cancelled') {
                            // 支付失败
                            hideWechatQRModal();
                            hidePaymentModal();
                            showMessage('支付失败，请重试', 'error');
                            return;
                        }
                    }
                    
                    // 继续轮询
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000); // 5秒后再次轮询
                    } else {
                        // 超时
                        hideWechatQRModal();
                        hidePaymentModal();
                        showMessage('支付超时，请重试', 'error');
                    }
                    
                } catch (error) {
                    console.error('支付状态查询失败:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    }
                }
            };
            
            // 开始轮询
            poll();
        }

        // 测试微信支付成功
        async function testWechatPaymentSuccess(paymentId) {
            try {
                // 检查登录状态 (调试信息)
                console.log('🔄 用户登录状态 - Token:', !!userToken, 'User:', !!currentUser);
                
                // 从paymentId中提取order_no (paymentId实际上就是order_no)
                const encodedOrderNo = encodeURIComponent(paymentId);
                console.log('🔄 测试微信支付成功，order_no:', paymentId);
                
                const response = await fetch(`/api/payment/wechat/test-success?order_no=${encodedOrderNo}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                console.log('🔄 微信支付API响应状态:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ 微信支付API错误响应:', errorText);
                    showMessage(`支付API错误: ${response.status}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('📋 微信支付API响应结果:', result);
                
                if (result.success) {
                    hideWechatQRModal();
                    hidePaymentModal();
                    showMessage('测试支付成功！您的处方已解锁', 'success');
                    
                    // 更新UI中的处方状态为已支付
                    await markPrescriptionAsPaid(result.prescription_id);
                    
                    // 显示代煎服务信息
                    setTimeout(() => {
                        showDecorationInfo(result.prescription_id);
                    }, 2000);
                } else {
                    console.error('❌ 微信支付测试失败:', result);
                    showMessage(result.message || result.error?.message || '测试支付失败', 'error');
                }
                
            } catch (error) {
                console.error('测试微信支付失败:', error);
                showMessage('测试支付服务暂时不可用', 'error');
            }
        }

        // 显示代煎服务信息
        function showDecorationInfo(prescriptionId) {
            showMessage('代煎服务已启动，我们将在24小时内联系您安排配送', 'success');
            
            // 可以在这里添加更多代煎服务的详细信息
            // 例如跳转到订单页面等
        }

        // ===================== 处方管理系统结束 =====================

        // ===================== 医疗安全保障系统 =====================
        
        // 检查消息中的医疗安全问题
        function checkMedicalSafety(content) {
            const warnings = [];
            
            // 防止undefined错误
            if (!content || typeof content !== 'string') {
                console.warn('checkMedicalSafety: 无效的内容参数', content);
                return warnings;
            }
            
            // 检查西药相关内容
            const westernMedicineKeywords = ['阿司匹林', '感冒灵', '抗生素', '青霉素', '头孢', '布洛芬', '对乙酰氨基酚'];
            for (const keyword of westernMedicineKeywords) {
                if (content.includes(keyword)) {
                    warnings.push({
                        type: 'western_medicine',
                        message: `检测到西药成分"${keyword}"，本系统仅提供中医诊疗建议`
                    });
                }
            }
            
            // 检查危险症状
            const dangerousSymptoms = ['胸痛', '呼吸困难', '意识模糊', '大出血', '高热不退', '剧烈腹痛'];
            for (const symptom of dangerousSymptoms) {
                if (content.includes(symptom)) {
                    warnings.push({
                        type: 'emergency',
                        message: `"${symptom}"可能为急症，建议立即就医`
                    });
                }
            }
            
            // 检查孕妇禁用药材
            const pregnancyForbidden = ['红花', '桃仁', '牛膝', '大黄', '芒硝', '附子', '肉桂'];
            if (content.includes('孕妇') || content.includes('怀孕')) {
                for (const herb of pregnancyForbidden) {
                    if (content.includes(herb)) {
                        warnings.push({
                            type: 'pregnancy_risk',
                            message: `"${herb}"孕妇禁用，请谨慎使用`
                        });
                    }
                }
            }
            
            return warnings;
        }

        // 显示医疗安全警告
        function showMedicalWarnings(warnings) {
            if (warnings.length === 0) return;
            
            const warningContainer = document.createElement('div');
            warningContainer.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                max-width: 300px;
                z-index: 10001;
                animation: slideInRight 0.3s ease-out;
            `;
            
            warnings.forEach((warning, index) => {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    font-size: 13px;
                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                `;
                
                warningDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span>⚠️</span>
                        <strong>医疗安全提醒</strong>
                    </div>
                    <div>${warning.message}</div>
                `;
                
                warningContainer.appendChild(warningDiv);
                
                // 自动移除警告
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.style.animation = 'slideOutRight 0.3s ease-out';
                        setTimeout(() => {
                            if (warningDiv.parentNode) {
                                warningDiv.parentNode.removeChild(warningDiv);
                            }
                        }, 300);
                    }
                }, 8000 + index * 1000); // 错开移除时间
            });
            
            document.body.appendChild(warningContainer);
            
            // 容器自清理
            setTimeout(() => {
                if (warningContainer.parentNode && warningContainer.children.length === 0) {
                    warningContainer.parentNode.removeChild(warningContainer);
                }
            }, 15000);
        }

        // 记录安全事件
        async function logSecurityEvent(eventType, content, details = {}) {
            try {
                const response = await fetch('/api/security/log-event', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        event_type: eventType,
                        content: content,
                        details: details,
                        user_id: currentUser ? currentUser.id : null,
                        conversation_id: currentConversationId,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('安全事件记录失败:', result.message);
                }
                
            } catch (error) {
                console.error('安全事件记录失败:', error);
            }
        }

        // 检查症状编造
        function detectSymptomFabrication(userInput, aiResponse) {
            // 防止undefined错误
            if (!userInput || typeof userInput !== 'string' || !aiResponse || typeof aiResponse !== 'string') {
                console.warn('detectSymptomFabrication: 无效的参数', {userInput, aiResponse});
                return;
            }
            
            // 检查AI是否添加了用户未提及的症状（智能检测）
            const userSymptoms = extractSymptomsFromText(userInput);
            const aiSymptoms = extractSymptomsFromText(aiResponse);
            
            // 使用智能关联性检查，过滤掉医学上合理的症状
            const fabricatedSymptoms = aiSymptoms.filter(symptom => 
                !isSymptomsRelated(userSymptoms, symptom)
            );
            
            // 只有当AI添加了明显不相关的症状时才报警
            if (fabricatedSymptoms.length > 0 && userSymptoms.length > 0) {
                // 计算编造症状的比例，避免误报
                const fabricationRatio = fabricatedSymptoms.length / aiSymptoms.length;
                
                // 只有当编造比例超过50%且用户明确描述了症状时才报警
                if (fabricationRatio > 0.5) {
                    logSecurityEvent('symptom_fabrication', aiResponse, {
                        user_symptoms: userSymptoms,
                        ai_symptoms: aiSymptoms,
                        fabricated: fabricatedSymptoms,
                        fabrication_ratio: fabricationRatio
                    });
                    
                    showMedicalWarnings([{
                        type: 'symptom_fabrication',
                        message: `AI可能添加了您未描述的症状，请核实: ${fabricatedSymptoms.join(', ')}`
                    }]);
                }
            }
        }

        // 增强版本的消息发送，添加安全检查
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            // 检查用户输入的安全性
            const userWarnings = checkMedicalSafety(message);
            if (userWarnings.length > 0) {
                showMedicalWarnings(userWarnings);
                // 记录安全事件
                userWarnings.forEach(warning => {
                    logSecurityEvent(warning.type, message, warning);
                });
            }
            
            // 调用原始发送函数
            return originalSendMessage.call(this);
        };

        // ===================== 医疗安全保障系统结束 =====================

        // ===================== 随访提醒系统 =====================
        
        // 页面加载时检查随访提醒
        document.addEventListener('DOMContentLoaded', function() {
            checkFollowUpReminders();
        });

        // 检查随访提醒
        async function checkFollowUpReminders() {
            if (!currentUser || !userToken) return;
            
            try {
                const response = await fetch('/api/follow-up/reminders', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    // 显示随访提醒
                    showFollowUpReminders(result.data);
                }
                
            } catch (error) {
                console.error('获取随访提醒失败:', error);
            }
        }

        // 显示随访提醒
        function showFollowUpReminders(reminders) {
            // 检查是否已显示过提醒
            const today = new Date().toDateString();
            const shownToday = localStorage.getItem(`followup_shown_${today}`);
            
            if (shownToday) return;
            
            const reminderContainer = document.createElement('div');
            reminderContainer.id = 'followUpContainer';
            reminderContainer.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                max-width: 350px;
                z-index: 10002;
                animation: slideInRight 0.3s ease-out;
            `;
            
            reminderContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px; padding: 16px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">🔔</span>
                            <strong style="font-size: 16px;">随访提醒</strong>
                        </div>
                        <button onclick="dismissFollowUpReminders()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px;">×</button>
                    </div>
                    
                    <div style="font-size: 14px; line-height: 1.5; margin-bottom: 12px;">
                        您有 <strong>${reminders.length}</strong> 条随访提醒
                    </div>
                    
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${reminders.slice(0, 3).map(reminder => `
                            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 8px; font-size: 13px;">
                                <div style="font-weight: 500; margin-bottom: 4px;">${reminder.title}</div>
                                <div style="opacity: 0.9;">${reminder.message}</div>
                                <div style="font-size: 11px; opacity: 0.8; margin-top: 6px;">
                                    ${new Date(reminder.scheduled_date).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="viewAllFollowUps()" style="flex: 1; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            查看全部
                        </button>
                        <button onclick="scheduleFollowUp()" style="flex: 1; background: white; border: none; color: #059669; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                            新建随访
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(reminderContainer);
            
            // 标记今天已显示
            localStorage.setItem(`followup_shown_${today}`, 'true');
            
            // 10秒后自动隐藏
            setTimeout(() => {
                dismissFollowUpReminders();
            }, 10000);
        }

        // 关闭随访提醒
        function dismissFollowUpReminders() {
            const container = document.getElementById('followUpContainer');
            if (container) {
                container.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }, 300);
            }
        }

        // 查看所有随访
        function viewAllFollowUps() {
            dismissFollowUpReminders();
            showFollowUpModal();
        }

        // 显示随访管理模态框
        async function showFollowUpModal() {
            try {
                const response = await fetch('/api/follow-up/list', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('获取随访记录失败', 'error');
                    return;
                }
                
                createFollowUpModal(result.data || []);
                
            } catch (error) {
                console.error('获取随访记录失败:', error);
                showMessage('服务暂时不可用', 'error');
            }
        }

        // 创建随访管理模态框
        function createFollowUpModal(followUps) {
            let modal = document.getElementById('followUpModal');
            if (modal) {
                modal.remove();
            }
            
            modal = document.createElement('div');
            modal.id = 'followUpModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1005;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 20px; font-weight: 600;">🔔 随访管理</h3>
                        <button onclick="hideFollowUpModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px;">
                                <button onclick="showActiveFollowUps()" id="activeFollowUpsBtn" style="padding: 8px 16px; border: 2px solid #10b981; background: #10b981; color: white; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    待随访
                                </button>
                                <button onclick="showCompletedFollowUps()" id="completedFollowUpsBtn" style="padding: 8px 16px; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    已完成
                                </button>
                            </div>
                            <button onclick="scheduleNewFollowUp()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                                + 新建随访
                            </button>
                        </div>
                        
                        <div id="followUpContainer">
                            ${followUps.length > 0 ? generateFollowUpHTML(followUps) : '<div style="text-align: center; color: #6b7280; padding: 40px;">暂无随访记录</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 生成随访记录HTML
        function generateFollowUpHTML(followUps) {
            return followUps.map(followUp => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px;">${followUp.title}</h4>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 13px;">随访时间: ${new Date(followUp.scheduled_date).toLocaleString()}</p>
                        </div>
                        <span style="padding: 4px 12px; background: ${followUp.status === 'completed' ? '#dcfce7' : followUp.status === 'overdue' ? '#fee2e2' : '#fef3c7'}; color: ${followUp.status === 'completed' ? '#166534' : followUp.status === 'overdue' ? '#dc2626' : '#92400e'}; border-radius: 12px; font-size: 12px;">
                            ${followUp.status === 'completed' ? '已完成' : followUp.status === 'overdue' ? '已逾期' : '待随访'}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 12px; font-size: 14px; color: #374151;">
                        ${followUp.message}
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        ${followUp.status === 'pending' ? `
                            <button onclick="completeFollowUp('${followUp.id}')" style="padding: 6px 12px; background: #dcfce7; border: 1px solid #10b981; border-radius: 6px; font-size: 12px; cursor: pointer; color: #059669;">
                                标记完成
                            </button>
                            <button onclick="postponeFollowUp('${followUp.id}')" style="padding: 6px 12px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; font-size: 12px; cursor: pointer; color: #d97706;">
                                延期随访
                            </button>
                        ` : ''}
                        <button onclick="viewFollowUpDetail('${followUp.id}')" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; color: #374151;">
                            查看详情
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 隐藏随访模态框
        function hideFollowUpModal() {
            const modal = document.getElementById('followUpModal');
            if (modal) {
                modal.remove();
            }
        }

        // 新建随访
        function scheduleFollowUp() {
            dismissFollowUpReminders();
            scheduleNewFollowUp();
        }

        // 安排新随访
        function scheduleNewFollowUp() {
            // 简化版新建随访对话框
            const title = prompt('请输入随访标题:', '药物疗效跟踪');
            if (!title) return;
            
            const days = prompt('几天后随访? (输入天数)', '7');
            if (!days || isNaN(days)) return;
            
            const message = prompt('随访提醒内容:', '请问用药后症状是否有所改善？是否有不适反应？');
            if (!message) return;
            
            createFollowUpReminder(title, parseInt(days), message);
        }

        // 创建随访提醒
        async function createFollowUpReminder(title, days, message) {
            try {
                const response = await fetch('/api/follow-up/create', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        title: title,
                        message: message,
                        days_after: days,
                        doctor_id: selectedDoctor,
                        related_consultation_id: currentConversationId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`随访提醒已设置，将在${days}天后提醒`, 'success');
                    // 如果随访模态框打开，刷新内容
                    const modal = document.getElementById('followUpModal');
                    if (modal) {
                        showFollowUpModal(); // 重新加载
                    }
                } else {
                    showMessage(result.message || '设置随访提醒失败', 'error');
                }
                
            } catch (error) {
                console.error('创建随访提醒失败:', error);
                showMessage('服务暂时不可用', 'error');
            }
        }

        // 完成随访
        async function completeFollowUp(followUpId) {
            try {
                const response = await fetch(`/api/follow-up/${followUpId}/complete`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('随访已标记完成', 'success');
                    showFollowUpModal(); // 刷新列表
                } else {
                    showMessage(result.message || '操作失败', 'error');
                }
                
            } catch (error) {
                console.error('完成随访失败:', error);
                showMessage('服务暂时不可用', 'error');
            }
        }

        // 延期随访
        async function postponeFollowUp(followUpId) {
            const days = prompt('延期几天?', '3');
            if (!days || isNaN(days)) return;
            
            try {
                const response = await fetch(`/api/follow-up/${followUpId}/postpone`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        postpone_days: parseInt(days)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`随访已延期${days}天`, 'success');
                    showFollowUpModal(); // 刷新列表
                } else {
                    showMessage(result.message || '延期失败', 'error');
                }
                
            } catch (error) {
                console.error('延期随访失败:', error);
                showMessage('服务暂时不可用', 'error');
            }
        }

        // 查看随访详情
        function viewFollowUpDetail(followUpId) {
            showMessage('随访详情功能开发中...', 'info');
        }

        // 显示待随访
        async function showActiveFollowUps() {
            updateFollowUpFilter('active');
            const response = await fetch('/api/follow-up/list?status=pending', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateFollowUpContainer(result.data || []);
        }

        // 显示已完成随访
        async function showCompletedFollowUps() {
            updateFollowUpFilter('completed');
            const response = await fetch('/api/follow-up/list?status=completed', {
                headers: getAuthHeaders()
            });
            const result = await response.json();
            updateFollowUpContainer(result.data || []);
        }

        // 更新随访过滤器样式
        function updateFollowUpFilter(type) {
            const buttons = ['activeFollowUpsBtn', 'completedFollowUpsBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((type === 'active' && btnId === 'activeFollowUpsBtn') ||
                        (type === 'completed' && btnId === 'completedFollowUpsBtn')) {
                        btn.style.background = '#10b981';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#10b981';
                    }
                }
            });
        }

        // 更新随访容器
        function updateFollowUpContainer(followUps) {
            const container = document.getElementById('followUpContainer');
            if (container) {
                container.innerHTML = followUps.length > 0 ? generateFollowUpHTML(followUps) : '<div style="text-align: center; color: #6b7280; padding: 40px;">暂无相关记录</div>';
            }
        }

        // ===================== 随访提醒系统结束 =====================

        // ===================== 多设备会话同步系统 =====================
        
        let syncInterval = null;
        let lastSyncTime = 0;
        let isInitialSync = true;
        
        // 页面加载时启动同步
        document.addEventListener('DOMContentLoaded', function() {
            if (currentUser && userToken) {
                startSessionSync();
            }
        });

        // 启动会话同步
        function startSessionSync() {
            if (!currentUser || !userToken) return;
            
            // 首次同步
            syncSessionFromServer();
            
            // 设置定期同步 (每30秒)
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(() => {
                syncSessionFromServer();
            }, 30000); // 30秒同步一次
            
            // 页面可见性变化时同步
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && currentUser) {
                    syncSessionFromServer();
                }
            });
        }

        // 停止会话同步
        function stopSessionSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // 从服务器同步会话状态 - 暂时禁用，API不存在
        async function syncSessionFromServer() {
            // 暂时禁用多设备同步功能
            // TODO: 实现 /api/session/sync 接口后启用
            return;
            
            try {
                const response = await fetch('/api/session/sync', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        doctor_id: selectedDoctor,
                        last_sync_time: lastSyncTime,
                        device_info: getDeviceInfo()
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    handleSyncData(result.data);
                    lastSyncTime = Date.now();
                }
                
            } catch (error) {
                console.error('会话同步失败:', error);
            }
        }

        // 处理同步数据
        function handleSyncData(syncData) {
            // 检查是否有新消息
            if (syncData.new_messages && syncData.new_messages.length > 0) {
                syncData.new_messages.forEach(message => {
                    if (isInitialSync) return; // 首次同步不显示通知
                    
                    // 添加同步的消息到界面
                    addSyncedMessage(message);
                });
                
                // 显示同步通知
                if (!isInitialSync && syncData.new_messages.length > 0) {
                    showSyncNotification(`同步了${syncData.new_messages.length}条新消息`);
                }
            }
            
            // 同步医生选择
            if (syncData.selected_doctor && syncData.selected_doctor !== selectedDoctor) {
                if (!isInitialSync) {
                    showSyncNotification(`已切换到${getDoctorName(syncData.selected_doctor)}`);
                }
                selectedDoctor = syncData.selected_doctor;
                updateDoctorSelection();
            }
            
            // 同步对话ID
            if (syncData.conversation_id && syncData.conversation_id !== currentConversationId) {
                currentConversationId = syncData.conversation_id;
                const userId = getCurrentUserId();
                const storageKey = `conversationId_${userId}`;
                localStorage.setItem(storageKey, currentConversationId);
            }
            
            isInitialSync = false;
        }

        // 添加同步的消息
        function addSyncedMessage(message) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            // 检查消息是否已存在
            const existingMessages = container.querySelectorAll('.message');
            const messageExists = Array.from(existingMessages).some(msgEl => {
                const timeEl = msgEl.querySelector('.message-time');
                const textEl = msgEl.querySelector('.message-text');
                return timeEl && textEl && 
                       timeEl.textContent === message.time && 
                       textEl.textContent.trim() === message.content.trim();
            });
            
            if (!messageExists) {
                addMessageWithTime(message.sender, message.content, message.time, message.show_feedback);
            }
        }

        // 获取设备信息
        function getDeviceInfo() {
            return {
                user_agent: navigator.userAgent,
                screen_resolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                device_type: window.innerWidth <= 768 ? 'mobile' : 'desktop'
            };
        }

        // 获取医生名称
        function getDoctorName(doctorId) {
            return doctors[doctorId] ? doctors[doctorId].name : '医生';
        }

        // 显示同步通知
        function showSyncNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 13px;
                z-index: 10003;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                animation: syncNotification 3s ease-out forwards;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 12px;">🔄</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // 同步当前状态到服务器
        async function syncSessionToServer() {
            if (!currentUser || !userToken) return;
            
            try {
                // 获取当前所有消息
                const messages = [];
                const container = document.getElementById('messagesContainer');
                if (container) {
                    container.querySelectorAll('.message').forEach(messageEl => {
                        const isUser = messageEl.classList.contains('user');
                        const textEl = messageEl.querySelector('.message-text');
                        const timeEl = messageEl.querySelector('.message-time');
                        
                        if (textEl && timeEl) {
                            messages.push({
                                sender: isUser ? 'user' : 'ai',
                                content: textEl.textContent.trim(),
                                time: timeEl.textContent,
                                timestamp: Date.now()
                            });
                        }
                    });
                }
                
                // 🔑 修复：匹配API期望的参数格式
                const userId = getCurrentUserId();
                const response = await fetch('/api/session/update', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        user_id: userId,
                        session_data: {
                            conversation_id: currentConversationId,
                            doctor_id: selectedDoctor,
                            messages: messages,
                            device_info: getDeviceInfo(),
                            sync_time: Date.now()
                        }
                    })
                });
                
                // 检查响应状态
                if (response.status === 404) {
                    console.log('🔄 会话同步功能暂未启用 (404)');
                    return; // 优雅处理404，不报错
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (!result.success) {
                    console.error('会话状态上传失败:', result.message);
                }
                
            } catch (error) {
                console.error('会话状态上传失败:', error);
            }
        }

        // 增强医生选择，添加同步功能
        const originalSelectDoctor = selectDoctor;
        selectDoctor = function(doctorId) {
            originalSelectDoctor.call(this, doctorId);
            
            // 同步医生选择到服务器
            if (currentUser && userToken) {
                syncSessionToServer();
            }
        };

        // 增强消息发送，添加同步功能
        const originalAddMessage = addMessage;
        const originalAddMobileMessage = addMobileMessage;
        
        addMessage = function(sender, content, showFeedback = false) {
            originalAddMessage.call(this, sender, content, showFeedback);
            
            // 🔑 修复：只对用户消息和AI回复进行同步，跳过欢迎消息
            if (currentUser && userToken && !content.includes('请详细描述您的症状')) {
                setTimeout(() => {
                    syncSessionToServer();
                }, 500); // 延迟500ms确保DOM更新完成
            }
        };
        
        addMobileMessage = function(sender, content, showFeedback = false, isPaid = false, prescriptionId = null) {
            originalAddMobileMessage.call(this, sender, content, showFeedback, isPaid, prescriptionId);
            
            // 🔑 修复：只对用户消息和AI回复进行同步，跳过欢迎消息
            if (currentUser && userToken && !content.includes('请详细描述您的症状')) {
                setTimeout(() => {
                    syncSessionToServer();
                }, 500);
            }
        };

        // 登录时启动同步
        const originalUpdateUserInterface = updateUserInterface;
        updateUserInterface = function(isLoggedIn) {
            originalUpdateUserInterface.call(this, isLoggedIn);
            
            if (isLoggedIn && currentUser) {
                startSessionSync();
            } else {
                stopSessionSync();
            }
        };

        // 🔑 更新问诊状态
        async function updateConsultationStatus(status, prescriptionId = null) {
            if (!currentUser || !userToken) return;
            
            try {
                const userId = getCurrentUserId();
                const payload = {
                    patient_id: userId,
                    status: status,
                    prescription_id: prescriptionId,
                    conversation_log: JSON.stringify(getAllMessages()),
                    symptoms_analysis: JSON.stringify(extractConversationSummary()),
                    updated_at: new Date().toISOString()
                };
                
                console.log('更新问诊状态:', payload);
                
                const response = await fetch('/api/consultation/update-status', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('问诊状态更新成功:', result);
                } else {
                    console.error('问诊状态更新失败:', response.status);
                }
                
            } catch (error) {
                console.error('更新问诊状态失败:', error);
            }
        }
        
        // 🔑 获取所有消息用于保存完整对话历史
        function getAllMessages() {
            const messages = [];
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.querySelectorAll('.message').forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    
                    if (textEl) {
                        messages.push({
                            sender: isUser ? 'user' : 'ai',
                            content: textEl.textContent.trim(),
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: Date.now()
                        });
                    }
                });
            }
            return messages;
        }

        // 页面卸载时停止同步
        window.addEventListener('beforeunload', function() {
            stopSessionSync();
            // 最后一次同步
            if (currentUser && userToken) {
                syncSessionToServer();
            }
        });

        // 添加CSS动画
        const syncAnimationCSS = `
            @keyframes syncNotification {
                0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                10% { opacity: 1; transform: translateX(-50%) translateY(0); }
                90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            }
        `;
        
        // 添加样式到页面
        const styleSheet = document.createElement('style');
        styleSheet.textContent = syncAnimationCSS;
        document.head.appendChild(styleSheet);

        // 显示同步状态指示器
        function createSyncIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'syncIndicator';
            indicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #10b981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
                z-index: 10004;
                animation: pulse 2s infinite;
                display: none;
            `;
            
            // 添加脉冲动画
            const pulseCSS = `
                @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                    70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
                }
            `;
            
            if (!document.getElementById('pulseStyle')) {
                const pulseStyle = document.createElement('style');
                pulseStyle.id = 'pulseStyle';
                pulseStyle.textContent = pulseCSS;
                document.head.appendChild(pulseStyle);
            }
            
            document.body.appendChild(indicator);
            
            // 鼠标悬停显示提示
            indicator.title = '多设备同步已启用';
            
            return indicator;
        }

        // 显示/隐藏同步指示器
        function showSyncIndicator() {
            let indicator = document.getElementById('syncIndicator');
            if (!indicator) {
                indicator = createSyncIndicator();
            }
            indicator.style.display = 'block';
        }

        function hideSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // 在用户登录时显示同步指示器
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (currentUser && userToken) {
                    showSyncIndicator();
                }
            }, 1000);
        });

        // ===================== 多设备会话同步系统结束 =====================

        // 🔍 调试用户ID和历史记录
        function debugUserIdAndHistory() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const currentUserId = getCurrentUserId();
            
            console.log('=== 用户ID调试信息 ===');
            console.log('currentUser对象:', currentUser);
            console.log('currentUser.id:', currentUser.id);
            console.log('currentUser.user_id:', currentUser.user_id);
            console.log('userData对象:', userData);
            console.log('userData.id:', userData.id);
            console.log('userData.user_id:', userData.user_id);
            console.log('getCurrentUserId()返回值:', currentUserId);
            
            const keys = Object.keys(localStorage);
            const allHistoryKeys = keys.filter(key => key.startsWith('tcm_doctor_history_'));
            const userHistoryKeys = keys.filter(key => key.startsWith(`tcm_doctor_history_${currentUserId}_`));
            
            console.log('=== 历史记录调试信息 ===');
            console.log('所有历史记录键名:', allHistoryKeys);
            console.log('当前用户历史记录键名:', userHistoryKeys);
            console.log('历史记录总数:', allHistoryKeys.length);
            console.log('当前用户历史记录数:', userHistoryKeys.length);
            
            // 检查是否有maoxiaohua相关的记录
            const maoxiaohuaKeys = keys.filter(key => key.includes('maoxiaohua') || key.includes('02f16099'));
            console.log('maoxiaohua相关键名:', maoxiaohuaKeys);
        }

        // 历史记录管理系统
        function saveCurrentDoctorHistory() {
            if (!selectedDoctor) return;
            
            try {
                const messages = [];
                
                // 检测当前是移动端还是PC端
                const isMobile = window.innerWidth <= 768;
                const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
                const messagesContainer = document.getElementById(containerSelector);
                
                if (!messagesContainer) {
                    console.warn('未找到消息容器，跳过保存');
                    return;
                }
                
                // 提取所有消息
                messagesContainer.querySelectorAll('.message').forEach(messageEl => {
                    const isUser = messageEl.classList.contains('user');
                    const textEl = messageEl.querySelector('.message-text');
                    const timeEl = messageEl.querySelector('.message-time');
                    
                    if (textEl && textEl.innerHTML.trim()) {
                        const messageData = {
                            type: isUser ? 'user' : 'ai',
                            content: textEl.innerHTML,
                            time: timeEl ? timeEl.textContent : new Date().toLocaleTimeString(),
                            timestamp: Date.now()
                        };
                        
                        // 如果是AI消息且包含处方，保存处方状态
                        if (!isUser) {
                            const prescriptionId = messageEl.getAttribute('data-prescription-id');
                            const isPaid = messageEl.querySelector('.prescription-paid') !== null;
                            const hasActions = messageEl.querySelector('.prescription-actions') !== null;
                            
                            if (prescriptionId || isPaid || hasActions) {
                                messageData.prescriptionData = {
                                    prescriptionId: prescriptionId,
                                    isPaid: isPaid,
                                    hasActions: hasActions
                                };
                                
                                // 🔧 关键修复：如果处方已支付，尝试获取并保存原始完整内容
                                if (isPaid) {
                                    const originalContent = messageEl.getAttribute('data-original-content');
                                    if (originalContent) {
                                        messageData.originalContent = originalContent;
                                        console.log('💾 保存了已支付处方的原始内容');
                                    }
                                }
                            }
                        }
                        
                        messages.push(messageData);
                    }
                });
                
                // 如果没有消息则不保存
                if (messages.length === 0) {
                    console.log('没有消息需要保存');
                    return;
                }
                
                // 限制历史记录数量（防止localStorage溢出）
                const maxMessages = 50; // 最多保存50条消息
                const trimmedMessages = messages.slice(-maxMessages);
                
                // 保存到localStorage
                const userId = getCurrentUserId();
                const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                const dataToSave = JSON.stringify({
                    messages: trimmedMessages,
                    lastUpdated: new Date().toISOString(),
                    doctor: selectedDoctor,
                    version: '2.1', // 增强版本号
                    saveCount: (JSON.parse(localStorage.getItem(historyKey) || '{}').saveCount || 0) + 1
                });
                
                // 验证localStorage可用性
                if (typeof(Storage) === "undefined") {
                    console.error('浏览器不支持localStorage');
                    return;
                }
                
                localStorage.setItem(historyKey, dataToSave);
                console.log(`✅ 已保存${selectedDoctor}医生的${trimmedMessages.length}条对话记录 (第${JSON.parse(dataToSave).saveCount}次保存)`);
                
                // 立即验证保存是否成功
                const savedData = localStorage.getItem(historyKey);
                if (!savedData) {
                    console.error('❌ 保存验证失败，数据未正确存储');
                    // 尝试重新保存
                    setTimeout(() => {
                        localStorage.setItem(historyKey, dataToSave);
                        console.log('🔄 重试保存完成');
                    }, 100);
                } else {
                    console.log('✅ 保存验证成功');
                }
                
                // 检查localStorage使用情况
                checkLocalStorageUsage();
                
                // 🚀 新增：自动保存到服务器数据库
                saveConversationToServer(trimmedMessages, selectedDoctor);
                
            } catch (error) {
                console.error('❌ 保存历史记录失败:', error);
                // 如果是存储空间不足，尝试清理旧记录
                if (error.name === 'QuotaExceededError') {
                    cleanOldHistoryRecords();
                    // 重试保存（只保存最近的消息）
                    try {
                        const recentMessages = messages.slice(-20);
                        const userId = getCurrentUserId();
                        const historyKey = `tcm_doctor_history_${userId}_${selectedDoctor}`;
                        localStorage.setItem(historyKey, JSON.stringify({
                            messages: recentMessages,
                            lastUpdated: new Date().toISOString(),
                            doctor: selectedDoctor,
                            version: '2.0'
                        }));
                        console.log(`空间不足，已保存最近${recentMessages.length}条记录`);
                    } catch (retryError) {
                        console.error('重试保存也失败:', retryError);
                    }
                }
            }
        }
        
        // 🆕 从服务器加载特定医生的历史记录
        async function loadDoctorHistoryFromServer(doctorKey, userId) {
            try {
                console.log(`🌐 从服务器加载${doctorKey}医生的历史记录...`);
                
                // 🔑 修复：添加超时控制，避免长时间等待
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch(`/api/conversation/history/${userId}?doctor_id=${doctorKey}`, {
                    headers: getAuthHeaders(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.warn(`❌ 服务器请求失败: ${response.status}`);
                    return false;
                }
                
                const result = await response.json();
                console.log('📋 医生历史记录响应:', result);
                
                if (result.success && result.data && result.data.messages) {
                    const messages = result.data.messages;
                    
                    if (messages.length > 0) {
                        console.log(`📥 恢复${doctorKey}医生的 ${messages.length} 条消息`);
                        
                        // 清空当前消息
                        clearAllMessages();
                        
                        // 逐条恢复消息
                        await processServerMessages(messages);
                        
                        showSyncNotification(`✅ 已从云端恢复与${doctorKey}医生的对话`, 'server_restored');
                        return true;
                    } else {
                        // 🔑 修复：服务器返回空数据时的处理
                        console.log(`📭 ${doctorKey}医生暂无历史对话记录`);
                        return true; // 返回true表示服务器响应正常，只是没有数据
                    }
                }
                
                return false;
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn(`⏰ 加载${doctorKey}医生历史超时，切换到本地模式`);
                } else {
                    console.error(`❌ 从服务器加载${doctorKey}医生历史失败:`, error);
                }
                return false;
            }
        }

        async function loadDoctorHistory(doctorKey) {
            const userId = getCurrentUserId();
            
            // 🔑 修复：对于临时用户或设备用户，直接使用本地模式
            if (userId.startsWith('temp_user_') || userId.startsWith('device_')) {
                console.log(`📱 临时用户(${userId})，直接使用本地模式加载${doctorKey}医生历史`);
            } else {
                // 🔧 修复：优先从服务器加载特定医生的历史
                const serverLoaded = await loadDoctorHistoryFromServer(doctorKey, userId);
                
                if (serverLoaded) {
                    console.log(`✅ 从服务器成功加载${doctorKey}医生的历史记录`);
                    return;
                }
                
                console.log(`⚠️ 服务器加载失败，降级到本地模式加载${doctorKey}医生历史`);
            }
            
            // 检测当前是移动端还是PC端
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            if (!messagesContainer) return;
            
            // 🔑 修复：检查是否需要清空消息容器，加强新对话检测
            const currentMessages = messagesContainer.querySelectorAll('.message');
            const currentDoctorAttr = messagesContainer.getAttribute('data-current-doctor');
            const isNewConversation = !currentConversationId || currentConversationId.length === 0;
            
            const shouldClearMessages = currentMessages.length === 0 || 
                                       !currentDoctorAttr ||
                                       currentDoctorAttr !== doctorKey ||
                                       isNewConversation; // 新增：如果是新对话，强制清空
            
            if (shouldClearMessages) {
                // 清空当前消息（切换医生、没有消息、或新对话时）
                messagesContainer.innerHTML = '';
                console.log(`🧹 清空消息容器，准备加载${doctorKey}医生的历史记录（isNewConversation: ${isNewConversation}）`);
            } else {
                console.log(`⚡ 保持当前${doctorKey}医生的消息，跳过重新加载`);
                // 如果是同一个医生且有消息，直接返回，不重新加载
                messagesContainer.setAttribute('data-current-doctor', doctorKey);
                return;
            }
            
            // 标记当前医生
            messagesContainer.setAttribute('data-current-doctor', doctorKey);
            
            // 移动端需要重置样式
            if (isMobile) {
                messagesContainer.style.display = 'block';
                messagesContainer.style.alignItems = 'flex-start';
                messagesContainer.style.justifyContent = 'flex-start';
            }

            // 🔑 关键修复：智能加载策略 - 优先使用本地数据，避免云端空数据覆盖
            let messages = [];
            let loadedFromServer = false;
            let loadedFromLocal = false;
            
            // 1. 首先检查localStorage是否有数据
            const historyKey = `tcm_doctor_history_${userId}_${doctorKey}`;
            const storedHistory = localStorage.getItem(historyKey);
            
            if (storedHistory) {
                try {
                    const historyData = JSON.parse(storedHistory);
                    if (historyData.messages && historyData.messages.length > 0) {
                        messages = historyData.messages;
                        loadedFromLocal = true;
                        console.log(`📱 从localStorage加载${doctorKey}医生的${messages.length}条对话历史`);
                        console.log(`🔍 调试: 本地消息=`, messages);
                        
                        // 🔑 修复：更友好的本地恢复提示
                        const doctorName = getDoctorDisplayName(doctorKey) || doctorKey;
                        showSyncNotification(`📱 已从本地恢复与${doctorName}的对话记录`, 'local_fallback');
                    }
                } catch (error) {
                    console.warn('解析本地历史记录失败:', error);
                }
            }
            
            // 2. 如果本地没有数据，再尝试从服务器加载
            if (!loadedFromLocal && !userId.startsWith('temp_user_') && !userId.startsWith('device_')) {
                try {
                    console.log(`🌐 本地无数据，从服务器加载${doctorKey}医生的对话历史...`);
                    console.log(`🔍 调试: 用户ID=${userId}, 医生ID=${doctorKey}`);
                    const apiUrl = `/api/conversation/history/${userId}?doctor_id=${doctorKey}`;
                    console.log(`🔍 调试: API URL=${apiUrl}`);
                    
                    const response = await fetch(apiUrl);
                    console.log(`🔍 调试: 响应状态=${response.status}, OK=${response.ok}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`🔍 调试: API响应=`, result);
                        
                        if (result.success && result.data && result.data.messages && result.data.messages.length > 0) {
                            messages = result.data.messages;
                            loadedFromServer = true;
                            console.log(`✅ 从服务器加载${doctorKey}医生的${messages.length}条对话历史`);
                            console.log(`🔍 调试: 加载的消息=`, messages);
                            showSyncNotification('✅ 已从云端同步对话历史', 'server_restored');
                        } else {
                            console.warn(`⚠️ 服务器返回空数据或格式不正确:`, result);
                        }
                    } else {
                        console.error(`❌ API调用失败: ${response.status} ${response.statusText}`);
                        const errorText = await response.text();
                        console.error(`❌ 错误详情: ${errorText}`);
                    }
                } catch (error) {
                    console.warn('服务器加载对话历史失败:', error);
                }
            } else if (loadedFromLocal) {
                console.log(`📱 已从本地加载数据，跳过服务器查询`);
            } else {
                console.log(`⚠️ 跳过服务器加载，临时用户ID: ${userId}`);
            }
            
            // 3. 最终检查：如果还是没有数据，则无历史记录
            if (!loadedFromLocal && !loadedFromServer) {
                const historyKey = `tcm_doctor_history_${userId}_${doctorKey}`;
                const storedHistory = localStorage.getItem(historyKey);
                
                if (storedHistory) {
                    try {
                        let historyData = JSON.parse(storedHistory);
                        
                        // 兼容旧格式和新格式
                        if (Array.isArray(historyData)) {
                            messages = historyData;
                            console.log(`📱 从本地加载${doctorKey}医生的${messages.length}条历史记录（旧格式）`);
                        } else if (historyData.messages && Array.isArray(historyData.messages)) {
                            messages = historyData.messages;
                            console.log(`📱 从本地加载${doctorKey}医生的${messages.length}条历史记录（${historyData.version || '1.0'}版本）`);
                        }
                        
                        if (messages.length > 0) {
                            showSyncNotification('📭 暂无历史对话，开始新的问诊', 'info');
                        }
                    } catch (error) {
                        console.error('本地历史记录解析失败:', error);
                    }
                }
            }
            
            // 3. 渲染加载的对话历史
            if (messages.length > 0) {
                // 恢复历史消息
                messages.forEach(msg => {
                    // 对于AI消息，检测是否包含处方以决定是否显示评价系统
                    const shouldShowFeedback = msg.type === 'ai' && containsPrescription(msg.content);
                    
                    // 检查是否有处方数据
                    const prescriptionData = msg.prescriptionData;
                    const isPaid = prescriptionData ? prescriptionData.isPaid : false;
                    const prescriptionId = prescriptionData ? prescriptionData.prescriptionId : null;
                    
                    // 🔧 修复：对于已支付的处方，确保显示完整格式化内容而不是预览版本
                    let displayContent = msg.content;
                    if (isPaid && prescriptionData && msg.type === 'ai' && containsPrescription(msg.content)) {
                        console.log('🔄 恢复已支付处方的完整格式，处方ID:', prescriptionId);
                        // 清理可能存在的预览限制标记
                        displayContent = msg.content
                            .replace(/\*\*\*/g, '15')
                            .replace(/解锁查看/g, '')
                            .replace(/\+ \d+ 味药材/g, '')
                            .replace(/方剂组成预览/g, '完整方剂组成')
                            .replace(/预览/g, '完整');
                    }
                    
                    if (isMobile) {
                        addMobileMessage(msg.type, displayContent, shouldShowFeedback, isPaid, prescriptionId);
                    } else {
                        addMessageWithTime(msg.type, displayContent, msg.time, shouldShowFeedback, isPaid, prescriptionId);
                    }
                });
                
                // 如果有历史记录，显示详细信息
                console.log(`历史记录详情: 共${messages.length}条消息，第一条=${messages[0].time || '未知时间'}, 最后一条=${messages[messages.length-1].time || '未知时间'}`);
                
                // 🔄 如果从本地加载成功，异步同步到服务器
                if (loadedFromLocal && !userId.startsWith('temp_user_') && !userId.startsWith('device_')) {
                    setTimeout(() => {
                        console.log(`🔄 将本地数据同步到服务器...`);
                        syncLocalHistoryToServer(userId, doctorKey, messages);
                    }, 2000); // 延迟2秒，确保页面渲染完成
                }
            } else {
                // 没有历史记录，显示欢迎消息
                console.log(`${doctorKey}医生没有历史记录，显示欢迎消息`);
                addWelcomeMessage(doctorKey);
            }
        }

        // 🌐 同步本地历史记录到服务器
        async function syncLocalHistoryToServer(userId, doctorKey, messages) {
            try {
                console.log(`🔄 将${doctorKey}医生的${messages.length}条本地消息同步到服务器...`);
                
                const response = await fetch('/api/conversation/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        doctor_id: doctorKey,
                        state_data: {
                            messages: messages,
                            sync_type: 'history_upload',
                            currentState: 'active',
                            conversationData: {
                                messageCount: messages.length,
                                lastActivity: new Date().toISOString()
                            }
                        },
                        device_info: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log(`✅ ${doctorKey}医生的对话历史已同步到服务器`);
                    }
                }
            } catch (error) {
                console.warn('同步历史记录到服务器失败:', error);
            }
        }

        // 🔔 显示同步状态通知
        function showSyncNotification(message, type = 'info') {
            const notification = document.createElement('div');
            
            // 根据类型设置不同的样式
            let bgColor, textColor, borderColor, icon;
            switch(type) {
                case 'server_restored':
                    bgColor = '#e8f5e8';
                    textColor = '#2e7d32';
                    borderColor = '#4caf50';
                    icon = '☁️';
                    break;
                case 'local_fallback':
                    bgColor = '#fff3e0';
                    textColor = '#f57c00';
                    borderColor = '#ff9800';
                    icon = '📱';
                    break;
                default:
                    bgColor = '#e3f2fd';
                    textColor = '#1976d2';
                    borderColor = '#2196f3';
                    icon = 'ℹ️';
            }
            
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${bgColor};
                color: ${textColor};
                padding: 12px 16px;
                border-radius: 8px;
                border-left: 4px solid ${borderColor};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1002;
                font-size: 14px;
                max-width: 250px;
                animation: slideInRight 0.3s ease;
            `;
            
            const icons = {
                'server_restored': '☁️',
                'local_restored': '📱',
                'sync_success': '✅'
            };
            
            notification.innerHTML = `${icon} ${message}`;
            document.body.appendChild(notification);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        function addWelcomeMessage(doctorKey) {
            const doctor = doctors[doctorKey];
            const isMobile = window.innerWidth <= 768;
            const containerSelector = isMobile ? 'mobileMessagesContainer' : 'messagesContainer';
            const messagesContainer = document.getElementById(containerSelector);
            
            // 🔧 修复重复欢迎消息问题：检查是否已经有消息存在
            if (messagesContainer && messagesContainer.children.length > 0) {
                console.log(`${doctor.name}医生的欢迎消息已存在，跳过重复添加`);
                return;
            }
            
            const welcomeMessage = `您好！我是${doctor.name}，${doctor.school}传人。请详细描述您的症状，我将为您进行专业的中医分析。`;
            console.log(`添加${doctor.name}医生的欢迎消息`);
            
            // 🔑 修复：使用原始函数而不是增强版本，避免触发数据保存
            if (isMobile) {
                originalAddMobileMessage('ai', welcomeMessage);
            } else {
                originalAddMessage('ai', welcomeMessage);
            }
        }
        
        function addMessageWithTime(sender, content, timeStr, showFeedback = false, isPaid = false, prescriptionId = null) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // 检测是否包含处方
            const containsPrescriptionContent = containsPrescription(content);
            
            // 如果有处方ID，保存到元素属性中
            if (prescriptionId) {
                messageDiv.setAttribute('data-prescription-id', prescriptionId);
            }
            
            // 🔧 修复重复支付按钮：主页面逻辑只处理已支付状态，未支付状态由prescription_renderer处理
            let prescriptionActionsHtml = '';
            if (sender === 'ai' && containsPrescriptionContent && isPaid) {
                // 只在已支付时显示代煎服务按钮
                prescriptionActionsHtml = `
                    <div class="prescription-paid" style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="font-size: 13px; color: #059669; margin-bottom: 8px;">
                            <strong>✅ 处方已解锁</strong> - 支付成功，您可以联系代煎服务
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="showDecorationInfo('${prescriptionId}')" 
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                                🍵 联系代煎服务
                            </button>
                        </div>
                    </div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? '👤' : (selectedDoctor ? doctors[selectedDoctor].avatar : '🤖')}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    <div class="message-time">${timeStr}</div>
                    ${prescriptionActionsHtml}
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">这个回答有帮助吗？</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">😊 很好</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">👍 不错</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">👌 还行</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">👎 不好</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">😞 很差</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // 加载对话历史 - 基于用户ID隔离并支持医疗记录管理
        // 🔧 修复：优先从服务器恢复数据，确保多端一致性
        async function loadConversationHistory() {
            const userId = getCurrentUserId();
            
            console.log('🔄 开始加载对话历史，用户ID:', userId);
            
            // 1. 优先尝试从服务器恢复数据
            const serverRestored = await loadConversationFromServer(userId);
            
            if (!serverRestored) {
                console.log('⚠️ 服务器恢复失败，降级到本地模式');
                
                // 2. 降级：从localStorage恢复对话ID
                const storageKey = `conversationId_${userId}`;
                const storedId = localStorage.getItem(storageKey);
                if (storedId) {
                    currentConversationId = storedId;
                    console.log(`📱 从本地存储加载对话ID: ${currentConversationId}`);
                } else {
                    generateConversationId();
                    console.log(`🆕 生成新对话ID: ${currentConversationId}`);
                }
                
                // 3. 加载本地历史记录
                loadAndDisplayAllConversations();
                
                // 4. 显示降级提示
                showSyncNotification('⚠️ 已从本地缓存恢复，建议检查网络连接', 'local_fallback');
            }
            
            // 5. 如果有选中的医生，加载该医生的历史记录
            if (selectedDoctor) {
                await loadDoctorHistoryFromServer(selectedDoctor, userId);
            }
        }
        
        // 🆕 从服务器加载对话历史
        async function loadConversationFromServer(userId) {
            try {
                console.log('🌐 尝试从服务器恢复对话历史...');
                
                const response = await fetch(`/api/conversation/history/${userId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    console.warn(`❌ 服务器请求失败: ${response.status}`);
                    return false;
                }
                
                const result = await response.json();
                console.log('📋 服务器响应:', result);
                
                if (result.success && result.data) {
                    const { messages, conversation_states, consultation_records } = result.data;
                    
                    // 显示成功提示
                    showSyncNotification(`✅ 已从云端恢复 ${messages?.length || 0} 条对话记录`, 'server_restored');
                    
                    // 处理对话状态
                    if (conversation_states && conversation_states.length > 0) {
                        const latestState = conversation_states[0];
                        currentConversationId = latestState.conversation_id;
                        console.log('🔄 恢复对话ID:', currentConversationId);
                    }
                    
                    // 处理消息历史 - 加载所有医生的消息
                    if (messages && messages.length > 0) {
                        console.log(`📥 恢复 ${messages.length} 条消息`);
                        await processServerMessages(messages);
                    }
                    
                    // 处理问诊记录
                    if (consultation_records && consultation_records.length > 0) {
                        console.log(`📋 恢复 ${consultation_records.length} 条问诊记录`);
                        await processConsultationRecords(consultation_records);
                    }
                    
                    return true;
                } else {
                    console.warn('❌ 服务器返回空数据');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ 从服务器恢复失败:', error);
                return false;
            }
        }
        
        // 🆕 处理服务器返回的消息
        async function processServerMessages(messages) {
            try {
                // 按时间排序消息
                messages.sort((a, b) => new Date(a.timestamp || a.time) - new Date(b.timestamp || b.time));
                
                // 清空当前显示的消息
                clearAllMessages();
                
                // 逐条恢复消息
                for (const message of messages) {
                    const messageType = message.type; // 'user' 或 'ai'
                    const content = message.content;
                    const prescriptionData = message.prescriptionData || null;
                    
                    // 确定是否包含处方且已支付
                    const isPaid = prescriptionData ? prescriptionData.isPaid : false;
                    const prescriptionId = prescriptionData ? prescriptionData.prescriptionId : null;
                    
                    if (messageType === 'user') {
                        // 恢复用户消息
                        await addMessage('user', content);
                    } else if (messageType === 'ai') {
                        // 恢复AI消息，包含处方状态
                        await addMessage('ai', content, false, isPaid, prescriptionId);
                        
                        // 🔑 关键修复：如果是已支付但等待审核的处方，更新显示状态
                        if (isPaid && prescriptionId) {
                            // 检查本地存储的处方状态
                            const localStatus = getPrescriptionStatusFromStorage(prescriptionId);
                            if (localStatus === 'pending_review') {
                                setTimeout(() => {
                                    updatePrescriptionToReviewStatus(prescriptionId);
                                    console.log('🔄 已恢复处方等待审核状态:', prescriptionId);
                                }, 100);
                            }
                        }
                    }
                    
                    // 添加小延迟以确保消息按顺序显示
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                console.log('✅ 消息恢复完成');
                
                // 🔑 移除额外的恢复调用，避免与统一恢复机制冲突
                // setTimeout(() => {
                //     restoreAllPendingPrescriptions();
                // }, 200);
                
            } catch (error) {
                console.error('❌ 处理服务器消息失败:', error);
            }
        }
        
        // 🆕 处理问诊记录
        async function processConsultationRecords(records) {
            try {
                // 这里可以更新历史记录显示
                console.log('📋 处理问诊记录:', records.length);
                
                // 如果有历史记录容器，更新显示
                const historyContainer = document.querySelector('.conversation-list');
                if (historyContainer && records.length > 0) {
                    // 可以在这里更新历史记录显示
                    console.log('📱 更新历史记录显示');
                }
                
            } catch (error) {
                console.error('❌ 处理问诊记录失败:', error);
            }
        }
        
        /**
         * 加载并显示所有历史对话记录
         */
        function loadAndDisplayAllConversations() {
            const userId = getCurrentUserId();
            const historyContainer = document.querySelector('.conversation-list');
            
            if (!historyContainer) {
                console.log('历史记录容器不存在，跳过加载');
                return;
            }
            
            try {
                let allConversations = [];
                
                // 遍历所有医生，收集历史记录
                Object.keys(doctors).forEach(doctorKey => {
                    const historyKey = `tcm_doctor_history_${userId}_${doctorKey}`;
                    const doctorHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
                    
                    doctorHistory.forEach(session => {
                        allConversations.push({
                            ...session,
                            doctorKey: doctorKey,
                            doctorInfo: doctors[doctorKey]
                        });
                    });
                });
                
                // 按时间排序（最新的在前面）
                allConversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // 生成HTML
                if (allConversations.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无问诊历史</div>';
                    return;
                }
                
                let historyHTML = '';
                allConversations.forEach(session => {
                    const sessionId = session.id || session.conversationId;
                    const isEvaluated = isSessionEvaluated(sessionId);
                    const shortId = sessionId ? sessionId.slice(-6) : '未知';
                    const timeStr = new Date(session.timestamp).toLocaleString('zh-CN');
                    
                    // 获取对话概要
                    let summary = '问诊记录';
                    if (session.conversation && session.conversation.length > 0) {
                        const firstUserMsg = session.conversation.find(msg => msg.type === 'user');
                        if (firstUserMsg && firstUserMsg.content) {
                            summary = firstUserMsg.content.substring(0, 30) + (firstUserMsg.content.length > 30 ? '...' : '');
                        }
                    }
                    
                    historyHTML += `
                        <div class="conversation-item" data-session-id="${sessionId}" onclick="showConversationDetails('${sessionId}', '${session.doctorKey}')" style="cursor: pointer;">
                            <div class="conversation-header">
                                <div class="doctor-info">
                                    <span class="doctor-avatar">${session.doctorInfo.avatar}</span>
                                    <div class="doctor-details">
                                        <div class="doctor-name">${session.doctorInfo.name}</div>
                                        <div class="session-time">${timeStr}</div>
                                    </div>
                                </div>
                                <div class="session-actions">
                                    <button class="session-details" onclick="event.stopPropagation(); showConversationDetails('${sessionId}', '${session.doctorKey}')" title="查看详情">📋</button>
                                    <button class="session-export" onclick="event.stopPropagation(); exportSession('${sessionId}')" title="导出医疗报告">📄</button>
                                    <button class="session-rate ${isEvaluated ? 'evaluated' : ''}" onclick="event.stopPropagation(); showEvaluationModal('${sessionId}')" title="${isEvaluated ? '已评价' : '评价问诊'}">
                                        ${isEvaluated ? '✅' : '⭐'}
                                    </button>
                                    <button class="session-delete" onclick="event.stopPropagation(); deleteSession('${sessionId}')" title="删除记录">🗑️</button>
                                </div>
                            </div>
                            <div class="conversation-summary">${summary}</div>
                            <div class="session-meta">
                                <span class="session-id">ID: ${shortId}</span>
                                ${session.diagnosis ? '<span class="has-diagnosis">已诊断</span>' : ''}
                                ${session.prescription ? '<span class="has-prescription">有处方</span>' : ''}
                                <button class="view-details-btn" onclick="event.stopPropagation(); showConversationDetails('${sessionId}', '${session.doctorKey}')" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">查看详情</button>
                            </div>
                        </div>
                    `;
                });
                
                historyContainer.innerHTML = historyHTML;
                console.log(`加载了 ${allConversations.length} 条历史记录`);
                
            } catch (error) {
                console.error('加载历史记录失败:', error);
                historyContainer.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">加载历史记录失败</div>';
            }
        }
        
        // 🆕 显示问诊详情 - 从服务器获取完整信息
        async function showConversationDetails(sessionId, doctorKey) {
            console.log('📋 显示问诊详情:', sessionId, doctorKey);
            
            try {
                const userId = getCurrentUserId();
                
                // 从服务器获取详细的问诊记录
                const response = await fetch(`/api/consultation/patient-history/${userId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('📋 API返回的历史数据:', result);
                
                if (!result.success || !result.data) {
                    throw new Error('获取详情失败');
                }
                
                // 🔑 修复：更准确的会话匹配逻辑
                const targetConsultation = result.data.find(consultation => {
                    // 多种ID匹配方式
                    const matchIds = [
                        consultation.consultation_id,
                        consultation.uuid,
                        consultation.session_id,
                        consultation.conversation_id
                    ];
                    
                    console.log('🔍 匹配检查:', {
                        sessionId,
                        consultation_id: consultation.consultation_id,
                        matchIds,
                        doctorMatch: consultation.doctor_id === doctorKey
                    });
                    
                    return matchIds.includes(sessionId) || 
                           (consultation.doctor_id === doctorKey && matchIds.some(id => id && id.includes(sessionId.slice(-6))));
                });
                
                if (!targetConsultation) {
                    console.warn('未找到匹配的问诊记录，显示所有数据以供调试');
                    console.log('所有问诊记录:', result.data.map(c => ({
                        id: c.consultation_id,
                        doctor: c.doctor_id,
                        created: c.created_at
                    })));
                    
                    // 如果找不到精确匹配，选择最新的记录
                    const latestConsultation = result.data[0];
                    if (latestConsultation) {
                        console.log('🔄 使用最新的问诊记录:', latestConsultation.consultation_id);
                        showConsultationDetailsModal(latestConsultation);
                        return;
                    }
                    
                    throw new Error('未找到对应的问诊记录');
                }
                
                console.log('✅ 找到匹配的问诊记录:', targetConsultation.consultation_id);
                
                // 显示详情模态框
                showConsultationDetailsModal(targetConsultation);
                
            } catch (error) {
                console.error('获取问诊详情失败:', error);
                showMessage('获取问诊详情失败: ' + error.message, 'error');
            }
        }
        
        // 🆕 显示问诊详情模态框
        function showConsultationDetailsModal(consultation) {
            console.log('🔍 解析问诊详情数据:', consultation);
            
            // 🔑 修复：使用正确的字段名解析对话历史
            let conversationHistory = [];
            try {
                // 优先使用API返回的conversation_history字段
                if (consultation.conversation_history && Array.isArray(consultation.conversation_history)) {
                    conversationHistory = consultation.conversation_history;
                } else if (consultation.conversation_log) {
                    const logData = typeof consultation.conversation_log === 'string' 
                        ? JSON.parse(consultation.conversation_log) 
                        : consultation.conversation_log;
                    conversationHistory = logData.conversation_history || [];
                }
            } catch (e) {
                console.warn('解析对话历史失败:', e);
            }
            
            console.log('📜 对话历史数据:', conversationHistory);
            
            // 🔑 修复：解析症状分析，处理多种数据格式
            let symptomsData = {};
            try {
                if (consultation.symptoms_analysis) {
                    symptomsData = typeof consultation.symptoms_analysis === 'string'
                        ? JSON.parse(consultation.symptoms_analysis)
                        : consultation.symptoms_analysis;
                } else if (consultation.prescription_info && consultation.prescription_info.symptoms) {
                    // 从处方信息中获取症状
                    symptomsData.symptoms = consultation.prescription_info.symptoms;
                }
            } catch (e) {
                console.warn('解析症状分析失败:', e);
            }
            
            console.log('🔍 症状分析数据:', symptomsData);
            
            // 🔑 修复：解析中医证候，处理多种数据格式
            let syndromeData = {};
            try {
                if (consultation.tcm_syndrome) {
                    syndromeData = typeof consultation.tcm_syndrome === 'string'
                        ? JSON.parse(consultation.tcm_syndrome)
                        : consultation.tcm_syndrome;
                } else if (consultation.prescription_info && consultation.prescription_info.diagnosis) {
                    // 从处方信息中获取诊断
                    syndromeData.diagnosis = consultation.prescription_info.diagnosis;
                }
            } catch (e) {
                console.warn('解析中医证候失败:', e);
            }
            
            console.log('🏥 中医证候数据:', syndromeData);
            
            // 🔑 修复：获取完整的处方信息
            const prescriptionInfo = consultation.prescription_info || {};
            console.log('💊 处方信息数据:', prescriptionInfo);
            
            // 构建详情HTML
            const detailsHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 16px; padding: 0; max-width: 800px; max-height: 90vh; overflow: hidden; position: relative;" onclick="event.stopPropagation()">
                        <!-- 模态框头部 -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; position: relative;">
                            <h2 style="margin: 0; font-size: 20px;">📋 问诊详情</h2>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                            <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
                                问诊时间: ${new Date(consultation.created_at).toLocaleString('zh-CN')}<br>
                                医生: ${consultation.doctor_display_name || '中医专家'}<br>
                                状态: ${consultation.status === 'completed' ? '已完成' : consultation.status === 'pending_review' ? '等待审核' : '进行中'}
                            </div>
                        </div>
                        
                        <!-- 模态框内容 -->
                        <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                            <!-- 对话记录 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">💬 对话记录</h3>
                                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb;">
                                    ${conversationHistory.length > 0 ? 
                                        conversationHistory.map(msg => `
                                            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="color: #667eea; font-weight: 600; margin-bottom: 5px;">患者:</div>
                                                <div style="margin-bottom: 10px; line-height: 1.6;">${msg.patient_query || ''}</div>
                                                <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">医生:</div>
                                                <div style="line-height: 1.6; white-space: pre-wrap;">${msg.ai_response || ''}</div>
                                            </div>
                                        `).join('') : 
                                        '<div style="color: #6b7280; text-align: center;">暂无对话记录</div>'
                                    }
                                </div>
                            </div>
                            
                            <!-- 症状分析 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">🔍 症状分析</h3>
                                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f0f9ff;">
                                    ${symptomsData.symptoms || symptomsData.main_symptoms ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>主要症状:</strong> ${symptomsData.symptoms || symptomsData.main_symptoms || ''}
                                        </div>
                                    ` : ''}
                                    ${symptomsData.additional_symptoms ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>伴随症状:</strong> ${symptomsData.additional_symptoms}
                                        </div>
                                    ` : ''}
                                    ${symptomsData.confidence_score ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>诊断置信度:</strong> ${(symptomsData.confidence_score * 100).toFixed(1)}%
                                        </div>
                                    ` : ''}
                                    ${!symptomsData.symptoms && !symptomsData.main_symptoms ? 
                                        '<div style="color: #6b7280;">暂无症状分析数据</div>' : ''
                                    }
                                </div>
                            </div>
                            
                            <!-- 中医辩证 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">🏥 中医辩证</h3>
                                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f0fdf4;">
                                    ${syndromeData.syndrome || syndromeData.diagnosis ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>证候诊断:</strong> ${syndromeData.syndrome || syndromeData.diagnosis || ''}
                                        </div>
                                    ` : ''}
                                    ${syndromeData.pattern || syndromeData.tcm_pattern ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>证型分析:</strong> ${syndromeData.pattern || syndromeData.tcm_pattern}
                                        </div>
                                    ` : ''}
                                    ${syndromeData.treatment_principle ? `
                                        <div style="margin-bottom: 10px;">
                                            <strong>治则治法:</strong> ${syndromeData.treatment_principle}
                                        </div>
                                    ` : ''}
                                    ${!syndromeData.syndrome && !syndromeData.diagnosis ? 
                                        '<div style="color: #6b7280;">暂无辩证信息</div>' : ''
                                    }
                                </div>
                            </div>
                            
                            <!-- 处方信息 -->
                            ${prescriptionInfo.prescription_id ? `
                                <div style="margin-bottom: 25px;">
                                    <h3 style="color: #374151; margin-bottom: 15px; font-size: 16px;">💊 处方信息</h3>
                                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #fefce8;">
                                        <div style="margin-bottom: 10px;">
                                            <strong>处方ID:</strong> ${prescriptionInfo.prescription_id}
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong>审核状态:</strong> 
                                            <span style="color: ${prescriptionInfo.review_status === 'approved' ? '#059669' : prescriptionInfo.review_status === 'pending_review' ? '#d97706' : '#dc2626'};">
                                                ${prescriptionInfo.review_status === 'approved' ? '已审核通过' : 
                                                  prescriptionInfo.review_status === 'pending_review' ? '等待审核' : 
                                                  prescriptionInfo.review_status || '未知'}
                                            </span>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong>支付状态:</strong> 
                                            <span style="color: ${prescriptionInfo.payment_status === 'completed' ? '#059669' : '#d97706'};">
                                                ${prescriptionInfo.payment_status === 'completed' ? '已支付' : '待支付'}
                                            </span>
                                        </div>
                                        ${prescriptionInfo.display_text ? `
                                            <div style="margin-top: 15px;">
                                                <strong>处方内容:</strong>
                                                <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 8px; line-height: 1.6; white-space: pre-wrap;">
                                                    ${prescriptionInfo.display_text}
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${prescriptionInfo.diagnosis ? `
                                            <div style="margin-top: 15px;">
                                                <strong>诊断:</strong> ${prescriptionInfo.diagnosis}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- 模态框底部 -->
                        <div style="padding: 20px; border-top: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: flex-end; gap: 10px;">
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">关闭</button>
                            <button onclick="exportSession('${consultation.uuid || consultation.conversation_id}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">导出报告</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
        }

        // 移动端页面切换
        function showMobileChatPage() {
            if (window.innerWidth <= 768) {
                const container = document.getElementById('mobilePageContainer');
                container.classList.add('show-chat');
                
            }
        }
        
        function showMobileDoctorPage() {
            if (window.innerWidth <= 768) {
                document.getElementById('mobilePageContainer').classList.remove('show-chat');
            }
        }

        // 移动端医生选择（支持默认医生和推荐医生）
        function selectMobileDoctor(doctorKey, doctorData = null) {
            // 保存当前医生的对话历史
            if (selectedDoctor && selectedDoctor !== doctorKey) {
                saveCurrentDoctorHistory();
            }
            
            selectedDoctor = doctorKey;
            
            // 获取医生信息（优先使用传入的doctorData，然后是默认doctors对象）
            const doctor = doctorData || doctors[doctorKey] || {
                name: '医生',
                school: '中医师', 
                avatar: '👨‍⚕️',
                specialty: '中医内科'
            };
            
            // 更新移动端医生信息
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // 生成新的对话ID，强制开始新对话
            generateConversationId();
            
            // 直接加载该医生的历史对话（loadDoctorHistory会自动清空容器）
            loadDoctorHistory(doctorKey);
            
            // 切换到聊天页面
            showMobileChatPage();
            
            // 确保输入框可见
            setTimeout(() => ensureMobileInputVisible(), 500);
        }

        // 移动端渲染医生卡片 - 已简化，移除AI推荐功能
        function renderMobileDoctorCards() {
            console.log('👥 渲染移动端医生卡片');
            const container = document.getElementById('mobileDoctorsGrid');
            if (!container) {
                console.error('❌ 未找到移动端医生容器 mobileDoctorsGrid');
                return;
            }
            
            // 清空容器
            container.innerHTML = '';
            
            // 强制显示容器
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            
            console.log('🔍 医生对象:', doctors);
            console.log('🔍 容器状态:', {
                display: getComputedStyle(container).display,
                visibility: getComputedStyle(container).visibility,
                opacity: getComputedStyle(container).opacity
            });
            
            // 直接使用默认医生列表
            Object.entries(doctors).forEach(([key, doctor]) => {
                const card = document.createElement('div');
                card.className = 'mobile-doctor-card';
                card.onclick = () => selectMobileDoctor(key, doctor);
                
                card.innerHTML = `
                    <div class="mobile-doctor-info">
                        <div class="mobile-doctor-avatar">${doctor.avatar}</div>
                        <div class="mobile-doctor-details">
                            <h3>${doctor.name}</h3>
                            <div class="school">${doctor.school}</div>
                        </div>
                    </div>
                    <div class="mobile-doctor-specialty">
                        <strong>擅长：</strong>${doctor.specialty}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // 添加移动端医生切换按钮 - AI推荐医生功能已移除
        // function addMobileDoctorToggleButton(container) {
        //     // AI推荐医生功能已移除，不再需要切换按钮
        // }

        // 移动端添加消息
        function addMobileMessage(sender, content, showFeedback = false, isPaid = false, prescriptionId = null) {
            const container = document.getElementById('mobileMessagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // 🆕 使用处方渲染器处理内容（移动端）
            let processedContent = content;
            if (sender === 'ai') {
                if (window.prescriptionContentRenderer) {
                    // 使用新的模块化处方渲染器（移动端）
                    processedContent = window.prescriptionContentRenderer.renderContent(content, prescriptionId);
                } else {
                    // 备用方案：使用格式化函数处理普通内容
                    processedContent = formatMessage(content);
                }
            }
            
            // 如果有处方ID，保存到元素属性中
            if (prescriptionId) {
                messageDiv.setAttribute('data-prescription-id', prescriptionId);
            }

            const messageContent = `
                <div class="message-avatar">
                    ${sender === 'user' ? '👤' : '🏥'}
                </div>
                <div class="message-content">
                    <div class="message-text">${processedContent}</div>
                    ${sender === 'ai' && showFeedback ? `
                        <div class="feedback-controls">
                            <div class="feedback-label">这个回答有帮助吗？</div>
                            <div class="rating-buttons">
                                <button class="rating-btn" onclick="rateFeedback(this, 5)">😊 很好</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 4)">👍 不错</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 3)">👌 还行</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 2)">👎 不好</button>
                                <button class="rating-btn" onclick="rateFeedback(this, 1)">😞 很差</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            container.appendChild(messageDiv);
            
            // 🔧 为移动端保存原始内容用于支付后解锁
            if (sender === 'ai' && prescriptionId && content && window.prescriptionContentRenderer) {
                const messageTextEl = messageDiv.querySelector('.message-text');
                if (messageTextEl && !messageTextEl.getAttribute('data-original-content')) {
                    messageTextEl.setAttribute('data-original-content', content);
                    console.log('✅ 移动端已保存原始内容用于支付后解锁');
                }
            }
            
            // 平滑滚动到底部
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // 自动保存移动端对话历史
            if (selectedDoctor) {
                setTimeout(() => {
                    saveCurrentDoctorHistory();
                    // 🔄 自动更新ChatGPT风格对话管理系统
                    updateConversationListAfterMessage();
                }, 200); // 延迟200ms确保DOM和滚动都完成
            }
        }

        // 移动端发送消息
        async function sendMobileMessage() {
            const input = document.getElementById('mobileMessageInput');
            const message = input.value.trim();
            
            if (!message || !selectedDoctor) {
                if (!selectedDoctor) {
                    alert('请先选择一位医师');
                }
                return;
            }

            // 添加用户消息
            addMobileMessage('user', message);
            input.value = '';
            adjustMobileTextareaHeight();

            // 显示加载状态
            const sendBtn = document.getElementById('mobileSendBtn');
            sendBtn.disabled = true;
            
            // 添加"正在分析"的临时消息
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message ai loading-message';
            loadingMessage.innerHTML = `
                <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f4f6; border-radius: 50%; border-top: 2px solid #667eea; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                AI正在分析您的症状...
            `;
            const container = document.getElementById('mobileMessagesContainer');
            container.appendChild(loadingMessage);
            container.scrollTop = container.scrollHeight;

            // 创建带超时的AbortController
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 45000); // 45秒超时

                        // 检查网络状态
            if (!checkNetworkStatus()) {
                sendBtn.disabled = false;
                return;
            }
            
            

            try {
                // 🔑 关键修复：获取当前对话历史以维持上下文连续性
                const conversationHistory = getCurrentConversationHistory();
                
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        selected_doctor: selectedDoctor,
                        patient_id: getCurrentUserId(), // 🔑 修复：添加用户ID
                        conversation_history: conversationHistory // 传递对话历史
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // 移除加载消息
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // 🔍 调试：打印完整API响应
                console.log('🔍 移动端API完整响应:', data);
                
                // 处理新的API响应格式 (移动端)
                let aiReply;
                if (data.success && data.data && data.data.reply) {
                    aiReply = data.data.reply;
                    console.log('✅ 移动端使用新格式，回复内容长度:', aiReply.length);
                } else if (data.reply) {
                    aiReply = data.reply; // 兼容旧格式
                    console.log('✅ 移动端使用旧格式，回复内容长度:', aiReply.length);
                } else {
                    console.error('❌ 移动端API响应格式错误，响应结构:', Object.keys(data));
                    throw new Error('API响应格式错误: 未找到reply字段');
                }
                
                if (aiReply) {
                    // 🔑 关键修复：处方检测和支付状态分离管理（移动端）
                    const containsActualPrescription = containsPrescription(aiReply);
                    const isTemporaryAdvice = window.prescriptionContentRenderer ? 
                        !window.prescriptionContentRenderer.containsPrescription(aiReply) : false;
                    
                    // 智能判断是否显示点评 - 所有AI回复都可以点评
                    const shouldShowFeedback = true;
                    
                    // 处方相关状态管理 - 修复处方ID为空的问题
                    let prescriptionId = data.data?.prescription_id || null;
                    const isPaid = data.data?.is_paid || false;
                    
                    // 🔧 如果API没有返回处方ID，但响应包含处方内容，则调用后端创建处方
                    if (!prescriptionId && data.reply && 
                        (data.reply.includes('处方') || data.reply.includes('方剂') || 
                         data.reply.includes('君药') || data.reply.includes('臣药'))) {
                        
                        // 🔑 关键修复：调用后端API创建处方并保存到数据库（移动端）
                        try {
                            const userId = getCurrentUserId();
                            const conversationId = currentConversationId || generateConversationId();
                            
                            const prescriptionData = {
                                patient_id: userId,
                                conversation_id: conversationId,
                                patient_name: currentUser?.display_name || currentUser?.username || '用户',
                                symptoms: (data.data?.symptoms_summary || '用户问诊'),
                                diagnosis: (data.data?.diagnosis_summary || selectedDoctor + '医生诊断'),
                                ai_prescription: data.reply
                            };
                            
                            console.log('🔄 移动端调用后端创建处方:', prescriptionData);
                            
                            const createResponse = await fetch('/api/prescription/create', {
                                method: 'POST',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(prescriptionData)
                            });
                            
                            if (createResponse.ok) {
                                const createResult = await createResponse.json();
                                if (createResult.success) {
                                    prescriptionId = createResult.prescription_id;
                                    console.log('✅ 移动端处方创建成功，ID:', prescriptionId);
                                } else {
                                    console.warn('⚠️ 移动端处方创建返回失败:', createResult.message);
                                    // 备用方案：使用临时ID
                                    prescriptionId = 'temp_mobile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                }
                            } else {
                                console.warn('⚠️ 移动端处方创建API调用失败:', createResponse.status);
                                // 备用方案：使用临时ID
                                prescriptionId = 'temp_mobile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                        } catch (error) {
                            console.error('❌ 移动端处方创建异常:', error);
                            // 备用方案：使用临时ID
                            prescriptionId = 'temp_mobile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                        
                        console.log('🆕 移动端最终处方ID:', prescriptionId);
                    }
                    
                    // 🚨 关键逻辑：完整处方且未付费时需要支付
                    const needsPayment = containsActualPrescription && !isTemporaryAdvice && !isPaid;
                    
                    console.log('🔍 移动端即将添加AI消息:', {
                        aiReply: aiReply.substring(0, 100) + '...',
                        shouldShowFeedback,
                        containsActualPrescription,
                        isTemporaryAdvice,
                        needsPayment,
                        isPaid,
                        prescriptionId
                    });
                    
                    // 🔑 关键修复：根据处方状态决定显示模式
                    addMobileMessage('ai', aiReply, shouldShowFeedback, isPaid, prescriptionId);
                    
                    // 记录诊断阶段
                    if (shouldShowFeedback) {
                        console.log('移动端检测到处方内容，显示点评功能，处方ID:', prescriptionId, '支付状态:', isPaid);
                    } else {
                        console.log('移动端普通对话，不显示点评');
                    }
                } else {
                    addMobileMessage('ai', '抱歉，我现在无法回答您的问题，请稍后再试。');
                }
                
                // 保存移动端对话历史
                setTimeout(() => {
                    saveCurrentDoctorHistory();
                    // 🔄 自动更新ChatGPT风格对话管理系统
                    updateConversationListAfterMessage();
                }, 200);

            } catch (error) {
                console.error('Mobile API Error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // 移除加载消息
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // 更详细的错误信息
                let errorMsg = '网络请求失败';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = '网络连接错误，请检查网络状态';
                } else if (error.message.includes('timeout')) {
                    errorMsg = '请求超时，请稍后再试';
                } else if (error.message.includes('HTTP error')) {
                    errorMsg = `服务器错误: ${error.message}`;
                } else {
                    errorMsg = `连接失败: ${error.message}`;
                }
                
                addMobileMessage('ai', errorMsg);
            } finally {
                sendBtn.disabled = false;
            }
        }

        // 移动端输入框高度调整
        function adjustMobileTextareaHeight() {
            const textarea = document.getElementById('mobileMessageInput');
            if (!textarea) return;
            
            textarea.style.height = '44px'; // 重置为最小高度
            const newHeight = Math.min(textarea.scrollHeight, 100);
            textarea.style.height = newHeight + 'px';
        }

        // 移动端键盘事件
        function handleMobileKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMobileMessage();
            }
        }
        
        
        // 移动端输入框焦点处理（简化版）
        function ensureMobileInputVisible() {
            const container = document.getElementById('mobileMessagesContainer');
            
            // 简单滚动到底部，不做过多干预
            setTimeout(() => {
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 100);
        }
        
        // 软键盘收起处理（简化版）
        function handleMobileInputBlur() {
            // 仅做最小必要的清理
            setTimeout(() => {
                const container = document.getElementById('mobileMessagesContainer');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 200);
        }

        // 删除视口监听器，避免过多干预
        
        // 页面加载时初始化移动端
        document.addEventListener('DOMContentLoaded', function() {
            // 调试：检查移动端检测
            const isMobile = window.innerWidth <= 768;
            const mobileContainer = document.getElementById('mobilePageContainer');
            console.log('🔍 移动端检测:', {
                windowWidth: window.innerWidth,
                isMobile: isMobile,
                mobileContainer: mobileContainer,
                containerDisplay: mobileContainer ? getComputedStyle(mobileContainer).display : 'not found'
            });
            if (window.innerWidth <= 768) {
                console.log('✅ 初始化移动端界面');
                
                // 强制显示移动端容器
                const mobileContainer = document.getElementById('mobilePageContainer');
                if (mobileContainer) {
                    mobileContainer.style.display = 'flex';
                    console.log('✅ 强制显示移动端容器');
                }
                
                // 延迟渲染医生卡片，确保 DOM 完全加载
                setTimeout(() => {
                    renderMobileDoctorCards();
                }, 500);
                
                // 移动端不设置默认医生，让用户主动选择
                // setMobileDefaultDoctor('zhang_zhongjing');
            } else {
                console.log('🖥️ 桌面端模式');
            }
        });
        
        // 移动端设置默认医生
        function setMobileDefaultDoctor(doctorKey) {
            const doctor = doctors[doctorKey];
            if (!doctor) return;
            
            selectedDoctor = doctorKey;
            
            // 更新移动端医生信息
            document.getElementById('mobileDoctorAvatar').textContent = doctor.avatar;
            document.getElementById('mobileDoctorName').textContent = doctor.name;
            document.getElementById('mobileDoctorDesc').textContent = doctor.school;
            
            // 添加欢迎消息到移动端
            const mobileContainer = document.getElementById('mobileMessagesContainer');
            if (mobileContainer && !mobileContainer.querySelector('.message')) {
                addMobileMessage('ai', `您好！我是${doctor.name}，${doctor.school}传人。请详细描述您的症状，我将为您进行专业的中医分析。`);
            }
        }
    </script>
    
    <!-- 开发调试信息（仅开发模式显示） -->
    <div id="mobileVersionInfo" style="display: none; position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 20px; font-size: 11px; z-index: 1000; border: 1px solid rgba(255,255,255,0.2);">
        <span style="color: #4fc3f7;">TCM v1.2.4</span> | 
        <a href="/static/wechat_debug.html" style="color: #81c784; text-decoration: none;">网络诊断</a> | 
        <a href="javascript:location.reload(true)" style="color: #ffb74d; text-decoration: none;">刷新</a> |
        <span style="color: #f48fb1; cursor: pointer;" onclick="this.parentElement.style.display='none'">×</span>
    </div>
    
    <script>
        // 调试模式检测 - 只有在特定条件下才显示调试信息
        function isDebugMode() {
            // 检测URL参数、开发环境等
            const urlParams = new URLSearchParams(window.location.search);
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const hasDebugParam = urlParams.has('debug');
            const isDevPort = window.location.port === '7789' || window.location.port === '3000';
            
            return isLocalhost || hasDebugParam || isDevPort;
        }
        
        // 添加特殊手势显示调试信息的功能（仅供开发调试）
        let clickSequence = [];
        let debugVisible = false;
        
        document.addEventListener('click', function(e) {
            // 记录点击位置（分为9宫格）
            const x = Math.floor(e.clientX / (window.innerWidth / 3));
            const y = Math.floor(e.clientY / (window.innerHeight / 3));
            const position = y * 3 + x;
            
            clickSequence.push(position);
            if (clickSequence.length > 5) clickSequence.shift();
            
            // 特殊序列：左上-右上-左下-右下-中心 (0-2-6-8-4)
            const debugSequence = [0, 2, 6, 8, 4];
            const isDebugSequence = clickSequence.length === 5 && 
                clickSequence.every((pos, idx) => pos === debugSequence[idx]);
            
            if (isDebugSequence && (isDebugMode() || window.location.hostname.includes('dev'))) {
                debugVisible = !debugVisible;
                document.getElementById('mobileVersionInfo').style.display = debugVisible ? 'block' : 'none';
                clickSequence = [];
                
                if (debugVisible) {
                    setTimeout(() => {
                        document.getElementById('mobileVersionInfo').style.display = 'none';
                        debugVisible = false;
                    }, 10000);
                }
            }
            
            // 清空序列
            setTimeout(() => { clickSequence = []; }, 3000);
        });
        // 网络状态检测
        function checkNetworkStatus() {
            if (!navigator.onLine) {
                addMobileMessage('ai', '🔌 检测到网络连接中断，请检查您的网络设置。');
                return false;
            }
            return true;
        }
        
        // 监听网络状态变化
        window.addEventListener('online', function() {
            console.log('Network is back online');
        });
        
        window.addEventListener('offline', function() {
            console.log('Network is offline');
            addMobileMessage('ai', '🔌 网络连接已断开，请检查您的网络设置。');
        });
    </script>

    <!-- 微信分享增强脚本 -->
    <script>
        // 微信环境检测
        function isWechat() {
            return /MicroMessenger/i.test(navigator.userAgent);
        }
        
        // 检测微信公众号来源
        function detectWechatSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromWechat = urlParams.get('from') === 'wechat';
            const wechatSource = urlParams.get('source') || 'unknown';
            
            return {
                fromWechat: fromWechat,
                source: wechatSource,
                isWechatBrowser: isWechat()
            };
        }
        
        // 处理微信公众号访问
        function handleWechatPublicAccount() {
            const wechatInfo = detectWechatSource();
            
            if (wechatInfo.fromWechat || wechatInfo.isWechatBrowser) {
                console.log('微信公众号用户访问，来源:', wechatInfo.source);
                
                // 记录微信访问统计
                fetch('/api/log_wechat_visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: wechatInfo.source,
                        from_wechat: wechatInfo.fromWechat,
                        is_wechat_browser: wechatInfo.isWechatBrowser,
                        timestamp: new Date().toISOString(),
                        page: 'main_app'
                    })
                }).catch(err => console.log('微信访问记录失败:', err));
                
                // 显示微信专属欢迎信息
                if (wechatInfo.fromWechat && wechatInfo.source === 'menu') {
                    setTimeout(() => showWechatWelcome(), 1000);
                }
                
                // 微信内优化：隐藏不必要的分享按钮
                if (wechatInfo.isWechatBrowser) {
                    const shareButtons = document.querySelectorAll('.share-button, .external-share');
                    shareButtons.forEach(btn => btn.style.display = 'none');
                }
            }
        }
        
        // 显示微信专属欢迎信息
        function showWechatWelcome() {
            const welcomeHTML = `
                <div id="wechatWelcome" style="
                    position: fixed; 
                    top: 60px; 
                    left: 50%; 
                    transform: translateX(-50%); 
                    background: linear-gradient(135deg, #28a745, #20c997); 
                    color: white; 
                    padding: 12px 20px; 
                    border-radius: 25px; 
                    font-size: 13px; 
                    z-index: 9999;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    animation: slideInDown 0.6s ease-out;
                    text-align: center;
                    max-width: 280px;
                ">
                    🎉 欢迎从公众号访问！<br>
                    <small>5大中医流派，专业AI问诊</small>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', welcomeHTML);
            
            // 4秒后淡出
            setTimeout(() => {
                const welcome = document.getElementById('wechatWelcome');
                if (welcome) {
                    welcome.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    welcome.style.opacity = '0';
                    welcome.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => welcome.remove(), 500);
                }
            }, 4000);
        }
        
        // 页面加载完成后初始化微信功能
        document.addEventListener('DOMContentLoaded', function() {
            handleWechatPublicAccount();
        });
        
        // 优化微信分享
        if (isWechat()) {
            // 动态设置分享信息
            document.title = "AI中医智能问诊助手";
            
            // 添加微信分享元信息
            var metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.content = "专业AI中医诊断助手，智能症状分析，证候判断，个性化方剂推荐";
            }
            
            // 记录微信分享统计
            window.addEventListener('load', function() {
                fetch('/api/wechat_visit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        page: 'main_app',
                        is_shared: document.referrer.includes('wechat'),
                        timestamp: new Date().toISOString()
                    })
                }).catch(() => {});
            });
            
            // 页面关闭或刷新时保存历史记录
            window.addEventListener('beforeunload', function(event) {
                // 确保在页面关闭前保存当前对话历史
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('页面关闭前已保存历史记录');
                }
            });
            
            // 页面可见性变化时也保存（应对手机切换应用等场景）
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('页面隐藏时已保存历史记录');
                }
            });
            
            // 增强历史记录保护 - 定期自动保存
            setInterval(() => {
                if (selectedDoctor) {
                    const messagesContainer = document.getElementById(window.innerWidth <= 768 ? 'mobileMessagesContainer' : 'messagesContainer');
                    if (messagesContainer && messagesContainer.children.length > 0) {
                        saveCurrentDoctorHistory();
                        console.log('定期自动保存历史记录');
                    }
                }
            }, 30000); // 每30秒自动保存一次
            
            // 浏览器焦点变化时保存
            window.addEventListener('blur', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('浏览器失去焦点时保存历史记录');
                }
            });
            
            // 页面卸载前强制保存
            window.addEventListener('pagehide', function() {
                if (selectedDoctor) {
                    saveCurrentDoctorHistory();
                    console.log('页面卸载前保存历史记录');
                }
            });
        }
        
        // localStorage管理功能
        function checkLocalStorageUsage() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length + key.length;
                    }
                }
                const sizeInMB = (totalSize / 1024 / 1024).toFixed(2);
                console.log(`LocalStorage使用量: ${sizeInMB}MB`);
                
                // 如果超过4MB，发出警告
                if (totalSize > 4 * 1024 * 1024) {
                    console.warn('LocalStorage使用量较大，可能需要清理');
                }
            } catch (error) {
                console.error('检查localStorage使用量失败:', error);
            }
        }
        
        function cleanOldHistoryRecords() {
            try {
                const keys = Object.keys(localStorage);
                const userId = getCurrentUserId();
                const historyKeys = keys.filter(key => key.startsWith(`tcm_doctor_history_${userId}_`));
                
                // 如果有超过10个医生的历史记录，清理最旧的
                if (historyKeys.length > 10) {
                    const keysWithTime = historyKeys.map(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            const lastUpdated = data.lastUpdated || data.timestamp || 0;
                            return { key, lastUpdated };
                        } catch {
                            return { key, lastUpdated: 0 };
                        }
                    });
                    
                    // 按时间排序，删除最旧的
                    keysWithTime.sort((a, b) => new Date(a.lastUpdated) - new Date(b.lastUpdated));
                    const keysToDelete = keysWithTime.slice(0, historyKeys.length - 8); // 保留最新8个
                    
                    keysToDelete.forEach(({ key }) => {
                        localStorage.removeItem(key);
                        console.log(`已清理旧历史记录: ${key}`);
                    });
                }
            } catch (error) {
                console.error('清理旧历史记录失败:', error);
            }
        }
        
        // 历史记录诊断功能
        function diagnoseHistoryIssues() {
            console.log('=== 历史记录诊断 ===');
            console.log('当前医生:', selectedDoctor);
            console.log('浏览器信息:', navigator.userAgent);
            console.log('屏幕尺寸:', window.innerWidth + 'x' + window.innerHeight);
            
            const keys = Object.keys(localStorage);
            const userId = getCurrentUserId();
            const historyKeys = keys.filter(key => key.startsWith(`tcm_doctor_history_${userId}_`));
            console.log('历史记录数量:', historyKeys.length);
            
            // 🔍 用户历史记录调试信息
            debugUserIdAndHistory();
            
            historyKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = JSON.parse(data);
                    const messageCount = Array.isArray(parsed) ? parsed.length : (parsed.messages ? parsed.messages.length : 0);
                    console.log(`${key}: ${messageCount}条消息, 大小=${(data.length/1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error(`${key}: 数据损坏`, error);
                }
            });
            
            checkLocalStorageUsage();
            
            // 测试localStorage写入
            try {
                const testKey = 'tcm_test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                console.log('✅ localStorage写入测试成功');
            } catch (error) {
                console.error('❌ localStorage写入测试失败:', error);
            }
        }

        // 问诊指导功能
        function showGuidance() {
            const overlay = document.createElement('div');
            overlay.className = 'guidance-overlay';
            overlay.onclick = hideGuidance;
            document.body.appendChild(overlay);
            
            document.getElementById('guidanceTips').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideGuidance() {
            document.getElementById('guidanceTips').style.display = 'none';
            const overlay = document.querySelector('.guidance-overlay');
            if (overlay) {
                overlay.remove();
            }
            document.body.style.overflow = 'auto';
        }

        function toggleGuidance() {
            hideGuidance();
        }
    </script>

    <!-- 问诊指导提示 -->
    <div class="guidance-tips" id="guidanceTips" style="display: none;">
        <div class="tips-header">
            <h4>💡 问诊指导</h4>
            <button onclick="toggleGuidance()" class="close-btn">×</button>
        </div>
        <div class="tips-content">
            <div class="tip-section">
                <h5>🔍 主要症状描述</h5>
                <ul>
                    <li>主要不适感觉（疼痛、发热、咳嗽等）</li>
                    <li>症状持续时间（几天、几周、几个月）</li>
                    <li>症状程度（轻微、中等、严重）</li>
                    <li>发作规律（持续性、间歇性、特定时间）</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>🩺 伴随症状</h5>
                <ul>
                    <li>睡眠情况（入睡困难、易醒、多梦）</li>
                    <li>食欲状况（食欲不振、消化不良）</li>
                    <li>大小便情况（便秘、腹泻、尿频等）</li>
                    <li>情绪状态（焦虑、抑郁、烦躁）</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>👅 舌象脉象（如果方便）</h5>
                <ul>
                    <li>舌头颜色（淡红、红、暗红）</li>
                    <li>舌苔情况（薄白、厚黄、无苔等）</li>
                    <li>脉搏感觉（快慢、强弱、规律性）</li>
                    <li>可上传舌象照片以便更准确诊断</li>
                </ul>
            </div>
            
            <div class="tip-section">
                <h5>📋 其他重要信息</h5>
                <ul>
                    <li>既往病史（慢性病、手术史）</li>
                    <li>过敏史（药物、食物过敏）</li>
                    <li>目前用药情况</li>
                    <li>生活习惯（作息、饮食、运动）</li>
                </ul>
            </div>
            
            <div class="tip-footer">
                <p>💬 <strong>提示</strong>：提供越详细的信息，医生越能给出准确的诊断和治疗建议</p>
            </div>
        </div>
    </div>
    
    <!-- 移动端图片选择弹窗 - 移至body底部确保最高层级 -->
    <div class="mobile-image-modal mobile-modal-hidden" id="mobileImageModal">
        <div class="mobile-image-modal-content">
            <div class="modal-header">
                <h3>选择拍照类型</h3>
                <button onclick="closeMobileImageModal()" class="modal-close">×</button>
            </div>
            <div class="modal-options">
                <button onclick="triggerMobileTongueUpload()" class="image-option-btn">
                    <div class="option-icon">👅</div>
                    <div class="option-text">
                        <strong>舌诊拍照</strong>
                        <span>拍摄舌头照片</span>
                    </div>
                </button>
                <button onclick="triggerMobileFaceUpload()" class="image-option-btn">
                    <div class="option-icon">😊</div>
                    <div class="option-text">
                        <strong>面诊拍照</strong>
                        <span>拍摄面部照片</span>
                    </div>
                </button>
            </div>
            <div class="upload-status-mobile" id="mobileUploadStatus">
                <div class="mobile-status-item" id="mobileTongueStatus">👅 舌诊: <span>未上传</span></div>
                <div class="mobile-status-item" id="mobileFaceStatus">😊 面诊: <span>未上传</span></div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <div class="login-header">
                <h3>用户登录</h3>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label class="form-label">用户名/手机号</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="请输入用户名或手机号">
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="请输入密码">
                </div>
                <div class="error-message" id="loginError">
                    登录失败，请检查用户名和密码
                </div>
                <div class="login-buttons">
                    <button class="login-btn secondary" onclick="hideLoginModal()">取消</button>
                    <button class="login-btn primary" onclick="performLogin()">登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 处方渲染器样式和脚本 -->
    <link rel="stylesheet" href="/static/css/prescription_styles.css">
    <!-- 🎯 简化版处方支付管理系统 -->
    <script src="/static/js/simple_prescription_manager.js?v=20250926-001"></script>
    
    <!-- 🔑 简化版处方恢复系统 - 已禁用，由主系统统一管理 -->
    <!-- <script src="/static/js/simple_recovery.js?v=20250930-001"></script> -->
    
    <!-- 备用：原处方支付管理系统 (暂时禁用，避免语法冲突) -->
    <!-- <script src="/static/js/prescription_payment_manager.js?v=20250925-004"></script> -->
    <!-- <script src="/static/js/prescription_debug_helper.js?v=20250925-004"></script> -->
    <!-- <script src="/static/js/prescription_renderer.js?v=20250916-010"></script> -->
    <script>
        // 🔧 调试：检查处方支付管理系统加载状态
        setTimeout(() => {
            console.log('🔍 处方支付系统加载检查:', {
                simplePrescriptionManager: !!window.simplePrescriptionManager,
                windowKeys: Object.keys(window).filter(k => k.includes('prescription') || k.includes('simple'))
            });
            
            if (window.simplePrescriptionManager) {
                console.log('✅ 简化版处方支付管理系统加载成功');
            } else {
                console.error('❌ 简化版处方支付管理系统未正确加载');
            }
        }, 1000);
    </script>
    
    <!-- 对话状态管理器 - 在主要JavaScript代码之后加载 -->
    <script src="/static/js/conversation_state_manager.js"></script>
    
    <!-- 自动同步管理器 v2.0 - 替代手动同步按钮 -->
    <script src="/static/js/auto_sync_manager.js"></script>
    
    <script>
        // 初始化自动同步系统
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 自动同步系统已启用，告别手动同步时代！');
            
            // 监听自动同步事件
            if (window.autoSyncManager) {
                window.autoSyncManager.addEventListener('connected', function() {
                    console.log('✅ 实时同步已连接，您的数据将自动在设备间同步');
                });
                
                window.autoSyncManager.addEventListener('synced', function(data) {
                    console.log('🔄 自动同步完成:', data.type);
                });
                
                window.autoSyncManager.addEventListener('conflict', function(data) {
                    console.warn('⚠️ 检测到数据冲突，请处理:', data);
                });
            }
        });
    </script>
    
    <script>
        // 🔑 会话恢复功能 - 从历史记录重新加载完整对话
        async function restoreSessionFromHistory(sessionId) {
            try {
                console.log('🔄 开始恢复历史会话:', sessionId);
                
                // 显示恢复提示
                const restoreMessage = `
                    <div class="restore-notification" style="
                        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white; padding: 15px 25px; border-radius: 8px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000;
                        font-size: 14px; font-weight: 500;
                    ">
                        🔄 正在恢复历史对话，请稍候...
                    </div>
                `;
                document.body.insertAdjacentHTML('afterbegin', restoreMessage);
                
                // 1. 从API获取完整的会话数据
                const userId = getCurrentUserId();
                const consultationResponse = await fetch(`/api/user/conversation/${sessionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!consultationResponse.ok) {
                    throw new Error(`获取会话数据失败: ${consultationResponse.status}`);
                }
                
                const consultationData = await consultationResponse.json();
                console.log('📄 获取到会话数据:', consultationData);
                
                if (!consultationData.success) {
                    throw new Error('会话数据获取失败');
                }
                
                // API返回的数据结构直接包含会话信息
                const consultation = consultationData;
                
                // 2. 解析对话记录
                const conversationHistory = consultation.conversation_history || [];
                console.log('💬 对话历史记录数量:', conversationHistory.length);
                
                // 3. 设置医生（如果指定了）
                if (consultation.doctor_name) {
                    console.log('👨‍⚕️ 设置医生:', consultation.doctor_name);
                    selectDoctor(consultation.doctor_name);
                }
                
                // 4. 清空当前消息并恢复对话
                clearAllMessages();
                
                // 5. 依次添加每条对话记录
                for (const message of conversationHistory) {
                    // 添加用户消息
                    if (message.patient_query) {
                        addMessage('您', message.patient_query, 'user', false);
                    }
                    
                    // 添加AI回复消息
                    if (message.ai_response) {
                        // 🔑 简化方案：直接使用conversation_log中的完整内容
                        // 这是最准确的数据来源，包含了完整的处方详情
                        let processedContent = message.ai_response;
                        
                        // 检查是否包含处方内容
                        if (window.simplePrescriptionManager && 
                            window.simplePrescriptionManager.containsPrescription(message.ai_response)) {
                            console.log('💊 检测到处方内容，检查支付状态');
                            
                            // 简化逻辑：直接查询是否有已支付的处方
                            try {
                                const prescriptionResponse = await fetch(`/api/prescription/by-consultation/${sessionId}`);
                                if (prescriptionResponse.ok) {
                                    const prescriptionData = await prescriptionResponse.json();
                                    if (prescriptionData.success && prescriptionData.prescriptions?.length > 0) {
                                        const paidPrescription = prescriptionData.prescriptions.find(p => 
                                            p.is_visible_to_patient === 1 && p.payment_status === 'paid'
                                        );
                                        
                                        if (paidPrescription) {
                                            console.log(`✅ 处方已支付，直接显示完整内容，ID: ${paidPrescription.id}`);
                                            // 🔑 关键：直接显示原始内容，不需要处理
                                            // 因为conversation_log中保存的就是完整的处方内容
                                            processedContent = message.ai_response;
                                            
                                            // 标记为已支付状态，供处方管理器识别
                                            if (window.simplePrescriptionManager) {
                                                await window.simplePrescriptionManager.markAsPaid(paidPrescription.id);
                                            }
                                        } else {
                                            // 未支付，使用处方管理器处理（隐藏详情）
                                            processedContent = await window.simplePrescriptionManager.processContent(
                                                message.ai_response, 
                                                null
                                            );
                                        }
                                    }
                                }
                            } catch (error) {
                                console.warn('⚠️ 查找处方状态失败，使用默认处理:', error);
                                processedContent = await window.simplePrescriptionManager.processContent(
                                    message.ai_response, 
                                    null
                                );
                            }
                        }
                        
                        addMessage(
                            doctors[consultation.doctor_name]?.name || consultation.doctor_display_name || '中医专家',
                            processedContent,
                            'ai',
                            false  // 不保存到历史记录，因为这是恢复操作
                        );
                    }
                }
                
                // 6. 检查是否有处方相关信息
                if (consultation.prescription_given && consultation.prescription_given !== '暂未开方') {
                    console.log('💊 检测到处方信息，触发处方状态检查');
                }
                
                // 7. 设置当前对话ID（如果需要）
                currentConversationId = sessionId;
                
                // 8. 触发处方状态恢复
                if (window.simplePrescriptionManager) {
                    setTimeout(async () => {
                        await window.simplePrescriptionManager.restorePaymentStatus();
                        console.log('✅ 处方支付状态恢复完成');
                    }, 1000);
                }
                
                // 9. 移除恢复提示并显示成功消息
                setTimeout(() => {
                    const notification = document.querySelector('.restore-notification');
                    if (notification) {
                        notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        notification.innerHTML = '✅ 历史对话恢复成功！';
                        
                        setTimeout(() => {
                            notification.remove();
                        }, 2000);
                    }
                }, 500);
                
                console.log('✅ 会话恢复完成');
                
            } catch (error) {
                console.error('❌ 恢复会话失败:', error);
                
                // 显示错误提示
                const notification = document.querySelector('.restore-notification');
                if (notification) {
                    notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    notification.innerHTML = '❌ 恢复历史对话失败，请重试';
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
                
                // 添加错误消息到聊天区域
                addMessage('系统', `恢复历史对话失败：${error.message}。您可以重新开始对话。`, 'system', false);
            }
        }
        
        // 🎯 新增：获取最新问诊会话的处方过滤函数
        function getLatestConsultationPrescriptions(prescriptions) {
            if (!prescriptions || prescriptions.length === 0) {
                return [];
            }
            
            // 按创建时间排序，找出最新的处方记录
            const sortedPrescriptions = prescriptions.sort((a, b) => 
                new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
            );
            
            // 获取最新处方的consultation_id或conversation_id作为会话标识
            const latestPrescription = sortedPrescriptions[0];
            const latestConsultationId = latestPrescription.consultation_id || latestPrescription.conversation_id;
            
            if (!latestConsultationId) {
                console.log('⚠️ 最新处方没有consultation_id，返回最新的单个处方');
                return [latestPrescription];
            }
            
            // 获取最新一次问诊会话的所有处方
            const latestSessionPrescriptions = prescriptions.filter(p => 
                (p.consultation_id === latestConsultationId) || 
                (p.conversation_id === latestConsultationId && !p.consultation_id)
            );
            
            console.log(`🔍 最新问诊会话ID: ${latestConsultationId}`);
            console.log(`📋 该会话包含 ${latestSessionPrescriptions.length} 个处方`);
            console.log(`🕐 会话时间: ${latestPrescription.created_at}`);
            
            return latestSessionPrescriptions;
        }
        
        // 🔑 新增：从服务器恢复处方状态的核心函数
        async function restorePrescriptionStatesFromServer() {
            try {
                const userId = getCurrentUserId();
                console.log('🌐 从服务器恢复处方状态，用户ID:', userId);
                
                if (!userId || userId === 'undefined' || userId === 'null') {
                    console.warn('⚠️ 无效的用户ID，跳过处方状态恢复');
                    return;
                }
                
                // 从服务器获取用户的所有处方
                const response = await fetch(`/api/prescription/patient/${userId}/prescriptions`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    console.warn('⚠️ 获取处方列表失败:', response.status);
                    return;
                }
                
                const result = await response.json();
                console.log('📋 服务器返回的处方列表:', result);
                
                if (result.success && result.prescriptions && result.prescriptions.length > 0) {
                    const allPrescriptions = result.prescriptions;
                    
                    // 🎯 关键修改：只恢复最后一次问诊的处方
                    const latestSessionPrescriptions = getLatestConsultationPrescriptions(allPrescriptions);
                    let restoredCount = 0;
                    
                    // 🔑 确保消息容器已准备好
                    const messagesContainer = document.getElementById('messagesContainer') || document.getElementById('mobileMessagesContainer');
                    if (!messagesContainer) {
                        console.warn('⚠️ 消息容器未找到，延迟重试...');
                        setTimeout(() => restorePrescriptionStatesFromServer(), 1000);
                        return;
                    }
                    
                    console.log(`📊 处方统计: 总计 ${allPrescriptions.length} 个，恢复最新会话的 ${latestSessionPrescriptions.length} 个`);
                    console.log(`🔄 开始处理 ${latestSessionPrescriptions.length} 个最新会话处方的状态恢复...`);
                    
                    for (const prescription of latestSessionPrescriptions) {
                        const prescriptionId = prescription.id;
                        const status = prescription.status;
                        const paymentStatus = prescription.payment_status;
                        
                        console.log(`🔄 处理处方ID ${prescriptionId}: status=${status}, payment=${paymentStatus}`);
                        
                        // 根据状态恢复处方显示
                        if (paymentStatus === 'paid' && status === 'pending_review') {
                            // 已支付但等待审核：显示等待审核状态
                            console.log(`📋 开始恢复等待审核状态: ${prescriptionId}`);
                            
                            // 先检查是否已经有这个处方的消息
                            const existingMsg = messagesContainer.querySelector(`[data-prescription-id="${prescriptionId}"]`);
                            if (!existingMsg) {
                                // 创建一个新的AI消息来显示处方状态
                                const messageHtml = `
                                        <div class="message ai" data-prescription-id="${prescriptionId}" data-prescription-status="pending_review">
                                            <div class="message-avatar">🤖</div>
                                            <div class="message-content">
                                                <div class="message-text">
                                                    <div class="prescription-review-waiting" style="padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border-left: 4px solid #f59e0b; margin: 15px 0;">
                                                        <div style="text-align: center; margin-bottom: 15px;">
                                                            <div style="font-size: 2em; margin-bottom: 10px;">⏳</div>
                                                            <h3 style="color: #92400e; margin: 0; font-size: 18px;">处方等待医生审核中</h3>
                                                        </div>
                                                        
                                                        <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; margin: 10px 0;">
                                                            <p style="margin: 0; color: #78350f; font-size: 14px; line-height: 1.6;">
                                                                ✅ <strong>支付已完成</strong><br>
                                                                🔍 处方正在由专业医生审核中<br>
                                                                📋 审核完成后您将收到通知<br>
                                                                💊 审核通过后即可配药
                                                            </p>
                                                        </div>
                                                        
                                                        <div style="text-align: center; margin-top: 15px;">
                                                            <button onclick="checkPrescriptionStatus('${prescriptionId}')" 
                                                                    style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                                🔍 查看审核状态
                                                            </button>
                                                        </div>
                                                        
                                                        <div style="font-size: 12px; color: #92400e; text-align: center; margin-top: 10px; opacity: 0.8;">
                                                            处方ID: ${prescriptionId}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                `;
                                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                                console.log(`✅ 创建了新的等待审核消息: ${prescriptionId}`);
                            } else {
                                // 更新现有消息
                                updatePrescriptionToReviewStatus(prescriptionId);
                                console.log(`✅ 更新了现有消息的等待审核状态: ${prescriptionId}`);
                            }
                            
                            console.log(`⏳ 恢复等待审核状态: ${prescriptionId}`);
                            restoredCount++;
                        } else if (status === 'doctor_approved' || status === 'doctor_modified') {
                            // 医生已审核完成：显示最终处方
                            console.log(`📋 开始恢复已审核状态: ${prescriptionId}`);
                            
                            // 先检查是否已经有这个处方的消息
                            const existingMsg = messagesContainer.querySelector(`[data-prescription-id="${prescriptionId}"]`);
                            if (!existingMsg) {
                                // 创建一个新的AI消息来显示审核完成状态
                                const finalPrescription = prescription.doctor_prescription || prescription.ai_prescription;
                                const messageHtml = `
                                        <div class="message ai" data-prescription-id="${prescriptionId}" data-prescription-status="approved">
                                            <div class="message-avatar">🤖</div>
                                            <div class="message-content">
                                                <div class="message-text">
                                                    <div class="prescription-approved" style="padding: 20px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 12px; border-left: 4px solid #22c55e; margin: 15px 0;">
                                                        <div style="text-align: center; margin-bottom: 15px;">
                                                            <div style="font-size: 2em; margin-bottom: 10px;">✅</div>
                                                            <h3 style="color: #15803d; margin: 0; font-size: 18px;">医生审核通过</h3>
                                                        </div>
                                                        
                                                        <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; margin: 15px 0;">
                                                            <div style="color: #15803d; font-size: 16px; font-weight: 600; margin-bottom: 15px;">
                                                                审核通过的处方：
                                                            </div>
                                                            <div style="color: #374151; line-height: 1.6; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                                                                ${finalPrescription}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style="text-align: center; margin-top: 15px;">
                                                            <div style="color: #059669; font-size: 14px; margin-bottom: 10px;">
                                                                ✅ 医生审核已完成<br>
                                                                💊 您可以凭此处方配药
                                                            </div>
                                                            ${prescription.doctor_notes ? `<div style="color: #059669; font-size: 12px; margin-top: 10px; opacity: 0.8;">医生备注：${prescription.doctor_notes}</div>` : ''}
                                                        </div>
                                                        
                                                        <div style="font-size: 12px; color: #059669; text-align: center; margin-top: 10px;">
                                                            处方ID: ${prescriptionId} | 状态: ${status === 'doctor_modified' ? '医生已调整' : '审核通过'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                                    console.log(`✅ 创建了新的审核完成消息: ${prescriptionId}`);
                                } else {
                                    // 更新现有消息为审核完成状态
                                    await markPrescriptionAsCompleted(prescriptionId, {
                                        final_prescription: prescription.doctor_prescription || prescription.ai_prescription,
                                        doctor_notes: prescription.doctor_notes,
                                        is_reviewed: true,
                                        status: status
                                    });
                                    console.log(`✅ 更新了现有消息的审核完成状态: ${prescriptionId}`);
                                }
                            }
                            
                            console.log(`✅ 恢复已审核状态: ${prescriptionId}`);
                            restoredCount++;
                        }
                    }
                    
                    if (restoredCount > 0) {
                        showMessage(`✅ 已从云端恢复 ${restoredCount} 个处方状态`, 'success');
                        console.log(`✅ 总共恢复了 ${restoredCount} 个处方状态`);
                    } else {
                        console.log('📝 没有需要恢复的处方状态');
                    }
                } else {
                    console.log('📝 用户暂无处方记录');
                }
                
            } catch (error) {
                console.error('❌ 从服务器恢复处方状态失败:', error);
                // 🔑 移除降级到本地的逻辑，避免混乱
                // console.log('🔄 降级到本地恢复方式...');
                // restoreAllPendingPrescriptions();
            }
        }
        
        // 🔑 新增：处方状态云端同步函数
        async function syncPrescriptionStatusToServer(prescriptionId, status, additionalData = {}) {
            try {
                console.log(`🌐 同步处方状态到服务器: ID=${prescriptionId}, status=${status}`);
                
                // 这里可以调用服务器API同步状态
                // 暂时只做日志记录，稍后实现具体的同步逻辑
                console.log('📡 处方状态同步数据:', { prescriptionId, status, ...additionalData });
                
                return true;
            } catch (error) {
                console.error('❌ 同步处方状态到服务器失败:', error);
                return false;
            }
        }
    </script>
</body>
</html>