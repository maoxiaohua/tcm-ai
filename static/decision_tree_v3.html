<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å†³ç­–æ ‘ç”Ÿæˆå™¨ V3 - åˆ†æ”¯è·¯å¾„è®¾è®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .main-content {
            padding: 30px;
        }

        /* åˆ†æ”¯è·¯å¾„å®¹å™¨ */
        .decision-paths {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .path-container {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .path-container:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .path-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .path-id {
            background: #4f46e5;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .path-actions {
            display: flex;
            gap: 8px;
        }

        .path-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .path-btn.edit {
            background: #f0f9ff;
            color: #1e40af;
        }

        .path-btn.delete {
            background: #fef2f2;
            color: #dc2626;
        }

        /* æµç¨‹æ­¥éª¤ */
        .path-flow {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .flow-step {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-node {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            text-align: center;
            min-width: 80px;
            position: relative;
        }

        .step-node.symptom { background: #fef3c7; border-color: #f59e0b; }
        .step-node.condition { background: #e0f2fe; border-color: #0ea5e9; }
        .step-node.diagnosis { background: #dcfce7; border-color: #22c55e; }
        .step-node.treatment { background: #fce7f3; border-color: #ec4899; }
        .step-node.formula { background: #f3e8ff; border-color: #a855f7; }

        .flow-arrow {
            color: #6b7280;
            font-size: 16px;
            font-weight: bold;
        }

        .condition-label {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            color: #374151;
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .condition-label.positive { background: #dcfce7; border-color: #22c55e; color: #166534; }
        .condition-label.negative { background: #fee2e2; border-color: #ef4444; color: #991b1b; }

        /* å¿«é€Ÿæ·»åŠ åˆ†æ”¯ */
        .quick-add-section {
            background: #f0f9ff;
            border: 2px dashed #3b82f6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-add-section:hover {
            background: #dbeafe;
            border-color: #2563eb;
        }

        .quick-add-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
        }

        /* åˆ†æ”¯ç¼–è¾‘è¡¨å• */
        .branch-edit-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .branch-edit-form {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .form-section-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .step-input-group {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }

        .step-input {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
        }

        .condition-quick-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 5px;
            margin-top: 10px;
        }

        .condition-option {
            padding: 4px 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 11px;
            transition: all 0.2s;
        }

        .condition-option:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
        }

        /* ç—‡çŠ¶åŒ¹é…é¢„è§ˆ */
        .symptom-match-preview {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .match-example {
            font-size: 12px;
            color: #1e40af;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ³ æ™ºèƒ½å†³ç­–æ ‘ç”Ÿæˆå™¨ V3</h1>
            <p>åˆ†æ”¯è·¯å¾„è®¾è®¡ Â· ä¸é—®è¯Šç³»ç»Ÿæ·±åº¦é›†æˆ Â· ä¸€é”®ç¼–è¾‘è¡¥å……</p>
        </div>

        <div class="main-content">
            <!-- ç–¾ç—…åŸºæœ¬ä¿¡æ¯ -->
            <div class="form-section">
                <div class="form-section-title">ğŸ¯ ç–¾ç—…åŸºæœ¬ä¿¡æ¯</div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #374151;">ç–¾ç—…åç§°</label>
                        <input type="text" id="diseaseName" class="step-input" placeholder="å¦‚ï¼šå¤±çœ ã€èƒƒç—›ã€å¤´ç—›">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #374151;">åŒ»ç”Ÿç®€è¦æ€è·¯</label>
                        <input type="text" id="doctorThought" class="step-input" placeholder="ç®€è¿°è¯Šç–—æ€è·¯ï¼ŒAIå°†è‡ªåŠ¨ç”Ÿæˆåˆ†æ”¯è·¯å¾„">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="quick-add-btn" onclick="generateInitialPaths()">
                        ğŸš€ AIç”Ÿæˆåˆå§‹è·¯å¾„
                    </button>
                    <button class="quick-add-btn" style="background: #059669;" onclick="loadExampleTree()">
                        ğŸ“‹ åŠ è½½ç¤ºä¾‹æ¨¡æ¿
                    </button>
                    <button class="quick-add-btn" style="background: #7c3aed;" onclick="viewIntegrationDemo()">
                        ğŸ”— æŸ¥çœ‹é›†æˆæ¼”ç¤º
                    </button>
                    <button class="quick-add-btn" style="background: #dc2626;" onclick="openVisualBuilder()">
                        ğŸ¨ å¯è§†åŒ–æ„å»ºå™¨
                    </button>
                </div>
            </div>

            <!-- å†³ç­–è·¯å¾„å±•ç¤º -->
            <div class="decision-paths" id="decisionPaths">
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    <p>ğŸ“ è¯·å…ˆè¾“å…¥ç–¾ç—…ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»"AIç”Ÿæˆåˆå§‹è·¯å¾„"</p>
                    <p style="font-size: 12px; margin-top: 10px;">æˆ–è€…ç‚¹å‡»"åŠ è½½ç¤ºä¾‹æ¨¡æ¿"æŸ¥çœ‹æ•ˆæœ</p>
                </div>
            </div>

            <!-- å¿«é€Ÿæ·»åŠ æ–°è·¯å¾„ -->
            <div class="quick-add-section" onclick="showAddPathModal()">
                <div style="font-size: 18px; margin-bottom: 5px;">â•</div>
                <div style="font-weight: 600; color: #1e40af;">å¿«é€Ÿæ·»åŠ æ–°çš„è¯Šç–—è·¯å¾„</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    ç‚¹å‡»åˆ›å»ºï¼šä¸»è¯ â†’ åˆ¤æ–­æ¡ä»¶ â†’ è¾¨è¯ â†’ æ²»æ³• â†’ æ–¹è¯
                </div>
            </div>

            <!-- ä¸é—®è¯Šç³»ç»Ÿé›†æˆé¢„è§ˆ -->
            <div class="symptom-match-preview" id="symptomMatchPreview" style="display: none;">
                <h4 style="color: #1e40af; margin-bottom: 10px;">ğŸ”— é—®è¯Šé›†æˆé¢„è§ˆ</h4>
                <div class="match-example">
                    å½“æ‚£è€…æè¿°"å¤±çœ å¤šæ¢¦ï¼Œå¿ƒçƒ¦ï¼ŒèˆŒçº¢è‹”é»„"æ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŒ¹é…åˆ°è·¯å¾„2ï¼Œæ¨è"é»„è¿é˜¿èƒ¶æ±¤"
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button class="quick-add-btn" onclick="saveDecisionTree()" style="background: #059669;">
                        ğŸ’¾ ä¿å­˜å†³ç­–æ ‘åˆ°ç³»ç»Ÿ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†æ”¯è·¯å¾„ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="branch-edit-modal" id="branchEditModal">
        <div class="branch-edit-form">
            <h3 style="margin: 0 0 20px 0; color: #2d5aa0;">âœ¨ åˆ›å»ºè¯Šç–—è·¯å¾„</h3>
            
            <!-- è·¯å¾„æ­¥éª¤æ„å»º -->
            <div class="form-section">
                <div class="form-section-title">ğŸ›¤ï¸ è¯Šç–—æ­¥éª¤æ„å»º</div>
                
                <!-- æ­¥éª¤1ï¼šä¸»è¯ -->
                <div class="step-input-group">
                    <label style="font-size: 12px; color: #6b7280;">ä¸»è¯</label>
                    <input type="text" class="step-input" id="mainSymptom" placeholder="ä¸»è¦ç–¾ç—…æˆ–ç—‡çŠ¶">
                    <span style="font-size: 12px; color: #6b7280;">èµ·ç‚¹</span>
                </div>
                
                <!-- æ­¥éª¤2ï¼šåˆ¤æ–­æ¡ä»¶ (æ”¯æŒå¤šæ¡ä»¶) -->
                <div style="grid-column: 1 / -1; margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #6b7280; margin-bottom: 8px; display: block;">åˆ¤æ–­æ¡ä»¶ (æ”¯æŒå¤šæ¡ä»¶ç»„åˆ)</label>
                    
                    <div id="multiConditionsContainer">
                        <div class="multi-condition-item" data-index="0">
                            <input type="text" class="step-input" style="flex: 1;" placeholder="å¦‚ï¼šèˆŒçº¢è‹”åš" id="condition_0">
                            <select class="step-input" style="width: 80px;" id="result_0">
                                <option value="true">æ˜¯ âœ“</option>
                                <option value="false">å¦ âœ—</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button type="button" onclick="addConditionItem()" 
                                style="flex: 1; padding: 6px; background: #dbeafe; color: #2563eb; border: 1px solid #3b82f6; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            â• æ·»åŠ æ¡ä»¶
                        </button>
                        <select id="multiConditionLogic" style="width: 80px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 8px;">
                        <div style="padding: 4px 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 11px;" onclick="setConditionTemplate('èˆŒçº¢è‹”åš')">èˆŒçº¢è‹”åš</div>
                        <div style="padding: 4px 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 11px;" onclick="setConditionTemplate('è„‰è±¡æ»‘æ•°')">è„‰è±¡æ»‘æ•°</div>
                        <div style="padding: 4px 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 11px;" onclick="setConditionTemplate('é¢è‰²èé»„')">é¢è‰²èé»„</div>
                        <div style="padding: 4px 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 11px;" onclick="setConditionTemplate('ç–¼ç—›éšéš')">ç–¼ç—›éšéš</div>
                        <div style="padding: 4px 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 11px;" onclick="setConditionTemplate('å£å¹²å£è‹¦')">å£å¹²å£è‹¦</div>
                        <div style="padding: 4px 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 11px;" onclick="setConditionTemplate('å¤§ä¾¿å¹²ç»“')">å¤§ä¾¿å¹²ç»“</div>
                    </div>
                    
                    <div style="margin-top: 8px; padding: 6px; background: #f0f9ff; border-radius: 4px; font-size: 11px; color: #1e40af;">
                        ğŸ’¡ ç¤ºä¾‹ï¼šèˆŒçº¢ AND è‹”é»„ = åŒæ—¶æ»¡è¶³ï¼›è„‰æ•° OR è„‰æ»‘ = æ»¡è¶³å…¶ä¸€
                    </div>
                </div>
                
                <!-- å¸¸ç”¨æ¡ä»¶å¿«é€‰ -->
                <div class="condition-quick-select">
                    <div class="condition-option" onclick="setCondition('èˆŒçº¢è‹”åš')">èˆŒçº¢è‹”åš</div>
                    <div class="condition-option" onclick="setCondition('èˆŒæ·¡è‹”ç™½')">èˆŒæ·¡è‹”ç™½</div>
                    <div class="condition-option" onclick="setCondition('è„‰è±¡æ»‘æ•°')">è„‰è±¡æ»‘æ•°</div>
                    <div class="condition-option" onclick="setCondition('è„‰è±¡æ²‰ç»†')">è„‰è±¡æ²‰ç»†</div>
                    <div class="condition-option" onclick="setCondition('é¢è‰²èé»„')">é¢è‰²èé»„</div>
                    <div class="condition-option" onclick="setCondition('é¢çº¢ç›®èµ¤')">é¢çº¢ç›®èµ¤</div>
                    <div class="condition-option" onclick="setCondition('ç–¼ç—›å‰§çƒˆ')">ç–¼ç—›å‰§çƒˆ</div>
                    <div class="condition-option" onclick="setCondition('ç–¼ç—›éšéš')">ç–¼ç—›éšéš</div>
                    <div class="condition-option" onclick="setCondition('å¤§ä¾¿å¹²ç»“')">å¤§ä¾¿å¹²ç»“</div>
                    <div class="condition-option" onclick="setCondition('å¤§ä¾¿æºè–„')">å¤§ä¾¿æºè–„</div>
                    <div class="condition-option" onclick="setCondition('å°ä¾¿çŸ­èµ¤')">å°ä¾¿çŸ­èµ¤</div>
                    <div class="condition-option" onclick="setCondition('å°ä¾¿æ¸…é•¿')">å°ä¾¿æ¸…é•¿</div>
                </div>
                
                <!-- æ­¥éª¤3ï¼šè¾¨è¯åˆ†æ -->
                <div class="step-input-group">
                    <label style="font-size: 12px; color: #6b7280;">è¾¨è¯ç»“æœ</label>
                    <input type="text" class="step-input" id="diagnosisResult" placeholder="å¦‚ï¼šå¿ƒç«æ—ºç››">
                    <span style="font-size: 12px; color: #6b7280;">è¯å‹</span>
                </div>
                
                <!-- æ­¥éª¤4ï¼šæ²»æ³• -->
                <div class="step-input-group">
                    <label style="font-size: 12px; color: #6b7280;">æ²»ç–—æ–¹æ³•</label>
                    <input type="text" class="step-input" id="treatmentMethod" placeholder="å¦‚ï¼šæ¸…å¿ƒç«ã€å…»å¿ƒç¥">
                    <span style="font-size: 12px; color: #6b7280;">æ²»æ³•</span>
                </div>
                
                <!-- æ­¥éª¤5ï¼šæ–¹è¯ -->
                <div class="step-input-group">
                    <label style="font-size: 12px; color: #6b7280;">æ¨èæ–¹å‰‚</label>
                    <input type="text" class="step-input" id="recommendedFormula" placeholder="å¦‚ï¼šé»„è¿é˜¿èƒ¶æ±¤">
                    <span style="font-size: 12px; color: #6b7280;">ç»ˆç‚¹</span>
                </div>
            </div>

            <!-- ç—‡çŠ¶åŒ¹é…å…³é”®è¯ -->
            <div class="form-section">
                <div class="form-section-title">ğŸ” ç—‡çŠ¶åŒ¹é…å…³é”®è¯</div>
                <textarea class="step-input" id="symptomKeywords" 
                          placeholder="è¾“å…¥æ‚£è€…å¯èƒ½æè¿°çš„ç—‡çŠ¶å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼š&#10;å¤±çœ ï¼Œå¤šæ¢¦ï¼Œå¿ƒçƒ¦ï¼Œå£å¹²ï¼ŒèˆŒçº¢ï¼Œè‹”é»„" 
                          rows="3" style="width: 100%;"></textarea>
                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    è¿™äº›å…³é”®è¯ç”¨äºé—®è¯Šæ—¶è‡ªåŠ¨åŒ¹é…åˆ°è¯¥è·¯å¾„
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="quick-add-btn" onclick="confirmAddPath()" style="flex: 1;">
                    âœ… æ·»åŠ è·¯å¾„
                </button>
                <button class="quick-add-btn" onclick="closeBranchModal()" 
                        style="flex: 1; background: #6b7280;">
                    âŒ å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        let decisionPaths = [];
        let editingPathIndex = -1;

        // åŠ è½½ç¤ºä¾‹å†³ç­–æ ‘
        function loadExampleTree() {
            decisionPaths = [
                {
                    id: 'path_1',
                    steps: [
                        { type: 'symptom', content: 'å¤±çœ ', condition: null },
                        { type: 'condition', content: 'èˆŒçº¢è‹”é»„', result: true },
                        { type: 'diagnosis', content: 'å¿ƒç«æ—ºç››', condition: null },
                        { type: 'treatment', content: 'æ¸…å¿ƒç«', condition: null },
                        { type: 'formula', content: 'é»„è¿é˜¿èƒ¶æ±¤', condition: null }
                    ],
                    keywords: ['å¤±çœ ', 'å¤šæ¢¦', 'å¿ƒçƒ¦', 'å£å¹²', 'èˆŒçº¢', 'è‹”é»„'],
                    created_by: 'ç¤ºä¾‹åŒ»ç”Ÿ'
                },
                {
                    id: 'path_2', 
                    steps: [
                        { type: 'symptom', content: 'å¤±çœ ', condition: null },
                        { type: 'condition', content: 'é¢è‰²èé»„', result: true },
                        { type: 'diagnosis', content: 'å¿ƒè„¾ä¸¤è™š', condition: null },
                        { type: 'treatment', content: 'è¡¥ç›Šå¿ƒè„¾', condition: null },
                        { type: 'formula', content: 'å½’è„¾æ±¤', condition: null }
                    ],
                    keywords: ['å¤±çœ ', 'å¿ƒæ‚¸', 'å¥å¿˜', 'é¢è‰²èé»„', 'èˆŒæ·¡', 'è„‰å¼±'],
                    created_by: 'ç¤ºä¾‹åŒ»ç”Ÿ'
                },
                {
                    id: 'path_3',
                    steps: [
                        { type: 'symptom', content: 'å¤±çœ ', condition: null },
                        { type: 'condition', content: 'èƒ¸èƒèƒ€æ»¡', result: true },
                        { type: 'diagnosis', content: 'è‚éƒåŒ–ç«', condition: null },
                        { type: 'treatment', content: 'ç–è‚è§£éƒ', condition: null },
                        { type: 'formula', content: 'é€é¥æ•£åŠ å‡', condition: null }
                    ],
                    keywords: ['å¤±çœ ', 'æ˜“æ€’', 'èƒ¸èƒèƒ€æ»¡', 'å£è‹¦', 'è„‰å¼¦'],
                    created_by: 'ç¤ºä¾‹åŒ»ç”Ÿ'
                }
            ];
            
            renderDecisionPaths();
            showSymptomMatchPreview();
        }

        // æ¸²æŸ“å†³ç­–è·¯å¾„
        function renderDecisionPaths() {
            const container = document.getElementById('decisionPaths');
            
            if (decisionPaths.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 40px;">
                        <p>ğŸ“ æš‚æ— å†³ç­–è·¯å¾„ï¼Œè¯·æ·»åŠ æ–°è·¯å¾„</p>
                    </div>`;
                return;
            }
            
            let html = '<div style="margin-bottom: 20px;"><h3 style="color: #1e40af;">ğŸ¯ è¯Šç–—è·¯å¾„å›¾</h3></div>';
            
            decisionPaths.forEach((path, index) => {
                html += `
                    <div class="path-container">
                        <div class="path-header">
                            <div class="path-id">è·¯å¾„ ${index + 1}</div>
                            <div class="path-actions">
                                <button class="path-btn edit" onclick="editPath(${index})">âœï¸ ç¼–è¾‘</button>
                                <button class="path-btn delete" onclick="deletePath(${index})">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                        
                        <div class="path-flow">
                            ${generatePathFlowHTML(path.steps)}
                        </div>
                        
                        <div style="margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 12px;">
                            <strong>è§¦å‘å…³é”®è¯ï¼š</strong> ${path.keywords.join(', ')}
                        </div>
                    </div>`;
            });
            
            container.innerHTML = html;
        }

        // ç”Ÿæˆè·¯å¾„æµç¨‹HTML
        function generatePathFlowHTML(steps) {
            let html = '';
            
            steps.forEach((step, index) => {
                if (index > 0) {
                    html += '<div class="flow-arrow">â†’</div>';
                }
                
                html += `<div class="flow-step">`;
                
                if (step.type === 'condition') {
                    const conditionClass = step.result ? 'positive' : 'negative';
                    const conditionSymbol = step.result ? ' âœ“' : ' âœ—';
                    html += `
                        <div class="step-node condition">
                            <div class="condition-label ${conditionClass}">åˆ¤æ–­æ¡ä»¶</div>
                            ${step.content}${conditionSymbol}
                        </div>`;
                } else {
                    html += `<div class="step-node ${step.type}">${step.content}</div>`;
                }
                
                html += '</div>';
            });
            
            return html;
        }

        // æ˜¾ç¤ºæ·»åŠ è·¯å¾„æ¨¡æ€æ¡†
        function showAddPathModal() {
            editingPathIndex = -1;
            clearFormInputs();
            document.getElementById('branchEditModal').style.display = 'flex';
        }

        // å¤šæ¡ä»¶ç®¡ç†
        let conditionCounter = 1;

        // æ·»åŠ æ¡ä»¶é¡¹
        function addConditionItem() {
            const container = document.getElementById('multiConditionsContainer');
            const newIndex = conditionCounter++;
            
            const conditionHTML = `
                <div class="multi-condition-item" data-index="${newIndex}" style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                    <span style="font-size: 11px; color: #6b7280; width: 30px;">${document.getElementById('multiConditionLogic').value}</span>
                    <input type="text" class="step-input" style="flex: 1;" placeholder="åˆ¤æ–­æ¡ä»¶" id="condition_${newIndex}">
                    <select class="step-input" style="width: 80px;" id="result_${newIndex}">
                        <option value="true">æ˜¯ âœ“</option>
                        <option value="false">å¦ âœ—</option>
                    </select>
                    <button type="button" onclick="removeConditionItem(${newIndex})" 
                            style="width: 24px; height: 24px; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœ•</button>
                </div>`;
            
            container.insertAdjacentHTML('beforeend', conditionHTML);
        }

        // ç§»é™¤æ¡ä»¶é¡¹
        function removeConditionItem(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.remove();
            }
        }

        // è®¾ç½®æ¡ä»¶æ¨¡æ¿
        function setConditionTemplate(template) {
            // è·å–å½“å‰å¯ç”¨çš„æ¡ä»¶è¾“å…¥æ¡†
            const conditionInputs = document.querySelectorAll('#multiConditionsContainer input[id^="condition_"]');
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºçš„æˆ–è€…æœ€åä¸€ä¸ªè¾“å…¥æ¡†
            let targetInput = null;
            for (let input of conditionInputs) {
                if (!input.value.trim()) {
                    targetInput = input;
                    break;
                }
            }
            
            if (!targetInput && conditionInputs.length > 0) {
                targetInput = conditionInputs[conditionInputs.length - 1];
            }
            
            if (targetInput) {
                targetInput.value = template;
            }
        }

        // æ”¶é›†å¤šæ¡ä»¶æ•°æ®
        function collectMultiConditions() {
            const conditions = [];
            const logic = document.getElementById('multiConditionLogic').value;
            
            const conditionInputs = document.querySelectorAll('#multiConditionsContainer input[id^="condition_"]');
            const resultSelects = document.querySelectorAll('#multiConditionsContainer select[id^="result_"]');
            
            for (let i = 0; i < conditionInputs.length; i++) {
                const conditionText = conditionInputs[i].value.trim();
                if (conditionText) {
                    const resultValue = resultSelects[i].value;
                    conditions.push({
                        text: conditionText,
                        result: resultValue,
                        operator: i === 0 ? null : logic
                    });
                }
            }
            
            return conditions;
        }

        // æ ¼å¼åŒ–å¤šæ¡ä»¶ä¸ºæ˜¾ç¤ºæ–‡æœ¬
        function formatMultiConditionsText(conditions) {
            if (!conditions || conditions.length === 0) return '';
            
            return conditions.map((cond, index) => {
                const prefix = index === 0 ? '' : ` ${cond.operator} `;
                const symbol = cond.result === 'true' ? 'âœ“' : 'âœ—';
                return `${prefix}${cond.text}${symbol}`;
            }).join('');
        }

        // ç¡®è®¤æ·»åŠ è·¯å¾„
        function confirmAddPath() {
            const mainSymptom = document.getElementById('mainSymptom').value.trim();
            const multiConditions = collectMultiConditions();
            const diagnosisResult = document.getElementById('diagnosisResult').value.trim();
            const treatmentMethod = document.getElementById('treatmentMethod').value.trim();
            const recommendedFormula = document.getElementById('recommendedFormula').value.trim();
            const symptomKeywords = document.getElementById('symptomKeywords').value.trim();

            if (!mainSymptom || multiConditions.length === 0 || !diagnosisResult || !recommendedFormula) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è·¯å¾„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è‡³å°‘ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶');
                return;
            }

            // æ ¼å¼åŒ–å¤šæ¡ä»¶ä¸ºå±•ç¤ºæ–‡æœ¬
            const conditionsText = formatMultiConditionsText(multiConditions);

            const newPath = {
                id: `path_${Date.now()}`,
                steps: [
                    { type: 'symptom', content: mainSymptom, condition: null },
                    { type: 'condition', content: conditionsText, result: true, conditions: multiConditions },
                    { type: 'diagnosis', content: diagnosisResult, condition: null },
                    { type: 'treatment', content: treatmentMethod || 'å¯¹ç—‡æ²»ç–—', condition: null },
                    { type: 'formula', content: recommendedFormula, condition: null }
                ],
                keywords: symptomKeywords ? symptomKeywords.split(/[,ï¼Œ\s]+/).filter(k => k.trim()) : [],
                created_by: 'å½“å‰åŒ»ç”Ÿ'
            };

            if (editingPathIndex >= 0) {
                decisionPaths[editingPathIndex] = newPath;
            } else {
                decisionPaths.push(newPath);
            }

            renderDecisionPaths();
            closeBranchModal();
            showSymptomMatchPreview();
        }

        // ç¼–è¾‘è·¯å¾„
        function editPath(index) {
            editingPathIndex = index;
            const path = decisionPaths[index];
            
            // å¡«å……è¡¨å•
            document.getElementById('mainSymptom').value = path.steps[0]?.content || '';
            document.getElementById('branchCondition').value = path.steps[1]?.content || '';
            document.getElementById('conditionResult').value = path.steps[1]?.result ? 'true' : 'false';
            document.getElementById('diagnosisResult').value = path.steps[2]?.content || '';
            document.getElementById('treatmentMethod').value = path.steps[3]?.content || '';
            document.getElementById('recommendedFormula').value = path.steps[4]?.content || '';
            document.getElementById('symptomKeywords').value = path.keywords.join(', ');
            
            document.getElementById('branchEditModal').style.display = 'flex';
        }

        // åˆ é™¤è·¯å¾„
        function deletePath(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯Šç–—è·¯å¾„å—ï¼Ÿ')) {
                decisionPaths.splice(index, 1);
                renderDecisionPaths();
                if (decisionPaths.length === 0) {
                    hideSymptomMatchPreview();
                }
            }
        }

        // ç”Ÿæˆåˆå§‹è·¯å¾„ï¼ˆAIè°ƒç”¨ï¼‰
        async function generateInitialPaths() {
            const diseaseName = document.getElementById('diseaseName').value.trim();
            const doctorThought = document.getElementById('doctorThought').value.trim();

            if (!diseaseName) {
                alert('è¯·è¾“å…¥ç–¾ç—…åç§°');
                return;
            }

            try {
                const response = await fetch('/api/generate_paths_from_thinking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName,
                        thinking_process: doctorThought || `åŒ»ç”Ÿå¯¹${diseaseName}çš„åŸºæœ¬è¯Šç–—æ€è·¯`
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data.paths) {
                        decisionPaths = data.data.paths;
                        renderDecisionPaths();
                        showSymptomMatchPreview();
                    } else {
                        throw new Error(data.message || 'AIç”Ÿæˆå¤±è´¥');
                    }
                } else {
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                }
            } catch (error) {
                console.error('AIç”Ÿæˆå¤±è´¥:', error);
                alert(`AIç”Ÿæˆå¤±è´¥ï¼š${error.message}\n\nè¯·æ‰‹åŠ¨æ·»åŠ è·¯å¾„æˆ–åŠ è½½ç¤ºä¾‹æ¨¡æ¿`);
            }
        }

        // æ˜¾ç¤ºç—‡çŠ¶åŒ¹é…é¢„è§ˆ
        function showSymptomMatchPreview() {
            if (decisionPaths.length > 0) {
                const preview = document.getElementById('symptomMatchPreview');
                preview.style.display = 'block';
                
                const example = decisionPaths[0];
                const matchText = `å½“æ‚£è€…æè¿°åŒ…å«"${example.keywords.slice(0,3).join('ã€')}"ç­‰å…³é”®è¯æ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŒ¹é…åˆ°"${example.steps[0].content} â†’ ${example.steps[2].content} â†’ ${example.steps[4].content}"è·¯å¾„`;
                
                preview.querySelector('.match-example').textContent = matchText;
            }
        }

        // éšè—ç—‡çŠ¶åŒ¹é…é¢„è§ˆ
        function hideSymptomMatchPreview() {
            document.getElementById('symptomMatchPreview').style.display = 'none';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeBranchModal() {
            document.getElementById('branchEditModal').style.display = 'none';
            clearFormInputs();
        }

        // æ¸…ç©ºè¡¨å•
        function clearFormInputs() {
            document.getElementById('mainSymptom').value = '';
            document.getElementById('diagnosisResult').value = '';
            document.getElementById('treatmentMethod').value = '';
            document.getElementById('recommendedFormula').value = '';
            document.getElementById('symptomKeywords').value = '';
            
            // é‡ç½®å¤šæ¡ä»¶ç¼–è¾‘å™¨
            const container = document.getElementById('multiConditionsContainer');
            container.innerHTML = `
                <div class="multi-condition-item" data-index="0">
                    <input type="text" class="step-input" style="flex: 1;" placeholder="å¦‚ï¼šèˆŒçº¢è‹”åš" id="condition_0">
                    <select class="step-input" style="width: 80px;" id="result_0">
                        <option value="true">æ˜¯ âœ“</option>
                        <option value="false">å¦ âœ—</option>
                    </select>
                </div>`;
            conditionCounter = 1;
        }

        // ä¿å­˜å†³ç­–æ ‘åˆ°ç³»ç»Ÿ
        async function saveDecisionTree() {
            if (decisionPaths.length === 0) {
                alert('è¯·å…ˆåˆ›å»ºå†³ç­–è·¯å¾„');
                return;
            }

            const diseaseName = document.getElementById('diseaseName').value.trim();
            if (!diseaseName) {
                alert('è¯·è¾“å…¥ç–¾ç—…åç§°');
                return;
            }

            try {
                const response = await fetch('/api/save_decision_tree_v3', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        disease_name: diseaseName,
                        paths: decisionPaths,
                        integration_enabled: true
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`âœ… å†³ç­–æ ‘å·²ä¿å­˜ï¼\n\nå·²åˆ›å»º ${data.data.paths_count} æ¡è¯Šç–—è·¯å¾„\nç°åœ¨æ‚£è€…é—®è¯Šæ—¶å°†è‡ªåŠ¨åŒ¹é…è¿™äº›è·¯å¾„ã€‚\n\nğŸ”— ç‚¹å‡»å³ä¸Šè§’"æŸ¥çœ‹é›†æˆæ¼”ç¤º"æµ‹è¯•æ•ˆæœ`);
                } else {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æŸ¥çœ‹é›†æˆæ¼”ç¤º
        function viewIntegrationDemo() {
            window.open('/static/decision_tree_integration_demo.html', '_blank');
        }

        // æ‰“å¼€å¯è§†åŒ–æ„å»ºå™¨
        function openVisualBuilder() {
            window.open('/static/decision_tree_visual_builder.html', '_blank');
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ™ºèƒ½å†³ç­–æ ‘V3åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>