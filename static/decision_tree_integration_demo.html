<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>决策树与问诊集成演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #333;
            padding: 20px;
        }

        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .panel-title {
            color: #1e40af;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consultation-panel {
            border-left: 4px solid #3b82f6;
        }

        .decision-panel {
            border-left: 4px solid #059669;
        }

        /* 问诊界面 */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.doctor {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
            margin-left: auto;
            text-align: right;
        }

        .message.patient {
            background: #f0f9ff;
            border-left: 3px solid #06b6d4;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .symptom-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .send-btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* 决策树面板 */
        .path-match {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .match-confidence {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .decision-flow {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .flow-node {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        .flow-node.symptom { background: #fef3c7; border: 1px solid #f59e0b; }
        .flow-node.condition { background: #e0f2fe; border: 1px solid #0ea5e9; }
        .flow-node.diagnosis { background: #dcfce7; border: 1px solid #22c55e; }
        .flow-node.treatment { background: #fce7f3; border: 1px solid #ec4899; }
        .flow-node.formula { background: #f3e8ff; border: 1px solid #a855f7; }

        .flow-arrow {
            color: #6b7280;
            font-size: 14px;
        }

        .matched-keywords {
            background: #ecfdf5;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            color: #065f46;
        }

        .no-match {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            color: #991b1b;
        }

        /* 症状标签 */
        .symptom-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }

        .symptom-tag {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 11px;
            color: #1e40af;
        }

        .demo-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .demo-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .demo-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .demo-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body>
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; margin-bottom: 10px;">🩺 决策树与问诊集成演示</h1>
        <p style="color: #6b7280;">左侧模拟患者问诊，右侧实时显示匹配的决策路径和方剂推荐</p>
    </div>

    <div class="demo-container">
        <!-- 问诊面板 -->
        <div class="panel consultation-panel">
            <div class="panel-title">
                💬 模拟患者问诊
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="message doctor">
                    医生：您好，请描述一下您的主要症状？
                </div>
            </div>

            <div class="input-area">
                <input type="text" class="symptom-input" id="symptomInput" 
                       placeholder="输入症状，如：失眠多梦，心烦口干，舌红苔黄">
                <button class="send-btn" onclick="sendSymptom()">发送</button>
            </div>

            <div style="margin-top: 15px;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">💡 快速测试症状：</div>
                <div class="symptom-tags">
                    <div class="symptom-tag" onclick="quickTest('失眠多梦心烦口干舌红苔黄')">心火旺盛型失眠</div>
                    <div class="symptom-tag" onclick="quickTest('失眠健忘心悸面色萎黄舌淡脉弱')">心脾两虚型失眠</div>
                    <div class="symptom-tag" onclick="quickTest('失眠易怒胸胁胀满口苦脉弦')">肝郁化火型失眠</div>
                    <div class="symptom-tag" onclick="quickTest('胃痛隐隐喜温喜按舌淡苔白')">脾胃虚寒型胃痛</div>
                </div>
            </div>
        </div>

        <!-- 决策树匹配面板 -->
        <div class="panel decision-panel">
            <div class="panel-title">
                🌳 决策路径匹配
            </div>

            <div id="pathMatchResult">
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    📍 请在左侧输入症状，系统将自动匹配决策路径
                </div>
            </div>

            <div class="demo-actions">
                <button class="demo-btn primary" onclick="openDecisionTreeEditor()">
                    ✏️ 编辑决策树
                </button>
                <button class="demo-btn secondary" onclick="viewAllPaths()">
                    📊 查看所有路径
                </button>
            </div>
        </div>
    </div>

    <!-- 当前症状收集 -->
    <div style="max-width: 1200px; margin: 20px auto;">
        <div class="panel">
            <div class="panel-title">🔍 当前症状分析</div>
            <div id="currentSymptoms">
                <div style="color: #6b7280; font-style: italic;">等待患者描述症状...</div>
            </div>
        </div>
    </div>

    <script>
        let collectedSymptoms = [];
        let currentPaths = [];

        // 模拟的决策路径数据（实际应从后端加载）
        const sampleDecisionPaths = [
            {
                id: 'insomnia_heart_fire',
                steps: [
                    { type: 'symptom', content: '失眠' },
                    { type: 'condition', content: '舌红苔黄', result: true },
                    { type: 'diagnosis', content: '心火旺盛' },
                    { type: 'treatment', content: '清心火' },
                    { type: 'formula', content: '黄连阿胶汤' }
                ],
                keywords: ['失眠', '多梦', '心烦', '口干', '舌红', '苔黄', '脉数'],
                created_by: '张仲景'
            },
            {
                id: 'insomnia_heart_spleen_deficiency',
                steps: [
                    { type: 'symptom', content: '失眠' },
                    { type: 'condition', content: '面色萎黄', result: true },
                    { type: 'diagnosis', content: '心脾两虚' },
                    { type: 'treatment', content: '补益心脾' },
                    { type: 'formula', content: '归脾汤' }
                ],
                keywords: ['失眠', '健忘', '心悸', '面色萎黄', '舌淡', '脉弱'],
                created_by: '李东垣'
            },
            {
                id: 'stomach_pain_spleen_deficiency',
                steps: [
                    { type: 'symptom', content: '胃痛' },
                    { type: 'condition', content: '喜温喜按', result: true },
                    { type: 'diagnosis', content: '脾胃虚寒' },
                    { type: 'treatment', content: '温中健脾' },
                    { type: 'formula', content: '理中汤' }
                ],
                keywords: ['胃痛', '隐隐', '喜温', '喜按', '舌淡', '苔白', '脉缓'],
                created_by: '李东垣'
            }
        ];

        // 发送症状
        function sendSymptom() {
            const symptomText = document.getElementById('symptomInput').value.trim();
            if (!symptomText) return;

            // 添加到对话
            addMessage('patient', symptomText);

            // 清空输入框
            document.getElementById('symptomInput').value = '';

            // 解析症状并匹配路径
            parseAndMatchSymptoms(symptomText);
        }

        // 快速测试
        function quickTest(symptoms) {
            document.getElementById('symptomInput').value = symptoms;
            sendSymptom();
        }

        // 添加消息到对话
        function addMessage(sender, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = sender === 'doctor' ? `医生：${content}` : `患者：${content}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 解析症状并匹配路径
        async function parseAndMatchSymptoms(symptomText) {
            // 简单的症状提取（实际应该用NLP）
            const extractedSymptoms = extractSymptomsFromText(symptomText);
            collectedSymptoms = [...new Set([...collectedSymptoms, ...extractedSymptoms])];

            // 更新症状展示
            updateSymptomsDisplay();

            // 匹配决策路径
            try {
                const matchResult = await matchSymptomsToPaths(collectedSymptoms);
                displayPathMatch(matchResult);

                // 如果找到匹配，医生回复推荐方剂
                if (matchResult.matched_path) {
                    const formula = matchResult.recommended_formula;
                    const confidence = (matchResult.match_confidence * 100).toFixed(0);
                    addMessage('doctor', `根据您的症状，我建议使用"${formula}"（匹配度：${confidence}%）`);
                }
            } catch (error) {
                console.error('路径匹配失败:', error);
            }
        }

        // 从文本中提取症状
        function extractSymptomsFromText(text) {
            const symptoms = [];
            const symptomPatterns = [
                '失眠', '多梦', '心烦', '口干', '舌红', '苔黄', '脉数',
                '健忘', '心悸', '面色萎黄', '舌淡', '脉弱',
                '胃痛', '隐隐', '喜温', '喜按', '苔白', '脉缓',
                '易怒', '胸胁胀满', '口苦', '脉弦'
            ];

            symptomPatterns.forEach(pattern => {
                if (text.includes(pattern)) {
                    symptoms.push(pattern);
                }
            });

            return symptoms;
        }

        // 匹配症状到路径（模拟API调用）
        async function matchSymptomsToPaths(symptoms) {
            // 实际应该调用 /api/match_symptoms_to_paths
            return new Promise(resolve => {
                setTimeout(() => {
                    let bestMatch = null;
                    let bestScore = 0;

                    sampleDecisionPaths.forEach(path => {
                        const matchScore = calculateMatchScore(symptoms, path.keywords);
                        if (matchScore > bestScore) {
                            bestScore = matchScore;
                            bestMatch = path;
                        }
                    });

                    if (bestScore > 0.3) {
                        const formula = bestMatch.steps.find(s => s.type === 'formula')?.content;
                        resolve({
                            matched_path: bestMatch,
                            recommended_formula: formula,
                            match_confidence: bestScore,
                            matched_keywords: symptoms.filter(s => bestMatch.keywords.includes(s))
                        });
                    } else {
                        resolve({
                            matched_path: null,
                            alternative_paths: sampleDecisionPaths.slice(0, 2),
                            suggestion: "症状描述需要更详细"
                        });
                    }
                }, 500);
            });
        }

        // 计算匹配分数
        function calculateMatchScore(userSymptoms, pathKeywords) {
            const userSet = new Set(userSymptoms);
            const pathSet = new Set(pathKeywords);
            const intersection = new Set([...userSet].filter(x => pathSet.has(x)));
            return intersection.size / pathSet.size;
        }

        // 显示路径匹配结果
        function displayPathMatch(matchResult) {
            const container = document.getElementById('pathMatchResult');

            if (matchResult.matched_path) {
                const path = matchResult.matched_path;
                const confidence = (matchResult.match_confidence * 100).toFixed(0);

                container.innerHTML = `
                    <div class="path-match">
                        <div class="match-confidence">
                            🎯 匹配路径 (置信度: ${confidence}%) - 创建者: ${path.created_by}
                        </div>
                        
                        <div class="decision-flow">
                            ${path.steps.map((step, index) => {
                                let html = `<div class="flow-node ${step.type}">${step.content}</div>`;
                                if (index < path.steps.length - 1) {
                                    html += '<div class="flow-arrow">→</div>';
                                }
                                return html;
                            }).join('')}
                        </div>
                        
                        <div class="matched-keywords">
                            匹配关键词: ${matchResult.matched_keywords ? matchResult.matched_keywords.join(', ') : '无'}
                        </div>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="no-match">
                        <div style="margin-bottom: 10px;">⚠️ 暂未找到高度匹配的决策路径</div>
                        <div style="font-size: 12px;">${matchResult.suggestion}</div>
                        
                        ${matchResult.alternative_paths ? `
                            <div style="margin-top: 15px; text-align: left;">
                                <strong>参考路径：</strong>
                                ${matchResult.alternative_paths.map(path => {
                                    const formula = path.steps.find(s => s.type === 'formula')?.content;
                                    return `<div style="margin: 5px 0;">• ${formula} (${path.created_by})</div>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>`;
            }
        }

        // 更新症状展示
        function updateSymptomsDisplay() {
            const container = document.getElementById('currentSymptoms');
            
            if (collectedSymptoms.length === 0) {
                container.innerHTML = '<div style="color: #6b7280; font-style: italic;">等待患者描述症状...</div>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>已收集症状 (${collectedSymptoms.length}个)：</strong>
                </div>
                <div class="symptom-tags">
                    ${collectedSymptoms.map(symptom => 
                        `<div class="symptom-tag">${symptom}</div>`
                    ).join('')}
                </div>
                <div style="margin-top: 10px;">
                    <button class="demo-btn secondary" onclick="clearSymptoms()">🗑️ 清空症状</button>
                </div>`;
        }

        // 清空症状
        function clearSymptoms() {
            collectedSymptoms = [];
            updateSymptomsDisplay();
            document.getElementById('pathMatchResult').innerHTML = `
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    📍 请在左侧输入症状，系统将自动匹配决策路径
                </div>`;
        }

        // 打开决策树编辑器
        function openDecisionTreeEditor() {
            window.open('/static/decision_tree_v3.html', '_blank');
        }

        // 查看所有路径
        function viewAllPaths() {
            const pathsWindow = window.open('', '_blank');
            pathsWindow.document.write(`
                <html>
                    <head><title>所有决策路径</title></head>
                    <body style="font-family: sans-serif; padding: 20px;">
                        <h2>当前系统中的所有决策路径</h2>
                        ${sampleDecisionPaths.map((path, index) => {
                            const flowText = path.steps.map(s => s.content).join(' → ');
                            return `
                                <div style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px;">
                                    <strong>路径 ${index + 1}</strong> (创建者: ${path.created_by})<br>
                                    <div style="margin: 8px 0; color: #666;">${flowText}</div>
                                    <small>关键词: ${path.keywords.join(', ')}</small>
                                </div>`;
                        }).join('')}
                    </body>
                </html>
            `);
        }

        // 键盘事件
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('symptomInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendSymptom();
                }
            });
        });
    </script>
</body>
</html>