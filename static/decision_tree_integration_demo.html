<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†³ç­–æ ‘ä¸é—®è¯Šé›†æˆæ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #333;
            padding: 20px;
        }

        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .panel-title {
            color: #1e40af;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consultation-panel {
            border-left: 4px solid #3b82f6;
        }

        .decision-panel {
            border-left: 4px solid #059669;
        }

        /* é—®è¯Šç•Œé¢ */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.doctor {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
            margin-left: auto;
            text-align: right;
        }

        .message.patient {
            background: #f0f9ff;
            border-left: 3px solid #06b6d4;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .symptom-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .send-btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* å†³ç­–æ ‘é¢æ¿ */
        .path-match {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .match-confidence {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .decision-flow {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .flow-node {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        .flow-node.symptom { background: #fef3c7; border: 1px solid #f59e0b; }
        .flow-node.condition { background: #e0f2fe; border: 1px solid #0ea5e9; }
        .flow-node.diagnosis { background: #dcfce7; border: 1px solid #22c55e; }
        .flow-node.treatment { background: #fce7f3; border: 1px solid #ec4899; }
        .flow-node.formula { background: #f3e8ff; border: 1px solid #a855f7; }

        .flow-arrow {
            color: #6b7280;
            font-size: 14px;
        }

        .matched-keywords {
            background: #ecfdf5;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            color: #065f46;
        }

        .no-match {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            color: #991b1b;
        }

        /* ç—‡çŠ¶æ ‡ç­¾ */
        .symptom-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }

        .symptom-tag {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 11px;
            color: #1e40af;
        }

        .demo-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .demo-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .demo-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .demo-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body>
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; margin-bottom: 10px;">ğŸ©º å†³ç­–æ ‘ä¸é—®è¯Šé›†æˆæ¼”ç¤º</h1>
        <p style="color: #6b7280;">å·¦ä¾§æ¨¡æ‹Ÿæ‚£è€…é—®è¯Šï¼Œå³ä¾§å®æ—¶æ˜¾ç¤ºåŒ¹é…çš„å†³ç­–è·¯å¾„å’Œæ–¹å‰‚æ¨è</p>
    </div>

    <div class="demo-container">
        <!-- é—®è¯Šé¢æ¿ -->
        <div class="panel consultation-panel">
            <div class="panel-title">
                ğŸ’¬ æ¨¡æ‹Ÿæ‚£è€…é—®è¯Š
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="message doctor">
                    åŒ»ç”Ÿï¼šæ‚¨å¥½ï¼Œè¯·æè¿°ä¸€ä¸‹æ‚¨çš„ä¸»è¦ç—‡çŠ¶ï¼Ÿ
                </div>
            </div>

            <div class="input-area">
                <input type="text" class="symptom-input" id="symptomInput" 
                       placeholder="è¾“å…¥ç—‡çŠ¶ï¼Œå¦‚ï¼šå¤±çœ å¤šæ¢¦ï¼Œå¿ƒçƒ¦å£å¹²ï¼ŒèˆŒçº¢è‹”é»„">
                <button class="send-btn" onclick="sendSymptom()">å‘é€</button>
            </div>

            <div style="margin-top: 15px;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">ğŸ’¡ å¿«é€Ÿæµ‹è¯•ç—‡çŠ¶ï¼š</div>
                <div class="symptom-tags">
                    <div class="symptom-tag" onclick="quickTest('å¤±çœ å¤šæ¢¦å¿ƒçƒ¦å£å¹²èˆŒçº¢è‹”é»„')">å¿ƒç«æ—ºç››å‹å¤±çœ </div>
                    <div class="symptom-tag" onclick="quickTest('å¤±çœ å¥å¿˜å¿ƒæ‚¸é¢è‰²èé»„èˆŒæ·¡è„‰å¼±')">å¿ƒè„¾ä¸¤è™šå‹å¤±çœ </div>
                    <div class="symptom-tag" onclick="quickTest('å¤±çœ æ˜“æ€’èƒ¸èƒèƒ€æ»¡å£è‹¦è„‰å¼¦')">è‚éƒåŒ–ç«å‹å¤±çœ </div>
                    <div class="symptom-tag" onclick="quickTest('èƒƒç—›éšéšå–œæ¸©å–œæŒ‰èˆŒæ·¡è‹”ç™½')">è„¾èƒƒè™šå¯’å‹èƒƒç—›</div>
                </div>
            </div>
        </div>

        <!-- å†³ç­–æ ‘åŒ¹é…é¢æ¿ -->
        <div class="panel decision-panel">
            <div class="panel-title">
                ğŸŒ³ å†³ç­–è·¯å¾„åŒ¹é…
            </div>

            <div id="pathMatchResult">
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    ğŸ“ è¯·åœ¨å·¦ä¾§è¾“å…¥ç—‡çŠ¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŒ¹é…å†³ç­–è·¯å¾„
                </div>
            </div>

            <div class="demo-actions">
                <button class="demo-btn primary" onclick="openDecisionTreeEditor()">
                    âœï¸ ç¼–è¾‘å†³ç­–æ ‘
                </button>
                <button class="demo-btn secondary" onclick="viewAllPaths()">
                    ğŸ“Š æŸ¥çœ‹æ‰€æœ‰è·¯å¾„
                </button>
            </div>
        </div>
    </div>

    <!-- å½“å‰ç—‡çŠ¶æ”¶é›† -->
    <div style="max-width: 1200px; margin: 20px auto;">
        <div class="panel">
            <div class="panel-title">ğŸ” å½“å‰ç—‡çŠ¶åˆ†æ</div>
            <div id="currentSymptoms">
                <div style="color: #6b7280; font-style: italic;">ç­‰å¾…æ‚£è€…æè¿°ç—‡çŠ¶...</div>
            </div>
        </div>
    </div>

    <script>
        let collectedSymptoms = [];
        let currentPaths = [];

        // æ¨¡æ‹Ÿçš„å†³ç­–è·¯å¾„æ•°æ®ï¼ˆå®é™…åº”ä»åç«¯åŠ è½½ï¼‰
        const sampleDecisionPaths = [
            {
                id: 'insomnia_heart_fire',
                steps: [
                    { type: 'symptom', content: 'å¤±çœ ' },
                    { type: 'condition', content: 'èˆŒçº¢è‹”é»„', result: true },
                    { type: 'diagnosis', content: 'å¿ƒç«æ—ºç››' },
                    { type: 'treatment', content: 'æ¸…å¿ƒç«' },
                    { type: 'formula', content: 'é»„è¿é˜¿èƒ¶æ±¤' }
                ],
                keywords: ['å¤±çœ ', 'å¤šæ¢¦', 'å¿ƒçƒ¦', 'å£å¹²', 'èˆŒçº¢', 'è‹”é»„', 'è„‰æ•°'],
                created_by: 'å¼ ä»²æ™¯'
            },
            {
                id: 'insomnia_heart_spleen_deficiency',
                steps: [
                    { type: 'symptom', content: 'å¤±çœ ' },
                    { type: 'condition', content: 'é¢è‰²èé»„', result: true },
                    { type: 'diagnosis', content: 'å¿ƒè„¾ä¸¤è™š' },
                    { type: 'treatment', content: 'è¡¥ç›Šå¿ƒè„¾' },
                    { type: 'formula', content: 'å½’è„¾æ±¤' }
                ],
                keywords: ['å¤±çœ ', 'å¥å¿˜', 'å¿ƒæ‚¸', 'é¢è‰²èé»„', 'èˆŒæ·¡', 'è„‰å¼±'],
                created_by: 'æä¸œå£'
            },
            {
                id: 'stomach_pain_spleen_deficiency',
                steps: [
                    { type: 'symptom', content: 'èƒƒç—›' },
                    { type: 'condition', content: 'å–œæ¸©å–œæŒ‰', result: true },
                    { type: 'diagnosis', content: 'è„¾èƒƒè™šå¯’' },
                    { type: 'treatment', content: 'æ¸©ä¸­å¥è„¾' },
                    { type: 'formula', content: 'ç†ä¸­æ±¤' }
                ],
                keywords: ['èƒƒç—›', 'éšéš', 'å–œæ¸©', 'å–œæŒ‰', 'èˆŒæ·¡', 'è‹”ç™½', 'è„‰ç¼“'],
                created_by: 'æä¸œå£'
            }
        ];

        // å‘é€ç—‡çŠ¶
        function sendSymptom() {
            const symptomText = document.getElementById('symptomInput').value.trim();
            if (!symptomText) return;

            // æ·»åŠ åˆ°å¯¹è¯
            addMessage('patient', symptomText);

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('symptomInput').value = '';

            // è§£æç—‡çŠ¶å¹¶åŒ¹é…è·¯å¾„
            parseAndMatchSymptoms(symptomText);
        }

        // å¿«é€Ÿæµ‹è¯•
        function quickTest(symptoms) {
            document.getElementById('symptomInput').value = symptoms;
            sendSymptom();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯
        function addMessage(sender, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = sender === 'doctor' ? `åŒ»ç”Ÿï¼š${content}` : `æ‚£è€…ï¼š${content}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // è§£æç—‡çŠ¶å¹¶åŒ¹é…è·¯å¾„
        async function parseAndMatchSymptoms(symptomText) {
            // ç®€å•çš„ç—‡çŠ¶æå–ï¼ˆå®é™…åº”è¯¥ç”¨NLPï¼‰
            const extractedSymptoms = extractSymptomsFromText(symptomText);
            collectedSymptoms = [...new Set([...collectedSymptoms, ...extractedSymptoms])];

            // æ›´æ–°ç—‡çŠ¶å±•ç¤º
            updateSymptomsDisplay();

            // åŒ¹é…å†³ç­–è·¯å¾„
            try {
                const matchResult = await matchSymptomsToPaths(collectedSymptoms);
                displayPathMatch(matchResult);

                // å¦‚æœæ‰¾åˆ°åŒ¹é…ï¼ŒåŒ»ç”Ÿå›å¤æ¨èæ–¹å‰‚
                if (matchResult.matched_path) {
                    const formula = matchResult.recommended_formula;
                    const confidence = (matchResult.match_confidence * 100).toFixed(0);
                    addMessage('doctor', `æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘å»ºè®®ä½¿ç”¨"${formula}"ï¼ˆåŒ¹é…åº¦ï¼š${confidence}%ï¼‰`);
                }
            } catch (error) {
                console.error('è·¯å¾„åŒ¹é…å¤±è´¥:', error);
            }
        }

        // ä»æ–‡æœ¬ä¸­æå–ç—‡çŠ¶
        function extractSymptomsFromText(text) {
            const symptoms = [];
            const symptomPatterns = [
                'å¤±çœ ', 'å¤šæ¢¦', 'å¿ƒçƒ¦', 'å£å¹²', 'èˆŒçº¢', 'è‹”é»„', 'è„‰æ•°',
                'å¥å¿˜', 'å¿ƒæ‚¸', 'é¢è‰²èé»„', 'èˆŒæ·¡', 'è„‰å¼±',
                'èƒƒç—›', 'éšéš', 'å–œæ¸©', 'å–œæŒ‰', 'è‹”ç™½', 'è„‰ç¼“',
                'æ˜“æ€’', 'èƒ¸èƒèƒ€æ»¡', 'å£è‹¦', 'è„‰å¼¦'
            ];

            symptomPatterns.forEach(pattern => {
                if (text.includes(pattern)) {
                    symptoms.push(pattern);
                }
            });

            return symptoms;
        }

        // åŒ¹é…ç—‡çŠ¶åˆ°è·¯å¾„ï¼ˆæ¨¡æ‹ŸAPIè°ƒç”¨ï¼‰
        async function matchSymptomsToPaths(symptoms) {
            // å®é™…åº”è¯¥è°ƒç”¨ /api/match_symptoms_to_paths
            return new Promise(resolve => {
                setTimeout(() => {
                    let bestMatch = null;
                    let bestScore = 0;

                    sampleDecisionPaths.forEach(path => {
                        const matchScore = calculateMatchScore(symptoms, path.keywords);
                        if (matchScore > bestScore) {
                            bestScore = matchScore;
                            bestMatch = path;
                        }
                    });

                    if (bestScore > 0.3) {
                        const formula = bestMatch.steps.find(s => s.type === 'formula')?.content;
                        resolve({
                            matched_path: bestMatch,
                            recommended_formula: formula,
                            match_confidence: bestScore,
                            matched_keywords: symptoms.filter(s => bestMatch.keywords.includes(s))
                        });
                    } else {
                        resolve({
                            matched_path: null,
                            alternative_paths: sampleDecisionPaths.slice(0, 2),
                            suggestion: "ç—‡çŠ¶æè¿°éœ€è¦æ›´è¯¦ç»†"
                        });
                    }
                }, 500);
            });
        }

        // è®¡ç®—åŒ¹é…åˆ†æ•°
        function calculateMatchScore(userSymptoms, pathKeywords) {
            const userSet = new Set(userSymptoms);
            const pathSet = new Set(pathKeywords);
            const intersection = new Set([...userSet].filter(x => pathSet.has(x)));
            return intersection.size / pathSet.size;
        }

        // æ˜¾ç¤ºè·¯å¾„åŒ¹é…ç»“æœ
        function displayPathMatch(matchResult) {
            const container = document.getElementById('pathMatchResult');

            if (matchResult.matched_path) {
                const path = matchResult.matched_path;
                const confidence = (matchResult.match_confidence * 100).toFixed(0);

                container.innerHTML = `
                    <div class="path-match">
                        <div class="match-confidence">
                            ğŸ¯ åŒ¹é…è·¯å¾„ (ç½®ä¿¡åº¦: ${confidence}%) - åˆ›å»ºè€…: ${path.created_by}
                        </div>
                        
                        <div class="decision-flow">
                            ${path.steps.map((step, index) => {
                                let html = `<div class="flow-node ${step.type}">${step.content}</div>`;
                                if (index < path.steps.length - 1) {
                                    html += '<div class="flow-arrow">â†’</div>';
                                }
                                return html;
                            }).join('')}
                        </div>
                        
                        <div class="matched-keywords">
                            åŒ¹é…å…³é”®è¯: ${matchResult.matched_keywords ? matchResult.matched_keywords.join(', ') : 'æ— '}
                        </div>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="no-match">
                        <div style="margin-bottom: 10px;">âš ï¸ æš‚æœªæ‰¾åˆ°é«˜åº¦åŒ¹é…çš„å†³ç­–è·¯å¾„</div>
                        <div style="font-size: 12px;">${matchResult.suggestion}</div>
                        
                        ${matchResult.alternative_paths ? `
                            <div style="margin-top: 15px; text-align: left;">
                                <strong>å‚è€ƒè·¯å¾„ï¼š</strong>
                                ${matchResult.alternative_paths.map(path => {
                                    const formula = path.steps.find(s => s.type === 'formula')?.content;
                                    return `<div style="margin: 5px 0;">â€¢ ${formula} (${path.created_by})</div>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>`;
            }
        }

        // æ›´æ–°ç—‡çŠ¶å±•ç¤º
        function updateSymptomsDisplay() {
            const container = document.getElementById('currentSymptoms');
            
            if (collectedSymptoms.length === 0) {
                container.innerHTML = '<div style="color: #6b7280; font-style: italic;">ç­‰å¾…æ‚£è€…æè¿°ç—‡çŠ¶...</div>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>å·²æ”¶é›†ç—‡çŠ¶ (${collectedSymptoms.length}ä¸ª)ï¼š</strong>
                </div>
                <div class="symptom-tags">
                    ${collectedSymptoms.map(symptom => 
                        `<div class="symptom-tag">${symptom}</div>`
                    ).join('')}
                </div>
                <div style="margin-top: 10px;">
                    <button class="demo-btn secondary" onclick="clearSymptoms()">ğŸ—‘ï¸ æ¸…ç©ºç—‡çŠ¶</button>
                </div>`;
        }

        // æ¸…ç©ºç—‡çŠ¶
        function clearSymptoms() {
            collectedSymptoms = [];
            updateSymptomsDisplay();
            document.getElementById('pathMatchResult').innerHTML = `
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    ğŸ“ è¯·åœ¨å·¦ä¾§è¾“å…¥ç—‡çŠ¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŒ¹é…å†³ç­–è·¯å¾„
                </div>`;
        }

        // æ‰“å¼€å†³ç­–æ ‘ç¼–è¾‘å™¨
        function openDecisionTreeEditor() {
            window.open('/static/decision_tree_v3.html', '_blank');
        }

        // æŸ¥çœ‹æ‰€æœ‰è·¯å¾„
        function viewAllPaths() {
            const pathsWindow = window.open('', '_blank');
            pathsWindow.document.write(`
                <html>
                    <head><title>æ‰€æœ‰å†³ç­–è·¯å¾„</title></head>
                    <body style="font-family: sans-serif; padding: 20px;">
                        <h2>å½“å‰ç³»ç»Ÿä¸­çš„æ‰€æœ‰å†³ç­–è·¯å¾„</h2>
                        ${sampleDecisionPaths.map((path, index) => {
                            const flowText = path.steps.map(s => s.content).join(' â†’ ');
                            return `
                                <div style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px;">
                                    <strong>è·¯å¾„ ${index + 1}</strong> (åˆ›å»ºè€…: ${path.created_by})<br>
                                    <div style="margin: 8px 0; color: #666;">${flowText}</div>
                                    <small>å…³é”®è¯: ${path.keywords.join(', ')}</small>
                                </div>`;
                        }).join('')}
                    </body>
                </html>
            `);
        }

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('symptomInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendSymptom();
                }
            });
        });
    </script>
</body>
</html>