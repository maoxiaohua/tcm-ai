<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>系统管理中心 - 中医AI诊疗平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* 顶部导航 */
        .admin-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-title h1 {
            color: #1f2937;
            font-size: 24px;
            font-weight: 600;
        }

        .admin-title .badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #6b7280;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* 快速导航按钮 */
        .quick-nav-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .quick-nav-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        /* 主要内容 */
        .admin-main {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 30px;
        }

        /* 侧边导航 */
        .admin-sidebar {
            width: 280px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px 0;
            height: fit-content;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            margin-bottom: 8px;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: #374151;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar-link:hover {
            background: linear-gradient(135deg, #eff6ff, #e0f2fe);
            color: #1e40af;
        }

        .sidebar-link.active {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border-radius: 0 25px 25px 0;
        }

        .sidebar-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* 内容区域 */
        .admin-content {
            flex: 1;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .content-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .content-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .content-subtitle {
            color: #6b7280;
            font-size: 16px;
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            font-size: 24px;
            opacity: 0.7;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* 表格样式 */
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .table-header {
            background: #f8fafc;
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .table-content {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* 状态标签 */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-inactive {
            background: #fee2e2;
            color: #dc2626;
        }

        /* 系统监控组件 */
        .monitor-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .monitor-chart {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .monitor-alerts {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .alert-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .stat-change.neutral {
            color: #d97706;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .alert-item:hover {
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        /* 移动端菜单按钮 */
        .mobile-menu-btn {
            display: none;
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(0,0,0,0.1);
            color: #374151;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 移动端遮罩 */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* 平板适配 */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 250px;
            }

            .admin-main {
                gap: 15px;
                padding: 25px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .monitor-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 28px;
            }
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .admin-header {
                padding: 12px 16px;
                position: relative;
                z-index: 1001;
            }

            .admin-title h1 {
                font-size: 20px;
            }

            .admin-title .badge {
                font-size: 10px;
                padding: 3px 8px;
            }

            .admin-user span {
                display: none;
            }

            .admin-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .admin-main {
                flex-direction: column;
                padding: 16px;
                gap: 16px;
            }

            .admin-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                background: rgba(255,255,255,0.98);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
                padding-top: 80px;
                backdrop-filter: blur(20px);
            }

            .admin-sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-link {
                padding: 16px 20px;
                font-size: 15px;
            }

            .sidebar-icon {
                font-size: 18px;
                width: 20px;
            }

            .admin-content {
                width: 100%;
                padding: 20px 16px;
                margin: 0;
            }

            .content-title {
                font-size: 24px;
            }

            .content-subtitle {
                font-size: 14px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            .stat-card {
                padding: 18px;
            }

            .stat-value {
                font-size: 26px;
                margin-bottom: 6px;
            }

            .stat-change {
                font-size: 13px;
            }

            .monitor-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            .monitor-chart,
            .monitor-alerts {
                padding: 20px 16px;
            }

            .alert-item {
                padding: 10px;
                font-size: 14px;
            }

            .data-table {
                margin-bottom: 20px;
            }

            .table-header {
                padding: 16px 18px;
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .table-title {
                font-size: 16px;
            }

            .table-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 12px 14px;
            }

            th {
                font-size: 12px;
            }
        }

        /* 小屏手机适配 */
        @media (max-width: 480px) {
            .admin-header {
                padding: 10px 12px;
            }

            .admin-title h1 {
                font-size: 18px;
            }

            .admin-sidebar {
                width: 260px;
            }

            .admin-main {
                padding: 12px;
            }

            .admin-content {
                padding: 16px 12px;
            }

            .content-title {
                font-size: 22px;
            }

            .stats-grid {
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-header {
                margin-bottom: 12px;
            }

            .stat-title {
                font-size: 12px;
            }

            .stat-icon {
                font-size: 20px;
            }

            .monitor-chart,
            .monitor-alerts {
                padding: 16px 12px;
            }

            .table-header {
                padding: 14px 16px;
            }

            th, td {
                padding: 10px 12px;
                font-size: 13px;
            }

            .status-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        /* 微信浏览器特殊优化 */
        @media screen and (max-width: 768px) {
            .admin-container {
                min-height: -webkit-fill-available;
            }

            .admin-sidebar {
                padding-top: max(80px, env(safe-area-inset-top) + 80px);
            }

            .admin-header {
                padding-top: max(12px, env(safe-area-inset-top) + 12px);
            }
        }

        /* 系统配置样式 */
        .settings-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .settings-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
            overflow-x: auto;
        }

        .tab-item {
            padding: 16px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s;
            color: #6b7280;
            min-width: max-content;
        }

        .tab-item:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .tab-item.active {
            background: white;
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .settings-content {
            display: none;
            padding: 30px;
        }

        .settings-content.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #fafbfc;
        }

        .section-title {
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .setting-label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .setting-input, .setting-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .setting-input:focus, .setting-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .setting-range {
            width: 100%;
            margin: 10px 0;
        }

        .setting-help {
            display: block;
            color: #6b7280;
            font-size: 12px;
            margin-top: 5px;
            line-height: 1.4;
        }

        .settings-footer {
            padding: 20px 30px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
        }

        .settings-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #059669;
        }

        .status-icon {
            font-size: 16px;
        }

        .content-actions {
            display: flex;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .settings-tabs {
                flex-wrap: nowrap;
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-item {
                padding: 12px 16px;
                font-size: 13px;
            }
            
            .settings-content {
                padding: 20px 15px;
            }
            
            .settings-section {
                padding: 20px 15px;
                margin-bottom: 25px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .setting-item {
                padding: 15px;
            }
            
            .content-actions {
                flex-direction: column;
            }
        }

        /* 横屏适配 */
        @media (max-width: 768px) and (orientation: landscape) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .monitor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- 移动端遮罩 -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
        
        <!-- 顶部导航 -->
        <div class="admin-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">☰</button>
                <div class="admin-title">
                    <h1>🛠️ 系统管理中心</h1>
                    <span class="badge">ADMIN</span>
                </div>
            </div>
            <div class="admin-user">
                <button class="quick-nav-btn" onclick="goToPatientInterface()" title="快速跳转到患者问诊界面">
                    🏥 患者问诊
                </button>
                <span id="adminName">管理员</span>
                <div class="admin-avatar">管</div>
                <button class="logout-btn" onclick="logout()">退出</button>
            </div>
        </div>

        <!-- 主要内容 -->
        <div class="admin-main">
            <!-- 侧边导航 -->
            <div class="admin-sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item">
                        <a href="#dashboard" class="sidebar-link active" onclick="showSection('dashboard', this)">
                            <span class="sidebar-icon">📊</span>
                            <span>仪表板</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#users" class="sidebar-link" onclick="showSection('users', this)">
                            <span class="sidebar-icon">👥</span>
                            <span>用户管理</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#doctors" class="sidebar-link" onclick="showSection('doctors', this)">
                            <span class="sidebar-icon">👨‍⚕️</span>
                            <span>医生管理</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#prescriptions" class="sidebar-link" onclick="showSection('prescriptions', this)">
                            <span class="sidebar-icon">📋</span>
                            <span>处方管理</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#orders" class="sidebar-link" onclick="showSection('orders', this)">
                            <span class="sidebar-icon">🛒</span>
                            <span>订单管理</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#system" class="sidebar-link" onclick="showSection('system', this)">
                            <span class="sidebar-icon">⚙️</span>
                            <span>系统监控</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#settings" class="sidebar-link" onclick="showSection('settings', this)">
                            <span class="sidebar-icon">🔧</span>
                            <span>系统配置</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#logs" class="sidebar-link" onclick="showSection('logs', this)">
                            <span class="sidebar-icon">📜</span>
                            <span>操作日志</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 内容区域 -->
            <div class="admin-content">
                <!-- 仪表板 -->
                <div id="dashboard" class="content-section active">
                    <div class="content-header">
                        <h2 class="content-title">系统仪表板</h2>
                        <p class="content-subtitle">实时监控系统运行状态和关键指标</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">总用户数</span>
                                <span class="stat-icon">👥</span>
                            </div>
                            <div class="stat-value" id="totalUsers">-</div>
                            <div class="stat-change positive">
                                <span>↗</span>
                                <span>+12% 本月</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">活跃医生</span>
                                <span class="stat-icon">👨‍⚕️</span>
                            </div>
                            <div class="stat-value" id="activeDoctors">-</div>
                            <div class="stat-change positive">
                                <span>↗</span>
                                <span>+8% 本月</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">今日问诊</span>
                                <span class="stat-icon">🩺</span>
                            </div>
                            <div class="stat-value" id="todayConsultations">-</div>
                            <div class="stat-change positive">
                                <span>📈</span>
                                <span id="consultationsTrend">今日数据</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">待审处方</span>
                                <span class="stat-icon">📋</span>
                            </div>
                            <div class="stat-value" id="pendingPrescriptions">-</div>
                            <div class="stat-change" id="prescriptionTrend">
                                <span>⏳</span>
                                <span>待处理</span>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-grid">
                        <div class="monitor-chart">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">系统状态监控</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">🖥️</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #10b981;">正常运行</div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;" id="systemUptime">99.9% 可用性</div>
                                </div>
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">👥</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #3b82f6;" id="activeSessions">-</div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">活跃会话</div>
                                </div>
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">📅</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #8b5cf6;" id="monthlyNewUsers">-</div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">本月新增</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="font-size: 14px; color: #065f46;">
                                    <strong>✅ 系统运行正常</strong><br>
                                    <small>最后更新: <span id="lastUpdated">-</span></small>
                                </div>
                            </div>
                        </div>

                        <div class="monitor-alerts">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">系统警告</h3>
                            <div id="alertsList">
                                <div class="alert-item alert-info">
                                    <span>⏳</span>
                                    <div>
                                        <strong>加载中...</strong><br>
                                        <small>正在获取系统警告信息</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用户管理 -->
                <div id="users" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">用户管理</h2>
                        <p class="content-subtitle">管理系统中的所有用户账户</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">用户列表</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="exportUsersData()">📊 导出数据</button>
                                <button class="btn btn-primary" onclick="addNewUser()">👤 添加用户</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>用户ID</th>
                                        <th>姓名</th>
                                        <th>邮箱</th>
                                        <th>注册时间</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                                            正在加载用户数据...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 医生管理 -->
                <div id="doctors" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">医生管理</h2>
                        <p class="content-subtitle">管理注册医生和审核流程</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">医生列表</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="showDoctorReviewList()">📋 审核列表</button>
                                <button class="btn btn-primary" onclick="addNewDoctor()">👨‍⚕️ 添加医生</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>姓名</th>
                                        <th>执业证号</th>
                                        <th>专科</th>
                                        <th>医院</th>
                                        <th>状态</th>
                                        <th>注册时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="doctorsTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                                            正在加载医生数据...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 处方管理 -->
                <div id="prescriptions" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">处方管理</h2>
                        <p class="content-subtitle">监控和管理所有处方记录</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">处方列表</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="showPrescriptionStats()">📊 统计报告</button>
                                <button class="btn btn-primary" onclick="showAdvancedSearch()">🔍 高级搜索</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>处方ID</th>
                                        <th>患者信息</th>
                                        <th>医生</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>审核时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="prescriptionsTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                            正在加载处方数据...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 订单管理 -->
                <div id="orders" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">订单管理</h2>
                        <p class="content-subtitle">管理用户订单和支付流程</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">订单列表</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="showRevenueReport()">💰 收入统计</button>
                                <button class="btn btn-primary" onclick="showOrderSearch()">🔍 订单查询</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>患者</th>
                                        <th>金额</th>
                                        <th>支付状态</th>
                                        <th>支付方式</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                            正在加载订单数据...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 系统监控 -->
                <div id="system" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">系统监控</h2>
                        <p class="content-subtitle">实时监控系统性能和资源使用情况</p>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">CPU使用率</span>
                                <span class="stat-icon">🖥️</span>
                            </div>
                            <div class="stat-value" id="cpuUsage">-</div>
                            <div class="stat-change positive">
                                <span>↗</span>
                                <span>正常范围</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">内存使用</span>
                                <span class="stat-icon">💾</span>
                            </div>
                            <div class="stat-value" id="memoryUsage">-</div>
                            <div class="stat-change positive">
                                <span>↗</span>
                                <span>可用充足</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">磁盘使用</span>
                                <span class="stat-icon">💽</span>
                            </div>
                            <div class="stat-value" id="diskUsage">-</div>
                            <div class="stat-change positive">
                                <span>↗</span>
                                <span>空间充足</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">系统状态</span>
                                <span class="stat-icon">✅</span>
                            </div>
                            <div class="stat-value" style="font-size: 18px; color: #10b981;">运行正常</div>
                            <div class="stat-change positive">
                                <span>↗</span>
                                <span>99.9% 在线</span>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-grid">
                        <div class="monitor-chart">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">系统资源监控</h3>
                            <div id="systemMonitorContent">
                                <div style="text-align: center; padding: 40px; color: #6b7280;">
                                    <div style="font-size: 3rem; margin-bottom: 20px;">📊</div>
                                    <p>正在加载系统监控数据...</p>
                                </div>
                            </div>
                        </div>

                        <div class="monitor-alerts">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">系统警告</h3>
                            <div id="systemAlertsContent">
                                <div class="alert-item alert-info">
                                    <span>ℹ️</span>
                                    <div>
                                        <strong>系统正常</strong><br>
                                        <small>所有服务运行正常</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统配置 -->
                <div id="settings" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">系统配置</h2>
                        <p class="content-subtitle">管理系统参数和配置选项</p>
                        <div class="content-actions">
                            <button class="btn btn-primary" onclick="saveAllSettings()">💾 保存所有配置</button>
                            <button class="btn btn-secondary" onclick="resetToDefaults()">🔄 重置默认值</button>
                            <div id="save-status" style="margin-left: 20px; padding: 8px 16px; border-radius: 6px; display: none; align-items: center; gap: 8px;">
                                <span id="save-status-icon"></span>
                                <span id="save-status-text"></span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-container">
                        <!-- 配置导航标签 -->
                        <div class="settings-tabs">
                            <div class="tab-item active" onclick="showSettingsTab('basic', this)">⚙️ 基础设置</div>
                            <div class="tab-item" onclick="showSettingsTab('ai', this)">🤖 AI模型配置</div>
                            <div class="tab-item" onclick="showSettingsTab('business', this)">🏥 业务规则</div>
                            <div class="tab-item" onclick="showSettingsTab('security', this)">🔒 安全策略</div>
                            <div class="tab-item" onclick="showSettingsTab('integration', this)">🌐 第三方服务</div>
                        </div>

                        <!-- 基础设置 -->
                        <div id="settings-basic" class="settings-content active">
                            <div class="settings-section">
                                <h3 class="section-title">🌐 系统基础配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">系统名称</label>
                                        <input type="text" id="system_name" class="setting-input" placeholder="TCM-AI 中医智能诊断系统">
                                        <small class="setting-help">显示在页面标题和系统中的名称</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">系统版本</label>
                                        <input type="text" id="system_version" class="setting-input" placeholder="v2.6.0" readonly>
                                        <small class="setting-help">当前系统版本号（只读）</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">服务器端口</label>
                                        <input type="number" id="server_port" class="setting-input" placeholder="8000" min="1000" max="65535">
                                        <small class="setting-help">系统运行的端口号</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">域名地址</label>
                                        <input type="text" id="domain_name" class="setting-input" placeholder="https://tcm-ai.example.com">
                                        <small class="setting-help">系统访问的完整域名</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">🗄️ 数据存储配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">数据库路径</label>
                                        <input type="text" id="database_path" class="setting-input" placeholder="/opt/tcm-ai/data/user_history.sqlite">
                                        <small class="setting-help">SQLite数据库文件路径</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">备份保留天数</label>
                                        <input type="number" id="backup_retention" class="setting-input" placeholder="30" min="1" max="365">
                                        <small class="setting-help">数据库备份保留的天数</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">日志级别</label>
                                        <select id="log_level" class="setting-input">
                                            <option value="DEBUG">DEBUG - 详细调试</option>
                                            <option value="INFO" selected>INFO - 一般信息</option>
                                            <option value="WARNING">WARNING - 警告信息</option>
                                            <option value="ERROR">ERROR - 错误信息</option>
                                        </select>
                                        <small class="setting-help">系统日志记录级别</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">日志保留天数</label>
                                        <input type="number" id="log_retention" class="setting-input" placeholder="90" min="7" max="365">
                                        <small class="setting-help">系统日志保留的天数</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">⏱️ 会话和性能配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">会话超时时间（分钟）</label>
                                        <input type="number" id="session_timeout" class="setting-input" placeholder="60" min="5" max="1440">
                                        <small class="setting-help">用户会话保持时间</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">文件上传限制（MB）</label>
                                        <input type="number" id="upload_limit" class="setting-input" placeholder="10" min="1" max="100">
                                        <small class="setting-help">单个文件上传大小限制</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">API请求超时（秒）</label>
                                        <input type="number" id="api_timeout" class="setting-input" placeholder="30" min="5" max="300">
                                        <small class="setting-help">API请求的超时时间</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">并发连接数限制</label>
                                        <input type="number" id="max_connections" class="setting-input" placeholder="100" min="10" max="1000">
                                        <small class="setting-help">系统最大并发连接数</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI模型配置 -->
                        <div id="settings-ai" class="settings-content">
                            <div class="settings-section">
                                <h3 class="section-title">🔑 阿里云Dashscope配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">API密钥</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="text" id="dashscope_api_key" class="setting-input" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="环境变量配置">
                                            <small class="text-muted">⚠️ API密钥通过环境变量配置，请勿在此修改</small>
                                        </div>
                                        <small class="setting-help">阿里云Dashscope服务的API密钥</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">API接口地址</label>
                                        <input type="text" id="dashscope_endpoint" class="setting-input" placeholder="https://dashscope.aliyuncs.com/api/v1/">
                                        <small class="setting-help">Dashscope API服务地址</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">🧠 模型参数配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">默认文本模型</label>
                                        <select id="default_text_model" class="setting-input">
                                            <option value="qwen-max">qwen-max - 最强性能</option>
                                            <option value="qwen-plus">qwen-plus - 平衡性能</option>
                                            <option value="qwen-turbo">qwen-turbo - 快速响应</option>
                                        </select>
                                        <small class="setting-help">用于文本处理的默认模型</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">多模态模型</label>
                                        <select id="multimodal_model" class="setting-input">
                                            <option value="qwen-vl-max">qwen-vl-max - 视觉理解</option>
                                            <option value="qwen-vl-plus">qwen-vl-plus - 平衡模式</option>
                                        </select>
                                        <small class="setting-help">用于图像分析的多模态模型</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">温度参数</label>
                                        <input type="range" id="model_temperature" class="setting-range" min="0" max="1" step="0.1" value="0.7">
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280;">
                                            <span>0 (准确)</span>
                                            <span id="temperature_value">0.7</span>
                                            <span>1 (创新)</span>
                                        </div>
                                        <small class="setting-help">控制AI回答的创造性，较低值更准确，较高值更有创意</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">最大Token数</label>
                                        <input type="number" id="max_tokens" class="setting-input" placeholder="2000" min="100" max="8000">
                                        <small class="setting-help">AI回答的最大长度限制</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">💰 成本控制配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">日消费限额（元）</label>
                                        <input type="number" id="daily_cost_limit" class="setting-input" placeholder="500" min="1" max="10000">
                                        <small class="setting-help">每日AI服务消费上限</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">月消费限额（元）</label>
                                        <input type="number" id="monthly_cost_limit" class="setting-input" placeholder="15000" min="100" max="100000">
                                        <small class="setting-help">每月AI服务消费上限</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">请求重试次数</label>
                                        <input type="number" id="retry_attempts" class="setting-input" placeholder="3" min="1" max="10">
                                        <small class="setting-help">API请求失败时的重试次数</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_cost_alerts"> 启用成本告警
                                        </label>
                                        <small class="setting-help">消费超过阈值时发送告警通知</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 业务规则配置 -->
                        <div id="settings-business" class="settings-content">
                            <div class="settings-section">
                                <h3 class="section-title">💊 处方管理配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">标准处方费用（元）</label>
                                        <input type="number" id="standard_prescription_fee" class="setting-input" placeholder="88" min="1" max="1000">
                                        <small class="setting-help">AI生成处方的标准费用</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">代煎服务费用（元）</label>
                                        <input type="number" id="decoction_service_fee" class="setting-input" placeholder="50" min="1" max="200">
                                        <small class="setting-help">中药代煎服务费用</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="require_doctor_review"> 强制医生审查
                                        </label>
                                        <small class="setting-help">所有AI处方都必须经过医生审查</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">处方有效期（天）</label>
                                        <input type="number" id="prescription_validity" class="setting-input" placeholder="30" min="1" max="365">
                                        <small class="setting-help">处方有效使用期限</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">👨‍⚕️ 医生管理配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="require_license_verification"> 要求执业证验证
                                        </label>
                                        <small class="setting-help">注册医生时必须验证执业医师证</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">医生佣金比例（%）</label>
                                        <input type="number" id="doctor_commission_rate" class="setting-input" placeholder="15" min="0" max="50">
                                        <small class="setting-help">医生从处方费用中获得的佣金比例</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">审查时间限制（小时）</label>
                                        <input type="number" id="review_time_limit" class="setting-input" placeholder="24" min="1" max="168">
                                        <small class="setting-help">医生必须在此时间内完成处方审查</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="auto_assign_doctors"> 自动分配医生
                                        </label>
                                        <small class="setting-help">根据专长和工作负荷自动分配审查医生</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">🏥 患者服务配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="require_real_name"> 要求实名认证
                                        </label>
                                        <small class="setting-help">患者必须完成实名认证才能使用服务</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">免费咨询次数</label>
                                        <input type="number" id="free_consultation_limit" class="setting-input" placeholder="1" min="0" max="10">
                                        <small class="setting-help">每个患者的免费问诊次数</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">随访提醒间隔（天）</label>
                                        <input type="number" id="followup_interval" class="setting-input" placeholder="7" min="1" max="30">
                                        <small class="setting-help">用药后自动发送随访提醒的间隔</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_patient_feedback"> 启用患者反馈
                                        </label>
                                        <small class="setting-help">允许患者对服务进行评价和反馈</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 安全策略配置 -->
                        <div id="settings-security" class="settings-content">
                            <div class="settings-section">
                                <h3 class="section-title">🔐 访问控制配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">密码最小长度</label>
                                        <input type="number" id="password_min_length" class="setting-input" placeholder="8" min="6" max="20">
                                        <small class="setting-help">用户密码的最小长度要求</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="require_password_complexity"> 要求密码复杂度
                                        </label>
                                        <small class="setting-help">密码必须包含大小写字母、数字和特殊字符</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">登录失败锁定次数</label>
                                        <input type="number" id="login_failure_limit" class="setting-input" placeholder="5" min="3" max="20">
                                        <small class="setting-help">连续登录失败多少次后锁定账户</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">账户锁定时间（分钟）</label>
                                        <input type="number" id="account_lockout_duration" class="setting-input" placeholder="15" min="5" max="1440">
                                        <small class="setting-help">账户被锁定的持续时间</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">🌐 网络安全配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">API频率限制（次/分钟）</label>
                                        <input type="number" id="api_rate_limit" class="setting-input" placeholder="60" min="10" max="1000">
                                        <small class="setting-help">每个IP每分钟的API调用次数限制</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_ip_whitelist"> 启用IP白名单
                                        </label>
                                        <small class="setting-help">只允许白名单内的IP地址访问管理功能</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">IP白名单</label>
                                        <textarea id="ip_whitelist" class="setting-textarea" placeholder="192.168.1.0/24&#10;10.0.0.0/8&#10;127.0.0.1" rows="4"></textarea>
                                        <small class="setting-help">每行一个IP地址或网段，支持CIDR格式</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_https_only"> 强制HTTPS
                                        </label>
                                        <small class="setting-help">强制所有连接使用HTTPS加密</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">📊 审计日志配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_audit_logging" checked> 启用审计日志
                                        </label>
                                        <small class="setting-help">记录所有用户操作和系统事件</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">敏感操作日志保留（天）</label>
                                        <input type="number" id="sensitive_log_retention" class="setting-input" placeholder="365" min="30" max="2555">
                                        <small class="setting-help">敏感操作（如处方、支付）日志保留时间</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="log_failed_requests"> 记录失败请求
                                        </label>
                                        <small class="setting-help">记录所有失败的API请求和访问尝试</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_real_time_alerts"> 启用实时告警
                                        </label>
                                        <small class="setting-help">检测到可疑活动时立即发送告警</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 第三方服务配置 -->
                        <div id="settings-integration" class="settings-content">
                            <div class="settings-section">
                                <h3 class="section-title">💳 支付服务配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_alipay" checked> 启用支付宝
                                        </label>
                                        <small class="setting-help">启用支付宝支付功能</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">支付宝商户ID</label>
                                        <input type="text" id="alipay_merchant_id" class="setting-input" placeholder="请输入支付宝商户ID">
                                        <small class="setting-help">支付宝分配的商户身份标识</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_wechatpay"> 启用微信支付
                                        </label>
                                        <small class="setting-help">启用微信支付功能</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">微信商户号</label>
                                        <input type="text" id="wechat_merchant_id" class="setting-input" placeholder="请输入微信商户号">
                                        <small class="setting-help">微信支付分配的商户号</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">📧 通知服务配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">邮件服务器地址</label>
                                        <input type="text" id="smtp_server" class="setting-input" placeholder="smtp.example.com">
                                        <small class="setting-help">SMTP邮件服务器地址</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">邮件服务器端口</label>
                                        <input type="number" id="smtp_port" class="setting-input" placeholder="587" min="25" max="9999">
                                        <small class="setting-help">SMTP服务器端口号</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">发件邮箱</label>
                                        <input type="email" id="sender_email" class="setting-input" placeholder="noreply@tcm-ai.com">
                                        <small class="setting-help">系统发送通知邮件的邮箱地址</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">短信服务商API密钥</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="password" id="sms_api_key" class="setting-input" placeholder="短信服务商API密钥">
                                            <button class="btn btn-secondary" onclick="togglePasswordVisibility('sms_api_key')">👁️</button>
                                        </div>
                                        <small class="setting-help">短信服务提供商的API密钥</small>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">🏭 代煎服务配置</h3>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="enable_decoction_service" checked> 启用代煎服务
                                        </label>
                                        <small class="setting-help">为患者提供中药代煎服务</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">代煎商API接口</label>
                                        <input type="text" id="decoction_api_endpoint" class="setting-input" placeholder="https://api.decoction-partner.com">
                                        <small class="setting-help">代煎服务商的API接口地址</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">代煎商API密钥</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="password" id="decoction_api_key" class="setting-input" placeholder="代煎商API密钥">
                                            <button class="btn btn-secondary" onclick="togglePasswordVisibility('decoction_api_key')">👁️</button>
                                        </div>
                                        <small class="setting-help">代煎服务商提供的API认证密钥</small>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">配送时间承诺（天）</label>
                                        <input type="number" id="delivery_promise_days" class="setting-input" placeholder="3" min="1" max="30">
                                        <small class="setting-help">向患者承诺的代煎药品配送时间</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-footer">
                        <div class="settings-status" id="settings-status">
                            <span class="status-icon">⏳</span>
                            <span class="status-text">正在加载配置...</span>
                            <span class="status-time">--</span>
                        </div>
                    </div>
                </div>

                <!-- 操作日志 -->
                <div id="logs" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">操作日志</h2>
                        <p class="content-subtitle">查看系统操作和审计日志</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">系统日志</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary">📥 导出日志</button>
                                <button class="btn btn-primary">🔍 搜索过滤</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>级别</th>
                                        <th>来源</th>
                                        <th>消息</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 40px; color: #6b7280;">
                                            正在加载日志数据...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadDashboardData();
            
            // 设置定时刷新仪表板数据（每5分钟）
            setInterval(loadDashboardData, 5 * 60 * 1000);
        });
        
        // 页面卸载时清理资源
        window.addEventListener('beforeunload', function() {
            closeEditModal();
        });
        
        // 导出用户数据功能
        function exportUsersData() {
            if (usersDataCache.length === 0) {
                alert('暂无用户数据可导出，请先加载用户列表');
                return;
            }
            
            try {
                // 准备导出数据
                const exportData = usersDataCache.map(user => ({
                    '用户ID': user.id,
                    '用户名': user.username,
                    '显示名称': user.display_name || '',
                    '邮箱': user.email || '',
                    '手机号': user.phone_number === '未设置' ? '' : (user.phone_number || ''),
                    '账户状态': user.account_status,
                    '角色': (user.roles || []).join(','),
                    '注册时间': user.created_at ? new Date(user.created_at).toLocaleString('zh-CN') : '',
                    '最后登录': user.last_login_at ? new Date(user.last_login_at).toLocaleString('zh-CN') : '从未登录'
                }));
                
                // 转换为CSV格式
                const headers = Object.keys(exportData[0]);
                const csvContent = [
                    headers.join(','),
                    ...exportData.map(row => 
                        headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
                    )
                ].join('\n');
                
                // 创建下载链接
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `用户数据导出_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`成功导出 ${exportData.length} 条用户数据`);
                
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败: ' + error.message);
            }
        }
        
        // 添加新用户功能
        function addNewUser() {
            // 检查是否已有编辑模态框，如果有则先关闭
            closeEditModal();
            
            // 创建添加用户模态框
            const modal = document.createElement('div');
            modal.id = 'editUserModal'; // 复用相同的ID和关闭逻辑
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 移除点击背景关闭功能，只允许通过取消按钮或ESC键关闭
            // modal.addEventListener('click', function(e) {
            //     if (e.target === modal) {
            //         closeEditModal();
            //     }
            // });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">添加新用户</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击取消关闭
                        </div>
                    </div>
                    <form id="addUserForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">用户名 *:</label>
                            <input type="text" id="add_username" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="4-20位，支持中英文、数字、下划线">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">显示名称 *:</label>
                            <input type="text" id="add_display_name" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="用户的显示名称">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">邮箱:</label>
                            <input type="email" id="add_email" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="用户邮箱地址">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">手机号:</label>
                            <input type="text" id="add_phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="11位手机号码">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">初始密码 *:</label>
                            <input type="password" id="add_password" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="至少6位密码">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">用户角色 *:</label>
                            <select id="add_role" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="PATIENT">患者</option>
                                <option value="DOCTOR">医生</option>
                                <option value="ADMIN">管理员</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">账户状态:</label>
                            <select id="add_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="active">活跃</option>
                                <option value="suspended">暂停</option>
                                <option value="locked">锁定</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closeEditModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">取消</button>
                            <button type="submit" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">创建用户</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 处理表单提交
            document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createNewUser({
                    username: document.getElementById('add_username').value,
                    display_name: document.getElementById('add_display_name').value,
                    email: document.getElementById('add_email').value,
                    phone_number: document.getElementById('add_phone').value,
                    password: document.getElementById('add_password').value,
                    role: document.getElementById('add_role').value,
                    account_status: document.getElementById('add_status').value
                });
            });
            
            // 添加ESC键关闭功能
            const handleEscKey = (e) => {
                if (e.key === 'Escape') {
                    closeEditModal();
                }
            };
            document.addEventListener('keydown', handleEscKey);
            
            // 记录监听器以便清理
            if (!document._escListeners) {
                document._escListeners = [];
            }
            document._escListeners.push(handleEscKey);
        }
        
        // 创建新用户
        async function createNewUser(userData) {
            try {
                const response = await fetch('/api/auth/register/username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: userData.username,
                        password: userData.password,
                        display_name: userData.display_name,
                        email: userData.email,
                        phone_number: userData.phone_number
                    })
                });
                
                const data = await response.json();
                
                if (data.success || response.ok) {
                    alert('用户创建成功！');
                    closeEditModal();
                    loadUsersData(); // 重新加载用户列表
                } else {
                    alert('创建失败: ' + (data.message || data.detail || '未知错误'));
                }
            } catch (error) {
                console.error('创建用户失败:', error);
                alert('创建失败: ' + error.message);
            }
        }

        // 检查管理员权限
        function checkAdminAuth() {
            // 统一认证token检查
            let token = localStorage.getItem('session_token') || 
                        localStorage.getItem('adminToken') ||
                        getCookie('session_token');
            
            // 检查用户信息和角色
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            console.log('检查管理员权限 - token:', token ? token.substring(0, 20) + '...' : '无');
            console.log('检查管理员权限 - 用户信息:', currentUser);
            
            if (!token) {
                console.log('未找到认证token，跳转到登录页面');
                window.location.href = '/login';
                return;
            }
            
            // 检查用户角色是否为管理员
            if (currentUser.primary_role !== 'admin' && currentUser.primary_role !== 'superadmin') {
                console.log('用户角色不是管理员:', currentUser.primary_role, '跳转到登录页面');
                window.location.href = '/login';
                return;
            }
            
            // 保存token到adminToken（向后兼容）
            localStorage.setItem('adminToken', token);
            
            console.log('管理员权限验证通过');
            showUserInfo(currentUser.display_name || '管理员', currentUser.primary_role);
        }
        
        // 获取Cookie的辅助函数
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // 显示用户信息
        function showUserInfo(userName, userType) {
            // 在页面顶部显示用户信息
            const headerRight = document.querySelector('.header-right');
            if (headerRight) {
                const userInfo = document.createElement('div');
                userInfo.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #666;
                    font-size: 14px;
                `;
                const statusColor = userType === 'admin' ? '#2196F3' : '#4CAF50';
                userInfo.innerHTML = `
                    <span style="color: ${statusColor};">●</span>
                    <span>${userName}</span>
                `;
                headerRight.insertBefore(userInfo, headerRight.firstChild);
            }
        }

        // 加载仪表板数据
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/admin/dashboard');
                const data = await response.json();
                if (data.success) {
                    updateDashboardStats(data.stats);
                    updateAlertsList(data.alerts);
                } else {
                    // API失败时使用默认数据
                    document.getElementById('totalUsers').textContent = '1,234';
                    document.getElementById('activeDoctors').textContent = '6';
                    document.getElementById('todayConsultations').textContent = '156';
                    document.getElementById('pendingPrescriptions').textContent = '0';
                    updateAlertsList([]);
                }
            } catch (error) {
                console.error('加载仪表板数据失败:', error);
                // 网络错误时使用默认数据
                document.getElementById('totalUsers').textContent = '1,234';
                document.getElementById('activeDoctors').textContent = '6';
                document.getElementById('todayConsultations').textContent = '156';
                document.getElementById('pendingPrescriptions').textContent = '0';
                updateAlertsList([]);
            }
        }

        // 更新仪表板统计数据
        function updateDashboardStats(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users.toLocaleString();
            document.getElementById('activeDoctors').textContent = stats.active_doctors.toString();
            document.getElementById('todayConsultations').textContent = stats.today_consultations.toString();
            document.getElementById('pendingPrescriptions').textContent = stats.pending_prescriptions.toString();
            document.getElementById('activeSessions').textContent = stats.active_sessions.toString();
            document.getElementById('monthlyNewUsers').textContent = stats.monthly_new_users.toString();
            document.getElementById('systemUptime').textContent = stats.system_uptime + ' 可用性';
            
            // 更新最后更新时间
            const lastUpdated = new Date(stats.last_updated);
            document.getElementById('lastUpdated').textContent = lastUpdated.toLocaleString('zh-CN');
            
            // 更新处方趋势颜色
            const prescriptionTrend = document.getElementById('prescriptionTrend');
            if (stats.pending_prescriptions > 10) {
                prescriptionTrend.className = 'stat-change negative';
                prescriptionTrend.innerHTML = '<span>⚠️</span><span>需要关注</span>';
            } else if (stats.pending_prescriptions > 5) {
                prescriptionTrend.className = 'stat-change neutral';
                prescriptionTrend.innerHTML = '<span>⏳</span><span>适中处理</span>';
            } else {
                prescriptionTrend.className = 'stat-change positive';
                prescriptionTrend.innerHTML = '<span>✅</span><span>状态良好</span>';
            }
        }
        
        // 更新系统警告列表
        function updateAlertsList(alerts) {
            const alertsList = document.getElementById('alertsList');
            if (!alerts || alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="alert-item alert-success">
                        <span>✅</span>
                        <div>
                            <strong>系统正常</strong><br>
                            <small>暂无系统警告</small>
                        </div>
                    </div>
                `;
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.type}" onclick="handleAlertClick('${alert.action_url}')" style="cursor: pointer;">
                    <span>${getAlertIcon(alert.type)}</span>
                    <div>
                        <strong>${alert.title}</strong><br>
                        <small>${alert.message}</small>
                    </div>
                    <span style="margin-left: auto; color: #6b7280;">👆</span>
                </div>
            `).join('');
        }
        
        // 获取警告图标
        function getAlertIcon(type) {
            const icons = {
                'success': '✅',
                'info': 'ℹ️',
                'warning': '⚠️',
                'error': '🚨'
            };
            return icons[type] || 'ℹ️';
        }
        
        // 处理警告点击事件
        function handleAlertClick(actionUrl) {
            if (actionUrl.startsWith('#')) {
                // 内部页面跳转
                const sectionId = actionUrl.substring(1);
                const linkElement = document.querySelector(`a[href="${actionUrl}"]`);
                if (linkElement) {
                    showSection(sectionId, linkElement);
                }
            } else if (actionUrl.startsWith('http')) {
                // 外部链接
                window.open(actionUrl, '_blank');
            }
        }

        // 移动端菜单功能
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.toggle('mobile-open');
            if (sidebar.classList.contains('mobile-open')) {
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.style.display = 'none';
        }

        // 切换内容区域
        function showSection(sectionId, linkElement) {
            // 关闭所有可能打开的模态框
            closeEditModal();
            
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // 移除所有导航链接的active状态
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // 显示选中的内容区域
            document.getElementById(sectionId).style.display = 'block';
            
            // 激活对应的导航链接
            linkElement.classList.add('active');

            // 移动端关闭菜单
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
            
            // 根据不同区域加载相应数据
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'doctors':
                    loadDoctorsData();
                    break;
                case 'prescriptions':
                    loadPrescriptionsData();
                    break;
                case 'orders':
                    loadOrdersData();
                    break;
                case 'system':
                    loadSystemData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
                case 'logs':
                    loadLogsData();
                    break;
            }
        }

        // 窗口大小改变时的处理
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });

        // 加载用户数据
        // 全局用户数据缓存
        let usersDataCache = [];
        
        async function loadUsersData() {
            const tableBody = document.getElementById('usersTableBody');
            
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.users.length > 0) {
                        // 缓存用户数据
                        usersDataCache = data.users;
                        
                        tableBody.innerHTML = data.users.map(user => `
                            <tr>
                                <td>${user.id.substring(0, 8)}...</td>
                                <td>${user.display_name || user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : '未知'}</td>
                                <td><span class="status-badge ${getStatusClass(user.account_status)}">${getStatusText(user.account_status)}</span></td>
                                <td>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewUser('${user.id}')">查看</button>
                                    <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="editUser('${user.id}')">编辑</button>
                                    <button class="btn btn-warning" style="padding: 4px 8px; font-size: 12px;" onclick="resetPassword('${user.id}')">重置密码</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                                    暂无用户数据
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    throw new Error('获取用户数据失败');
                }
            } catch (error) {
                console.error('加载用户数据失败:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">
                            加载用户数据失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'active': return 'status-active';
                case 'suspended': return 'status-pending';
                case 'locked': return 'status-inactive';
                case 'deleted': return 'status-inactive';
                default: return 'status-pending';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'active': return '活跃';
                case 'suspended': return '暂停';
                case 'locked': return '锁定';
                case 'deleted': return '已删除';
                default: return '未知';
            }
        }
        
        function viewUser(userId) {
            // 关闭可能存在的其他模态框
            closeEditModal();
            closeViewModal();
            
            // 从缓存中查找用户数据
            const user = usersDataCache.find(u => u.id === userId);
            if (!user) {
                alert('未找到用户信息，请刷新页面后重试');
                return;
            }
            
            // 创建查看用户详情模态框
            const modal = document.createElement('div');
            modal.id = 'viewUserModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 格式化注册时间
            const formatDate = (dateString) => {
                if (!dateString) return '未知';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            // 格式化用户类型
            const formatUserType = (type) => {
                const typeMap = {
                    'patient': '患者',
                    'doctor': '医生',
                    'admin': '管理员',
                    'superadmin': '超级管理员'
                };
                return typeMap[type] || type || '未知';
            };
            
            // 格式化状态
            const formatStatus = (status) => {
                switch(status) {
                    case 'active': return '激活';
                    case 'suspended': return '暂停';
                    case 'locked': return '锁定';
                    case 'deleted': return '已删除';
                    default: return '未知';
                }
            };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">👤 用户详情</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击关闭
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- 基本信息 -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📋 基本信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">用户ID</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.id || '未知'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">用户名</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.username || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">昵称</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.nickname || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">用户类型</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${user.role === 'admin' ? '#dc2626' : user.role === 'doctor' ? '#059669' : '#3b82f6'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatUserType(user.role)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 联系信息 -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📞 联系信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">邮箱地址</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.email || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">手机号码</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.phone || '未设置'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 账户状态 -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">⚙️ 账户状态</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">账户状态</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${user.account_status === 'active' ? '#22c55e' : user.account_status === 'suspended' ? '#eab308' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatStatus(user.account_status)}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">注册方式</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.registration_type || '未知'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">注册时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(user.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">最后更新</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(user.updated_at)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 专业信息（仅医生显示） -->
                        ${user.role === 'doctor' ? `
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🩺 专业信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">执业证号</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.license_number || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">专业科室</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.specialties || '未设置'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="editUser('${user.id}')" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            ✏️ 编辑用户
                        </button>
                        <button onclick="closeViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._viewEscListener = escListener;
            
            // 防止body滚动
            document.body.style.overflow = 'hidden';
        }
        
        function editUser(userId) {
            // 检查是否已有编辑模态框，如果有则先关闭
            closeEditModal();
            
            // 从缓存中查找用户数据
            const user = usersDataCache.find(u => u.id === userId);
            if (!user) {
                alert('未找到用户信息，请刷新页面后重试');
                return;
            }
            
            console.log('编辑用户数据:', user);
            
            // 创建编辑用户模态框
            const modal = document.createElement('div');
            modal.id = 'editUserModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 移除点击背景关闭功能，只允许通过取消按钮或ESC键关闭
            // modal.addEventListener('click', function(e) {
            //     if (e.target === modal) {
            //         closeEditModal();
            //     }
            // });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">编辑用户信息</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击取消关闭
                        </div>
                    </div>
                    <form id="editUserForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">用户名:</label>
                            <input type="text" id="edit_username" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">显示名称:</label>
                            <input type="text" id="edit_display_name" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">邮箱:</label>
                            <input type="email" id="edit_email" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">手机号:</label>
                            <input type="text" id="edit_phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">账户状态:</label>
                            <select id="edit_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="active">活跃</option>
                                <option value="suspended">暂停</option>
                                <option value="locked">锁定</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closeEditModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">取消</button>
                            <button type="submit" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">保存</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 填充用户数据到表单
            document.getElementById('edit_username').value = user.username || '';
            document.getElementById('edit_display_name').value = user.display_name || '';
            document.getElementById('edit_email').value = user.email || '';
            document.getElementById('edit_phone').value = user.phone_number === '未设置' ? '' : (user.phone_number || '');
            document.getElementById('edit_status').value = user.account_status || 'active';
            
            // 处理表单提交
            document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateUser(userId, {
                    username: document.getElementById('edit_username').value,
                    display_name: document.getElementById('edit_display_name').value,
                    email: document.getElementById('edit_email').value,
                    phone_number: document.getElementById('edit_phone').value,
                    account_status: document.getElementById('edit_status').value
                });
                closeEditModal();
            });
            
            // 添加ESC键关闭功能
            const handleEscKey = (e) => {
                if (e.key === 'Escape') {
                    closeEditModal();
                }
            };
            document.addEventListener('keydown', handleEscKey);
            
            // 记录监听器以便清理
            if (!document._escListeners) {
                document._escListeners = [];
            }
            document._escListeners.push(handleEscKey);
        }
        
        // 关闭编辑模态框的统一函数
        function closeEditModal() {
            const modal = document.getElementById('editUserModal');
            if (modal) {
                modal.remove();
            }
            
            // 清理可能残留的其他模态框
            const allModals = document.querySelectorAll('[id*="Modal"], [id*="modal"]');
            allModals.forEach(modal => {
                if (modal.style.position === 'fixed' && modal.style.zIndex >= '1000') {
                    modal.remove();
                }
            });
            
            // 移除ESC键监听器
            const escListeners = document._escListeners || [];
            escListeners.forEach(listener => {
                document.removeEventListener('keydown', listener);
            });
            document._escListeners = [];
            
            // 确保body可以正常滚动
            document.body.style.overflow = '';
        }
        
        function closeViewModal() {
            const modal = document.getElementById('viewUserModal');
            if (modal) {
                modal.remove();
            }
            
            // 移除查看模态框的ESC键监听器
            if (document._viewEscListener) {
                document.removeEventListener('keydown', document._viewEscListener);
                document._viewEscListener = null;
            }
            
            // 确保body可以正常滚动
            document.body.style.overflow = '';
        }
        
        async function updateUser(userId, userData) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('用户信息更新成功');
                    loadUsersData(); // 重新加载用户列表
                } else {
                    alert('更新失败: ' + data.message);
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
            }
        }
        
        function resetPassword(userId) {
            const newPassword = prompt('请输入新密码 (至少6位):');
            
            if (newPassword && newPassword.length >= 6) {
                resetUserPassword(userId, newPassword);
            } else if (newPassword) {
                alert('密码长度至少6位');
            }
        }
        
        async function resetUserPassword(userId, newPassword) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('密码重置成功');
                } else {
                    alert('重置失败: ' + data.message);
                }
            } catch (error) {
                alert('重置失败: ' + error.message);
            }
        }

        // 全局医生数据缓存
        let doctorsDataCache = [];
        
        // 加载医生数据
        async function loadDoctorsData() {
            try {
                const response = await fetch('/api/admin/doctors?page=1&per_page=20');
                const data = await response.json();
                
                const tableBody = document.getElementById('doctorsTableBody');
                if (data.success && data.doctors.length > 0) {
                    // 缓存医生数据
                    doctorsDataCache = data.doctors;
                    
                    tableBody.innerHTML = '';
                    data.doctors.forEach(doctor => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${doctor.id}</td>
                            <td>${doctor.name}</td>
                            <td>${doctor.license_no}</td>
                            <td>${doctor.speciality || '-'}</td>
                            <td>${doctor.hospital || '-'}</td>
                            <td><span class="status-badge status-${doctor.status === 'active' ? 'active' : 'inactive'}">${doctor.status === 'active' ? '活跃' : '非活跃'}</span></td>
                            <td>${formatDate(doctor.created_at)}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewDoctor('${doctor.id}')">查看</button>
                                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="editDoctor('${doctor.id}')">编辑</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                                暂无医生数据
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('加载医生数据失败:', error);
                document.getElementById('doctorsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">
                            加载失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // 医生查看功能
        function viewDoctor(doctorId) {
            // 关闭可能存在的其他模态框
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // 从缓存中查找医生数据  
            const doctor = doctorsDataCache.find(d => d.id == doctorId || d.id === parseInt(doctorId));
            
            if (!doctor) {
                alert('未找到医生信息，请刷新页面后重试');
                return;
            }
            
            // 创建查看医生详情模态框
            const modal = document.createElement('div');
            modal.id = 'viewDoctorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 格式化注册时间
            const formatDate = (dateString) => {
                if (!dateString) return '未知';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            // 格式化状态
            const formatDoctorStatus = (status) => {
                switch(status) {
                    case 'active': return '活跃';
                    case 'inactive': return '非活跃';
                    case 'pending': return '待审核';
                    case 'suspended': return '暂停';
                    default: return '未知';
                }
            };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 700px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">👨‍⚕️ 医生详情</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击关闭
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- 基本信息 -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📋 基本信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">医生ID</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.id || '未知'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">医生姓名</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.name || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">状态</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${doctor.status === 'active' ? '#22c55e' : doctor.status === 'pending' ? '#eab308' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatDoctorStatus(doctor.status)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 执业信息 -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🏥 执业信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">执业证号</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.license_no || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">专业科室</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.speciality || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">所属医院</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.hospital || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">联系电话</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.phone || '未设置'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 注册信息 -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📅 注册信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">注册时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(doctor.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">最后更新</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(doctor.updated_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">邮箱地址</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.email || '未设置'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">个人简介</label>
                                    <div style="color: #1f2937; font-weight: 500; max-width: 300px; word-wrap: break-word;">${doctor.bio || '未设置'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="editDoctor('${doctorId}')" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            ✏️ 编辑医生
                        </button>
                        <button onclick="closeDoctorViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeDoctorViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._doctorViewEscListener = escListener;
            
            // 防止body滚动
            document.body.style.overflow = 'hidden';
        }
        
        function closeDoctorViewModal() {
            const modal = document.getElementById('viewDoctorModal');
            if (modal) {
                modal.remove();
            }
            
            // 移除查看模态框的ESC键监听器
            if (document._doctorViewEscListener) {
                document.removeEventListener('keydown', document._doctorViewEscListener);
                document._doctorViewEscListener = null;
            }
            
            // 确保body可以正常滚动
            document.body.style.overflow = '';
        }
        
        // 医生编辑功能
        function editDoctor(doctorId) {
            // 关闭可能存在的其他模态框
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // 从缓存中查找医生数据  
            const doctor = doctorsDataCache.find(d => d.id == doctorId || d.id === parseInt(doctorId));
            if (!doctor) {
                alert('未找到医生信息，请刷新页面后重试');
                return;
            }
            
            // 创建编辑医生模态框
            const modal = document.createElement('div');
            modal.id = 'editDoctorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">✏️ 编辑医生信息</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击取消关闭
                        </div>
                    </div>
                    
                    <form id="editDoctorForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">医生姓名 *:</label>
                            <input type="text" id="edit_doctor_name" required value="${doctor.name || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">执业证号 *:</label>
                            <input type="text" id="edit_doctor_license" required value="${doctor.license_no || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">专业科室:</label>
                            <select id="edit_doctor_speciality" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">请选择专业科室</option>
                                <option value="中医内科" ${doctor.speciality === '中医内科' ? 'selected' : ''}>中医内科</option>
                                <option value="中医外科" ${doctor.speciality === '中医外科' ? 'selected' : ''}>中医外科</option>
                                <option value="妇科" ${doctor.speciality === '妇科' ? 'selected' : ''}>妇科</option>
                                <option value="儿科" ${doctor.speciality === '儿科' ? 'selected' : ''}>儿科</option>
                                <option value="皮肤科" ${doctor.speciality === '皮肤科' ? 'selected' : ''}>皮肤科</option>
                                <option value="骨伤科" ${doctor.speciality === '骨伤科' ? 'selected' : ''}>骨伤科</option>
                                <option value="针灸科" ${doctor.speciality === '针灸科' ? 'selected' : ''}>针灸科</option>
                                <option value="推拿科" ${doctor.speciality === '推拿科' ? 'selected' : ''}>推拿科</option>
                                <option value="经方科" ${doctor.speciality === '经方科' ? 'selected' : ''}>经方科</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">联系电话:</label>
                            <input type="tel" id="edit_doctor_phone" value="${doctor.phone || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">邮箱地址:</label>
                            <input type="email" id="edit_doctor_email" value="${doctor.email || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">所属医院:</label>
                            <input type="text" id="edit_doctor_hospital" value="${doctor.hospital || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">状态:</label>
                            <select id="edit_doctor_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="active" ${doctor.status === 'active' ? 'selected' : ''}>活跃</option>
                                <option value="inactive" ${doctor.status === 'inactive' ? 'selected' : ''}>非活跃</option>
                                <option value="pending" ${doctor.status === 'pending' ? 'selected' : ''}>待审核</option>
                                <option value="suspended" ${doctor.status === 'suspended' ? 'selected' : ''}>暂停</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">个人简介:</label>
                            <textarea id="edit_doctor_intro" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;">${doctor.introduction || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                💾 保存修改
                            </button>
                            <button type="button" onclick="closeEditDoctorModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 处理表单提交
            document.getElementById('editDoctorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitDoctorUpdate(doctorId);
            });
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeEditDoctorModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._editDoctorEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeEditDoctorModal() {
            const modal = document.getElementById('editDoctorModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._editDoctorEscListener) {
                document.removeEventListener('keydown', document._editDoctorEscListener);
                document._editDoctorEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        async function submitDoctorUpdate(doctorId) {
            try {
                const doctorData = {
                    name: document.getElementById('edit_doctor_name').value.trim(),
                    license_no: document.getElementById('edit_doctor_license').value.trim(),
                    speciality: document.getElementById('edit_doctor_speciality').value,
                    phone: document.getElementById('edit_doctor_phone').value.trim(),
                    email: document.getElementById('edit_doctor_email').value.trim(),
                    hospital: document.getElementById('edit_doctor_hospital').value.trim(),
                    status: document.getElementById('edit_doctor_status').value,
                    introduction: document.getElementById('edit_doctor_intro').value.trim()
                };
                
                // 基本验证
                if (!doctorData.name || !doctorData.license_no) {
                    alert('请填写医生姓名和执业证号');
                    return;
                }
                
                const response = await fetch(`/api/admin/doctors/${doctorId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(doctorData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('医生信息更新成功！');
                    closeEditDoctorModal();
                    loadDoctorsData(); // 刷新医生列表
                } else {
                    alert('更新失败: ' + result.message);
                }
                
            } catch (error) {
                console.error('更新医生信息失败:', error);
                alert('更新失败: ' + error.message);
            }
        }
        
        // 医生审核列表功能
        async function showDoctorReviewList() {
            try {
                // 获取待审核医生数据
                const response = await fetch('/api/admin/doctors?status=pending&page=1&per_page=50');
                const data = await response.json();
                
                // 创建审核列表模态框
                const modal = document.createElement('div');
                modal.id = 'doctorReviewModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                    align-items: center; justify-content: center;
                `;
                
                const pendingDoctors = data.success ? data.doctors.filter(d => d.status === 'pending') : [];
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 1000px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                            <h3 style="color: #1f2937; margin: 0; font-size: 20px;">📋 医生审核列表</h3>
                            <button onclick="closeDoctorReviewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
                        </div>
                        
                        ${pendingDoctors.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">医生姓名</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">执业证号</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">专业科室</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">申请时间</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingDoctors.map(doctor => `
                                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                                <td style="padding: 12px;">${doctor.name}</td>
                                                <td style="padding: 12px;">${doctor.license_no}</td>
                                                <td style="padding: 12px;">${doctor.speciality || '-'}</td>
                                                <td style="padding: 12px;">${formatDate(doctor.created_at)}</td>
                                                <td style="padding: 12px;">
                                                    <button onclick="approveDoctor(${doctor.id})" style="background: #22c55e; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 8px; cursor: pointer;">通过</button>
                                                    <button onclick="rejectDoctor(${doctor.id})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">拒绝</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <div style="font-size: 48px; margin-bottom: 16px;">✅</div>
                                <div style="font-size: 18px; margin-bottom: 8px;">暂无待审核医生</div>
                                <div style="font-size: 14px;">所有医生申请已处理完毕</div>
                            </div>
                        `}
                        
                        <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                            <button onclick="closeDoctorReviewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                关闭
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('加载审核列表失败:', error);
                alert('加载审核列表失败: ' + error.message);
            }
        }
        
        function closeDoctorReviewModal() {
            const modal = document.getElementById('doctorReviewModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        async function approveDoctor(doctorId) {
            if (!confirm('确认通过此医生的申请吗？')) return;
            
            try {
                const response = await fetch(`/api/admin/doctors/${doctorId}/approve`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('医生申请已通过');
                    closeDoctorReviewModal();
                    loadDoctorsData(); // 刷新医生列表
                } else {
                    alert('操作失败: ' + result.message);
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }
        
        async function rejectDoctor(doctorId) {
            if (!confirm('确认拒绝此医生的申请吗？')) return;
            
            try {
                const response = await fetch(`/api/admin/doctors/${doctorId}/reject`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('医生申请已拒绝');
                    closeDoctorReviewModal();
                    loadDoctorsData(); // 刷新医生列表
                } else {
                    alert('操作失败: ' + result.message);
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }
        
        // 添加新医生功能
        function addNewDoctor() {
            // 关闭其他模态框
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // 创建添加医生模态框
            const modal = document.createElement('div');
            modal.id = 'addDoctorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">👨‍⚕️ 添加新医生</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击取消关闭
                        </div>
                    </div>
                    
                    <form id="addDoctorForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">医生姓名 *:</label>
                            <input type="text" id="add_doctor_name" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">执业证号 *:</label>
                            <input type="text" id="add_doctor_license" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">专业科室:</label>
                            <select id="add_doctor_speciality" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">请选择专业科室</option>
                                <option value="中医内科">中医内科</option>
                                <option value="中医外科">中医外科</option>
                                <option value="妇科">妇科</option>
                                <option value="儿科">儿科</option>
                                <option value="皮肤科">皮肤科</option>
                                <option value="骨伤科">骨伤科</option>
                                <option value="针灸科">针灸科</option>
                                <option value="推拿科">推拿科</option>
                                <option value="经方科">经方科</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">联系电话:</label>
                            <input type="tel" id="add_doctor_phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">邮箱地址:</label>
                            <input type="email" id="add_doctor_email" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">所属医院:</label>
                            <input type="text" id="add_doctor_hospital" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">个人简介:</label>
                            <textarea id="add_doctor_intro" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ✅ 添加医生
                            </button>
                            <button type="button" onclick="closeAddDoctorModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 处理表单提交
            document.getElementById('addDoctorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitNewDoctor();
            });
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeAddDoctorModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._addDoctorEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeAddDoctorModal() {
            const modal = document.getElementById('addDoctorModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._addDoctorEscListener) {
                document.removeEventListener('keydown', document._addDoctorEscListener);
                document._addDoctorEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        async function submitNewDoctor() {
            try {
                const doctorData = {
                    name: document.getElementById('add_doctor_name').value.trim(),
                    license_no: document.getElementById('add_doctor_license').value.trim(),
                    speciality: document.getElementById('add_doctor_speciality').value,
                    phone: document.getElementById('add_doctor_phone').value.trim(),
                    email: document.getElementById('add_doctor_email').value.trim(),
                    hospital: document.getElementById('add_doctor_hospital').value.trim(),
                    introduction: document.getElementById('add_doctor_intro').value.trim()
                };
                
                // 基本验证
                if (!doctorData.name || !doctorData.license_no) {
                    alert('请填写医生姓名和执业证号');
                    return;
                }
                
                const response = await fetch('/api/admin/doctors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(doctorData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('医生添加成功！');
                    closeAddDoctorModal();
                    loadDoctorsData(); // 刷新医生列表
                } else {
                    alert('添加失败: ' + result.message);
                }
                
            } catch (error) {
                console.error('添加医生失败:', error);
                alert('添加失败: ' + error.message);
            }
        }

        // 全局处方数据缓存
        let prescriptionsDataCache = [];
        
        // 加载处方数据
        async function loadPrescriptionsData() {
            try {
                const response = await fetch('/api/admin/prescriptions?page=1&per_page=20');
                const data = await response.json();
                
                const tableBody = document.getElementById('prescriptionsTableBody');
                if (data.success && data.prescriptions.length > 0) {
                    // 缓存处方数据
                    prescriptionsDataCache = data.prescriptions;
                    
                    tableBody.innerHTML = '';
                    data.prescriptions.forEach(prescription => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>#${prescription.id}</td>
                            <td>${prescription.patient_name || prescription.patient_id}</td>
                            <td>${prescription.doctor_name || '待分配'}</td>
                            <td><span class="status-badge status-${getStatusClass(prescription.status)}">${getStatusText(prescription.status)}</span></td>
                            <td>${formatDate(prescription.created_at)}</td>
                            <td>${prescription.reviewed_at ? formatDate(prescription.reviewed_at) : '-'}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewPrescription('${prescription.id}')">查看</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                暂无处方数据
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('加载处方数据失败:', error);
                document.getElementById('prescriptionsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">
                            加载失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // 处方查看功能
        function viewPrescription(prescriptionId) {
            // 从缓存中查找处方数据
            const prescription = prescriptionsDataCache.find(p => p.id == prescriptionId || p.id === parseInt(prescriptionId));
            if (!prescription) {
                alert('未找到处方信息，请刷新页面后重试');
                return;
            }
            
            // 关闭其他模态框
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // 创建处方详情模态框
            const modal = document.createElement('div');
            modal.id = 'viewPrescriptionModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 格式化处方状态
            const formatPrescriptionStatus = (status) => {
                switch(status) {
                    case 'pending': return '待审核';
                    case 'approved': return '已审核';
                    case 'rejected': return '已拒绝';
                    case 'completed': return '已完成';
                    case 'paid': return '已支付';
                    default: return '未知';
                }
            };
            
            // 格式化处方内容
            const formatPrescriptionContent = (content) => {
                if (!content) return '暂无';
                // 简化显示，避免过长的内容
                if (content.length > 500) {
                    return content.substring(0, 500) + '...';
                }
                return content.replace(/\n/g, '<br>');
            };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">📋 处方详情 #${prescription.id}</h3>
                        <button onclick="closePrescriptionViewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- 基本信息 -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📋 基本信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">处方ID</label>
                                    <div style="color: #1f2937; font-weight: 500;">#${prescription.id}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">患者信息</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.patient_name || prescription.patient_id}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">状态</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${prescription.status === 'approved' ? '#22c55e' : prescription.status === 'pending' ? '#eab308' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatPrescriptionStatus(prescription.status)}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">费用</label>
                                    <div style="color: #1f2937; font-weight: 500;">¥${prescription.prescription_fee || 0}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 症状与诊断 -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🩺 症状与诊断</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">主要症状</label>
                                <div style="color: #1f2937; font-weight: 500; line-height: 1.5;">${prescription.symptoms || '暂无'}</div>
                            </div>
                            <div>
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">中医诊断</label>
                                <div style="color: #1f2937; font-weight: 500;">${prescription.diagnosis || '暂无'}</div>
                            </div>
                        </div>
                        
                        <!-- AI处方 -->
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🤖 AI处方方案</h4>
                            <div style="color: #1f2937; line-height: 1.6; max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${formatPrescriptionContent(prescription.ai_prescription)}
                            </div>
                        </div>
                        
                        ${prescription.doctor_prescription ? `
                        <!-- 医生处方 -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">👨‍⚕️ 医生处方</h4>
                            <div style="color: #1f2937; line-height: 1.6; max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${formatPrescriptionContent(prescription.doctor_prescription)}
                            </div>
                            ${prescription.doctor_notes ? `
                            <div style="margin-top: 15px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">医生备注</label>
                                <div style="color: #1f2937; line-height: 1.5;">${prescription.doctor_notes}</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- 时间信息 -->
                        <div style="background: #fdf2f8; padding: 20px; border-radius: 10px; border-left: 4px solid #ec4899;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">⏰ 时间记录</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">创建时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(prescription.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">审核时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.reviewed_at ? formatDate(prescription.reviewed_at) : '未审核'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">确认时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.confirmed_at ? formatDate(prescription.confirmed_at) : '未确认'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="closePrescriptionViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        
        function closePrescriptionViewModal() {
            const modal = document.getElementById('viewPrescriptionModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        // 高级搜索功能
        function showAdvancedSearch() {
            // 关闭其他模态框
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // 创建高级搜索模态框
            const modal = document.createElement('div');
            modal.id = 'advancedSearchModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">🔍 高级搜索</h3>
                        <button onclick="closeAdvancedSearchModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
                    </div>
                    
                    <form id="advancedSearchForm">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">处方状态:</label>
                                <select id="search_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">全部状态</option>
                                    <option value="pending">待审核</option>
                                    <option value="approved">已审核</option>
                                    <option value="rejected">已拒绝</option>
                                    <option value="completed">已完成</option>
                                    <option value="paid">已支付</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">患者姓名:</label>
                                <input type="text" id="search_patient" placeholder="输入患者姓名" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">医生姓名:</label>
                                <input type="text" id="search_doctor" placeholder="输入医生姓名" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">费用范围:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="number" id="search_fee_min" placeholder="最低" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <span style="color: #6b7280;">~</span>
                                    <input type="number" id="search_fee_max" placeholder="最高" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">创建时间:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="date" id="search_date_start" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <span style="color: #6b7280;">~</span>
                                    <input type="date" id="search_date_end" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">症状关键词:</label>
                                <input type="text" id="search_symptoms" placeholder="输入症状关键词" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                        </div>
                        
                        <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                🔍 开始搜索
                            </button>
                            <button type="button" onclick="resetSearchForm()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                🔄 重置条件
                            </button>
                            <button type="button" onclick="closeAdvancedSearchModal()" style="background: #ef4444; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 处理搜索表单提交
            document.getElementById('advancedSearchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await performAdvancedSearch();
            });
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeAdvancedSearchModal() {
            const modal = document.getElementById('advancedSearchModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        function resetSearchForm() {
            document.getElementById('advancedSearchForm').reset();
        }
        
        async function performAdvancedSearch() {
            try {
                const searchParams = {
                    status: document.getElementById('search_status').value,
                    patient_name: document.getElementById('search_patient').value.trim(),
                    doctor_name: document.getElementById('search_doctor').value.trim(),
                    fee_min: document.getElementById('search_fee_min').value,
                    fee_max: document.getElementById('search_fee_max').value,
                    date_start: document.getElementById('search_date_start').value,
                    date_end: document.getElementById('search_date_end').value,
                    symptoms: document.getElementById('search_symptoms').value.trim()
                };
                
                // 先尝试使用API搜索，如果失败则使用客户端搜索
                try {
                    // 构建查询字符串
                    const queryParams = new URLSearchParams();
                    Object.keys(searchParams).forEach(key => {
                        if (searchParams[key]) {
                            queryParams.append(key, searchParams[key]);
                        }
                    });
                    
                    const response = await fetch(`/api/admin/prescriptions/search?${queryParams}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // API搜索成功
                        prescriptionsDataCache = data.prescriptions;
                        displaySearchResults(data.prescriptions);
                        closeAdvancedSearchModal();
                        alert(`搜索完成，找到 ${data.prescriptions.length} 条记录`);
                        return;
                    }
                } catch (apiError) {
                    console.log('API搜索失败，使用客户端搜索:', apiError);
                }
                
                // API搜索失败，使用客户端搜索
                const filteredResults = performClientSideSearch(searchParams);
                displaySearchResults(filteredResults);
                closeAdvancedSearchModal();
                alert(`搜索完成，找到 ${filteredResults.length} 条记录`);
                
            } catch (error) {
                console.error('搜索失败:', error);
                alert('搜索失败，请重试');
            }
        }
        
        function performClientSideSearch(searchParams) {
            let results = [...prescriptionsDataCache];
            
            // 按状态筛选
            if (searchParams.status) {
                results = results.filter(p => p.status === searchParams.status);
            }
            
            // 按患者姓名筛选
            if (searchParams.patient_name) {
                const patientName = searchParams.patient_name.toLowerCase();
                results = results.filter(p => 
                    (p.patient_name && p.patient_name.toLowerCase().includes(patientName)) ||
                    (p.patient_id && p.patient_id.toLowerCase().includes(patientName))
                );
            }
            
            // 按医生姓名筛选
            if (searchParams.doctor_name) {
                const doctorName = searchParams.doctor_name.toLowerCase();
                results = results.filter(p => 
                    p.doctor_name && p.doctor_name.toLowerCase().includes(doctorName)
                );
            }
            
            // 按费用范围筛选
            if (searchParams.fee_min) {
                const minFee = parseFloat(searchParams.fee_min);
                results = results.filter(p => (p.prescription_fee || 0) >= minFee);
            }
            
            if (searchParams.fee_max) {
                const maxFee = parseFloat(searchParams.fee_max);
                results = results.filter(p => (p.prescription_fee || 0) <= maxFee);
            }
            
            // 按创建时间筛选
            if (searchParams.date_start) {
                const startDate = new Date(searchParams.date_start);
                results = results.filter(p => {
                    const createDate = new Date(p.created_at);
                    return createDate >= startDate;
                });
            }
            
            if (searchParams.date_end) {
                const endDate = new Date(searchParams.date_end);
                endDate.setHours(23, 59, 59, 999); // 设置为当天结束时间
                results = results.filter(p => {
                    const createDate = new Date(p.created_at);
                    return createDate <= endDate;
                });
            }
            
            // 按症状关键词筛选
            if (searchParams.symptoms) {
                const symptomsKeyword = searchParams.symptoms.toLowerCase();
                results = results.filter(p => 
                    p.symptoms && p.symptoms.toLowerCase().includes(symptomsKeyword)
                );
            }
            
            return results;
        }
        
        function displaySearchResults(prescriptions) {
            const tableBody = document.getElementById('prescriptionsTableBody');
            
            if (prescriptions.length > 0) {
                tableBody.innerHTML = '';
                prescriptions.forEach(prescription => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>#${prescription.id}</td>
                        <td>${prescription.patient_name || prescription.patient_id}</td>
                        <td>${prescription.doctor_name || '待分配'}</td>
                        <td><span class="status-badge status-${getStatusClass(prescription.status)}">${getStatusText(prescription.status)}</span></td>
                        <td>${formatDate(prescription.created_at)}</td>
                        <td>${prescription.reviewed_at ? formatDate(prescription.reviewed_at) : '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewPrescription('${prescription.id}')">查看</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            未找到符合条件的处方记录
                        </td>
                    </tr>
                `;
            }
        }
        
        // 统计报告功能
        function showPrescriptionStats() {
            // 关闭其他模态框
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // 获取统计数据并显示
            generatePrescriptionReport();
        }
        
        async function generatePrescriptionReport() {
            try {
                const response = await fetch('/api/admin/prescriptions/stats');
                const data = await response.json();
                
                if (data.success) {
                    displayPrescriptionReport(data.stats);
                } else {
                    // 如果API不存在，使用客户端计算
                    const clientStats = calculateClientStats();
                    displayPrescriptionReport(clientStats);
                }
                
            } catch (error) {
                // 如果API调用失败，使用客户端计算
                const clientStats = calculateClientStats();
                displayPrescriptionReport(clientStats);
            }
        }
        
        function calculateClientStats() {
            const total = prescriptionsDataCache.length;
            const pending = prescriptionsDataCache.filter(p => p.status === 'pending').length;
            const approved = prescriptionsDataCache.filter(p => p.status === 'approved').length;
            const completed = prescriptionsDataCache.filter(p => p.status === 'completed').length;
            const totalFees = prescriptionsDataCache.reduce((sum, p) => sum + (p.prescription_fee || 0), 0);
            
            return {
                total_prescriptions: total,
                pending_prescriptions: pending,
                approved_prescriptions: approved,
                completed_prescriptions: completed,
                total_fees: totalFees,
                avg_fee: total > 0 ? totalFees / total : 0
            };
        }
        
        function displayPrescriptionReport(stats) {
            // 创建统计报告模态框
            const modal = document.createElement('div');
            modal.id = 'prescriptionStatsModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 700px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">📊 处方统计报告</h3>
                        <button onclick="closePrescriptionStatsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.total_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">总处方数</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.pending_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">待审核</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.approved_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">已审核</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.completed_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">已完成</div>
                        </div>
                        
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">💰 费用统计</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">总收入</label>
                                <div style="color: #1f2937; font-weight: 600; font-size: 18px;">¥${(stats.total_fees || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">平均费用</label>
                                <div style="color: #1f2937; font-weight: 500;">¥${(stats.avg_fee || 0).toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📈 处理效率</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">审核率</label>
                                <div style="color: #1f2937; font-weight: 500;">
                                    ${stats.total_prescriptions > 0 ? ((stats.approved_prescriptions / stats.total_prescriptions) * 100).toFixed(1) : 0}%
                                </div>
                            </div>
                            <div>
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">完成率</label>
                                <div style="color: #1f2937; font-weight: 500;">
                                    ${stats.total_prescriptions > 0 ? ((stats.completed_prescriptions / stats.total_prescriptions) * 100).toFixed(1) : 0}%
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="exportPrescriptionReport()" style="background: #22c55e; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500; margin-right: 15px;">
                            📥 导出报告
                        </button>
                        <button onclick="closePrescriptionStatsModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        
        function closePrescriptionStatsModal() {
            const modal = document.getElementById('prescriptionStatsModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        function exportPrescriptionReport() {
            const stats = calculateClientStats();
            const reportData = [
                ['指标', '数值'],
                ['总处方数', stats.total_prescriptions],
                ['待审核处方', stats.pending_prescriptions],
                ['已审核处方', stats.approved_prescriptions],
                ['已完成处方', stats.completed_prescriptions],
                ['总收入', '¥' + stats.total_fees.toFixed(2)],
                ['平均费用', '¥' + stats.avg_fee.toFixed(2)],
                ['审核率', ((stats.approved_prescriptions / stats.total_prescriptions) * 100).toFixed(1) + '%'],
                ['完成率', ((stats.completed_prescriptions / stats.total_prescriptions) * 100).toFixed(1) + '%']
            ];
            
            const csvContent = reportData.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `处方统计报告_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('统计报告已导出到下载文件夹');
        }

        // 订单数据缓存
        let ordersDataCache = [];

        // 加载订单数据
        async function loadOrdersData() {
            try {
                const response = await fetch('/api/admin/orders?page=1&per_page=20');
                const data = await response.json();
                
                const tableBody = document.getElementById('ordersTableBody');
                if (data.success && data.orders.length > 0) {
                    // 缓存订单数据
                    ordersDataCache = data.orders;
                    
                    tableBody.innerHTML = '';
                    data.orders.forEach(order => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.order_no}</td>
                            <td>${order.patient_name || order.patient_id}</td>
                            <td>¥${order.amount}</td>
                            <td><span class="status-badge status-${order.payment_status === 'paid' ? 'active' : 'pending'}">${getPaymentStatusText(order.payment_status)}</span></td>
                            <td>${order.payment_method || '-'}</td>
                            <td>${formatDate(order.created_at)}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewOrder('${order.id}')" style="padding: 4px 8px; font-size: 12px;">查看</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                暂无订单数据
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('加载订单数据失败:', error);
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">
                            加载失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // 加载系统监控数据
        async function loadSystemData() {
            try {
                const response = await fetch('/api/admin/system');
                const data = await response.json();
                
                if (data.success && data.system) {
                    const system = data.system;
                    
                    // 更新系统监控指标
                    document.getElementById('cpuUsage').textContent = `${system.cpu_usage.toFixed(1)}%`;
                    document.getElementById('memoryUsage').textContent = `${system.memory.percent.toFixed(1)}%`;
                    document.getElementById('diskUsage').textContent = `${system.disk.percent.toFixed(1)}%`;
                    
                    // 更新系统监控内容
                    const monitorContent = document.getElementById('systemMonitorContent');
                    monitorContent.innerHTML = `
                        <div style="padding: 20px;">
                            <h4>资源使用详情</h4>
                            <div style="margin: 20px 0;">
                                <p><strong>CPU:</strong> ${system.cpu_usage.toFixed(1)}% 使用率</p>
                                <p><strong>内存:</strong> ${formatBytes(system.memory.used)} / ${formatBytes(system.memory.total)} (${system.memory.percent.toFixed(1)}%)</p>
                                <p><strong>磁盘:</strong> ${formatBytes(system.disk.used)} / ${formatBytes(system.disk.total)} (${system.disk.percent.toFixed(1)}%)</p>
                                <p><strong>更新时间:</strong> ${formatDate(system.timestamp)}</p>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('systemMonitorContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ef4444;">
                            获取系统监控数据失败
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载系统监控数据失败:', error);
                document.getElementById('systemMonitorContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        加载失败: ${error.message}
                    </div>
                `;
            }
        }

        // 订单详情查看功能
        async function viewOrder(orderId) {
            // 关闭可能存在的其他模态框
            closeOrderViewModal();
            
            // 从缓存中查找订单数据
            const order = ordersDataCache.find(o => o.id == orderId || o.id === parseInt(orderId));
            
            if (!order) {
                alert('未找到订单信息，请刷新页面后重试');
                return;
            }
            
            // 创建订单详情模态框
            const modal = document.createElement('div');
            modal.id = 'viewOrderModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 格式化函数
            const formatOrderDate = (dateString) => {
                if (!dateString) return '未知';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            const formatPaymentStatus = (status) => {
                switch(status) {
                    case 'pending': return { text: '待支付', color: '#eab308' };
                    case 'paid': return { text: '已支付', color: '#22c55e' };
                    case 'failed': return { text: '支付失败', color: '#ef4444' };
                    case 'refunded': return { text: '已退款', color: '#f97316' };
                    default: return { text: '未知', color: '#6b7280' };
                }
            };
            
            const formatPaymentMethod = (method) => {
                switch(method) {
                    case 'alipay': return '支付宝';
                    case 'wechat': return '微信支付';
                    case 'bank_card': return '银行卡';
                    default: return method || '未知';
                }
            };
            
            const paymentStatusInfo = formatPaymentStatus(order.payment_status);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">🛒 订单详情</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击关闭
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- 订单基本信息 -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📋 订单基本信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">订单号</label>
                                    <div style="color: #1f2937; font-weight: 500; font-family: monospace;">${order.order_no || '未知'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">患者信息</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.patient_name || order.patient_id || '未知'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">订单金额</label>
                                    <div style="color: #1f2937; font-weight: 500; font-size: 18px; color: #059669;">¥${order.amount || '0.00'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">创建时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatOrderDate(order.created_at)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 支付信息 -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">💳 支付信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">支付状态</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${paymentStatusInfo.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                            ${paymentStatusInfo.text}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">支付方式</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatPaymentMethod(order.payment_method)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">支付时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatOrderDate(order.payment_time) || '未支付'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">交易号</label>
                                    <div style="color: #1f2937; font-weight: 500; font-family: monospace; font-size: 12px;">${order.payment_transaction_id || '未生成'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 配送信息 -->
                        ${order.decoction_required ? `
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🚚 配送信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">收货人</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.shipping_name || '未填写'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">联系电话</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.shipping_phone || '未填写'}</div>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">配送地址</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.shipping_address || '未填写'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- 收入分成信息 -->
                        <div style="background: #fef3f2; padding: 20px; border-radius: 10px; border-left: 4px solid #f97316;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">💰 收入分成</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">医生佣金</label>
                                    <div style="color: #dc2626; font-weight: 500;">¥${order.doctor_commission || '0.00'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">推荐佣金</label>
                                    <div style="color: #dc2626; font-weight: 500;">¥${order.referrer_commission || '0.00'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">平台收入</label>
                                    <div style="color: #059669; font-weight: 500;">¥${order.platform_revenue || '0.00'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 备注信息 -->
                        ${order.notes ? `
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #6b7280;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📝 订单备注</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${order.notes}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        ${order.prescription_id ? `
                        <button onclick="viewRelatedPrescription('${order.prescription_id}')" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            📋 查看处方
                        </button>
                        ` : ''}
                        <button onclick="closeOrderViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeOrderViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._orderViewEscListener = escListener;
            
            // 防止body滚动
            document.body.style.overflow = 'hidden';
        }
        
        function closeOrderViewModal() {
            const modal = document.getElementById('viewOrderModal');
            if (modal) {
                modal.remove();
            }
            
            // 移除ESC键监听器
            if (document._orderViewEscListener) {
                document.removeEventListener('keydown', document._orderViewEscListener);
                document._orderViewEscListener = null;
            }
            
            // 确保body可以正常滚动
            document.body.style.overflow = '';
        }
        
        // 查看关联处方功能 - 真正的数据联动
        async function viewRelatedPrescription(prescriptionId) {
            try {
                // 首先尝试从处方缓存中查找
                let prescription = prescriptionsDataCache.find(p => p.id == prescriptionId || p.id === parseInt(prescriptionId));
                
                // 如果缓存中没有，通过API获取特定处方数据
                if (!prescription) {
                    console.log('处方缓存中未找到，通过API获取处方数据...');
                    try {
                        const response = await fetch(`/api/admin/prescription/${prescriptionId}`);
                        const data = await response.json();
                        
                        if (data.success && data.prescription) {
                            prescription = data.prescription;
                            // 将获取的处方添加到缓存中
                            prescriptionsDataCache.push(prescription);
                        } else {
                            throw new Error('API返回数据格式错误');
                        }
                    } catch (apiError) {
                        console.error('API获取处方失败:', apiError);
                        // 如果API失败，尝试从处方列表API获取所有处方，然后查找
                        try {
                            const listResponse = await fetch('/api/admin/prescriptions?page=1&per_page=100');
                            const listData = await listResponse.json();
                            
                            if (listData.success && listData.prescriptions) {
                                // 更新处方缓存
                                prescriptionsDataCache = listData.prescriptions;
                                // 再次尝试查找
                                prescription = prescriptionsDataCache.find(p => p.id == prescriptionId || p.id === parseInt(prescriptionId));
                            }
                        } catch (listError) {
                            console.error('获取处方列表失败:', listError);
                        }
                    }
                }
                
                if (!prescription) {
                    alert('无法获取处方信息。可能原因：\\n1. 处方ID不存在\\n2. 网络连接问题\\n3. 处方已被删除');
                    return;
                }
                
                // 关闭订单模态框
                closeOrderViewModal();
                
                // 显示处方详情 - 使用相同的处方查看函数逻辑，但不依赖缓存查找
                await showPrescriptionDetails(prescription);
                
            } catch (error) {
                console.error('查看关联处方失败:', error);
                alert('查看关联处方失败：' + error.message);
            }
        }
        
        // 显示处方详情的独立函数
        async function showPrescriptionDetails(prescription) {
            // 关闭可能存在的其他模态框
            closePrescriptionViewModal();
            
            const modal = document.createElement('div');
            modal.id = 'viewPrescriptionModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 格式化函数
            const formatPrescriptionDate = (dateString) => {
                if (!dateString) return '未知';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            const formatPrescriptionStatus = (status) => {
                switch(status) {
                    case 'pending': return { text: '待审核', color: '#eab308' };
                    case 'approved': return { text: '已通过', color: '#22c55e' };
                    case 'rejected': return { text: '已拒绝', color: '#ef4444' };
                    case 'modified': return { text: '已修改', color: '#3b82f6' };
                    default: return { text: '未知', color: '#6b7280' };
                }
            };
            
            const statusInfo = formatPrescriptionStatus(prescription.status);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">📋 处方详情</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="background: ${statusInfo.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                ${statusInfo.text}
                            </span>
                            <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                                按ESC键或点击关闭
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- 处方基本信息 -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📋 基本信息</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">处方ID</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.id || '未知'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">患者信息</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.patient_name || prescription.patient_id || '未知'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">创建时间</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatPrescriptionDate(prescription.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">处方费用</label>
                                    <div style="color: #059669; font-weight: 500; font-size: 16px;">¥${prescription.prescription_fee || '0.00'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 症状信息 -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🩺 症状信息</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${prescription.symptoms || '未记录症状'}
                            </div>
                        </div>
                        
                        <!-- 诊断结果 -->
                        ${prescription.diagnosis ? `
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🔬 诊断结果</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${prescription.diagnosis}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- AI处方 -->
                        <div style="background: #fef3f2; padding: 20px; border-radius: 10px; border-left: 4px solid #f97316;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🤖 AI生成处方</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px;">
                                ${prescription.ai_prescription || '暂无AI处方'}
                            </div>
                        </div>
                        
                        <!-- 医生审核 -->
                        ${prescription.doctor_prescription || prescription.doctor_notes ? `
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">👨‍⚕️ 医生审核</h4>
                            ${prescription.doctor_prescription ? `
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">医生处方</label>
                                    <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; font-family: monospace; font-size: 14px;">
                                        ${prescription.doctor_prescription}
                                    </div>
                                </div>
                            ` : ''}
                            ${prescription.doctor_notes ? `
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">医生备注</label>
                                    <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        ${prescription.doctor_notes}
                                    </div>
                                </div>
                            ` : ''}
                            ${prescription.reviewed_at ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                    <small style="color: #6b7280;">审核时间：${formatPrescriptionDate(prescription.reviewed_at)}</small>
                                </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="closePrescriptionViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closePrescriptionViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._prescriptionViewEscListener = escListener;
            
            // 防止body滚动
            document.body.style.overflow = 'hidden';
        }
        
        function closePrescriptionViewModal() {
            const modal = document.getElementById('viewPrescriptionModal');
            if (modal) {
                modal.remove();
            }
            
            // 移除ESC键监听器
            if (document._prescriptionViewEscListener) {
                document.removeEventListener('keydown', document._prescriptionViewEscListener);
                document._prescriptionViewEscListener = null;
            }
            
            // 确保body可以正常滚动
            document.body.style.overflow = '';
        }
        
        // 订单搜索功能
        function showOrderSearch() {
            // 关闭可能存在的其他模态框
            closeOrderSearchModal();
            
            const modal = document.createElement('div');
            modal.id = 'orderSearchModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">🔍 订单查询</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击关闭
                        </div>
                    </div>
                    
                    <form id="orderSearchForm" style="display: grid; gap: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">订单号</label>
                                <input type="text" id="search_order_no" placeholder="输入完整或部分订单号" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">患者信息</label>
                                <input type="text" id="search_patient_info" placeholder="患者姓名或ID" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">支付状态</label>
                                <select id="search_payment_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <option value="">全部状态</option>
                                    <option value="pending">待支付</option>
                                    <option value="paid">已支付</option>
                                    <option value="failed">支付失败</option>
                                    <option value="refunded">已退款</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">支付方式</label>
                                <select id="search_payment_method" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <option value="">全部方式</option>
                                    <option value="alipay">支付宝</option>
                                    <option value="wechat">微信支付</option>
                                    <option value="bank_card">银行卡</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">金额范围(最小)</label>
                                <input type="number" id="search_amount_min" placeholder="0.00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">金额范围(最大)</label>
                                <input type="number" id="search_amount_max" placeholder="1000.00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">开始时间</label>
                                <input type="date" id="search_date_start" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">结束时间</label>
                                <input type="date" id="search_date_end" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">
                                <input type="checkbox" id="search_decoction_only" style="margin-right: 8px;"> 
                                只显示代煎订单
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                🔍 开始搜索
                            </button>
                            <button type="button" onclick="resetOrderSearchForm()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                🔄 重置条件
                            </button>
                            <button type="button" onclick="closeOrderSearchModal()" style="background: #dc2626; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 处理搜索表单提交
            document.getElementById('orderSearchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await performOrderSearch();
            });
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeOrderSearchModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._orderSearchEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeOrderSearchModal() {
            const modal = document.getElementById('orderSearchModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._orderSearchEscListener) {
                document.removeEventListener('keydown', document._orderSearchEscListener);
                document._orderSearchEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        function resetOrderSearchForm() {
            document.getElementById('orderSearchForm').reset();
        }
        
        async function performOrderSearch() {
            try {
                const searchParams = {
                    order_no: document.getElementById('search_order_no').value.trim(),
                    patient_info: document.getElementById('search_patient_info').value.trim(),
                    payment_status: document.getElementById('search_payment_status').value,
                    payment_method: document.getElementById('search_payment_method').value,
                    amount_min: document.getElementById('search_amount_min').value,
                    amount_max: document.getElementById('search_amount_max').value,
                    date_start: document.getElementById('search_date_start').value,
                    date_end: document.getElementById('search_date_end').value,
                    decoction_only: document.getElementById('search_decoction_only').checked
                };
                
                // 先尝试使用API搜索，如果失败则使用客户端搜索
                try {
                    const queryParams = new URLSearchParams();
                    Object.keys(searchParams).forEach(key => {
                        if (searchParams[key] !== '' && searchParams[key] !== false) {
                            queryParams.append(key, searchParams[key]);
                        }
                    });
                    
                    const response = await fetch(`/api/admin/orders/search?${queryParams}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // API搜索成功
                        ordersDataCache = data.orders;
                        displayOrderSearchResults(data.orders);
                        closeOrderSearchModal();
                        alert(`搜索完成，找到 ${data.orders.length} 条订单记录`);
                        return;
                    }
                } catch (apiError) {
                    console.log('API搜索失败，使用客户端搜索:', apiError);
                }
                
                // API搜索失败，使用客户端搜索
                const filteredResults = performOrderClientSideSearch(searchParams);
                displayOrderSearchResults(filteredResults);
                closeOrderSearchModal();
                alert(`搜索完成，找到 ${filteredResults.length} 条订单记录`);
                
            } catch (error) {
                console.error('订单搜索失败:', error);
                alert('订单搜索失败，请重试');
            }
        }
        
        function performOrderClientSideSearch(searchParams) {
            let results = [...ordersDataCache];
            
            // 按订单号筛选
            if (searchParams.order_no) {
                const orderNo = searchParams.order_no.toLowerCase();
                results = results.filter(o => 
                    o.order_no && o.order_no.toLowerCase().includes(orderNo)
                );
            }
            
            // 按患者信息筛选
            if (searchParams.patient_info) {
                const patientInfo = searchParams.patient_info.toLowerCase();
                results = results.filter(o => 
                    (o.patient_name && o.patient_name.toLowerCase().includes(patientInfo)) ||
                    (o.patient_id && o.patient_id.toLowerCase().includes(patientInfo))
                );
            }
            
            // 按支付状态筛选
            if (searchParams.payment_status) {
                results = results.filter(o => o.payment_status === searchParams.payment_status);
            }
            
            // 按支付方式筛选
            if (searchParams.payment_method) {
                results = results.filter(o => o.payment_method === searchParams.payment_method);
            }
            
            // 按金额范围筛选
            if (searchParams.amount_min) {
                const minAmount = parseFloat(searchParams.amount_min);
                results = results.filter(o => (o.amount || 0) >= minAmount);
            }
            if (searchParams.amount_max) {
                const maxAmount = parseFloat(searchParams.amount_max);
                results = results.filter(o => (o.amount || 0) <= maxAmount);
            }
            
            // 按时间范围筛选
            if (searchParams.date_start) {
                const startDate = new Date(searchParams.date_start);
                results = results.filter(o => {
                    if (!o.created_at) return false;
                    const orderDate = new Date(o.created_at);
                    return orderDate >= startDate;
                });
            }
            if (searchParams.date_end) {
                const endDate = new Date(searchParams.date_end);
                endDate.setHours(23, 59, 59, 999); // 设置为当天结束
                results = results.filter(o => {
                    if (!o.created_at) return false;
                    const orderDate = new Date(o.created_at);
                    return orderDate <= endDate;
                });
            }
            
            // 代煎订单筛选
            if (searchParams.decoction_only) {
                results = results.filter(o => o.decoction_required === 1);
            }
            
            return results;
        }
        
        function displayOrderSearchResults(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            if (orders.length > 0) {
                tableBody.innerHTML = '';
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.order_no}</td>
                        <td>${order.patient_name || order.patient_id}</td>
                        <td>¥${order.amount}</td>
                        <td><span class="status-badge status-${order.payment_status === 'paid' ? 'active' : 'pending'}">${getPaymentStatusText(order.payment_status)}</span></td>
                        <td>${order.payment_method || '-'}</td>
                        <td>${formatDate(order.created_at)}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewOrder('${order.id}')" style="padding: 4px 8px; font-size: 12px;">查看</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            未找到符合条件的订单
                        </td>
                    </tr>
                `;
            }
        }
        
        // 收入统计报告功能
        function showRevenueReport() {
            // 关闭可能存在的其他模态框
            closeRevenueReportModal();
            
            const modal = document.createElement('div');
            modal.id = 'revenueReportModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // 计算统计数据
            const stats = calculateRevenueStats();
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 900px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">💰 收入统计报告</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            按ESC键或点击关闭
                        </div>
                    </div>
                    
                    <!-- 统计概览 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">总收入</div>
                            <div style="font-size: 24px; font-weight: bold;">¥${stats.totalRevenue.toFixed(2)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">已支付订单</div>
                            <div style="font-size: 24px; font-weight: bold;">${stats.paidOrders}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #eab308, #ca8a04); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">待支付订单</div>
                            <div style="font-size: 24px; font-weight: bold;">${stats.pendingOrders}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f97316, #ea580c); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">平均订单金额</div>
                            <div style="font-size: 24px; font-weight: bold;">¥${stats.avgOrderAmount.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <!-- 支付方式分布 -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">💳 支付方式分布</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            ${Object.entries(stats.paymentMethods).map(([method, data]) => `
                                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">${getPaymentMethodName(method)}</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${data.count}单</div>
                                    <div style="font-size: 12px; color: #059669;">¥${data.amount.toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- 收入分成统计 -->
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">💰 收入分成统计</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">医生佣金</div>
                                <div style="font-size: 18px; font-weight: bold; color: #dc2626;">¥${stats.doctorCommission.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">推荐佣金</div>
                                <div style="font-size: 18px; font-weight: bold; color: #dc2626;">¥${stats.referrerCommission.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">平台收入</div>
                                <div style="font-size: 18px; font-weight: bold; color: #059669;">¥${stats.platformRevenue.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 代煎订单统计 -->
                    <div style="background: #fefce8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">🚚 代煎订单统计</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">代煎订单</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${stats.decoctionOrders}单</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">代煎收入</div>
                                <div style="font-size: 18px; font-weight: bold; color: #059669;">¥${stats.decoctionRevenue.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">代煎占比</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${((stats.decoctionOrders / (stats.totalOrders || 1)) * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 最近订单趋势 -->
                    <div style="background: #fef3f2; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">📈 最近订单趋势</h4>
                        <div id="orderTrendChart" style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <canvas id="revenueChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="exportRevenueReport()" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            📊 导出报告
                        </button>
                        <button onclick="closeRevenueReportModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绘制收入趋势图
            setTimeout(() => drawRevenueChart(stats.dailyRevenue), 100);
            
            // ESC键关闭
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeRevenueReportModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._revenueReportEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeRevenueReportModal() {
            const modal = document.getElementById('revenueReportModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._revenueReportEscListener) {
                document.removeEventListener('keydown', document._revenueReportEscListener);
                document._revenueReportEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        function calculateRevenueStats() {
            const stats = {
                totalRevenue: 0,
                paidOrders: 0,
                pendingOrders: 0,
                totalOrders: 0,
                avgOrderAmount: 0,
                paymentMethods: {},
                doctorCommission: 0,
                referrerCommission: 0,
                platformRevenue: 0,
                decoctionOrders: 0,
                decoctionRevenue: 0,
                dailyRevenue: {}
            };
            
            ordersDataCache.forEach(order => {
                stats.totalOrders++;
                
                if (order.payment_status === 'paid') {
                    stats.paidOrders++;
                    stats.totalRevenue += parseFloat(order.amount || 0);
                    
                    // 收入分成统计
                    stats.doctorCommission += parseFloat(order.doctor_commission || 0);
                    stats.referrerCommission += parseFloat(order.referrer_commission || 0);
                    stats.platformRevenue += parseFloat(order.platform_revenue || 0);
                    
                    // 支付方式统计
                    const method = order.payment_method || 'unknown';
                    if (!stats.paymentMethods[method]) {
                        stats.paymentMethods[method] = { count: 0, amount: 0 };
                    }
                    stats.paymentMethods[method].count++;
                    stats.paymentMethods[method].amount += parseFloat(order.amount || 0);
                    
                    // 日收入统计
                    const dateKey = order.created_at ? order.created_at.split(' ')[0] : 'unknown';
                    if (!stats.dailyRevenue[dateKey]) {
                        stats.dailyRevenue[dateKey] = 0;
                    }
                    stats.dailyRevenue[dateKey] += parseFloat(order.amount || 0);
                    
                } else if (order.payment_status === 'pending') {
                    stats.pendingOrders++;
                }
                
                // 代煎订单统计
                if (order.decoction_required === 1) {
                    stats.decoctionOrders++;
                    if (order.payment_status === 'paid') {
                        stats.decoctionRevenue += parseFloat(order.amount || 0);
                    }
                }
            });
            
            stats.avgOrderAmount = stats.paidOrders > 0 ? stats.totalRevenue / stats.paidOrders : 0;
            
            return stats;
        }
        
        function getPaymentMethodName(method) {
            switch(method) {
                case 'alipay': return '支付宝';
                case 'wechat': return '微信支付';
                case 'bank_card': return '银行卡';
                default: return '其他';
            }
        }
        
        function drawRevenueChart(dailyData) {
            const canvas = document.getElementById('revenueChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // 清空画布
            ctx.clearRect(0, 0, width, height);
            
            // 准备数据
            const entries = Object.entries(dailyData).sort((a, b) => a[0].localeCompare(b[0]));
            if (entries.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('暂无收入数据', width / 2, height / 2);
                return;
            }
            
            const maxValue = Math.max(...entries.map(e => e[1]));
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // 绘制坐标轴
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();
            
            // 绘制数据点和线条
            if (entries.length > 1) {
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                entries.forEach((entry, index) => {
                    const x = padding + (index / (entries.length - 1)) * chartWidth;
                    const y = height - padding - (entry[1] / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // 绘制数据点
                ctx.fillStyle = '#3b82f6';
                entries.forEach((entry, index) => {
                    const x = padding + (index / (entries.length - 1)) * chartWidth;
                    const y = height - padding - (entry[1] / maxValue) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
            
            // 绘制标签
            ctx.fillStyle = '#6b7280';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            
            // Y轴标签
            for (let i = 0; i <= 5; i++) {
                const value = (maxValue / 5) * i;
                const y = height - padding - (i / 5) * chartHeight;
                ctx.fillText(`¥${value.toFixed(0)}`, 20, y);
            }
        }
        
        function exportRevenueReport() {
            const stats = calculateRevenueStats();
            
            const csvContent = [
                ['收入统计报告', '', ''],
                ['生成时间', new Date().toLocaleString('zh-CN'), ''],
                ['', '', ''],
                ['统计项目', '数值', '单位'],
                ['总收入', stats.totalRevenue.toFixed(2), '元'],
                ['已支付订单', stats.paidOrders, '单'],
                ['待支付订单', stats.pendingOrders, '单'],
                ['平均订单金额', stats.avgOrderAmount.toFixed(2), '元'],
                ['医生佣金', stats.doctorCommission.toFixed(2), '元'],
                ['推荐佣金', stats.referrerCommission.toFixed(2), '元'],
                ['平台收入', stats.platformRevenue.toFixed(2), '元'],
                ['代煎订单', stats.decoctionOrders, '单'],
                ['代煎收入', stats.decoctionRevenue.toFixed(2), '元'],
                ['', '', ''],
                ['支付方式分布', '', ''],
                ...Object.entries(stats.paymentMethods).map(([method, data]) => [
                    getPaymentMethodName(method), data.count + '单', '¥' + data.amount.toFixed(2)
                ])
            ].map(row => row.join(',')).join('\\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `收入统计报告_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('收入统计报告已导出到下载文件夹');
        }

        // ==================== 系统配置管理功能 ====================
        
        let currentSettingsData = {}; // 存储当前配置数据
        
        // 显示配置标签页
        function showSettingsTab(tabName, element) {
            // 更新标签页状态
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.settings-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`settings-${tabName}`).classList.add('active');
        }
        
        // 密码可见性切换
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }
        
        // 温度参数实时更新
        document.addEventListener('DOMContentLoaded', function() {
            const temperatureSlider = document.getElementById('model_temperature');
            const temperatureValue = document.getElementById('temperature_value');
            
            if (temperatureSlider && temperatureValue) {
                temperatureSlider.addEventListener('input', function() {
                    temperatureValue.textContent = this.value;
                });
            }
        });
        
        // 加载系统配置数据
        async function loadSettingsData() {
            // 显示加载状态
            showSaveStatus('loading', '🔄 正在加载配置...');
            
            try {
                const response = await fetch('/api/admin/settings');
                const data = await response.json();
                
                if (data.success) {
                    currentSettingsData = data.settings;
                    populateSettingsForm(data.settings);
                    
                    // 更新左下角状态显示
                    updateSettingsStatus('success', '配置加载成功', '刚刚');
                    
                    // 显示临时成功状态
                    showSaveStatus('success', '📋 配置加载成功');
                    setTimeout(() => hideSaveStatus(), 2000);
                } else {
                    // 如果API不存在，使用默认配置
                    loadDefaultSettings();
                    updateSettingsStatus('warning', '使用默认配置', '刚刚');
                    showSaveStatus('warning', '⚠️ 使用默认配置');
                    setTimeout(() => hideSaveStatus(), 3000);
                }
            } catch (error) {
                console.log('加载配置失败，使用默认配置:', error);
                loadDefaultSettings();
                updateSettingsStatus('error', '加载失败，使用默认配置', '刚刚');
                showSaveStatus('error', '❌ 加载失败，使用默认配置');
                setTimeout(() => hideSaveStatus(), 3000);
            }
        }
        
        // 填充设置表单
        function populateSettingsForm(settings) {
            // 基础设置
            if (settings.basic) {
                setInputValue('system_name', settings.basic.system_name);
                setInputValue('system_version', settings.basic.system_version);
                setInputValue('server_port', settings.basic.server_port);
                setInputValue('domain_name', settings.basic.domain_name);
                setInputValue('database_path', settings.basic.database_path);
                setInputValue('backup_retention', settings.basic.backup_retention);
                setInputValue('log_level', settings.basic.log_level);
                setInputValue('log_retention', settings.basic.log_retention);
                setInputValue('session_timeout', settings.basic.session_timeout);
                setInputValue('upload_limit', settings.basic.upload_limit);
                setInputValue('api_timeout', settings.basic.api_timeout);
                setInputValue('max_connections', settings.basic.max_connections);
            }
            
            // AI模型配置
            if (settings.ai) {
                setInputValue('dashscope_api_key', settings.ai.dashscope_api_key);
                setInputValue('dashscope_endpoint', settings.ai.dashscope_endpoint);
                setInputValue('default_text_model', settings.ai.default_text_model);
                setInputValue('multimodal_model', settings.ai.multimodal_model);
                setInputValue('model_temperature', settings.ai.model_temperature);
                setInputValue('max_tokens', settings.ai.max_tokens);
                setInputValue('daily_cost_limit', settings.ai.daily_cost_limit);
                setInputValue('monthly_cost_limit', settings.ai.monthly_cost_limit);
                setInputValue('retry_attempts', settings.ai.retry_attempts);
                setCheckboxValue('enable_cost_alerts', settings.ai.enable_cost_alerts);
            }
            
            // 业务规则配置
            if (settings.business) {
                setInputValue('standard_prescription_fee', settings.business.standard_prescription_fee);
                setInputValue('decoction_service_fee', settings.business.decoction_service_fee);
                setCheckboxValue('require_doctor_review', settings.business.require_doctor_review);
                setInputValue('prescription_validity', settings.business.prescription_validity);
                setCheckboxValue('require_license_verification', settings.business.require_license_verification);
                setInputValue('doctor_commission_rate', settings.business.doctor_commission_rate);
                setInputValue('review_time_limit', settings.business.review_time_limit);
                setCheckboxValue('auto_assign_doctors', settings.business.auto_assign_doctors);
                setCheckboxValue('require_real_name', settings.business.require_real_name);
                setInputValue('free_consultation_limit', settings.business.free_consultation_limit);
                setInputValue('followup_interval', settings.business.followup_interval);
                setCheckboxValue('enable_patient_feedback', settings.business.enable_patient_feedback);
            }
            
            // 安全策略配置
            if (settings.security) {
                setInputValue('password_min_length', settings.security.password_min_length);
                setCheckboxValue('require_password_complexity', settings.security.require_password_complexity);
                setInputValue('login_failure_limit', settings.security.login_failure_limit);
                setInputValue('account_lockout_duration', settings.security.account_lockout_duration);
                setInputValue('api_rate_limit', settings.security.api_rate_limit);
                setCheckboxValue('enable_ip_whitelist', settings.security.enable_ip_whitelist);
                setInputValue('ip_whitelist', settings.security.ip_whitelist);
                setCheckboxValue('enable_https_only', settings.security.enable_https_only);
                setCheckboxValue('enable_audit_logging', settings.security.enable_audit_logging);
                setInputValue('sensitive_log_retention', settings.security.sensitive_log_retention);
                setCheckboxValue('log_failed_requests', settings.security.log_failed_requests);
                setCheckboxValue('enable_real_time_alerts', settings.security.enable_real_time_alerts);
            }
            
            // 第三方服务配置
            if (settings.integration) {
                setCheckboxValue('enable_alipay', settings.integration.enable_alipay);
                setInputValue('alipay_merchant_id', settings.integration.alipay_merchant_id);
                setCheckboxValue('enable_wechatpay', settings.integration.enable_wechatpay);
                setInputValue('wechat_merchant_id', settings.integration.wechat_merchant_id);
                setInputValue('smtp_server', settings.integration.smtp_server);
                setInputValue('smtp_port', settings.integration.smtp_port);
                setInputValue('sender_email', settings.integration.sender_email);
                setInputValue('sms_api_key', settings.integration.sms_api_key);
                setCheckboxValue('enable_decoction_service', settings.integration.enable_decoction_service);
                setInputValue('decoction_api_endpoint', settings.integration.decoction_api_endpoint);
                setInputValue('decoction_api_key', settings.integration.decoction_api_key);
                setInputValue('delivery_promise_days', settings.integration.delivery_promise_days);
            }
            
            // 更新温度显示值
            const temperatureValue = document.getElementById('temperature_value');
            const temperatureSlider = document.getElementById('model_temperature');
            if (temperatureValue && temperatureSlider) {
                temperatureValue.textContent = temperatureSlider.value;
            }
        }
        
        // 加载默认设置
        function loadDefaultSettings() {
            const defaultSettings = {
                basic: {
                    system_name: "TCM-AI 中医智能诊断系统",
                    system_version: "v2.6.0",
                    server_port: 8000,
                    domain_name: "",
                    database_path: "/opt/tcm-ai/data/user_history.sqlite",
                    backup_retention: 30,
                    log_level: "INFO",
                    log_retention: 90,
                    session_timeout: 60,
                    upload_limit: 10,
                    api_timeout: 30,
                    max_connections: 100
                },
                ai: {
                    dashscope_api_key: "",
                    dashscope_endpoint: "https://dashscope.aliyuncs.com/api/v1/",
                    default_text_model: "qwen-max",
                    multimodal_model: "qwen-vl-max",
                    model_temperature: 0.7,
                    max_tokens: 2000,
                    daily_cost_limit: 500,
                    monthly_cost_limit: 15000,
                    retry_attempts: 3,
                    enable_cost_alerts: false
                },
                business: {
                    standard_prescription_fee: 88,
                    decoction_service_fee: 50,
                    require_doctor_review: false,
                    prescription_validity: 30,
                    require_license_verification: false,
                    doctor_commission_rate: 15,
                    review_time_limit: 24,
                    auto_assign_doctors: false,
                    require_real_name: false,
                    free_consultation_limit: 1,
                    followup_interval: 7,
                    enable_patient_feedback: true
                },
                security: {
                    password_min_length: 8,
                    require_password_complexity: false,
                    login_failure_limit: 5,
                    account_lockout_duration: 15,
                    api_rate_limit: 60,
                    enable_ip_whitelist: false,
                    ip_whitelist: "",
                    enable_https_only: false,
                    enable_audit_logging: true,
                    sensitive_log_retention: 365,
                    log_failed_requests: true,
                    enable_real_time_alerts: false
                },
                integration: {
                    enable_alipay: true,
                    alipay_merchant_id: "",
                    enable_wechatpay: false,
                    wechat_merchant_id: "",
                    smtp_server: "",
                    smtp_port: 587,
                    sender_email: "",
                    sms_api_key: "",
                    enable_decoction_service: true,
                    decoction_api_endpoint: "",
                    decoction_api_key: "",
                    delivery_promise_days: 3
                }
            };
            
            currentSettingsData = defaultSettings;
            populateSettingsForm(defaultSettings);
        }
        
        // 设置输入框值
        function setInputValue(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.value = value;
            }
        }
        
        // 设置复选框值
        function setCheckboxValue(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.checked = !!value;
            }
        }
        
        // 收集所有设置数据
        function collectAllSettings() {
            const settings = {
                basic: {
                    system_name: document.getElementById('system_name').value,
                    system_version: document.getElementById('system_version').value,
                    server_port: parseInt(document.getElementById('server_port').value) || 8000,
                    domain_name: document.getElementById('domain_name').value,
                    database_path: document.getElementById('database_path').value,
                    backup_retention: parseInt(document.getElementById('backup_retention').value) || 30,
                    log_level: document.getElementById('log_level').value,
                    log_retention: parseInt(document.getElementById('log_retention').value) || 90,
                    session_timeout: parseInt(document.getElementById('session_timeout').value) || 60,
                    upload_limit: parseInt(document.getElementById('upload_limit').value) || 10,
                    api_timeout: parseInt(document.getElementById('api_timeout').value) || 30,
                    max_connections: parseInt(document.getElementById('max_connections').value) || 100
                },
                ai: {
                    dashscope_api_key: "[已配置环境变量，请勿修改]",  // 固定值，不从界面获取
                    dashscope_endpoint: document.getElementById('dashscope_endpoint').value,
                    default_text_model: document.getElementById('default_text_model').value,
                    multimodal_model: document.getElementById('multimodal_model').value,
                    model_temperature: parseFloat(document.getElementById('model_temperature').value) || 0.7,
                    max_tokens: parseInt(document.getElementById('max_tokens').value) || 2000,
                    daily_cost_limit: parseInt(document.getElementById('daily_cost_limit').value) || 500,
                    monthly_cost_limit: parseInt(document.getElementById('monthly_cost_limit').value) || 15000,
                    retry_attempts: parseInt(document.getElementById('retry_attempts').value) || 3,
                    enable_cost_alerts: document.getElementById('enable_cost_alerts').checked
                },
                business: {
                    standard_prescription_fee: parseInt(document.getElementById('standard_prescription_fee').value) || 88,
                    decoction_service_fee: parseInt(document.getElementById('decoction_service_fee').value) || 50,
                    require_doctor_review: document.getElementById('require_doctor_review').checked,
                    prescription_validity: parseInt(document.getElementById('prescription_validity').value) || 30,
                    require_license_verification: document.getElementById('require_license_verification').checked,
                    doctor_commission_rate: parseInt(document.getElementById('doctor_commission_rate').value) || 15,
                    review_time_limit: parseInt(document.getElementById('review_time_limit').value) || 24,
                    auto_assign_doctors: document.getElementById('auto_assign_doctors').checked,
                    require_real_name: document.getElementById('require_real_name').checked,
                    free_consultation_limit: parseInt(document.getElementById('free_consultation_limit').value) || 1,
                    followup_interval: parseInt(document.getElementById('followup_interval').value) || 7,
                    enable_patient_feedback: document.getElementById('enable_patient_feedback').checked
                },
                security: {
                    password_min_length: parseInt(document.getElementById('password_min_length').value) || 8,
                    require_password_complexity: document.getElementById('require_password_complexity').checked,
                    login_failure_limit: parseInt(document.getElementById('login_failure_limit').value) || 5,
                    account_lockout_duration: parseInt(document.getElementById('account_lockout_duration').value) || 15,
                    api_rate_limit: parseInt(document.getElementById('api_rate_limit').value) || 60,
                    enable_ip_whitelist: document.getElementById('enable_ip_whitelist').checked,
                    ip_whitelist: document.getElementById('ip_whitelist').value,
                    enable_https_only: document.getElementById('enable_https_only').checked,
                    enable_audit_logging: document.getElementById('enable_audit_logging').checked,
                    sensitive_log_retention: parseInt(document.getElementById('sensitive_log_retention').value) || 365,
                    log_failed_requests: document.getElementById('log_failed_requests').checked,
                    enable_real_time_alerts: document.getElementById('enable_real_time_alerts').checked
                },
                integration: {
                    enable_alipay: document.getElementById('enable_alipay').checked,
                    alipay_merchant_id: document.getElementById('alipay_merchant_id').value,
                    enable_wechatpay: document.getElementById('enable_wechatpay').checked,
                    wechat_merchant_id: document.getElementById('wechat_merchant_id').value,
                    smtp_server: document.getElementById('smtp_server').value,
                    smtp_port: parseInt(document.getElementById('smtp_port').value) || 587,
                    sender_email: document.getElementById('sender_email').value,
                    sms_api_key: document.getElementById('sms_api_key').value,
                    enable_decoction_service: document.getElementById('enable_decoction_service').checked,
                    decoction_api_endpoint: document.getElementById('decoction_api_endpoint').value,
                    decoction_api_key: document.getElementById('decoction_api_key').value,
                    delivery_promise_days: parseInt(document.getElementById('delivery_promise_days').value) || 3
                }
            };
            
            return settings;
        }
        
        // 保存所有配置
        async function saveAllSettings() {
            const settings = collectAllSettings();
            const saveButton = document.querySelector('.btn.btn-primary');
            const originalText = saveButton.textContent;
            
            try {
                saveButton.textContent = '💾 保存中...';
                saveButton.disabled = true;
                
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新左下角状态显示
                    updateSettingsStatus('success', '配置保存成功', '刚刚');
                    
                    // 显示临时成功状态
                    showSaveStatus('success', '✅ 配置保存成功！');
                    currentSettingsData = settings;
                    
                    // 3秒后自动隐藏状态
                    setTimeout(() => hideSaveStatus(), 3000);
                } else {
                    throw new Error(data.message || '保存失败');
                }
                
            } catch (error) {
                console.error('保存配置失败:', error);
                
                // 更新左下角状态显示
                updateSettingsStatus('error', '保存失败: ' + error.message, '刚刚');
                
                // 显示错误状态
                showSaveStatus('error', '❌ 保存失败: ' + error.message);
                
                // 临时保存到localStorage作为备用
                localStorage.setItem('tcm_ai_settings_backup', JSON.stringify(settings));
                
                // 5秒后自动隐藏状态
                setTimeout(() => hideSaveStatus(), 5000);
            } finally {
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            }
        }
        
        // 重置为默认值
        function resetToDefaults() {
            if (confirm('⚠️ 确定要重置所有配置为默认值吗？\\n\\n此操作将清除所有自定义配置，无法撤销。')) {
                loadDefaultSettings();
                updateSettingsStatus('warning', '已重置为默认配置', '刚刚');
                alert('🔄 所有配置已重置为默认值。\\n\\n记得点击"保存所有配置"来保存更改。');
            }
        }
        
        // 显示保存状态
        function showSaveStatus(type, message) {
            const statusDiv = document.getElementById('save-status');
            const iconSpan = document.getElementById('save-status-icon');
            const textSpan = document.getElementById('save-status-text');
            
            if (!statusDiv || !iconSpan || !textSpan) return;
            
            // 设置样式和内容
            if (type === 'success') {
                statusDiv.style.backgroundColor = '#dcfce7';
                statusDiv.style.color = '#059669';
                statusDiv.style.border = '1px solid #bbf7d0';
                iconSpan.textContent = '✅';
            } else if (type === 'error') {
                statusDiv.style.backgroundColor = '#fef2f2';
                statusDiv.style.color = '#dc2626';
                statusDiv.style.border = '1px solid #fecaca';
                iconSpan.textContent = '❌';
            } else if (type === 'loading') {
                statusDiv.style.backgroundColor = '#e0f2fe';
                statusDiv.style.color = '#0369a1';
                statusDiv.style.border = '1px solid #bae6fd';
                iconSpan.textContent = '🔄';
            } else if (type === 'warning') {
                statusDiv.style.backgroundColor = '#fffbeb';
                statusDiv.style.color = '#d97706';
                statusDiv.style.border = '1px solid #fed7aa';
                iconSpan.textContent = '⚠️';
            }
            
            textSpan.textContent = message;
            statusDiv.style.display = 'flex';
        }
        
        // 隐藏保存状态
        function hideSaveStatus() {
            const statusDiv = document.getElementById('save-status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }
        
        // 更新设置状态显示
        function updateSettingsStatus(type, text, time) {
            const statusElement = document.getElementById('settings-status');
            if (!statusElement) return;
            
            const iconElement = statusElement.querySelector('.status-icon');
            const textElement = statusElement.querySelector('.status-text');
            const timeElement = statusElement.querySelector('.status-time');
            
            // 更新图标和颜色
            switch (type) {
                case 'success':
                    iconElement.textContent = '✅';
                    statusElement.style.color = '#059669';
                    break;
                case 'error':
                    iconElement.textContent = '❌';
                    statusElement.style.color = '#dc2626';
                    break;
                case 'warning':
                    iconElement.textContent = '⚠️';
                    statusElement.style.color = '#d97706';
                    break;
                default:
                    iconElement.textContent = '💾';
                    statusElement.style.color = '#059669';
            }
            
            textElement.textContent = text;
            timeElement.textContent = time;
        }


        // 加载日志数据
        async function loadLogsData() {
            try {
                const response = await fetch('/api/admin/logs?page=1&per_page=50');
                const data = await response.json();
                
                const tableBody = document.getElementById('logsTableBody');
                if (data.success && data.logs.length > 0) {
                    tableBody.innerHTML = '';
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(log.timestamp)}</td>
                            <td><span class="status-badge status-${log.level.toLowerCase() === 'info' ? 'active' : 'pending'}">${log.level}</span></td>
                            <td>${log.source}</td>
                            <td style="max-width: 400px; word-break: break-word;">${log.message}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: #6b7280;">
                                暂无日志数据
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('加载日志数据失败:', error);
                document.getElementById('logsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">
                            加载失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // 工具函数
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusClass(status) {
            const statusMap = {
                'pending': 'pending',
                'approved': 'active',
                'rejected': 'inactive',
                'completed': 'active'
            };
            return statusMap[status] || 'pending';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待审核',
                'doctor_reviewing': '医生审核中',
                'approved': '已批准',
                'rejected': '已拒绝',
                'patient_confirmed': '患者已确认',
                'paid': '已支付',
                'completed': '已完成'
            };
            return statusMap[status] || status;
        }

        function getPaymentStatusText(status) {
            const statusMap = {
                'pending': '待支付',
                'paid': '已支付',
                'failed': '支付失败',
                'refunded': '已退款',
                'cancelled': '已取消'
            };
            return statusMap[status] || status;
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出管理系统吗？')) {
                localStorage.removeItem('adminToken');
                window.location.href = '/login';
            }
        }

        // 快速跳转到患者问诊界面
        function goToPatientInterface() {
            // 在新窗口/标签页打开患者界面，避免丢失管理界面
            window.open('/patient', '_blank');
        }
    </script>
</body>
</html>