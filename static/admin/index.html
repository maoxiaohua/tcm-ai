<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ç³»ç»Ÿç®¡ç†ä¸­å¿ƒ - ä¸­åŒ»AIè¯Šç–—å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .admin-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-title h1 {
            color: #1f2937;
            font-size: 24px;
            font-weight: 600;
        }

        .admin-title .badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #6b7280;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* å¿«é€Ÿå¯¼èˆªæŒ‰é’® */
        .quick-nav-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .quick-nav-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        /* ä¸»è¦å†…å®¹ */
        .admin-main {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 30px;
        }

        /* ä¾§è¾¹å¯¼èˆª */
        .admin-sidebar {
            width: 280px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px 0;
            height: fit-content;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            margin-bottom: 8px;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: #374151;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar-link:hover {
            background: linear-gradient(135deg, #eff6ff, #e0f2fe);
            color: #1e40af;
        }

        .sidebar-link.active {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border-radius: 0 25px 25px 0;
        }

        .sidebar-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* å†…å®¹åŒºåŸŸ */
        .admin-content {
            flex: 1;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .content-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .content-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .content-subtitle {
            color: #6b7280;
            font-size: 16px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            font-size: 24px;
            opacity: 0.7;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .table-header {
            background: #f8fafc;
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .table-content {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-inactive {
            background: #fee2e2;
            color: #dc2626;
        }

        /* ç³»ç»Ÿç›‘æ§ç»„ä»¶ */
        .monitor-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .monitor-chart {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .monitor-alerts {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .alert-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .stat-change.neutral {
            color: #d97706;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .alert-item:hover {
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .mobile-menu-btn {
            display: none;
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(0,0,0,0.1);
            color: #374151;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ç§»åŠ¨ç«¯é®ç½© */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* å¹³æ¿é€‚é… */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 250px;
            }

            .admin-main {
                gap: 15px;
                padding: 25px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .monitor-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 28px;
            }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .admin-header {
                padding: 12px 16px;
                position: relative;
                z-index: 1001;
            }

            .admin-title h1 {
                font-size: 20px;
            }

            .admin-title .badge {
                font-size: 10px;
                padding: 3px 8px;
            }

            .admin-user span {
                display: none;
            }

            .admin-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .admin-main {
                flex-direction: column;
                padding: 16px;
                gap: 16px;
            }

            .admin-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                background: rgba(255,255,255,0.98);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
                padding-top: 80px;
                backdrop-filter: blur(20px);
            }

            .admin-sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-link {
                padding: 16px 20px;
                font-size: 15px;
            }

            .sidebar-icon {
                font-size: 18px;
                width: 20px;
            }

            .admin-content {
                width: 100%;
                padding: 20px 16px;
                margin: 0;
            }

            .content-title {
                font-size: 24px;
            }

            .content-subtitle {
                font-size: 14px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            .stat-card {
                padding: 18px;
            }

            .stat-value {
                font-size: 26px;
                margin-bottom: 6px;
            }

            .stat-change {
                font-size: 13px;
            }

            .monitor-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            .monitor-chart,
            .monitor-alerts {
                padding: 20px 16px;
            }

            .alert-item {
                padding: 10px;
                font-size: 14px;
            }

            .data-table {
                margin-bottom: 20px;
            }

            .table-header {
                padding: 16px 18px;
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .table-title {
                font-size: 16px;
            }

            .table-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 12px 14px;
            }

            th {
                font-size: 12px;
            }
        }

        /* å°å±æ‰‹æœºé€‚é… */
        @media (max-width: 480px) {
            .admin-header {
                padding: 10px 12px;
            }

            .admin-title h1 {
                font-size: 18px;
            }

            .admin-sidebar {
                width: 260px;
            }

            .admin-main {
                padding: 12px;
            }

            .admin-content {
                padding: 16px 12px;
            }

            .content-title {
                font-size: 22px;
            }

            .stats-grid {
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-header {
                margin-bottom: 12px;
            }

            .stat-title {
                font-size: 12px;
            }

            .stat-icon {
                font-size: 20px;
            }

            .monitor-chart,
            .monitor-alerts {
                padding: 16px 12px;
            }

            .table-header {
                padding: 14px 16px;
            }

            th, td {
                padding: 10px 12px;
                font-size: 13px;
            }

            .status-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        /* å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šä¼˜åŒ– */
        @media screen and (max-width: 768px) {
            .admin-container {
                min-height: -webkit-fill-available;
            }

            .admin-sidebar {
                padding-top: max(80px, env(safe-area-inset-top) + 80px);
            }

            .admin-header {
                padding-top: max(12px, env(safe-area-inset-top) + 12px);
            }
        }

        /* æ¨ªå±é€‚é… */
        @media (max-width: 768px) and (orientation: landscape) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .monitor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- ç§»åŠ¨ç«¯é®ç½© -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
        
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="admin-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">â˜°</button>
                <div class="admin-title">
                    <h1>ğŸ› ï¸ ç³»ç»Ÿç®¡ç†ä¸­å¿ƒ</h1>
                    <span class="badge">ADMIN</span>
                </div>
            </div>
            <div class="admin-user">
                <button class="quick-nav-btn" onclick="goToPatientInterface()" title="å¿«é€Ÿè·³è½¬åˆ°æ‚£è€…é—®è¯Šç•Œé¢">
                    ğŸ¥ æ‚£è€…é—®è¯Š
                </button>
                <span id="adminName">ç®¡ç†å‘˜</span>
                <div class="admin-avatar">ç®¡</div>
                <button class="logout-btn" onclick="logout()">é€€å‡º</button>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="admin-main">
            <!-- ä¾§è¾¹å¯¼èˆª -->
            <div class="admin-sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item">
                        <a href="#dashboard" class="sidebar-link active" onclick="showSection('dashboard', this)">
                            <span class="sidebar-icon">ğŸ“Š</span>
                            <span>ä»ªè¡¨æ¿</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#users" class="sidebar-link" onclick="showSection('users', this)">
                            <span class="sidebar-icon">ğŸ‘¥</span>
                            <span>ç”¨æˆ·ç®¡ç†</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#doctors" class="sidebar-link" onclick="showSection('doctors', this)">
                            <span class="sidebar-icon">ğŸ‘¨â€âš•ï¸</span>
                            <span>åŒ»ç”Ÿç®¡ç†</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#prescriptions" class="sidebar-link" onclick="showSection('prescriptions', this)">
                            <span class="sidebar-icon">ğŸ“‹</span>
                            <span>å¤„æ–¹ç®¡ç†</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#orders" class="sidebar-link" onclick="showSection('orders', this)">
                            <span class="sidebar-icon">ğŸ›’</span>
                            <span>è®¢å•ç®¡ç†</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#system" class="sidebar-link" onclick="showSection('system', this)">
                            <span class="sidebar-icon">âš™ï¸</span>
                            <span>ç³»ç»Ÿç›‘æ§</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#settings" class="sidebar-link" onclick="showSection('settings', this)">
                            <span class="sidebar-icon">ğŸ”§</span>
                            <span>ç³»ç»Ÿé…ç½®</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#logs" class="sidebar-link" onclick="showSection('logs', this)">
                            <span class="sidebar-icon">ğŸ“œ</span>
                            <span>æ“ä½œæ—¥å¿—</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="admin-content">
                <!-- ä»ªè¡¨æ¿ -->
                <div id="dashboard" class="content-section active">
                    <div class="content-header">
                        <h2 class="content-title">ç³»ç»Ÿä»ªè¡¨æ¿</h2>
                        <p class="content-subtitle">å®æ—¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œå…³é”®æŒ‡æ ‡</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">æ€»ç”¨æˆ·æ•°</span>
                                <span class="stat-icon">ğŸ‘¥</span>
                            </div>
                            <div class="stat-value" id="totalUsers">-</div>
                            <div class="stat-change positive">
                                <span>â†—</span>
                                <span>+12% æœ¬æœˆ</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">æ´»è·ƒåŒ»ç”Ÿ</span>
                                <span class="stat-icon">ğŸ‘¨â€âš•ï¸</span>
                            </div>
                            <div class="stat-value" id="activeDoctors">-</div>
                            <div class="stat-change positive">
                                <span>â†—</span>
                                <span>+8% æœ¬æœˆ</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">ä»Šæ—¥é—®è¯Š</span>
                                <span class="stat-icon">ğŸ©º</span>
                            </div>
                            <div class="stat-value" id="todayConsultations">-</div>
                            <div class="stat-change positive">
                                <span>ğŸ“ˆ</span>
                                <span id="consultationsTrend">ä»Šæ—¥æ•°æ®</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">å¾…å®¡å¤„æ–¹</span>
                                <span class="stat-icon">ğŸ“‹</span>
                            </div>
                            <div class="stat-value" id="pendingPrescriptions">-</div>
                            <div class="stat-change" id="prescriptionTrend">
                                <span>â³</span>
                                <span>å¾…å¤„ç†</span>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-grid">
                        <div class="monitor-chart">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">ç³»ç»ŸçŠ¶æ€ç›‘æ§</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ–¥ï¸</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #10b981;">æ­£å¸¸è¿è¡Œ</div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;" id="systemUptime">99.9% å¯ç”¨æ€§</div>
                                </div>
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ‘¥</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #3b82f6;" id="activeSessions">-</div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">æ´»è·ƒä¼šè¯</div>
                                </div>
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“…</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #8b5cf6;" id="monthlyNewUsers">-</div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">æœ¬æœˆæ–°å¢</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="font-size: 14px; color: #065f46;">
                                    <strong>âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸</strong><br>
                                    <small>æœ€åæ›´æ–°: <span id="lastUpdated">-</span></small>
                                </div>
                            </div>
                        </div>

                        <div class="monitor-alerts">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">ç³»ç»Ÿè­¦å‘Š</h3>
                            <div id="alertsList">
                                <div class="alert-item alert-info">
                                    <span>â³</span>
                                    <div>
                                        <strong>åŠ è½½ä¸­...</strong><br>
                                        <small>æ­£åœ¨è·å–ç³»ç»Ÿè­¦å‘Šä¿¡æ¯</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç† -->
                <div id="users" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">ç”¨æˆ·ç®¡ç†</h2>
                        <p class="content-subtitle">ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç”¨æˆ·è´¦æˆ·</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">ç”¨æˆ·åˆ—è¡¨</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="exportUsersData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
                                <button class="btn btn-primary" onclick="addNewUser()">ğŸ‘¤ æ·»åŠ ç”¨æˆ·</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ç”¨æˆ·ID</th>
                                        <th>å§“å</th>
                                        <th>é‚®ç®±</th>
                                        <th>æ³¨å†Œæ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                                            æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- åŒ»ç”Ÿç®¡ç† -->
                <div id="doctors" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">åŒ»ç”Ÿç®¡ç†</h2>
                        <p class="content-subtitle">ç®¡ç†æ³¨å†ŒåŒ»ç”Ÿå’Œå®¡æ ¸æµç¨‹</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">åŒ»ç”Ÿåˆ—è¡¨</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="showDoctorReviewList()">ğŸ“‹ å®¡æ ¸åˆ—è¡¨</button>
                                <button class="btn btn-primary" onclick="addNewDoctor()">ğŸ‘¨â€âš•ï¸ æ·»åŠ åŒ»ç”Ÿ</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>å§“å</th>
                                        <th>æ‰§ä¸šè¯å·</th>
                                        <th>ä¸“ç§‘</th>
                                        <th>åŒ»é™¢</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ³¨å†Œæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="doctorsTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                                            æ­£åœ¨åŠ è½½åŒ»ç”Ÿæ•°æ®...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- å¤„æ–¹ç®¡ç† -->
                <div id="prescriptions" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">å¤„æ–¹ç®¡ç†</h2>
                        <p class="content-subtitle">ç›‘æ§å’Œç®¡ç†æ‰€æœ‰å¤„æ–¹è®°å½•</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">å¤„æ–¹åˆ—è¡¨</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="showPrescriptionStats()">ğŸ“Š ç»Ÿè®¡æŠ¥å‘Š</button>
                                <button class="btn btn-primary" onclick="showAdvancedSearch()">ğŸ” é«˜çº§æœç´¢</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>å¤„æ–¹ID</th>
                                        <th>æ‚£è€…ä¿¡æ¯</th>
                                        <th>åŒ»ç”Ÿ</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>å®¡æ ¸æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="prescriptionsTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                            æ­£åœ¨åŠ è½½å¤„æ–¹æ•°æ®...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- è®¢å•ç®¡ç† -->
                <div id="orders" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">è®¢å•ç®¡ç†</h2>
                        <p class="content-subtitle">ç®¡ç†ç”¨æˆ·è®¢å•å’Œæ”¯ä»˜æµç¨‹</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">è®¢å•åˆ—è¡¨</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary" onclick="showRevenueReport()">ğŸ’° æ”¶å…¥ç»Ÿè®¡</button>
                                <button class="btn btn-primary" onclick="showOrderSearch()">ğŸ” è®¢å•æŸ¥è¯¢</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>è®¢å•å·</th>
                                        <th>æ‚£è€…</th>
                                        <th>é‡‘é¢</th>
                                        <th>æ”¯ä»˜çŠ¶æ€</th>
                                        <th>æ”¯ä»˜æ–¹å¼</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                            æ­£åœ¨åŠ è½½è®¢å•æ•°æ®...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿç›‘æ§ -->
                <div id="system" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">ç³»ç»Ÿç›‘æ§</h2>
                        <p class="content-subtitle">å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½å’Œèµ„æºä½¿ç”¨æƒ…å†µ</p>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">CPUä½¿ç”¨ç‡</span>
                                <span class="stat-icon">ğŸ–¥ï¸</span>
                            </div>
                            <div class="stat-value" id="cpuUsage">-</div>
                            <div class="stat-change positive">
                                <span>â†—</span>
                                <span>æ­£å¸¸èŒƒå›´</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">å†…å­˜ä½¿ç”¨</span>
                                <span class="stat-icon">ğŸ’¾</span>
                            </div>
                            <div class="stat-value" id="memoryUsage">-</div>
                            <div class="stat-change positive">
                                <span>â†—</span>
                                <span>å¯ç”¨å……è¶³</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">ç£ç›˜ä½¿ç”¨</span>
                                <span class="stat-icon">ğŸ’½</span>
                            </div>
                            <div class="stat-value" id="diskUsage">-</div>
                            <div class="stat-change positive">
                                <span>â†—</span>
                                <span>ç©ºé—´å……è¶³</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">ç³»ç»ŸçŠ¶æ€</span>
                                <span class="stat-icon">âœ…</span>
                            </div>
                            <div class="stat-value" style="font-size: 18px; color: #10b981;">è¿è¡Œæ­£å¸¸</div>
                            <div class="stat-change positive">
                                <span>â†—</span>
                                <span>99.9% åœ¨çº¿</span>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-grid">
                        <div class="monitor-chart">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">ç³»ç»Ÿèµ„æºç›‘æ§</h3>
                            <div id="systemMonitorContent">
                                <div style="text-align: center; padding: 40px; color: #6b7280;">
                                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“Š</div>
                                    <p>æ­£åœ¨åŠ è½½ç³»ç»Ÿç›‘æ§æ•°æ®...</p>
                                </div>
                            </div>
                        </div>

                        <div class="monitor-alerts">
                            <h3 style="margin-bottom: 20px; color: #1f2937;">ç³»ç»Ÿè­¦å‘Š</h3>
                            <div id="systemAlertsContent">
                                <div class="alert-item alert-info">
                                    <span>â„¹ï¸</span>
                                    <div>
                                        <strong>ç³»ç»Ÿæ­£å¸¸</strong><br>
                                        <small>æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿé…ç½® -->
                <div id="settings" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">ç³»ç»Ÿé…ç½®</h2>
                        <p class="content-subtitle">ç®¡ç†ç³»ç»Ÿå‚æ•°å’Œé…ç½®é€‰é¡¹</p>
                    </div>

                    <div style="text-align: center; padding: 60px; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ”§</div>
                        <p>ç³»ç»Ÿé…ç½®åŠŸèƒ½å¼€å‘ä¸­...</p>
                        <p style="margin-top: 10px;">å°†åŒ…å«ç³»ç»Ÿå‚æ•°ã€é‚®ä»¶é…ç½®ç­‰è®¾ç½®</p>
                    </div>
                </div>

                <!-- æ“ä½œæ—¥å¿— -->
                <div id="logs" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">æ“ä½œæ—¥å¿—</h2>
                        <p class="content-subtitle">æŸ¥çœ‹ç³»ç»Ÿæ“ä½œå’Œå®¡è®¡æ—¥å¿—</p>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">ç³»ç»Ÿæ—¥å¿—</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary">ğŸ“¥ å¯¼å‡ºæ—¥å¿—</button>
                                <button class="btn btn-primary">ğŸ” æœç´¢è¿‡æ»¤</button>
                            </div>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>çº§åˆ«</th>
                                        <th>æ¥æº</th>
                                        <th>æ¶ˆæ¯</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 40px; color: #6b7280;">
                                            æ­£åœ¨åŠ è½½æ—¥å¿—æ•°æ®...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadDashboardData();
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°ä»ªè¡¨æ¿æ•°æ®ï¼ˆæ¯5åˆ†é’Ÿï¼‰
            setInterval(loadDashboardData, 5 * 60 * 1000);
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            closeEditModal();
        });
        
        // å¯¼å‡ºç”¨æˆ·æ•°æ®åŠŸèƒ½
        function exportUsersData() {
            if (usersDataCache.length === 0) {
                alert('æš‚æ— ç”¨æˆ·æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆåŠ è½½ç”¨æˆ·åˆ—è¡¨');
                return;
            }
            
            try {
                // å‡†å¤‡å¯¼å‡ºæ•°æ®
                const exportData = usersDataCache.map(user => ({
                    'ç”¨æˆ·ID': user.id,
                    'ç”¨æˆ·å': user.username,
                    'æ˜¾ç¤ºåç§°': user.display_name || '',
                    'é‚®ç®±': user.email || '',
                    'æ‰‹æœºå·': user.phone_number === 'æœªè®¾ç½®' ? '' : (user.phone_number || ''),
                    'è´¦æˆ·çŠ¶æ€': user.account_status,
                    'è§’è‰²': (user.roles || []).join(','),
                    'æ³¨å†Œæ—¶é—´': user.created_at ? new Date(user.created_at).toLocaleString('zh-CN') : '',
                    'æœ€åç™»å½•': user.last_login_at ? new Date(user.last_login_at).toLocaleString('zh-CN') : 'ä»æœªç™»å½•'
                }));
                
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                const headers = Object.keys(exportData[0]);
                const csvContent = [
                    headers.join(','),
                    ...exportData.map(row => 
                        headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
                    )
                ].join('\n');
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `ç”¨æˆ·æ•°æ®å¯¼å‡º_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`æˆåŠŸå¯¼å‡º ${exportData.length} æ¡ç”¨æˆ·æ•°æ®`);
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
        
        // æ·»åŠ æ–°ç”¨æˆ·åŠŸèƒ½
        function addNewUser() {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼–è¾‘æ¨¡æ€æ¡†ï¼Œå¦‚æœæœ‰åˆ™å…ˆå…³é—­
            closeEditModal();
            
            // åˆ›å»ºæ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'editUserModal'; // å¤ç”¨ç›¸åŒçš„IDå’Œå…³é—­é€»è¾‘
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // ç§»é™¤ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½ï¼Œåªå…è®¸é€šè¿‡å–æ¶ˆæŒ‰é’®æˆ–ESCé”®å…³é—­
            // modal.addEventListener('click', function(e) {
            //     if (e.target === modal) {
            //         closeEditModal();
            //     }
            // });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">æ·»åŠ æ–°ç”¨æˆ·</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å–æ¶ˆå…³é—­
                        </div>
                    </div>
                    <form id="addUserForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">ç”¨æˆ·å *:</label>
                            <input type="text" id="add_username" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="4-20ä½ï¼Œæ”¯æŒä¸­è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ˜¾ç¤ºåç§° *:</label>
                            <input type="text" id="add_display_name" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="ç”¨æˆ·çš„æ˜¾ç¤ºåç§°">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">é‚®ç®±:</label>
                            <input type="email" id="add_email" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="ç”¨æˆ·é‚®ç®±åœ°å€">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ‰‹æœºå·:</label>
                            <input type="text" id="add_phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="11ä½æ‰‹æœºå·ç ">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">åˆå§‹å¯†ç  *:</label>
                            <input type="password" id="add_password" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="è‡³å°‘6ä½å¯†ç ">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">ç”¨æˆ·è§’è‰² *:</label>
                            <select id="add_role" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="PATIENT">æ‚£è€…</option>
                                <option value="DOCTOR">åŒ»ç”Ÿ</option>
                                <option value="ADMIN">ç®¡ç†å‘˜</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">è´¦æˆ·çŠ¶æ€:</label>
                            <select id="add_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="active">æ´»è·ƒ</option>
                                <option value="suspended">æš‚åœ</option>
                                <option value="locked">é”å®š</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closeEditModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">å–æ¶ˆ</button>
                            <button type="submit" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">åˆ›å»ºç”¨æˆ·</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¤„ç†è¡¨å•æäº¤
            document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createNewUser({
                    username: document.getElementById('add_username').value,
                    display_name: document.getElementById('add_display_name').value,
                    email: document.getElementById('add_email').value,
                    phone_number: document.getElementById('add_phone').value,
                    password: document.getElementById('add_password').value,
                    role: document.getElementById('add_role').value,
                    account_status: document.getElementById('add_status').value
                });
            });
            
            // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
            const handleEscKey = (e) => {
                if (e.key === 'Escape') {
                    closeEditModal();
                }
            };
            document.addEventListener('keydown', handleEscKey);
            
            // è®°å½•ç›‘å¬å™¨ä»¥ä¾¿æ¸…ç†
            if (!document._escListeners) {
                document._escListeners = [];
            }
            document._escListeners.push(handleEscKey);
        }
        
        // åˆ›å»ºæ–°ç”¨æˆ·
        async function createNewUser(userData) {
            try {
                const response = await fetch('/api/auth/register/username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: userData.username,
                        password: userData.password,
                        display_name: userData.display_name,
                        email: userData.email,
                        phone_number: userData.phone_number
                    })
                });
                
                const data = await response.json();
                
                if (data.success || response.ok) {
                    alert('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼');
                    closeEditModal();
                    loadUsersData(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        function checkAdminAuth() {
            // ç»Ÿä¸€è®¤è¯tokenæ£€æŸ¥
            let token = localStorage.getItem('session_token') || 
                        localStorage.getItem('adminToken') ||
                        getCookie('session_token');
            
            // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            console.log('æ£€æŸ¥ç®¡ç†å‘˜æƒé™ - token:', token ? token.substring(0, 20) + '...' : 'æ— ');
            console.log('æ£€æŸ¥ç®¡ç†å‘˜æƒé™ - ç”¨æˆ·ä¿¡æ¯:', currentUser);
            
            if (!token) {
                console.log('æœªæ‰¾åˆ°è®¤è¯tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                window.location.href = '/login';
                return;
            }
            
            // æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦ä¸ºç®¡ç†å‘˜
            if (currentUser.primary_role !== 'admin' && currentUser.primary_role !== 'superadmin') {
                console.log('ç”¨æˆ·è§’è‰²ä¸æ˜¯ç®¡ç†å‘˜:', currentUser.primary_role, 'è·³è½¬åˆ°ç™»å½•é¡µé¢');
                window.location.href = '/login';
                return;
            }
            
            // ä¿å­˜tokenåˆ°adminTokenï¼ˆå‘åå…¼å®¹ï¼‰
            localStorage.setItem('adminToken', token);
            
            console.log('ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡');
            showUserInfo(currentUser.display_name || 'ç®¡ç†å‘˜', currentUser.primary_role);
        }
        
        // è·å–Cookieçš„è¾…åŠ©å‡½æ•°
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo(userName, userType) {
            // åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            const headerRight = document.querySelector('.header-right');
            if (headerRight) {
                const userInfo = document.createElement('div');
                userInfo.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #666;
                    font-size: 14px;
                `;
                const statusColor = userType === 'admin' ? '#2196F3' : '#4CAF50';
                userInfo.innerHTML = `
                    <span style="color: ${statusColor};">â—</span>
                    <span>${userName}</span>
                `;
                headerRight.insertBefore(userInfo, headerRight.firstChild);
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/admin/dashboard');
                const data = await response.json();
                if (data.success) {
                    updateDashboardStats(data.stats);
                    updateAlertsList(data.alerts);
                } else {
                    // APIå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ•°æ®
                    document.getElementById('totalUsers').textContent = '1,234';
                    document.getElementById('activeDoctors').textContent = '6';
                    document.getElementById('todayConsultations').textContent = '156';
                    document.getElementById('pendingPrescriptions').textContent = '0';
                    updateAlertsList([]);
                }
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
                // ç½‘ç»œé”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤æ•°æ®
                document.getElementById('totalUsers').textContent = '1,234';
                document.getElementById('activeDoctors').textContent = '6';
                document.getElementById('todayConsultations').textContent = '156';
                document.getElementById('pendingPrescriptions').textContent = '0';
                updateAlertsList([]);
            }
        }

        // æ›´æ–°ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ®
        function updateDashboardStats(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users.toLocaleString();
            document.getElementById('activeDoctors').textContent = stats.active_doctors.toString();
            document.getElementById('todayConsultations').textContent = stats.today_consultations.toString();
            document.getElementById('pendingPrescriptions').textContent = stats.pending_prescriptions.toString();
            document.getElementById('activeSessions').textContent = stats.active_sessions.toString();
            document.getElementById('monthlyNewUsers').textContent = stats.monthly_new_users.toString();
            document.getElementById('systemUptime').textContent = stats.system_uptime + ' å¯ç”¨æ€§';
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            const lastUpdated = new Date(stats.last_updated);
            document.getElementById('lastUpdated').textContent = lastUpdated.toLocaleString('zh-CN');
            
            // æ›´æ–°å¤„æ–¹è¶‹åŠ¿é¢œè‰²
            const prescriptionTrend = document.getElementById('prescriptionTrend');
            if (stats.pending_prescriptions > 10) {
                prescriptionTrend.className = 'stat-change negative';
                prescriptionTrend.innerHTML = '<span>âš ï¸</span><span>éœ€è¦å…³æ³¨</span>';
            } else if (stats.pending_prescriptions > 5) {
                prescriptionTrend.className = 'stat-change neutral';
                prescriptionTrend.innerHTML = '<span>â³</span><span>é€‚ä¸­å¤„ç†</span>';
            } else {
                prescriptionTrend.className = 'stat-change positive';
                prescriptionTrend.innerHTML = '<span>âœ…</span><span>çŠ¶æ€è‰¯å¥½</span>';
            }
        }
        
        // æ›´æ–°ç³»ç»Ÿè­¦å‘Šåˆ—è¡¨
        function updateAlertsList(alerts) {
            const alertsList = document.getElementById('alertsList');
            if (!alerts || alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="alert-item alert-success">
                        <span>âœ…</span>
                        <div>
                            <strong>ç³»ç»Ÿæ­£å¸¸</strong><br>
                            <small>æš‚æ— ç³»ç»Ÿè­¦å‘Š</small>
                        </div>
                    </div>
                `;
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.type}" onclick="handleAlertClick('${alert.action_url}')" style="cursor: pointer;">
                    <span>${getAlertIcon(alert.type)}</span>
                    <div>
                        <strong>${alert.title}</strong><br>
                        <small>${alert.message}</small>
                    </div>
                    <span style="margin-left: auto; color: #6b7280;">ğŸ‘†</span>
                </div>
            `).join('');
        }
        
        // è·å–è­¦å‘Šå›¾æ ‡
        function getAlertIcon(type) {
            const icons = {
                'success': 'âœ…',
                'info': 'â„¹ï¸',
                'warning': 'âš ï¸',
                'error': 'ğŸš¨'
            };
            return icons[type] || 'â„¹ï¸';
        }
        
        // å¤„ç†è­¦å‘Šç‚¹å‡»äº‹ä»¶
        function handleAlertClick(actionUrl) {
            if (actionUrl.startsWith('#')) {
                // å†…éƒ¨é¡µé¢è·³è½¬
                const sectionId = actionUrl.substring(1);
                const linkElement = document.querySelector(`a[href="${actionUrl}"]`);
                if (linkElement) {
                    showSection(sectionId, linkElement);
                }
            } else if (actionUrl.startsWith('http')) {
                // å¤–éƒ¨é“¾æ¥
                window.open(actionUrl, '_blank');
            }
        }

        // ç§»åŠ¨ç«¯èœå•åŠŸèƒ½
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.toggle('mobile-open');
            if (sidebar.classList.contains('mobile-open')) {
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.style.display = 'none';
        }

        // åˆ‡æ¢å†…å®¹åŒºåŸŸ
        function showSection(sectionId, linkElement) {
            // å…³é—­æ‰€æœ‰å¯èƒ½æ‰“å¼€çš„æ¨¡æ€æ¡†
            closeEditModal();
            
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé“¾æ¥çš„activeçŠ¶æ€
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸ
            document.getElementById(sectionId).style.display = 'block';
            
            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªé“¾æ¥
            linkElement.classList.add('active');

            // ç§»åŠ¨ç«¯å…³é—­èœå•
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
            
            // æ ¹æ®ä¸åŒåŒºåŸŸåŠ è½½ç›¸åº”æ•°æ®
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'doctors':
                    loadDoctorsData();
                    break;
                case 'prescriptions':
                    loadPrescriptionsData();
                    break;
                case 'orders':
                    loadOrdersData();
                    break;
                case 'system':
                    loadSystemData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
                case 'logs':
                    loadLogsData();
                    break;
            }
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶çš„å¤„ç†
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });

        // åŠ è½½ç”¨æˆ·æ•°æ®
        // å…¨å±€ç”¨æˆ·æ•°æ®ç¼“å­˜
        let usersDataCache = [];
        
        async function loadUsersData() {
            const tableBody = document.getElementById('usersTableBody');
            
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.users.length > 0) {
                        // ç¼“å­˜ç”¨æˆ·æ•°æ®
                        usersDataCache = data.users;
                        
                        tableBody.innerHTML = data.users.map(user => `
                            <tr>
                                <td>${user.id.substring(0, 8)}...</td>
                                <td>${user.display_name || user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'æœªçŸ¥'}</td>
                                <td><span class="status-badge ${getStatusClass(user.account_status)}">${getStatusText(user.account_status)}</span></td>
                                <td>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewUser('${user.id}')">æŸ¥çœ‹</button>
                                    <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="editUser('${user.id}')">ç¼–è¾‘</button>
                                    <button class="btn btn-warning" style="padding: 4px 8px; font-size: 12px;" onclick="resetPassword('${user.id}')">é‡ç½®å¯†ç </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                                    æš‚æ— ç”¨æˆ·æ•°æ®
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    throw new Error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">
                            åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'active': return 'status-active';
                case 'suspended': return 'status-pending';
                case 'locked': return 'status-inactive';
                case 'deleted': return 'status-inactive';
                default: return 'status-pending';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'active': return 'æ´»è·ƒ';
                case 'suspended': return 'æš‚åœ';
                case 'locked': return 'é”å®š';
                case 'deleted': return 'å·²åˆ é™¤';
                default: return 'æœªçŸ¥';
            }
        }
        
        function viewUser(userId) {
            // å…³é—­å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¨¡æ€æ¡†
            closeEditModal();
            closeViewModal();
            
            // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ç”¨æˆ·æ•°æ®
            const user = usersDataCache.find(u => u.id === userId);
            if (!user) {
                alert('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            // åˆ›å»ºæŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'viewUserModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // æ ¼å¼åŒ–æ³¨å†Œæ—¶é—´
            const formatDate = (dateString) => {
                if (!dateString) return 'æœªçŸ¥';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            // æ ¼å¼åŒ–ç”¨æˆ·ç±»å‹
            const formatUserType = (type) => {
                const typeMap = {
                    'patient': 'æ‚£è€…',
                    'doctor': 'åŒ»ç”Ÿ',
                    'admin': 'ç®¡ç†å‘˜',
                    'superadmin': 'è¶…çº§ç®¡ç†å‘˜'
                };
                return typeMap[type] || type || 'æœªçŸ¥';
            };
            
            // æ ¼å¼åŒ–çŠ¶æ€
            const formatStatus = (status) => {
                switch(status) {
                    case 'active': return 'æ¿€æ´»';
                    case 'suspended': return 'æš‚åœ';
                    case 'locked': return 'é”å®š';
                    case 'deleted': return 'å·²åˆ é™¤';
                    default: return 'æœªçŸ¥';
                }
            };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ‘¤ ç”¨æˆ·è¯¦æƒ…</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å…³é—­
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ç”¨æˆ·ID</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.id || 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ç”¨æˆ·å</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.username || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ˜µç§°</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.nickname || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ç”¨æˆ·ç±»å‹</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${user.role === 'admin' ? '#dc2626' : user.role === 'doctor' ? '#059669' : '#3b82f6'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatUserType(user.role)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è”ç³»ä¿¡æ¯ -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“ è”ç³»ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">é‚®ç®±åœ°å€</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.email || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ‰‹æœºå·ç </label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.phone || 'æœªè®¾ç½®'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è´¦æˆ·çŠ¶æ€ -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">âš™ï¸ è´¦æˆ·çŠ¶æ€</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">è´¦æˆ·çŠ¶æ€</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${user.account_status === 'active' ? '#22c55e' : user.account_status === 'suspended' ? '#eab308' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatStatus(user.account_status)}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ³¨å†Œæ–¹å¼</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.registration_type || 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ³¨å†Œæ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(user.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æœ€åæ›´æ–°</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(user.updated_at)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸“ä¸šä¿¡æ¯ï¼ˆä»…åŒ»ç”Ÿæ˜¾ç¤ºï¼‰ -->
                        ${user.role === 'doctor' ? `
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ©º ä¸“ä¸šä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ‰§ä¸šè¯å·</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.license_number || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ä¸“ä¸šç§‘å®¤</label>
                                    <div style="color: #1f2937; font-weight: 500;">${user.specialties || 'æœªè®¾ç½®'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="editUser('${user.id}')" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            âœï¸ ç¼–è¾‘ç”¨æˆ·
                        </button>
                        <button onclick="closeViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modal);
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._viewEscListener = escListener;
            
            // é˜²æ­¢bodyæ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }
        
        function editUser(userId) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼–è¾‘æ¨¡æ€æ¡†ï¼Œå¦‚æœæœ‰åˆ™å…ˆå…³é—­
            closeEditModal();
            
            // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ç”¨æˆ·æ•°æ®
            const user = usersDataCache.find(u => u.id === userId);
            if (!user) {
                alert('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            console.log('ç¼–è¾‘ç”¨æˆ·æ•°æ®:', user);
            
            // åˆ›å»ºç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'editUserModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // ç§»é™¤ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½ï¼Œåªå…è®¸é€šè¿‡å–æ¶ˆæŒ‰é’®æˆ–ESCé”®å…³é—­
            // modal.addEventListener('click', function(e) {
            //     if (e.target === modal) {
            //         closeEditModal();
            //     }
            // });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å–æ¶ˆå…³é—­
                        </div>
                    </div>
                    <form id="editUserForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">ç”¨æˆ·å:</label>
                            <input type="text" id="edit_username" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ˜¾ç¤ºåç§°:</label>
                            <input type="text" id="edit_display_name" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">é‚®ç®±:</label>
                            <input type="email" id="edit_email" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ‰‹æœºå·:</label>
                            <input type="text" id="edit_phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">è´¦æˆ·çŠ¶æ€:</label>
                            <select id="edit_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="active">æ´»è·ƒ</option>
                                <option value="suspended">æš‚åœ</option>
                                <option value="locked">é”å®š</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closeEditModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">å–æ¶ˆ</button>
                            <button type="submit" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¡«å……ç”¨æˆ·æ•°æ®åˆ°è¡¨å•
            document.getElementById('edit_username').value = user.username || '';
            document.getElementById('edit_display_name').value = user.display_name || '';
            document.getElementById('edit_email').value = user.email || '';
            document.getElementById('edit_phone').value = user.phone_number === 'æœªè®¾ç½®' ? '' : (user.phone_number || '');
            document.getElementById('edit_status').value = user.account_status || 'active';
            
            // å¤„ç†è¡¨å•æäº¤
            document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateUser(userId, {
                    username: document.getElementById('edit_username').value,
                    display_name: document.getElementById('edit_display_name').value,
                    email: document.getElementById('edit_email').value,
                    phone_number: document.getElementById('edit_phone').value,
                    account_status: document.getElementById('edit_status').value
                });
                closeEditModal();
            });
            
            // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
            const handleEscKey = (e) => {
                if (e.key === 'Escape') {
                    closeEditModal();
                }
            };
            document.addEventListener('keydown', handleEscKey);
            
            // è®°å½•ç›‘å¬å™¨ä»¥ä¾¿æ¸…ç†
            if (!document._escListeners) {
                document._escListeners = [];
            }
            document._escListeners.push(handleEscKey);
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†çš„ç»Ÿä¸€å‡½æ•°
        function closeEditModal() {
            const modal = document.getElementById('editUserModal');
            if (modal) {
                modal.remove();
            }
            
            // æ¸…ç†å¯èƒ½æ®‹ç•™çš„å…¶ä»–æ¨¡æ€æ¡†
            const allModals = document.querySelectorAll('[id*="Modal"], [id*="modal"]');
            allModals.forEach(modal => {
                if (modal.style.position === 'fixed' && modal.style.zIndex >= '1000') {
                    modal.remove();
                }
            });
            
            // ç§»é™¤ESCé”®ç›‘å¬å™¨
            const escListeners = document._escListeners || [];
            escListeners.forEach(listener => {
                document.removeEventListener('keydown', listener);
            });
            document._escListeners = [];
            
            // ç¡®ä¿bodyå¯ä»¥æ­£å¸¸æ»šåŠ¨
            document.body.style.overflow = '';
        }
        
        function closeViewModal() {
            const modal = document.getElementById('viewUserModal');
            if (modal) {
                modal.remove();
            }
            
            // ç§»é™¤æŸ¥çœ‹æ¨¡æ€æ¡†çš„ESCé”®ç›‘å¬å™¨
            if (document._viewEscListener) {
                document.removeEventListener('keydown', document._viewEscListener);
                document._viewEscListener = null;
            }
            
            // ç¡®ä¿bodyå¯ä»¥æ­£å¸¸æ»šåŠ¨
            document.body.style.overflow = '';
        }
        
        async function updateUser(userId, userData) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                    loadUsersData(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }
        
        function resetPassword(userId) {
            const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç  (è‡³å°‘6ä½):');
            
            if (newPassword && newPassword.length >= 6) {
                resetUserPassword(userId, newPassword);
            } else if (newPassword) {
                alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');
            }
        }
        
        async function resetUserPassword(userId, newPassword) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('å¯†ç é‡ç½®æˆåŠŸ');
                } else {
                    alert('é‡ç½®å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('é‡ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å…¨å±€åŒ»ç”Ÿæ•°æ®ç¼“å­˜
        let doctorsDataCache = [];
        
        // åŠ è½½åŒ»ç”Ÿæ•°æ®
        async function loadDoctorsData() {
            try {
                const response = await fetch('/api/admin/doctors?page=1&per_page=20');
                const data = await response.json();
                
                const tableBody = document.getElementById('doctorsTableBody');
                if (data.success && data.doctors.length > 0) {
                    // ç¼“å­˜åŒ»ç”Ÿæ•°æ®
                    doctorsDataCache = data.doctors;
                    
                    tableBody.innerHTML = '';
                    data.doctors.forEach(doctor => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${doctor.id}</td>
                            <td>${doctor.name}</td>
                            <td>${doctor.license_no}</td>
                            <td>${doctor.speciality || '-'}</td>
                            <td>${doctor.hospital || '-'}</td>
                            <td><span class="status-badge status-${doctor.status === 'active' ? 'active' : 'inactive'}">${doctor.status === 'active' ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}</span></td>
                            <td>${formatDate(doctor.created_at)}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewDoctor('${doctor.id}')">æŸ¥çœ‹</button>
                                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="editDoctor('${doctor.id}')">ç¼–è¾‘</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                                æš‚æ— åŒ»ç”Ÿæ•°æ®
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½åŒ»ç”Ÿæ•°æ®å¤±è´¥:', error);
                document.getElementById('doctorsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">
                            åŠ è½½å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // åŒ»ç”ŸæŸ¥çœ‹åŠŸèƒ½
        function viewDoctor(doctorId) {
            // å…³é—­å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¨¡æ€æ¡†
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾åŒ»ç”Ÿæ•°æ®  
            const doctor = doctorsDataCache.find(d => d.id == doctorId || d.id === parseInt(doctorId));
            
            if (!doctor) {
                alert('æœªæ‰¾åˆ°åŒ»ç”Ÿä¿¡æ¯ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            // åˆ›å»ºæŸ¥çœ‹åŒ»ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'viewDoctorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // æ ¼å¼åŒ–æ³¨å†Œæ—¶é—´
            const formatDate = (dateString) => {
                if (!dateString) return 'æœªçŸ¥';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            // æ ¼å¼åŒ–çŠ¶æ€
            const formatDoctorStatus = (status) => {
                switch(status) {
                    case 'active': return 'æ´»è·ƒ';
                    case 'inactive': return 'éæ´»è·ƒ';
                    case 'pending': return 'å¾…å®¡æ ¸';
                    case 'suspended': return 'æš‚åœ';
                    default: return 'æœªçŸ¥';
                }
            };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 700px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿè¯¦æƒ…</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å…³é—­
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åŒ»ç”ŸID</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.id || 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åŒ»ç”Ÿå§“å</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.name || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">çŠ¶æ€</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${doctor.status === 'active' ? '#22c55e' : doctor.status === 'pending' ? '#eab308' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatDoctorStatus(doctor.status)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ‰§ä¸šä¿¡æ¯ -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ¥ æ‰§ä¸šä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ‰§ä¸šè¯å·</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.license_no || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ä¸“ä¸šç§‘å®¤</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.speciality || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ‰€å±åŒ»é™¢</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.hospital || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">è”ç³»ç”µè¯</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.phone || 'æœªè®¾ç½®'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ³¨å†Œä¿¡æ¯ -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“… æ³¨å†Œä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ³¨å†Œæ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(doctor.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æœ€åæ›´æ–°</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(doctor.updated_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">é‚®ç®±åœ°å€</label>
                                    <div style="color: #1f2937; font-weight: 500;">${doctor.email || 'æœªè®¾ç½®'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ä¸ªäººç®€ä»‹</label>
                                    <div style="color: #1f2937; font-weight: 500; max-width: 300px; word-wrap: break-word;">${doctor.bio || 'æœªè®¾ç½®'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="editDoctor('${doctorId}')" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            âœï¸ ç¼–è¾‘åŒ»ç”Ÿ
                        </button>
                        <button onclick="closeDoctorViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modal);
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeDoctorViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._doctorViewEscListener = escListener;
            
            // é˜²æ­¢bodyæ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }
        
        function closeDoctorViewModal() {
            const modal = document.getElementById('viewDoctorModal');
            if (modal) {
                modal.remove();
            }
            
            // ç§»é™¤æŸ¥çœ‹æ¨¡æ€æ¡†çš„ESCé”®ç›‘å¬å™¨
            if (document._doctorViewEscListener) {
                document.removeEventListener('keydown', document._doctorViewEscListener);
                document._doctorViewEscListener = null;
            }
            
            // ç¡®ä¿bodyå¯ä»¥æ­£å¸¸æ»šåŠ¨
            document.body.style.overflow = '';
        }
        
        // åŒ»ç”Ÿç¼–è¾‘åŠŸèƒ½
        function editDoctor(doctorId) {
            // å…³é—­å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¨¡æ€æ¡†
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾åŒ»ç”Ÿæ•°æ®  
            const doctor = doctorsDataCache.find(d => d.id == doctorId || d.id === parseInt(doctorId));
            if (!doctor) {
                alert('æœªæ‰¾åˆ°åŒ»ç”Ÿä¿¡æ¯ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            // åˆ›å»ºç¼–è¾‘åŒ»ç”Ÿæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'editDoctorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">âœï¸ ç¼–è¾‘åŒ»ç”Ÿä¿¡æ¯</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å–æ¶ˆå…³é—­
                        </div>
                    </div>
                    
                    <form id="editDoctorForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">åŒ»ç”Ÿå§“å *:</label>
                            <input type="text" id="edit_doctor_name" required value="${doctor.name || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ‰§ä¸šè¯å· *:</label>
                            <input type="text" id="edit_doctor_license" required value="${doctor.license_no || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">ä¸“ä¸šç§‘å®¤:</label>
                            <select id="edit_doctor_speciality" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">è¯·é€‰æ‹©ä¸“ä¸šç§‘å®¤</option>
                                <option value="ä¸­åŒ»å†…ç§‘" ${doctor.speciality === 'ä¸­åŒ»å†…ç§‘' ? 'selected' : ''}>ä¸­åŒ»å†…ç§‘</option>
                                <option value="ä¸­åŒ»å¤–ç§‘" ${doctor.speciality === 'ä¸­åŒ»å¤–ç§‘' ? 'selected' : ''}>ä¸­åŒ»å¤–ç§‘</option>
                                <option value="å¦‡ç§‘" ${doctor.speciality === 'å¦‡ç§‘' ? 'selected' : ''}>å¦‡ç§‘</option>
                                <option value="å„¿ç§‘" ${doctor.speciality === 'å„¿ç§‘' ? 'selected' : ''}>å„¿ç§‘</option>
                                <option value="çš®è‚¤ç§‘" ${doctor.speciality === 'çš®è‚¤ç§‘' ? 'selected' : ''}>çš®è‚¤ç§‘</option>
                                <option value="éª¨ä¼¤ç§‘" ${doctor.speciality === 'éª¨ä¼¤ç§‘' ? 'selected' : ''}>éª¨ä¼¤ç§‘</option>
                                <option value="é’ˆç¸ç§‘" ${doctor.speciality === 'é’ˆç¸ç§‘' ? 'selected' : ''}>é’ˆç¸ç§‘</option>
                                <option value="æ¨æ‹¿ç§‘" ${doctor.speciality === 'æ¨æ‹¿ç§‘' ? 'selected' : ''}>æ¨æ‹¿ç§‘</option>
                                <option value="ç»æ–¹ç§‘" ${doctor.speciality === 'ç»æ–¹ç§‘' ? 'selected' : ''}>ç»æ–¹ç§‘</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">è”ç³»ç”µè¯:</label>
                            <input type="tel" id="edit_doctor_phone" value="${doctor.phone || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">é‚®ç®±åœ°å€:</label>
                            <input type="email" id="edit_doctor_email" value="${doctor.email || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ‰€å±åŒ»é™¢:</label>
                            <input type="text" id="edit_doctor_hospital" value="${doctor.hospital || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">çŠ¶æ€:</label>
                            <select id="edit_doctor_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="active" ${doctor.status === 'active' ? 'selected' : ''}>æ´»è·ƒ</option>
                                <option value="inactive" ${doctor.status === 'inactive' ? 'selected' : ''}>éæ´»è·ƒ</option>
                                <option value="pending" ${doctor.status === 'pending' ? 'selected' : ''}>å¾…å®¡æ ¸</option>
                                <option value="suspended" ${doctor.status === 'suspended' ? 'selected' : ''}>æš‚åœ</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">ä¸ªäººç®€ä»‹:</label>
                            <textarea id="edit_doctor_intro" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;">${doctor.introduction || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ğŸ’¾ ä¿å­˜ä¿®æ”¹
                            </button>
                            <button type="button" onclick="closeEditDoctorModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¤„ç†è¡¨å•æäº¤
            document.getElementById('editDoctorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitDoctorUpdate(doctorId);
            });
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeEditDoctorModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._editDoctorEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeEditDoctorModal() {
            const modal = document.getElementById('editDoctorModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._editDoctorEscListener) {
                document.removeEventListener('keydown', document._editDoctorEscListener);
                document._editDoctorEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        async function submitDoctorUpdate(doctorId) {
            try {
                const doctorData = {
                    name: document.getElementById('edit_doctor_name').value.trim(),
                    license_no: document.getElementById('edit_doctor_license').value.trim(),
                    speciality: document.getElementById('edit_doctor_speciality').value,
                    phone: document.getElementById('edit_doctor_phone').value.trim(),
                    email: document.getElementById('edit_doctor_email').value.trim(),
                    hospital: document.getElementById('edit_doctor_hospital').value.trim(),
                    status: document.getElementById('edit_doctor_status').value,
                    introduction: document.getElementById('edit_doctor_intro').value.trim()
                };
                
                // åŸºæœ¬éªŒè¯
                if (!doctorData.name || !doctorData.license_no) {
                    alert('è¯·å¡«å†™åŒ»ç”Ÿå§“åå’Œæ‰§ä¸šè¯å·');
                    return;
                }
                
                const response = await fetch(`/api/admin/doctors/${doctorId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(doctorData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åŒ»ç”Ÿä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    closeEditDoctorModal();
                    loadDoctorsData(); // åˆ·æ–°åŒ»ç”Ÿåˆ—è¡¨
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
                
            } catch (error) {
                console.error('æ›´æ–°åŒ»ç”Ÿä¿¡æ¯å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }
        
        // åŒ»ç”Ÿå®¡æ ¸åˆ—è¡¨åŠŸèƒ½
        async function showDoctorReviewList() {
            try {
                // è·å–å¾…å®¡æ ¸åŒ»ç”Ÿæ•°æ®
                const response = await fetch('/api/admin/doctors?status=pending&page=1&per_page=50');
                const data = await response.json();
                
                // åˆ›å»ºå®¡æ ¸åˆ—è¡¨æ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.id = 'doctorReviewModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                    align-items: center; justify-content: center;
                `;
                
                const pendingDoctors = data.success ? data.doctors.filter(d => d.status === 'pending') : [];
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 1000px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                            <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ“‹ åŒ»ç”Ÿå®¡æ ¸åˆ—è¡¨</h3>
                            <button onclick="closeDoctorReviewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
                        </div>
                        
                        ${pendingDoctors.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">åŒ»ç”Ÿå§“å</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">æ‰§ä¸šè¯å·</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">ä¸“ä¸šç§‘å®¤</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">ç”³è¯·æ—¶é—´</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingDoctors.map(doctor => `
                                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                                <td style="padding: 12px;">${doctor.name}</td>
                                                <td style="padding: 12px;">${doctor.license_no}</td>
                                                <td style="padding: 12px;">${doctor.speciality || '-'}</td>
                                                <td style="padding: 12px;">${formatDate(doctor.created_at)}</td>
                                                <td style="padding: 12px;">
                                                    <button onclick="approveDoctor(${doctor.id})" style="background: #22c55e; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 8px; cursor: pointer;">é€šè¿‡</button>
                                                    <button onclick="rejectDoctor(${doctor.id})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">æ‹’ç»</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
                                <div style="font-size: 18px; margin-bottom: 8px;">æš‚æ— å¾…å®¡æ ¸åŒ»ç”Ÿ</div>
                                <div style="font-size: 14px;">æ‰€æœ‰åŒ»ç”Ÿç”³è¯·å·²å¤„ç†å®Œæ¯•</div>
                            </div>
                        `}
                        
                        <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                            <button onclick="closeDoctorReviewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('åŠ è½½å®¡æ ¸åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½å®¡æ ¸åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }
        
        function closeDoctorReviewModal() {
            const modal = document.getElementById('doctorReviewModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        async function approveDoctor(doctorId) {
            if (!confirm('ç¡®è®¤é€šè¿‡æ­¤åŒ»ç”Ÿçš„ç”³è¯·å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/doctors/${doctorId}/approve`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('åŒ»ç”Ÿç”³è¯·å·²é€šè¿‡');
                    closeDoctorReviewModal();
                    loadDoctorsData(); // åˆ·æ–°åŒ»ç”Ÿåˆ—è¡¨
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        async function rejectDoctor(doctorId) {
            if (!confirm('ç¡®è®¤æ‹’ç»æ­¤åŒ»ç”Ÿçš„ç”³è¯·å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/doctors/${doctorId}/reject`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('åŒ»ç”Ÿç”³è¯·å·²æ‹’ç»');
                    closeDoctorReviewModal();
                    loadDoctorsData(); // åˆ·æ–°åŒ»ç”Ÿåˆ—è¡¨
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        // æ·»åŠ æ–°åŒ»ç”ŸåŠŸèƒ½
        function addNewDoctor() {
            // å…³é—­å…¶ä»–æ¨¡æ€æ¡†
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // åˆ›å»ºæ·»åŠ åŒ»ç”Ÿæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'addDoctorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937; margin: 0;">ğŸ‘¨â€âš•ï¸ æ·»åŠ æ–°åŒ»ç”Ÿ</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å–æ¶ˆå…³é—­
                        </div>
                    </div>
                    
                    <form id="addDoctorForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">åŒ»ç”Ÿå§“å *:</label>
                            <input type="text" id="add_doctor_name" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ‰§ä¸šè¯å· *:</label>
                            <input type="text" id="add_doctor_license" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">ä¸“ä¸šç§‘å®¤:</label>
                            <select id="add_doctor_speciality" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">è¯·é€‰æ‹©ä¸“ä¸šç§‘å®¤</option>
                                <option value="ä¸­åŒ»å†…ç§‘">ä¸­åŒ»å†…ç§‘</option>
                                <option value="ä¸­åŒ»å¤–ç§‘">ä¸­åŒ»å¤–ç§‘</option>
                                <option value="å¦‡ç§‘">å¦‡ç§‘</option>
                                <option value="å„¿ç§‘">å„¿ç§‘</option>
                                <option value="çš®è‚¤ç§‘">çš®è‚¤ç§‘</option>
                                <option value="éª¨ä¼¤ç§‘">éª¨ä¼¤ç§‘</option>
                                <option value="é’ˆç¸ç§‘">é’ˆç¸ç§‘</option>
                                <option value="æ¨æ‹¿ç§‘">æ¨æ‹¿ç§‘</option>
                                <option value="ç»æ–¹ç§‘">ç»æ–¹ç§‘</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">è”ç³»ç”µè¯:</label>
                            <input type="tel" id="add_doctor_phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">é‚®ç®±åœ°å€:</label>
                            <input type="email" id="add_doctor_email" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">æ‰€å±åŒ»é™¢:</label>
                            <input type="text" id="add_doctor_hospital" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">ä¸ªäººç®€ä»‹:</label>
                            <textarea id="add_doctor_intro" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                âœ… æ·»åŠ åŒ»ç”Ÿ
                            </button>
                            <button type="button" onclick="closeAddDoctorModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¤„ç†è¡¨å•æäº¤
            document.getElementById('addDoctorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitNewDoctor();
            });
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeAddDoctorModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._addDoctorEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeAddDoctorModal() {
            const modal = document.getElementById('addDoctorModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._addDoctorEscListener) {
                document.removeEventListener('keydown', document._addDoctorEscListener);
                document._addDoctorEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        async function submitNewDoctor() {
            try {
                const doctorData = {
                    name: document.getElementById('add_doctor_name').value.trim(),
                    license_no: document.getElementById('add_doctor_license').value.trim(),
                    speciality: document.getElementById('add_doctor_speciality').value,
                    phone: document.getElementById('add_doctor_phone').value.trim(),
                    email: document.getElementById('add_doctor_email').value.trim(),
                    hospital: document.getElementById('add_doctor_hospital').value.trim(),
                    introduction: document.getElementById('add_doctor_intro').value.trim()
                };
                
                // åŸºæœ¬éªŒè¯
                if (!doctorData.name || !doctorData.license_no) {
                    alert('è¯·å¡«å†™åŒ»ç”Ÿå§“åå’Œæ‰§ä¸šè¯å·');
                    return;
                }
                
                const response = await fetch('/api/admin/doctors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(doctorData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åŒ»ç”Ÿæ·»åŠ æˆåŠŸï¼');
                    closeAddDoctorModal();
                    loadDoctorsData(); // åˆ·æ–°åŒ»ç”Ÿåˆ—è¡¨
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
                
            } catch (error) {
                console.error('æ·»åŠ åŒ»ç”Ÿå¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }

        // å…¨å±€å¤„æ–¹æ•°æ®ç¼“å­˜
        let prescriptionsDataCache = [];
        
        // åŠ è½½å¤„æ–¹æ•°æ®
        async function loadPrescriptionsData() {
            try {
                const response = await fetch('/api/admin/prescriptions?page=1&per_page=20');
                const data = await response.json();
                
                const tableBody = document.getElementById('prescriptionsTableBody');
                if (data.success && data.prescriptions.length > 0) {
                    // ç¼“å­˜å¤„æ–¹æ•°æ®
                    prescriptionsDataCache = data.prescriptions;
                    
                    tableBody.innerHTML = '';
                    data.prescriptions.forEach(prescription => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>#${prescription.id}</td>
                            <td>${prescription.patient_name || prescription.patient_id}</td>
                            <td>${prescription.doctor_name || 'å¾…åˆ†é…'}</td>
                            <td><span class="status-badge status-${getStatusClass(prescription.status)}">${getStatusText(prescription.status)}</span></td>
                            <td>${formatDate(prescription.created_at)}</td>
                            <td>${prescription.reviewed_at ? formatDate(prescription.reviewed_at) : '-'}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewPrescription('${prescription.id}')">æŸ¥çœ‹</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                æš‚æ— å¤„æ–¹æ•°æ®
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å¤„æ–¹æ•°æ®å¤±è´¥:', error);
                document.getElementById('prescriptionsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">
                            åŠ è½½å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // å¤„æ–¹æŸ¥çœ‹åŠŸèƒ½
        function viewPrescription(prescriptionId) {
            // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å¤„æ–¹æ•°æ®
            const prescription = prescriptionsDataCache.find(p => p.id == prescriptionId || p.id === parseInt(prescriptionId));
            if (!prescription) {
                alert('æœªæ‰¾åˆ°å¤„æ–¹ä¿¡æ¯ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            // å…³é—­å…¶ä»–æ¨¡æ€æ¡†
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // åˆ›å»ºå¤„æ–¹è¯¦æƒ…æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'viewPrescriptionModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // æ ¼å¼åŒ–å¤„æ–¹çŠ¶æ€
            const formatPrescriptionStatus = (status) => {
                switch(status) {
                    case 'pending': return 'å¾…å®¡æ ¸';
                    case 'approved': return 'å·²å®¡æ ¸';
                    case 'rejected': return 'å·²æ‹’ç»';
                    case 'completed': return 'å·²å®Œæˆ';
                    case 'paid': return 'å·²æ”¯ä»˜';
                    default: return 'æœªçŸ¥';
                }
            };
            
            // æ ¼å¼åŒ–å¤„æ–¹å†…å®¹
            const formatPrescriptionContent = (content) => {
                if (!content) return 'æš‚æ— ';
                // ç®€åŒ–æ˜¾ç¤ºï¼Œé¿å…è¿‡é•¿çš„å†…å®¹
                if (content.length > 500) {
                    return content.substring(0, 500) + '...';
                }
                return content.replace(/\n/g, '<br>');
            };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ“‹ å¤„æ–¹è¯¦æƒ… #${prescription.id}</h3>
                        <button onclick="closePrescriptionViewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å¤„æ–¹ID</label>
                                    <div style="color: #1f2937; font-weight: 500;">#${prescription.id}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ‚£è€…ä¿¡æ¯</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.patient_name || prescription.patient_id}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">çŠ¶æ€</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${prescription.status === 'approved' ? '#22c55e' : prescription.status === 'pending' ? '#eab308' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                            ${formatPrescriptionStatus(prescription.status)}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">è´¹ç”¨</label>
                                    <div style="color: #1f2937; font-weight: 500;">Â¥${prescription.prescription_fee || 0}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç—‡çŠ¶ä¸è¯Šæ–­ -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ©º ç—‡çŠ¶ä¸è¯Šæ–­</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ä¸»è¦ç—‡çŠ¶</label>
                                <div style="color: #1f2937; font-weight: 500; line-height: 1.5;">${prescription.symptoms || 'æš‚æ— '}</div>
                            </div>
                            <div>
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ä¸­åŒ»è¯Šæ–­</label>
                                <div style="color: #1f2937; font-weight: 500;">${prescription.diagnosis || 'æš‚æ— '}</div>
                            </div>
                        </div>
                        
                        <!-- AIå¤„æ–¹ -->
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ¤– AIå¤„æ–¹æ–¹æ¡ˆ</h4>
                            <div style="color: #1f2937; line-height: 1.6; max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${formatPrescriptionContent(prescription.ai_prescription)}
                            </div>
                        </div>
                        
                        ${prescription.doctor_prescription ? `
                        <!-- åŒ»ç”Ÿå¤„æ–¹ -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿå¤„æ–¹</h4>
                            <div style="color: #1f2937; line-height: 1.6; max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${formatPrescriptionContent(prescription.doctor_prescription)}
                            </div>
                            ${prescription.doctor_notes ? `
                            <div style="margin-top: 15px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åŒ»ç”Ÿå¤‡æ³¨</label>
                                <div style="color: #1f2937; line-height: 1.5;">${prescription.doctor_notes}</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- æ—¶é—´ä¿¡æ¯ -->
                        <div style="background: #fdf2f8; padding: 20px; border-radius: 10px; border-left: 4px solid #ec4899;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">â° æ—¶é—´è®°å½•</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åˆ›å»ºæ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatDate(prescription.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å®¡æ ¸æ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.reviewed_at ? formatDate(prescription.reviewed_at) : 'æœªå®¡æ ¸'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">ç¡®è®¤æ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.confirmed_at ? formatDate(prescription.confirmed_at) : 'æœªç¡®è®¤'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="closePrescriptionViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        
        function closePrescriptionViewModal() {
            const modal = document.getElementById('viewPrescriptionModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        // é«˜çº§æœç´¢åŠŸèƒ½
        function showAdvancedSearch() {
            // å…³é—­å…¶ä»–æ¨¡æ€æ¡†
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // åˆ›å»ºé«˜çº§æœç´¢æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'advancedSearchModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ” é«˜çº§æœç´¢</h3>
                        <button onclick="closeAdvancedSearchModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
                    </div>
                    
                    <form id="advancedSearchForm">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">å¤„æ–¹çŠ¶æ€:</label>
                                <select id="search_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="pending">å¾…å®¡æ ¸</option>
                                    <option value="approved">å·²å®¡æ ¸</option>
                                    <option value="rejected">å·²æ‹’ç»</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                    <option value="paid">å·²æ”¯ä»˜</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">æ‚£è€…å§“å:</label>
                                <input type="text" id="search_patient" placeholder="è¾“å…¥æ‚£è€…å§“å" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">åŒ»ç”Ÿå§“å:</label>
                                <input type="text" id="search_doctor" placeholder="è¾“å…¥åŒ»ç”Ÿå§“å" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">è´¹ç”¨èŒƒå›´:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="number" id="search_fee_min" placeholder="æœ€ä½" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <span style="color: #6b7280;">~</span>
                                    <input type="number" id="search_fee_max" placeholder="æœ€é«˜" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">åˆ›å»ºæ—¶é—´:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="date" id="search_date_start" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <span style="color: #6b7280;">~</span>
                                    <input type="date" id="search_date_end" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 500;">ç—‡çŠ¶å…³é”®è¯:</label>
                                <input type="text" id="search_symptoms" placeholder="è¾“å…¥ç—‡çŠ¶å…³é”®è¯" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                        </div>
                        
                        <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ğŸ” å¼€å§‹æœç´¢
                            </button>
                            <button type="button" onclick="resetSearchForm()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ğŸ”„ é‡ç½®æ¡ä»¶
                            </button>
                            <button type="button" onclick="closeAdvancedSearchModal()" style="background: #ef4444; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¤„ç†æœç´¢è¡¨å•æäº¤
            document.getElementById('advancedSearchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await performAdvancedSearch();
            });
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeAdvancedSearchModal() {
            const modal = document.getElementById('advancedSearchModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        function resetSearchForm() {
            document.getElementById('advancedSearchForm').reset();
        }
        
        async function performAdvancedSearch() {
            try {
                const searchParams = {
                    status: document.getElementById('search_status').value,
                    patient_name: document.getElementById('search_patient').value.trim(),
                    doctor_name: document.getElementById('search_doctor').value.trim(),
                    fee_min: document.getElementById('search_fee_min').value,
                    fee_max: document.getElementById('search_fee_max').value,
                    date_start: document.getElementById('search_date_start').value,
                    date_end: document.getElementById('search_date_end').value,
                    symptoms: document.getElementById('search_symptoms').value.trim()
                };
                
                // å…ˆå°è¯•ä½¿ç”¨APIæœç´¢ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å®¢æˆ·ç«¯æœç´¢
                try {
                    // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
                    const queryParams = new URLSearchParams();
                    Object.keys(searchParams).forEach(key => {
                        if (searchParams[key]) {
                            queryParams.append(key, searchParams[key]);
                        }
                    });
                    
                    const response = await fetch(`/api/admin/prescriptions/search?${queryParams}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // APIæœç´¢æˆåŠŸ
                        prescriptionsDataCache = data.prescriptions;
                        displaySearchResults(data.prescriptions);
                        closeAdvancedSearchModal();
                        alert(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${data.prescriptions.length} æ¡è®°å½•`);
                        return;
                    }
                } catch (apiError) {
                    console.log('APIæœç´¢å¤±è´¥ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æœç´¢:', apiError);
                }
                
                // APIæœç´¢å¤±è´¥ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æœç´¢
                const filteredResults = performClientSideSearch(searchParams);
                displaySearchResults(filteredResults);
                closeAdvancedSearchModal();
                alert(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${filteredResults.length} æ¡è®°å½•`);
                
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                alert('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function performClientSideSearch(searchParams) {
            let results = [...prescriptionsDataCache];
            
            // æŒ‰çŠ¶æ€ç­›é€‰
            if (searchParams.status) {
                results = results.filter(p => p.status === searchParams.status);
            }
            
            // æŒ‰æ‚£è€…å§“åç­›é€‰
            if (searchParams.patient_name) {
                const patientName = searchParams.patient_name.toLowerCase();
                results = results.filter(p => 
                    (p.patient_name && p.patient_name.toLowerCase().includes(patientName)) ||
                    (p.patient_id && p.patient_id.toLowerCase().includes(patientName))
                );
            }
            
            // æŒ‰åŒ»ç”Ÿå§“åç­›é€‰
            if (searchParams.doctor_name) {
                const doctorName = searchParams.doctor_name.toLowerCase();
                results = results.filter(p => 
                    p.doctor_name && p.doctor_name.toLowerCase().includes(doctorName)
                );
            }
            
            // æŒ‰è´¹ç”¨èŒƒå›´ç­›é€‰
            if (searchParams.fee_min) {
                const minFee = parseFloat(searchParams.fee_min);
                results = results.filter(p => (p.prescription_fee || 0) >= minFee);
            }
            
            if (searchParams.fee_max) {
                const maxFee = parseFloat(searchParams.fee_max);
                results = results.filter(p => (p.prescription_fee || 0) <= maxFee);
            }
            
            // æŒ‰åˆ›å»ºæ—¶é—´ç­›é€‰
            if (searchParams.date_start) {
                const startDate = new Date(searchParams.date_start);
                results = results.filter(p => {
                    const createDate = new Date(p.created_at);
                    return createDate >= startDate;
                });
            }
            
            if (searchParams.date_end) {
                const endDate = new Date(searchParams.date_end);
                endDate.setHours(23, 59, 59, 999); // è®¾ç½®ä¸ºå½“å¤©ç»“æŸæ—¶é—´
                results = results.filter(p => {
                    const createDate = new Date(p.created_at);
                    return createDate <= endDate;
                });
            }
            
            // æŒ‰ç—‡çŠ¶å…³é”®è¯ç­›é€‰
            if (searchParams.symptoms) {
                const symptomsKeyword = searchParams.symptoms.toLowerCase();
                results = results.filter(p => 
                    p.symptoms && p.symptoms.toLowerCase().includes(symptomsKeyword)
                );
            }
            
            return results;
        }
        
        function displaySearchResults(prescriptions) {
            const tableBody = document.getElementById('prescriptionsTableBody');
            
            if (prescriptions.length > 0) {
                tableBody.innerHTML = '';
                prescriptions.forEach(prescription => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>#${prescription.id}</td>
                        <td>${prescription.patient_name || prescription.patient_id}</td>
                        <td>${prescription.doctor_name || 'å¾…åˆ†é…'}</td>
                        <td><span class="status-badge status-${getStatusClass(prescription.status)}">${getStatusText(prescription.status)}</span></td>
                        <td>${formatDate(prescription.created_at)}</td>
                        <td>${prescription.reviewed_at ? formatDate(prescription.reviewed_at) : '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewPrescription('${prescription.id}')">æŸ¥çœ‹</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¤„æ–¹è®°å½•
                        </td>
                    </tr>
                `;
            }
        }
        
        // ç»Ÿè®¡æŠ¥å‘ŠåŠŸèƒ½
        function showPrescriptionStats() {
            // å…³é—­å…¶ä»–æ¨¡æ€æ¡†
            closeEditModal();
            closeViewModal();
            closeDoctorViewModal();
            
            // è·å–ç»Ÿè®¡æ•°æ®å¹¶æ˜¾ç¤º
            generatePrescriptionReport();
        }
        
        async function generatePrescriptionReport() {
            try {
                const response = await fetch('/api/admin/prescriptions/stats');
                const data = await response.json();
                
                if (data.success) {
                    displayPrescriptionReport(data.stats);
                } else {
                    // å¦‚æœAPIä¸å­˜åœ¨ï¼Œä½¿ç”¨å®¢æˆ·ç«¯è®¡ç®—
                    const clientStats = calculateClientStats();
                    displayPrescriptionReport(clientStats);
                }
                
            } catch (error) {
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å®¢æˆ·ç«¯è®¡ç®—
                const clientStats = calculateClientStats();
                displayPrescriptionReport(clientStats);
            }
        }
        
        function calculateClientStats() {
            const total = prescriptionsDataCache.length;
            const pending = prescriptionsDataCache.filter(p => p.status === 'pending').length;
            const approved = prescriptionsDataCache.filter(p => p.status === 'approved').length;
            const completed = prescriptionsDataCache.filter(p => p.status === 'completed').length;
            const totalFees = prescriptionsDataCache.reduce((sum, p) => sum + (p.prescription_fee || 0), 0);
            
            return {
                total_prescriptions: total,
                pending_prescriptions: pending,
                approved_prescriptions: approved,
                completed_prescriptions: completed,
                total_fees: totalFees,
                avg_fee: total > 0 ? totalFees / total : 0
            };
        }
        
        function displayPrescriptionReport(stats) {
            // åˆ›å»ºç»Ÿè®¡æŠ¥å‘Šæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'prescriptionStatsModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 700px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ“Š å¤„æ–¹ç»Ÿè®¡æŠ¥å‘Š</h3>
                        <button onclick="closePrescriptionStatsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.total_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">æ€»å¤„æ–¹æ•°</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.pending_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">å¾…å®¡æ ¸</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.approved_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">å·²å®¡æ ¸</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${stats.completed_prescriptions || 0}</div>
                            <div style="font-size: 14px; opacity: 0.9;">å·²å®Œæˆ</div>
                        </div>
                        
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ’° è´¹ç”¨ç»Ÿè®¡</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ€»æ”¶å…¥</label>
                                <div style="color: #1f2937; font-weight: 600; font-size: 18px;">Â¥${(stats.total_fees || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å¹³å‡è´¹ç”¨</label>
                                <div style="color: #1f2937; font-weight: 500;">Â¥${(stats.avg_fee || 0).toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“ˆ å¤„ç†æ•ˆç‡</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å®¡æ ¸ç‡</label>
                                <div style="color: #1f2937; font-weight: 500;">
                                    ${stats.total_prescriptions > 0 ? ((stats.approved_prescriptions / stats.total_prescriptions) * 100).toFixed(1) : 0}%
                                </div>
                            </div>
                            <div>
                                <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å®Œæˆç‡</label>
                                <div style="color: #1f2937; font-weight: 500;">
                                    ${stats.total_prescriptions > 0 ? ((stats.completed_prescriptions / stats.total_prescriptions) * 100).toFixed(1) : 0}%
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="exportPrescriptionReport()" style="background: #22c55e; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500; margin-right: 15px;">
                            ğŸ“¥ å¯¼å‡ºæŠ¥å‘Š
                        </button>
                        <button onclick="closePrescriptionStatsModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        
        function closePrescriptionStatsModal() {
            const modal = document.getElementById('prescriptionStatsModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }
        
        function exportPrescriptionReport() {
            const stats = calculateClientStats();
            const reportData = [
                ['æŒ‡æ ‡', 'æ•°å€¼'],
                ['æ€»å¤„æ–¹æ•°', stats.total_prescriptions],
                ['å¾…å®¡æ ¸å¤„æ–¹', stats.pending_prescriptions],
                ['å·²å®¡æ ¸å¤„æ–¹', stats.approved_prescriptions],
                ['å·²å®Œæˆå¤„æ–¹', stats.completed_prescriptions],
                ['æ€»æ”¶å…¥', 'Â¥' + stats.total_fees.toFixed(2)],
                ['å¹³å‡è´¹ç”¨', 'Â¥' + stats.avg_fee.toFixed(2)],
                ['å®¡æ ¸ç‡', ((stats.approved_prescriptions / stats.total_prescriptions) * 100).toFixed(1) + '%'],
                ['å®Œæˆç‡', ((stats.completed_prescriptions / stats.total_prescriptions) * 100).toFixed(1) + '%']
            ];
            
            const csvContent = reportData.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å¤„æ–¹ç»Ÿè®¡æŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ç»Ÿè®¡æŠ¥å‘Šå·²å¯¼å‡ºåˆ°ä¸‹è½½æ–‡ä»¶å¤¹');
        }

        // è®¢å•æ•°æ®ç¼“å­˜
        let ordersDataCache = [];

        // åŠ è½½è®¢å•æ•°æ®
        async function loadOrdersData() {
            try {
                const response = await fetch('/api/admin/orders?page=1&per_page=20');
                const data = await response.json();
                
                const tableBody = document.getElementById('ordersTableBody');
                if (data.success && data.orders.length > 0) {
                    // ç¼“å­˜è®¢å•æ•°æ®
                    ordersDataCache = data.orders;
                    
                    tableBody.innerHTML = '';
                    data.orders.forEach(order => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.order_no}</td>
                            <td>${order.patient_name || order.patient_id}</td>
                            <td>Â¥${order.amount}</td>
                            <td><span class="status-badge status-${order.payment_status === 'paid' ? 'active' : 'pending'}">${getPaymentStatusText(order.payment_status)}</span></td>
                            <td>${order.payment_method || '-'}</td>
                            <td>${formatDate(order.created_at)}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewOrder('${order.id}')" style="padding: 4px 8px; font-size: 12px;">æŸ¥çœ‹</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                æš‚æ— è®¢å•æ•°æ®
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½è®¢å•æ•°æ®å¤±è´¥:', error);
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">
                            åŠ è½½å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // åŠ è½½ç³»ç»Ÿç›‘æ§æ•°æ®
        async function loadSystemData() {
            try {
                const response = await fetch('/api/admin/system');
                const data = await response.json();
                
                if (data.success && data.system) {
                    const system = data.system;
                    
                    // æ›´æ–°ç³»ç»Ÿç›‘æ§æŒ‡æ ‡
                    document.getElementById('cpuUsage').textContent = `${system.cpu_usage.toFixed(1)}%`;
                    document.getElementById('memoryUsage').textContent = `${system.memory.percent.toFixed(1)}%`;
                    document.getElementById('diskUsage').textContent = `${system.disk.percent.toFixed(1)}%`;
                    
                    // æ›´æ–°ç³»ç»Ÿç›‘æ§å†…å®¹
                    const monitorContent = document.getElementById('systemMonitorContent');
                    monitorContent.innerHTML = `
                        <div style="padding: 20px;">
                            <h4>èµ„æºä½¿ç”¨è¯¦æƒ…</h4>
                            <div style="margin: 20px 0;">
                                <p><strong>CPU:</strong> ${system.cpu_usage.toFixed(1)}% ä½¿ç”¨ç‡</p>
                                <p><strong>å†…å­˜:</strong> ${formatBytes(system.memory.used)} / ${formatBytes(system.memory.total)} (${system.memory.percent.toFixed(1)}%)</p>
                                <p><strong>ç£ç›˜:</strong> ${formatBytes(system.disk.used)} / ${formatBytes(system.disk.total)} (${system.disk.percent.toFixed(1)}%)</p>
                                <p><strong>æ›´æ–°æ—¶é—´:</strong> ${formatDate(system.timestamp)}</p>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('systemMonitorContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ef4444;">
                            è·å–ç³»ç»Ÿç›‘æ§æ•°æ®å¤±è´¥
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿç›‘æ§æ•°æ®å¤±è´¥:', error);
                document.getElementById('systemMonitorContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        åŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // è®¢å•è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½
        async function viewOrder(orderId) {
            // å…³é—­å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¨¡æ€æ¡†
            closeOrderViewModal();
            
            // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾è®¢å•æ•°æ®
            const order = ordersDataCache.find(o => o.id == orderId || o.id === parseInt(orderId));
            
            if (!order) {
                alert('æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            // åˆ›å»ºè®¢å•è¯¦æƒ…æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'viewOrderModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // æ ¼å¼åŒ–å‡½æ•°
            const formatOrderDate = (dateString) => {
                if (!dateString) return 'æœªçŸ¥';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            const formatPaymentStatus = (status) => {
                switch(status) {
                    case 'pending': return { text: 'å¾…æ”¯ä»˜', color: '#eab308' };
                    case 'paid': return { text: 'å·²æ”¯ä»˜', color: '#22c55e' };
                    case 'failed': return { text: 'æ”¯ä»˜å¤±è´¥', color: '#ef4444' };
                    case 'refunded': return { text: 'å·²é€€æ¬¾', color: '#f97316' };
                    default: return { text: 'æœªçŸ¥', color: '#6b7280' };
                }
            };
            
            const formatPaymentMethod = (method) => {
                switch(method) {
                    case 'alipay': return 'æ”¯ä»˜å®';
                    case 'wechat': return 'å¾®ä¿¡æ”¯ä»˜';
                    case 'bank_card': return 'é“¶è¡Œå¡';
                    default: return method || 'æœªçŸ¥';
                }
            };
            
            const paymentStatusInfo = formatPaymentStatus(order.payment_status);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ›’ è®¢å•è¯¦æƒ…</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å…³é—­
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“‹ è®¢å•åŸºæœ¬ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">è®¢å•å·</label>
                                    <div style="color: #1f2937; font-weight: 500; font-family: monospace;">${order.order_no || 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ‚£è€…ä¿¡æ¯</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.patient_name || order.patient_id || 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">è®¢å•é‡‘é¢</label>
                                    <div style="color: #1f2937; font-weight: 500; font-size: 18px; color: #059669;">Â¥${order.amount || '0.00'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åˆ›å»ºæ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatOrderDate(order.created_at)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ”¯ä»˜ä¿¡æ¯ -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ’³ æ”¯ä»˜ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ”¯ä»˜çŠ¶æ€</label>
                                    <div style="color: #1f2937; font-weight: 500;">
                                        <span style="background: ${paymentStatusInfo.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                            ${paymentStatusInfo.text}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ”¯ä»˜æ–¹å¼</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatPaymentMethod(order.payment_method)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ”¯ä»˜æ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatOrderDate(order.payment_time) || 'æœªæ”¯ä»˜'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">äº¤æ˜“å·</label>
                                    <div style="color: #1f2937; font-weight: 500; font-family: monospace; font-size: 12px;">${order.payment_transaction_id || 'æœªç”Ÿæˆ'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é…é€ä¿¡æ¯ -->
                        ${order.decoction_required ? `
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸšš é…é€ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ”¶è´§äºº</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.shipping_name || 'æœªå¡«å†™'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">è”ç³»ç”µè¯</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.shipping_phone || 'æœªå¡«å†™'}</div>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">é…é€åœ°å€</label>
                                    <div style="color: #1f2937; font-weight: 500;">${order.shipping_address || 'æœªå¡«å†™'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- æ”¶å…¥åˆ†æˆä¿¡æ¯ -->
                        <div style="background: #fef3f2; padding: 20px; border-radius: 10px; border-left: 4px solid #f97316;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ’° æ”¶å…¥åˆ†æˆ</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åŒ»ç”Ÿä½£é‡‘</label>
                                    <div style="color: #dc2626; font-weight: 500;">Â¥${order.doctor_commission || '0.00'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ¨èä½£é‡‘</label>
                                    <div style="color: #dc2626; font-weight: 500;">Â¥${order.referrer_commission || '0.00'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å¹³å°æ”¶å…¥</label>
                                    <div style="color: #059669; font-weight: 500;">Â¥${order.platform_revenue || '0.00'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¤‡æ³¨ä¿¡æ¯ -->
                        ${order.notes ? `
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #6b7280;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“ è®¢å•å¤‡æ³¨</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${order.notes}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        ${order.prescription_id ? `
                        <button onclick="viewRelatedPrescription('${order.prescription_id}')" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            ğŸ“‹ æŸ¥çœ‹å¤„æ–¹
                        </button>
                        ` : ''}
                        <button onclick="closeOrderViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modal);
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeOrderViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._orderViewEscListener = escListener;
            
            // é˜²æ­¢bodyæ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }
        
        function closeOrderViewModal() {
            const modal = document.getElementById('viewOrderModal');
            if (modal) {
                modal.remove();
            }
            
            // ç§»é™¤ESCé”®ç›‘å¬å™¨
            if (document._orderViewEscListener) {
                document.removeEventListener('keydown', document._orderViewEscListener);
                document._orderViewEscListener = null;
            }
            
            // ç¡®ä¿bodyå¯ä»¥æ­£å¸¸æ»šåŠ¨
            document.body.style.overflow = '';
        }
        
        // æŸ¥çœ‹å…³è”å¤„æ–¹åŠŸèƒ½ - çœŸæ­£çš„æ•°æ®è”åŠ¨
        async function viewRelatedPrescription(prescriptionId) {
            try {
                // é¦–å…ˆå°è¯•ä»å¤„æ–¹ç¼“å­˜ä¸­æŸ¥æ‰¾
                let prescription = prescriptionsDataCache.find(p => p.id == prescriptionId || p.id === parseInt(prescriptionId));
                
                // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œé€šè¿‡APIè·å–ç‰¹å®šå¤„æ–¹æ•°æ®
                if (!prescription) {
                    console.log('å¤„æ–¹ç¼“å­˜ä¸­æœªæ‰¾åˆ°ï¼Œé€šè¿‡APIè·å–å¤„æ–¹æ•°æ®...');
                    try {
                        const response = await fetch(`/api/admin/prescription/${prescriptionId}`);
                        const data = await response.json();
                        
                        if (data.success && data.prescription) {
                            prescription = data.prescription;
                            // å°†è·å–çš„å¤„æ–¹æ·»åŠ åˆ°ç¼“å­˜ä¸­
                            prescriptionsDataCache.push(prescription);
                        } else {
                            throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                        }
                    } catch (apiError) {
                        console.error('APIè·å–å¤„æ–¹å¤±è´¥:', apiError);
                        // å¦‚æœAPIå¤±è´¥ï¼Œå°è¯•ä»å¤„æ–¹åˆ—è¡¨APIè·å–æ‰€æœ‰å¤„æ–¹ï¼Œç„¶åæŸ¥æ‰¾
                        try {
                            const listResponse = await fetch('/api/admin/prescriptions?page=1&per_page=100');
                            const listData = await listResponse.json();
                            
                            if (listData.success && listData.prescriptions) {
                                // æ›´æ–°å¤„æ–¹ç¼“å­˜
                                prescriptionsDataCache = listData.prescriptions;
                                // å†æ¬¡å°è¯•æŸ¥æ‰¾
                                prescription = prescriptionsDataCache.find(p => p.id == prescriptionId || p.id === parseInt(prescriptionId));
                            }
                        } catch (listError) {
                            console.error('è·å–å¤„æ–¹åˆ—è¡¨å¤±è´¥:', listError);
                        }
                    }
                }
                
                if (!prescription) {
                    alert('æ— æ³•è·å–å¤„æ–¹ä¿¡æ¯ã€‚å¯èƒ½åŸå› ï¼š\\n1. å¤„æ–¹IDä¸å­˜åœ¨\\n2. ç½‘ç»œè¿æ¥é—®é¢˜\\n3. å¤„æ–¹å·²è¢«åˆ é™¤');
                    return;
                }
                
                // å…³é—­è®¢å•æ¨¡æ€æ¡†
                closeOrderViewModal();
                
                // æ˜¾ç¤ºå¤„æ–¹è¯¦æƒ… - ä½¿ç”¨ç›¸åŒçš„å¤„æ–¹æŸ¥çœ‹å‡½æ•°é€»è¾‘ï¼Œä½†ä¸ä¾èµ–ç¼“å­˜æŸ¥æ‰¾
                await showPrescriptionDetails(prescription);
                
            } catch (error) {
                console.error('æŸ¥çœ‹å…³è”å¤„æ–¹å¤±è´¥:', error);
                alert('æŸ¥çœ‹å…³è”å¤„æ–¹å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ˜¾ç¤ºå¤„æ–¹è¯¦æƒ…çš„ç‹¬ç«‹å‡½æ•°
        async function showPrescriptionDetails(prescription) {
            // å…³é—­å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¨¡æ€æ¡†
            closePrescriptionViewModal();
            
            const modal = document.createElement('div');
            modal.id = 'viewPrescriptionModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // æ ¼å¼åŒ–å‡½æ•°
            const formatPrescriptionDate = (dateString) => {
                if (!dateString) return 'æœªçŸ¥';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            const formatPrescriptionStatus = (status) => {
                switch(status) {
                    case 'pending': return { text: 'å¾…å®¡æ ¸', color: '#eab308' };
                    case 'approved': return { text: 'å·²é€šè¿‡', color: '#22c55e' };
                    case 'rejected': return { text: 'å·²æ‹’ç»', color: '#ef4444' };
                    case 'modified': return { text: 'å·²ä¿®æ”¹', color: '#3b82f6' };
                    default: return { text: 'æœªçŸ¥', color: '#6b7280' };
                }
            };
            
            const statusInfo = formatPrescriptionStatus(prescription.status);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ“‹ å¤„æ–¹è¯¦æƒ…</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="background: ${statusInfo.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                ${statusInfo.text}
                            </span>
                            <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                                æŒ‰ESCé”®æˆ–ç‚¹å‡»å…³é—­
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- å¤„æ–¹åŸºæœ¬ä¿¡æ¯ -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å¤„æ–¹ID</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.id || 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">æ‚£è€…ä¿¡æ¯</label>
                                    <div style="color: #1f2937; font-weight: 500;">${prescription.patient_name || prescription.patient_id || 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åˆ›å»ºæ—¶é—´</label>
                                    <div style="color: #1f2937; font-weight: 500;">${formatPrescriptionDate(prescription.created_at)}</div>
                                </div>
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">å¤„æ–¹è´¹ç”¨</label>
                                    <div style="color: #059669; font-weight: 500; font-size: 16px;">Â¥${prescription.prescription_fee || '0.00'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç—‡çŠ¶ä¿¡æ¯ -->
                        <div style="background: #fefce8; padding: 20px; border-radius: 10px; border-left: 4px solid #eab308;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ©º ç—‡çŠ¶ä¿¡æ¯</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${prescription.symptoms || 'æœªè®°å½•ç—‡çŠ¶'}
                            </div>
                        </div>
                        
                        <!-- è¯Šæ–­ç»“æœ -->
                        ${prescription.diagnosis ? `
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ”¬ è¯Šæ–­ç»“æœ</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${prescription.diagnosis}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- AIå¤„æ–¹ -->
                        <div style="background: #fef3f2; padding: 20px; border-radius: 10px; border-left: 4px solid #f97316;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ¤– AIç”Ÿæˆå¤„æ–¹</h4>
                            <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px;">
                                ${prescription.ai_prescription || 'æš‚æ— AIå¤„æ–¹'}
                            </div>
                        </div>
                        
                        <!-- åŒ»ç”Ÿå®¡æ ¸ -->
                        ${prescription.doctor_prescription || prescription.doctor_notes ? `
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                            <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿå®¡æ ¸</h4>
                            ${prescription.doctor_prescription ? `
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åŒ»ç”Ÿå¤„æ–¹</label>
                                    <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; font-family: monospace; font-size: 14px;">
                                        ${prescription.doctor_prescription}
                                    </div>
                                </div>
                            ` : ''}
                            ${prescription.doctor_notes ? `
                                <div>
                                    <label style="display: block; color: #6b7280; font-size: 12px; margin-bottom: 5px;">åŒ»ç”Ÿå¤‡æ³¨</label>
                                    <div style="color: #1f2937; font-weight: 400; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        ${prescription.doctor_notes}
                                    </div>
                                </div>
                            ` : ''}
                            ${prescription.reviewed_at ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                    <small style="color: #6b7280;">å®¡æ ¸æ—¶é—´ï¼š${formatPrescriptionDate(prescription.reviewed_at)}</small>
                                </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="closePrescriptionViewModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modal);
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closePrescriptionViewModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._prescriptionViewEscListener = escListener;
            
            // é˜²æ­¢bodyæ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }
        
        function closePrescriptionViewModal() {
            const modal = document.getElementById('viewPrescriptionModal');
            if (modal) {
                modal.remove();
            }
            
            // ç§»é™¤ESCé”®ç›‘å¬å™¨
            if (document._prescriptionViewEscListener) {
                document.removeEventListener('keydown', document._prescriptionViewEscListener);
                document._prescriptionViewEscListener = null;
            }
            
            // ç¡®ä¿bodyå¯ä»¥æ­£å¸¸æ»šåŠ¨
            document.body.style.overflow = '';
        }
        
        // è®¢å•æœç´¢åŠŸèƒ½
        function showOrderSearch() {
            // å…³é—­å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¨¡æ€æ¡†
            closeOrderSearchModal();
            
            const modal = document.createElement('div');
            modal.id = 'orderSearchModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ” è®¢å•æŸ¥è¯¢</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å…³é—­
                        </div>
                    </div>
                    
                    <form id="orderSearchForm" style="display: grid; gap: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">è®¢å•å·</label>
                                <input type="text" id="search_order_no" placeholder="è¾“å…¥å®Œæ•´æˆ–éƒ¨åˆ†è®¢å•å·" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">æ‚£è€…ä¿¡æ¯</label>
                                <input type="text" id="search_patient_info" placeholder="æ‚£è€…å§“åæˆ–ID" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">æ”¯ä»˜çŠ¶æ€</label>
                                <select id="search_payment_status" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="pending">å¾…æ”¯ä»˜</option>
                                    <option value="paid">å·²æ”¯ä»˜</option>
                                    <option value="failed">æ”¯ä»˜å¤±è´¥</option>
                                    <option value="refunded">å·²é€€æ¬¾</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">æ”¯ä»˜æ–¹å¼</label>
                                <select id="search_payment_method" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <option value="">å…¨éƒ¨æ–¹å¼</option>
                                    <option value="alipay">æ”¯ä»˜å®</option>
                                    <option value="wechat">å¾®ä¿¡æ”¯ä»˜</option>
                                    <option value="bank_card">é“¶è¡Œå¡</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">é‡‘é¢èŒƒå›´(æœ€å°)</label>
                                <input type="number" id="search_amount_min" placeholder="0.00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">é‡‘é¢èŒƒå›´(æœ€å¤§)</label>
                                <input type="number" id="search_amount_max" placeholder="1000.00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">å¼€å§‹æ—¶é—´</label>
                                <input type="date" id="search_date_start" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">ç»“æŸæ—¶é—´</label>
                                <input type="date" id="search_date_end" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 5px;">
                                <input type="checkbox" id="search_decoction_only" style="margin-right: 8px;"> 
                                åªæ˜¾ç¤ºä»£ç…è®¢å•
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                ğŸ” å¼€å§‹æœç´¢
                            </button>
                            <button type="button" onclick="resetOrderSearchForm()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                ğŸ”„ é‡ç½®æ¡ä»¶
                            </button>
                            <button type="button" onclick="closeOrderSearchModal()" style="background: #dc2626; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¤„ç†æœç´¢è¡¨å•æäº¤
            document.getElementById('orderSearchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await performOrderSearch();
            });
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeOrderSearchModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._orderSearchEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeOrderSearchModal() {
            const modal = document.getElementById('orderSearchModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._orderSearchEscListener) {
                document.removeEventListener('keydown', document._orderSearchEscListener);
                document._orderSearchEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        function resetOrderSearchForm() {
            document.getElementById('orderSearchForm').reset();
        }
        
        async function performOrderSearch() {
            try {
                const searchParams = {
                    order_no: document.getElementById('search_order_no').value.trim(),
                    patient_info: document.getElementById('search_patient_info').value.trim(),
                    payment_status: document.getElementById('search_payment_status').value,
                    payment_method: document.getElementById('search_payment_method').value,
                    amount_min: document.getElementById('search_amount_min').value,
                    amount_max: document.getElementById('search_amount_max').value,
                    date_start: document.getElementById('search_date_start').value,
                    date_end: document.getElementById('search_date_end').value,
                    decoction_only: document.getElementById('search_decoction_only').checked
                };
                
                // å…ˆå°è¯•ä½¿ç”¨APIæœç´¢ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å®¢æˆ·ç«¯æœç´¢
                try {
                    const queryParams = new URLSearchParams();
                    Object.keys(searchParams).forEach(key => {
                        if (searchParams[key] !== '' && searchParams[key] !== false) {
                            queryParams.append(key, searchParams[key]);
                        }
                    });
                    
                    const response = await fetch(`/api/admin/orders/search?${queryParams}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // APIæœç´¢æˆåŠŸ
                        ordersDataCache = data.orders;
                        displayOrderSearchResults(data.orders);
                        closeOrderSearchModal();
                        alert(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${data.orders.length} æ¡è®¢å•è®°å½•`);
                        return;
                    }
                } catch (apiError) {
                    console.log('APIæœç´¢å¤±è´¥ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æœç´¢:', apiError);
                }
                
                // APIæœç´¢å¤±è´¥ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æœç´¢
                const filteredResults = performOrderClientSideSearch(searchParams);
                displayOrderSearchResults(filteredResults);
                closeOrderSearchModal();
                alert(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${filteredResults.length} æ¡è®¢å•è®°å½•`);
                
            } catch (error) {
                console.error('è®¢å•æœç´¢å¤±è´¥:', error);
                alert('è®¢å•æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function performOrderClientSideSearch(searchParams) {
            let results = [...ordersDataCache];
            
            // æŒ‰è®¢å•å·ç­›é€‰
            if (searchParams.order_no) {
                const orderNo = searchParams.order_no.toLowerCase();
                results = results.filter(o => 
                    o.order_no && o.order_no.toLowerCase().includes(orderNo)
                );
            }
            
            // æŒ‰æ‚£è€…ä¿¡æ¯ç­›é€‰
            if (searchParams.patient_info) {
                const patientInfo = searchParams.patient_info.toLowerCase();
                results = results.filter(o => 
                    (o.patient_name && o.patient_name.toLowerCase().includes(patientInfo)) ||
                    (o.patient_id && o.patient_id.toLowerCase().includes(patientInfo))
                );
            }
            
            // æŒ‰æ”¯ä»˜çŠ¶æ€ç­›é€‰
            if (searchParams.payment_status) {
                results = results.filter(o => o.payment_status === searchParams.payment_status);
            }
            
            // æŒ‰æ”¯ä»˜æ–¹å¼ç­›é€‰
            if (searchParams.payment_method) {
                results = results.filter(o => o.payment_method === searchParams.payment_method);
            }
            
            // æŒ‰é‡‘é¢èŒƒå›´ç­›é€‰
            if (searchParams.amount_min) {
                const minAmount = parseFloat(searchParams.amount_min);
                results = results.filter(o => (o.amount || 0) >= minAmount);
            }
            if (searchParams.amount_max) {
                const maxAmount = parseFloat(searchParams.amount_max);
                results = results.filter(o => (o.amount || 0) <= maxAmount);
            }
            
            // æŒ‰æ—¶é—´èŒƒå›´ç­›é€‰
            if (searchParams.date_start) {
                const startDate = new Date(searchParams.date_start);
                results = results.filter(o => {
                    if (!o.created_at) return false;
                    const orderDate = new Date(o.created_at);
                    return orderDate >= startDate;
                });
            }
            if (searchParams.date_end) {
                const endDate = new Date(searchParams.date_end);
                endDate.setHours(23, 59, 59, 999); // è®¾ç½®ä¸ºå½“å¤©ç»“æŸ
                results = results.filter(o => {
                    if (!o.created_at) return false;
                    const orderDate = new Date(o.created_at);
                    return orderDate <= endDate;
                });
            }
            
            // ä»£ç…è®¢å•ç­›é€‰
            if (searchParams.decoction_only) {
                results = results.filter(o => o.decoction_required === 1);
            }
            
            return results;
        }
        
        function displayOrderSearchResults(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            if (orders.length > 0) {
                tableBody.innerHTML = '';
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.order_no}</td>
                        <td>${order.patient_name || order.patient_id}</td>
                        <td>Â¥${order.amount}</td>
                        <td><span class="status-badge status-${order.payment_status === 'paid' ? 'active' : 'pending'}">${getPaymentStatusText(order.payment_status)}</span></td>
                        <td>${order.payment_method || '-'}</td>
                        <td>${formatDate(order.created_at)}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewOrder('${order.id}')" style="padding: 4px 8px; font-size: 12px;">æŸ¥çœ‹</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®¢å•
                        </td>
                    </tr>
                `;
            }
        }
        
        // æ”¶å…¥ç»Ÿè®¡æŠ¥å‘ŠåŠŸèƒ½
        function showRevenueReport() {
            // å…³é—­å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¨¡æ€æ¡†
            closeRevenueReportModal();
            
            const modal = document.createElement('div');
            modal.id = 'revenueReportModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const stats = calculateRevenueStats();
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 900px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 20px;">ğŸ’° æ”¶å…¥ç»Ÿè®¡æŠ¥å‘Š</h3>
                        <div style="font-size: 12px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                            æŒ‰ESCé”®æˆ–ç‚¹å‡»å…³é—­
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">æ€»æ”¶å…¥</div>
                            <div style="font-size: 24px; font-weight: bold;">Â¥${stats.totalRevenue.toFixed(2)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">å·²æ”¯ä»˜è®¢å•</div>
                            <div style="font-size: 24px; font-weight: bold;">${stats.paidOrders}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #eab308, #ca8a04); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">å¾…æ”¯ä»˜è®¢å•</div>
                            <div style="font-size: 24px; font-weight: bold;">${stats.pendingOrders}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f97316, #ea580c); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">å¹³å‡è®¢å•é‡‘é¢</div>
                            <div style="font-size: 24px; font-weight: bold;">Â¥${stats.avgOrderAmount.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <!-- æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ’³ æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            ${Object.entries(stats.paymentMethods).map(([method, data]) => `
                                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">${getPaymentMethodName(method)}</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${data.count}å•</div>
                                    <div style="font-size: 12px; color: #059669;">Â¥${data.amount.toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- æ”¶å…¥åˆ†æˆç»Ÿè®¡ -->
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ’° æ”¶å…¥åˆ†æˆç»Ÿè®¡</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">åŒ»ç”Ÿä½£é‡‘</div>
                                <div style="font-size: 18px; font-weight: bold; color: #dc2626;">Â¥${stats.doctorCommission.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">æ¨èä½£é‡‘</div>
                                <div style="font-size: 18px; font-weight: bold; color: #dc2626;">Â¥${stats.referrerCommission.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">å¹³å°æ”¶å…¥</div>
                                <div style="font-size: 18px; font-weight: bold; color: #059669;">Â¥${stats.platformRevenue.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä»£ç…è®¢å•ç»Ÿè®¡ -->
                    <div style="background: #fefce8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸšš ä»£ç…è®¢å•ç»Ÿè®¡</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">ä»£ç…è®¢å•</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${stats.decoctionOrders}å•</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">ä»£ç…æ”¶å…¥</div>
                                <div style="font-size: 18px; font-weight: bold; color: #059669;">Â¥${stats.decoctionRevenue.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">ä»£ç…å æ¯”</div>
                                <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${((stats.decoctionOrders / (stats.totalOrders || 1)) * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æœ€è¿‘è®¢å•è¶‹åŠ¿ -->
                    <div style="background: #fef3f2; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin: 0 0 15px 0; font-size: 16px;">ğŸ“ˆ æœ€è¿‘è®¢å•è¶‹åŠ¿</h4>
                        <div id="orderTrendChart" style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <canvas id="revenueChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="exportRevenueReport()" style="background: #3b82f6; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            ğŸ“Š å¯¼å‡ºæŠ¥å‘Š
                        </button>
                        <button onclick="closeRevenueReportModal()" style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç»˜åˆ¶æ”¶å…¥è¶‹åŠ¿å›¾
            setTimeout(() => drawRevenueChart(stats.dailyRevenue), 100);
            
            // ESCé”®å…³é—­
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeRevenueReportModal();
                }
            };
            
            document.addEventListener('keydown', escListener);
            document._revenueReportEscListener = escListener;
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeRevenueReportModal() {
            const modal = document.getElementById('revenueReportModal');
            if (modal) {
                modal.remove();
            }
            
            if (document._revenueReportEscListener) {
                document.removeEventListener('keydown', document._revenueReportEscListener);
                document._revenueReportEscListener = null;
            }
            
            document.body.style.overflow = '';
        }
        
        function calculateRevenueStats() {
            const stats = {
                totalRevenue: 0,
                paidOrders: 0,
                pendingOrders: 0,
                totalOrders: 0,
                avgOrderAmount: 0,
                paymentMethods: {},
                doctorCommission: 0,
                referrerCommission: 0,
                platformRevenue: 0,
                decoctionOrders: 0,
                decoctionRevenue: 0,
                dailyRevenue: {}
            };
            
            ordersDataCache.forEach(order => {
                stats.totalOrders++;
                
                if (order.payment_status === 'paid') {
                    stats.paidOrders++;
                    stats.totalRevenue += parseFloat(order.amount || 0);
                    
                    // æ”¶å…¥åˆ†æˆç»Ÿè®¡
                    stats.doctorCommission += parseFloat(order.doctor_commission || 0);
                    stats.referrerCommission += parseFloat(order.referrer_commission || 0);
                    stats.platformRevenue += parseFloat(order.platform_revenue || 0);
                    
                    // æ”¯ä»˜æ–¹å¼ç»Ÿè®¡
                    const method = order.payment_method || 'unknown';
                    if (!stats.paymentMethods[method]) {
                        stats.paymentMethods[method] = { count: 0, amount: 0 };
                    }
                    stats.paymentMethods[method].count++;
                    stats.paymentMethods[method].amount += parseFloat(order.amount || 0);
                    
                    // æ—¥æ”¶å…¥ç»Ÿè®¡
                    const dateKey = order.created_at ? order.created_at.split(' ')[0] : 'unknown';
                    if (!stats.dailyRevenue[dateKey]) {
                        stats.dailyRevenue[dateKey] = 0;
                    }
                    stats.dailyRevenue[dateKey] += parseFloat(order.amount || 0);
                    
                } else if (order.payment_status === 'pending') {
                    stats.pendingOrders++;
                }
                
                // ä»£ç…è®¢å•ç»Ÿè®¡
                if (order.decoction_required === 1) {
                    stats.decoctionOrders++;
                    if (order.payment_status === 'paid') {
                        stats.decoctionRevenue += parseFloat(order.amount || 0);
                    }
                }
            });
            
            stats.avgOrderAmount = stats.paidOrders > 0 ? stats.totalRevenue / stats.paidOrders : 0;
            
            return stats;
        }
        
        function getPaymentMethodName(method) {
            switch(method) {
                case 'alipay': return 'æ”¯ä»˜å®';
                case 'wechat': return 'å¾®ä¿¡æ”¯ä»˜';
                case 'bank_card': return 'é“¶è¡Œå¡';
                default: return 'å…¶ä»–';
            }
        }
        
        function drawRevenueChart(dailyData) {
            const canvas = document.getElementById('revenueChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // å‡†å¤‡æ•°æ®
            const entries = Object.entries(dailyData).sort((a, b) => a[0].localeCompare(b[0]));
            if (entries.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ”¶å…¥æ•°æ®', width / 2, height / 2);
                return;
            }
            
            const maxValue = Math.max(...entries.map(e => e[1]));
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();
            
            // ç»˜åˆ¶æ•°æ®ç‚¹å’Œçº¿æ¡
            if (entries.length > 1) {
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                entries.forEach((entry, index) => {
                    const x = padding + (index / (entries.length - 1)) * chartWidth;
                    const y = height - padding - (entry[1] / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // ç»˜åˆ¶æ•°æ®ç‚¹
                ctx.fillStyle = '#3b82f6';
                entries.forEach((entry, index) => {
                    const x = padding + (index / (entries.length - 1)) * chartWidth;
                    const y = height - padding - (entry[1] / maxValue) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
            
            // ç»˜åˆ¶æ ‡ç­¾
            ctx.fillStyle = '#6b7280';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            
            // Yè½´æ ‡ç­¾
            for (let i = 0; i <= 5; i++) {
                const value = (maxValue / 5) * i;
                const y = height - padding - (i / 5) * chartHeight;
                ctx.fillText(`Â¥${value.toFixed(0)}`, 20, y);
            }
        }
        
        function exportRevenueReport() {
            const stats = calculateRevenueStats();
            
            const csvContent = [
                ['æ”¶å…¥ç»Ÿè®¡æŠ¥å‘Š', '', ''],
                ['ç”Ÿæˆæ—¶é—´', new Date().toLocaleString('zh-CN'), ''],
                ['', '', ''],
                ['ç»Ÿè®¡é¡¹ç›®', 'æ•°å€¼', 'å•ä½'],
                ['æ€»æ”¶å…¥', stats.totalRevenue.toFixed(2), 'å…ƒ'],
                ['å·²æ”¯ä»˜è®¢å•', stats.paidOrders, 'å•'],
                ['å¾…æ”¯ä»˜è®¢å•', stats.pendingOrders, 'å•'],
                ['å¹³å‡è®¢å•é‡‘é¢', stats.avgOrderAmount.toFixed(2), 'å…ƒ'],
                ['åŒ»ç”Ÿä½£é‡‘', stats.doctorCommission.toFixed(2), 'å…ƒ'],
                ['æ¨èä½£é‡‘', stats.referrerCommission.toFixed(2), 'å…ƒ'],
                ['å¹³å°æ”¶å…¥', stats.platformRevenue.toFixed(2), 'å…ƒ'],
                ['ä»£ç…è®¢å•', stats.decoctionOrders, 'å•'],
                ['ä»£ç…æ”¶å…¥', stats.decoctionRevenue.toFixed(2), 'å…ƒ'],
                ['', '', ''],
                ['æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ', '', ''],
                ...Object.entries(stats.paymentMethods).map(([method, data]) => [
                    getPaymentMethodName(method), data.count + 'å•', 'Â¥' + data.amount.toFixed(2)
                ])
            ].map(row => row.join(',')).join('\\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `æ”¶å…¥ç»Ÿè®¡æŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('æ”¶å…¥ç»Ÿè®¡æŠ¥å‘Šå·²å¯¼å‡ºåˆ°ä¸‹è½½æ–‡ä»¶å¤¹');
        }

        // åŠ è½½ç³»ç»Ÿé…ç½®æ•°æ®
        function loadSettingsData() {
            const settingsContent = document.querySelector('#settings .content-section');
            if (settingsContent) {
                settingsContent.innerHTML = `
                    <div class="content-header">
                        <h2 class="content-title">ç³»ç»Ÿé…ç½®</h2>
                        <p class="content-subtitle">ç®¡ç†ç³»ç»Ÿå‚æ•°å’Œé…ç½®é€‰é¡¹</p>
                    </div>
                    <div style="text-align: center; padding: 60px; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ”§</div>
                        <p>ç³»ç»Ÿé…ç½®åŠŸèƒ½å¼€å‘ä¸­...</p>
                        <p style="margin-top: 10px;">å°†åŒ…å«ç³»ç»Ÿå‚æ•°ã€é‚®ä»¶é…ç½®ç­‰è®¾ç½®</p>
                    </div>
                `;
            }
        }

        // åŠ è½½æ—¥å¿—æ•°æ®
        async function loadLogsData() {
            try {
                const response = await fetch('/api/admin/logs?page=1&per_page=50');
                const data = await response.json();
                
                const tableBody = document.getElementById('logsTableBody');
                if (data.success && data.logs.length > 0) {
                    tableBody.innerHTML = '';
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(log.timestamp)}</td>
                            <td><span class="status-badge status-${log.level.toLowerCase() === 'info' ? 'active' : 'pending'}">${log.level}</span></td>
                            <td>${log.source}</td>
                            <td style="max-width: 400px; word-break: break-word;">${log.message}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: #6b7280;">
                                æš‚æ— æ—¥å¿—æ•°æ®
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—æ•°æ®å¤±è´¥:', error);
                document.getElementById('logsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">
                            åŠ è½½å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // å·¥å…·å‡½æ•°
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusClass(status) {
            const statusMap = {
                'pending': 'pending',
                'approved': 'active',
                'rejected': 'inactive',
                'completed': 'active'
            };
            return statusMap[status] || 'pending';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å®¡æ ¸',
                'doctor_reviewing': 'åŒ»ç”Ÿå®¡æ ¸ä¸­',
                'approved': 'å·²æ‰¹å‡†',
                'rejected': 'å·²æ‹’ç»',
                'patient_confirmed': 'æ‚£è€…å·²ç¡®è®¤',
                'paid': 'å·²æ”¯ä»˜',
                'completed': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        function getPaymentStatusText(status) {
            const statusMap = {
                'pending': 'å¾…æ”¯ä»˜',
                'paid': 'å·²æ”¯ä»˜',
                'failed': 'æ”¯ä»˜å¤±è´¥',
                'refunded': 'å·²é€€æ¬¾',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç®¡ç†ç³»ç»Ÿå—ï¼Ÿ')) {
                localStorage.removeItem('adminToken');
                window.location.href = '/login';
            }
        }

        // å¿«é€Ÿè·³è½¬åˆ°æ‚£è€…é—®è¯Šç•Œé¢
        function goToPatientInterface() {
            // åœ¨æ–°çª—å£/æ ‡ç­¾é¡µæ‰“å¼€æ‚£è€…ç•Œé¢ï¼Œé¿å…ä¸¢å¤±ç®¡ç†ç•Œé¢
            window.open('/patient', '_blank');
        }
    </script>
</body>
</html>