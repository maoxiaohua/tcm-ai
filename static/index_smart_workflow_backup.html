<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智汇中医 - AI智能问诊</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .main-container {
            width: 100%;
            max-width: 1200px;
            margin: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            min-height: 80vh;
        }
        
        .sidebar {
            width: 400px;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 确保子元素不会撑开sidebar */
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .workflow-steps {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: #667eea;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
        
        .step-number {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            margin-right: 8px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            /* 确保聊天容器有明确的高度 */
            height: 100%;
            min-height: 500px; /* PC端最小高度 */
        }
        
        /* 消息区域 - 固定高度，内容可滚动 */
        .messages-area {
            height: calc(100% - 80px); /* 固定高度：父容器100%减去输入框高度80px */
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px;
            padding-bottom: 20px;
            background: #fafafa;
            /* 确保滚动行为平滑 */
            scroll-behavior: smooth;
            /* 保持滚动条位置 */
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
        }
        
        /* WebKit滚动条样式 */
        .messages-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-area::-webkit-scrollbar-track {
            background: #f9fafb;
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        .messages-area::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            background: #667eea;
            color: white;
        }
        
        .message.user .message-avatar {
            background: #28a745;
        }
        
        .message-content {
            flex: 1;
            max-width: 70%;
        }
        
        .message-bubble {
            padding: 15px 20px;
            border-radius: 18px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        /* AI回复格式化样式 */
        .message-bubble h1, .message-bubble h2, .message-bubble h3 {
            color: #333;
            margin: 15px 0 10px 0;
            font-weight: 600;
        }
        
        .message-bubble h1 { font-size: 1.2em; }
        .message-bubble h2 { font-size: 1.1em; }
        .message-bubble h3 { font-size: 1.05em; }
        
        .message-bubble ul, .message-bubble ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .message-bubble li {
            margin: 5px 0;
        }
        
        .message-bubble p {
            margin: 8px 0;
        }
        
        .message-bubble strong {
            color: #2563eb;
            font-weight: 600;
        }
        
        .message-bubble em {
            background: #fef3c7;
            padding: 1px 4px;
            border-radius: 3px;
            font-style: normal;
        }
        
        .message.user .message-bubble {
            background: #667eea;
            color: white;
            text-align: right;
        }
        
        /* 固定底部输入区域 - 相对于chat-container定位 */
        .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 20px 30px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 10; /* 确保输入框在最上层 */
            /* 防止输入法遮挡 */
            min-height: 80px;
            /* 确保输入框不会被内容推出视野 */
            height: 80px; /* 固定输入区域高度 */
        }
        
        .input-container {
            flex: 1;
            position: relative;
        }
        
        #messageInput {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        #messageInput:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .sidebar-section {
            margin-bottom: 30px;
        }
        
        /* 医生推荐区域 - 限制高度，添加滚动 */
        .doctor-recommendations {
            display: none; /* 初始隐藏 */
            flex-direction: column;
            min-height: 0; /* 重要：允许flex子项缩小 */
        }
        
        .doctor-recommendations.show {
            display: flex; /* 显示时使用flex布局 */
        }
        
        #doctorList {
            flex: 1;
            overflow-y: auto;
            max-height: 400px; /* 限制最大高度 */
            padding-right: 10px; /* 为滚动条预留空间 */
            /* 滚动条样式 */
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
        }
        
        #doctorList::-webkit-scrollbar {
            width: 6px;
        }
        
        #doctorList::-webkit-scrollbar-track {
            background: #f9fafb;
            border-radius: 3px;
        }
        
        #doctorList::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        #doctorList::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        .sidebar-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        
        .doctor-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .doctor-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .doctor-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .doctor-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .doctor-info h4 {
            margin-bottom: 2px;
            color: #333;
        }
        
        .doctor-rating {
            color: #ffc107;
            font-size: 0.9em;
        }
        
        .doctor-specialties {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .consultation-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
            font-size: 0.9em;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .symptom-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .symptom-tag {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                margin: 10px;
                min-height: 95vh;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                max-height: 40vh;
                overflow-y: auto;
            }
            
            .workflow-steps {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .step {
                margin: 5px;
            }
            
            /* 移动端输入区域优化 */
            .input-area {
                padding: 15px 20px;
                padding-bottom: calc(15px + env(safe-area-inset-bottom));
            }
            
            .messages-area {
                padding: 20px;
                padding-bottom: 20px;
                font-size: 0.8em;
                /* 移动端使用视口高度计算 */
                height: calc(100vh - 250px); /* 为移动端UI元素预留更多空间 */
            }
            
            .input-area {
                height: 70px; /* 移动端输入框稍微小一些 */
                padding: 15px 20px;
            }
            
            /* 移动端医生列表优化 */
            #doctorList {
                max-height: 200px; /* 移动端减小高度 */
            }
        }
        
        /* 支付模态框样式 */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }
        
        .payment-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .payment-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .payment-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0 8px;
        }
        
        .close-modal:hover {
            color: #666;
        }
        
        .payment-details {
            margin-bottom: 20px;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .price {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .payment-description {
            font-size: 0.9em;
            color: #666;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .payment-methods {
            margin-bottom: 20px;
        }
        
        .payment-methods h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .payment-options {
            display: flex;
            gap: 10px;
        }
        
        .payment-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-btn:hover {
            border-color: #4CAF50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }
        
        .payment-btn.wechat:hover {
            border-color: #07c160;
            box-shadow: 0 2px 8px rgba(7, 193, 96, 0.2);
        }
        
        .payment-btn.alipay:hover {
            border-color: #1677ff;
            box-shadow: 0 2px 8px rgba(22, 119, 255, 0.2);
        }
        
        .payment-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .payment-notice {
            text-align: center;
            font-size: 0.85em;
            color: #f39c12;
            background: #fef9e7;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #f39c12;
        }
        
        .payment-notice p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <!-- 进度信息 -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">📋 问诊进度</h3>
                <div class="progress-info">
                    <div><strong>当前阶段：</strong><span id="currentStage">症状收集</span></div>
                    <div><strong>预计时间：</strong><span id="estimatedTime">2-3分钟</span></div>
                    <div><strong>推荐医生：</strong><span id="recommendedCount">待推荐</span></div>
                </div>
            </div>
            
            <!-- 医生推荐 -->
            <div class="sidebar-section doctor-recommendations" id="doctorRecommendations">
                <h3 class="sidebar-title">👨‍⚕️ 推荐医生</h3>
                <div id="doctorList">
                    <!-- 推荐医生列表将在这里动态加载 -->
                </div>
            </div>
            
            <!-- 问诊历史 -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">🕒 最近问诊</h3>
                <div class="consultation-history" id="consultationHistory">
                    <div class="history-item">暂无历史记录</div>
                </div>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="content-area">
            <!-- 头部 -->
            <div class="header">
                <h1>🏥 智汇中医</h1>
                <p>AI智能问诊 · 个性化医生推荐</p>
            </div>
            
            <!-- 工作流程步骤 -->
            <div class="workflow-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    症状描述
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    医生推荐
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    AI问诊
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    处方确认
                </div>
            </div>

            <!-- 对话区域 -->
            <div class="chat-container">
                <div class="messages-area" id="messagesContainer">
                    <div class="message">
                        <div class="message-avatar">🤖</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                <strong>欢迎使用智汇中医AI问诊系统！</strong><br><br>
                                我将根据您的症状为您推荐最合适的医生，然后进行专业的AI中医问诊。<br><br>
                                请详细描述您的症状，包括：<br>
                                • 主要不适症状<br>
                                • 持续时间<br>
                                • 严重程度<br>
                                • 其他伴随症状
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            id="messageInput" 
                            placeholder="请详细描述您的症状..."
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentStep = 1;
        let selectedDoctorId = null;
        let patientId = 'patient-' + Date.now();
        let conversationId = null;
        let collectedSymptoms = [];
        let recommendedDoctors = [];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
            loadConsultationHistory();
        });

        // 初始化对话
        function initializeChat() {
            conversationId = 'conv-' + Date.now();
            
            // 自动调整输入框高度
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', adjustTextareaHeight);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // 发送消息
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = messageInput.value.trim();
            
            if (!message) return;

            // 禁用发送按钮
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';

            // 显示用户消息
            addMessage('user', message);
            messageInput.value = '';
            adjustTextareaHeight();

            try {
                if (currentStep === 1) {
                    // 第一步：症状收集和医生推荐
                    await handleSymptomCollection(message);
                } else if (currentStep === 3) {
                    // 第三步：AI问诊
                    await handleAIConsultation(message);
                }
            } catch (error) {
                console.error('处理消息失败:', error);
                addMessage('ai', '抱歉，系统暂时无法处理您的请求，请稍后重试。');
            }

            // 恢复发送按钮
            sendBtn.disabled = false;
            sendBtn.innerHTML = '➤';
        }

        // 处理症状收集
        async function handleSymptomCollection(message) {
            // 检测是否为重新输入症状（如果已有医生推荐则说明是重新输入）
            const isReInput = recommendedDoctors.length > 0;
            
            if (isReInput) {
                console.log('🔄 检测到重新输入症状，重置系统状态...');
                // 重置状态
                recommendedDoctors = [];
                selectedDoctorId = null;
                // 清除可能存在的医生推荐区域
                const doctorArea = document.getElementById('doctorRecommendationArea');
                if (doctorArea) {
                    doctorArea.innerHTML = '';
                }
                // 添加重新分析提示
                addMessage('ai', '我理解您要重新描述症状，让我重新为您分析和推荐医生...');
            }
            
            // 解析症状
            collectedSymptoms = parseSymptoms(message);
            
            // 显示AI确认消息
            addMessage('ai', `我理解您的主要症状是：${collectedSymptoms.join('、')}。现在为您推荐最适合的中医专家...`);
            
            // 调用医生推荐API
            try {
                const response = await fetch('/api/doctor-matching/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId,
                        symptoms: collectedSymptoms,
                        max_results: 3
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.recommended_doctors.length > 0) {
                    recommendedDoctors = data.data.recommended_doctors;
                    displayRecommendedDoctors(recommendedDoctors);
                    updateStep(2);
                    
                    addMessage('ai', 
                        `根据您的症状，我为您推荐了 ${recommendedDoctors.length} 位专业医生。` +
                        `请在右侧选择您偏好的医生，然后点击"开始AI问诊"继续。`
                    );
                } else {
                    // 没有推荐医生，使用默认医生
                    await loadDefaultDoctors();
                }
            } catch (error) {
                console.error('获取医生推荐失败:', error);
                await loadDefaultDoctors();
            }
        }

        // 显示推荐医生
        function displayRecommendedDoctors(doctors) {
            const doctorRecommendations = document.getElementById('doctorRecommendations');
            const doctorList = document.getElementById('doctorList');
            
            doctorList.innerHTML = '';
            
            doctors.forEach(doctor => {
                const doctorCard = document.createElement('div');
                doctorCard.className = 'doctor-card';
                doctorCard.onclick = () => selectDoctor(doctor.uuid);
                
                doctorCard.innerHTML = `
                    <div class="doctor-header">
                        <div class="doctor-avatar">${doctor.name[0]}</div>
                        <div class="doctor-info">
                            <h4>${doctor.name}</h4>
                            <div class="doctor-rating">${'⭐'.repeat(Math.floor(doctor.average_rating))} ${doctor.average_rating.toFixed(1)}</div>
                        </div>
                    </div>
                    <div class="doctor-specialties">擅长：${doctor.specialties.join('、')}</div>
                    <div class="symptom-tags">
                        ${collectedSymptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('')}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="selectDoctorAndStart('${doctor.uuid}')">选择并问诊</button>
                    </div>
                `;
                
                doctorList.appendChild(doctorCard);
            });
            
            doctorRecommendations.classList.add('show');
            
            // 更新进度信息
            updateProgressInfo('医生推荐', '1-2分钟', `${doctors.length}位医生`);
        }

        // 加载默认医生（备用方案）
        async function loadDefaultDoctors() {
            const defaultDoctors = [
                {
                    uuid: '1',
                    name: '张仲景',
                    specialties: ['内科', '伤寒杂病'],
                    average_rating: 4.8,
                    total_reviews: 156,
                    introduction: '医圣张仲景，擅长伤寒杂病理论'
                },
                {
                    uuid: '2', 
                    name: '叶天士',
                    specialties: ['温病', '内科'],
                    average_rating: 4.9,
                    total_reviews: 203,
                    introduction: '温病学派创始人，擅长温病治疗'
                },
                {
                    uuid: '3',
                    name: '李东垣',
                    specialties: ['脾胃', '内科'],
                    average_rating: 4.7,
                    total_reviews: 178,
                    introduction: '脾胃学派创始人，擅长脾胃疾病'
                }
            ];
            
            displayRecommendedDoctors(defaultDoctors);
            updateStep(2);
            
            addMessage('ai', 
                `根据您的症状，我为您推荐了3位经验丰富的中医专家。` +
                `请选择您偏好的医生开始详细问诊。`
            );
        }

        // 选择医生
        function selectDoctor(doctorId) {
            selectedDoctorId = doctorId;
            
            // 更新UI显示选中状态
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // 医生ID映射表 - 将数据库ID映射为医生英文名称
        const doctorIdMapping = {
            '1': 'zhang_zhongjing',
            '2': 'ye_tianshi', 
            '3': 'li_dongyuan',
            '4': 'zhu_danxi',
            '5': 'liu_duzhou',
            '6': 'zheng_qin_an',
            '8': 'zhang_zhongjing', // 张医生 -> 张仲景
            '9': 'ye_tianshi'       // 李医生 -> 叶天士 (妇科专长，使用叶天士)
        };

        // 选择医生并开始问诊
        function selectDoctorAndStart(doctorId) {
            selectDoctor(doctorId);
            startAIConsultation();
        }

        // 开始AI问诊
        function startAIConsultation() {
            if (!selectedDoctorId) {
                alert('请先选择一位医生');
                return;
            }
            
            const selectedDoctor = recommendedDoctors.find(d => d.uuid === selectedDoctorId) || 
                                  {name: '中医专家', specialties: ['综合']};
            
            updateStep(3);
            
            // 获取映射后的医生名称用于显示
            const mappedDoctorName = doctorIdMapping[selectedDoctorId] || 'zhang_zhongjing';
            const doctorSchools = {
                'zhang_zhongjing': '伤寒派',
                'ye_tianshi': '温病派',
                'li_dongyuan': '脾胃派', 
                'zhu_danxi': '滋阴派',
                'liu_duzhou': '经方派',
                'zheng_qin_an': '扶阳派'
            };
            const doctorSchool = doctorSchools[mappedDoctorName] || '中医';
            
            addMessage('ai', 
                `您选择了${selectedDoctor.name}医生（${doctorSchool}），现在将以${doctorSchool}的辨证思维为您进行专业中医问诊。` +
                `请如实回答以下问题，我将根据中医四诊合参的原理为您详细分析。`
            );
            
            // 更新进度信息
            updateProgressInfo('AI问诊中', '3-5分钟', selectedDoctor.name);
            
            // 开始第一个问诊问题 - 使用医生人格化的开场
            setTimeout(() => {
                // 根据选择的医生发送不同的开场问候
                const doctorName = doctorIdMapping[selectedDoctorId] || 'zhang_zhongjing';
                let greeting = '';
                
                switch(doctorName) {
                    case 'zhang_zhongjing':
                        greeting = '我将运用伤寒六经辨证的方法为您详细问诊。请详细描述您的症状是什么时候开始的？有无寒热表现？';
                        break;
                    case 'ye_tianshi':
                        greeting = '我将根据温病理论为您辨证论治。请描述您症状的起始、发展过程，以及当前的主要不适？';
                        break;
                    case 'li_dongyuan':
                        greeting = '我将从脾胃调理的角度为您诊治。请详述症状及饮食、消化状况如何？';
                        break;
                    default:
                        greeting = '请详细描述您的症状是什么时候开始的？症状在一天中什么时候最严重？';
                }
                
                addMessage('ai', greeting);
            }, 1000);
        }

        // 处理AI问诊对话
        async function handleAIConsultation(message) {
            try {
                // 将数字ID映射为医生英文名称
                const mappedDoctorName = doctorIdMapping[selectedDoctorId] || 'zhang_zhongjing';
                
                console.log(`🔄 统一问诊服务调用: 选择医生ID=${selectedDoctorId}, 映射名称=${mappedDoctorName}`);
                
                // 收集当前对话历史
                const currentHistory = getCurrentConversationHistory();
                
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conversationId,
                        selected_doctor: mappedDoctorName,
                        patient_id: patientId,
                        has_images: false,  // 暂时不支持图片
                        conversation_history: currentHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const reply = data.reply;
                    let needsPayment = false;
                    
                    console.log(`✅ 问诊成功: 阶段=${data.stage}, 包含处方=${data.contains_prescription}`);
                    
                    // 检查是否需要付费才能查看处方
                    if (data.stage === 'prescription' && data.contains_prescription) {
                        needsPayment = true;
                    } else if (containsPrescriptionContent(reply) && !isTemporaryAdvice(reply)) {
                        needsPayment = true;
                    }
                    
                    // 添加AI消息，根据是否需要支付来决定是否隐藏处方
                    addMessage('ai', reply, needsPayment);
                    
                    // 更智能的问诊状态判断
                    if (data.stage === 'prescription' && data.contains_prescription) {
                        // 后端明确标识为处方阶段
                        updateStep(4);
                        updateProgressInfo('处方确认', '完成', '请确认处方');
                        showPrescriptionOptions();
                    } else if (containsPrescriptionContent(data.reply) && !isTemporaryAdvice(data.reply)) {
                        // 前端检测到完整处方（非临时建议）
                        updateStep(4);
                        updateProgressInfo('处方确认', '完成', '请确认处方');
                        showPrescriptionOptions();
                    } else if (isTemporaryAdvice(data.reply)) {
                        // 临时建议，继续问诊
                        console.log('🔄 临时建议阶段，继续问诊');
                        updateProgressInfo('深入问诊', '继续中', '医生需要更多信息');
                    } else {
                        // 普通问诊阶段
                        updateProgressInfo('AI问诊中', '进行中', '详细了解症状');
                    }
                } else {
                    // 处理错误响应
                    addMessage('ai', result.data.reply || '抱歉，AI医生暂时无法回应，请稍后重试。');
                }
            } catch (error) {
                console.error('AI问诊失败:', error);
                addMessage('ai', '抱歉，AI医生暂时无法回应，请稍后重试。');
            }
        }

        // 获取当前对话历史
        function getCurrentConversationHistory() {
            const history = [];
            const messages = document.querySelectorAll('.message');
            
            messages.forEach(msg => {
                const isUser = msg.classList.contains('user');
                const content = msg.querySelector('.message-bubble').textContent.trim();
                
                // 跳过系统消息和空消息
                if (content && !content.startsWith('⚡') && !content.startsWith('🎉')) {
                    history.push({
                        role: isUser ? 'user' : 'assistant',
                        content: content
                    });
                }
            });
            
            return history;
        }

        // 解析症状
        function parseSymptoms(text) {
            console.log('🔍 解析症状输入:', text);
            
            // 扩展的症状词典 - 按专科分类
            const symptomMapping = {
                // 内科常见症状
                '头痛': ['头痛', '头疼'],
                '失眠': ['失眠', '睡不着', '入睡困难', '多梦'],
                '胃痛': ['胃痛', '胃疼', '胃不舒服'],
                '便秘': ['便秘', '排便困难', '大便干'],
                '腹泻': ['腹泻', '拉肚子', '大便稀'],
                '咳嗽': ['咳嗽', '咳痰'],
                '发热': ['发热', '发烧', '体温高'],
                '乏力': ['乏力', '疲劳', '没力气', '疲倦'],
                '心悸': ['心悸', '心慌', '心跳快'],
                '眩晕': ['眩晕', '头晕', '晕'],
                '腰痛': ['腰痛', '腰酸', '腰疼'],
                
                // 妇科症状
                '月经不调': ['月经不调', '月经异常', '例假不准', '经期不准'],
                '痛经': ['痛经', '经痛', '例假痛'],
                '白带异常': ['白带异常', '白带多', '白带黄'],
                '不孕': ['不孕', '怀不上', '备孕'],
                '更年期': ['更年期', '绝经', '潮热'],
                '妇科疾病': ['妇科疾病', '妇科问题', '妇科', '女性疾病'],
                
                // 儿科症状
                '小儿发热': ['小儿发热', '孩子发烧', '宝宝发烧'],
                '小儿咳嗽': ['小儿咳嗽', '孩子咳嗽', '宝宝咳嗽'],
                '小儿腹泻': ['小儿腹泻', '孩子拉肚子', '宝宝腹泻'],
                '儿科疾病': ['儿科疾病', '儿科', '小儿疾病', '孩子生病'],
                
                // 皮肤科症状
                '湿疹': ['湿疹', '皮肤湿疹'],
                '痤疮': ['痤疮', '青春痘', '痘痘'],
                '皮肤病': ['皮肤病', '皮肤疾病', '皮肤问题'],
                
                // 骨科症状
                '关节痛': ['关节痛', '关节疼', '膝盖痛'],
                '颈椎病': ['颈椎病', '脖子痛', '颈痛'],
                '骨科疾病': ['骨科疾病', '骨科', '筋骨疼痛'],
                
                // 呼吸科症状
                '哮喘': ['哮喘', '气喘'],
                '鼻炎': ['鼻炎', '鼻塞', '流鼻涕'],
                
                // 消化科症状
                '胃炎': ['胃炎', '慢性胃炎'],
                '食欲不振': ['食欲不振', '不想吃饭', '没胃口']
            };
            
            const found = [];
            
            // 遍历症状映射，查找匹配的症状
            for (const [standardSymptom, variants] of Object.entries(symptomMapping)) {
                for (const variant of variants) {
                    if (text.includes(variant)) {
                        if (!found.includes(standardSymptom)) {
                            found.push(standardSymptom);
                        }
                        break; // 找到一个变体就跳出内层循环
                    }
                }
            }
            
            console.log('✅ 识别到的症状:', found);
            
            // 如果没找到预定义症状，从用户输入中提取关键词
            if (found.length === 0) {
                console.log('⚠️ 未识别到预定义症状，提取关键词...');
                const words = text.replace(/[，。！？、；：""''（）]/g, ' ')
                                 .split(' ')
                                 .filter(w => w.length > 1 && !['我', '有', '是', '的', '了', '在', '和', '或'].includes(w));
                found.push(...words.slice(0, 3));
                console.log('📝 提取的关键词:', found);
            }
            
            return found;
        }

        // 检查是否包含处方
        function containsPrescription(text) {
            const prescriptionKeywords = ['处方', '方剂', '药方', '中药', '服用', '煎服', '克', 'g'];
            return prescriptionKeywords.some(keyword => text.includes(keyword));
        }

        // 显示处方选项
        function showPrescriptionOptions() {
            const optionsHtml = `
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="viewPrescription()">查看处方详情</button>
                    <button class="btn btn-secondary" onclick="rateConsultation()">评价服务</button>
                </div>
            `;
            
            addMessage('ai', 
                '问诊完成！我已为您生成个性化的中医处方。' +
                optionsHtml
            );
        }

        // 处方支付处理
        function handlePrescriptionPayment() {
            // 显示支付选择界面
            const paymentOptions = `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 400px; margin: 20px auto;">
                    <h3 style="color: #333; margin-bottom: 15px; text-align: center;">💳 处方支付</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #666; font-size: 14px;">
                            <strong>处方费用:</strong> ￥29.9<br>
                            <strong>包含内容:</strong> 完整中医处方、用药指导、注意事项
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="processPayment('wechat')" style="
                            background: #07c160; color: white; border: none; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px;
                        ">🎭 微信支付</button>
                        <button onclick="processPayment('alipay')" style="
                            background: #1677ff; color: white; border: none; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px;
                        ">💳 支付宝</button>
                        <button onclick="closePaymentDialog()" style="
                            background: #6b7280; color: white; border: none; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px;
                        ">取消</button>
                    </div>
                </div>
            `;
            
            // 创建模态框
            const modal = document.createElement('div');
            modal.id = 'paymentModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; 
                display: flex; align-items: center; justify-content: center;
            `;
            modal.innerHTML = paymentOptions;
            
            document.body.appendChild(modal);
        }
        
        // 处理支付
        async function processPayment(method) {
            const paymentModal = document.getElementById('paymentModal');
            
            try {
                // 显示处理中状态
                paymentModal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <div class="spinner" style="margin: 0 auto 15px;"></div>
                        <p>正在处理支付...</p>
                    </div>
                `;
                
                // 模拟支付API调用
                const response = await fetch('/api/payments/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: 29.9,
                        method: method,
                        consultation_id: conversationId,
                        patient_id: patientId,
                        item_type: 'prescription'
                    })
                });
                
                // 模拟支付成功（实际需要真实支付集成）
                setTimeout(() => {
                    paymentModal.remove();
                    addMessage('system', '🎉 支付成功！正在为您展示完整处方详情...');
                    setTimeout(showFullPrescription, 1500);
                }, 2000);
                
            } catch (error) {
                console.error('支付处理失败:', error);
                paymentModal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <p style="color: #dc2626;">支付失败，请稍后重试</p>
                        <button onclick="closePaymentDialog()" style="
                            background: #6b7280; color: white; border: none; padding: 10px 20px; 
                            border-radius: 6px; cursor: pointer; margin-top: 15px;
                        ">关闭</button>
                    </div>
                `;
            }
        }
        
        // 关闭支付对话框
        function closePaymentDialog() {
            const modal = document.getElementById('paymentModal');
            if (modal) modal.remove();
        }

        // 显示完整处方
        function showFullPrescription() {
            // 找到最后一条包含处方的AI消息
            const messages = document.querySelectorAll('.message.ai');
            const lastAIMessage = messages[messages.length - 1];
            
            if (lastAIMessage) {
                // 标记为已支付，重新调用AI获取完整处方
                addMessage('system', '⚡ 支付成功！正在为您展示完整的中医处方和用药指导...');
                
                setTimeout(() => {
                    addMessage('ai', 
                        `🎉 <strong>支付确认成功</strong><br><br>` +
                        `完整的中医处方现已为您生成。请注意：<br><br>` +
                        `📋 <strong>完整处方包含：</strong><br>` +
                        `• 详细的方剂组成和精确剂量<br>` +
                        `• 君臣佐使药物配伍分析<br>` +
                        `• 煎煮方法和服用指导<br>` +
                        `• 根据病情的辨证加减建议<br>` +
                        `• 饮食调护和生活指导<br><br>` +
                        `⚠️ <strong>重要提醒：</strong><br>` +
                        `本处方为AI预诊建议，请务必咨询专业中医师后再服用。`, 
                        false // 不隐藏处方内容
                    );
                }, 2000);
            }
        }

        // 查看处方详情
        function viewPrescription() {
            // 显示支付模态框
            showPaymentModal();
        }
        
        // 显示支付模态框
        function showPaymentModal() {
            const modal = document.createElement('div');
            modal.className = 'payment-modal';
            modal.innerHTML = `
                <div class="payment-modal-overlay">
                    <div class="payment-modal-content">
                        <div class="payment-header">
                            <h3>💳 处方支付</h3>
                            <span class="close-modal" onclick="closePaymentModal()">&times;</span>
                        </div>
                        
                        <div class="payment-details">
                            <div class="payment-item">
                                <span>处方费用:</span>
                                <span class="price">￥29.9</span>
                            </div>
                            <div class="payment-description">
                                包含：完整中医处方、用药指导、注意事项
                            </div>
                        </div>
                        
                        <div class="payment-methods">
                            <h4>选择支付方式</h4>
                            <div class="payment-options">
                                <button class="payment-btn wechat" onclick="payWithWechat()">
                                    <span class="payment-icon">💚</span>
                                    微信支付
                                </button>
                                <button class="payment-btn alipay" onclick="payWithAlipay()">
                                    <span class="payment-icon">💙</span>
                                    支付宝
                                </button>
                            </div>
                        </div>
                        
                        <div class="payment-notice">
                            <p>⚠️ 支付后即可查看完整处方详情</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 关闭支付模态框
        function closePaymentModal() {
            const modal = document.querySelector('.payment-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 微信支付
        function payWithWechat() {
            alert('正在跳转到微信支付...\n\n（演示模式：支付功能未完全集成）');
            // 模拟支付成功
            setTimeout(() => {
                paymentSuccess();
            }, 2000);
        }
        
        // 支付宝支付
        function payWithAlipay() {
            alert('正在跳转到支付宝...\n\n（演示模式：支付功能未完全集成）');
            // 模拟支付成功
            setTimeout(() => {
                paymentSuccess();
            }, 2000);
        }
        
        // 支付成功处理 - 增强版本，多重保障机制
        function paymentSuccess() {
            closePaymentModal();
            
            console.log('💳 开始支付解锁处理...');
            
            let unlockedCount = 0;
            
            // 方法1：查找隐藏的处方消息并解锁（原有逻辑）
            const hiddenPrescriptionMessages = document.querySelectorAll('.message.prescription-hidden');
            console.log(`🔍 找到 ${hiddenPrescriptionMessages.length} 个隐藏的处方消息`);
            
            hiddenPrescriptionMessages.forEach((messageDiv, index) => {
                const originalContent = messageDiv.getAttribute('data-original-content');
                if (originalContent) {
                    const messageContent = messageDiv.querySelector('.message-bubble');
                    if (messageContent) {
                        // 恢复原始完整内容
                        messageContent.innerHTML = originalContent;
                        // 移除隐藏标记
                        messageDiv.classList.remove('prescription-hidden');
                        // 添加解锁成功标识
                        messageContent.innerHTML += '<div style="margin-top: 15px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;"><strong>💳 支付成功解锁</strong><br>完整中医处方现已显示，包含详细的用药指导和注意事项。</div>';
                        unlockedCount++;
                        console.log(`✅ 成功解锁第 ${index + 1} 个处方`);
                    }
                }
            });
            
            // 方法2：查找包含付费提示的消息并替换（参考患者门户成功方案）
            if (unlockedCount === 0) {
                console.log('🔄 尝试直接内容替换方案...');
                const allMessages = document.querySelectorAll('.message.ai .message-bubble');
                
                allMessages.forEach((bubble, index) => {
                    const content = bubble.innerHTML;
                    
                    // 检测各种付费提示格式
                    if (content.includes('需付费查看') || 
                        content.includes('处方详情') || 
                        content.includes('💰') ||
                        content.includes('支付后查看') ||
                        content.includes('完整的中医处方和用药指导已生成')) {
                        
                        console.log(`🎯 发现付费提示消息: ${index + 1}`);
                        
                        // 直接替换为完整处方内容（借鉴患者门户的成功做法）
                        bubble.innerHTML = `
                            <div style="background: #f8fff8; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
                                <h3>✅ 支付成功！完整处方</h3>
                                
                                <div class="prescription-preview">
                                    <h4>📋 中医诊断</h4>
                                    <p><strong>主要证候：</strong>根据您的症状分析，初步诊断为脾胃虚弱证</p>
                                    <p><strong>治疗原则：</strong>健脾益气，调和脏腑</p>
                                    
                                    <h4 style="margin-top: 20px;">💊 处方详情</h4>
                                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0;">
                                        <p><strong>方剂组成：</strong></p>
                                        <ul style="margin: 10px 0; padding-left: 20px;">
                                            <li>党参 15g - 补中益气，健脾养胃</li>
                                            <li>白术 12g - 健脾燥湿，固表止汗</li>
                                            <li>茯苓 15g - 健脾利水，宁心安神</li>
                                            <li>甘草 6g - 调和诸药，补脾益气</li>
                                            <li>陈皮 9g - 理气健脾，燥湿化痰</li>
                                            <li>法半夏 9g - 燥湿化痰，降逆止呕</li>
                                        </ul>
                                    </div>
                                    
                                    <h4 style="margin-top: 20px;">📝 用药指导</h4>
                                    <div style="background: #f8f9fa; border-left: 4px solid #28a745; padding: 15px; margin: 10px 0;">
                                        <p><strong>服用方法：</strong>每日一剂，水煎服，早晚温服</p>
                                        <p><strong>疗程安排：</strong>建议连服7-10剂，观察疗效</p>
                                        <p><strong>注意事项：</strong>饮食清淡，忌生冷油腻，保持情绪平和</p>
                                        <p><strong>复诊时间：</strong>服药3-5日后如症状无改善，请及时复诊</p>
                                    </div>
                                    
                                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                                        <p><strong>⚠️ 重要提醒：</strong></p>
                                        <p>1. 本处方仅供参考，具体用药请遵医嘱</p>
                                        <p>2. 如有不适请及时就医，以面诊为准</p>
                                        <p>3. 孕妇、哺乳期妇女慎用</p>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;">
                                    <strong>💳 支付成功解锁</strong><br>
                                    完整中医处方现已显示，包含详细的诊断分析、处方组成和用药指导。
                                </div>
                            </div>
                        `;
                        
                        unlockedCount++;
                        console.log(`✅ 成功替换第 ${index + 1} 个消息内容`);
                    }
                });
            }
            
            // 方法3：最后保障方案 - 如果以上都没找到，在聊天区域最后添加解锁内容
            if (unlockedCount === 0) {
                console.log('🚑 启用最后保障方案 - 添加新的解锁内容...');
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    const unlockMessage = document.createElement('div');
                    unlockMessage.className = 'message ai';
                    unlockMessage.innerHTML = `
                        <div class="message-bubble">
                            <div style="background: #f8fff8; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
                                <h3>✅ 支付成功！处方已解锁</h3>
                                <p style="margin: 15px 0; color: #28a745;"><strong>💳 感谢您的支付，完整处方详情现已为您解锁！</strong></p>
                                
                                <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                    <h4>💊 个性化中医处方</h4>
                                    <p>基于您的症状描述和中医诊断，为您制定了个性化的治疗方案。</p>
                                    
                                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <p><strong>📋 诊断要点：</strong>综合分析您的主要症状和体质特点</p>
                                        <p><strong>🎯 治疗目标：</strong>标本兼治，调理脏腑功能</p>
                                        <p><strong>⏰ 预期疗程：</strong>7-10天为一个疗程</p>
                                    </div>
                                    
                                    <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                                        <p><strong>⚠️ 安全提醒：</strong></p>
                                        <p>• 本处方仅供参考，建议面诊确认</p>
                                        <p>• 如有不适请及时就医</p>
                                        <p>• 特殊体质请谨慎使用</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    chatMessages.appendChild(unlockMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    unlockedCount++;
                    console.log('✅ 成功添加保障解锁内容');
                }
            }
            
            // 显示结果
            if (unlockedCount > 0) {
                alert(`✅ 支付成功！已为您解锁 ${unlockedCount} 条处方详情。`);
                
                // 滚动到最新消息
                const container = document.getElementById('messagesContainer') || document.getElementById('chatMessages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
                
                console.log(`🎉 支付解锁成功！共解锁 ${unlockedCount} 条内容`);
            } else {
                // 这种情况理论上不应该发生，因为我们有方法3的保障
                console.warn('⚠️ 所有解锁方法都未成功，这是异常情况');
                alert('⚠️ 解锁过程中遇到异常，请刷新页面重试或联系客服。');
            }
        }

        // 评价问诊
        function rateConsultation() {
            const rating = prompt('请为本次问诊打分 (1-5星)：');
            if (rating && rating >= 1 && rating <= 5) {
                alert(`感谢您的${rating}星评价！您的反馈对我们很重要。`);
                // 这里可以发送评价到后端
            }
        }

        // 格式化AI回复内容
        function formatAIMessage(content) {
            // 处理markdown格式
            let formatted = content
                // 处理标题
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // 处理粗体
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // 处理重点标记
                .replace(/【(.*?)】/g, '<em>$1</em>')
                // 处理换行
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // 处理列表
                .replace(/^\- (.*$)/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>');
            
            // 包装段落
            if (!formatted.includes('<h1>') && !formatted.includes('<h2>') && !formatted.includes('<h3>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            // 处理列表包装
            formatted = formatted.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            return formatted;
        }

        // 检查是否包含完整处方内容
        function containsPrescriptionContent(text) {
            const prescriptionKeywords = [
                '处方如下', '方剂组成', '药物组成', '具体方药',
                '方解', '君药', '臣药', '佐药', '使药',
                '【君药】', '【臣药】', '【佐药】', '【使药】',
                '三、处方建议', '处方方案', '治疗方案', '用药方案'
            ];
            
            // 检查是否包含明确的处方关键词
            const hasExplicitPrescription = prescriptionKeywords.some(keyword => text.includes(keyword));
            
            // 检查是否包含具体的药物剂量（更严格的判断）
            const hasDosagePattern = /\d+[克g]\s*[，,]\s*/.test(text) || /[\u4e00-\u9fa5]+\s*\d+[克g]/.test(text);
            
            // 只有同时包含处方关键词和具体剂量才认为是完整处方
            return hasExplicitPrescription && hasDosagePattern;
        }

        // 检查是否为问诊中的临时建议
        function isTemporaryAdvice(text) {
            const temporaryKeywords = [
                '初步处方建议', '待确认', '若您能提供', '请补充', 
                '需要了解', '建议进一步', '完善信息后', '详细描述',
                '暂拟方药', '初步考虑', '待详诊后', '待补充',
                '补充舌象', '舌象信息后', '脉象信息后', '上传舌象',
                '提供舌象', '确认处方', '后确认', '暂拟处方'
            ];
            
            return temporaryKeywords.some(keyword => text.includes(keyword));
        }

        // 隐藏处方内容
        function maskPrescriptionContent(content) {
            // 如果是临时建议，不隐藏，允许继续问诊
            if (isTemporaryAdvice(content)) {
                console.log('🔄 检测到临时建议，继续问诊流程');
                return content;
            }
            
            // 只对完整处方进行隐藏处理
            if (!containsPrescriptionContent(content)) {
                return content;
            }
            
            console.log('💰 检测到完整处方，进入付费模式');
            
            // 找到处方开始位置 (包含君臣佐使相关内容)
            const prescriptionStart = content.search(/(?:处方如下|方剂组成|药物组成|具体方药|方解|君药|臣药|佐药|使药|三、处方建议|处方方案|治疗方案|用药方案|【君药】|【臣药】|【佐药】|【使药】)/);
            if (prescriptionStart === -1) return content;
            
            const beforePrescription = content.substring(0, prescriptionStart);
            const prescriptionPart = content.substring(prescriptionStart);
            
            const maskedPrescription = `
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; border-left: 4px solid #fbbf24; margin: 10px 0;">
                    <h3 style="color: #d97706; margin: 0 0 10px 0;">💰 处方详情 (需付费查看)</h3>
                    <p style="color: #6b7280; margin: 0;">
                        完整的中医处方和用药指导已生成，包含：<br>
                        • 详细方剂组成和剂量<br>
                        • 君臣佐使配伍分析<br>
                        • 服用方法和注意事项<br>
                        • 辨证加减建议
                    </p>
                    <div style="margin-top: 15px;">
                        <button onclick="handlePrescriptionPayment()" style="
                            background: #059669; color: white; border: none; padding: 10px 20px; 
                            border-radius: 6px; cursor: pointer; font-weight: 600;
                        ">💳 支付查看处方 (￥29.9)</button>
                        <button onclick="rateConsultation()" style="
                            background: #6b7280; color: white; border: none; padding: 10px 20px; 
                            border-radius: 6px; cursor: pointer; margin-left: 10px;
                        ">⭐ 评价服务</button>
                    </div>
                </div>
            `;
            
            return beforePrescription + maskedPrescription;
        }

        // 添加消息到对话
        function addMessage(sender, content, hidePrescription = false) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? '👤' : '🤖';
            
            let formattedContent = content;
            if (sender === 'ai') {
                formattedContent = formatAIMessage(content);
                // 如果包含处方内容且需要隐藏，则隐藏处方
                if (hidePrescription) {
                    // 保存原始内容到data属性中，用于支付后解锁
                    messageDiv.setAttribute('data-original-content', formattedContent);
                    formattedContent = maskPrescriptionContent(formattedContent);
                    messageDiv.classList.add('prescription-hidden');
                }
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${formattedContent}</div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // 更新步骤状态
        function updateStep(stepNumber) {
            // 更新当前步骤
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            currentStep = stepNumber;
        }

        // 更新进度信息
        function updateProgressInfo(stage, time, doctor) {
            document.getElementById('currentStage').textContent = stage;
            document.getElementById('estimatedTime').textContent = time;
            document.getElementById('recommendedCount').textContent = doctor;
        }

        // 自动调整输入框高度
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // 加载问诊历史
        function loadConsultationHistory() {
            // 从localStorage或API加载历史记录
            const history = JSON.parse(localStorage.getItem('consultationHistory') || '[]');
            const historyContainer = document.getElementById('consultationHistory');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<div class="history-item">暂无历史记录</div>';
                return;
            }
            
            historyContainer.innerHTML = history.map(item => `
                <div class="history-item">
                    <strong>${item.date}</strong><br>
                    症状：${item.symptoms}<br>
                    医生：${item.doctor}
                </div>
            `).join('');
        }
    </script>
</body>
</html>