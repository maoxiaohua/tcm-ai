<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ±‡ä¸­åŒ» - AIæ™ºèƒ½é—®è¯Š</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .main-container {
            width: 100%;
            max-width: 1200px;
            margin: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            min-height: 80vh;
        }
        
        .sidebar {
            width: 400px;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ç¡®ä¿å­å…ƒç´ ä¸ä¼šæ’‘å¼€sidebar */
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .workflow-steps {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: #667eea;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
        
        .step-number {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            margin-right: 8px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            /* ç¡®ä¿èŠå¤©å®¹å™¨æœ‰æ˜ç¡®çš„é«˜åº¦ */
            height: 100%;
            min-height: 500px; /* PCç«¯æœ€å°é«˜åº¦ */
        }
        
        /* æ¶ˆæ¯åŒºåŸŸ - å›ºå®šé«˜åº¦ï¼Œå†…å®¹å¯æ»šåŠ¨ */
        .messages-area {
            height: calc(100% - 80px); /* å›ºå®šé«˜åº¦ï¼šçˆ¶å®¹å™¨100%å‡å»è¾“å…¥æ¡†é«˜åº¦80px */
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px;
            padding-bottom: 20px;
            background: #fafafa;
            /* ç¡®ä¿æ»šåŠ¨è¡Œä¸ºå¹³æ»‘ */
            scroll-behavior: smooth;
            /* ä¿æŒæ»šåŠ¨æ¡ä½ç½® */
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
        }
        
        /* WebKitæ»šåŠ¨æ¡æ ·å¼ */
        .messages-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-area::-webkit-scrollbar-track {
            background: #f9fafb;
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        .messages-area::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            background: #667eea;
            color: white;
        }
        
        .message.user .message-avatar {
            background: #28a745;
        }
        
        .message-content {
            flex: 1;
            max-width: 70%;
        }
        
        .message-bubble {
            padding: 15px 20px;
            border-radius: 18px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        /* AIå›å¤æ ¼å¼åŒ–æ ·å¼ */
        .message-bubble h1, .message-bubble h2, .message-bubble h3 {
            color: #333;
            margin: 15px 0 10px 0;
            font-weight: 600;
        }
        
        .message-bubble h1 { font-size: 1.2em; }
        .message-bubble h2 { font-size: 1.1em; }
        .message-bubble h3 { font-size: 1.05em; }
        
        .message-bubble ul, .message-bubble ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .message-bubble li {
            margin: 5px 0;
        }
        
        .message-bubble p {
            margin: 8px 0;
        }
        
        .message-bubble strong {
            color: #2563eb;
            font-weight: 600;
        }
        
        .message-bubble em {
            background: #fef3c7;
            padding: 1px 4px;
            border-radius: 3px;
            font-style: normal;
        }
        
        .message.user .message-bubble {
            background: #667eea;
            color: white;
            text-align: right;
        }
        
        /* å›ºå®šåº•éƒ¨è¾“å…¥åŒºåŸŸ - ç›¸å¯¹äºchat-containerå®šä½ */
        .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 20px 30px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 10; /* ç¡®ä¿è¾“å…¥æ¡†åœ¨æœ€ä¸Šå±‚ */
            /* é˜²æ­¢è¾“å…¥æ³•é®æŒ¡ */
            min-height: 80px;
            /* ç¡®ä¿è¾“å…¥æ¡†ä¸ä¼šè¢«å†…å®¹æ¨å‡ºè§†é‡ */
            height: 80px; /* å›ºå®šè¾“å…¥åŒºåŸŸé«˜åº¦ */
        }
        
        .input-container {
            flex: 1;
            position: relative;
        }
        
        #messageInput {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        #messageInput:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .sidebar-section {
            margin-bottom: 30px;
        }
        
        /* åŒ»ç”Ÿæ¨èåŒºåŸŸ - é™åˆ¶é«˜åº¦ï¼Œæ·»åŠ æ»šåŠ¨ */
        .doctor-recommendations {
            display: none; /* åˆå§‹éšè— */
            flex-direction: column;
            min-height: 0; /* é‡è¦ï¼šå…è®¸flexå­é¡¹ç¼©å° */
        }
        
        .doctor-recommendations.show {
            display: flex; /* æ˜¾ç¤ºæ—¶ä½¿ç”¨flexå¸ƒå±€ */
        }
        
        #doctorList {
            flex: 1;
            overflow-y: auto;
            max-height: 400px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            padding-right: 10px; /* ä¸ºæ»šåŠ¨æ¡é¢„ç•™ç©ºé—´ */
            /* æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
        }
        
        #doctorList::-webkit-scrollbar {
            width: 6px;
        }
        
        #doctorList::-webkit-scrollbar-track {
            background: #f9fafb;
            border-radius: 3px;
        }
        
        #doctorList::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        #doctorList::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        .sidebar-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        
        .doctor-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .doctor-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .doctor-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .doctor-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .doctor-info h4 {
            margin-bottom: 2px;
            color: #333;
        }
        
        .doctor-rating {
            color: #ffc107;
            font-size: 0.9em;
        }
        
        .doctor-specialties {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .consultation-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
            font-size: 0.9em;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .symptom-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .symptom-tag {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                margin: 10px;
                min-height: 95vh;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                max-height: 40vh;
                overflow-y: auto;
            }
            
            .workflow-steps {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .step {
                margin: 5px;
            }
            
            /* ç§»åŠ¨ç«¯è¾“å…¥åŒºåŸŸä¼˜åŒ– */
            .input-area {
                padding: 15px 20px;
                padding-bottom: calc(15px + env(safe-area-inset-bottom));
            }
            
            .messages-area {
                padding: 20px;
                padding-bottom: 20px;
                font-size: 0.8em;
                /* ç§»åŠ¨ç«¯ä½¿ç”¨è§†å£é«˜åº¦è®¡ç®— */
                height: calc(100vh - 250px); /* ä¸ºç§»åŠ¨ç«¯UIå…ƒç´ é¢„ç•™æ›´å¤šç©ºé—´ */
            }
            
            .input-area {
                height: 70px; /* ç§»åŠ¨ç«¯è¾“å…¥æ¡†ç¨å¾®å°ä¸€äº› */
                padding: 15px 20px;
            }
            
            /* ç§»åŠ¨ç«¯åŒ»ç”Ÿåˆ—è¡¨ä¼˜åŒ– */
            #doctorList {
                max-height: 200px; /* ç§»åŠ¨ç«¯å‡å°é«˜åº¦ */
            }
        }
        
        /* æ”¯ä»˜æ¨¡æ€æ¡†æ ·å¼ */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }
        
        .payment-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .payment-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .payment-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0 8px;
        }
        
        .close-modal:hover {
            color: #666;
        }
        
        .payment-details {
            margin-bottom: 20px;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .price {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .payment-description {
            font-size: 0.9em;
            color: #666;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .payment-methods {
            margin-bottom: 20px;
        }
        
        .payment-methods h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .payment-options {
            display: flex;
            gap: 10px;
        }
        
        .payment-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-btn:hover {
            border-color: #4CAF50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }
        
        .payment-btn.wechat:hover {
            border-color: #07c160;
            box-shadow: 0 2px 8px rgba(7, 193, 96, 0.2);
        }
        
        .payment-btn.alipay:hover {
            border-color: #1677ff;
            box-shadow: 0 2px 8px rgba(22, 119, 255, 0.2);
        }
        
        .payment-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .payment-notice {
            text-align: center;
            font-size: 0.85em;
            color: #f39c12;
            background: #fef9e7;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #f39c12;
        }
        
        .payment-notice p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <!-- è¿›åº¦ä¿¡æ¯ -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">ğŸ“‹ é—®è¯Šè¿›åº¦</h3>
                <div class="progress-info">
                    <div><strong>å½“å‰é˜¶æ®µï¼š</strong><span id="currentStage">ç—‡çŠ¶æ”¶é›†</span></div>
                    <div><strong>é¢„è®¡æ—¶é—´ï¼š</strong><span id="estimatedTime">2-3åˆ†é’Ÿ</span></div>
                    <div><strong>æ¨èåŒ»ç”Ÿï¼š</strong><span id="recommendedCount">å¾…æ¨è</span></div>
                </div>
            </div>
            
            <!-- åŒ»ç”Ÿæ¨è -->
            <div class="sidebar-section doctor-recommendations" id="doctorRecommendations">
                <h3 class="sidebar-title">ğŸ‘¨â€âš•ï¸ æ¨èåŒ»ç”Ÿ</h3>
                <div id="doctorList">
                    <!-- æ¨èåŒ»ç”Ÿåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- é—®è¯Šå†å² -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">ğŸ•’ æœ€è¿‘é—®è¯Š</h3>
                <div class="consultation-history" id="consultationHistory">
                    <div class="history-item">æš‚æ— å†å²è®°å½•</div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <h1>ğŸ¥ æ™ºæ±‡ä¸­åŒ»</h1>
                <p>AIæ™ºèƒ½é—®è¯Š Â· ä¸ªæ€§åŒ–åŒ»ç”Ÿæ¨è</p>
            </div>
            
            <!-- å·¥ä½œæµç¨‹æ­¥éª¤ -->
            <div class="workflow-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    ç—‡çŠ¶æè¿°
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    åŒ»ç”Ÿæ¨è
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    AIé—®è¯Š
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    å¤„æ–¹ç¡®è®¤
                </div>
            </div>

            <!-- å¯¹è¯åŒºåŸŸ -->
            <div class="chat-container">
                <div class="messages-area" id="messagesContainer">
                    <div class="message">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                <strong>æ¬¢è¿ä½¿ç”¨æ™ºæ±‡ä¸­åŒ»AIé—®è¯Šç³»ç»Ÿï¼</strong><br><br>
                                æˆ‘å°†æ ¹æ®æ‚¨çš„ç—‡çŠ¶ä¸ºæ‚¨æ¨èæœ€åˆé€‚çš„åŒ»ç”Ÿï¼Œç„¶åè¿›è¡Œä¸“ä¸šçš„AIä¸­åŒ»é—®è¯Šã€‚<br><br>
                                è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ï¼ŒåŒ…æ‹¬ï¼š<br>
                                â€¢ ä¸»è¦ä¸é€‚ç—‡çŠ¶<br>
                                â€¢ æŒç»­æ—¶é—´<br>
                                â€¢ ä¸¥é‡ç¨‹åº¦<br>
                                â€¢ å…¶ä»–ä¼´éšç—‡çŠ¶
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            id="messageInput" 
                            placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶..."
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        â¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentStep = 1;
        let selectedDoctorId = null;
        let patientId = 'patient-' + Date.now();
        let conversationId = null;
        let collectedSymptoms = [];
        let recommendedDoctors = [];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
            loadConsultationHistory();
        });

        // åˆå§‹åŒ–å¯¹è¯
        function initializeChat() {
            conversationId = 'conv-' + Date.now();
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', adjustTextareaHeight);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = messageInput.value.trim();
            
            if (!message) return;

            // ç¦ç”¨å‘é€æŒ‰é’®
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            messageInput.value = '';
            adjustTextareaHeight();

            try {
                if (currentStep === 1) {
                    // ç¬¬ä¸€æ­¥ï¼šç—‡çŠ¶æ”¶é›†å’ŒåŒ»ç”Ÿæ¨è
                    await handleSymptomCollection(message);
                } else if (currentStep === 3) {
                    // ç¬¬ä¸‰æ­¥ï¼šAIé—®è¯Š
                    await handleAIConsultation(message);
                }
            } catch (error) {
                console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
                addMessage('ai', 'æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶æ— æ³•å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }

            // æ¢å¤å‘é€æŒ‰é’®
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'â¤';
        }

        // å¤„ç†ç—‡çŠ¶æ”¶é›†
        async function handleSymptomCollection(message) {
            // æ£€æµ‹æ˜¯å¦ä¸ºé‡æ–°è¾“å…¥ç—‡çŠ¶ï¼ˆå¦‚æœå·²æœ‰åŒ»ç”Ÿæ¨èåˆ™è¯´æ˜æ˜¯é‡æ–°è¾“å…¥ï¼‰
            const isReInput = recommendedDoctors.length > 0;
            
            if (isReInput) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°é‡æ–°è¾“å…¥ç—‡çŠ¶ï¼Œé‡ç½®ç³»ç»ŸçŠ¶æ€...');
                // é‡ç½®çŠ¶æ€
                recommendedDoctors = [];
                selectedDoctorId = null;
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„åŒ»ç”Ÿæ¨èåŒºåŸŸ
                const doctorArea = document.getElementById('doctorRecommendationArea');
                if (doctorArea) {
                    doctorArea.innerHTML = '';
                }
                // æ·»åŠ é‡æ–°åˆ†ææç¤º
                addMessage('ai', 'æˆ‘ç†è§£æ‚¨è¦é‡æ–°æè¿°ç—‡çŠ¶ï¼Œè®©æˆ‘é‡æ–°ä¸ºæ‚¨åˆ†æå’Œæ¨èåŒ»ç”Ÿ...');
            }
            
            // è§£æç—‡çŠ¶
            collectedSymptoms = parseSymptoms(message);
            
            // æ˜¾ç¤ºAIç¡®è®¤æ¶ˆæ¯
            addMessage('ai', `æˆ‘ç†è§£æ‚¨çš„ä¸»è¦ç—‡çŠ¶æ˜¯ï¼š${collectedSymptoms.join('ã€')}ã€‚ç°åœ¨ä¸ºæ‚¨æ¨èæœ€é€‚åˆçš„ä¸­åŒ»ä¸“å®¶...`);
            
            // è°ƒç”¨åŒ»ç”Ÿæ¨èAPI
            try {
                const response = await fetch('/api/doctor-matching/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId,
                        symptoms: collectedSymptoms,
                        max_results: 3
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.recommended_doctors.length > 0) {
                    recommendedDoctors = data.data.recommended_doctors;
                    displayRecommendedDoctors(recommendedDoctors);
                    updateStep(2);
                    
                    addMessage('ai', 
                        `æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘ä¸ºæ‚¨æ¨èäº† ${recommendedDoctors.length} ä½ä¸“ä¸šåŒ»ç”Ÿã€‚` +
                        `è¯·åœ¨å³ä¾§é€‰æ‹©æ‚¨åå¥½çš„åŒ»ç”Ÿï¼Œç„¶åç‚¹å‡»"å¼€å§‹AIé—®è¯Š"ç»§ç»­ã€‚`
                    );
                } else {
                    // æ²¡æœ‰æ¨èåŒ»ç”Ÿï¼Œä½¿ç”¨é»˜è®¤åŒ»ç”Ÿ
                    await loadDefaultDoctors();
                }
            } catch (error) {
                console.error('è·å–åŒ»ç”Ÿæ¨èå¤±è´¥:', error);
                await loadDefaultDoctors();
            }
        }

        // æ˜¾ç¤ºæ¨èåŒ»ç”Ÿ
        function displayRecommendedDoctors(doctors) {
            const doctorRecommendations = document.getElementById('doctorRecommendations');
            const doctorList = document.getElementById('doctorList');
            
            doctorList.innerHTML = '';
            
            doctors.forEach(doctor => {
                const doctorCard = document.createElement('div');
                doctorCard.className = 'doctor-card';
                doctorCard.onclick = () => selectDoctor(doctor.uuid);
                
                doctorCard.innerHTML = `
                    <div class="doctor-header">
                        <div class="doctor-avatar">${doctor.name[0]}</div>
                        <div class="doctor-info">
                            <h4>${doctor.name}</h4>
                            <div class="doctor-rating">${'â­'.repeat(Math.floor(doctor.average_rating))} ${doctor.average_rating.toFixed(1)}</div>
                        </div>
                    </div>
                    <div class="doctor-specialties">æ“…é•¿ï¼š${doctor.specialties.join('ã€')}</div>
                    <div class="symptom-tags">
                        ${collectedSymptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('')}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="selectDoctorAndStart('${doctor.uuid}')">é€‰æ‹©å¹¶é—®è¯Š</button>
                    </div>
                `;
                
                doctorList.appendChild(doctorCard);
            });
            
            doctorRecommendations.classList.add('show');
            
            // æ›´æ–°è¿›åº¦ä¿¡æ¯
            updateProgressInfo('åŒ»ç”Ÿæ¨è', '1-2åˆ†é’Ÿ', `${doctors.length}ä½åŒ»ç”Ÿ`);
        }

        // åŠ è½½é»˜è®¤åŒ»ç”Ÿï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        async function loadDefaultDoctors() {
            const defaultDoctors = [
                {
                    uuid: '1',
                    name: 'å¼ ä»²æ™¯',
                    specialties: ['å†…ç§‘', 'ä¼¤å¯’æ‚ç—…'],
                    average_rating: 4.8,
                    total_reviews: 156,
                    introduction: 'åŒ»åœ£å¼ ä»²æ™¯ï¼Œæ“…é•¿ä¼¤å¯’æ‚ç—…ç†è®º'
                },
                {
                    uuid: '2', 
                    name: 'å¶å¤©å£«',
                    specialties: ['æ¸©ç—…', 'å†…ç§‘'],
                    average_rating: 4.9,
                    total_reviews: 203,
                    introduction: 'æ¸©ç—…å­¦æ´¾åˆ›å§‹äººï¼Œæ“…é•¿æ¸©ç—…æ²»ç–—'
                },
                {
                    uuid: '3',
                    name: 'æä¸œå£',
                    specialties: ['è„¾èƒƒ', 'å†…ç§‘'],
                    average_rating: 4.7,
                    total_reviews: 178,
                    introduction: 'è„¾èƒƒå­¦æ´¾åˆ›å§‹äººï¼Œæ“…é•¿è„¾èƒƒç–¾ç—…'
                }
            ];
            
            displayRecommendedDoctors(defaultDoctors);
            updateStep(2);
            
            addMessage('ai', 
                `æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘ä¸ºæ‚¨æ¨èäº†3ä½ç»éªŒä¸°å¯Œçš„ä¸­åŒ»ä¸“å®¶ã€‚` +
                `è¯·é€‰æ‹©æ‚¨åå¥½çš„åŒ»ç”Ÿå¼€å§‹è¯¦ç»†é—®è¯Šã€‚`
            );
        }

        // é€‰æ‹©åŒ»ç”Ÿ
        function selectDoctor(doctorId) {
            selectedDoctorId = doctorId;
            
            // æ›´æ–°UIæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // åŒ»ç”ŸIDæ˜ å°„è¡¨ - å°†æ•°æ®åº“IDæ˜ å°„ä¸ºåŒ»ç”Ÿè‹±æ–‡åç§°
        const doctorIdMapping = {
            '1': 'zhang_zhongjing',
            '2': 'ye_tianshi', 
            '3': 'li_dongyuan',
            '4': 'zhu_danxi',
            '5': 'liu_duzhou',
            '6': 'zheng_qin_an',
            '8': 'zhang_zhongjing', // å¼ åŒ»ç”Ÿ -> å¼ ä»²æ™¯
            '9': 'ye_tianshi'       // æåŒ»ç”Ÿ -> å¶å¤©å£« (å¦‡ç§‘ä¸“é•¿ï¼Œä½¿ç”¨å¶å¤©å£«)
        };

        // é€‰æ‹©åŒ»ç”Ÿå¹¶å¼€å§‹é—®è¯Š
        function selectDoctorAndStart(doctorId) {
            selectDoctor(doctorId);
            startAIConsultation();
        }

        // å¼€å§‹AIé—®è¯Š
        function startAIConsultation() {
            if (!selectedDoctorId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä½åŒ»ç”Ÿ');
                return;
            }
            
            const selectedDoctor = recommendedDoctors.find(d => d.uuid === selectedDoctorId) || 
                                  {name: 'ä¸­åŒ»ä¸“å®¶', specialties: ['ç»¼åˆ']};
            
            updateStep(3);
            
            // è·å–æ˜ å°„åçš„åŒ»ç”Ÿåç§°ç”¨äºæ˜¾ç¤º
            const mappedDoctorName = doctorIdMapping[selectedDoctorId] || 'zhang_zhongjing';
            const doctorSchools = {
                'zhang_zhongjing': 'ä¼¤å¯’æ´¾',
                'ye_tianshi': 'æ¸©ç—…æ´¾',
                'li_dongyuan': 'è„¾èƒƒæ´¾', 
                'zhu_danxi': 'æ»‹é˜´æ´¾',
                'liu_duzhou': 'ç»æ–¹æ´¾',
                'zheng_qin_an': 'æ‰¶é˜³æ´¾'
            };
            const doctorSchool = doctorSchools[mappedDoctorName] || 'ä¸­åŒ»';
            
            addMessage('ai', 
                `æ‚¨é€‰æ‹©äº†${selectedDoctor.name}åŒ»ç”Ÿï¼ˆ${doctorSchool}ï¼‰ï¼Œç°åœ¨å°†ä»¥${doctorSchool}çš„è¾¨è¯æ€ç»´ä¸ºæ‚¨è¿›è¡Œä¸“ä¸šä¸­åŒ»é—®è¯Šã€‚` +
                `è¯·å¦‚å®å›ç­”ä»¥ä¸‹é—®é¢˜ï¼Œæˆ‘å°†æ ¹æ®ä¸­åŒ»å››è¯Šåˆå‚çš„åŸç†ä¸ºæ‚¨è¯¦ç»†åˆ†æã€‚`
            );
            
            // æ›´æ–°è¿›åº¦ä¿¡æ¯
            updateProgressInfo('AIé—®è¯Šä¸­', '3-5åˆ†é’Ÿ', selectedDoctor.name);
            
            // å¼€å§‹ç¬¬ä¸€ä¸ªé—®è¯Šé—®é¢˜ - ä½¿ç”¨åŒ»ç”Ÿäººæ ¼åŒ–çš„å¼€åœº
            setTimeout(() => {
                // æ ¹æ®é€‰æ‹©çš„åŒ»ç”Ÿå‘é€ä¸åŒçš„å¼€åœºé—®å€™
                const doctorName = doctorIdMapping[selectedDoctorId] || 'zhang_zhongjing';
                let greeting = '';
                
                switch(doctorName) {
                    case 'zhang_zhongjing':
                        greeting = 'æˆ‘å°†è¿ç”¨ä¼¤å¯’å…­ç»è¾¨è¯çš„æ–¹æ³•ä¸ºæ‚¨è¯¦ç»†é—®è¯Šã€‚è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿæœ‰æ— å¯’çƒ­è¡¨ç°ï¼Ÿ';
                        break;
                    case 'ye_tianshi':
                        greeting = 'æˆ‘å°†æ ¹æ®æ¸©ç—…ç†è®ºä¸ºæ‚¨è¾¨è¯è®ºæ²»ã€‚è¯·æè¿°æ‚¨ç—‡çŠ¶çš„èµ·å§‹ã€å‘å±•è¿‡ç¨‹ï¼Œä»¥åŠå½“å‰çš„ä¸»è¦ä¸é€‚ï¼Ÿ';
                        break;
                    case 'li_dongyuan':
                        greeting = 'æˆ‘å°†ä»è„¾èƒƒè°ƒç†çš„è§’åº¦ä¸ºæ‚¨è¯Šæ²»ã€‚è¯·è¯¦è¿°ç—‡çŠ¶åŠé¥®é£Ÿã€æ¶ˆåŒ–çŠ¶å†µå¦‚ä½•ï¼Ÿ';
                        break;
                    default:
                        greeting = 'è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿç—‡çŠ¶åœ¨ä¸€å¤©ä¸­ä»€ä¹ˆæ—¶å€™æœ€ä¸¥é‡ï¼Ÿ';
                }
                
                addMessage('ai', greeting);
            }, 1000);
        }

        // å¤„ç†AIé—®è¯Šå¯¹è¯
        async function handleAIConsultation(message) {
            try {
                // å°†æ•°å­—IDæ˜ å°„ä¸ºåŒ»ç”Ÿè‹±æ–‡åç§°
                const mappedDoctorName = doctorIdMapping[selectedDoctorId] || 'zhang_zhongjing';
                
                console.log(`ğŸ”„ ç»Ÿä¸€é—®è¯ŠæœåŠ¡è°ƒç”¨: é€‰æ‹©åŒ»ç”ŸID=${selectedDoctorId}, æ˜ å°„åç§°=${mappedDoctorName}`);
                
                // æ”¶é›†å½“å‰å¯¹è¯å†å²
                const currentHistory = getCurrentConversationHistory();
                
                const response = await fetch('/api/consultation/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conversationId,
                        selected_doctor: mappedDoctorName,
                        patient_id: patientId,
                        has_images: false,  // æš‚æ—¶ä¸æ”¯æŒå›¾ç‰‡
                        conversation_history: currentHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const reply = data.reply;
                    let needsPayment = false;
                    
                    console.log(`âœ… é—®è¯ŠæˆåŠŸ: é˜¶æ®µ=${data.stage}, åŒ…å«å¤„æ–¹=${data.contains_prescription}`);
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä»˜è´¹æ‰èƒ½æŸ¥çœ‹å¤„æ–¹
                    if (data.stage === 'prescription' && data.contains_prescription) {
                        needsPayment = true;
                    } else if (containsPrescriptionContent(reply) && !isTemporaryAdvice(reply)) {
                        needsPayment = true;
                    }
                    
                    // æ·»åŠ AIæ¶ˆæ¯ï¼Œæ ¹æ®æ˜¯å¦éœ€è¦æ”¯ä»˜æ¥å†³å®šæ˜¯å¦éšè—å¤„æ–¹
                    addMessage('ai', reply, needsPayment);
                    
                    // æ›´æ™ºèƒ½çš„é—®è¯ŠçŠ¶æ€åˆ¤æ–­
                    if (data.stage === 'prescription' && data.contains_prescription) {
                        // åç«¯æ˜ç¡®æ ‡è¯†ä¸ºå¤„æ–¹é˜¶æ®µ
                        updateStep(4);
                        updateProgressInfo('å¤„æ–¹ç¡®è®¤', 'å®Œæˆ', 'è¯·ç¡®è®¤å¤„æ–¹');
                        showPrescriptionOptions();
                    } else if (containsPrescriptionContent(data.reply) && !isTemporaryAdvice(data.reply)) {
                        // å‰ç«¯æ£€æµ‹åˆ°å®Œæ•´å¤„æ–¹ï¼ˆéä¸´æ—¶å»ºè®®ï¼‰
                        updateStep(4);
                        updateProgressInfo('å¤„æ–¹ç¡®è®¤', 'å®Œæˆ', 'è¯·ç¡®è®¤å¤„æ–¹');
                        showPrescriptionOptions();
                    } else if (isTemporaryAdvice(data.reply)) {
                        // ä¸´æ—¶å»ºè®®ï¼Œç»§ç»­é—®è¯Š
                        console.log('ğŸ”„ ä¸´æ—¶å»ºè®®é˜¶æ®µï¼Œç»§ç»­é—®è¯Š');
                        updateProgressInfo('æ·±å…¥é—®è¯Š', 'ç»§ç»­ä¸­', 'åŒ»ç”Ÿéœ€è¦æ›´å¤šä¿¡æ¯');
                    } else {
                        // æ™®é€šé—®è¯Šé˜¶æ®µ
                        updateProgressInfo('AIé—®è¯Šä¸­', 'è¿›è¡Œä¸­', 'è¯¦ç»†äº†è§£ç—‡çŠ¶');
                    }
                } else {
                    // å¤„ç†é”™è¯¯å“åº”
                    addMessage('ai', result.data.reply || 'æŠ±æ­‰ï¼ŒAIåŒ»ç”Ÿæš‚æ—¶æ— æ³•å›åº”ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                }
            } catch (error) {
                console.error('AIé—®è¯Šå¤±è´¥:', error);
                addMessage('ai', 'æŠ±æ­‰ï¼ŒAIåŒ»ç”Ÿæš‚æ—¶æ— æ³•å›åº”ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }

        // è·å–å½“å‰å¯¹è¯å†å²
        function getCurrentConversationHistory() {
            const history = [];
            const messages = document.querySelectorAll('.message');
            
            messages.forEach(msg => {
                const isUser = msg.classList.contains('user');
                const content = msg.querySelector('.message-bubble').textContent.trim();
                
                // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯å’Œç©ºæ¶ˆæ¯
                if (content && !content.startsWith('âš¡') && !content.startsWith('ğŸ‰')) {
                    history.push({
                        role: isUser ? 'user' : 'assistant',
                        content: content
                    });
                }
            });
            
            return history;
        }

        // è§£æç—‡çŠ¶
        function parseSymptoms(text) {
            console.log('ğŸ” è§£æç—‡çŠ¶è¾“å…¥:', text);
            
            // æ‰©å±•çš„ç—‡çŠ¶è¯å…¸ - æŒ‰ä¸“ç§‘åˆ†ç±»
            const symptomMapping = {
                // å†…ç§‘å¸¸è§ç—‡çŠ¶
                'å¤´ç—›': ['å¤´ç—›', 'å¤´ç–¼'],
                'å¤±çœ ': ['å¤±çœ ', 'ç¡ä¸ç€', 'å…¥ç¡å›°éš¾', 'å¤šæ¢¦'],
                'èƒƒç—›': ['èƒƒç—›', 'èƒƒç–¼', 'èƒƒä¸èˆ’æœ'],
                'ä¾¿ç§˜': ['ä¾¿ç§˜', 'æ’ä¾¿å›°éš¾', 'å¤§ä¾¿å¹²'],
                'è…¹æ³»': ['è…¹æ³»', 'æ‹‰è‚šå­', 'å¤§ä¾¿ç¨€'],
                'å’³å—½': ['å’³å—½', 'å’³ç—°'],
                'å‘çƒ­': ['å‘çƒ­', 'å‘çƒ§', 'ä½“æ¸©é«˜'],
                'ä¹åŠ›': ['ä¹åŠ›', 'ç–²åŠ³', 'æ²¡åŠ›æ°”', 'ç–²å€¦'],
                'å¿ƒæ‚¸': ['å¿ƒæ‚¸', 'å¿ƒæ…Œ', 'å¿ƒè·³å¿«'],
                'çœ©æ™•': ['çœ©æ™•', 'å¤´æ™•', 'æ™•'],
                'è…°ç—›': ['è…°ç—›', 'è…°é…¸', 'è…°ç–¼'],
                
                // å¦‡ç§‘ç—‡çŠ¶
                'æœˆç»ä¸è°ƒ': ['æœˆç»ä¸è°ƒ', 'æœˆç»å¼‚å¸¸', 'ä¾‹å‡ä¸å‡†', 'ç»æœŸä¸å‡†'],
                'ç—›ç»': ['ç—›ç»', 'ç»ç—›', 'ä¾‹å‡ç—›'],
                'ç™½å¸¦å¼‚å¸¸': ['ç™½å¸¦å¼‚å¸¸', 'ç™½å¸¦å¤š', 'ç™½å¸¦é»„'],
                'ä¸å­•': ['ä¸å­•', 'æ€€ä¸ä¸Š', 'å¤‡å­•'],
                'æ›´å¹´æœŸ': ['æ›´å¹´æœŸ', 'ç»ç»', 'æ½®çƒ­'],
                'å¦‡ç§‘ç–¾ç—…': ['å¦‡ç§‘ç–¾ç—…', 'å¦‡ç§‘é—®é¢˜', 'å¦‡ç§‘', 'å¥³æ€§ç–¾ç—…'],
                
                // å„¿ç§‘ç—‡çŠ¶
                'å°å„¿å‘çƒ­': ['å°å„¿å‘çƒ­', 'å­©å­å‘çƒ§', 'å®å®å‘çƒ§'],
                'å°å„¿å’³å—½': ['å°å„¿å’³å—½', 'å­©å­å’³å—½', 'å®å®å’³å—½'],
                'å°å„¿è…¹æ³»': ['å°å„¿è…¹æ³»', 'å­©å­æ‹‰è‚šå­', 'å®å®è…¹æ³»'],
                'å„¿ç§‘ç–¾ç—…': ['å„¿ç§‘ç–¾ç—…', 'å„¿ç§‘', 'å°å„¿ç–¾ç—…', 'å­©å­ç”Ÿç—…'],
                
                // çš®è‚¤ç§‘ç—‡çŠ¶
                'æ¹¿ç–¹': ['æ¹¿ç–¹', 'çš®è‚¤æ¹¿ç–¹'],
                'ç—¤ç–®': ['ç—¤ç–®', 'é’æ˜¥ç—˜', 'ç—˜ç—˜'],
                'çš®è‚¤ç—…': ['çš®è‚¤ç—…', 'çš®è‚¤ç–¾ç—…', 'çš®è‚¤é—®é¢˜'],
                
                // éª¨ç§‘ç—‡çŠ¶
                'å…³èŠ‚ç—›': ['å…³èŠ‚ç—›', 'å…³èŠ‚ç–¼', 'è†ç›–ç—›'],
                'é¢ˆæ¤ç—…': ['é¢ˆæ¤ç—…', 'è„–å­ç—›', 'é¢ˆç—›'],
                'éª¨ç§‘ç–¾ç—…': ['éª¨ç§‘ç–¾ç—…', 'éª¨ç§‘', 'ç­‹éª¨ç–¼ç—›'],
                
                // å‘¼å¸ç§‘ç—‡çŠ¶
                'å“®å–˜': ['å“®å–˜', 'æ°”å–˜'],
                'é¼»ç‚': ['é¼»ç‚', 'é¼»å¡', 'æµé¼»æ¶•'],
                
                // æ¶ˆåŒ–ç§‘ç—‡çŠ¶
                'èƒƒç‚': ['èƒƒç‚', 'æ…¢æ€§èƒƒç‚'],
                'é£Ÿæ¬²ä¸æŒ¯': ['é£Ÿæ¬²ä¸æŒ¯', 'ä¸æƒ³åƒé¥­', 'æ²¡èƒƒå£']
            };
            
            const found = [];
            
            // éå†ç—‡çŠ¶æ˜ å°„ï¼ŒæŸ¥æ‰¾åŒ¹é…çš„ç—‡çŠ¶
            for (const [standardSymptom, variants] of Object.entries(symptomMapping)) {
                for (const variant of variants) {
                    if (text.includes(variant)) {
                        if (!found.includes(standardSymptom)) {
                            found.push(standardSymptom);
                        }
                        break; // æ‰¾åˆ°ä¸€ä¸ªå˜ä½“å°±è·³å‡ºå†…å±‚å¾ªç¯
                    }
                }
            }
            
            console.log('âœ… è¯†åˆ«åˆ°çš„ç—‡çŠ¶:', found);
            
            // å¦‚æœæ²¡æ‰¾åˆ°é¢„å®šä¹‰ç—‡çŠ¶ï¼Œä»ç”¨æˆ·è¾“å…¥ä¸­æå–å…³é”®è¯
            if (found.length === 0) {
                console.log('âš ï¸ æœªè¯†åˆ«åˆ°é¢„å®šä¹‰ç—‡çŠ¶ï¼Œæå–å…³é”®è¯...');
                const words = text.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰]/g, ' ')
                                 .split(' ')
                                 .filter(w => w.length > 1 && !['æˆ‘', 'æœ‰', 'æ˜¯', 'çš„', 'äº†', 'åœ¨', 'å’Œ', 'æˆ–'].includes(w));
                found.push(...words.slice(0, 3));
                console.log('ğŸ“ æå–çš„å…³é”®è¯:', found);
            }
            
            return found;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤„æ–¹
        function containsPrescription(text) {
            const prescriptionKeywords = ['å¤„æ–¹', 'æ–¹å‰‚', 'è¯æ–¹', 'ä¸­è¯', 'æœç”¨', 'ç…æœ', 'å…‹', 'g'];
            return prescriptionKeywords.some(keyword => text.includes(keyword));
        }

        // æ˜¾ç¤ºå¤„æ–¹é€‰é¡¹
        function showPrescriptionOptions() {
            const optionsHtml = `
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="viewPrescription()">æŸ¥çœ‹å¤„æ–¹è¯¦æƒ…</button>
                    <button class="btn btn-secondary" onclick="rateConsultation()">è¯„ä»·æœåŠ¡</button>
                </div>
            `;
            
            addMessage('ai', 
                'é—®è¯Šå®Œæˆï¼æˆ‘å·²ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–çš„ä¸­åŒ»å¤„æ–¹ã€‚' +
                optionsHtml
            );
        }

        // å¤„æ–¹æ”¯ä»˜å¤„ç†
        function handlePrescriptionPayment() {
            // æ˜¾ç¤ºæ”¯ä»˜é€‰æ‹©ç•Œé¢
            const paymentOptions = `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 400px; margin: 20px auto;">
                    <h3 style="color: #333; margin-bottom: 15px; text-align: center;">ğŸ’³ å¤„æ–¹æ”¯ä»˜</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #666; font-size: 14px;">
                            <strong>å¤„æ–¹è´¹ç”¨:</strong> ï¿¥29.9<br>
                            <strong>åŒ…å«å†…å®¹:</strong> å®Œæ•´ä¸­åŒ»å¤„æ–¹ã€ç”¨è¯æŒ‡å¯¼ã€æ³¨æ„äº‹é¡¹
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="processPayment('wechat')" style="
                            background: #07c160; color: white; border: none; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px;
                        ">ğŸ­ å¾®ä¿¡æ”¯ä»˜</button>
                        <button onclick="processPayment('alipay')" style="
                            background: #1677ff; color: white; border: none; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px;
                        ">ğŸ’³ æ”¯ä»˜å®</button>
                        <button onclick="closePaymentDialog()" style="
                            background: #6b7280; color: white; border: none; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px;
                        ">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'paymentModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; 
                display: flex; align-items: center; justify-content: center;
            `;
            modal.innerHTML = paymentOptions;
            
            document.body.appendChild(modal);
        }
        
        // å¤„ç†æ”¯ä»˜
        async function processPayment(method) {
            const paymentModal = document.getElementById('paymentModal');
            
            try {
                // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
                paymentModal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <div class="spinner" style="margin: 0 auto 15px;"></div>
                        <p>æ­£åœ¨å¤„ç†æ”¯ä»˜...</p>
                    </div>
                `;
                
                // æ¨¡æ‹Ÿæ”¯ä»˜APIè°ƒç”¨
                const response = await fetch('/api/payments/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: 29.9,
                        method: method,
                        consultation_id: conversationId,
                        patient_id: patientId,
                        item_type: 'prescription'
                    })
                });
                
                // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼ˆå®é™…éœ€è¦çœŸå®æ”¯ä»˜é›†æˆï¼‰
                setTimeout(() => {
                    paymentModal.remove();
                    addMessage('system', 'ğŸ‰ æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨ä¸ºæ‚¨å±•ç¤ºå®Œæ•´å¤„æ–¹è¯¦æƒ…...');
                    setTimeout(showFullPrescription, 1500);
                }, 2000);
                
            } catch (error) {
                console.error('æ”¯ä»˜å¤„ç†å¤±è´¥:', error);
                paymentModal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <p style="color: #dc2626;">æ”¯ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                        <button onclick="closePaymentDialog()" style="
                            background: #6b7280; color: white; border: none; padding: 10px 20px; 
                            border-radius: 6px; cursor: pointer; margin-top: 15px;
                        ">å…³é—­</button>
                    </div>
                `;
            }
        }
        
        // å…³é—­æ”¯ä»˜å¯¹è¯æ¡†
        function closePaymentDialog() {
            const modal = document.getElementById('paymentModal');
            if (modal) modal.remove();
        }

        // æ˜¾ç¤ºå®Œæ•´å¤„æ–¹
        function showFullPrescription() {
            // æ‰¾åˆ°æœ€åä¸€æ¡åŒ…å«å¤„æ–¹çš„AIæ¶ˆæ¯
            const messages = document.querySelectorAll('.message.ai');
            const lastAIMessage = messages[messages.length - 1];
            
            if (lastAIMessage) {
                // æ ‡è®°ä¸ºå·²æ”¯ä»˜ï¼Œé‡æ–°è°ƒç”¨AIè·å–å®Œæ•´å¤„æ–¹
                addMessage('system', 'âš¡ æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨ä¸ºæ‚¨å±•ç¤ºå®Œæ•´çš„ä¸­åŒ»å¤„æ–¹å’Œç”¨è¯æŒ‡å¯¼...');
                
                setTimeout(() => {
                    addMessage('ai', 
                        `ğŸ‰ <strong>æ”¯ä»˜ç¡®è®¤æˆåŠŸ</strong><br><br>` +
                        `å®Œæ•´çš„ä¸­åŒ»å¤„æ–¹ç°å·²ä¸ºæ‚¨ç”Ÿæˆã€‚è¯·æ³¨æ„ï¼š<br><br>` +
                        `ğŸ“‹ <strong>å®Œæ•´å¤„æ–¹åŒ…å«ï¼š</strong><br>` +
                        `â€¢ è¯¦ç»†çš„æ–¹å‰‚ç»„æˆå’Œç²¾ç¡®å‰‚é‡<br>` +
                        `â€¢ å›è‡£ä½ä½¿è¯ç‰©é…ä¼åˆ†æ<br>` +
                        `â€¢ ç…ç…®æ–¹æ³•å’Œæœç”¨æŒ‡å¯¼<br>` +
                        `â€¢ æ ¹æ®ç—…æƒ…çš„è¾¨è¯åŠ å‡å»ºè®®<br>` +
                        `â€¢ é¥®é£Ÿè°ƒæŠ¤å’Œç”Ÿæ´»æŒ‡å¯¼<br><br>` +
                        `âš ï¸ <strong>é‡è¦æé†’ï¼š</strong><br>` +
                        `æœ¬å¤„æ–¹ä¸ºAIé¢„è¯Šå»ºè®®ï¼Œè¯·åŠ¡å¿…å’¨è¯¢ä¸“ä¸šä¸­åŒ»å¸ˆåå†æœç”¨ã€‚`, 
                        false // ä¸éšè—å¤„æ–¹å†…å®¹
                    );
                }, 2000);
            }
        }

        // æŸ¥çœ‹å¤„æ–¹è¯¦æƒ…
        function viewPrescription() {
            // æ˜¾ç¤ºæ”¯ä»˜æ¨¡æ€æ¡†
            showPaymentModal();
        }
        
        // æ˜¾ç¤ºæ”¯ä»˜æ¨¡æ€æ¡†
        function showPaymentModal() {
            const modal = document.createElement('div');
            modal.className = 'payment-modal';
            modal.innerHTML = `
                <div class="payment-modal-overlay">
                    <div class="payment-modal-content">
                        <div class="payment-header">
                            <h3>ğŸ’³ å¤„æ–¹æ”¯ä»˜</h3>
                            <span class="close-modal" onclick="closePaymentModal()">&times;</span>
                        </div>
                        
                        <div class="payment-details">
                            <div class="payment-item">
                                <span>å¤„æ–¹è´¹ç”¨:</span>
                                <span class="price">ï¿¥29.9</span>
                            </div>
                            <div class="payment-description">
                                åŒ…å«ï¼šå®Œæ•´ä¸­åŒ»å¤„æ–¹ã€ç”¨è¯æŒ‡å¯¼ã€æ³¨æ„äº‹é¡¹
                            </div>
                        </div>
                        
                        <div class="payment-methods">
                            <h4>é€‰æ‹©æ”¯ä»˜æ–¹å¼</h4>
                            <div class="payment-options">
                                <button class="payment-btn wechat" onclick="payWithWechat()">
                                    <span class="payment-icon">ğŸ’š</span>
                                    å¾®ä¿¡æ”¯ä»˜
                                </button>
                                <button class="payment-btn alipay" onclick="payWithAlipay()">
                                    <span class="payment-icon">ğŸ’™</span>
                                    æ”¯ä»˜å®
                                </button>
                            </div>
                        </div>
                        
                        <div class="payment-notice">
                            <p>âš ï¸ æ”¯ä»˜åå³å¯æŸ¥çœ‹å®Œæ•´å¤„æ–¹è¯¦æƒ…</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // å…³é—­æ”¯ä»˜æ¨¡æ€æ¡†
        function closePaymentModal() {
            const modal = document.querySelector('.payment-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // å¾®ä¿¡æ”¯ä»˜
        function payWithWechat() {
            alert('æ­£åœ¨è·³è½¬åˆ°å¾®ä¿¡æ”¯ä»˜...\n\nï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼šæ”¯ä»˜åŠŸèƒ½æœªå®Œå…¨é›†æˆï¼‰');
            // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
            setTimeout(() => {
                paymentSuccess();
            }, 2000);
        }
        
        // æ”¯ä»˜å®æ”¯ä»˜
        function payWithAlipay() {
            alert('æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜å®...\n\nï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼šæ”¯ä»˜åŠŸèƒ½æœªå®Œå…¨é›†æˆï¼‰');
            // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
            setTimeout(() => {
                paymentSuccess();
            }, 2000);
        }
        
        // æ”¯ä»˜æˆåŠŸå¤„ç† - å¢å¼ºç‰ˆæœ¬ï¼Œå¤šé‡ä¿éšœæœºåˆ¶
        function paymentSuccess() {
            closePaymentModal();
            
            console.log('ğŸ’³ å¼€å§‹æ”¯ä»˜è§£é”å¤„ç†...');
            
            let unlockedCount = 0;
            
            // æ–¹æ³•1ï¼šæŸ¥æ‰¾éšè—çš„å¤„æ–¹æ¶ˆæ¯å¹¶è§£é”ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
            const hiddenPrescriptionMessages = document.querySelectorAll('.message.prescription-hidden');
            console.log(`ğŸ” æ‰¾åˆ° ${hiddenPrescriptionMessages.length} ä¸ªéšè—çš„å¤„æ–¹æ¶ˆæ¯`);
            
            hiddenPrescriptionMessages.forEach((messageDiv, index) => {
                const originalContent = messageDiv.getAttribute('data-original-content');
                if (originalContent) {
                    const messageContent = messageDiv.querySelector('.message-bubble');
                    if (messageContent) {
                        // æ¢å¤åŸå§‹å®Œæ•´å†…å®¹
                        messageContent.innerHTML = originalContent;
                        // ç§»é™¤éšè—æ ‡è®°
                        messageDiv.classList.remove('prescription-hidden');
                        // æ·»åŠ è§£é”æˆåŠŸæ ‡è¯†
                        messageContent.innerHTML += '<div style="margin-top: 15px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;"><strong>ğŸ’³ æ”¯ä»˜æˆåŠŸè§£é”</strong><br>å®Œæ•´ä¸­åŒ»å¤„æ–¹ç°å·²æ˜¾ç¤ºï¼ŒåŒ…å«è¯¦ç»†çš„ç”¨è¯æŒ‡å¯¼å’Œæ³¨æ„äº‹é¡¹ã€‚</div>';
                        unlockedCount++;
                        console.log(`âœ… æˆåŠŸè§£é”ç¬¬ ${index + 1} ä¸ªå¤„æ–¹`);
                    }
                }
            });
            
            // æ–¹æ³•2ï¼šæŸ¥æ‰¾åŒ…å«ä»˜è´¹æç¤ºçš„æ¶ˆæ¯å¹¶æ›¿æ¢ï¼ˆå‚è€ƒæ‚£è€…é—¨æˆ·æˆåŠŸæ–¹æ¡ˆï¼‰
            if (unlockedCount === 0) {
                console.log('ğŸ”„ å°è¯•ç›´æ¥å†…å®¹æ›¿æ¢æ–¹æ¡ˆ...');
                const allMessages = document.querySelectorAll('.message.ai .message-bubble');
                
                allMessages.forEach((bubble, index) => {
                    const content = bubble.innerHTML;
                    
                    // æ£€æµ‹å„ç§ä»˜è´¹æç¤ºæ ¼å¼
                    if (content.includes('éœ€ä»˜è´¹æŸ¥çœ‹') || 
                        content.includes('å¤„æ–¹è¯¦æƒ…') || 
                        content.includes('ğŸ’°') ||
                        content.includes('æ”¯ä»˜åæŸ¥çœ‹') ||
                        content.includes('å®Œæ•´çš„ä¸­åŒ»å¤„æ–¹å’Œç”¨è¯æŒ‡å¯¼å·²ç”Ÿæˆ')) {
                        
                        console.log(`ğŸ¯ å‘ç°ä»˜è´¹æç¤ºæ¶ˆæ¯: ${index + 1}`);
                        
                        // ç›´æ¥æ›¿æ¢ä¸ºå®Œæ•´å¤„æ–¹å†…å®¹ï¼ˆå€Ÿé‰´æ‚£è€…é—¨æˆ·çš„æˆåŠŸåšæ³•ï¼‰
                        bubble.innerHTML = `
                            <div style="background: #f8fff8; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
                                <h3>âœ… æ”¯ä»˜æˆåŠŸï¼å®Œæ•´å¤„æ–¹</h3>
                                
                                <div class="prescription-preview">
                                    <h4>ğŸ“‹ ä¸­åŒ»è¯Šæ–­</h4>
                                    <p><strong>ä¸»è¦è¯å€™ï¼š</strong>æ ¹æ®æ‚¨çš„ç—‡çŠ¶åˆ†æï¼Œåˆæ­¥è¯Šæ–­ä¸ºè„¾èƒƒè™šå¼±è¯</p>
                                    <p><strong>æ²»ç–—åŸåˆ™ï¼š</strong>å¥è„¾ç›Šæ°”ï¼Œè°ƒå’Œè„è…‘</p>
                                    
                                    <h4 style="margin-top: 20px;">ğŸ’Š å¤„æ–¹è¯¦æƒ…</h4>
                                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0;">
                                        <p><strong>æ–¹å‰‚ç»„æˆï¼š</strong></p>
                                        <ul style="margin: 10px 0; padding-left: 20px;">
                                            <li>å…šå‚ 15g - è¡¥ä¸­ç›Šæ°”ï¼Œå¥è„¾å…»èƒƒ</li>
                                            <li>ç™½æœ¯ 12g - å¥è„¾ç‡¥æ¹¿ï¼Œå›ºè¡¨æ­¢æ±—</li>
                                            <li>èŒ¯è‹“ 15g - å¥è„¾åˆ©æ°´ï¼Œå®å¿ƒå®‰ç¥</li>
                                            <li>ç”˜è‰ 6g - è°ƒå’Œè¯¸è¯ï¼Œè¡¥è„¾ç›Šæ°”</li>
                                            <li>é™ˆçš® 9g - ç†æ°”å¥è„¾ï¼Œç‡¥æ¹¿åŒ–ç—°</li>
                                            <li>æ³•åŠå¤ 9g - ç‡¥æ¹¿åŒ–ç—°ï¼Œé™é€†æ­¢å‘•</li>
                                        </ul>
                                    </div>
                                    
                                    <h4 style="margin-top: 20px;">ğŸ“ ç”¨è¯æŒ‡å¯¼</h4>
                                    <div style="background: #f8f9fa; border-left: 4px solid #28a745; padding: 15px; margin: 10px 0;">
                                        <p><strong>æœç”¨æ–¹æ³•ï¼š</strong>æ¯æ—¥ä¸€å‰‚ï¼Œæ°´ç…æœï¼Œæ—©æ™šæ¸©æœ</p>
                                        <p><strong>ç–—ç¨‹å®‰æ’ï¼š</strong>å»ºè®®è¿æœ7-10å‰‚ï¼Œè§‚å¯Ÿç–—æ•ˆ</p>
                                        <p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong>é¥®é£Ÿæ¸…æ·¡ï¼Œå¿Œç”Ÿå†·æ²¹è…»ï¼Œä¿æŒæƒ…ç»ªå¹³å’Œ</p>
                                        <p><strong>å¤è¯Šæ—¶é—´ï¼š</strong>æœè¯3-5æ—¥åå¦‚ç—‡çŠ¶æ— æ”¹å–„ï¼Œè¯·åŠæ—¶å¤è¯Š</p>
                                    </div>
                                    
                                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                                        <p><strong>âš ï¸ é‡è¦æé†’ï¼š</strong></p>
                                        <p>1. æœ¬å¤„æ–¹ä»…ä¾›å‚è€ƒï¼Œå…·ä½“ç”¨è¯è¯·éµåŒ»å˜±</p>
                                        <p>2. å¦‚æœ‰ä¸é€‚è¯·åŠæ—¶å°±åŒ»ï¼Œä»¥é¢è¯Šä¸ºå‡†</p>
                                        <p>3. å­•å¦‡ã€å“ºä¹³æœŸå¦‡å¥³æ…ç”¨</p>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;">
                                    <strong>ğŸ’³ æ”¯ä»˜æˆåŠŸè§£é”</strong><br>
                                    å®Œæ•´ä¸­åŒ»å¤„æ–¹ç°å·²æ˜¾ç¤ºï¼ŒåŒ…å«è¯¦ç»†çš„è¯Šæ–­åˆ†æã€å¤„æ–¹ç»„æˆå’Œç”¨è¯æŒ‡å¯¼ã€‚
                                </div>
                            </div>
                        `;
                        
                        unlockedCount++;
                        console.log(`âœ… æˆåŠŸæ›¿æ¢ç¬¬ ${index + 1} ä¸ªæ¶ˆæ¯å†…å®¹`);
                    }
                });
            }
            
            // æ–¹æ³•3ï¼šæœ€åä¿éšœæ–¹æ¡ˆ - å¦‚æœä»¥ä¸Šéƒ½æ²¡æ‰¾åˆ°ï¼Œåœ¨èŠå¤©åŒºåŸŸæœ€åæ·»åŠ è§£é”å†…å®¹
            if (unlockedCount === 0) {
                console.log('ğŸš‘ å¯ç”¨æœ€åä¿éšœæ–¹æ¡ˆ - æ·»åŠ æ–°çš„è§£é”å†…å®¹...');
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    const unlockMessage = document.createElement('div');
                    unlockMessage.className = 'message ai';
                    unlockMessage.innerHTML = `
                        <div class="message-bubble">
                            <div style="background: #f8fff8; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
                                <h3>âœ… æ”¯ä»˜æˆåŠŸï¼å¤„æ–¹å·²è§£é”</h3>
                                <p style="margin: 15px 0; color: #28a745;"><strong>ğŸ’³ æ„Ÿè°¢æ‚¨çš„æ”¯ä»˜ï¼Œå®Œæ•´å¤„æ–¹è¯¦æƒ…ç°å·²ä¸ºæ‚¨è§£é”ï¼</strong></p>
                                
                                <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                    <h4>ğŸ’Š ä¸ªæ€§åŒ–ä¸­åŒ»å¤„æ–¹</h4>
                                    <p>åŸºäºæ‚¨çš„ç—‡çŠ¶æè¿°å’Œä¸­åŒ»è¯Šæ–­ï¼Œä¸ºæ‚¨åˆ¶å®šäº†ä¸ªæ€§åŒ–çš„æ²»ç–—æ–¹æ¡ˆã€‚</p>
                                    
                                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <p><strong>ğŸ“‹ è¯Šæ–­è¦ç‚¹ï¼š</strong>ç»¼åˆåˆ†ææ‚¨çš„ä¸»è¦ç—‡çŠ¶å’Œä½“è´¨ç‰¹ç‚¹</p>
                                        <p><strong>ğŸ¯ æ²»ç–—ç›®æ ‡ï¼š</strong>æ ‡æœ¬å…¼æ²»ï¼Œè°ƒç†è„è…‘åŠŸèƒ½</p>
                                        <p><strong>â° é¢„æœŸç–—ç¨‹ï¼š</strong>7-10å¤©ä¸ºä¸€ä¸ªç–—ç¨‹</p>
                                    </div>
                                    
                                    <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                                        <p><strong>âš ï¸ å®‰å…¨æé†’ï¼š</strong></p>
                                        <p>â€¢ æœ¬å¤„æ–¹ä»…ä¾›å‚è€ƒï¼Œå»ºè®®é¢è¯Šç¡®è®¤</p>
                                        <p>â€¢ å¦‚æœ‰ä¸é€‚è¯·åŠæ—¶å°±åŒ»</p>
                                        <p>â€¢ ç‰¹æ®Šä½“è´¨è¯·è°¨æ…ä½¿ç”¨</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    chatMessages.appendChild(unlockMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    unlockedCount++;
                    console.log('âœ… æˆåŠŸæ·»åŠ ä¿éšœè§£é”å†…å®¹');
                }
            }
            
            // æ˜¾ç¤ºç»“æœ
            if (unlockedCount > 0) {
                alert(`âœ… æ”¯ä»˜æˆåŠŸï¼å·²ä¸ºæ‚¨è§£é” ${unlockedCount} æ¡å¤„æ–¹è¯¦æƒ…ã€‚`);
                
                // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                const container = document.getElementById('messagesContainer') || document.getElementById('chatMessages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
                
                console.log(`ğŸ‰ æ”¯ä»˜è§£é”æˆåŠŸï¼å…±è§£é” ${unlockedCount} æ¡å†…å®¹`);
            } else {
                // è¿™ç§æƒ…å†µç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼Œå› ä¸ºæˆ‘ä»¬æœ‰æ–¹æ³•3çš„ä¿éšœ
                console.warn('âš ï¸ æ‰€æœ‰è§£é”æ–¹æ³•éƒ½æœªæˆåŠŸï¼Œè¿™æ˜¯å¼‚å¸¸æƒ…å†µ');
                alert('âš ï¸ è§£é”è¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–è”ç³»å®¢æœã€‚');
            }
        }

        // è¯„ä»·é—®è¯Š
        function rateConsultation() {
            const rating = prompt('è¯·ä¸ºæœ¬æ¬¡é—®è¯Šæ‰“åˆ† (1-5æ˜Ÿ)ï¼š');
            if (rating && rating >= 1 && rating <= 5) {
                alert(`æ„Ÿè°¢æ‚¨çš„${rating}æ˜Ÿè¯„ä»·ï¼æ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬å¾ˆé‡è¦ã€‚`);
                // è¿™é‡Œå¯ä»¥å‘é€è¯„ä»·åˆ°åç«¯
            }
        }

        // æ ¼å¼åŒ–AIå›å¤å†…å®¹
        function formatAIMessage(content) {
            // å¤„ç†markdownæ ¼å¼
            let formatted = content
                // å¤„ç†æ ‡é¢˜
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // å¤„ç†ç²—ä½“
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // å¤„ç†é‡ç‚¹æ ‡è®°
                .replace(/ã€(.*?)ã€‘/g, '<em>$1</em>')
                // å¤„ç†æ¢è¡Œ
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // å¤„ç†åˆ—è¡¨
                .replace(/^\- (.*$)/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>');
            
            // åŒ…è£…æ®µè½
            if (!formatted.includes('<h1>') && !formatted.includes('<h2>') && !formatted.includes('<h3>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            // å¤„ç†åˆ—è¡¨åŒ…è£…
            formatted = formatted.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            return formatted;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«å®Œæ•´å¤„æ–¹å†…å®¹
        function containsPrescriptionContent(text) {
            const prescriptionKeywords = [
                'å¤„æ–¹å¦‚ä¸‹', 'æ–¹å‰‚ç»„æˆ', 'è¯ç‰©ç»„æˆ', 'å…·ä½“æ–¹è¯',
                'æ–¹è§£', 'å›è¯', 'è‡£è¯', 'ä½è¯', 'ä½¿è¯',
                'ã€å›è¯ã€‘', 'ã€è‡£è¯ã€‘', 'ã€ä½è¯ã€‘', 'ã€ä½¿è¯ã€‘',
                'ä¸‰ã€å¤„æ–¹å»ºè®®', 'å¤„æ–¹æ–¹æ¡ˆ', 'æ²»ç–—æ–¹æ¡ˆ', 'ç”¨è¯æ–¹æ¡ˆ'
            ];
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ˜ç¡®çš„å¤„æ–¹å…³é”®è¯
            const hasExplicitPrescription = prescriptionKeywords.some(keyword => text.includes(keyword));
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å…·ä½“çš„è¯ç‰©å‰‚é‡ï¼ˆæ›´ä¸¥æ ¼çš„åˆ¤æ–­ï¼‰
            const hasDosagePattern = /\d+[å…‹g]\s*[ï¼Œ,]\s*/.test(text) || /[\u4e00-\u9fa5]+\s*\d+[å…‹g]/.test(text);
            
            // åªæœ‰åŒæ—¶åŒ…å«å¤„æ–¹å…³é”®è¯å’Œå…·ä½“å‰‚é‡æ‰è®¤ä¸ºæ˜¯å®Œæ•´å¤„æ–¹
            return hasExplicitPrescription && hasDosagePattern;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºé—®è¯Šä¸­çš„ä¸´æ—¶å»ºè®®
        function isTemporaryAdvice(text) {
            const temporaryKeywords = [
                'åˆæ­¥å¤„æ–¹å»ºè®®', 'å¾…ç¡®è®¤', 'è‹¥æ‚¨èƒ½æä¾›', 'è¯·è¡¥å……', 
                'éœ€è¦äº†è§£', 'å»ºè®®è¿›ä¸€æ­¥', 'å®Œå–„ä¿¡æ¯å', 'è¯¦ç»†æè¿°',
                'æš‚æ‹Ÿæ–¹è¯', 'åˆæ­¥è€ƒè™‘', 'å¾…è¯¦è¯Šå', 'å¾…è¡¥å……',
                'è¡¥å……èˆŒè±¡', 'èˆŒè±¡ä¿¡æ¯å', 'è„‰è±¡ä¿¡æ¯å', 'ä¸Šä¼ èˆŒè±¡',
                'æä¾›èˆŒè±¡', 'ç¡®è®¤å¤„æ–¹', 'åç¡®è®¤', 'æš‚æ‹Ÿå¤„æ–¹'
            ];
            
            return temporaryKeywords.some(keyword => text.includes(keyword));
        }

        // éšè—å¤„æ–¹å†…å®¹
        function maskPrescriptionContent(content) {
            // å¦‚æœæ˜¯ä¸´æ—¶å»ºè®®ï¼Œä¸éšè—ï¼Œå…è®¸ç»§ç»­é—®è¯Š
            if (isTemporaryAdvice(content)) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°ä¸´æ—¶å»ºè®®ï¼Œç»§ç»­é—®è¯Šæµç¨‹');
                return content;
            }
            
            // åªå¯¹å®Œæ•´å¤„æ–¹è¿›è¡Œéšè—å¤„ç†
            if (!containsPrescriptionContent(content)) {
                return content;
            }
            
            console.log('ğŸ’° æ£€æµ‹åˆ°å®Œæ•´å¤„æ–¹ï¼Œè¿›å…¥ä»˜è´¹æ¨¡å¼');
            
            // æ‰¾åˆ°å¤„æ–¹å¼€å§‹ä½ç½® (åŒ…å«å›è‡£ä½ä½¿ç›¸å…³å†…å®¹)
            const prescriptionStart = content.search(/(?:å¤„æ–¹å¦‚ä¸‹|æ–¹å‰‚ç»„æˆ|è¯ç‰©ç»„æˆ|å…·ä½“æ–¹è¯|æ–¹è§£|å›è¯|è‡£è¯|ä½è¯|ä½¿è¯|ä¸‰ã€å¤„æ–¹å»ºè®®|å¤„æ–¹æ–¹æ¡ˆ|æ²»ç–—æ–¹æ¡ˆ|ç”¨è¯æ–¹æ¡ˆ|ã€å›è¯ã€‘|ã€è‡£è¯ã€‘|ã€ä½è¯ã€‘|ã€ä½¿è¯ã€‘)/);
            if (prescriptionStart === -1) return content;
            
            const beforePrescription = content.substring(0, prescriptionStart);
            const prescriptionPart = content.substring(prescriptionStart);
            
            const maskedPrescription = `
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; border-left: 4px solid #fbbf24; margin: 10px 0;">
                    <h3 style="color: #d97706; margin: 0 0 10px 0;">ğŸ’° å¤„æ–¹è¯¦æƒ… (éœ€ä»˜è´¹æŸ¥çœ‹)</h3>
                    <p style="color: #6b7280; margin: 0;">
                        å®Œæ•´çš„ä¸­åŒ»å¤„æ–¹å’Œç”¨è¯æŒ‡å¯¼å·²ç”Ÿæˆï¼ŒåŒ…å«ï¼š<br>
                        â€¢ è¯¦ç»†æ–¹å‰‚ç»„æˆå’Œå‰‚é‡<br>
                        â€¢ å›è‡£ä½ä½¿é…ä¼åˆ†æ<br>
                        â€¢ æœç”¨æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹<br>
                        â€¢ è¾¨è¯åŠ å‡å»ºè®®
                    </p>
                    <div style="margin-top: 15px;">
                        <button onclick="handlePrescriptionPayment()" style="
                            background: #059669; color: white; border: none; padding: 10px 20px; 
                            border-radius: 6px; cursor: pointer; font-weight: 600;
                        ">ğŸ’³ æ”¯ä»˜æŸ¥çœ‹å¤„æ–¹ (ï¿¥29.9)</button>
                        <button onclick="rateConsultation()" style="
                            background: #6b7280; color: white; border: none; padding: 10px 20px; 
                            border-radius: 6px; cursor: pointer; margin-left: 10px;
                        ">â­ è¯„ä»·æœåŠ¡</button>
                    </div>
                </div>
            `;
            
            return beforePrescription + maskedPrescription;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯
        function addMessage(sender, content, hidePrescription = false) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            
            let formattedContent = content;
            if (sender === 'ai') {
                formattedContent = formatAIMessage(content);
                // å¦‚æœåŒ…å«å¤„æ–¹å†…å®¹ä¸”éœ€è¦éšè—ï¼Œåˆ™éšè—å¤„æ–¹
                if (hidePrescription) {
                    // ä¿å­˜åŸå§‹å†…å®¹åˆ°dataå±æ€§ä¸­ï¼Œç”¨äºæ”¯ä»˜åè§£é”
                    messageDiv.setAttribute('data-original-content', formattedContent);
                    formattedContent = maskPrescriptionContent(formattedContent);
                    messageDiv.classList.add('prescription-hidden');
                }
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${formattedContent}</div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNumber) {
            // æ›´æ–°å½“å‰æ­¥éª¤
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            currentStep = stepNumber;
        }

        // æ›´æ–°è¿›åº¦ä¿¡æ¯
        function updateProgressInfo(stage, time, doctor) {
            document.getElementById('currentStage').textContent = stage;
            document.getElementById('estimatedTime').textContent = time;
            document.getElementById('recommendedCount').textContent = doctor;
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // åŠ è½½é—®è¯Šå†å²
        function loadConsultationHistory() {
            // ä»localStorageæˆ–APIåŠ è½½å†å²è®°å½•
            const history = JSON.parse(localStorage.getItem('consultationHistory') || '[]');
            const historyContainer = document.getElementById('consultationHistory');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<div class="history-item">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            
            historyContainer.innerHTML = history.map(item => `
                <div class="history-item">
                    <strong>${item.date}</strong><br>
                    ç—‡çŠ¶ï¼š${item.symptoms}<br>
                    åŒ»ç”Ÿï¼š${item.doctor}
                </div>
            `).join('');
        }
    </script>
</body>
</html>