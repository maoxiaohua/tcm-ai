<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®è¯Šå†å² - TCM AIä¸­åŒ»åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-details {
            flex: 1;
            margin-left: 15px;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .user-type {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .upgrade-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .upgrade-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .stats-section {
            padding: 30px;
            background: #f8f9ff;
            border-bottom: 1px solid #e1e8f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .history-section {
            padding: 30px;
        }
        
        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "ğŸ“‹";
            margin-right: 10px;
        }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filter-tab.active {
            background: #667eea;
            color: white;
        }
        
        .filter-tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .filter-tab.disabled:hover {
            background: #f0f0f0;
            transform: none;
        }
        
        .doctor-group {
            margin-bottom: 30px;
            border: 1px solid #e1e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .doctor-header {
            background: #f8f9ff;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .doctor-header:hover {
            background: #f0f2ff;
        }
        
        .doctor-info {
            display: flex;
            align-items: center;
        }
        
        .doctor-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }
        
        .doctor-details .doctor-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .doctor-details .session-count {
            color: #666;
            font-size: 14px;
        }
        
        .expand-icon {
            font-size: 20px;
            color: #666;
            transition: transform 0.3s;
        }
        
        .doctor-group.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .sessions-list {
            display: none;
            padding: 0 20px 20px;
        }
        
        .doctor-group.expanded .sessions-list {
            display: block;
        }
        
        .session-item {
            background: white;
            border: 1px solid #e1e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .session-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .session-item.recent {
            border-left: 4px solid #667eea;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .session-title {
            font-weight: bold;
            color: #333;
        }
        
        .session-date {
            color: #666;
            font-size: 14px;
        }
        
        .session-complaint {
            color: #555;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .session-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .session-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .session-status.completed {
            background: #e8f5e8;
            color: #4caf50;
        }
        
        .session-status.active {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .conversation-count {
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .actions-bar {
            padding: 20px 30px;
            background: #f8f9ff;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e1e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #999;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px 30px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e1e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .device-item {
            background: #f8f9ff;
            border: 1px solid #e1e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-item.current {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .device-details {
            font-size: 14px;
            color: #666;
        }
        
        .device-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .device-status.current {
            background: #e8f5e8;
            color: #4caf50;
        }
        
        .device-status.inactive {
            background: #f5f5f5;
            color: #999;
        }
        
        .session-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-detail {
            background: #f0f8ff;
            color: #4a90e2;
            border: 1px solid #4a90e2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-detail:hover {
            background: #4a90e2;
            color: white;
        }
        
        .detail-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e1e8f0;
            border-radius: 8px;
            background: #f8f9ff;
        }
        
        .detail-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .detail-grid > div {
            padding: 5px 0;
        }
        
        .diagnosis-content {
            line-height: 1.6;
        }
        
        .diagnosis-content p {
            margin-bottom: 8px;
        }
        
        .status-info {
            padding: 10px 0;
        }
        
        @media (max-width: 600px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .history-section {
                padding: 20px;
            }
            
            .filter-tabs {
                grid-template-columns: repeat(2, 1fr);
                display: grid;
                gap: 8px;
            }
            
            .filter-tab {
                padding: 6px 12px;
                font-size: 13px;
                text-align: center;
            }
            
            .actions-bar {
                padding: 15px 20px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .modal-header, .modal-body, .modal-footer {
                padding: 15px 20px;
            }
            
            .device-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        
        .error-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        
        .error-state h3 {
            color: #dc2626;
            margin-bottom: 8px;
        }
        
        .error-state p {
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        
        .debug-info {
            font-size: 0.8rem !important;
            color: #9ca3af !important;
            margin-top: 12px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="header">
            <h1>ğŸ“‹ æˆ‘çš„é—®è¯Šå†å²</h1>
            <p class="subtitle">æ‚¨çš„ä¸ªäººä¸­åŒ»å¥åº·æ¡£æ¡ˆ</p>
            
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">ç”¨</div>
                <div class="user-details">
                    <div class="user-name" id="userName">åŠ è½½ä¸­...</div>
                    <div class="user-type" id="userType">è®¾å¤‡ç”¨æˆ·</div>
                </div>
                <button class="upgrade-btn" id="upgradeBtn" onclick="upgradeAccount()">
                    ğŸ“± ç»‘å®šæ‰‹æœº
                </button>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-section">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSessions">-</div>
                    <div class="stat-label">é—®è¯Šæ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="doctorCount">-</div>
                    <div class="stat-label">å’¨è¯¢åŒ»ç”Ÿ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="usageDays">-</div>
                    <div class="stat-label">ä½¿ç”¨å¤©æ•°</div>
                </div>
            </div>
        </div>
        
        <!-- å†å²è®°å½• -->
        <div class="history-section">
            <h2 class="section-title">é—®è¯Šè®°å½•</h2>
            
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterSessions('all')">å…¨éƒ¨</button>
                <button class="filter-tab" onclick="filterSessions('jin_daifu')">é‡‘å¤§å¤«</button>
                <button class="filter-tab" onclick="filterSessions('zhang_zhongjing')">å¼ ä»²æ™¯</button>
                <button class="filter-tab" onclick="filterSessions('recent')">æœ€è¿‘7å¤©</button>
            </div>
            
            <div id="historyContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ‚¨çš„é—®è¯Šå†å²...</p>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="actions-bar">
            <button class="btn-secondary" onclick="exportHistory()">ğŸ“„ å¯¼å‡ºæ¡£æ¡ˆ</button>
            <button class="btn-secondary" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
            <button class="btn-primary" onclick="startNewConsultation()">ğŸ’¬ å¼€å§‹æ–°é—®è¯Š</button>
        </div>
    </div>

    <!-- è®¾å¤‡ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="deviceModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“± æˆ‘çš„è®¾å¤‡</h2>
                <span class="close" onclick="closeDeviceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="device-list" id="deviceList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeviceModal()">å…³é—­</button>
                <button class="btn-primary" onclick="refreshDevices()">åˆ·æ–°</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUserId = null;
        let allSessions = [];
        let currentFilter = 'all';
        let userToken = null;
        let currentUser = null;
        
        // åŒ»ç”Ÿä¿¡æ¯æ˜ å°„ - åªä¿ç•™æ´»è·ƒåŒ»ç”Ÿï¼Œä»æœåŠ¡å™¨åŠ¨æ€è·å–
        let doctorInfo = {};
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
        
        // ğŸ”‘ åŠ¨æ€åŠ è½½æ´»è·ƒåŒ»ç”Ÿä¿¡æ¯
        async function loadDoctorInfo() {
            try {
                const response = await fetch('/api/doctor/list');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.doctors) {
                        // æ¸…ç©ºç°æœ‰æ˜ å°„ï¼Œåªä¿ç•™æ´»è·ƒåŒ»ç”Ÿ
                        doctorInfo = {};
                        
                        // æ›´æ–°åŒ»ç”Ÿä¿¡æ¯æ˜ å°„
                        data.doctors.forEach(doctor => {
                            if (doctor.doctor_code) {
                                doctorInfo[doctor.doctor_code] = {
                                    name: doctor.name,
                                    emoji: getEmojiForDoctor(doctor.doctor_code),
                                    description: extractDescription(doctor.specialties)
                                };
                            }
                        });
                        console.log('âœ… æ´»è·ƒåŒ»ç”Ÿä¿¡æ¯å·²æ›´æ–°:', Object.keys(doctorInfo));
                        console.log('âœ… æ´»è·ƒåŒ»ç”Ÿåˆ—è¡¨:', data.doctors.map(d => d.name));
                        
                        // æ›´æ–°åŒ»ç”Ÿç­›é€‰é€‰é¡¹å¡
                        updateDoctorTabs();
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ åŠ è½½åŒ»ç”Ÿä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // ğŸ”‘ æ›´æ–°åŒ»ç”Ÿç­›é€‰é€‰é¡¹å¡ï¼ˆä»…æ˜¾ç¤ºæ´»è·ƒåŒ»ç”Ÿå’Œæœ‰å†å²è®°å½•çš„åŒ»ç”Ÿï¼‰
        function updateDoctorTabs() {
            const filterTabs = document.querySelector('.filter-tabs');
            if (!filterTabs) return;
            
            // è·å–æ‰€æœ‰æœ‰æ•°æ®çš„åŒ»ç”Ÿ
            const doctorsWithData = [...new Set(allSessions.map(session => session.doctor_name))];
            console.log('æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ:', doctorsWithData);
            console.log('æ´»è·ƒåŒ»ç”Ÿ:', Object.keys(doctorInfo));
            
            // é‡æ–°ç”Ÿæˆè¿‡æ»¤æ ‡ç­¾ - åªæ˜¾ç¤ºæ´»è·ƒåŒ»ç”Ÿä¸­æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ
            let tabsHtml = '<button class="filter-tab active" onclick="filterSessions(\'all\')">å…¨éƒ¨</button>';
            
            // ç­›é€‰å‡ºæ´»è·ƒä¸”æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ
            const validDoctors = doctorsWithData.filter(doctorKey => doctorInfo[doctorKey]);
            
            validDoctors.forEach(doctorKey => {
                const doctor = doctorInfo[doctorKey];
                tabsHtml += `<button class="filter-tab" onclick="filterSessions('${doctorKey}')">${doctor.name}</button>`;
            });
            
            // æ·»åŠ æ—¶é—´ç­›é€‰
            tabsHtml += '<button class="filter-tab" onclick="filterSessions(\'recent\')">æœ€è¿‘7å¤©</button>';
            
            filterTabs.innerHTML = tabsHtml;
            console.log('âœ… åŒ»ç”Ÿç­›é€‰é€‰é¡¹å¡å·²æ›´æ–°ï¼Œåªæ˜¾ç¤ºæ´»è·ƒåŒ»ç”Ÿ');
        }
        
        // ä¸ºåŒ»ç”Ÿåˆ†é…emoji
        function getEmojiForDoctor(doctorCode) {
            const emojiMap = {
                'zhang_zhongjing': 'ğŸ¯',
                'jin_daifu': 'ğŸ‘¨â€âš•ï¸'
            };
            return emojiMap[doctorCode] || 'ğŸ‘¨â€âš•ï¸';
        }
        
        // ä»specialtiesä¸­æå–æè¿°
        function extractDescription(specialties) {
            if (!specialties) return 'ä¸­åŒ»ä¸“å®¶';
            try {
                const parsed = JSON.parse(specialties);
                return parsed.length > 0 ? parsed[0] : 'ä¸­åŒ»ä¸“å®¶';
            } catch {
                return specialties || 'ä¸­åŒ»ä¸“å®¶';
            }
        }
        
        // åˆå§‹åŒ–é¡µé¢
        async function initializePage() {
            try {
                // å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
                checkLoginStatus();
                
                // ğŸ”‘ å¹¶è¡ŒåŠ è½½åŒ»ç”Ÿä¿¡æ¯å’Œç”¨æˆ·ä¿¡æ¯
                await Promise.all([
                    loadDoctorInfo(),
                    loadUserInfo()
                ]);
                
                await loadSessionHistory();
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            // æŒ‰è§’è‰²æ£€æŸ¥token (ä¿®å¤tokené”®åä¸åŒ¹é…é—®é¢˜)
            const patientToken = localStorage.getItem('patientToken');
            const doctorToken = localStorage.getItem('doctorToken');
            const adminToken = localStorage.getItem('adminToken');
            const sessionToken = localStorage.getItem('session_token'); // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ session_token
            const userTokenStored = localStorage.getItem('userToken');
            
            // ä¼˜å…ˆä½¿ç”¨è§’è‰²ä¸“ç”¨tokenï¼Œç„¶åfallbackåˆ°é€šç”¨token
            userToken = patientToken || doctorToken || adminToken || sessionToken || userTokenStored;
            const userData = localStorage.getItem('userData') || localStorage.getItem('currentUser'); // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ currentUser
            
            if (userToken) {
                try {
                    currentUser = userData ? JSON.parse(userData) : null;
                    console.log('æ£€æµ‹åˆ°ç”¨æˆ·token:', userToken.substring(0, 20) + '...');
                    console.log('ç”¨æˆ·æ•°æ®:', currentUser);
                } catch (error) {
                    console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                    currentUser = null;
                }
            } else {
                console.log('æœªæ£€æµ‹åˆ°ç”¨æˆ·token');
            }
        }
        
        // è·å–è®¤è¯å¤´
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // ğŸ”‘ ä¿®å¤ï¼šä½¿ç”¨authManagerè·å–æ­£ç¡®çš„token
            const token = window.authManager ? window.authManager.getToken() : userToken;
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                console.log('ğŸ”‘ å†å²é¡µé¢ä½¿ç”¨è®¤è¯token:', token.substring(0, 20) + '...');
            } else {
                console.log('âš ï¸ å†å²é¡µé¢æ²¡æœ‰æ‰¾åˆ°è®¤è¯token');
            }
            
            return headers;
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                // ä¼˜å…ˆå°è¯•è®¤è¯APIï¼ˆçœŸæ­£çš„æ³¨å†Œç”¨æˆ·ï¼‰- ä½¿ç”¨ä¿®å¤ç‰ˆæœ¬
                const authResponse = await fetch('/api/auth/profile-fixed', {
                    headers: getAuthHeaders()
                });
                
                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    if (authData.success && authData.user) {
                        const userInfo = {
                            user_id: authData.user.user_id,
                            role: authData.user.role,
                            permissions: authData.user.permissions,
                            registration_type: authData.user.registration_type || 'authenticated',
                            username: authData.user.username,
                            email: authData.user.email,
                            nickname: authData.user.nickname || authData.user.username
                        };
                        currentUserId = userInfo.user_id;
                        currentUser = userInfo;
                        updateUserInterface(userInfo);
                        return;
                    }
                }
                
                // å¦‚æœè®¤è¯APIå¤±è´¥ï¼Œfallbackåˆ°è®¾å¤‡ç”¨æˆ·API
                const deviceResponse = await fetch('/api/user/info', {
                    headers: getAuthHeaders()
                });
                
                if (deviceResponse.ok) {
                    const userInfo = await deviceResponse.json();
                    currentUserId = userInfo.user_id;
                    currentUser = userInfo;
                    updateUserInterface(userInfo);
                } else {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                // æ˜¾ç¤ºé»˜è®¤ç”¨æˆ·ä¿¡æ¯
                document.getElementById('userName').textContent = 'æ¸¸å®¢ç”¨æˆ·';
                document.getElementById('userType').textContent = 'æœªæ³¨å†Œç”¨æˆ·';
            }
        }
        
        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserInterface(userInfo) {
            const userName = userInfo.nickname || `ç”¨æˆ·_${userInfo.user_id.slice(-4)}`;
            
            // æ›´æ–°ç”¨æˆ·ç±»å‹æ˜¾ç¤ºé€»è¾‘
            let userType;
            if (userInfo.registration_type === 'authenticated') {
                // å·²è®¤è¯çš„ç”¨æˆ·ï¼ˆé€šè¿‡patient/doctorè´¦æˆ·ç™»å½•ï¼‰
                userType = `å·²æ³¨å†Œç”¨æˆ·ï¼ˆ${userInfo.role || 'ç”¨æˆ·'}ï¼‰`;
            } else if (userInfo.registration_type === 'phone') {
                // æ‰‹æœºéªŒè¯ç”¨æˆ·
                userType = `å·²éªŒè¯ç”¨æˆ·ï¼ˆ${userInfo.phone_number}ï¼‰`;
            } else if (userInfo.registration_type === 'username') {
                // ç”¨æˆ·åæ³¨å†Œç”¨æˆ·
                userType = `æ³¨å†Œç”¨æˆ·ï¼ˆ${userInfo.username}ï¼‰`;
            } else if (userInfo.registration_type === 'email') {
                // é‚®ç®±æ³¨å†Œç”¨æˆ·
                userType = `æ³¨å†Œç”¨æˆ·ï¼ˆ${userInfo.email}ï¼‰`;
            } else {
                // è®¾å¤‡ç”¨æˆ·
                userType = 'è®¾å¤‡ç”¨æˆ·';
            }
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userType').textContent = userType;
            document.getElementById('userAvatar').textContent = userName.charAt(0);
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹è°ƒæ•´æŒ‰é’®
            if (userInfo.is_verified) {
                // å·²éªŒè¯ç”¨æˆ·æ˜¾ç¤ºè®¾å¤‡ç®¡ç†æŒ‰é’®
                const upgradeBtn = document.getElementById('upgradeBtn');
                upgradeBtn.innerHTML = 'ğŸ“± è®¾å¤‡ç®¡ç†';
                upgradeBtn.onclick = function() { showDeviceManagement(); };
            }
        }
        
        
        // è·å–å½“å‰ç”¨æˆ·IDï¼ˆå…¼å®¹æ™ºèƒ½å·¥ä½œæµé¡µé¢ï¼‰
        function getCurrentUserId() {
            // ğŸ”‘ ä¼˜å…ˆä½¿ç”¨çœŸå®ç™»å½•ç”¨æˆ·ä¿¡æ¯
            let realUser = null;
            
            // æ£€æŸ¥userDataå­˜å‚¨
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.id || userData.user_id || userData.global_user_id) {
                    realUser = userData;
                }
            } catch (e) {}
            
            // æ£€æŸ¥currentUserå­˜å‚¨ï¼ˆå¤‡é€‰ï¼‰
            if (!realUser) {
                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (currentUser.id || currentUser.user_id || currentUser.global_user_id) {
                        realUser = currentUser;
                    }
                } catch (e) {}
            }
            
            // å¦‚æœæ‰¾åˆ°çœŸå®ç”¨æˆ·
            if (realUser) {
                const userId = realUser.global_user_id || realUser.user_id || realUser.id;
                if (userId && userId !== 'undefined' && userId !== null) {
                    console.log('ğŸ”‘ å†å²é¡µé¢è·å–åˆ°çœŸå®ç”¨æˆ·ID:', userId);
                    return userId;
                }
            }
            
            // è®¿å®¢æ¨¡å¼
            const smartUser = localStorage.getItem('currentUserId');
            if (smartUser) {
                console.log('ğŸ”„ å†å²é¡µé¢ä½¿ç”¨è®¿å®¢ç”¨æˆ·ID:', smartUser);
                return smartUser;
            }
            
            // æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç”¨æˆ·ID
            console.warn('âš ï¸ å†å²é¡µé¢æ— æ³•è·å–ç”¨æˆ·ID');
            return null;
        }
        
        // åŠ è½½ä¼šè¯å†å²ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        async function loadSessionHistory(retryCount = 0) {
            const maxRetries = 3;
            const historyContent = document.getElementById('historyContent');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (retryCount === 0) {
                historyContent.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½æ‚¨çš„é—®è¯Šå†å²...</p>
                    </div>
                `;
            }
            
            try {
                console.log('æ­£åœ¨åŠ è½½ä¼šè¯å†å²ï¼Œå°è¯•æ¬¡æ•°:', retryCount + 1);
                
                // ğŸ”‘ è·å–å½“å‰ç”¨æˆ·IDå¹¶æ·»åŠ åˆ°APIè¯·æ±‚ä¸­
                const userId = getCurrentUserId();
                const apiUrl = userId ? `/api/user/sessions?user_id=${encodeURIComponent(userId)}` : '/api/user/sessions';
                
                console.log('ğŸ”— å†å²è®°å½•API URL:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: getAuthHeaders(),
                    timeout: 30000
                });
                
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('è·å–åˆ°çš„ä¼šè¯æ•°æ®:', data);
                    
                    allSessions = data.sessions || [];
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateStatistics(data.stats || {});
                    
                    // æ¸²æŸ“å†å²è®°å½•
                    renderSessionHistory();
                    
                    console.log('å†å²è®°å½•åŠ è½½æˆåŠŸï¼Œä¼šè¯æ•°é‡:', allSessions.length);
                } else {
                    throw new Error(`APIè¿”å›é”™è¯¯çŠ¶æ€: ${response.status}`);
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å†å²å¤±è´¥:', error);
                
                // å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œåˆ™é‡è¯•
                if (retryCount < maxRetries) {
                    console.log(`é‡è¯•åŠ è½½å†å²è®°å½• (${retryCount + 1}/${maxRetries})...`);
                    setTimeout(() => {
                        loadSessionHistory(retryCount + 1);
                    }, 2000 * (retryCount + 1)); // é€’å¢å»¶è¿Ÿ
                } else {
                    // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    showHistoryError(error.message);
                }
            }
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•åŠ è½½é”™è¯¯
        function showHistoryError(errorMessage) {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div class="error-state">
                    <div class="icon">âš ï¸</div>
                    <h3>åŠ è½½å†å²è®°å½•å¤±è´¥</h3>
                    <p>${errorMessage}</p>
                    <button class="btn-primary" onclick="loadSessionHistory(0)">é‡æ–°åŠ è½½</button>
                    <p class="debug-info">å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</p>
                </div>
            `;
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics(stats) {
            document.getElementById('totalSessions').textContent = stats.total_sessions || 0;
            document.getElementById('doctorCount').textContent = stats.doctor_count || 0;
            document.getElementById('usageDays').textContent = stats.usage_days || 0;
        }
        
        // æ¸²æŸ“ä¼šè¯å†å²
        function renderSessionHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (allSessions.length === 0) {
                showEmptyState();
                return;
            }
            
            // åŠ¨æ€æ›´æ–°è¿‡æ»¤æ ‡ç­¾ï¼ˆç¡®ä¿æ˜¾ç¤ºæ‰€æœ‰æœ‰æ•°æ®çš„åŒ»ç”Ÿï¼‰
            updateFilterTabs();
            
            // æŒ‰åŒ»ç”Ÿåˆ†ç»„
            const sessionsByDoctor = groupSessionsByDoctor(filteredSessions());
            
            let html = '';
            for (const [doctorName, sessions] of Object.entries(sessionsByDoctor)) {
                html += renderDoctorGroup(doctorName, sessions);
            }
            
            historyContent.innerHTML = html;
        }
        
        // åŠ¨æ€æ›´æ–°è¿‡æ»¤æ ‡ç­¾ - åªæ˜¾ç¤ºæ´»è·ƒåŒ»ç”Ÿ
        async function updateFilterTabs() {
            const filterTabs = document.querySelector('.filter-tabs');
            
            try {
                // 1. è·å–æ´»è·ƒåŒ»ç”Ÿåˆ—è¡¨
                const response = await fetch('/api/doctors/list', {
                    headers: getAuthHeaders()
                });
                
                const activeDoctorMap = {};
                if (response.ok) {
                    const doctorData = await response.json();
                    if (doctorData.success && doctorData.doctors) {
                        doctorData.doctors.forEach(doctor => {
                            // ğŸ”‘ ä¿®å¤: APIè¿”å›çš„åŒ»ç”Ÿéƒ½æ˜¯æ´»è·ƒçš„ï¼Œæ²¡æœ‰is_activeå­—æ®µ
                            activeDoctorMap[doctor.id] = doctor.name;
                        });
                        console.log('âœ… æ´»è·ƒåŒ»ç”Ÿåˆ—è¡¨:', activeDoctorMap);
                    }
                }
                
                // 2. è·å–æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿï¼ˆåªåŒ…å«æ´»è·ƒåŒ»ç”Ÿï¼‰
                const doctorsWithData = [...new Set(allSessions.map(session => session.doctor_name))];
                const activeDoctorsWithData = doctorsWithData.filter(doctorKey => activeDoctorMap[doctorKey]);
                
                console.log('ğŸ” æœ‰è®°å½•çš„æ´»è·ƒåŒ»ç”Ÿ:', activeDoctorsWithData);
                
                // 3. é‡æ–°ç”Ÿæˆè¿‡æ»¤æ ‡ç­¾
                let tabsHtml = '<button class="filter-tab active" onclick="filterSessions(\'all\')">å…¨éƒ¨</button>';
                
                // åªæ˜¾ç¤ºæ´»è·ƒä¸”æœ‰å†å²è®°å½•çš„åŒ»ç”Ÿ
                activeDoctorsWithData.forEach(doctorKey => {
                    const doctorName = activeDoctorMap[doctorKey];
                    tabsHtml += `<button class="filter-tab" onclick="filterSessions('${doctorKey}')">${doctorName}</button>`;
                });
                
                tabsHtml += '<button class="filter-tab" onclick="filterSessions(\'recent\')">æœ€è¿‘7å¤©</button>';
                
                filterTabs.innerHTML = tabsHtml;
                
                // 4. æ¢å¤å½“å‰é€‰ä¸­çŠ¶æ€
                const currentTab = filterTabs.querySelector(`[onclick="filterSessions('${currentFilter}')"]`);
                if (currentTab) {
                    filterTabs.querySelector('.active').classList.remove('active');
                    currentTab.classList.add('active');
                }
                
            } catch (error) {
                console.error('âŒ æ›´æ–°åŒ»ç”Ÿè¿‡æ»¤æ ‡ç­¾å¤±è´¥:', error);
                
                // fallback: æ˜¾ç¤ºåŸºç¡€æ ‡ç­¾
                let fallbackHtml = '<button class="filter-tab active" onclick="filterSessions(\'all\')">å…¨éƒ¨</button>';
                fallbackHtml += '<button class="filter-tab" onclick="filterSessions(\'recent\')">æœ€è¿‘7å¤©</button>';
                filterTabs.innerHTML = fallbackHtml;
            }
        }
        
        // æŒ‰åŒ»ç”Ÿåˆ†ç»„ä¼šè¯
        function groupSessionsByDoctor(sessions) {
            const grouped = {};
            sessions.forEach(session => {
                if (!grouped[session.doctor_name]) {
                    grouped[session.doctor_name] = [];
                }
                grouped[session.doctor_name].push(session);
            });
            return grouped;
        }
        
        // æ¸²æŸ“åŒ»ç”Ÿåˆ†ç»„
        function renderDoctorGroup(doctorName, sessions) {
            const doctor = doctorInfo[doctorName] || { name: doctorName, emoji: 'ğŸ‘¨â€âš•ï¸', description: '' };
            
            let sessionsHtml = '';
            sessions.forEach(session => {
                sessionsHtml += renderSessionItem(session);
            });
            
            return `
                <div class="doctor-group" onclick="toggleDoctorGroup(this)">
                    <div class="doctor-header">
                        <div class="doctor-info">
                            <div class="doctor-avatar">${doctor.emoji}</div>
                            <div class="doctor-details">
                                <div class="doctor-name">${doctor.name}</div>
                                <div class="session-count">${sessions.length}æ¬¡é—®è¯Š â€¢ ${doctor.description}</div>
                            </div>
                        </div>
                        <div class="expand-icon">â–¼</div>
                    </div>
                    <div class="sessions-list">
                        ${sessionsHtml}
                    </div>
                </div>
            `;
        }
        
        // æ¸²æŸ“ä¼šè¯é¡¹ç›®
        function renderSessionItem(session) {
            const isRecent = isRecentSession(session.created_at);
            const recentClass = isRecent ? 'recent' : '';
            
            return `
                <div class="session-item ${recentClass}">
                    <div class="session-header">
                        <div class="session-title">ç¬¬${session.session_count}æ¬¡é—®è¯Š</div>
                        <div class="session-date">${formatDate(session.created_at)}</div>
                    </div>
                    <div class="session-complaint">
                        ä¸»è¯‰ï¼š${session.chief_complaint || 'æœªè®°å½•'}
                    </div>
                    <div class="session-footer">
                        <div class="conversation-count">${session.total_conversations || 0}è½®å¯¹è¯</div>
                        <div class="session-actions">
                            <button class="btn-detail" onclick="viewSession('${session.session_id}')" title="æŸ¥çœ‹è¯¦æƒ…">
                                ğŸ“‹ è¯¦æƒ…
                            </button>
                            <div class="session-status ${session.session_status}">
                                ${session.session_status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ğŸ”‘ æ–°å¢ï¼šæ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            if (!allSessions || allSessions.length === 0) {
                showEmptyState();
                return;
            }
            
            // æŒ‰åŒ»ç”Ÿåˆ†ç»„
            const sessionsByDoctor = groupSessionsByDoctor(allSessions);
            
            let html = '';
            for (const [doctorName, sessions] of Object.entries(sessionsByDoctor)) {
                html += renderDoctorGroup(doctorName, sessions);
            }
            
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = html;
        }

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div class="empty-state">
                    <div class="icon">ğŸ¥</div>
                    <h3>è¿˜æ²¡æœ‰é—®è¯Šè®°å½•</h3>
                    <p>å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡AIä¸­åŒ»é—®è¯Šï¼Œå»ºç«‹ä¸“å±å¥åº·æ¡£æ¡ˆ</p>
                    <button class="btn-primary" onclick="startNewConsultation()">
                        ğŸ’¬ å¼€å§‹é—®è¯Š
                    </button>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div class="empty-state">
                    <div class="icon">âš ï¸</div>
                    <h3>åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                    <button class="btn-primary" onclick="location.reload()">
                        ğŸ”„ é‡æ–°åŠ è½½
                    </button>
                </div>
            `;
        }
        
        // å·¥å…·å‡½æ•°
        function isRecentSession(dateString) {
            const sessionDate = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - sessionDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function filteredSessions() {
            if (currentFilter === 'all') {
                return allSessions;
            } else if (currentFilter === 'recent') {
                return allSessions.filter(session => isRecentSession(session.created_at));
            } else {
                return allSessions.filter(session => session.doctor_name === currentFilter);
            }
        }
        
        // äº‹ä»¶å¤„ç†å‡½æ•°
        function toggleDoctorGroup(element) {
            element.classList.toggle('expanded');
        }
        
        function filterSessions(filter) {
            currentFilter = filter;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡æ–°æ¸²æŸ“
            renderSessionHistory();
        }
        
        function viewSession(sessionId) {
            // æ˜¾ç¤ºå¯¹è¯è¯¦æƒ…
            showConversationDetail(sessionId);
        }
        
        // æ˜¾ç¤ºå¯¹è¯è¯¦æƒ…
        async function showConversationDetail(sessionId) {
            try {
                // ğŸ”‘ ä¿®å¤ï¼šä»allSessionsä¸­ç›´æ¥è·å–è¯¦æƒ…ï¼Œé¿å…APIä¸åŒ¹é…é—®é¢˜
                const sessionDetail = allSessions.find(s => s.session_id === sessionId);
                if (!sessionDetail) {
                    alert('æœªæ‰¾åˆ°å¯¹è¯è¯¦æƒ…');
                    return;
                }
                
                // ğŸ”‘ ä¿®å¤ï¼šæ„å»ºå‰ç«¯æœŸæœ›çš„æ•°æ®æ ¼å¼
                const detail = {
                    session_id: sessionDetail.session_id,
                    session_count: sessionDetail.session_count || 1,
                    chief_complaint: sessionDetail.chief_complaint || extractChiefComplaint(sessionDetail.messages),
                    message_count: sessionDetail.messages ? sessionDetail.messages.length : 0,
                    diagnosis_summary: sessionDetail.diagnosis_summary || 'å¾…å®Œå–„',
                    prescription_given: sessionDetail.prescription_given || 'æš‚æœªå¼€æ–¹',
                    created_at: sessionDetail.created_at,
                    status: sessionDetail.status || 'completed'
                };
                
                displayConversationDetail(detail);
            } catch (error) {
                console.error('è·å–å¯¹è¯è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–å¯¹è¯è¯¦æƒ…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // ğŸ”‘ è¾…åŠ©å‡½æ•°ï¼šä»æ¶ˆæ¯ä¸­æå–ä¸»è¯‰
        function extractChiefComplaint(messages) {
            if (!messages || messages.length === 0) return 'æœªè®°å½•';
            // è·å–ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºä¸»è¯‰
            const firstUserMessage = messages.find(m => m.sender === 'user');
            return firstUserMessage ? firstUserMessage.content.substring(0, 50) + '...' : 'æœªè®°å½•';
        }
        
        // æ˜¾ç¤ºå¯¹è¯è¯¦æƒ…æ¨¡æ€æ¡†
        function displayConversationDetail(detail) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const doctorName = doctorInfo[detail.doctor_name]?.name || detail.doctor_name;
            const visitDate = new Date(detail.created_at).toLocaleString('zh-CN');
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>ğŸ“‹ å¯¹è¯è¯¦æƒ… - ${doctorName}</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-section">
                            <h3>åŸºæœ¬ä¿¡æ¯</h3>
                            <div class="detail-grid">
                                <div><strong>å°±è¯Šæ—¶é—´:</strong> ${visitDate}</div>
                                <div><strong>å°±è¯Šæ¬¡æ•°:</strong> ç¬¬${detail.session_count}æ¬¡</div>
                                <div><strong>ä¸»è¯‰:</strong> ${detail.chief_complaint || 'æœªè®°å½•'}</div>
                                <div><strong>å¯¹è¯è½®æ•°:</strong> ${detail.message_count}è½®</div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h3>è¯Šç–—è®°å½•</h3>
                            <div class="diagnosis-content">
                                <p><strong>è¯Šæ–­æ‘˜è¦:</strong> ${detail.diagnosis_summary || 'æœªè®°å½•'}</p>
                                <p><strong>å¤„æ–¹å»ºè®®:</strong> ${detail.prescription_given || 'æœªå¼€æ–¹'}</p>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h3>å¯¹è¯çŠ¶æ€</h3>
                            <div class="status-info">
                                <span class="session-status ${detail.session_status}">
                                    ${detail.session_status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="this.closest('.modal').remove()">å…³é—­</button>
                        <button class="btn-primary" onclick="exportConversation('${detail.session_id}')">ğŸ“„ å¯¼å‡ºç—…å†</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // å¯¼å‡ºå•ä¸ªå¯¹è¯
        async function exportConversation(sessionId) {
            try {
                const response = await fetch(`/api/user/conversation/${sessionId}/export`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TCM_ç—…å†_${sessionId.slice(0,8)}_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                } else {
                    console.error('å¯¼å‡ºå¤±è´¥:', response.status, await response.text());
                    alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        function upgradeAccount() {
            // è·³è½¬åˆ°æ‰‹æœºç»‘å®šé¡µé¢
            window.open('/phone-binding', '_blank');
        }
        
        function exportHistory() {
            // å¯¼å‡ºæ‰€æœ‰å†å²è®°å½•
            if (allSessions.length === 0) {
                alert('æš‚æ— å†å²è®°å½•å¯å¯¼å‡º');
                return;
            }
            
            // ç”Ÿæˆå¹¶ä¸‹è½½æ‘˜è¦æŠ¥å‘Š
            const summary = generateSummaryReport();
            downloadTextFile(summary, `TCM_å†å²è®°å½•æ‘˜è¦_${new Date().toISOString().split('T')[0]}.txt`);
        }
        
        // ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
        function generateSummaryReport() {
            const stats = {
                totalSessions: allSessions.length,
                doctorCount: new Set(allSessions.map(s => s.doctor_name)).size,
                recentSessions: allSessions.filter(s => isRecentSession(s.created_at)).length
            };
            
            let report = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
            report += `        TCM AIä¸­åŒ»æ™ºèƒ½é—®è¯Šå†å²è®°å½•æ‘˜è¦\n`;
            report += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
            report += `ã€ç»Ÿè®¡ä¿¡æ¯ã€‘\n`;
            report += `æ€»é—®è¯Šæ¬¡æ•°: ${stats.totalSessions}æ¬¡\n`;
            report += `å’¨è¯¢åŒ»ç”Ÿæ•°: ${stats.doctorCount}ä½\n`;
            report += `æœ€è¿‘7å¤©: ${stats.recentSessions}æ¬¡\n`;
            report += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n\n`;
            
            // æŒ‰åŒ»ç”Ÿåˆ†ç»„
            const sessionsByDoctor = groupSessionsByDoctor(allSessions);
            report += `ã€åˆ†åŒ»ç”Ÿè®°å½•ã€‘\n`;
            
            for (const [doctorName, sessions] of Object.entries(sessionsByDoctor)) {
                const doctor = doctorInfo[doctorName] || { name: doctorName, description: '' };
                report += `\n${doctor.name} (${sessions.length}æ¬¡é—®è¯Š)\n`;
                report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                
                sessions.slice(0, 5).forEach((session, index) => {
                    const date = new Date(session.created_at).toLocaleDateString('zh-CN');
                    report += `${index + 1}. ${date} - ${session.chief_complaint || 'ç—‡çŠ¶å’¨è¯¢'}\n`;
                });
                
                if (sessions.length > 5) {
                    report += `   ... è¿˜æœ‰${sessions.length - 5}æ¬¡è®°å½•\n`;
                }
            }
            
            report += `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
            report += `ğŸ¤– ç”±TCM AIä¸­åŒ»æ™ºèƒ½è¯Šç–—ç³»ç»Ÿç”Ÿæˆ\n`;
            report += `âš ï¸ æ­¤ä¸ºAIè¾…åŠ©è¯Šç–—è®°å½•ï¼Œä»…ä¾›å‚è€ƒ\n`;
            report += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
            
            return report;
        }
        
        // ä¸‹è½½æ–‡æœ¬æ–‡ä»¶
        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        async function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é—®è¯Šå†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                try {
                    console.log('ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºå†å²è®°å½•...');
                    
                    const headers = getAuthHeaders();
                    console.log('ğŸ”‘ ä½¿ç”¨çš„è¯·æ±‚å¤´:', headers);
                    
                    const response = await fetch('/api/user/sessions/clear', {
                        method: 'DELETE',
                        headers: headers
                    });
                    
                    console.log('ğŸ“¡ æ¸…ç©ºAPIå“åº”çŠ¶æ€:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ… æ¸…ç©ºAPIå“åº”:', result);
                        alert(result.message || 'æ¸…ç©ºæˆåŠŸ');
                        
                        // æ¸…ç©ºæœ¬åœ°æ˜¾ç¤º
                        allSessions = [];
                        updateHistoryDisplay();
                        updateStatistics({ total_sessions: 0, doctor_count: 0, usage_days: 0 });
                        
                        // é‡æ–°åŠ è½½
                        await loadSessionHistory();
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ æ¸…ç©ºAPIé”™è¯¯å“åº”:', errorText);
                        
                        try {
                            const error = JSON.parse(errorText);
                            alert('æ¸…ç©ºå¤±è´¥: ' + (error.detail || error.message || 'æœªçŸ¥é”™è¯¯'));
                        } catch {
                            alert('æ¸…ç©ºå¤±è´¥: HTTP ' + response.status);
                        }
                    }
                } catch (error) {
                    console.error('âŒ æ¸…ç©ºå†å²è®°å½•å¼‚å¸¸:', error);
                    alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥: ' + error.message);
                }
            }
        }
        
        function startNewConsultation() {
            // è¿”å›ä¸»é¡µå¼€å§‹æ–°é—®è¯Š
            window.location.href = '/';
        }
        
        // ========== è®¾å¤‡ç®¡ç†åŠŸèƒ½ ==========
        
        // æ˜¾ç¤ºè®¾å¤‡ç®¡ç†æ¨¡æ€æ¡†
        async function showDeviceManagement() {
            const modal = document.getElementById('deviceModal');
            modal.style.display = 'block';
            
            // åŠ è½½è®¾å¤‡åˆ—è¡¨
            await loadDeviceList();
        }
        
        // å…³é—­è®¾å¤‡ç®¡ç†æ¨¡æ€æ¡†
        function closeDeviceModal() {
            document.getElementById('deviceModal').style.display = 'none';
        }
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDeviceList() {
            const deviceList = document.getElementById('deviceList');
            
            try {
                const response = await fetch('/api/user/devices', {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.devices.length > 0) {
                        renderDeviceList(data.devices);
                    } else {
                        showEmptyDeviceList();
                    }
                } else {
                    throw new Error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                showDeviceError('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
        function renderDeviceList(devices) {
            const deviceList = document.getElementById('deviceList');
            
            let html = '';
            devices.forEach((device, index) => {
                const isCurrentClass = device.is_current ? 'current' : '';
                const statusClass = device.is_current ? 'current' : 'inactive';
                const statusText = device.is_current ? 'å½“å‰è®¾å¤‡' : 'éæ´»è·ƒ';
                
                html += `
                    <div class="device-item ${isCurrentClass}">
                        <div class="device-info">
                            <div class="device-name">${device.device_name}</div>
                            <div class="device-details">
                                æŒ‡çº¹: ${device.device_fingerprint}<br>
                                é¦–æ¬¡ç™»å½•: ${formatDate(device.first_login)}<br>
                                æœ€åæ´»è·ƒ: ${formatDate(device.last_active)}
                            </div>
                        </div>
                        <div class="device-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            });
            
            deviceList.innerHTML = html;
        }
        
        // æ˜¾ç¤ºç©ºè®¾å¤‡åˆ—è¡¨
        function showEmptyDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = `
                <div class="empty-state">
                    <div class="icon">ğŸ“±</div>
                    <h3>æš‚æ— è®¾å¤‡è®°å½•</h3>
                    <p>å½“æ‚¨åœ¨ä¸åŒè®¾å¤‡ä¸Šä½¿ç”¨æ—¶ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨</p>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºè®¾å¤‡ç®¡ç†é”™è¯¯
        function showDeviceError(message) {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = `
                <div class="empty-state">
                    <div class="icon">âš ï¸</div>
                    <h3>åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                    <button class="btn-primary" onclick="loadDeviceList()">é‡æ–°åŠ è½½</button>
                </div>
            `;
        }
        
        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        async function refreshDevices() {
            await loadDeviceList();
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('deviceModal');
            if (event.target === modal) {
                closeDeviceModal();
            }
        }
    </script>
</body>
</html>