<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈóÆËØäÂéÜÂè≤ - TCM AI‰∏≠ÂåªÂä©Êâã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-details {
            flex: 1;
            margin-left: 15px;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .user-type {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .upgrade-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .upgrade-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .stats-section {
            padding: 30px;
            background: #f8f9ff;
            border-bottom: 1px solid #e1e8f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .history-section {
            padding: 30px;
        }
        
        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "üìã";
            margin-right: 10px;
        }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filter-tab.active {
            background: #667eea;
            color: white;
        }
        
        .filter-tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .filter-tab.disabled:hover {
            background: #f0f0f0;
            transform: none;
        }
        
        .doctor-group {
            margin-bottom: 30px;
            border: 1px solid #e1e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .doctor-header {
            background: #f8f9ff;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .doctor-header:hover {
            background: #f0f2ff;
        }
        
        .doctor-info {
            display: flex;
            align-items: center;
        }
        
        .doctor-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }
        
        .doctor-details .doctor-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .doctor-details .session-count {
            color: #666;
            font-size: 14px;
        }
        
        .expand-icon {
            font-size: 20px;
            color: #666;
            transition: transform 0.3s;
        }
        
        .doctor-group.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .sessions-list {
            display: none;
            padding: 0 20px 20px;
        }
        
        .doctor-group.expanded .sessions-list {
            display: block;
        }
        
        .session-item {
            background: white;
            border: 1px solid #e1e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .session-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .session-item.recent {
            border-left: 4px solid #667eea;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .session-title {
            font-weight: bold;
            color: #333;
        }
        
        .session-date {
            color: #666;
            font-size: 14px;
        }
        
        .session-complaint {
            color: #555;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .session-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .session-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .session-status.completed {
            background: #e8f5e8;
            color: #4caf50;
        }
        
        .session-status.active {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .conversation-count {
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .actions-bar {
            padding: 20px 30px;
            background: #f8f9ff;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e1e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #999;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px 30px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e1e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .device-item {
            background: #f8f9ff;
            border: 1px solid #e1e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-item.current {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .device-details {
            font-size: 14px;
            color: #666;
        }
        
        .device-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .device-status.current {
            background: #e8f5e8;
            color: #4caf50;
        }
        
        .device-status.inactive {
            background: #f5f5f5;
            color: #999;
        }
        
        .session-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-detail {
            background: #f0f8ff;
            color: #4a90e2;
            border: 1px solid #4a90e2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-detail:hover {
            background: #4a90e2;
            color: white;
        }
        
        .detail-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e1e8f0;
            border-radius: 8px;
            background: #f8f9ff;
        }
        
        .detail-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .detail-grid > div {
            padding: 5px 0;
        }
        
        .diagnosis-content {
            line-height: 1.6;
        }
        
        .diagnosis-content p {
            margin-bottom: 8px;
        }
        
        .status-info {
            padding: 10px 0;
        }
        
        @media (max-width: 600px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .history-section {
                padding: 20px;
            }
            
            .filter-tabs {
                grid-template-columns: repeat(2, 1fr);
                display: grid;
                gap: 8px;
            }
            
            .filter-tab {
                padding: 6px 12px;
                font-size: 13px;
                text-align: center;
            }
            
            .actions-bar {
                padding: 15px 20px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .modal-header, .modal-body, .modal-footer {
                padding: 15px 20px;
            }
            
            .device-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        
        .error-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        
        .error-state h3 {
            color: #dc2626;
            margin-bottom: 8px;
        }
        
        .error-state p {
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        
        .debug-info {
            font-size: 0.8rem !important;
            color: #9ca3af !important;
            margin-top: 12px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â§¥ÈÉ®‰ø°ÊÅØ -->
        <div class="header">
            <h1>üìã ÊàëÁöÑÈóÆËØäÂéÜÂè≤</h1>
            <p class="subtitle">ÊÇ®ÁöÑ‰∏™‰∫∫‰∏≠ÂåªÂÅ•Â∫∑Ê°£Ê°à</p>
            
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">Áî®</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Âä†ËΩΩ‰∏≠...</div>
                    <div class="user-type" id="userType">ËÆæÂ§áÁî®Êà∑</div>
                </div>
                <button class="upgrade-btn" id="upgradeBtn" onclick="upgradeAccount()">
                    üì± ÁªëÂÆöÊâãÊú∫
                </button>
            </div>
        </div>
        
        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div class="stats-section">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSessions">-</div>
                    <div class="stat-label">ÈóÆËØäÊ¨°Êï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="doctorCount">-</div>
                    <div class="stat-label">Âí®ËØ¢ÂåªÁîü</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="usageDays">-</div>
                    <div class="stat-label">‰ΩøÁî®Â§©Êï∞</div>
                </div>
            </div>
        </div>
        
        <!-- ÂéÜÂè≤ËÆ∞ÂΩï -->
        <div class="history-section">
            <h2 class="section-title">ÈóÆËØäËÆ∞ÂΩï</h2>
            
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterSessions('all')">ÂÖ®ÈÉ®</button>
                <button class="filter-tab" onclick="filterSessions('jin_daifu')">ÈáëÂ§ßÂ§´</button>
                <button class="filter-tab" onclick="filterSessions('zhang_zhongjing')">Âº†‰ª≤ÊôØ</button>
                <button class="filter-tab" onclick="filterSessions('recent')">ÊúÄËøë7Â§©</button>
            </div>
            
            <div id="historyContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Ê≠£Âú®Âä†ËΩΩÊÇ®ÁöÑÈóÆËØäÂéÜÂè≤...</p>
                </div>
            </div>
        </div>
        
        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="actions-bar">
            <button class="btn-secondary" onclick="exportHistory()">üìÑ ÂØºÂá∫Ê°£Ê°à</button>
            <button class="btn-secondary" onclick="clearHistory()">üóëÔ∏è Ê∏ÖÁ©∫ÂéÜÂè≤</button>
            <button class="btn-primary" onclick="startNewConsultation()">üí¨ ÂºÄÂßãÊñ∞ÈóÆËØä</button>
        </div>
    </div>

    <!-- ËÆæÂ§áÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü -->
    <div id="deviceModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì± ÊàëÁöÑËÆæÂ§á</h2>
                <span class="close" onclick="closeDeviceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="device-list" id="deviceList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Ê≠£Âú®Âä†ËΩΩËÆæÂ§áÂàóË°®...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeviceModal()">ÂÖ≥Èó≠</button>
                <button class="btn-primary" onclick="refreshDevices()">Âà∑Êñ∞</button>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentUserId = null;
        let allSessions = [];
        let currentFilter = 'all';
        let userToken = null;
        let currentUser = null;
        
        // ÂåªÁîü‰ø°ÊÅØÊò†Â∞Ñ - Âè™‰øùÁïôÊ¥ªË∑ÉÂåªÁîüÔºå‰ªéÊúçÂä°Âô®Âä®ÊÄÅËé∑Âèñ
        let doctorInfo = {};
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
        
        // üîë Âä®ÊÄÅÂä†ËΩΩÊ¥ªË∑ÉÂåªÁîü‰ø°ÊÅØ
        async function loadDoctorInfo() {
            try {
                const response = await fetch('/api/doctor/list');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.doctors) {
                        // Ê∏ÖÁ©∫Áé∞ÊúâÊò†Â∞ÑÔºåÂè™‰øùÁïôÊ¥ªË∑ÉÂåªÁîü
                        doctorInfo = {};
                        
                        // Êõ¥Êñ∞ÂåªÁîü‰ø°ÊÅØÊò†Â∞Ñ
                        data.doctors.forEach(doctor => {
                            if (doctor.doctor_code) {
                                doctorInfo[doctor.doctor_code] = {
                                    name: doctor.name,
                                    emoji: getEmojiForDoctor(doctor.doctor_code),
                                    description: extractDescription(doctor.specialties)
                                };
                            }
                        });
                        console.log('‚úÖ Ê¥ªË∑ÉÂåªÁîü‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞:', Object.keys(doctorInfo));
                        console.log('‚úÖ Ê¥ªË∑ÉÂåªÁîüÂàóË°®:', data.doctors.map(d => d.name));
                        
                        // Êõ¥Êñ∞ÂåªÁîüÁ≠õÈÄâÈÄâÈ°πÂç°
                        updateDoctorTabs();
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Âä†ËΩΩÂåªÁîü‰ø°ÊÅØÂ§±Ë¥•:', error);
            }
        }

        // üîë Êõ¥Êñ∞ÂåªÁîüÁ≠õÈÄâÈÄâÈ°πÂç°Ôºà‰ªÖÊòæÁ§∫Ê¥ªË∑ÉÂåªÁîüÂíåÊúâÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂåªÁîüÔºâ
        function updateDoctorTabs() {
            const filterTabs = document.querySelector('.filter-tabs');
            if (!filterTabs) return;
            
            // Ëé∑ÂèñÊâÄÊúâÊúâÊï∞ÊçÆÁöÑÂåªÁîü
            const doctorsWithData = [...new Set(allSessions.map(session => session.doctor_name))];
            console.log('ÊúâÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂåªÁîü:', doctorsWithData);
            console.log('Ê¥ªË∑ÉÂåªÁîü:', Object.keys(doctorInfo));
            
            // ÈáçÊñ∞ÁîüÊàêËøáÊª§Ê†áÁ≠æ - Âè™ÊòæÁ§∫Ê¥ªË∑ÉÂåªÁîü‰∏≠ÊúâÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂåªÁîü
            let tabsHtml = '<button class="filter-tab active" onclick="filterSessions(\'all\')">ÂÖ®ÈÉ®</button>';
            
            // Á≠õÈÄâÂá∫Ê¥ªË∑É‰∏îÊúâÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂåªÁîü
            const validDoctors = doctorsWithData.filter(doctorKey => doctorInfo[doctorKey]);
            
            validDoctors.forEach(doctorKey => {
                const doctor = doctorInfo[doctorKey];
                tabsHtml += `<button class="filter-tab" onclick="filterSessions('${doctorKey}')">${doctor.name}</button>`;
            });
            
            // Ê∑ªÂä†Êó∂Èó¥Á≠õÈÄâ
            tabsHtml += '<button class="filter-tab" onclick="filterSessions(\'recent\')">ÊúÄËøë7Â§©</button>';
            
            filterTabs.innerHTML = tabsHtml;
            console.log('‚úÖ ÂåªÁîüÁ≠õÈÄâÈÄâÈ°πÂç°Â∑≤Êõ¥Êñ∞ÔºåÂè™ÊòæÁ§∫Ê¥ªË∑ÉÂåªÁîü');
        }
        
        // ‰∏∫ÂåªÁîüÂàÜÈÖçemoji
        function getEmojiForDoctor(doctorCode) {
            const emojiMap = {
                'zhang_zhongjing': 'üéØ',
                'jin_daifu': 'üë®‚Äç‚öïÔ∏è'
            };
            return emojiMap[doctorCode] || 'üë®‚Äç‚öïÔ∏è';
        }
        
        // ‰ªéspecialties‰∏≠ÊèêÂèñÊèèËø∞
        function extractDescription(specialties) {
            if (!specialties) return '‰∏≠Âåª‰∏ìÂÆ∂';
            try {
                const parsed = JSON.parse(specialties);
                return parsed.length > 0 ? parsed[0] : '‰∏≠Âåª‰∏ìÂÆ∂';
            } catch {
                return specialties || '‰∏≠Âåª‰∏ìÂÆ∂';
            }
        }
        
        // ÂàùÂßãÂåñÈ°µÈù¢
        async function initializePage() {
            try {
                // ÂÖàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
                checkLoginStatus();
                
                // üîë Âπ∂Ë°åÂä†ËΩΩÂåªÁîü‰ø°ÊÅØÂíåÁî®Êà∑‰ø°ÊÅØ
                await Promise.all([
                    loadDoctorInfo(),
                    loadUserInfo()
                ]);
                
                await loadSessionHistory();
            } catch (error) {
                console.error('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                showError('Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        function checkLoginStatus() {
            // ÊåâËßíËâ≤Ê£ÄÊü•token (‰øÆÂ§çtokenÈîÆÂêç‰∏çÂåπÈÖçÈóÆÈ¢ò)
            const patientToken = localStorage.getItem('patientToken');
            const doctorToken = localStorage.getItem('doctorToken');
            const adminToken = localStorage.getItem('adminToken');
            const sessionToken = localStorage.getItem('session_token'); // üîß ‰øÆÂ§çÔºöÊ∑ªÂä†session_token
            const userTokenStored = localStorage.getItem('userToken');
            
            // ‰ºòÂÖà‰ΩøÁî®ËßíËâ≤‰∏ìÁî®tokenÔºåÁÑ∂ÂêéfallbackÂà∞ÈÄöÁî®token
            userToken = patientToken || doctorToken || adminToken || sessionToken || userTokenStored;
            const userData = localStorage.getItem('userData') || localStorage.getItem('currentUser'); // üîß ‰øÆÂ§çÔºöÊ∑ªÂä†currentUser
            
            if (userToken) {
                try {
                    currentUser = userData ? JSON.parse(userData) : null;
                    console.log('Ê£ÄÊµãÂà∞Áî®Êà∑token:', userToken.substring(0, 20) + '...');
                    console.log('Áî®Êà∑Êï∞ÊçÆ:', currentUser);
                } catch (error) {
                    console.error('Ëß£ÊûêÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', error);
                    currentUser = null;
                }
            } else {
                console.log('Êú™Ê£ÄÊµãÂà∞Áî®Êà∑token');
            }
        }
        
        // Ëé∑ÂèñËÆ§ËØÅÂ§¥
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // üîë ‰øÆÂ§çÔºö‰ΩøÁî®authManagerËé∑ÂèñÊ≠£Á°ÆÁöÑtoken
            const token = window.authManager ? window.authManager.getToken() : userToken;
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                console.log('üîë ÂéÜÂè≤È°µÈù¢‰ΩøÁî®ËÆ§ËØÅtoken:', token.substring(0, 20) + '...');
            } else {
                console.log('‚ö†Ô∏è ÂéÜÂè≤È°µÈù¢Ê≤°ÊúâÊâæÂà∞ËÆ§ËØÅtoken');
            }
            
            return headers;
        }
        
        // Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
        async function loadUserInfo() {
            try {
                // ‰ºòÂÖàÂ∞ùËØïËÆ§ËØÅAPIÔºàÁúüÊ≠£ÁöÑÊ≥®ÂÜåÁî®Êà∑Ôºâ- ‰ΩøÁî®‰øÆÂ§çÁâàÊú¨
                const authResponse = await fetch('/api/auth/profile-fixed', {
                    headers: getAuthHeaders()
                });
                
                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    if (authData.success && authData.user) {
                        const userInfo = {
                            user_id: authData.user.user_id,
                            role: authData.user.role,
                            permissions: authData.user.permissions,
                            registration_type: authData.user.registration_type || 'authenticated',
                            username: authData.user.username,
                            email: authData.user.email,
                            nickname: authData.user.nickname || authData.user.username
                        };
                        currentUserId = userInfo.user_id;
                        currentUser = userInfo;
                        updateUserInterface(userInfo);
                        return;
                    }
                }
                
                // Â¶ÇÊûúËÆ§ËØÅAPIÂ§±Ë¥•ÔºåfallbackÂà∞ËÆæÂ§áÁî®Êà∑API
                const deviceResponse = await fetch('/api/user/info', {
                    headers: getAuthHeaders()
                });
                
                if (deviceResponse.ok) {
                    const userInfo = await deviceResponse.json();
                    currentUserId = userInfo.user_id;
                    currentUser = userInfo;
                    updateUserInterface(userInfo);
                } else {
                    throw new Error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•');
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
                // ÊòæÁ§∫ÈªòËÆ§Áî®Êà∑‰ø°ÊÅØ
                document.getElementById('userName').textContent = 'Ê∏∏ÂÆ¢Áî®Êà∑';
                document.getElementById('userType').textContent = 'Êú™Ê≥®ÂÜåÁî®Êà∑';
            }
        }
        
        // Êõ¥Êñ∞Áî®Êà∑ÁïåÈù¢
        function updateUserInterface(userInfo) {
            const userName = userInfo.nickname || `Áî®Êà∑_${userInfo.user_id.slice(-4)}`;
            
            // Êõ¥Êñ∞Áî®Êà∑Á±ªÂûãÊòæÁ§∫ÈÄªËæë
            let userType;
            if (userInfo.registration_type === 'authenticated') {
                // Â∑≤ËÆ§ËØÅÁöÑÁî®Êà∑ÔºàÈÄöËøápatient/doctorË¥¶Êà∑ÁôªÂΩïÔºâ
                userType = `Â∑≤Ê≥®ÂÜåÁî®Êà∑Ôºà${userInfo.role || 'Áî®Êà∑'}Ôºâ`;
            } else if (userInfo.registration_type === 'phone') {
                // ÊâãÊú∫È™åËØÅÁî®Êà∑
                userType = `Â∑≤È™åËØÅÁî®Êà∑Ôºà${userInfo.phone_number}Ôºâ`;
            } else if (userInfo.registration_type === 'username') {
                // Áî®Êà∑ÂêçÊ≥®ÂÜåÁî®Êà∑
                userType = `Ê≥®ÂÜåÁî®Êà∑Ôºà${userInfo.username}Ôºâ`;
            } else if (userInfo.registration_type === 'email') {
                // ÈÇÆÁÆ±Ê≥®ÂÜåÁî®Êà∑
                userType = `Ê≥®ÂÜåÁî®Êà∑Ôºà${userInfo.email}Ôºâ`;
            } else {
                // ËÆæÂ§áÁî®Êà∑
                userType = 'ËÆæÂ§áÁî®Êà∑';
            }
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userType').textContent = userType;
            document.getElementById('userAvatar').textContent = userName.charAt(0);
            
            // Ê†πÊçÆÁî®Êà∑Á±ªÂûãË∞ÉÊï¥ÊåâÈíÆ
            if (userInfo.is_verified) {
                // Â∑≤È™åËØÅÁî®Êà∑ÊòæÁ§∫ËÆæÂ§áÁÆ°ÁêÜÊåâÈíÆ
                const upgradeBtn = document.getElementById('upgradeBtn');
                upgradeBtn.innerHTML = 'üì± ËÆæÂ§áÁÆ°ÁêÜ';
                upgradeBtn.onclick = function() { showDeviceManagement(); };
            }
        }
        
        
        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑IDÔºàÂÖºÂÆπÊô∫ËÉΩÂ∑•‰ΩúÊµÅÈ°µÈù¢Ôºâ
        function getCurrentUserId() {
            // üîë ‰øÆÂ§çÔºö‰ºòÂÖà‰ªéËÆ§ËØÅÁî®Êà∑‰ø°ÊÅØËé∑ÂèñÁúüÂÆûÁî®Êà∑ID
            
            // 1. Â¶ÇÊûúÊúâËÆ§ËØÅÁî®Êà∑‰ø°ÊÅØÔºà‰ªéAPIËé∑ÂèñÁöÑÔºâÔºåÁõ¥Êé•‰ΩøÁî®
            if (currentUser && currentUser.user_id && currentUser.user_id !== 'anonymous') {
                console.log('üîë ÂéÜÂè≤È°µÈù¢‰ΩøÁî®ËÆ§ËØÅÁî®Êà∑ID:', currentUser.user_id);
                return currentUser.user_id;
            }
            
            // 2. Ê£ÄÊü•userDataÂ≠òÂÇ®ÔºàÁôªÂΩïÂêéÁöÑÊï∞ÊçÆÔºâ
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.global_user_id) {
                    console.log('üîë ÂéÜÂè≤È°µÈù¢‰ªéuserDataËé∑ÂèñÁî®Êà∑ID:', userData.global_user_id);
                    return userData.global_user_id;
                }
                if (userData.user_id && userData.user_id !== 'anonymous') {
                    console.log('üîë ÂéÜÂè≤È°µÈù¢‰ªéuserDataËé∑ÂèñÁî®Êà∑ID:', userData.user_id);
                    return userData.user_id;
                }
            } catch (e) {
                console.warn('Ëß£ÊûêuserDataÂ§±Ë¥•:', e);
            }
            
            // 3. Ê£ÄÊü•currentUserÂ≠òÂÇ®ÔºàÂ§áÈÄâÔºâ
            try {
                const storedCurrentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (storedCurrentUser.global_user_id) {
                    console.log('üîë ÂéÜÂè≤È°µÈù¢‰ªécurrentUserËé∑ÂèñÁî®Êà∑ID:', storedCurrentUser.global_user_id);
                    return storedCurrentUser.global_user_id;
                }
                if (storedCurrentUser.user_id && storedCurrentUser.user_id !== 'anonymous') {
                    console.log('üîë ÂéÜÂè≤È°µÈù¢‰ªécurrentUserËé∑ÂèñÁî®Êà∑ID:', storedCurrentUser.user_id);
                    return storedCurrentUser.user_id;
                }
            } catch (e) {
                console.warn('Ëß£ÊûêcurrentUserÂ§±Ë¥•:', e);
            }
            
            // 4. Â∞ùËØï‰ªéURLÂèÇÊï∞Ëé∑ÂèñÁî®Êà∑ID
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            if (urlUserId && urlUserId !== 'anonymous') {
                console.log('üîë ÂéÜÂè≤È°µÈù¢‰ªéURLËé∑ÂèñÁî®Êà∑ID:', urlUserId);
                return urlUserId;
            }
            
            // 5. ËÆøÂÆ¢Ê®°Âºè - ËÆæÂ§áÁî®Êà∑ID
            const smartUser = localStorage.getItem('currentUserId');
            if (smartUser && smartUser !== 'anonymous') {
                console.log('üîÑ ÂéÜÂè≤È°µÈù¢‰ΩøÁî®ËÆøÂÆ¢Áî®Êà∑ID:', smartUser);
                return smartUser;
            }
            
            // 6. ÊúÄÂêéÂÖúÂ∫ïÔºöÂ¶ÇÊûúÊòØanonymousÁî®Êà∑ÔºåËøîÂõûnullÂº∫Âà∂‰ΩøÁî®tokenËß£Êûê
            console.warn('‚ö†Ô∏è ÂéÜÂè≤È°µÈù¢Êó†Ê≥ïËé∑ÂèñÊúâÊïàÁî®Êà∑IDÔºåÂ∞Ü‰æùËµñÊúçÂä°Á´ØtokenËß£Êûê');
            return null;
        }
        
        // Âä†ËΩΩ‰ºöËØùÂéÜÂè≤ÔºàÂ∏¶ÈáçËØïÊú∫Âà∂Ôºâ
        async function loadSessionHistory(retryCount = 0) {
            const maxRetries = 3;
            const historyContent = document.getElementById('historyContent');

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            if (retryCount === 0) {
                historyContent.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Ê≠£Âú®Âä†ËΩΩÊÇ®ÁöÑÈóÆËØäÂéÜÂè≤...</p>
                    </div>
                `;
            }

            try {
                console.log('Ê≠£Âú®Âä†ËΩΩ‰ºöËØùÂéÜÂè≤ÔºåÂ∞ùËØïÊ¨°Êï∞:', retryCount + 1);

                // üîë ‰øÆÂ§çÔºö‰ΩøÁî®Êñ∞ÁöÑÁªü‰∏ÄÈóÆËØäAPIÁ´ØÁÇπ
                const userId = getCurrentUserId();
                const apiUrl = `/api/consultation/patient/history?user_id=${encodeURIComponent(userId || '')}`;

                console.log('üîó ÂéÜÂè≤ËÆ∞ÂΩïAPI URL (Êñ∞Áªü‰∏ÄAPI):', apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: getAuthHeaders(),
                    timeout: 30000
                });

                console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Ëé∑ÂèñÂà∞ÁöÑÁªü‰∏ÄAPIÊï∞ÊçÆ:', result);

                    if (result.success && result.data) {
                        // üîë Êñ∞APIÂìçÂ∫îÁªìÊûÑÔºöresult.data.consultation_history
                        const consultations = result.data.consultation_history || [];
                        console.log(`üìä Ëß£ÊûêÂà∞ ${consultations.length} Êù°ÈóÆËØäËÆ∞ÂΩï`);

                        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè‰ª•ÂÖºÂÆπÁé∞ÊúâÊ∏≤ÊüìÈÄªËæë
                        allSessions = consultations.map((consultation, index) => ({
                            session_id: consultation.consultation_id,
                            doctor_name: consultation.selected_doctor_id,
                            session_count: index + 1,
                            chief_complaint: consultation.symptoms_analysis ?
                                (typeof consultation.symptoms_analysis === 'string' ?
                                    JSON.parse(consultation.symptoms_analysis).chief_complaint :
                                    consultation.symptoms_analysis.chief_complaint)
                                : 'Êú™ËÆ∞ÂΩï',
                            created_at: consultation.created_at,
                            updated_at: consultation.updated_at,
                            status: consultation.status,
                            total_conversations: consultation.conversation_log ?
                                (typeof consultation.conversation_log === 'string' ?
                                    JSON.parse(consultation.conversation_log).conversation_history?.length :
                                    consultation.conversation_log.conversation_history?.length) || 0
                                : 0,
                            has_prescription: consultation.has_prescription || false,
                            prescription_info: consultation.prescription_info || null
                        }));

                        console.log('üìù ËΩ¨Êç¢ÂêéÁöÑ‰ºöËØùÊï∞ÊçÆ:', allSessions);

                        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                        const stats = {
                            total_sessions: result.data.total_count || allSessions.length,
                            doctor_count: new Set(allSessions.map(s => s.doctor_name)).size,
                            usage_days: calculateUsageDays(allSessions)
                        };
                        updateStatistics(stats);

                        // Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï
                        renderSessionHistory();

                        console.log('‚úÖ ÂéÜÂè≤ËÆ∞ÂΩïÂä†ËΩΩÊàêÂäüÔºåÈóÆËØäÊï∞Èáè:', allSessions.length);
                    } else {
                        throw new Error(result.message || 'APIËøîÂõûÊï∞ÊçÆÊ†ºÂºèÈîôËØØ');
                    }
                } else {
                    throw new Error(`APIËøîÂõûÈîôËØØÁä∂ÊÄÅ: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩ‰ºöËØùÂéÜÂè≤Â§±Ë¥•:', error);

                // Â¶ÇÊûúËøòÊúâÈáçËØïÊ¨°Êï∞ÔºåÂàôÈáçËØï
                if (retryCount < maxRetries) {
                    console.log(`üîÑ ÈáçËØïÂä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï (${retryCount + 1}/${maxRetries})...`);
                    setTimeout(() => {
                        loadSessionHistory(retryCount + 1);
                    }, 2000 * (retryCount + 1)); // ÈÄíÂ¢ûÂª∂Ëøü
                } else {
                    // ÊâÄÊúâÈáçËØïÈÉΩÂ§±Ë¥•ÔºåÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
                    showHistoryError(error.message);
                }
            }
        }

        // üîë Êñ∞Â¢ûÔºöËÆ°ÁÆó‰ΩøÁî®Â§©Êï∞
        function calculateUsageDays(sessions) {
            if (sessions.length === 0) return 0;

            const dates = sessions.map(s => new Date(s.created_at).toDateString());
            const uniqueDates = new Set(dates);
            return uniqueDates.size;
        }
        
        // ÊòæÁ§∫ÂéÜÂè≤ËÆ∞ÂΩïÂä†ËΩΩÈîôËØØ
        function showHistoryError(errorMessage) {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div class="error-state">
                    <div class="icon">‚ö†Ô∏è</div>
                    <h3>Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•</h3>
                    <p>${errorMessage}</p>
                    <button class="btn-primary" onclick="loadSessionHistory(0)">ÈáçÊñ∞Âä†ËΩΩ</button>
                    <p class="debug-info">Â¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠ÔºåËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢ÊàñÊ∏ÖÈô§ÊµèËßàÂô®ÁºìÂ≠ò</p>
                </div>
            `;
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStatistics(stats) {
            document.getElementById('totalSessions').textContent = stats.total_sessions || 0;
            document.getElementById('doctorCount').textContent = stats.doctor_count || 0;
            document.getElementById('usageDays').textContent = stats.usage_days || 0;
        }
        
        // Ê∏≤Êüì‰ºöËØùÂéÜÂè≤
        function renderSessionHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (allSessions.length === 0) {
                showEmptyState();
                return;
            }
            
            // Âä®ÊÄÅÊõ¥Êñ∞ËøáÊª§Ê†áÁ≠æÔºàÁ°Æ‰øùÊòæÁ§∫ÊâÄÊúâÊúâÊï∞ÊçÆÁöÑÂåªÁîüÔºâ
            updateFilterTabs();
            
            // ÊåâÂåªÁîüÂàÜÁªÑ
            const sessionsByDoctor = groupSessionsByDoctor(filteredSessions());
            
            let html = '';
            for (const [doctorName, sessions] of Object.entries(sessionsByDoctor)) {
                html += renderDoctorGroup(doctorName, sessions);
            }
            
            historyContent.innerHTML = html;
        }
        
        // Âä®ÊÄÅÊõ¥Êñ∞ËøáÊª§Ê†áÁ≠æ - Âè™ÊòæÁ§∫Ê¥ªË∑ÉÂåªÁîü
        async function updateFilterTabs() {
            const filterTabs = document.querySelector('.filter-tabs');
            
            try {
                // 1. Ëé∑ÂèñÊ¥ªË∑ÉÂåªÁîüÂàóË°®
                const response = await fetch('/api/doctors/list', {
                    headers: getAuthHeaders()
                });
                
                const activeDoctorMap = {};
                if (response.ok) {
                    const doctorData = await response.json();
                    if (doctorData.success && doctorData.doctors) {
                        doctorData.doctors.forEach(doctor => {
                            // üîë ‰øÆÂ§ç: APIËøîÂõûÁöÑÂåªÁîüÈÉΩÊòØÊ¥ªË∑ÉÁöÑÔºåÊ≤°Êúâis_activeÂ≠óÊÆµ
                            activeDoctorMap[doctor.id] = doctor.name;
                        });
                        console.log('‚úÖ Ê¥ªË∑ÉÂåªÁîüÂàóË°®:', activeDoctorMap);
                    }
                }
                
                // 2. Ëé∑ÂèñÊúâÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂåªÁîüÔºàÂè™ÂåÖÂê´Ê¥ªË∑ÉÂåªÁîüÔºâ
                const doctorsWithData = [...new Set(allSessions.map(session => session.doctor_name))];
                const activeDoctorsWithData = doctorsWithData.filter(doctorKey => activeDoctorMap[doctorKey]);
                
                console.log('üîç ÊúâËÆ∞ÂΩïÁöÑÊ¥ªË∑ÉÂåªÁîü:', activeDoctorsWithData);
                
                // 3. ÈáçÊñ∞ÁîüÊàêËøáÊª§Ê†áÁ≠æ
                let tabsHtml = '<button class="filter-tab active" onclick="filterSessions(\'all\')">ÂÖ®ÈÉ®</button>';
                
                // Âè™ÊòæÁ§∫Ê¥ªË∑É‰∏îÊúâÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂåªÁîü
                activeDoctorsWithData.forEach(doctorKey => {
                    const doctorName = activeDoctorMap[doctorKey];
                    tabsHtml += `<button class="filter-tab" onclick="filterSessions('${doctorKey}')">${doctorName}</button>`;
                });
                
                tabsHtml += '<button class="filter-tab" onclick="filterSessions(\'recent\')">ÊúÄËøë7Â§©</button>';
                
                filterTabs.innerHTML = tabsHtml;
                
                // 4. ÊÅ¢Â§çÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
                const currentTab = filterTabs.querySelector(`[onclick="filterSessions('${currentFilter}')"]`);
                if (currentTab) {
                    filterTabs.querySelector('.active').classList.remove('active');
                    currentTab.classList.add('active');
                }
                
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞ÂåªÁîüËøáÊª§Ê†áÁ≠æÂ§±Ë¥•:', error);
                
                // fallback: ÊòæÁ§∫Âü∫Á°ÄÊ†áÁ≠æ
                let fallbackHtml = '<button class="filter-tab active" onclick="filterSessions(\'all\')">ÂÖ®ÈÉ®</button>';
                fallbackHtml += '<button class="filter-tab" onclick="filterSessions(\'recent\')">ÊúÄËøë7Â§©</button>';
                filterTabs.innerHTML = fallbackHtml;
            }
        }
        
        // ÊåâÂåªÁîüÂàÜÁªÑ‰ºöËØù
        function groupSessionsByDoctor(sessions) {
            const grouped = {};
            sessions.forEach(session => {
                if (!grouped[session.doctor_name]) {
                    grouped[session.doctor_name] = [];
                }
                grouped[session.doctor_name].push(session);
            });
            return grouped;
        }
        
        // Ê∏≤ÊüìÂåªÁîüÂàÜÁªÑ
        function renderDoctorGroup(doctorName, sessions) {
            const doctor = doctorInfo[doctorName] || { name: doctorName, emoji: 'üë®‚Äç‚öïÔ∏è', description: '' };
            
            let sessionsHtml = '';
            sessions.forEach(session => {
                sessionsHtml += renderSessionItem(session);
            });
            
            return `
                <div class="doctor-group" onclick="toggleDoctorGroup(this)">
                    <div class="doctor-header">
                        <div class="doctor-info">
                            <div class="doctor-avatar">${doctor.emoji}</div>
                            <div class="doctor-details">
                                <div class="doctor-name">${doctor.name}</div>
                                <div class="session-count">${sessions.length}Ê¨°ÈóÆËØä ‚Ä¢ ${doctor.description}</div>
                            </div>
                        </div>
                        <div class="expand-icon">‚ñº</div>
                    </div>
                    <div class="sessions-list">
                        ${sessionsHtml}
                    </div>
                </div>
            `;
        }
        
        // Ê∏≤Êüì‰ºöËØùÈ°πÁõÆ
        function renderSessionItem(session) {
            const isRecent = isRecentSession(session.created_at);
            const recentClass = isRecent ? 'recent' : '';
            
            return `
                <div class="session-item ${recentClass}">
                    <div class="session-header">
                        <div class="session-title">Á¨¨${session.session_count}Ê¨°ÈóÆËØä</div>
                        <div class="session-date">${formatDate(session.created_at)}</div>
                    </div>
                    <div class="session-complaint">
                        ‰∏ªËØâÔºö${session.chief_complaint || 'Êú™ËÆ∞ÂΩï'}
                    </div>
                    <div class="session-footer">
                        <div class="conversation-count">${session.total_conversations || 0}ËΩÆÂØπËØù</div>
                        <div class="session-actions">
                            <button class="btn-detail" onclick="showConversationDetail('${session.session_id}')" title="Êü•ÁúãËØ¶ÊÉÖ">
                                üìã ËØ¶ÊÉÖ
                            </button>
                            <button class="btn-detail" onclick="viewSession('${session.session_id}')" title="ÊÅ¢Â§çÂØπËØù" style="margin-left: 5px;">
                                üí¨ ÊÅ¢Â§ç
                            </button>
                            <div class="session-status ${session.status === 'completed' ? 'completed' : 'active'}">
                                ${session.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // üîë Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÊòæÁ§∫
        function updateHistoryDisplay() {
            if (!allSessions || allSessions.length === 0) {
                showEmptyState();
                return;
            }
            
            // ÊåâÂåªÁîüÂàÜÁªÑ
            const sessionsByDoctor = groupSessionsByDoctor(allSessions);
            
            let html = '';
            for (const [doctorName, sessions] of Object.entries(sessionsByDoctor)) {
                html += renderDoctorGroup(doctorName, sessions);
            }
            
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = html;
        }

        // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
        function showEmptyState() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üè•</div>
                    <h3>ËøòÊ≤°ÊúâÈóÆËØäËÆ∞ÂΩï</h3>
                    <p>ÂºÄÂßãÊÇ®ÁöÑÁ¨¨‰∏ÄÊ¨°AI‰∏≠ÂåªÈóÆËØäÔºåÂª∫Á´ã‰∏ìÂ±ûÂÅ•Â∫∑Ê°£Ê°à</p>
                    <button class="btn-primary" onclick="startNewConsultation()">
                        üí¨ ÂºÄÂßãÈóÆËØä
                    </button>
                </div>
            `;
        }
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚ö†Ô∏è</div>
                    <h3>Âä†ËΩΩÂ§±Ë¥•</h3>
                    <p>${message}</p>
                    <button class="btn-primary" onclick="location.reload()">
                        üîÑ ÈáçÊñ∞Âä†ËΩΩ
                    </button>
                </div>
            `;
        }
        
        // Â∑•ÂÖ∑ÂáΩÊï∞
        function isRecentSession(dateString) {
            const sessionDate = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - sessionDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function filteredSessions() {
            if (currentFilter === 'all') {
                return allSessions;
            } else if (currentFilter === 'recent') {
                return allSessions.filter(session => isRecentSession(session.created_at));
            } else {
                return allSessions.filter(session => session.doctor_name === currentFilter);
            }
        }
        
        // ‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
        function toggleDoctorGroup(element) {
            element.classList.toggle('expanded');
        }
        
        function filterSessions(filter) {
            currentFilter = filter;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.filter-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ÈáçÊñ∞Ê∏≤Êüì
            renderSessionHistory();
        }
        
        function viewSession(sessionId) {
            // üîë Êñ∞‰øÆÂ§çÔºöÈáçÂÆöÂêëÂà∞‰∏ªÈóÆËØäÈ°µÈù¢Âπ∂ÊÅ¢Â§çÂÆåÊï¥ÂØπËØùÔºàÂåÖÊã¨Â∑≤Ëß£ÈîÅÂ§ÑÊñπÔºâ
            console.log('üîÑ ÈáçÂÆöÂêëÂà∞‰∏ªÈóÆËØäÈ°µÈù¢ÊÅ¢Â§çÂØπËØù:', sessionId);
            
            // Ë∑≥ËΩ¨Âà∞Êô∫ËÉΩÈóÆËØäÈ°µÈù¢Âπ∂‰º†ÈÄí‰ºöËØùID
            const restoreUrl = `/smart?restore_session=${encodeURIComponent(sessionId)}`;
            console.log('üìç ÊÅ¢Â§çURL:', restoreUrl);
            
            // Êñ∞Á™óÂè£ÊâìÂºÄÊàñÂΩìÂâçÁ™óÂè£Ë∑≥ËΩ¨
            if (confirm('ÊòØÂê¶Âú®Êñ∞Á™óÂè£‰∏≠Êü•ÁúãÂÆåÊï¥ÁöÑÈóÆËØäÂØπËØùÔºàÂåÖÊã¨Â∑≤Ëß£ÈîÅÁöÑÂ§ÑÊñπÂÜÖÂÆπÔºâÔºü\n\nÁÇπÂáª"Á°ÆÂÆö"Êñ∞Á™óÂè£ÊâìÂºÄÔºåÁÇπÂáª"ÂèñÊ∂à"ÂΩìÂâçÁ™óÂè£Ë∑≥ËΩ¨')) {
                window.open(restoreUrl, '_blank');
            } else {
                window.location.href = restoreUrl;
            }
        }
        
        // ÊòæÁ§∫ÂØπËØùËØ¶ÊÉÖ
        async function showConversationDetail(sessionId) {
            try {
                console.log('üîç Ëé∑ÂèñÂØπËØùËØ¶ÊÉÖ:', sessionId);
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const loadingModal = createLoadingModal('Ê≠£Âú®Âä†ËΩΩÂØπËØùËØ¶ÊÉÖ...');
                document.body.appendChild(loadingModal);
                
                // üîë ‰ªéÊúçÂä°Á´ØËé∑ÂèñÂÆåÊï¥ÁöÑÂØπËØùÊï∞ÊçÆ
                const response = await fetch(`/api/consultation/detail/${sessionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üìÑ Ëé∑ÂèñÂà∞ÁöÑÂØπËØùËØ¶ÊÉÖ:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Ëé∑ÂèñÂØπËØùËØ¶ÊÉÖÂ§±Ë¥•');
                }
                
                // Ëß£ÊûêËØ¶ÁªÜÁöÑÂØπËØùÊï∞ÊçÆ
                const conversationData = result.data;
                const detail = await parseConversationDetail(conversationData, sessionId);
                
                // ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
                loadingModal.remove();
                
                // ÊòæÁ§∫ËØ¶ÊÉÖÂºπÁ™ó
                displayConversationDetail(detail);
                
            } catch (error) {
                console.error('‚ùå Ëé∑ÂèñÂØπËØùËØ¶ÊÉÖÂ§±Ë¥•:', error);
                
                // ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
                const loadingModal = document.querySelector('.loading-modal');
                if (loadingModal) loadingModal.remove();
                
                // ÂõûÈÄÄÊñπÊ°àÔºö‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ
                const sessionDetail = allSessions.find(s => s.session_id === sessionId);
                if (sessionDetail) {
                    console.log('üîÑ ‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆÊòæÁ§∫Âü∫Êú¨‰ø°ÊÅØ');
                    const basicDetail = {
                        session_id: sessionDetail.session_id,
                        doctor_name: sessionDetail.doctor_name,
                        session_count: sessionDetail.session_count || 1,
                        chief_complaint: sessionDetail.chief_complaint || 'Êú™ËÆ∞ÂΩï',
                        created_at: sessionDetail.created_at,
                        status: sessionDetail.status || 'completed',
                        conversation_history: [],
                        diagnosis_summary: 'Êó†Ê≥ïËé∑ÂèñËØ¶ÁªÜËØäÊñ≠‰ø°ÊÅØ',
                        prescription_content: 'Êó†Ê≥ïËé∑ÂèñÂ§ÑÊñπ‰ø°ÊÅØ',
                        error_message: `Ëé∑ÂèñËØ¶ÊÉÖÂ§±Ë¥•: ${error.message}`
                    };
                    displayConversationDetail(basicDetail);
                } else {
                    alert('Ëé∑ÂèñÂØπËØùËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }
        }
        
        // üîë Êñ∞Â¢ûÔºöÂàõÂª∫Âä†ËΩΩÁä∂ÊÄÅÊ®°ÊÄÅÊ°Ü
        function createLoadingModal(message) {
            const modal = document.createElement('div');
            modal.className = 'modal loading-modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <div class="modal-body">
                        <div class="spinner" style="margin: 20px auto;"></div>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            return modal;
        }
        
        // üîë Êñ∞Â¢ûÔºöËß£ÊûêÂÆåÊï¥ÁöÑÂØπËØùËØ¶ÊÉÖ
        async function parseConversationDetail(conversationData, sessionId) {
            try {
                let conversationHistory = [];
                let chiefComplaint = 'Êú™ËÆ∞ÂΩï';
                let diagnosisSummary = 'ÂæÖÂÆåÂñÑ';
                let prescriptionContent = 'ÊöÇÊú™ÂºÄÊñπ';
                let patientSymptoms = [];
                let doctorAnalysis = '';
                
                // Ëß£Êûêconversation_log
                if (conversationData.conversation_log) {
                    const logData = JSON.parse(conversationData.conversation_log);
                    
                    if (logData.conversation_history && Array.isArray(logData.conversation_history)) {
                        conversationHistory = logData.conversation_history;
                        
                        // ÊèêÂèñÊÇ£ËÄÖÁóáÁä∂ÊèèËø∞ÔºàÊâÄÊúâÁî®Êà∑Ê∂àÊÅØÔºâ
                        conversationHistory.forEach(item => {
                            if (item.patient_query) {
                                patientSymptoms.push(item.patient_query);
                            }
                            if (item.ai_response) {
                                // ÊèêÂèñÂåªÁîüÁöÑÂàÜÊûêÂíåËØäÊñ≠
                                if (item.ai_response.includes('Ëæ®ËØÅ') || item.ai_response.includes('ËØäÊñ≠')) {
                                    doctorAnalysis = item.ai_response;
                                }
                                // ÊèêÂèñÂ§ÑÊñπÂÜÖÂÆπ
                                if (item.ai_response.includes('Â§ÑÊñπ') || item.ai_response.includes('ÊñπÂâÇ')) {
                                    prescriptionContent = item.ai_response;
                                }
                            }
                        });
                        
                        // È¶ñÊ¨°ÁóáÁä∂ÊèèËø∞‰Ωú‰∏∫‰∏ªËØâ
                        if (patientSymptoms.length > 0) {
                            chiefComplaint = patientSymptoms[0];
                        }
                        
                        // ÂåªÁîüÂàÜÊûê‰Ωú‰∏∫ËØäÊñ≠ÊëòË¶Å
                        if (doctorAnalysis) {
                            diagnosisSummary = doctorAnalysis;
                        }
                    }
                }
                
                return {
                    session_id: sessionId,
                    doctor_name: conversationData.selected_doctor_id,
                    session_count: 1,
                    chief_complaint: chiefComplaint,
                    created_at: conversationData.created_at,
                    updated_at: conversationData.updated_at,
                    status: conversationData.status || 'completed',
                    conversation_history: conversationHistory,
                    patient_symptoms: patientSymptoms,
                    diagnosis_summary: diagnosisSummary,
                    prescription_content: prescriptionContent,
                    message_count: conversationHistory.length,
                    total_patient_messages: patientSymptoms.length,
                    has_prescription: prescriptionContent !== 'ÊöÇÊú™ÂºÄÊñπ'
                };
                
            } catch (error) {
                console.error('Ëß£ÊûêÂØπËØùÊï∞ÊçÆÂ§±Ë¥•:', error);
                return {
                    session_id: sessionId,
                    error_message: 'Ëß£ÊûêÂØπËØùÊï∞ÊçÆÂ§±Ë¥•: ' + error.message
                };
            }
        }
        
        // üîë ËæÖÂä©ÂáΩÊï∞Ôºö‰ªéÊ∂àÊÅØ‰∏≠ÊèêÂèñ‰∏ªËØâ
        function extractChiefComplaint(messages) {
            if (!messages || messages.length === 0) return 'Êú™ËÆ∞ÂΩï';
            // Ëé∑ÂèñÁ¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ‰Ωú‰∏∫‰∏ªËØâ
            const firstUserMessage = messages.find(m => m.sender === 'user');
            return firstUserMessage ? firstUserMessage.content.substring(0, 50) + '...' : 'Êú™ËÆ∞ÂΩï';
        }
        
        // ÊòæÁ§∫ÂØπËØùËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function displayConversationDetail(detail) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // Ê†ºÂºèÂåñÂåªÁîü‰ø°ÊÅØ
            const doctorName = doctorInfo[detail.doctor_name]?.name || detail.doctor_name;
            const doctorSchool = doctorInfo[detail.doctor_name]?.school || '‰∏≠Âåª';
            
            // Ê†ºÂºèÂåñÊó∂Èó¥‰ø°ÊÅØ
            const visitDate = new Date(detail.created_at).toLocaleString('zh-CN');
            const updateDate = new Date(detail.updated_at).toLocaleString('zh-CN');
            const duration = detail.duration_minutes ? `${detail.duration_minutes}ÂàÜÈíü` : 'Êó†ËÆ∞ÂΩï';
            
            // Â§ÑÁêÜÁóáÁä∂‰ø°ÊÅØ
            const symptomsText = detail.symptoms_summary || detail.chief_complaint || 'ÊÇ£ËÄÖÊú™Êèê‰æõËØ¶ÁªÜÁóáÁä∂ÊèèËø∞';
            const shortenedSymptoms = symptomsText.length > 150 ? symptomsText.substring(0, 150) + '...' : symptomsText;
            
            // üîë ‰øÆÂ§çÔºöÊòæÁ§∫ÂÆûÈôÖÁöÑËØäÊñ≠‰ø°ÊÅØËÄå‰∏çÊòØÊ®°ÊùøÂÜÖÂÆπ
            const diagnosisText = detail.diagnosis && detail.diagnosis !== 'Âü∫‰∫éÊÇ£ËÄÖÁóáÁä∂ÁöÑ‰∏≠ÂåªËæ®ËØÅÂàÜÊûê' 
                ? detail.diagnosis 
                : (detail.diagnosis_summary || 'Âü∫‰∫éÊÇ£ËÄÖÁóáÁä∂ÁöÑ‰∏≠ÂåªËæ®ËØÅÂàÜÊûê');
            const syndromeText = detail.syndrome && detail.syndrome !== 'ÂæÖËøõ‰∏ÄÊ≠•Ëæ®ËØÅÂàÜÊûê'
                ? detail.syndrome 
                : 'ÂæÖËøõ‰∏ÄÊ≠•Ëæ®ËØÅÂàÜÊûê';
            
            // Â§ÑÁêÜÂ§ÑÊñπ‰ø°ÊÅØ
            const prescriptionSection = detail.prescription ? `
                <div class="detail-section prescription-section">
                    <h3>üåø ‰∏≠ÂåªÂ§ÑÊñπ</h3>
                    <div class="prescription-content">
                        <div class="prescription-text">${detail.prescription}</div>
                        ${detail.prescription_info ? `
                            <div class="prescription-meta">
                                <div class="prescription-fee">
                                    <span class="fee-label">Â§ÑÊñπË¥πÁî®:</span>
                                    <span class="fee-amount">¬•${detail.prescription_info.prescription_fee || '88.00'}</span>
                                </div>
                                <div class="payment-status ${detail.prescription_info.payment_status}">
                                    ${detail.prescription_info.payment_status === 'paid' ? '‚úÖ Â∑≤ÊîØ‰ªò' : 
                                      detail.prescription_info.payment_status === 'pending' ? '‚è≥ ÂæÖÊîØ‰ªò' : '‚ùå Êú™ÊîØ‰ªò'}
                                </div>
                                <div class="prescription-visibility">
                                    ${detail.prescription_info.is_visible ? 'üëÅÔ∏è ÊÇ£ËÄÖÂèØËßÅ' : 'üîí ÊîØ‰ªòÂêéÂèØËßÅ'}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : '<div class="detail-section"><h3>üåø ‰∏≠ÂåªÂ§ÑÊñπ</h3><p class="no-prescription">Êú¨Ê¨°ÈóÆËØäÊú™ÂºÄÂÖ∑Â§ÑÊñπ</p></div>';
            
            // Â§ÑÁêÜÂØπËØùÂéÜÂè≤
            const conversationHistory = detail.conversation_history && detail.conversation_history.length > 0 ? 
                detail.conversation_history.map((conv, index) => `
                    <div class="conversation-turn">
                        <div class="patient-message">
                            <strong>ÊÇ£ËÄÖ (Á¨¨${index + 1}ËΩÆ):</strong>
                            <p>${conv.patient_query}</p>
                        </div>
                        <div class="doctor-message">
                            <strong>${doctorName}:</strong>
                            <p>${conv.ai_response}</p>
                        </div>
                        <div class="turn-timestamp">${new Date(conv.timestamp).toLocaleString('zh-CN')}</div>
                    </div>
                `).join('')
                : '<p>ÊöÇÊó†ËØ¶ÁªÜÂØπËØùËÆ∞ÂΩï</p>';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                    <div class="modal-header">
                        <h2>üìã ÈóÆËØäËØ¶ÊÉÖ - ${doctorName} (${doctorSchool})</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Âü∫Êú¨‰ø°ÊÅØÂç°Áâá -->
                        <div class="detail-section info-card">
                            <h3>üìä Âü∫Êú¨‰ø°ÊÅØ</h3>
                            <div class="detail-grid">
                                <div class="info-item">
                                    <span class="info-label">ÂºÄÂßãÊó∂Èó¥:</span>
                                    <span class="info-value">${visitDate}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ÊúÄÂêéÊõ¥Êñ∞:</span>
                                    <span class="info-value">${updateDate}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ÈóÆËØäÊó∂Èïø:</span>
                                    <span class="info-value">${duration}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ÂØπËØùËΩÆÊ¨°:</span>
                                    <span class="info-value">${detail.total_rounds || 0}ËΩÆ</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ÈóÆËØäÁä∂ÊÄÅ:</span>
                                    <span class="info-value status-badge ${detail.status}">
                                        ${detail.status === 'completed' ? '‚úÖ Â∑≤ÂÆåÊàê' : 
                                          detail.status === 'in_progress' ? '‚è≥ ËøõË°å‰∏≠' : '‚ùì Êú™Áü•'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- ÊÇ£ËÄÖÁóáÁä∂ÊèèËø∞ -->
                        <div class="detail-section symptoms-section">
                            <h3>ü©∫ ÊÇ£ËÄÖÁóáÁä∂ÊèèËø∞</h3>
                            <div class="symptoms-content">
                                <div class="chief-complaint">
                                    <h4>‰∏ªËØâÔºö</h4>
                                    <p>${detail.chief_complaint || 'Êú™ËÆ∞ÂΩï‰∏ªËØâ'}</p>
                                </div>
                                <div class="symptoms-detail">
                                    <h4>ËØ¶ÁªÜÁóáÁä∂Ôºö</h4>
                                    <div class="symptoms-text">
                                        <p class="symptoms-preview">${shortenedSymptoms}</p>
                                        ${symptomsText.length > 150 ? `
                                            <div class="symptoms-full" style="display: none;">
                                                <p>${symptomsText}</p>
                                            </div>
                                            <button class="toggle-symptoms" onclick="toggleSymptomsDetail(this)">
                                                Êü•ÁúãÂÆåÊï¥ÁóáÁä∂ÊèèËø∞
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ‰∏≠ÂåªËæ®ËØÅÂÜÖÂÆπ -->
                        <div class="detail-section diagnosis-section">
                            <h3>‚öñÔ∏è ‰∏≠ÂåªËæ®ËØÅÂàÜÊûê</h3>
                            <div class="diagnosis-content">
                                <div class="diagnosis-item">
                                    <h4>ËØäÊñ≠ÁªìÊûúÔºö</h4>
                                    <p>${diagnosisText}</p>
                                </div>
                                <div class="syndrome-item">
                                    <h4>ËØÅÂÄôÂàÜÊûêÔºö</h4>
                                    <p>${syndromeText}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Â§ÑÊñπÂÜÖÂÆπ -->
                        ${prescriptionSection}

                        <!-- ÂØπËØùËÆ∞ÂΩï -->
                        <div class="detail-section conversation-section">
                            <h3>üí¨ ÂÆåÊï¥ÂØπËØùËÆ∞ÂΩï</h3>
                            <div class="conversation-history">
                                ${conversationHistory}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="this.closest('.modal').remove()">ÂÖ≥Èó≠</button>
                        <button class="btn-action" onclick="shareConversation('${detail.session_id}')">üîó ÂàÜ‰∫´</button>
                        <button class="btn-action" onclick="exportConversation('${detail.session_id}')">üìÑ ÂØºÂá∫</button>
                        ${detail.prescription ? `
                            <button class="btn-primary" onclick="viewPrescriptionDetail('${detail.session_id}')">üíä Êü•ÁúãÂ§ÑÊñπËØ¶ÊÉÖ</button>
                        ` : ''}
                    </div>
                </div>

                <style>
                /* ËØ¶ÊÉÖÂºπÁ™óÊ†∑ÂºèÂ¢ûÂº∫ */
                .detail-section {
                    margin-bottom: 25px;
                    padding: 20px;
                    background: #f8f9ff;
                    border-radius: 12px;
                    border: 1px solid #e1e8f0;
                }

                .detail-section h3 {
                    margin: 0 0 15px 0;
                    color: #2c3e50;
                    font-size: 18px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #667eea;
                }

                .detail-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                }

                .info-item {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }

                .info-label {
                    font-weight: bold;
                    color: #666;
                    font-size: 14px;
                }

                .info-value {
                    color: #333;
                    font-size: 16px;
                }

                .status-badge {
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: bold;
                }

                .status-badge.completed {
                    background: #d4edda;
                    color: #155724;
                }

                .status-badge.in_progress {
                    background: #fff3cd;
                    color: #856404;
                }

                .symptoms-content h4, .diagnosis-content h4 {
                    margin: 10px 0 8px 0;
                    color: #2c3e50;
                    font-size: 16px;
                }

                .symptoms-text p {
                    line-height: 1.6;
                    color: #444;
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #e1e8f0;
                }

                .toggle-symptoms {
                    background: #667eea;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    margin-top: 10px;
                    transition: background 0.3s;
                }

                .toggle-symptoms:hover {
                    background: #5a67d8;
                }

                .prescription-content {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #e1e8f0;
                }

                .prescription-text {
                    font-family: 'Courier New', monospace;
                    line-height: 1.8;
                    color: #2c3e50;
                    margin-bottom: 15px;
                    white-space: pre-wrap;
                }

                .prescription-meta {
                    display: flex;
                    gap: 20px;
                    align-items: center;
                    padding-top: 15px;
                    border-top: 1px solid #e1e8f0;
                    font-size: 14px;
                }

                .fee-amount {
                    font-weight: bold;
                    color: #e74c3c;
                    font-size: 16px;
                }

                .payment-status.paid {
                    color: #27ae60;
                    font-weight: bold;
                }

                .payment-status.pending {
                    color: #f39c12;
                    font-weight: bold;
                }

                .no-prescription {
                    color: #666;
                    font-style: italic;
                    text-align: center;
                    padding: 20px;
                }

                .conversation-turn {
                    margin-bottom: 20px;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                    border: 1px solid #e1e8f0;
                }

                .patient-message, .doctor-message {
                    margin-bottom: 10px;
                }

                .patient-message strong {
                    color: #3498db;
                }

                .doctor-message strong {
                    color: #27ae60;
                }

                .turn-timestamp {
                    font-size: 12px;
                    color: #888;
                    text-align: right;
                    margin-top: 10px;
                    padding-top: 8px;
                    border-top: 1px solid #f0f0f0;
                }

                .btn-action {
                    background: #667eea;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: background 0.3s;
                    margin-left: 10px;
                }

                .btn-action:hover {
                    background: #5a67d8;
                }
                </style>
            `;
            
            document.body.appendChild(modal);
        }
        
        // ÂØºÂá∫Âçï‰∏™ÂØπËØù
        async function exportConversation(sessionId) {
            try {
                const response = await fetch(`/api/user/conversation/${sessionId}/export`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TCM_ÁóÖÂéÜ_${sessionId.slice(0,8)}_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                } else {
                    console.error('ÂØºÂá∫Â§±Ë¥•:', response.status, await response.text());
                    alert('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                alert('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            }
        }
        
        function upgradeAccount() {
            // Ë∑≥ËΩ¨Âà∞ÊâãÊú∫ÁªëÂÆöÈ°µÈù¢
            window.open('/phone-binding', '_blank');
        }
        
        function exportHistory() {
            // ÂØºÂá∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï
            if (allSessions.length === 0) {
                alert('ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩïÂèØÂØºÂá∫');
                return;
            }
            
            // ÁîüÊàêÂπ∂‰∏ãËΩΩÊëòË¶ÅÊä•Âëä
            const summary = generateSummaryReport();
            downloadTextFile(summary, `TCM_ÂéÜÂè≤ËÆ∞ÂΩïÊëòË¶Å_${new Date().toISOString().split('T')[0]}.txt`);
        }
        
        // ÁîüÊàêÊëòË¶ÅÊä•Âëä
        function generateSummaryReport() {
            const stats = {
                totalSessions: allSessions.length,
                doctorCount: new Set(allSessions.map(s => s.doctor_name)).size,
                recentSessions: allSessions.filter(s => isRecentSession(s.created_at)).length
            };
            
            let report = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `        TCM AI‰∏≠ÂåªÊô∫ËÉΩÈóÆËØäÂéÜÂè≤ËÆ∞ÂΩïÊëòË¶Å\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            report += `„ÄêÁªüËÆ°‰ø°ÊÅØ„Äë\n`;
            report += `ÊÄªÈóÆËØäÊ¨°Êï∞: ${stats.totalSessions}Ê¨°\n`;
            report += `Âí®ËØ¢ÂåªÁîüÊï∞: ${stats.doctorCount}‰Ωç\n`;
            report += `ÊúÄËøë7Â§©: ${stats.recentSessions}Ê¨°\n`;
            report += `ÂØºÂá∫Êó∂Èó¥: ${new Date().toLocaleString('zh-CN')}\n\n`;
            
            // ÊåâÂåªÁîüÂàÜÁªÑ
            const sessionsByDoctor = groupSessionsByDoctor(allSessions);
            report += `„ÄêÂàÜÂåªÁîüËÆ∞ÂΩï„Äë\n`;
            
            for (const [doctorName, sessions] of Object.entries(sessionsByDoctor)) {
                const doctor = doctorInfo[doctorName] || { name: doctorName, description: '' };
                report += `\n${doctor.name} (${sessions.length}Ê¨°ÈóÆËØä)\n`;
                report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                sessions.slice(0, 5).forEach((session, index) => {
                    const date = new Date(session.created_at).toLocaleDateString('zh-CN');
                    report += `${index + 1}. ${date} - ${session.chief_complaint || 'ÁóáÁä∂Âí®ËØ¢'}\n`;
                });
                
                if (sessions.length > 5) {
                    report += `   ... ËøòÊúâ${sessions.length - 5}Ê¨°ËÆ∞ÂΩï\n`;
                }
            }
            
            report += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `ü§ñ Áî±TCM AI‰∏≠ÂåªÊô∫ËÉΩËØäÁñóÁ≥ªÁªüÁîüÊàê\n`;
            report += `‚ö†Ô∏è Ê≠§‰∏∫AIËæÖÂä©ËØäÁñóËÆ∞ÂΩïÔºå‰ªÖ‰æõÂèÇËÄÉ\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            
            return report;
        }
        
        // ‰∏ãËΩΩÊñáÊú¨Êñá‰ª∂
        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        async function clearHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÈóÆËØäÂéÜÂè≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                try {
                    console.log('üóëÔ∏è ÂºÄÂßãÊ∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï...');
                    
                    const headers = getAuthHeaders();
                    console.log('üîë ‰ΩøÁî®ÁöÑËØ∑Ê±ÇÂ§¥:', headers);
                    
                    const response = await fetch('/api/user/sessions/clear', {
                        method: 'DELETE',
                        headers: headers
                    });
                    
                    console.log('üì° Ê∏ÖÁ©∫APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Ê∏ÖÁ©∫APIÂìçÂ∫î:', result);
                        alert(result.message || 'Ê∏ÖÁ©∫ÊàêÂäü');
                        
                        // Ê∏ÖÁ©∫Êú¨Âú∞ÊòæÁ§∫
                        allSessions = [];
                        updateHistoryDisplay();
                        updateStatistics({ total_sessions: 0, doctor_count: 0, usage_days: 0 });
                        
                        // ÈáçÊñ∞Âä†ËΩΩ
                        await loadSessionHistory();
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Ê∏ÖÁ©∫APIÈîôËØØÂìçÂ∫î:', errorText);
                        
                        try {
                            const error = JSON.parse(errorText);
                            alert('Ê∏ÖÁ©∫Â§±Ë¥•: ' + (error.detail || error.message || 'Êú™Áü•ÈîôËØØ'));
                        } catch {
                            alert('Ê∏ÖÁ©∫Â§±Ë¥•: HTTP ' + response.status);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Ê∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩïÂºÇÂ∏∏:', error);
                    alert('Ê∏ÖÁ©∫Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•: ' + error.message);
                }
            }
        }
        
        function startNewConsultation() {
            // üîë ‰øÆÂ§çÔºöË∑≥ËΩ¨Âà∞Êô∫ËÉΩÈóÆËØäÈ°µÈù¢Âπ∂‰øùÊåÅÁôªÂΩïÁä∂ÊÄÅ
            console.log('üîÑ ÂºÄÂßãÊñ∞ÈóÆËØäÔºåÂΩìÂâçÁî®Êà∑:', currentUser);
            
            // Á°Æ‰øùÁî®Êà∑ËÆ§ËØÅ‰ø°ÊÅØÂÆåÊï¥‰º†ÈÄí
            if (currentUser && currentUser.user_id) {
                // Êê∫Â∏¶Áî®Êà∑‰ø°ÊÅØË∑≥ËΩ¨Âà∞Êô∫ËÉΩÈóÆËØäÈ°µÈù¢
                const smartUrl = `/smart?user_id=${encodeURIComponent(currentUser.user_id)}`;
                console.log('üìç Ë∑≥ËΩ¨URL:', smartUrl);
                window.location.href = smartUrl;
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑‰ø°ÊÅØÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞Êô∫ËÉΩÈóÆËØäÈ°µÈù¢
                console.log('üìç Êó†Áî®Êà∑‰ø°ÊÅØÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞Êô∫ËÉΩÈóÆËØäÈ°µÈù¢');
                window.location.href = '/smart';
            }
        }
        
        // ========== ËÆæÂ§áÁÆ°ÁêÜÂäüËÉΩ ==========
        
        // ÊòæÁ§∫ËÆæÂ§áÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
        async function showDeviceManagement() {
            const modal = document.getElementById('deviceModal');
            modal.style.display = 'block';
            
            // Âä†ËΩΩËÆæÂ§áÂàóË°®
            await loadDeviceList();
        }
        
        // ÂÖ≥Èó≠ËÆæÂ§áÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
        function closeDeviceModal() {
            document.getElementById('deviceModal').style.display = 'none';
        }
        
        // Âä†ËΩΩËÆæÂ§áÂàóË°®
        async function loadDeviceList() {
            const deviceList = document.getElementById('deviceList');
            
            try {
                const response = await fetch('/api/user/devices', {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.devices.length > 0) {
                        renderDeviceList(data.devices);
                    } else {
                        showEmptyDeviceList();
                    }
                } else {
                    throw new Error('Ëé∑ÂèñËÆæÂ§áÂàóË°®Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÆæÂ§áÂàóË°®Â§±Ë¥•:', error);
                showDeviceError('Âä†ËΩΩËÆæÂ§áÂàóË°®Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Ê∏≤ÊüìËÆæÂ§áÂàóË°®
        function renderDeviceList(devices) {
            const deviceList = document.getElementById('deviceList');
            
            let html = '';
            devices.forEach((device, index) => {
                const isCurrentClass = device.is_current ? 'current' : '';
                const statusClass = device.is_current ? 'current' : 'inactive';
                const statusText = device.is_current ? 'ÂΩìÂâçËÆæÂ§á' : 'ÈùûÊ¥ªË∑É';
                
                html += `
                    <div class="device-item ${isCurrentClass}">
                        <div class="device-info">
                            <div class="device-name">${device.device_name}</div>
                            <div class="device-details">
                                ÊåáÁ∫π: ${device.device_fingerprint}<br>
                                È¶ñÊ¨°ÁôªÂΩï: ${formatDate(device.first_login)}<br>
                                ÊúÄÂêéÊ¥ªË∑É: ${formatDate(device.last_active)}
                            </div>
                        </div>
                        <div class="device-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            });
            
            deviceList.innerHTML = html;
        }
        
        // ÊòæÁ§∫Á©∫ËÆæÂ§áÂàóË°®
        function showEmptyDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üì±</div>
                    <h3>ÊöÇÊó†ËÆæÂ§áËÆ∞ÂΩï</h3>
                    <p>ÂΩìÊÇ®Âú®‰∏çÂêåËÆæÂ§á‰∏ä‰ΩøÁî®Êó∂ÔºåËøôÈáå‰ºöÊòæÁ§∫ËÆæÂ§áÂàóË°®</p>
                </div>
            `;
        }
        
        // ÊòæÁ§∫ËÆæÂ§áÁÆ°ÁêÜÈîôËØØ
        function showDeviceError(message) {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚ö†Ô∏è</div>
                    <h3>Âä†ËΩΩÂ§±Ë¥•</h3>
                    <p>${message}</p>
                    <button class="btn-primary" onclick="loadDeviceList()">ÈáçÊñ∞Âä†ËΩΩ</button>
                </div>
            `;
        }
        
        // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
        async function refreshDevices() {
            await loadDeviceList();
        }
        
        // ========== ËØ¶ÊÉÖÂºπÁ™óËæÖÂä©ÂáΩÊï∞ ==========
        
        // ÂàáÊç¢ÁóáÁä∂ËØ¶ÁªÜÊèèËø∞ÊòæÁ§∫
        function toggleSymptomsDetail(button) {
            const symptomsText = button.closest('.symptoms-text');
            const preview = symptomsText.querySelector('.symptoms-preview');
            const full = symptomsText.querySelector('.symptoms-full');
            
            if (full.style.display === 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
                button.textContent = 'Êî∂Ëµ∑ÁóáÁä∂ÊèèËø∞';
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
                button.textContent = 'Êü•ÁúãÂÆåÊï¥ÁóáÁä∂ÊèèËø∞';
            }
        }
        
        // ÂàÜ‰∫´ÂØπËØùÂäüËÉΩ
        async function shareConversation(sessionId) {
            try {
                // ÁîüÊàêÂàÜ‰∫´ÈìæÊé•
                const shareUrl = `${window.location.origin}/shared/conversation/${sessionId}`;
                
                // Â¶ÇÊûúÊîØÊåÅWeb Share APIÔºå‰ΩøÁî®ÂéüÁîüÂàÜ‰∫´
                if (navigator.share) {
                    await navigator.share({
                        title: 'TCM AI ÈóÆËØäËÆ∞ÂΩï',
                        text: 'ÊàëÊÉ≥ÂàÜ‰∫´‰∏Ä‰∏™‰∏≠ÂåªAIÈóÆËØäËÆ∞ÂΩï',
                        url: shareUrl
                    });
                } else {
                    // Âê¶ÂàôÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(shareUrl);
                        alert('ÂàÜ‰∫´ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    } else {
                        // ÊòæÁ§∫ÂàÜ‰∫´ÈìæÊé•
                        prompt('ËØ∑Â§çÂà∂‰∏ãÈù¢ÁöÑÂàÜ‰∫´ÈìæÊé•:', shareUrl);
                    }
                }
            } catch (error) {
                console.error('ÂàÜ‰∫´Â§±Ë¥•:', error);
                if (error.name !== 'AbortError') {
                    alert('ÂàÜ‰∫´Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }
        }
        
        // Êü•ÁúãÂ§ÑÊñπËØ¶ÊÉÖ
        async function viewPrescriptionDetail(sessionId) {
            try {
                const response = await fetch(`/api/prescription/detail/${sessionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñÂ§ÑÊñπËØ¶ÊÉÖÂ§±Ë¥•');
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    showPrescriptionModal(result.data);
                } else {
                    alert('ÊöÇÊó†Â§ÑÊñπËØ¶ÊÉÖÊàñÂ§ÑÊñπÊú™ÊîØ‰ªò');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂ§ÑÊñπËØ¶ÊÉÖÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÂ§ÑÊñπËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÊòæÁ§∫Â§ÑÊñπËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function showPrescriptionModal(prescriptionData) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const paymentStatusText = {
                'paid': '‚úÖ Â∑≤ÊîØ‰ªò',
                'pending': '‚è≥ ÂæÖÊîØ‰ªò',
                'failed': '‚ùå ÊîØ‰ªòÂ§±Ë¥•'
            };
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>üíä Â§ÑÊñπËØ¶ÊÉÖ</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="prescription-detail">
                            <div class="prescription-meta-info">
                                <div class="meta-row">
                                    <span class="meta-label">Â§ÑÊñπÁºñÂè∑:</span>
                                    <span class="meta-value">${prescriptionData.prescription_id}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">ÂºÄÊñπÂåªÁîü:</span>
                                    <span class="meta-value">${prescriptionData.doctor_name}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">ÂºÄÊñπÊó∂Èó¥:</span>
                                    <span class="meta-value">${new Date(prescriptionData.created_at).toLocaleString('zh-CN')}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">ÊîØ‰ªòÁä∂ÊÄÅ:</span>
                                    <span class="meta-value payment-status ${prescriptionData.payment_status}">
                                        ${paymentStatusText[prescriptionData.payment_status] || 'Êú™Áü•Áä∂ÊÄÅ'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="prescription-content-detail">
                                <h3>üåø ËçØÊñπÈÖç‰ºç</h3>
                                <div class="prescription-herbs">
                                    ${prescriptionData.ai_prescription || 'Â§ÑÊñπÂÜÖÂÆπ'}
                                </div>
                            </div>
                            
                            <div class="diagnosis-content-detail">
                                <h3>‚öñÔ∏è ËØäÊñ≠ËØ¥Êòé</h3>
                                <div class="diagnosis-text">
                                    ${prescriptionData.diagnosis || 'ÊöÇÊó†ËØäÊñ≠ËØ¥Êòé'}
                                </div>
                            </div>
                            
                            ${prescriptionData.payment_status === 'pending' ? `
                                <div class="payment-section">
                                    <h3>üí∞ Ë¥πÁî®‰ø°ÊÅØ</h3>
                                    <div class="fee-info">
                                        <span class="fee-label">Â§ÑÊñπË¥πÁî®:</span>
                                        <span class="fee-amount">¬•${prescriptionData.prescription_fee || '88.00'}</span>
                                    </div>
                                    <button class="btn-primary pay-now-btn" onclick="proceedToPayment('${prescriptionData.prescription_id}')">
                                        Á´ãÂç≥ÊîØ‰ªò
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="this.closest('.modal').remove()">ÂÖ≥Èó≠</button>
                        <button class="btn-action" onclick="exportPrescription('${prescriptionData.prescription_id}')">üìÑ ÂØºÂá∫Â§ÑÊñπ</button>
                    </div>
                </div>
                
                <style>
                .prescription-detail .meta-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 10px;
                    padding: 8px 0;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .meta-label {
                    font-weight: bold;
                    color: #666;
                }
                
                .meta-value {
                    color: #333;
                }
                
                .prescription-herbs, .diagnosis-text {
                    background: #f8f9ff;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #e1e8f0;
                    line-height: 1.8;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                    white-space: pre-wrap;
                }
                
                .payment-section {
                    margin-top: 20px;
                    padding: 15px;
                    background: #fff3cd;
                    border-radius: 8px;
                    border: 1px solid #ffeaa7;
                }
                
                .fee-info {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                    font-size: 16px;
                }
                
                .pay-now-btn {
                    width: 100%;
                    padding: 12px;
                    font-size: 16px;
                    font-weight: bold;
                }
                </style>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Â§ÑÁêÜÊîØ‰ªò
        function proceedToPayment(prescriptionId) {
            // Ë∑≥ËΩ¨Âà∞ÊîØ‰ªòÈ°µÈù¢
            window.location.href = `/payment?prescription_id=${prescriptionId}`;
        }
        
        // ÂØºÂá∫Â§ÑÊñπ
        async function exportPrescription(prescriptionId) {
            try {
                const response = await fetch(`/api/prescription/export/${prescriptionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Â§ÑÊñπ_${prescriptionId}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    throw new Error('ÂØºÂá∫Â§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂØºÂá∫Â§ÑÊñπÂ§±Ë¥•:', error);
                alert('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('deviceModal');
            if (event.target === modal) {
                closeDeviceModal();
            }
        }
    </script>
</body>
</html>