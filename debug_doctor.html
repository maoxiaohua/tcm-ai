<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医生工作台调试</title>
</head>
<body>
    <h1>医生工作台调试页面</h1>
    <div id="debug-info"></div>
    <div id="user-info">正在加载用户信息...</div>
    
    <script>
        console.log('Debug page loaded');
        
        // 检查用户认证 - 简化版
        async function checkAuth() {
            console.log('checkAuth started');
            const token = localStorage.getItem('session_token') || localStorage.getItem('doctorToken');
            console.log('Token found:', !!token, token ? token.substring(0, 10) + '...' : 'none');
            
            if (!token) {
                document.getElementById('user-info').innerHTML = 'No token found, redirecting...';
                console.log('No token, would redirect to login');
                return;
            }

            try {
                console.log('Making API call to /api/v2/auth/profile');
                const response = await fetch('/api/v2/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (data.success && data.user) {
                        document.getElementById('user-info').innerHTML = `
                            <h3>用户信息加载成功</h3>
                            <p>用户名: ${data.user.display_name}</p>
                            <p>角色: ${data.user.primary_role}</p>
                            <p>状态: ${data.user.account_status}</p>
                        `;
                        console.log('User info updated successfully');
                    } else {
                        throw new Error('用户信息无效: ' + JSON.stringify(data));
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(`API调用失败: ${response.status} ${errorText}`);
                }
            } catch (error) {
                console.error('认证检查失败:', error);
                document.getElementById('user-info').innerHTML = `
                    <h3>认证失败</h3>
                    <p>错误: ${error.message}</p>
                `;
            }
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting checkAuth');
            document.getElementById('debug-info').innerHTML = 'DOM加载完成，开始认证检查...';
            checkAuth();
        });
        
        // 显示调试信息
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            document.getElementById('debug-info').innerHTML += `<br>JavaScript错误: ${e.message}`;
        });
    </script>
</body>
</html>