# TCM-AI å¼€å‘æŒ‡å¯¼å’Œé”™è¯¯é˜²èŒƒæ‰‹å†Œ

## ğŸ“‹ å¸¸è§é”™è¯¯åŠé˜²èŒƒæªæ–½

### ğŸš¨ é«˜é¢‘é”™è¯¯æ¸…å•

#### 1. APIç«¯ç‚¹å‘½åé”™è¯¯
**é”™è¯¯æ¨¡å¼**: 
- å†™æˆ `/chat` ä½†å®é™…åº”è¯¥æ˜¯ `/chat_with_ai`
- å†™æˆ `/api/chat` ä½†å®é™…åº”è¯¥æ˜¯ `/api/consultation/chat`

**é˜²èŒƒæªæ–½**:
```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
fetch('/chat', { ... })  // ä¼šå¯¼è‡´404

// âœ… æ­£ç¡®åšæ³• - å…ˆç¡®è®¤ç«¯ç‚¹
// æ™ºèƒ½å·¥ä½œæµç¨‹ä½¿ç”¨ç»Ÿä¸€é—®è¯ŠæœåŠ¡
fetch('/api/consultation/chat', { ... })

// åŸç³»ç»Ÿå…¼å®¹æ¥å£
fetch('/chat_with_ai', { ... })
```

**æ£€æŸ¥æ¸…å•**:
- [ ] ç¡®è®¤ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿï¼ˆæ™ºèƒ½å·¥ä½œæµç¨‹ vs åŸç³»ç»Ÿï¼‰
- [ ] æ£€æŸ¥ API è·¯ç”±è¡¨ä¸­çš„å®é™…ç«¯ç‚¹åç§°
- [ ] æµ‹è¯•æ—¶å…ˆç”¨ curl éªŒè¯ç«¯ç‚¹å­˜åœ¨

#### 2. å‚æ•°æ ¼å¼ä¸åŒ¹é…
**é”™è¯¯æ¨¡å¼**:
- å‰ç«¯ä¼ é€’æ•°å­—ID (`"1", "2"`) ä½†åç«¯æœŸæœ›åŒ»ç”Ÿåç§° (`"zhang_zhongjing"`)
- å‰ç«¯ä¼ é€’ `selected_doctor` ä½†åç«¯æœŸæœ› `doctor_name`

**é˜²èŒƒæªæ–½**:
```javascript
// âŒ é”™è¯¯ç¤ºä¾‹  
{
  selected_doctor: "1"  // æ•°å­—ID
}

// âœ… æ­£ç¡®åšæ³• - ä½¿ç”¨æ˜ å°„
const doctorIdMapping = {
  '1': 'zhang_zhongjing',
  '2': 'ye_tianshi'
};

{
  selected_doctor: doctorIdMapping[selectedDoctorId] || 'zhang_zhongjing'
}
```

**æ£€æŸ¥æ¸…å•**:
- [ ] ç¡®è®¤å‰ç«¯ä¼ é€’çš„å‚æ•°åç§°å’Œæ ¼å¼
- [ ] ç¡®è®¤åç«¯æœŸæœ›çš„å‚æ•°åç§°å’Œæ ¼å¼  
- [ ] æ£€æŸ¥æ˜¯å¦éœ€è¦IDæ˜ å°„æˆ–æ ¼å¼è½¬æ¢

#### 3. å“åº”æ•°æ®ç»“æ„ä¸åŒ¹é…
**é”™è¯¯æ¨¡å¼**:
- æœŸæœ› `data.reply` ä½†å®é™…æ˜¯ `reply`
- æœŸæœ›ç®€å•å¯¹è±¡ä½†å®é™…æ˜¯åµŒå¥—åœ¨ `data` ä¸­

**é˜²èŒƒæªæ–½**:
```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
const data = await response.json();
addMessage('ai', data.reply);  // data.reply å¯èƒ½ä¸å­˜åœ¨

// âœ… æ­£ç¡®åšæ³• - å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
const result = await response.json();
let reply;

if (result.success && result.data) {
  // ç»Ÿä¸€é—®è¯ŠæœåŠ¡æ ¼å¼
  reply = result.data.reply;
} else if (result.reply) {
  // åŸç³»ç»Ÿæ ¼å¼
  reply = result.reply;
} else {
  reply = 'ç³»ç»Ÿæš‚æ—¶æ— æ³•å“åº”';
}

addMessage('ai', reply);
```

#### 4. æ•°æ®åº“å­—æ®µåç§°é”™è¯¯
**é”™è¯¯æ¨¡å¼**:
- æŸ¥è¯¢ä¸­ä½¿ç”¨ `uuid` ä½†è¡¨ä¸­å­—æ®µæ˜¯ `id`
- æŸ¥è¯¢ä¸­ä½¿ç”¨ `specialties` ä½†è¡¨ä¸­å­—æ®µæ˜¯ `speciality`

**é˜²èŒƒæªæ–½**:
```sql
-- âŒ é”™è¯¯ç¤ºä¾‹
SELECT * FROM doctors WHERE uuid = ?  -- uuid å­—æ®µä¸å­˜åœ¨

-- âœ… æ­£ç¡®åšæ³• - å…ˆæ£€æŸ¥è¡¨ç»“æ„
-- ä½¿ç”¨ï¼šsqlite3 database.sqlite ".schema doctors"
SELECT * FROM doctors WHERE id = ?
```

**æ£€æŸ¥æ¸…å•**:
- [ ] ä½¿ç”¨ `.schema table_name` ç¡®è®¤è¡¨ç»“æ„
- [ ] æ³¨æ„å•å¤æ•°å½¢å¼ (specialty vs specialties)
- [ ] ç¡®è®¤å­—æ®µç±»å‹æ˜¯å¦åŒ¹é…

#### 5. å¤„æ–¹å†…å®¹æœªæ­£ç¡®éšè—é”™è¯¯
**é”™è¯¯æ¨¡å¼**:
- å¤„æ–¹å†…å®¹ç›´æ¥æ˜¾ç¤ºç»™æ‚£è€…ï¼Œè€Œä¸æ˜¯ä»˜è´¹åæ‰æ˜¾ç¤º
- `addMessage` å‡½æ•°çš„ `hidePrescription` é»˜è®¤å€¼è®¾ç½®ä¸å½“
- å¤„æ–¹æ£€æµ‹é€»è¾‘å­˜åœ¨ä½†æœªæ­£ç¡®è°ƒç”¨

**é˜²èŒƒæªæ–½**:
```javascript
// âŒ é”™è¯¯ç¤ºä¾‹ - é»˜è®¤éšè—æ‰€æœ‰å†…å®¹
function addMessage(sender, content, hidePrescription = true) {
    // è¿™æ ·ä¼šé»˜è®¤éšè—æ‰€æœ‰AIå›å¤
}

// âœ… æ­£ç¡®åšæ³• - æ˜ç¡®æŒ‡å®šä½•æ—¶éšè—å¤„æ–¹
function addMessage(sender, content, hidePrescription = false) {
    // åªåœ¨æ˜ç¡®æ£€æµ‹åˆ°å®Œæ•´å¤„æ–¹æ—¶æ‰éšè—
}

// è°ƒç”¨æ—¶æ˜ç¡®ä¼ é€’éšè—å‚æ•°
let needsPayment = false;
if (data.stage === 'prescription' && data.contains_prescription) {
    needsPayment = true;
} else if (containsPrescriptionContent(reply) && !isTemporaryAdvice(reply)) {
    needsPayment = true;
}
addMessage('ai', reply, needsPayment);
```

**å…·ä½“ä¿®å¤å®ä¾‹**:
```javascript
// å¤„æ–¹å…³é”®è¯å¿…é¡»åŒ…å«ä¸­åŒ»ç‰¹è‰²æ ¼å¼
const prescriptionKeywords = [
    'å¤„æ–¹å¦‚ä¸‹', 'æ–¹å‰‚ç»„æˆ', 'è¯ç‰©ç»„æˆ', 'å…·ä½“æ–¹è¯',
    'æ–¹è§£', 'å›è¯', 'è‡£è¯', 'ä½è¯', 'ä½¿è¯',
    'ã€å›è¯ã€‘', 'ã€è‡£è¯ã€‘', 'ã€ä½è¯ã€‘', 'ã€ä½¿è¯ã€‘',  // å…³é”®ï¼šä¸­æ–‡æ ‡è®°æ ¼å¼
    'ä¸‰ã€å¤„æ–¹å»ºè®®'  // å…³é”®ï¼šç»“æ„åŒ–æ ‡é¢˜æ ¼å¼
];

// æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿè¦åŒæ­¥æ›´æ–°
const prescriptionStart = content.search(/(?:å¤„æ–¹å¦‚ä¸‹|æ–¹å‰‚ç»„æˆ|ã€å›è¯ã€‘|ã€è‡£è¯ã€‘|ã€ä½è¯ã€‘|ã€ä½¿è¯ã€‘|ä¸‰ã€å¤„æ–¹å»ºè®®)/);
```

**æ£€æŸ¥æ¸…å•**:
- [ ] ç¡®è®¤ `addMessage` å‡½æ•°é»˜è®¤å€¼è®¾ç½®æ­£ç¡®
- [ ] éªŒè¯å¤„æ–¹æ£€æµ‹é€»è¾‘è¢«æ­£ç¡®è°ƒç”¨
- [ ] ç¡®ä¿ `containsPrescriptionContent` å’Œ `maskPrescriptionContent` ä½¿ç”¨ç›¸åŒçš„å…³é”®è¯
- [ ] æµ‹è¯•æ”¯ä»˜æµç¨‹å’Œå¤„æ–¹è§£é”åŠŸèƒ½
- [ ] ç¡®ä¿ä¸´æ—¶å»ºè®®ä¸ä¼šè§¦å‘æ”¯ä»˜
- [ ] éªŒè¯ä¸­æ–‡æ ‡è®°æ ¼å¼ã€å›è¯ã€‘ã€è‡£è¯ã€‘ç­‰è¢«æ­£ç¡®è¯†åˆ«

#### 6. åŒ»ç”Ÿé—®è¯Šè´¨é‡å·®å¼‚é—®é¢˜
**é”™è¯¯æ¨¡å¼**:
- ä¸åŒåŒ»ç”Ÿçš„é—®è¯Šæ·±åº¦å·®å¼‚å¾ˆå¤§ï¼Œæœ‰äº›åŒ»ç”Ÿç›´æ¥ç»™å‡ºå¤„æ–¹ä¸è¯¦ç»†é—®è¯Š
- ä¸´æ—¶å»ºè®®å…³é”®è¯ä¸å…¨é¢ï¼Œé—æ¼"å¾…è¡¥å……èˆŒè±¡ä¿¡æ¯åç¡®è®¤"ç­‰è¡¨è¿°
- AIæç¤ºè¯ä¸­åŒ…å«"ç§¯æå¼€æ–¹"ç­‰å¯¼è‡´è¿‡æ—©å¤„æ–¹çš„æŒ‡å¯¼

**é˜²èŒƒæªæ–½**:
```python
# æ‰©å±•ä¸´æ—¶å»ºè®®å…³é”®è¯ï¼Œè¦†ç›–æ›´å¤šè¡¨è¿°
temporary_keywords = [
    'åˆæ­¥å¤„æ–¹å»ºè®®', 'å¾…ç¡®è®¤', 'è‹¥æ‚¨èƒ½æä¾›', 'è¯·è¡¥å……', 
    'éœ€è¦äº†è§£', 'å»ºè®®è¿›ä¸€æ­¥', 'å®Œå–„ä¿¡æ¯å', 'è¯¦ç»†æè¿°',
    'æš‚æ‹Ÿæ–¹è¯', 'åˆæ­¥è€ƒè™‘', 'å¾…è¯¦è¯Šå', 'å¾…è¡¥å……',
    'è¡¥å……èˆŒè±¡', 'èˆŒè±¡ä¿¡æ¯å', 'è„‰è±¡ä¿¡æ¯å', 'ä¸Šä¼ èˆŒè±¡',  # å…³é”®è¡¥å……
    'æä¾›èˆŒè±¡', 'ç¡®è®¤å¤„æ–¹', 'åç¡®è®¤', 'æš‚æ‹Ÿå¤„æ–¹'
]

# åŒ»ç”Ÿäººæ ¼çš„æ€ç»´æ¨¡å¼å¼ºè°ƒè¯¦ç»†é—®è¯Š
thinking_pattern = "....**é—®è¯ŠåŸåˆ™ï¼šå¾ªåºæ¸è¿›ï¼Œä»ä¸»ç—‡åˆ°å…¼ç—‡ï¼Œä»ç°åœ¨åˆ°æ—¢å¾€ï¼Œå¿…é¡»è¯¦ç»†äº†è§£æ‚£è€…çš„åŸºæœ¬ä¿¡æ¯ã€ç—‡çŠ¶ç‰¹ç‚¹ã€èˆŒè±¡è„‰è±¡ã€ç—…å²ç­‰ï¼Œä¿¡æ¯å……åˆ†åæ‰èƒ½ç»™å‡ºå‡†ç¡®è¯Šæ–­å’Œå¤„æ–¹ã€‚å®å¯å¤šé—®å‡ è½®ï¼Œä¹Ÿä¸å¯è‰ç‡å¼€æ–¹**"
```

**AIæç¤ºè¯ä¼˜åŒ–**:
```python
# ç§»é™¤å¯¼è‡´æ€¥äºå¼€æ–¹çš„æŒ‡å¯¼
âŒ "ç§¯æå¼€æ–¹: åœ¨ç—‡çŠ¶å’Œä½“å¾ä¿¡æ¯å……è¶³æ—¶ï¼Œåº”ç»™å‡ºå…·ä½“çš„æ²»ç–—æ–¹æ¡ˆ"
âœ… "å¾ªåºæ¸è¿›é—®è¯Š: éœ€è¦å……åˆ†äº†è§£æ‚£è€…ä¿¡æ¯ï¼Œéµå¾ªä¸­åŒ»å››è¯Šåˆå‚çš„ä¼ ç»Ÿ"

âŒ "ä¸€æ¬¡æ€§é—®è¯ŠåŸåˆ™ï¼šé¿å…åå¤å¤šè½®é—®è¯Š"  
âœ… "å¾ªåºæ¸è¿›é—®è¯Šï¼šéµå¾ªä¸­åŒ»ä¼ ç»Ÿï¼Œä»ä¸»ç—‡åˆ°å…¼ç—‡ï¼Œé€æ­¥äº†è§£ç—…æƒ…"

âŒ "åº”è¯¥ä¸€æ¬¡æ€§è¯¢é—®æ‰€ç¼ºå¤±çš„å…³é”®ä¿¡æ¯ï¼Œè€Œéå¼ºåˆ¶å¼€æ–¹"
âœ… "åº”è¯¥å¾ªåºæ¸è¿›åœ°æ·±å…¥é—®è¯Šï¼Œä½“ç°ä¸­åŒ»è¯¦ç»†é—®è¯Šçš„ç‰¹è‰²"
```

**æ£€æŸ¥æ¸…å•**:
- [ ] ç¡®ä¿ä¸´æ—¶å»ºè®®å…³é”®è¯è¦†ç›–ä¸­åŒ»ç‰¹è‰²è¡¨è¿°
- [ ] éªŒè¯åŒ»ç”Ÿäººæ ¼çš„æ€ç»´æ¨¡å¼å¼ºè°ƒè¯¦ç»†é—®è¯Š
- [ ] ç§»é™¤AIæç¤ºè¯ä¸­"ç§¯æå¼€æ–¹"ç›¸å…³æŒ‡å¯¼
- [ ] æµ‹è¯•ä¸åŒåŒ»ç”Ÿçš„é—®è¯Šæ·±åº¦æ˜¯å¦ä¸€è‡´
- [ ] ç¡®è®¤èˆŒè±¡ç›¸å…³çš„ä¸´æ—¶å»ºè®®è¢«æ­£ç¡®è¯†åˆ«

#### 7. å¤„æ–¹å…³é”®è¯é—æ¼å¯¼è‡´éšè—å¤±æ•ˆ
**é”™è¯¯æ¨¡å¼**:
- ç³»ç»Ÿç”ŸæˆåŒ…å«"å¤„æ–¹æ–¹æ¡ˆ"ã€"æ²»ç–—æ–¹æ¡ˆ"çš„å†…å®¹ä½†æœªè¢«éšè—
- å…³é”®è¯æ£€æµ‹ä¸å…¨é¢ï¼Œé—æ¼å¸¸è§çš„å¤„æ–¹è¡¨è¿°æ ¼å¼
- å‰ç«¯å’Œåç«¯çš„å¤„æ–¹å…³é”®è¯ä¸åŒæ­¥

**é˜²èŒƒæªæ–½**:
```javascript
// å‰ç«¯å¤„æ–¹å…³é”®è¯å¿…é¡»å…¨é¢è¦†ç›–
const prescriptionKeywords = [
    'å¤„æ–¹å¦‚ä¸‹', 'æ–¹å‰‚ç»„æˆ', 'è¯ç‰©ç»„æˆ', 'å…·ä½“æ–¹è¯',
    'æ–¹è§£', 'å›è¯', 'è‡£è¯', 'ä½è¯', 'ä½¿è¯',
    'ã€å›è¯ã€‘', 'ã€è‡£è¯ã€‘', 'ã€ä½è¯ã€‘', 'ã€ä½¿è¯ã€‘',
    'ä¸‰ã€å¤„æ–¹å»ºè®®', 
    'å¤„æ–¹æ–¹æ¡ˆ', 'æ²»ç–—æ–¹æ¡ˆ', 'ç”¨è¯æ–¹æ¡ˆ'  // ğŸ¯ å…³é”®è¡¥å……
];

// æ­£åˆ™è¡¨è¾¾å¼åŒæ­¥æ›´æ–°
const prescriptionStart = content.search(/(?:å¤„æ–¹å¦‚ä¸‹|æ–¹å‰‚ç»„æˆ|å¤„æ–¹æ–¹æ¡ˆ|æ²»ç–—æ–¹æ¡ˆ|ç”¨è¯æ–¹æ¡ˆ)/);
```

```python
# åç«¯ç»Ÿä¸€é—®è¯ŠæœåŠ¡åŒæ­¥æ›´æ–°
prescription_keywords = [
    'å¤„æ–¹å¦‚ä¸‹', 'æ–¹å‰‚ç»„æˆ', 'è¯ç‰©ç»„æˆ', 'å…·ä½“æ–¹è¯',
    'æ–¹è§£', 'å›è¯', 'è‡£è¯', 'ä½è¯', 'ä½¿è¯',
    'å¤„æ–¹æ–¹æ¡ˆ', 'æ²»ç–—æ–¹æ¡ˆ', 'ç”¨è¯æ–¹æ¡ˆ',  # ğŸ¯ å…³é”®è¡¥å……
    'ã€å›è¯ã€‘', 'ã€è‡£è¯ã€‘', 'ã€ä½è¯ã€‘', 'ã€ä½¿è¯ã€‘'
]
```

**æ£€æŸ¥æ¸…å•**:
- [ ] æ”¶é›†AIå®é™…è¾“å‡ºçš„å¤„æ–¹æ ¼å¼è¡¨è¿°
- [ ] ç¡®ä¿å‰åç«¯å¤„æ–¹å…³é”®è¯åˆ—è¡¨å®Œå…¨ä¸€è‡´
- [ ] æµ‹è¯•æ‰€æœ‰å¯èƒ½çš„å¤„æ–¹è¡¨è¿°æ ¼å¼
- [ ] éªŒè¯æ­£åˆ™è¡¨è¾¾å¼åŒ…å«æ‰€æœ‰å…³é”®è¯
- [ ] è¿›è¡Œå›å½’æµ‹è¯•ç¡®ä¿ä¿®å¤æœ‰æ•ˆ

#### 8. AIè¿‡åº¦é—®è¯Šé—®é¢˜
**é”™è¯¯æ¨¡å¼**:
- AIåœ¨æ‚£è€…æä¾›å……åˆ†ä¿¡æ¯æ—¶ä»è¦æ±‚æ›´å¤šç»†èŠ‚
- å¼€æ–¹æ¡ä»¶è¿‡äºä¸¥æ ¼ï¼Œè¦æ±‚è„‰è±¡ç­‰éš¾ä»¥è·å¾—çš„ä¿¡æ¯
- å¿½è§†å·²æœ‰ä¿¡æ¯çš„å®Œæ•´æ€§å’Œå……åˆ†æ€§

**é˜²èŒƒæªæ–½**:
```python
# AIæç¤ºè¯ä¸­æ˜ç¡®ä¿¡æ¯å……åˆ†æ ‡å‡†
"**ä¿¡æ¯å……åˆ†æ ‡å‡†**ï¼šå½“æ‚£è€…æä¾›äº†ä¸»è¦ç—‡çŠ¶ï¼ˆä½ç½®ã€æ€§è´¨ã€æ—¶é—´ï¼‰+ ä¼´éšç—‡çŠ¶ + èˆŒè±¡æè¿° + åŸºæœ¬çš„é£Ÿæ¬²ç¡çœ äºŒä¾¿æƒ…å†µ + ç›¸å…³ç—…å²æ—¶ï¼Œå³å¯è¿›è¡Œè¾¨è¯è®ºæ²»ï¼Œä¸å¿…è¿‡åˆ†è¿½æ±‚è„‰è±¡ç­‰éš¾ä»¥è·å¾—çš„ä¿¡æ¯"

# è°ƒæ•´å¼€æ–¹æ¡ä»¶
"**å¼€æ–¹æ¡ä»¶**ï¼šä¸»è¦ç—‡çŠ¶æ¸…æ¥š + èˆŒè±¡æ˜ç¡®ï¼ˆæˆ–æœ‰è¯¦ç»†æè¿°ï¼‰+ è¯å‹åŸºæœ¬ç¡®å®šã€‚ä¸å¿…æ‹˜æ³¥äºè„‰è±¡ï¼Œå¯æ ¹æ®ç—‡çŠ¶å’ŒèˆŒè±¡è¿›è¡Œè¾¨è¯"
```

**ç”¨æˆ·æµ‹è¯•æ¡ˆä¾‹**:
```
ç”¨æˆ·æä¾›: å¤´ç—›ä½ç½®+æ€§è´¨+æ—¶é—´+ä¼´éšç—‡çŠ¶+èˆŒè±¡+é£Ÿæ¬²ç¡çœ +ç—…å²+è¯±å‘å› ç´ 
æœŸæœ›ç»“æœ: åº”ç»™å‡ºè¯Šæ–­å’Œå¤„æ–¹ï¼Œä¸å†è¦æ±‚è„‰è±¡ã€æ±—å‡ºç­‰
å®é™…ç»“æœ: âŒ ä»è¦æ±‚è¡¥å……è„‰è±¡ç­‰ä¿¡æ¯
ä¿®å¤å: âœ… ä¿¡æ¯å……åˆ†æ—¶ç»™å‡ºè¾¨è¯è®ºæ²»
```

**æ£€æŸ¥æ¸…å•**:
- [ ] æµ‹è¯•å…¸å‹ç—…ä¾‹çš„é—®è¯Šè½®æ•°æ˜¯å¦åˆç†
- [ ] éªŒè¯AIèƒ½è¯†åˆ«ä¿¡æ¯å……åˆ†çš„æƒ…å†µ
- [ ] ç¡®ä¿ä¸åŒåŒ»ç”Ÿçš„é—®è¯Šæ·±åº¦ä¸€è‡´
- [ ] å¹³è¡¡è¯¦ç»†é—®è¯Šä¸ç”¨æˆ·ä½“éªŒ

#### 9. æ”¯ä»˜åå¤„æ–¹è§£é”åŠŸèƒ½å¤±æ•ˆ
**é”™è¯¯æ¨¡å¼**:
- æ”¯ä»˜æˆåŠŸåå¤„æ–¹å†…å®¹æ²¡æœ‰è¢«æ­£ç¡®è§£é”æ˜¾ç¤º
- åªæ˜¾ç¤ºæ”¯ä»˜æˆåŠŸæç¤ºï¼Œä½†éšè—çš„å¤„æ–¹ä¾ç„¶ä¸å¯è§
- åŸå§‹å¤„æ–¹å†…å®¹æ²¡æœ‰è¢«ä¿å­˜ï¼Œæ— æ³•åœ¨æ”¯ä»˜åæ¢å¤

**é˜²èŒƒæªæ–½**:
```javascript
// åœ¨éšè—å¤„æ–¹æ—¶ä¿å­˜åŸå§‹å†…å®¹
if (hidePrescription) {
    // ä¿å­˜åŸå§‹å†…å®¹åˆ°dataå±æ€§ä¸­ï¼Œç”¨äºæ”¯ä»˜åè§£é”
    messageDiv.setAttribute('data-original-content', formattedContent);
    formattedContent = maskPrescriptionContent(formattedContent);
    messageDiv.classList.add('prescription-hidden');  // æ·»åŠ æ ‡è®°ç±»
}

// æ”¯ä»˜æˆåŠŸåæ¢å¤åŸå§‹å†…å®¹
function paymentSuccess() {
    const hiddenPrescriptionMessages = document.querySelectorAll('.message.prescription-hidden');
    hiddenPrescriptionMessages.forEach(messageDiv => {
        const originalContent = messageDiv.getAttribute('data-original-content');
        if (originalContent) {
            const messageContent = messageDiv.querySelector('.message-bubble');
            messageContent.innerHTML = originalContent;  // æ¢å¤å®Œæ•´å†…å®¹
            messageDiv.classList.remove('prescription-hidden');
        }
    });
}
```

**æµ‹è¯•éªŒè¯**:
```
æ“ä½œæ­¥éª¤:
1. åŒ»ç”Ÿæä¾›å®Œæ•´å¤„æ–¹ï¼ˆåŒ…å«å›è‡£ä½ä½¿åˆ†ç±»ï¼‰
2. ç¡®è®¤å¤„æ–¹å†…å®¹è¢«éšè—ï¼Œæ˜¾ç¤ºä»˜è´¹æç¤º
3. ç‚¹å‡»"æŸ¥çœ‹å¤„æ–¹è¯¦æƒ…"å¼¹å‡ºæ”¯ä»˜æ¨¡æ€æ¡†
4. é€‰æ‹©å¾®ä¿¡/æ”¯ä»˜å®è¿›è¡Œæ¨¡æ‹Ÿæ”¯ä»˜
5. æ”¯ä»˜æˆåŠŸåéªŒè¯å¤„æ–¹å†…å®¹æ˜¯å¦å®Œæ•´æ˜¾ç¤º

æœŸæœ›ç»“æœ:
- âœ… æ”¯ä»˜å‰ï¼šå¤„æ–¹å†…å®¹è¢«éšè—
- âœ… æ”¯ä»˜åï¼šå®Œæ•´å¤„æ–¹å†…å®¹æ˜¾ç¤ºï¼ŒåŒ…å«æ‰€æœ‰è¯ç‰©ã€å‰‚é‡ã€å›è‡£ä½ä½¿åˆ†ç±»
- âœ… è§£é”æç¤ºï¼šæ˜¾ç¤º"æ”¯ä»˜æˆåŠŸè§£é”"æ ‡è¯†
```

**æ£€æŸ¥æ¸…å•**:
- [ ] ç¡®è®¤å¤„æ–¹éšè—æ—¶åŸå§‹å†…å®¹è¢«æ­£ç¡®ä¿å­˜
- [ ] éªŒè¯æ”¯ä»˜æˆåŠŸåèƒ½æ‰¾åˆ°éšè—çš„å¤„æ–¹æ¶ˆæ¯
- [ ] æµ‹è¯•åŸå§‹å†…å®¹èƒ½è¢«å®Œæ•´æ¢å¤æ˜¾ç¤º
- [ ] ç¡®è®¤è§£é”åçš„è§†è§‰åé¦ˆæ˜ç¡®
- [ ] éªŒè¯å¤šæ¡å¤„æ–¹æ¶ˆæ¯çš„æ‰¹é‡è§£é”åŠŸèƒ½

#### 10. åŒ»ç”Ÿå›ç­”æ ¼å¼ä¸ä¸€è‡´é—®é¢˜
**é”™è¯¯æ¨¡å¼**:
- ä¸åŒåŒ»ç”Ÿçš„å›ç­”ç»“æ„å’Œæ ¼å¼å­˜åœ¨æ˜æ˜¾å·®å¼‚
- éƒ¨åˆ†åŒ»ç”Ÿç¼ºä¹ç»“æ„åŒ–çš„è¾¨è¯è®ºæ²»å†…å®¹
- åŒ»ç”Ÿäººæ ¼çš„æ€ç»´æ¨¡å¼æŒ‡å¯¼è¿‡äºç®€å•ï¼Œç¼ºä¹å…·ä½“æŒ‡å¯¼

**é˜²èŒƒæªæ–½**:
```python
# åŒ»ç”Ÿäººæ ¼çš„æ€ç»´æ¨¡å¼éœ€è¦è¯¦ç»†å…·ä½“
âŒ thinking_pattern="é‡è§†é˜³æ°”ï¼Œè®¤ä¸ºä¸‡ç—…çš†ç”±é˜³æ°”ä¸è¶³æ‰€è‡´"  # è¿‡äºç®€å•

âœ… thinking_pattern="é‡è§†é˜³æ°”ï¼Œè®¤ä¸ºä¸‡ç—…çš†ç”±é˜³æ°”ä¸è¶³æ‰€è‡´ã€‚**é—®è¯ŠåŸåˆ™ï¼šè¯¦ç»†äº†è§£é˜³è™šç—‡çŠ¶ï¼ŒåŒ…æ‹¬å››è‚¢å¥å†·ã€ç¥ç–²ä¹åŠ›ã€è„‰è±¡æ²‰å¾®ç­‰ã€‚éœ€å……åˆ†æ”¶é›†é˜³è™šè¯å€™ä¿¡æ¯ï¼Œç¡®å®šé˜³æ°”è¡°å¾®ç¨‹åº¦åæ‰èƒ½åˆç†è¿ç”¨æ‰¶é˜³è¯ç‰©ã€‚æ‰¶é˜³ç”¨è¯é¡»è°¨æ…ï¼Œä¿¡æ¯ä¸å…¨æ—¶ä¸åº”æ€¥äºå¼€æ–¹ï¼Œéœ€ç»§ç»­é—®è¯Šä»¥æ˜ç¡®é˜³è™šç¨‹åº¦å’Œå…·ä½“ç—…ä½**"
```

**ç»Ÿä¸€æ ¼å¼è¦æ±‚**:
```markdown
æœŸæœ›çš„åŒ»ç”Ÿå›ç­”æ ¼å¼åº”åŒ…å«ï¼š
1. **é—®è¯Šä¿¡æ¯æ”¶é›†çŠ¶å†µ** - å½“å‰å·²è·å¾—çš„ä¿¡æ¯æ€»ç»“
2. **å¾ªåºæ¸è¿›é—®è¯Š** - ç»“æ„åŒ–çš„è¿½é—®å†…å®¹
3. **åˆæ­¥è¾¨è¯åˆ†æ** - åŸºäºå·²æœ‰ä¿¡æ¯çš„åˆæ­¥åˆ¤æ–­
4. **ä¸‹ä¸€æ­¥æŒ‡å¯¼** - æ˜ç¡®çš„åç»­é—®è¯Šæˆ–è¯Šç–—æ–¹å‘

é¿å…æ ¼å¼ï¼š
- ç®€å•çš„ä¸€é—®ä¸€ç­”
- ç¼ºä¹ä¸­åŒ»ç†è®ºæ”¯æ’‘çš„å†…å®¹
- æ²¡æœ‰ä½“ç°åŒ»ç”Ÿæµæ´¾ç‰¹è‰²çš„é€šç”¨å›ç­”
```

**æ£€æŸ¥æ¸…å•**:
- [ ] éªŒè¯æ‰€æœ‰åŒ»ç”Ÿçš„thinking_patternéƒ½åŒ…å«è¯¦ç»†é—®è¯ŠæŒ‡å¯¼
- [ ] ç¡®ä¿åŒ»ç”Ÿå›ç­”ä½“ç°æµæ´¾ç‰¹è‰²ï¼ˆæ‰¶é˜³æ´¾ã€æ»‹é˜´æ´¾ç­‰ï¼‰
- [ ] æµ‹è¯•å›ç­”æ ¼å¼çš„ä¸€è‡´æ€§å’Œç»“æ„åŒ–ç¨‹åº¦
- [ ] éªŒè¯å››è¯Šåˆå‚çš„å®Œæ•´ä½“ç°

#### 11. æ”¯ä»˜è§£é”åŠŸèƒ½è°ƒè¯•å¢å¼º
**è°ƒè¯•ç­–ç•¥**:
ä¸ºäº†è§£å†³æŒç»­çš„æ”¯ä»˜è§£é”é—®é¢˜ï¼Œå·²å¢åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼š

```javascript
function paymentSuccess() {
    console.log('ğŸ” å¼€å§‹æ”¯ä»˜è§£é”è°ƒè¯•...');
    const hiddenPrescriptionMessages = document.querySelectorAll('.message.prescription-hidden');
    console.log(`ğŸ” æ‰¾åˆ° ${hiddenPrescriptionMessages.length} ä¸ªéšè—çš„å¤„æ–¹æ¶ˆæ¯`);
    
    // è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯è¾“å‡º
    const allAIMessages = document.querySelectorAll('.message.ai');
    allAIMessages.forEach((msg, i) => {
        const hasOriginalContent = msg.hasAttribute('data-original-content');
        const isPrescriptionHidden = msg.classList.contains('prescription-hidden');
        console.log(`ğŸ” æ¶ˆæ¯${i+1}: æœ‰åŸå§‹å†…å®¹=${hasOriginalContent}, æœ‰éšè—æ ‡è®°=${isPrescriptionHidden}`);
    });
}
```

**æµ‹è¯•æ­¥éª¤**:
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. è¿›è¡Œå®Œæ•´çš„é—®è¯Šè·å¾—å¤„æ–¹
3. ç¡®è®¤å¤„æ–¹è¢«éšè—
4. æ‰§è¡Œæ”¯ä»˜æµç¨‹
5. æ£€æŸ¥æ§åˆ¶å°è°ƒè¯•è¾“å‡º
6. åˆ†ææ”¯ä»˜è§£é”å¤±è´¥çš„å…·ä½“åŸå› 

#### 12. é—®è¯Šæµç¨‹çŠ¶æ€åˆ¤æ–­é”™è¯¯
**é”™è¯¯æ¨¡å¼**:
- ä¸´æ—¶å»ºè®®ï¼ˆ"åˆæ­¥å¤„æ–¹å»ºè®®ï¼ˆå¾…ç¡®è®¤ï¼‰"ï¼‰è¢«è¯¯åˆ¤ä¸ºå®Œæ•´å¤„æ–¹
- é—®è¯Šæœªç»“æŸå°±è§¦å‘æ”¯ä»˜æµç¨‹ï¼Œé˜»æ–­ç”¨æˆ·ç»§ç»­è¡¥å……ä¿¡æ¯

**é˜²èŒƒæªæ–½**:
```javascript
// âŒ é”™è¯¯ç¤ºä¾‹ - ç®€å•å…³é”®è¯åŒ¹é…
function containsPrescription(text) {
  return text.includes('å¤„æ–¹') || text.includes('å…‹');
}

// âœ… æ­£ç¡®åšæ³• - åŒºåˆ†ä¸´æ—¶å»ºè®®å’Œå®Œæ•´å¤„æ–¹
function containsPrescriptionContent(text) {
  // æ£€æŸ¥ä¸´æ—¶å»ºè®®å…³é”®è¯
  const temporaryKeywords = ['å¾…ç¡®è®¤', 'è‹¥æ‚¨èƒ½æä¾›', 'è¯·è¡¥å……'];
  if (temporaryKeywords.some(keyword => text.includes(keyword))) {
    return false;  // ä¸´æ—¶å»ºè®®ï¼Œä¸ç®—å®Œæ•´å¤„æ–¹
  }
  
  // åŒæ—¶æ£€æŸ¥å¤„æ–¹å…³é”®è¯å’Œå…·ä½“å‰‚é‡
  const hasKeywords = ['å¤„æ–¹å¦‚ä¸‹', 'æ–¹å‰‚ç»„æˆ'].some(k => text.includes(k));
  const hasDosage = /\d+[å…‹g]\s*[ï¼Œ,]/.test(text);
  
  return hasKeywords && hasDosage;
}
```

**æ£€æŸ¥æ¸…å•**:
- [ ] åŒºåˆ†ä¸´æ—¶å»ºè®®å’Œå®Œæ•´å¤„æ–¹
- [ ] ç¡®è®¤é—®è¯ŠçŠ¶æ€åˆ¤æ–­é€»è¾‘æ­£ç¡®
- [ ] æµ‹è¯•æ”¯ä»˜æµç¨‹è§¦å‘æ—¶æœº
- [ ] éªŒè¯ç”¨æˆ·å¯ä»¥ç»§ç»­è¡¥å……ä¿¡æ¯

#### 6. å‰ç«¯äº‹ä»¶ç»‘å®šæ—¶æœºé”™è¯¯
**é”™è¯¯æ¨¡å¼**:
- DOM å…ƒç´ è¿˜æœªåŠ è½½å®Œæˆå°±ç»‘å®šäº‹ä»¶
- å¼‚æ­¥åŠ è½½å†…å®¹çš„äº‹ä»¶ç›‘å¬å™¨ä¸¢å¤±

**é˜²èŒƒæªæ–½**:
```javascript
// âŒ é”™è¯¯ç¤ºä¾‹ - DOMå¯èƒ½è¿˜æœªåŠ è½½
document.getElementById('button').onclick = handler;

// âœ… æ­£ç¡®åšæ³• - ç¡®ä¿DOMåŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
  const button = document.getElementById('button');
  if (button) {
    button.onclick = handler;
  }
});

// âœ… æ›´å®‰å…¨çš„åšæ³• - å»¶è¿Ÿç»‘å®š
setTimeout(function() {
  const button = document.getElementById('button');
  if (button) {
    button.onclick = handler;
  }
}, 1000);
```

### ğŸ”§ å¼€å‘æœ€ä½³å®è·µ

#### 1. APIå¼€å‘æµç¨‹
```bash
# æ ‡å‡†å¼€å‘æµç¨‹
1. ç¡®è®¤éœ€æ±‚ â†’ æ˜ç¡®è¾“å…¥è¾“å‡ºæ ¼å¼
2. æ£€æŸ¥ç°æœ‰API â†’ é¿å…é‡å¤é€ è½®å­  
3. è®¾è®¡æ¥å£ â†’ ç»Ÿä¸€å‘½åè§„èŒƒ
4. å®ç°åç«¯ â†’ åŒ…å«å®Œæ•´é”™è¯¯å¤„ç†
5. æµ‹è¯•æ¥å£ â†’ ä½¿ç”¨curléªŒè¯
6. å‰ç«¯é›†æˆ â†’ å¤„ç†å„ç§å“åº”æƒ…å†µ
7. é›†æˆæµ‹è¯• â†’ ç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯
```

#### 2. æ•°æ®åº“æ“ä½œè§„èŒƒ
```python
# æ ‡å‡†æ•°æ®åº“æ“ä½œæ¨¡å¼
try:
    with sqlite3.connect(db_path) as conn:
        conn.row_factory = sqlite3.Row  # ä½¿ç”¨å­—å…¸å¼è®¿é—®
        cursor = conn.execute(query, params)
        results = cursor.fetchall()
        
        # å¤„ç†ç»“æœæ—¶æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
        for row in results:
            name = row.get('name', 'Unknown')  # å®‰å…¨è®¿é—®
            # å¤„ç†JSONå­—æ®µæ—¶è¦æœ‰å¼‚å¸¸å¤„ç†
            try:
                specialties = json.loads(row['specialties'] or '[]')
            except (json.JSONDecodeError, KeyError):
                specialties = []
                
except sqlite3.Error as e:
    logger.error(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
    return []
```

#### 3. å‰ç«¯é”™è¯¯å¤„ç†è§„èŒƒ
```javascript
// æ ‡å‡†fetchè¯·æ±‚æ¨¡å¼
async function makeAPIRequest(url, data) {
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    // å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
    if (result.success !== undefined) {
      // æ–°APIæ ¼å¼
      return result.success ? result.data : { error: result.message };
    } else {
      // åŸAPIæ ¼å¼  
      return result;
    }
    
  } catch (error) {
    console.error('APIè¯·æ±‚å¤±è´¥:', error);
    return { error: error.message };
  }
}
```

### ğŸ” è°ƒè¯•æŠ€å·§å’Œå·¥å…·

#### 1. å¿«é€Ÿé—®é¢˜å®šä½
```bash
# åç«¯è°ƒè¯•
journalctl -u tcm-ai.service -f  # å®æ—¶æŸ¥çœ‹æ—¥å¿—
curl -X GET "http://localhost:8000/docs"  # æŸ¥çœ‹APIæ–‡æ¡£

# å‰ç«¯è°ƒè¯•
æµè§ˆå™¨F12 â†’ Console  # æŸ¥çœ‹JavaScripté”™è¯¯
æµè§ˆå™¨F12 â†’ Network  # æŸ¥çœ‹APIè¯·æ±‚å“åº”

# æ•°æ®åº“è°ƒè¯•  
sqlite3 database.sqlite ".schema"  # æŸ¥çœ‹è¡¨ç»“æ„
sqlite3 database.sqlite "SELECT * FROM table LIMIT 5;"  # æŸ¥çœ‹æ•°æ®æ ·ä¾‹
```

#### 2. å¸¸ç”¨éªŒè¯å‘½ä»¤
```bash
# APIç«¯ç‚¹éªŒè¯
curl -X GET "http://localhost:8000/api/consultation/service-status"

# æ•°æ®åº“è¿æ¥éªŒè¯
sqlite3 /opt/tcm-ai/data/user_history.sqlite "SELECT COUNT(*) FROM doctors;"

# æœåŠ¡çŠ¶æ€éªŒè¯
systemctl status tcm-ai
```

### ğŸ“ ä»£ç å®¡æŸ¥æ¸…å•

#### æ¯æ¬¡ä¿®æ”¹å‰æ£€æŸ¥
- [ ] æ˜¯å¦ä¸ç°æœ‰ç³»ç»Ÿå†²çªï¼Ÿ
- [ ] å‚æ•°æ ¼å¼æ˜¯å¦åŒ¹é…ï¼Ÿ
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦å®Œæ•´ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ•°æ®åº“è¿ç§»ï¼Ÿ
- [ ] å‰åç«¯æ¥å£æ˜¯å¦å¯¹é½ï¼Ÿ

#### æ¯æ¬¡ä¿®æ”¹åéªŒè¯
- [ ] APIç«¯ç‚¹æ˜¯å¦å¯ä»¥è®¿é—®ï¼Ÿ
- [ ] å‰ç«¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºï¼Ÿ
- [ ] é”™è¯¯æƒ…å†µæ˜¯å¦å¦¥å–„å¤„ç†ï¼Ÿ
- [ ] æ˜¯å¦å½±å“å…¶ä»–åŠŸèƒ½ï¼Ÿ
- [ ] æ€§èƒ½æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ

### ğŸš€ æŒç»­æ”¹è¿›æœºåˆ¶

#### é”™è¯¯è®°å½•å’Œå­¦ä¹ 
å½“å‘ç°æ–°çš„é‡å¤æ€§é”™è¯¯æ—¶ï¼š

1. **è®°å½•é”™è¯¯**:
   ```markdown
   ## æ–°å‘ç°é”™è¯¯: [é”™è¯¯æè¿°]
   **é”™è¯¯æ¨¡å¼**: [å…·ä½“é”™è¯¯æƒ…å†µ]
   **æ ¹æœ¬åŸå› **: [ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿ]
   **é˜²èŒƒæªæ–½**: [å¦‚ä½•é¿å…]
   **æ£€æŸ¥æ¸…å•**: [éªŒè¯æ­¥éª¤]
   ```

2. **æ›´æ–°æ–‡æ¡£**: ç«‹å³æ·»åŠ åˆ°æœ¬æ–‡æ¡£
3. **åˆ›å»ºæµ‹è¯•**: ç¼–å†™æµ‹è¯•ç”¨ä¾‹é˜²æ­¢å›å½’
4. **åˆ†äº«ç»éªŒ**: åœ¨å›¢é˜Ÿä¸­åˆ†äº«ç»éªŒæ•™è®­

#### å®šæœŸæ–‡æ¡£æ›´æ–°
- æ¯æœˆå›é¡¾å¸¸è§é”™è¯¯ï¼Œæ›´æ–°é˜²èŒƒæªæ–½
- è®°å½•æ–°çš„æœ€ä½³å®è·µå’Œå¼€å‘æ¨¡å¼
- æ•´ç†æœ‰æ•ˆçš„è°ƒè¯•æŠ€å·§å’Œå·¥å…·ä½¿ç”¨æ–¹æ³•

---

## ğŸ’¡ è®°ä½è¿™äº›åŸåˆ™

1. **å…ˆç†è§£ï¼Œå†å®ç°**: ä¸ç¡®å®šæ—¶å…ˆæŸ¥çœ‹ç°æœ‰ä»£ç å’Œæ–‡æ¡£
2. **å°æ­¥å¿«è·‘**: æ¯æ¬¡åªæ”¹ä¸€ä¸ªé—®é¢˜ï¼Œç«‹å³éªŒè¯
3. **æ—¥å¿—ä¸ºç‹**: è¯¦ç»†çš„æ—¥å¿—æ˜¯æœ€å¥½çš„è°ƒè¯•å·¥å…·
4. **æµ‹è¯•é©±åŠ¨**: é‡è¦åŠŸèƒ½å¿…é¡»æœ‰æµ‹è¯•è¦†ç›–
5. **æ–‡æ¡£åŒæ­¥**: ä»£ç æ”¹åŠ¨æ—¶åŒæ­¥æ›´æ–°æ–‡æ¡£
6. **ä»£ç å¤‡ä»½**: æ¯æ¬¡ä¿®æ”¹ä»£ç å‰éƒ½éœ€è¦ç¡®è®¤æ˜¯å¦gitå¤‡ä»½ç‰ˆæœ¬

**è¿™ä¸ªæ–‡æ¡£ä¼šæŒç»­æ›´æ–°ï¼Œæ¯æ¬¡é‡åˆ°æ–°çš„é‡å¤æ€§é”™è¯¯éƒ½ä¼šæ·»åŠ åˆ°è¿™é‡Œï¼Œå½¢æˆæˆ‘ä»¬çš„å¼€å‘çŸ¥è¯†åº“ã€‚**